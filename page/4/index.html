<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="what I don&apos;t know">
<meta property="og:type" content="website">
<meta property="og:title" content="Serious Autonomous Vehicles">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="Serious Autonomous Vehicles">
<meta property="og:description" content="what I don&apos;t know">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Serious Autonomous Vehicles">
<meta name="twitter:description" content="what I don&apos;t know">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/4/"/>





  <title>Serious Autonomous Vehicles</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Serious Autonomous Vehicles</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/02/design-a-threadpool-in-pure-C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/02/design-a-threadpool-in-pure-C/" itemprop="url">design a threadpool in pure C</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-08-02T00:44:08-04:00">
                2018-08-02
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/08/02/design-a-threadpool-in-pure-C/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/08/02/design-a-threadpool-in-pure-C/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>actually this post should be named as “pure C multithreads”, while it’s better to write some real code. <a href="https://github.com/Pithikos/C-Thread-Pool" target="_blank" rel="external">a simple threadpool in pure C</a></p>
<h2 id="exposed-APIs"><a href="#exposed-APIs" class="headerlink" title="exposed APIs"></a>exposed APIs</h2><p>at most simple case, what a threadpool object should do? </p>
<pre><code>thpool_init(num_threads);
thpool_destory(threapool_obj);
thpool_add_work(callback, args); 
// so user define event callback() can be passed in;  
</code></pre><p>threadpool is used to assign jobs (from job list) to a thread. so joblist should be an internal class; and it’s better to package thread, job as separate class too;  to add work, what kind of funcs need for joblist ?  at least, to add new job(from outside) to the joblist.</p>
<h2 id="internal-structures"><a href="#internal-structures" class="headerlink" title="internal structures:"></a>internal structures:</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">thread</span> &#123;</span></div><div class="line"> 	<span class="keyword">int</span> id;</div><div class="line"> 	<span class="keyword">pthread_t</span> thread;   <span class="comment">//pthread_t is a unsigned long int; it's system assigned</span></div><div class="line"> 	threadpool *thpool;  <span class="comment">//so thread know its domain</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">job</span> &#123;</span></div><div class="line">	(<span class="keyword">void</span>*) func(<span class="keyword">void</span>*); <span class="comment">// each job/task should have a callback func</span></div><div class="line">	(<span class="keyword">void</span>*) func_arg ; <span class="comment">//and func args</span></div><div class="line">	<span class="comment">//since consider joblist as a list, it's helpful to add pointers to neighbors</span></div><div class="line">	job* prev;</div><div class="line">	job* next;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">jobqueue</span> &#123;</span></div><div class="line">    <span class="keyword">int</span> num_jobs;</div><div class="line">    job* front;</div><div class="line">    job* rear;</div><div class="line">    <span class="comment">//some flags to support add new node(job) to the list</span></div><div class="line"></div><div class="line">&#125;    </div><div class="line">   	 </div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">threadpool_</span> &#123;</span></div><div class="line">    thread* threads_array;</div><div class="line">    jobqueue job_queue;</div><div class="line">    <span class="comment">// some flags</span></div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h2 id="consider-syncronlization"><a href="#consider-syncronlization" class="headerlink" title="consider syncronlization"></a>consider syncronlization</h2><p>will multi threads call add_task() simutaneously? if so, jobqueue should have a mutex object;</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">jobqueue</span> &#123;</span></div><div class="line">    <span class="keyword">int</span> num_jobs;</div><div class="line">    job* front;</div><div class="line">    job* rear;</div><div class="line">    <span class="keyword">pthread_mutex_t</span>  jq_mutex;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>during threadpool initialization, will all threads be created simultaneously and immediately? if not, there should be thread status flags (creating, exisiting-but-idle, working, died); and to update these flags need protect by mutex object;    </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">threadpool_</span> &#123;</span></div><div class="line">    thread* threads_array;</div><div class="line">    jobqueue job_queue;</div><div class="line">    <span class="keyword">int</span> num_threads; <span class="comment">//stands for the number of all existing threads</span></div><div class="line">    <span class="keyword">pthread_mutex_t</span> tp_mutex;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>this is an interesting, when design a lib, what’s in my mind. hopefully implement by the end of week.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/31/pure-C-socket/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/31/pure-C-socket/" itemprop="url">pure C socket</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-31T19:26:58-04:00">
                2018-07-31
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/31/pure-C-socket/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/07/31/pure-C-socket/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>this is a review from <a href="https://www.gnu.org/software/libc/manual/html_node/Sockets.html" target="_blank" rel="external">GNU C lib</a>. socket is a two-way communication channel, both read and write can be performed at either end.  </p>
<h2 id="sys-socket-h"><a href="#sys-socket-h" class="headerlink" title="sys/socket.h"></a>sys/socket.h</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">socket</span><span class="params">(AF_INET, SOCK_STREAM, protocol)</span></span>; </div><div class="line"><span class="comment">/* return fd for this new socket, or -1 as error */</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">close</span><span class="params">(<span class="keyword">int</span> socket_fd)</span></span>; </div><div class="line"><span class="comment">/* return 0 when close successfuly, else return -1 */</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">connect</span><span class="params">(<span class="keyword">int</span> socket, struct sockaddr *addr, <span class="keyword">socketlen_t</span> len)</span></span>;</div><div class="line"><span class="comment">/* initiate a connection from (client) socket to (server) address; by default, the connection is blocking untill server respond */</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">listen</span><span class="params">(<span class="keyword">int</span> socket, <span class="keyword">int</span> n)</span></span>;</div><div class="line"><span class="comment">/* n specifies the length of queue for pending connections; when the queue fills up, new clients attempting to connect will fail */</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">accept</span><span class="params">(<span class="keyword">int</span> socket, struct sockaddr *addr,  <span class="keyword">socketlen_t</span> *len_ptr)</span></span>;</div><div class="line"><span class="comment">/* if successfully, accept return a new socket fd, the original (server) socket remains open and unconnected;  the address and len_ptr are used to return information about the name of client socket that initiated this connection */</span></div><div class="line"></div><div class="line"><span class="keyword">size_t</span> send(<span class="keyword">int</span> socket, <span class="keyword">const</span> <span class="keyword">void</span> *buffer, <span class="keyword">size_t</span> size, <span class="keyword">int</span> flags);</div><div class="line"><span class="comment">/* param socket is the fd of current sending socket. no receiver socket explicitly defined, since connection-oriented(TCP)protocol will connect first prior to send/receive  */</span></div><div class="line"></div><div class="line"><span class="keyword">size_t</span> recv(<span class="keyword">int</span> socket, <span class="keyword">const</span> <span class="keyword">void</span> *buffer,  <span class="keyword">size_t</span> size, <span class="keyword">int</span> flags);</div><div class="line"><span class="comment">/* param socket is the fd of current receiving socket */</span></div><div class="line"></div><div class="line"></div><div class="line">``` </div><div class="line"></div><div class="line"></div><div class="line">#<span class="meta"># network socket </span></div><div class="line"></div><div class="line">I didn't realize GNU C socket I/O is so related to network socket. the missing part when reading muduo, libuv is here. </div><div class="line"></div><div class="line">The server listens the connection requests on the special server socket, then accept each incoming connection. select() blocks/sleeps the program until input is available/ready on the special server socket/fd. </div><div class="line"></div><div class="line">```<span class="function">c</span></div><div class="line"><span class="keyword">void</span> <span class="title">FD_ZERO</span><span class="params">(fd_set *<span class="built_in">set</span>)</span> </div><div class="line"><span class="comment">/* initialized the file descriptor set to empty set */</span></div><div class="line"><span class="keyword">void</span> <span class="title">FD_SET</span><span class="params">(<span class="keyword">int</span> fd, fd_set *<span class="built_in">set</span>)</span> <span class="comment">/* add fd to set */</span></div><div class="line"><span class="keyword">void</span> <span class="title">FD_CLR</span><span class="params">(<span class="keyword">int</span> fd,  fd_set *<span class="built_in">set</span>)</span> <span class="comment">/*remove fd from set */</span></div><div class="line"><span class="keyword">void</span> <span class="title">FD_ISSET</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">const</span> fd_set * <span class="built_in">set</span>)</span>  </div><div class="line"><span class="comment">/* return true(non-zero) if fd is in  set; else return 0 */</span></div><div class="line">STDIN_FILENO ; <span class="comment">/*  file descriptor for std input “1” */</span></div></pre></td></tr></table></figure>
<p>how to debug server/client code? <a href="https://github.com/alphadose/Alpha-Chat/blob/master/" target="_blank" rel="external">chatRoom</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/31/pure-C-i-o/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/31/pure-C-i-o/" itemprop="url">pure C I/O</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-31T19:14:28-04:00">
                2018-07-31
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/31/pure-C-i-o/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/07/31/pure-C-i-o/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>this is a review from <a href="https://www.gnu.org/software/libc/manual/html_node/I_002fO-Overview.html#I_002fO-Overview" target="_blank" rel="external">GNU C programming</a></p>
<h1 id="stream"><a href="#stream" class="headerlink" title="stream"></a>stream</h1><p>two basic mechanism for representing the connection between your program and the file: streams &amp;  file descriptors.  FD is represented as objects of type int; streams are represented as FILE * objects </p>
<p>a stream is an abstract concept reprensenting a communication channel to a file, a device, or consider it as a sequence of characters with functions to take characters out of one end, and put characters into the other end, like a pipe. </p>
<h1 id="file-position"><a href="#file-position" class="headerlink" title="file position"></a>file position</h1><p>an integer representing the number of bytes from the beginning of the file; each time a character read or written, the file position is incremented, namely, access to a file is sequential.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">int</span> <span class="title">ftell</span><span class="params">(FILE \* stream)</span></span>; <span class="comment">//return file position </span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">fseek</span><span class="params">(FILE \*stream, <span class="keyword">long</span> <span class="keyword">int</span> offset, <span class="keyword">int</span> whence)</span></span>;</div><div class="line">/\* whence is SEEK\_SET |  SEEK\_CUR | SEEK\_END \*/</div><div class="line"></div><div class="line">``` </div><div class="line"></div><div class="line">“write to a file” is always appended sequentially to the end of the file, regardless of the file position; but “read from a file” is used the current file position. which means multiple reading can happens simultaneously with an independent file pointer. In fact, each opening creates an independent file position pointer, even in the same program to open a file twice.  </div><div class="line"></div><div class="line">#<span class="meta"># std streams</span></div><div class="line"></div><div class="line">```c</div><div class="line"></div><div class="line">	FILE *<span class="built_in">stdin</span> ;</div><div class="line">	FILE *<span class="built_in">stdout</span>;</div><div class="line">	FILE *<span class="built_in">stderr</span>;</div><div class="line">	<span class="function">FILE *<span class="title">fopen</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *filename, <span class="keyword">const</span> <span class="keyword">char</span> *openMode)</span></span>;  </div><div class="line">	<span class="comment">/* create a new stream connected to the file */</span></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">int</span> <span class="title">fclose</span><span class="params">(FILE *stream)</span></span></div><div class="line">	<span class="comment">/* disconnected between the stream and the file, any buffered output is written and any buffered input will discarded */</span></div></pre></td></tr></table></figure>
<h2 id="ASCII-IO"><a href="#ASCII-IO" class="headerlink" title="ASCII IO"></a>ASCII IO</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">fputs</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s, FILE *stream)</span> </span>;</div><div class="line"><span class="comment">/* write a char array into stream. this call doesn't add a newline or terminal null character */</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">char</span> *<span class="title">fgets</span><span class="params">(<span class="keyword">char</span> *s, <span class="keyword">int</span> n, FILE *stream)</span></span>;</div><div class="line"><span class="comment">/* read n number of char array from stream, default add a newline character */</span></div><div class="line"></div><div class="line"><span class="keyword">ssize_t</span> getline(<span class="keyword">char</span> **lineptr, <span class="keyword">size_t</span> *n, FILE *stream);</div><div class="line"><span class="comment">/* read a whole line from stream */</span></div></pre></td></tr></table></figure>
<h2 id="block-IO"><a href="#block-IO" class="headerlink" title="block IO"></a>block IO</h2><p>usually block stands for either block data or text in fixed-size, instead of characters or lines</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">size_t</span> fread(<span class="keyword">void</span> *data, <span class="keyword">size_t</span> size, <span class="keyword">size_t</span> n, FILE *stream);</div><div class="line"><span class="comment">/* read #n block, each block has size from stream, and store in data */</span></div><div class="line"></div><div class="line"><span class="keyword">size_t</span> fwrite(<span class="keyword">const</span> <span class="keyword">void</span> *data, <span class="keyword">size_t</span> size, <span class="keyword">size_t</span> n, FILE *stream);</div><div class="line"><span class="comment">/* write #n block, each block has size from buffer data to stream */</span></div></pre></td></tr></table></figure>
<h2 id="formatted-IO"><a href="#formatted-IO" class="headerlink" title="formatted IO"></a>formatted IO</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">printf</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">template</span>, …)</span></span>;  <span class="comment">//write to std output</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">fprintf</span><span class="params">(FILE *stream, <span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">template</span>, ...)</span></span>; <span class="function">write to stream</span></div><div class="line"><span class="keyword">int</span> <span class="title">sprintf</span><span class="params">(<span class="keyword">char</span> *s, <span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">template</span>, ...)</span>; <span class="comment">//write to a string</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">scanf</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">template</span>, …)</span> <span class="comment">//formatted read from stdin</span></span></div><div class="line"><span class="keyword">int</span> <span class="title">fscanf</span><span class="params">(FILE *stream, <span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">template</span>, …)</span> <span class="comment">// read from stream </span></div><div class="line"><span class="keyword">int</span> <span class="title">sscanf</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s, <span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">template</span>, …)</span> <span class="comment">// read from a string</span></div></pre></td></tr></table></figure>
<h2 id="EOF"><a href="#EOF" class="headerlink" title="EOF"></a>EOF</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">feof</span><span class="params">(FILE* stream)</span> </span>; </div><div class="line"><span class="comment">/* return nonzero iff end of file indicator is set for stream */</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">ferror</span><span class="params">(FILE* stream)</span> </span>; </div><div class="line"><span class="comment">/* return nonzero iff error indicator is set for stream */</span></div></pre></td></tr></table></figure>
<h2 id="stream-buffer"><a href="#stream-buffer" class="headerlink" title="stream buffer"></a>stream buffer</h2><p>stream and file is not communicated character-by-character, there is a buffer for I/O.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">fflush</span><span class="params">(FILE *stream)</span> </span></div><div class="line"><span class="comment">/* take any buffered output on stream to be delivered to the file */</span></div></pre></td></tr></table></figure>
<h2 id="file-descriptor"><a href="#file-descriptor" class="headerlink" title="file descriptor"></a>file descriptor</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">open</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *filename, <span class="keyword">int</span> flags)</span></span>;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">open64</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *filename,  <span class="keyword">int</span> flags)</span> </span>;</div><div class="line"><span class="comment">// allow large file mode </span></div><div class="line"><span class="keyword">size_t</span> read(<span class="keyword">int</span> fd,  <span class="keyword">void</span> *buffer, <span class="keyword">size_t</span> size) </div><div class="line"><span class="comment">//  read from fd  size bytes into buffer </span></div><div class="line"><span class="keyword">size_t</span> pread(<span class="keyword">int</span> fd, <span class="keyword">void</span> *buffer,  <span class="keyword">size_t</span> size, <span class="keyword">off_t</span>  offset) </div><div class="line"><span class="comment">// start reading from position “offset” </span></div><div class="line"><span class="keyword">size_t</span>  write(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">void</span> *buffer,  <span class="keyword">size_t</span> size) </div><div class="line"><span class="keyword">off_t</span>  lseek(<span class="keyword">int</span> fd,  <span class="keyword">off_t</span> offset,  <span class="keyword">int</span> whence)  </div><div class="line"><span class="comment">// change the file position of fd </span></div><div class="line"><span class="function">FILE *<span class="title">fdopen</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">char</span> *opentype)</span> </span></div><div class="line"><span class="comment">// return a new stream for this fd</span></div></pre></td></tr></table></figure>
<h2 id="synchronizing-I-O"><a href="#synchronizing-I-O" class="headerlink" title="synchronizing I/O"></a>synchronizing I/O</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">sync</span><span class="params">(<span class="keyword">void</span>)</span> </span>;</div><div class="line"><span class="comment">// to ensure all operations finished before they return </span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">fsync</span><span class="params">(<span class="keyword">int</span> fd)</span> </span>;</div><div class="line"><span class="comment">// to ensure all data associated with the fd is written to the device</span></div></pre></td></tr></table></figure>
<h2 id="not-yet"><a href="#not-yet" class="headerlink" title="not yet"></a>not yet</h2><p>async I/O, event I/O, interrupt driven I/O, GPIO …</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/26/Linux-at-work/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/26/Linux-at-work/" itemprop="url">Linux at work</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-26T00:10:49-04:00">
                2018-07-26
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/26/Linux-at-work/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/07/26/Linux-at-work/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="bash-environment"><a href="#bash-environment" class="headerlink" title="bash environment"></a>bash environment</h2><pre><code>/etc/profile -&gt;  hold shell environment &amp; startup settings 
~/.bashrc  -&gt; system wide definitions for shell funcs &amp; alias 
~/.bash_profile -&gt; user environment individually
</code></pre><p>ususally during coapplication configuration on Mac or Linux, mostly use ~/.bashrc to add project related environment variables. </p>
<h2 id="regular-expressions"><a href="#regular-expressions" class="headerlink" title="regular expressions"></a>regular expressions</h2><ul>
<li>the$ :matches the line ending with “the”</li>
<li>^the :matches the line starting with “the”</li>
<li>[^g]abc : search “abc” but not starting with “g” </li>
<li>[^abc…z][0-9] : search numbers but not with alphabet in front </li>
<li>^[a-z] : search the line starting with low alphabet</li>
<li>^[^a-z]: search the line starting without low alphabet</li>
<li>^$ :  match white space </li>
<li>[xyz]: general match anyone from “xyz” </li>
<li>[!xyz]: general match in opposite, neither from “xyz” </li>
</ul>
<h2 id="shell-expressions"><a href="#shell-expressions" class="headerlink" title="shell expressions"></a>shell expressions</h2><ul>
<li>command &amp; :  to run command in bg</li>
<li>$! : current PID</li>
<li>$# : number of arguments</li>
<li>$1 : the first paramter</li>
<li>$* : wildcard for all variables</li>
</ul>
<h2 id="Linux-commands"><a href="#Linux-commands" class="headerlink" title="Linux commands"></a>Linux commands</h2><ul>
<li>ldd:  check runtime lib</li>
<li>unix2dos  / dos2unix:  change file format between Windows and Linux</li>
<li>ps : print running processes in current terminal </li>
<li>ipcs : check share memory portion in current system </li>
<li>ipcrm -M ipc_key :  remove the shared memory portion id by ipc_key </li>
<li>top: print  virtual,resident,shared memory percentage</li>
<li>basename:  e.g.  basename /path/to/file -&gt;  file </li>
<li>wc -l .file:  print total lines of the file </li>
<li>df: check the usage of disk</li>
<li>find . -type f -print0 | xargs -0 grep -l “xx” </li>
<li>find D:\  | grep xml </li>
<li>less .file  : read the last few lines of file</li>
<li>ln item link : soft link</li>
<li>ln -s item link : hard link</li>
<li>type command : check the type of command</li>
<li>cat f1 f2 &gt; merged </li>
<li>sort </li>
<li>uniq </li>
<li>comm f1 f2 :  the common part of f1 and f2 </li>
<li>diff f1 f2 : the difference of f1 and f2 </li>
<li>2 &gt;&amp; 1: redirect std output(fd=2) to std error(fd=1)</li>
<li>nm :  check libs used in current executable(T defined, U undefined) </li>
</ul>
<h2 id="gdb"><a href="#gdb" class="headerlink" title="gdb"></a>gdb</h2><p>MPI gdb: (each MPI thread will have an independent terminal window)<br>    mpirun -np #cpus  xterm -e gdb ./exe </p>
<p>set breakpoint in different src:<br>    b sth.cxx:20</p>
<p>print an array:<br>    p (int[length]* a)</p>
<p>add input file:<br>    set args -j input_file </p>
<p>load src after triggering GDB:<br>    gdb<br>    file exe<br>    set args -j input_file </p>
<h2 id="books-about-Linux"><a href="#books-about-Linux" class="headerlink" title="books about Linux"></a>books about Linux</h2><p>bash guide for beginners<br>tao of regular expression<br>Linux programmer’s manual<br>Linux system administrators guide<br>C expert programming<br>what every programmer should know about CPU caches</p>
<h2 id="resources-in-multi-core-optimization"><a href="#resources-in-multi-core-optimization" class="headerlink" title="resources in multi-core optimization"></a>resources in multi-core optimization</h2><p>understand CPU utilization &amp; optimization<br>Intel: optimization applications for NUMA<br>Intel guide for developing multithreaded applications<br>MPI parallel programming in Python<br>considerations in software design for multi-core, multiprocessor architectures<br>how to optimize GEMM<br>optimize for Intel AVX using MKL with DGEMM<br>GEMM: from pure C to SSE optimized micro kernel<br>a practical guide to SSE SIMDD with C++<br>multi-core design<br>Unix and pthread programming </p>
<h2 id="resources-in-applications"><a href="#resources-in-applications" class="headerlink" title="resources in applications"></a>resources in applications</h2><p>introduction to post processing finite element results with AVS<br>CAE Linux: FEA inter-operability<br>open sourcing a Python project the right way<br>PPSS<br>pyNastran<br>hdfviewer<br>valgrind</p>
<h2 id="postscript"><a href="#postscript" class="headerlink" title="postscript"></a>postscript</h2><p>starting from 2016, I had went through each hot topic nowadays, even did some study in DL, AV, CV etc. every time the passion burst out and I promised to e.g. study a framework, or contribute an open project. in reality, the passion dies away soon. It’s like a new and very attracting concept bump out in the market, but no business model can handle it, then it dies out. </p>
<p>downside of this learning pattern is that the fundmental is ignored. e.g. I can’t success in code interview, few experience in basic algorithms. kind of person always vision the big, but don’t realize how to reach there. it’s kind of wasting finally, just want to be focus at this moment.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/26/Pure-C-structure/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/26/Pure-C-structure/" itemprop="url">pure C structure</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-26T00:03:29-04:00">
                2018-07-26
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/26/Pure-C-structure/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/07/26/Pure-C-structure/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="definition"><a href="#definition" class="headerlink" title="definition"></a>definition</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">gid_</span> &#123;</span></div><div class="line">			<span class="keyword">double</span> x;</div><div class="line">			<span class="keyword">double</span> y;</div><div class="line">			<span class="keyword">char</span>* name ;</div><div class="line">		&#125; gid ;</div></pre></td></tr></table></figure>
<p>typedef defines “gid” as an alias name to “struct gid_ “. typedef also alias function handle/pointer, which is often used in asynchronous/event callback programming. other data encapsulation are:<br>    enum : map a list of const names to integral constants<br>    union: store many data type in one memory address</p>
<h2 id="initialization"><a href="#initialization" class="headerlink" title="initialization"></a>initialization</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">gid g1=&#123;<span class="number">2.0</span>, <span class="number">3.0</span>, <span class="string">"g1"</span>&#125;;</div><div class="line">gid g2=&#123;.x=<span class="number">2.0</span>, .y=<span class="number">3.0</span>, .name=<span class="string">"g2"</span>&#125;;</div><div class="line">gid g3=(gid)&#123;<span class="number">2.0</span>, <span class="number">3.0</span>, <span class="string">"g3"</span>&#125;;</div></pre></td></tr></table></figure>
<p>in C++, structure initialization can also be done in constructor. </p>
<h2 id="memory-alignment"><a href="#memory-alignment" class="headerlink" title="memory alignment"></a>memory alignment</h2><p>for better memory access in CPU architecture, <a href="http://www.catb.org/esr/structure-packing/" target="_blank" rel="external">memory alignment</a> in structure is considered. namely:</p>
<pre><code>chars can start on any byte address
2-bytes shorts must start on an even address 
4-bytes ints/floats must start on an address divisible by 4
8-bytes doubles/longs must start on an address divisible by 8 
</code></pre><p>the size of the whole structure, is aligned to intergeral times of the max size of its member variable. e.g. sizeof(gid) = 24, not 8+8+4.</p>
<p>to put the member variables in ascending/descending order is good practice.</p>
<h2 id="structure-pointer-arithmetic"><a href="#structure-pointer-arithmetic" class="headerlink" title="structure pointer arithmetic"></a>structure pointer arithmetic</h2><p>“gid++” will step forward the sizeof(gid); structure also supports self-reference:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">gid_</span> &#123;</span></div><div class="line">		<span class="keyword">char</span> *name ;</div><div class="line">		<span class="keyword">double</span> x;</div><div class="line">		<span class="keyword">double</span> y;</div><div class="line">		gid_ *next_gid ; </div><div class="line">	&#125; gid ;</div></pre></td></tr></table></figure>
<p>another common utils is structure array: </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">gid gid_list[MAX_SIZE]; </div><div class="line">gid **gid_list_p ;</div></pre></td></tr></table></figure>
<h2 id="structure-as-function-parameters"><a href="#structure-as-function-parameters" class="headerlink" title="structure as function parameters"></a>structure as function parameters</h2><p>in general, structure can be passing to function by value or by pointer, but not by reference in pure C. also structure as return value from function can be value or a pointer</p>
<h2 id="structure-in-C"><a href="#structure-in-C" class="headerlink" title="structure in C++"></a>structure in C++</h2><p>in C++, structure supports member functions, is same as a public class. and the initialization can be done either in constructor function or direct initialization during definition. see <a href="https://www.quora.com/What-is-the-difference-between-C-structure-C++-structure" target="_blank" rel="external">the difference of struct between C and C++</a></p>
<h2 id="stdlib-h"><a href="#stdlib-h" class="headerlink" title="stdlib.h"></a>stdlib.h</h2><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"> /* convert string s1 to an int*/	</div><div class="line">	int atoi(const char* s1);</div><div class="line"> </div><div class="line"> /* memory op */</div><div class="line">	void* malloc(size_t size); </div><div class="line">	void free(void *ptr);</div><div class="line">	</div><div class="line"> /* system level op */</div><div class="line">	char* getenv(const char *name);</div><div class="line">	int system(const char *command); </div><div class="line"></div><div class="line">/* algorithms */</div><div class="line">	void* bsearch(const void* key, const void* base,</div><div class="line">	size_t nitems, size_t size,  int(*compar)(const void*, const void*))  </div><div class="line"></div><div class="line">	void qsort(void *base, size_t nitems, size_t size, </div><div class="line">int(*compar)(const void*, const void*))</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/24/pure-C-string/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/24/pure-C-string/" itemprop="url">pure C string</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-24T18:43:37-04:00">
                2018-07-24
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/24/pure-C-string/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/07/24/pure-C-string/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="string-initialization"><a href="#string-initialization" class="headerlink" title="string initialization"></a>string initialization</h2><p>in pure C, string is a char array terminating with NULL(‘\0’). To initialize an array of char(string) is with a string literal(a double-quotaed string).</p>
<p>in general, the string literal is used as the initializer for an array of char; anywhere else, it is a static array of chars, which shouldn’t be modified by a pointer.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* initialize a string in C </span></div><div class="line"> * the size of s1 is taken from the size of the initializer</div><div class="line"> */</div><div class="line">	<span class="keyword">char</span> s1[] = <span class="string">"hello world"</span> ; </div><div class="line"><span class="comment">// or </span></div><div class="line">	<span class="keyword">char</span> s1[<span class="number">12</span>] = <span class="string">"hello world"</span>; </div><div class="line"></div><div class="line"><span class="comment">/* common errors */</span></div><div class="line">	<span class="keyword">char</span> s2[];</div><div class="line">	s2 = <span class="string">"hello world"</span></div><div class="line"><span class="comment">// error: storage size of 's2' isn't known </span></div><div class="line"></div><div class="line">	<span class="keyword">char</span> s2[<span class="number">12</span>];</div><div class="line">	s2 = <span class="string">"hello world"</span></div><div class="line"><span class="comment">// error:  invalid array assignment </span></div><div class="line"><span class="comment">/* there is no "=" operator defined for char array in C </span></div><div class="line">   using strcpy()</div><div class="line">*/</div><div class="line"></div><div class="line">``` </div><div class="line"></div><div class="line">## <span class="keyword">char</span> pointer arithmetic </div><div class="line"></div><div class="line">```c</div><div class="line"></div><div class="line">	<span class="keyword">char</span> s1[<span class="number">12</span>];</div><div class="line">	*s1++ ;	</div><div class="line"><span class="comment">/* error:  lvalue requied as increment operand</span></div><div class="line"> * s3 is an array, can't modify the address of an array. the difference between pointer and array </div><div class="line">*/ </div><div class="line">	 <span class="keyword">char</span>* s2 = s1; </div><div class="line">	 *s2++;</div><div class="line"><span class="comment">/* s2 is a pointer to s1, ++ is ok */</span></div></pre></td></tr></table></figure>
<h2 id="string-h"><a href="#string-h" class="headerlink" title="string.h"></a>string.h</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* concatenate two strings */</span></div><div class="line"><span class="built_in">strcat</span>(<span class="keyword">char</span>* s1, <span class="keyword">const</span> <span class="keyword">char</span>* s2) ;</div><div class="line"><span class="built_in">strncat</span>(<span class="keyword">char</span>* s1, <span class="keyword">const</span> <span class="keyword">char</span>* s2, <span class="keyword">size_t</span> n); </div><div class="line"></div><div class="line"><span class="comment">/*  locate the first/last occurance of char c in string s */</span></div><div class="line"><span class="built_in">strchr</span>(<span class="keyword">const</span> <span class="keyword">char</span>* s1, <span class="keyword">int</span> c);</div><div class="line"><span class="built_in">memchr</span>(<span class="keyword">const</span> <span class="keyword">void</span>* s1, <span class="keyword">int</span> c, <span class="keyword">size_t</span> n);</div><div class="line"><span class="built_in">strrchr</span>(<span class="keyword">const</span> <span class="keyword">char</span>* s1, <span class="keyword">int</span> c); </div><div class="line"></div><div class="line"><span class="comment">/*  compare s1 and s2 alphabetically */</span></div><div class="line"><span class="built_in">strcmp</span>(<span class="keyword">const</span> <span class="keyword">char</span>* s1, <span class="keyword">const</span> <span class="keyword">char</span>* s2);	</div><div class="line"><span class="built_in">strncmp</span>(<span class="keyword">const</span> <span class="keyword">char</span>* s1, <span class="keyword">const</span> <span class="keyword">char</span>* s2, <span class="keyword">size_t</span> n);</div><div class="line"><span class="built_in">memcmp</span>(<span class="keyword">const</span> <span class="keyword">void</span>* s1, <span class="keyword">const</span> <span class="keyword">void</span>* s2, <span class="keyword">size_t</span> n);</div><div class="line"></div><div class="line"><span class="comment">/*  copy s2 to s1 */</span></div><div class="line"><span class="built_in">strcpy</span>(<span class="keyword">char</span> *s1, <span class="keyword">const</span> <span class="keyword">char</span> *s2); </div><div class="line"><span class="built_in">memcpy</span>(<span class="keyword">void</span>* s1, <span class="keyword">void</span>* s2, <span class="keyword">size_t</span> n);</div><div class="line"></div><div class="line"><span class="comment">/* number of bytes, not including terminating NULL; sizeof() will inlcude the terminating NULL */</span></div><div class="line"><span class="built_in">strlen</span>(<span class="keyword">const</span> <span class="keyword">char</span>* s1); </div><div class="line"></div><div class="line"><span class="comment">/* find the first occurance of substring s2 in s1 */</span></div><div class="line"><span class="built_in">strstr</span>(<span class="keyword">const</span> <span class="keyword">char</span> *s1,  <span class="keyword">const</span> <span class="keyword">char</span> *s2);</div><div class="line"></div><div class="line"><span class="comment">/* split string s1 into a sequence of tokens by s2 */</span></div><div class="line">strtok(<span class="keyword">char</span>* s1, <span class="keyword">const</span> <span class="keyword">char</span>* s2);</div></pre></td></tr></table></figure>
<p>\<string.h> is replaced by <cstring> in C++.<br>and be aware of <a href="https://www.cs.fsu.edu/~myers/cop3330/notes/strings.html" target="_blank" rel="external">downs of C string</a>.</cstring></string.h></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/18/which-function-is-called/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/18/which-function-is-called/" itemprop="url">which function is called</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-18T22:00:16-04:00">
                2018-07-18
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/18/which-function-is-called/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/07/18/which-function-is-called/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="which-function-is-called"><a href="#which-function-is-called" class="headerlink" title="which function is called"></a>which function is called</h1><p>when a derived object calls the base class member function, inside which calls another virtual member function, which is implemented inside the derived class, so which virtual member function is actually called ?  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Weld</span> &#123;</span></div><div class="line">	<span class="keyword">public</span>: </div><div class="line">		Weld()&#123;&#125;;</div><div class="line">		<span class="keyword">virtual</span> ~Weld()&#123;&#125;;</div><div class="line">		<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">getDataIndex</span><span class="params">()</span></span>&#123;</div><div class="line">			<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Weld::getDataIndex"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">			<span class="keyword">return</span> <span class="literal">true</span> ; </div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">bool</span> <span class="title">getInternalDataList</span><span class="params">()</span></span>&#123;	</div><div class="line">			<span class="keyword">return</span> getDataIndex();</div><div class="line">		&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpotWeld</span>:</span> <span class="keyword">public</span> Weld&#123;</div><div class="line">	<span class="keyword">public</span>:</div><div class="line">		SpotWeld()&#123;&#125;;</div><div class="line">		<span class="keyword">virtual</span> ~SpotWeld()&#123;&#125;;</div><div class="line">		<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">getDataIndex</span><span class="params">()</span></span>&#123;</div><div class="line">			<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"SpotWeld::getDataIndex"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">			<span class="keyword">return</span> <span class="literal">true</span>; </div><div class="line">		&#125;</div><div class="line"></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ACM2</span> :</span> <span class="keyword">public</span> SpotWeld&#123;</div><div class="line">	<span class="keyword">public</span>:</div><div class="line">		ACM2()&#123;&#125;;</div><div class="line">		~ACM2()&#123;&#125;;</div><div class="line">		<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">getDataIndex</span><span class="params">()</span></span>&#123;</div><div class="line">			<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"ACM2::getDataIndex"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="function"><span class="keyword">bool</span> <span class="title">getPoints</span><span class="params">()</span></span>&#123;</div><div class="line">			<span class="keyword">return</span> getInternalDataList();</div><div class="line">		&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">	ACM2  acm2 ;</div><div class="line">	acm2.getPoints();</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>output is:</p>
<pre><code>ACM2::getDataIndex
</code></pre><p>so the derived object always calls the member function that most closest to its own class domain first, even if this member function is called from a base class member function.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/13/multi-core-at-work/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/13/multi-core-at-work/" itemprop="url">multi-core at work</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-13T17:21:04-04:00">
                2018-07-13
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/13/multi-core-at-work/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/07/13/multi-core-at-work/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="NUMA"><a href="#NUMA" class="headerlink" title="NUMA"></a>NUMA</h2><p>uniform memory arch,  all CPUs in the same sokcet shall the memory, and the memory IO is bottleneck; non uniform memory acess(NUMA), each CPU has itw own memory, inter-CPU memory access is remote.</p>
<pre><code>numctl  cpu_node_bind
MPI binding APIs
</code></pre><p>memory allocation strategy in NUMA</p>
<pre><code>interleave: place the memory on alternating node,
the first memory portion in node0, the next 
portion in node1
membind: forcely to allocate memory in special node
</code></pre><h2 id="CPU-affinity"><a href="#CPU-affinity" class="headerlink" title="CPU affinity"></a>CPU affinity</h2><p>the benifit of CPU affinity is to reduce context switch since one special process is binded to one speical CPU, so the data required in this process (no other process data will be switched in), can always in the CPU cache. espcially for NUMA arch to access data locally. and this is specially true when the application generate a large cache footprint, e.g. in scientific computing.</p>
<p>for general applications, CPU afinity may reduce performance, since in this way the CPU scheduler can’t work properly.</p>
<h2 id="CPU-info"><a href="#CPU-info" class="headerlink" title="CPU info"></a>CPU info</h2><pre><code>/proc/cpuinfo
</code></pre><p>physical id:  socket index<br>siblings:   number of cores in each socket<br>core id:   current core index </p>
<p>e.g. Ford HPC CPU architecture:</p>
<pre><code>2 or 4 CPU sockets group into one computing node
each socket has 10 or 12 CPU cores
each socket has a on-board shared memory
</code></pre><h2 id="atomic-operation"><a href="#atomic-operation" class="headerlink" title="atomic operation"></a>atomic operation</h2><p>CPU physical mechanism:</p>
<pre><code>physically there is a bus #hlock pin. 
if #lock is added before the assembly instruction, 
the corresponding machine code will be pulled down
during the execution of the #hlock pin till the
end, basically the bus is locked only for current 
instruction
</code></pre><p>cache coherence:</p>
<p>the cache unit tranfered between CPU and main memory is cache line. in one socket, as slibings share L3 cache, there is an scenario, when CPU1 modified one variable, but not yet writen to main memory, and CPU2 read from main memory and did modified again, then the variable in CPU1 and CPU2 is not coherence. </p>
<pre><code>volatile in C, forcely to read the variable value 
from main memory every time, to avoid use dirty
memory in cache
</code></pre><p>another scenario, to achieve and cache coherence, and the same variable is read and write repeatly by multiple processes, the performance is worse, “false sharing” </p>
<p>lock:</p>
<pre><code>signal, also called &quot;sleeping lock&quot;: used when the
lock need to keep for a longer time 
spin lock: at most hold by one thread, to block
other threads into critial area, used to keep 
for a short time.
write/read lock:
</code></pre><h2 id="system-performance"><a href="#system-performance" class="headerlink" title="system performance"></a>system performance</h2><p>resident memory(res), the portion of virtual memory space that is actually in RAM; swapped memory, when the physical memory is full and the system needs more memory, inactive pages in memory moved to the shared space, and swapped usable memory in</p>
<pre><code>virtual memory = res memory +  swapped memory
</code></pre><p>mmap, to access the remote (data block) like access local RAM. </p>
<p>voluntary context switches(vcs):</p>
<pre><code>when a thread makes a system call that blocks. vcs
measures the frequency of calling blocked system I/O 
</code></pre><p>involuntary context switches(ivcs):</p>
<pre><code>when a thread has being runing too long without
making a system call that blocks, and there are
other processes waiting for CPU, then OS will
switch for other CPUs. ivcs measures the CPU
competition, an unfinished processed is switched off
</code></pre><p>in general, as more threads, the context switch cost increase, due to the total amount of switch increase and as well each switch is more expensive, since CPU cache is limited, and each process will hold fewer data in cache. </p>
<p>cpu_time (clock_t):<br>    the total amount of time that a process has actually used</p>
<p>user CPU time:<br>     the amount of time spend in user space running </p>
<p>system CPU time:<br>      the amount of time spent during kernel space running </p>
<p>wall-clock time:<br>    the whole time from the process start to end</p>
<h2 id="Linux-IPC"><a href="#Linux-IPC" class="headerlink" title="Linux IPC"></a>Linux IPC</h2><p>inter-process communication(IPC) share memory is used in our application to cowork with MPI. while IPC helps to balance memory distributed in multi computing nodes, and MPI threads are the working horse to eat shared data. there are other IPC libs, e.g.  Boost.interprocess.</p>
<pre><code>ftok() -&gt; to generate a IPC key, based on a special file path

shmget() -&gt; generate a shared memory portion and return a shm_id

shmat() -&gt; attach to the shm_id and return a pointer to that shared memory

shmctl() 

shmdt() 
</code></pre><p>in design, all threads call shmget() to get a pointer to the share memory section, but actually only master thread do create the portion, others read it. since all thread can access the share memory section, it’s important to keep the first returned pointer from master thread clean/unpolluated. </p>
<h1 id="MPI"><a href="#MPI" class="headerlink" title="MPI"></a>MPI</h1><p>there are a few <a href="http://mpitutorial.com/tutorials" target="_blank" rel="external">basic MPI APIs</a>. </p>
<p>in our project, to benefit both CPU and memory performance, we actually need: 1) subgroup the MPI comm, 2) bind MPI threads to sockets.</p>
<pre><code>MPI_COMM_GROUP()
MPI_Group_incl() 
MPI_COMM_create()
</code></pre><p>apis and numctl during run-time:</p>
<pre><code>mpirun -bycore -bind-to-socket -&gt; bind process to each core on the socket 

mpirun -bysocket  -bind-to-socket 

mpirun numctl -membind=0 -np 32 ./run 
</code></pre>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/12/vehicle-network/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/12/vehicle-network/" itemprop="url">vehicle network</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-12T17:55:12-04:00">
                2018-07-12
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/12/vehicle-network/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/07/12/vehicle-network/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>vehicle networ is what connects the different parts together as a vehile. </p>
<h2 id="the-lower-level-basic"><a href="#the-lower-level-basic" class="headerlink" title="the lower-level basic"></a>the lower-level basic</h2><p>A few basic concepts:  TCP/UDP socket, CAN Bus, Ethernet, MCU register, Ip address, MAC address, Ethernet driver, network configure, how to code a ECU/MCU etc. </p>
<p>there are EE students working on this close to physical level implementation, on how to talk with register, MCU pins and controls, and some implementing the data traffic protocol in network. While both are isolated from top applications, since no matter where the data come from, either AV application or connected vehicle or media data, doesn’t make a difference.  </p>
<h2 id="architecture"><a href="#architecture" class="headerlink" title="architecture"></a>architecture</h2><p> <a href="https://autoelectricalsystems.wordpress.com/2015/11/07/typical-vehicle-network-architecture/" target="_blank" rel="external">typical vehicle network architecture</a></p>
<p>beyond the basic, network architecture brings a good vision to understand what makes a vehicle electronicly as a whole. and which is serving all apps with v2x, in-vehicle entertainment, AV.</p>
<p>I was thought ECU handling events the same as web server. while they are very different. each ECU is doing only one special task. e.g. ABS ECU only dealing with ABS events, there are no many ABS events happening simultaneously to seize the ECU computing resource; however, a web server have to deal with multiplex request simultaneously, either using thread pool or asynchronous event callbacks. </p>
<p>each ECU actually has an easy life, but the bus seems easily choked since around 100+ ECU nodes in the vehicle network. however again, typical vehicle network architecture is very matured products, without data-heavy applications arising, current CAN bus is great.</p>
<h2 id="smart-phone-in-wheels"><a href="#smart-phone-in-wheels" class="headerlink" title="smart phone in wheels?"></a>smart phone in wheels?</h2><p>one day in future, every vehicle running on road is requesting some data from cloud seamlessly, the scenario is like billions of browsers send requests to Google server seamlessly, then the cloud may face same issues in today’s web server. </p>
<p>Service oriented architecture(SOA) is also rising in vehicle network architeture design, but what kind of services is better locally in vehicle, and which services in cloud ? as hardwares evolution, even the computing-heavy tasks, e.g. vision based detection, path planning in AV, suppose not be a burden for local ECUs. so these services make sense locally served.  </p>
<p>except that, I only image future vehicle as a smart phone on wheels. so remote cloud server do connect to, e.g. talk to another vehicle, play online game during driving, check weather, find out a parking lot, resturant or similar, or the car company want to steal user data privately? </p>
<p>SOA is a good move to decouple ECU modules and make the network bus light, and it’s fun to try some vehicle network architecture open project or play with ROS simulator if hardware required. but in a business view, I don’t know a good story to attract investors, namely vehicle network sounds not that blinking amazing.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/29/gnu-make/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/29/gnu-make/" itemprop="url">gnu-make</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-06-29T17:45:40-04:00">
                2018-06-29
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/06/29/gnu-make/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/06/29/gnu-make/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p> websocket projects recently reviewed: <a href="https://github.com/uNetworking/uWebSockets" target="_blank" rel="external">uWebSocket</a>, which is used in Udacity self-driving car term2 projects. the other is <a href="https://github.com/warmcat/libwebsockets" target="_blank" rel="external">libwebsocket</a>, which is used in <a href="https://github.com/otcshare/automotive-message-broker/tree/master/ambd" target="_blank" rel="external">automotive message broker</a>(amb). </p>
<h2 id="gcc-compiler-options"><a href="#gcc-compiler-options" class="headerlink" title="gcc compiler options"></a>gcc compiler options</h2><p><a href="https://www3.ntu.edu.sg/home/ehchua/programming/cpp/gcc_make.html" target="_blank" rel="external">gcc and make:  a tutorial on how to compile, link and build c/c++ projects</a></p>
<pre><code>-wall : print all warning messages 
-c : compile into object, by default the object has same name as the source file
-o : specify the output executable filename
</code></pre><h2 id="headers-h-static-libs-lib-a-amp-shared-libs-dll-so"><a href="#headers-h-static-libs-lib-a-amp-shared-libs-dll-so" class="headerlink" title="headers(.h), static libs(.lib, .a) &amp; shared libs(.dll, .so)"></a>headers(.h), static libs(.lib, .a) &amp; shared libs(.dll, .so)</h2><p>gcc by default, links to the shared libraries if available.</p>
<p>the compiler search “include-paths” for headers, which is specified via -L\<dir\> option or CPATH; </dir\></p>
<p>the linker search “library-paths” to link the program into an executable object, which is specified via -L\<dir\> or LIBRARY_PATH, in addition, need to specify the library name via -l<name></name></dir\></p>
<p>the system default “include-paths” can be found by “cpp -v”</p>
<h2 id="gcc-environment-variables"><a href="#gcc-environment-variables" class="headerlink" title="gcc environment variables"></a>gcc environment variables</h2><p>PATH is used to search executable and run-time shared libs. (woo, this suppose to replace LD-LIBRARY-PATH)<br>CPATH is used to search “include-paths”, it’s searched after paths specified in -I&lt;dir> options. C_INCLUDE_PATH &amp; CPLUS_INCLUDE_PATH can be used to specify C &amp; C++ headers<br>LIBRARY_PATH is used to search linking-time “library-paths”, it’s searched after paths specified in -L\<dir\> options. the standard directories is  /usr/lib </dir\></p>
<h2 id="Linux-utils"><a href="#Linux-utils" class="headerlink" title="Linux utils"></a>Linux utils</h2><p>1) readelf: read <a href="https://amir.rachum.com/blog/2016/09/17/shared-libraries/" target="_blank" rel="external">ELF</a> </p>
<p>2) ldconfig : by default, read /etc/ls.so.conf, sets up the appropirate symbolic links in the dynamic link dir, and then write a cache to /etc/ld.so.cache, which then is used by other programs</p>
<p>3) ldd: to see recursive shared library dependencies</p>
<p>4) file: determine file type </p>
<p>5) nm: list symbol table of an object file, commonly-used to check if a particular func or variable is defined in an object file. “T” indicates   it is defined; “U” means undefined, which should be resolved by the linker.</p>
<h2 id="make-amp-cmake"><a href="#make-amp-cmake" class="headerlink" title="make &amp; cmake"></a>make &amp; cmake</h2><p>[gnu make] (<a href="https://www.gnu.org/software/make/manual/html_node/index.html#SEC_Contents" target="_blank" rel="external">https://www.gnu.org/software/make/manual/html_node/index.html#SEC_Contents</a>) </p>
<p>there are many best practical, e.g. <a href="https://gist.github.com/mbinna/c61dbb39bca0e4fb7d1f73b0d66a4fd1" target="_blank" rel="external">effective cmake</a></p>
<h2 id="build-libuv"><a href="#build-libuv" class="headerlink" title="build libuv"></a>build libuv</h2><p>it’s built based on GNU autotools</p>
<pre><code>sh autogen.sh  
&quot;libtoolize: AC_CONFIG_MACRO_DIR([m4]) conflicts with ACLOCAL_AMFLAGS=-I m4&quot;
</code></pre><p><a href="https://pete.akeo.ie/2010/12/that-darn-libtoolize-acconfigmacrodirm4.html" target="_blank" rel="external">fixing-solution</a>, then make all &amp; make install, so here is libuv.so, add the directory to \$LIBRARY_PATH in ~/.bashrc </p>
<h2 id="build-uWebSockets"><a href="#build-uWebSockets" class="headerlink" title="build uWebSockets"></a>build uWebSockets</h2><p>it’s built based on gnu make. the tests command has dependents on libuv. since already added libuv directory to \$LIBRARY_PATH, run through. if else, errors output:</p>
<pre><code>cannot find -luv
collect2: error: ld returned 1 exit status
Makefile:xx recipe for targe &apos;tests&apos; failed    
make: *** [tests] Error 1 
</code></pre><p>try to run ./testsBin, get another error:</p>
<pre><code>error while loading shared libraries: libuWS.so: cannot open shared object file: No such file or directory 
</code></pre><p>that’s run-time error, since libuWS.so is not included in \$PATH or speically for building/testing purpose, define $LD_LIBRARY_PATH. </p>
<h2 id="build-libwebsockets"><a href="#build-libwebsockets" class="headerlink" title="build libwebsockets"></a>build libwebsockets</h2><p>it’s built based on cmake. there is some dependent, but should go through well.</p>
<h2 id="beyond-the-note"><a href="#beyond-the-note" class="headerlink" title="beyond the note"></a>beyond the note</h2><p>when 2-months ago, looking at amb project, which has websocket plugin module, then find uWebSocket lib, during reading this tiny lib, where libuv APIs are highly-used, and soon found out libuv is actually the event-loop in nodejs. Woo, somehow they are related.</p>
<p>build tools are highly used in each project, but prior experience is more done by luck.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="David Z.J. Lee" />
          <p class="site-author-name" itemprop="name">David Z.J. Lee</p>
           
              <p class="site-description motion-element" itemprop="description">what I don't know</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">52</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/ZJLi2013" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.linkedin.com/in/zhengjia13/" target="_blank" title="LinkedIn">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  LinkedIn
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">David Z.J. Lee</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://zjlee.disqus.com/count.js" async></script>
    

    

  




	





  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
