<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="what I don&apos;t know">
<meta property="og:type" content="website">
<meta property="og:title" content="Serious Autonomous Vehicles">
<meta property="og:url" content="http://yoursite.com/page/13/index.html">
<meta property="og:site_name" content="Serious Autonomous Vehicles">
<meta property="og:description" content="what I don&apos;t know">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Serious Autonomous Vehicles">
<meta name="twitter:description" content="what I don&apos;t know">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/13/"/>





  <title>Serious Autonomous Vehicles</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Serious Autonomous Vehicles</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/26/Linux-at-work/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/26/Linux-at-work/" itemprop="url">Linux at work</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-26T00:10:49-04:00">
                2018-07-26
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/26/Linux-at-work/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/07/26/Linux-at-work/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="bash-environment"><a href="#bash-environment" class="headerlink" title="bash environment"></a>bash environment</h2><pre><code>/etc/profile -&gt;  hold shell environment &amp; startup settings 
~/.bashrc  -&gt; system wide definitions for shell funcs &amp; alias 
~/.bash_profile -&gt; user environment individually
</code></pre><p>ususally during coapplication configuration on Mac or Linux, mostly use ~/.bashrc to add project related environment variables. </p>
<h2 id="regular-expressions"><a href="#regular-expressions" class="headerlink" title="regular expressions"></a>regular expressions</h2><ul>
<li>the$ :matches the line ending with “the”</li>
<li>^the :matches the line starting with “the”</li>
<li>[^g]abc : search “abc” but not starting with “g” </li>
<li>[^abc…z][0-9] : search numbers but not with alphabet in front </li>
<li>^[a-z] : search the line starting with low alphabet</li>
<li>^[^a-z]: search the line starting without low alphabet</li>
<li>^$ :  match white space </li>
<li>[xyz]: general match anyone from “xyz” </li>
<li>[!xyz]: general match in opposite, neither from “xyz” </li>
</ul>
<h2 id="shell-expressions"><a href="#shell-expressions" class="headerlink" title="shell expressions"></a>shell expressions</h2><ul>
<li>command &amp; :  to run command in bg</li>
<li>$! : current PID</li>
<li>$# : number of arguments</li>
<li>$1 : the first paramter</li>
<li>$* : wildcard for all variables</li>
</ul>
<h2 id="Linux-commands"><a href="#Linux-commands" class="headerlink" title="Linux commands"></a>Linux commands</h2><ul>
<li>ldd:  check runtime lib</li>
<li>unix2dos  / dos2unix:  change file format between Windows and Linux</li>
<li>ps : print running processes in current terminal </li>
<li>ipcs : check share memory portion in current system </li>
<li>ipcrm -M ipc_key :  remove the shared memory portion id by ipc_key </li>
<li>top: print  virtual,resident,shared memory percentage</li>
<li>basename:  e.g.  basename /path/to/file -&gt;  file </li>
<li>wc -l .file:  print total lines of the file </li>
<li>df: check the usage of disk</li>
<li>find . -type f -print0 | xargs -0 grep -l “xx” </li>
<li>find D:\  | grep xml </li>
<li>less .file  : read the last few lines of file</li>
<li>ln item link : soft link</li>
<li>ln -s item link : hard link</li>
<li>type command : check the type of command</li>
<li>cat f1 f2 &gt; merged </li>
<li>sort </li>
<li>uniq </li>
<li>comm f1 f2 :  the common part of f1 and f2 </li>
<li>diff f1 f2 : the difference of f1 and f2 </li>
<li>2 &gt;&amp; 1: redirect std output(fd=2) to std error(fd=1)</li>
<li>nm :  check libs used in current executable(T defined, U undefined) </li>
</ul>
<h2 id="gdb"><a href="#gdb" class="headerlink" title="gdb"></a>gdb</h2><p>MPI gdb: (each MPI thread will have an independent terminal window)<br>    mpirun -np #cpus  xterm -e gdb ./exe </p>
<p>set breakpoint in different src:<br>    b sth.cxx:20</p>
<p>print an array:<br>    p (int[length]* a)</p>
<p>add input file:<br>    set args -j input_file </p>
<p>load src after triggering GDB:<br>    gdb<br>    file exe<br>    set args -j input_file </p>
<h2 id="books-about-Linux"><a href="#books-about-Linux" class="headerlink" title="books about Linux"></a>books about Linux</h2><p>bash guide for beginners<br>tao of regular expression<br>Linux programmer’s manual<br>Linux system administrators guide<br>C expert programming<br>what every programmer should know about CPU caches</p>
<h2 id="resources-in-multi-core-optimization"><a href="#resources-in-multi-core-optimization" class="headerlink" title="resources in multi-core optimization"></a>resources in multi-core optimization</h2><p>understand CPU utilization &amp; optimization<br>Intel: optimization applications for NUMA<br>Intel guide for developing multithreaded applications<br>MPI parallel programming in Python<br>considerations in software design for multi-core, multiprocessor architectures<br>how to optimize GEMM<br>optimize for Intel AVX using MKL with DGEMM<br>GEMM: from pure C to SSE optimized micro kernel<br>a practical guide to SSE SIMDD with C++<br>multi-core design<br>Unix and pthread programming </p>
<h2 id="resources-in-applications"><a href="#resources-in-applications" class="headerlink" title="resources in applications"></a>resources in applications</h2><p>introduction to post processing finite element results with AVS<br>CAE Linux: FEA inter-operability<br>open sourcing a Python project the right way<br>PPSS<br>pyNastran<br>hdfviewer<br>valgrind</p>
<h2 id="postscript"><a href="#postscript" class="headerlink" title="postscript"></a>postscript</h2><p>starting from 2016, I had went through each hot topic nowadays, even did some study in DL, AV, CV etc. every time the passion burst out and I promised to e.g. study a framework, or contribute an open project. in reality, the passion dies away soon. It’s like a new and very attracting concept bump out in the market, but no business model can handle it, then it dies out. </p>
<p>downside of this learning pattern is that the fundmental is ignored. e.g. I can’t success in code interview, few experience in basic algorithms. kind of person always vision the big, but don’t realize how to reach there. it’s kind of wasting finally, just want to be focus at this moment.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/26/Pure-C-structure/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/26/Pure-C-structure/" itemprop="url">pure C structure</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-26T00:03:29-04:00">
                2018-07-26
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/26/Pure-C-structure/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/07/26/Pure-C-structure/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="definition"><a href="#definition" class="headerlink" title="definition"></a>definition</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">gid_</span> &#123;</span></div><div class="line">			<span class="keyword">double</span> x;</div><div class="line">			<span class="keyword">double</span> y;</div><div class="line">			<span class="keyword">char</span>* name ;</div><div class="line">		&#125; gid ;</div></pre></td></tr></table></figure>
<p>typedef defines “gid” as an alias name to “struct gid_ “. typedef also alias function handle/pointer, which is often used in asynchronous/event callback programming. other data encapsulation are:<br>    enum : map a list of const names to integral constants<br>    union: store many data type in one memory address</p>
<h2 id="initialization"><a href="#initialization" class="headerlink" title="initialization"></a>initialization</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">gid g1=&#123;<span class="number">2.0</span>, <span class="number">3.0</span>, <span class="string">"g1"</span>&#125;;</div><div class="line">gid g2=&#123;.x=<span class="number">2.0</span>, .y=<span class="number">3.0</span>, .name=<span class="string">"g2"</span>&#125;;</div><div class="line">gid g3=(gid)&#123;<span class="number">2.0</span>, <span class="number">3.0</span>, <span class="string">"g3"</span>&#125;;</div></pre></td></tr></table></figure>
<p>in C++, structure initialization can also be done in constructor. </p>
<h2 id="memory-alignment"><a href="#memory-alignment" class="headerlink" title="memory alignment"></a>memory alignment</h2><p>for better memory access in CPU architecture, <a href="http://www.catb.org/esr/structure-packing/" target="_blank" rel="external">memory alignment</a> in structure is considered. namely:</p>
<pre><code>chars can start on any byte address
2-bytes shorts must start on an even address 
4-bytes ints/floats must start on an address divisible by 4
8-bytes doubles/longs must start on an address divisible by 8 
</code></pre><p>the size of the whole structure, is aligned to intergeral times of the max size of its member variable. e.g. sizeof(gid) = 24, not 8+8+4.</p>
<p>to put the member variables in ascending/descending order is good practice.</p>
<h2 id="structure-pointer-arithmetic"><a href="#structure-pointer-arithmetic" class="headerlink" title="structure pointer arithmetic"></a>structure pointer arithmetic</h2><p>“gid++” will step forward the sizeof(gid); structure also supports self-reference:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">gid_</span> &#123;</span></div><div class="line">		<span class="keyword">char</span> *name ;</div><div class="line">		<span class="keyword">double</span> x;</div><div class="line">		<span class="keyword">double</span> y;</div><div class="line">		gid_ *next_gid ; </div><div class="line">	&#125; gid ;</div></pre></td></tr></table></figure>
<p>another common utils is structure array: </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">gid gid_list[MAX_SIZE]; </div><div class="line">gid **gid_list_p ;</div></pre></td></tr></table></figure>
<h2 id="structure-as-function-parameters"><a href="#structure-as-function-parameters" class="headerlink" title="structure as function parameters"></a>structure as function parameters</h2><p>in general, structure can be passing to function by value or by pointer, but not by reference in pure C. also structure as return value from function can be value or a pointer</p>
<h2 id="structure-in-C"><a href="#structure-in-C" class="headerlink" title="structure in C++"></a>structure in C++</h2><p>in C++, structure supports member functions, is same as a public class. and the initialization can be done either in constructor function or direct initialization during definition. see <a href="https://www.quora.com/What-is-the-difference-between-C-structure-C++-structure" target="_blank" rel="external">the difference of struct between C and C++</a></p>
<h2 id="stdlib-h"><a href="#stdlib-h" class="headerlink" title="stdlib.h"></a>stdlib.h</h2><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"> /* convert string s1 to an int*/	</div><div class="line">	int atoi(const char* s1);</div><div class="line"> </div><div class="line"> /* memory op */</div><div class="line">	void* malloc(size_t size); </div><div class="line">	void free(void *ptr);</div><div class="line">	</div><div class="line"> /* system level op */</div><div class="line">	char* getenv(const char *name);</div><div class="line">	int system(const char *command); </div><div class="line"></div><div class="line">/* algorithms */</div><div class="line">	void* bsearch(const void* key, const void* base,</div><div class="line">	size_t nitems, size_t size,  int(*compar)(const void*, const void*))  </div><div class="line"></div><div class="line">	void qsort(void *base, size_t nitems, size_t size, </div><div class="line">int(*compar)(const void*, const void*))</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/24/pure-C-string/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/24/pure-C-string/" itemprop="url">pure C string</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-24T18:43:37-04:00">
                2018-07-24
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/24/pure-C-string/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/07/24/pure-C-string/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="string-initialization"><a href="#string-initialization" class="headerlink" title="string initialization"></a>string initialization</h2><p>in pure C, string is a char array terminating with NULL(‘\0’). To initialize an array of char(string) is with a string literal(a double-quotaed string).</p>
<p>in general, the string literal is used as the initializer for an array of char; anywhere else, it is a static array of chars, which shouldn’t be modified by a pointer.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* initialize a string in C </span></div><div class="line"> * the size of s1 is taken from the size of the initializer</div><div class="line"> */</div><div class="line">	<span class="keyword">char</span> s1[] = <span class="string">"hello world"</span> ; </div><div class="line"><span class="comment">// or </span></div><div class="line">	<span class="keyword">char</span> s1[<span class="number">12</span>] = <span class="string">"hello world"</span>; </div><div class="line"></div><div class="line"><span class="comment">/* common errors */</span></div><div class="line">	<span class="keyword">char</span> s2[];</div><div class="line">	s2 = <span class="string">"hello world"</span></div><div class="line"><span class="comment">// error: storage size of 's2' isn't known </span></div><div class="line"></div><div class="line">	<span class="keyword">char</span> s2[<span class="number">12</span>];</div><div class="line">	s2 = <span class="string">"hello world"</span></div><div class="line"><span class="comment">// error:  invalid array assignment </span></div><div class="line"><span class="comment">/* there is no "=" operator defined for char array in C </span></div><div class="line">   using strcpy()</div><div class="line">*/</div><div class="line"></div><div class="line">``` </div><div class="line"></div><div class="line">## <span class="keyword">char</span> pointer arithmetic </div><div class="line"></div><div class="line">```c</div><div class="line"></div><div class="line">	<span class="keyword">char</span> s1[<span class="number">12</span>];</div><div class="line">	*s1++ ;	</div><div class="line"><span class="comment">/* error:  lvalue requied as increment operand</span></div><div class="line"> * s3 is an array, can't modify the address of an array. the difference between pointer and array </div><div class="line">*/ </div><div class="line">	 <span class="keyword">char</span>* s2 = s1; </div><div class="line">	 *s2++;</div><div class="line"><span class="comment">/* s2 is a pointer to s1, ++ is ok */</span></div></pre></td></tr></table></figure>
<h2 id="string-h"><a href="#string-h" class="headerlink" title="string.h"></a>string.h</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* concatenate two strings */</span></div><div class="line"><span class="built_in">strcat</span>(<span class="keyword">char</span>* s1, <span class="keyword">const</span> <span class="keyword">char</span>* s2) ;</div><div class="line"><span class="built_in">strncat</span>(<span class="keyword">char</span>* s1, <span class="keyword">const</span> <span class="keyword">char</span>* s2, <span class="keyword">size_t</span> n); </div><div class="line"></div><div class="line"><span class="comment">/*  locate the first/last occurance of char c in string s */</span></div><div class="line"><span class="built_in">strchr</span>(<span class="keyword">const</span> <span class="keyword">char</span>* s1, <span class="keyword">int</span> c);</div><div class="line"><span class="built_in">memchr</span>(<span class="keyword">const</span> <span class="keyword">void</span>* s1, <span class="keyword">int</span> c, <span class="keyword">size_t</span> n);</div><div class="line"><span class="built_in">strrchr</span>(<span class="keyword">const</span> <span class="keyword">char</span>* s1, <span class="keyword">int</span> c); </div><div class="line"></div><div class="line"><span class="comment">/*  compare s1 and s2 alphabetically */</span></div><div class="line"><span class="built_in">strcmp</span>(<span class="keyword">const</span> <span class="keyword">char</span>* s1, <span class="keyword">const</span> <span class="keyword">char</span>* s2);	</div><div class="line"><span class="built_in">strncmp</span>(<span class="keyword">const</span> <span class="keyword">char</span>* s1, <span class="keyword">const</span> <span class="keyword">char</span>* s2, <span class="keyword">size_t</span> n);</div><div class="line"><span class="built_in">memcmp</span>(<span class="keyword">const</span> <span class="keyword">void</span>* s1, <span class="keyword">const</span> <span class="keyword">void</span>* s2, <span class="keyword">size_t</span> n);</div><div class="line"></div><div class="line"><span class="comment">/*  copy s2 to s1 */</span></div><div class="line"><span class="built_in">strcpy</span>(<span class="keyword">char</span> *s1, <span class="keyword">const</span> <span class="keyword">char</span> *s2); </div><div class="line"><span class="built_in">memcpy</span>(<span class="keyword">void</span>* s1, <span class="keyword">void</span>* s2, <span class="keyword">size_t</span> n);</div><div class="line"></div><div class="line"><span class="comment">/* number of bytes, not including terminating NULL; sizeof() will inlcude the terminating NULL */</span></div><div class="line"><span class="built_in">strlen</span>(<span class="keyword">const</span> <span class="keyword">char</span>* s1); </div><div class="line"></div><div class="line"><span class="comment">/* find the first occurance of substring s2 in s1 */</span></div><div class="line"><span class="built_in">strstr</span>(<span class="keyword">const</span> <span class="keyword">char</span> *s1,  <span class="keyword">const</span> <span class="keyword">char</span> *s2);</div><div class="line"></div><div class="line"><span class="comment">/* split string s1 into a sequence of tokens by s2 */</span></div><div class="line">strtok(<span class="keyword">char</span>* s1, <span class="keyword">const</span> <span class="keyword">char</span>* s2);</div></pre></td></tr></table></figure>
<p>\<string.h> is replaced by <cstring> in C++.<br>and be aware of <a href="https://www.cs.fsu.edu/~myers/cop3330/notes/strings.html" target="_blank" rel="external">downs of C string</a>.</cstring></string.h></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/18/which-function-is-called/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/18/which-function-is-called/" itemprop="url">which function is called</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-18T22:00:16-04:00">
                2018-07-18
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/18/which-function-is-called/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/07/18/which-function-is-called/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="which-function-is-called"><a href="#which-function-is-called" class="headerlink" title="which function is called"></a>which function is called</h1><p>when a derived object calls the base class member function, inside which calls another virtual member function, which is implemented inside the derived class, so which virtual member function is actually called ?  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Weld</span> &#123;</span></div><div class="line">	<span class="keyword">public</span>: </div><div class="line">		Weld()&#123;&#125;;</div><div class="line">		<span class="keyword">virtual</span> ~Weld()&#123;&#125;;</div><div class="line">		<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">getDataIndex</span><span class="params">()</span></span>&#123;</div><div class="line">			<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Weld::getDataIndex"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">			<span class="keyword">return</span> <span class="literal">true</span> ; </div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">bool</span> <span class="title">getInternalDataList</span><span class="params">()</span></span>&#123;	</div><div class="line">			<span class="keyword">return</span> getDataIndex();</div><div class="line">		&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpotWeld</span>:</span> <span class="keyword">public</span> Weld&#123;</div><div class="line">	<span class="keyword">public</span>:</div><div class="line">		SpotWeld()&#123;&#125;;</div><div class="line">		<span class="keyword">virtual</span> ~SpotWeld()&#123;&#125;;</div><div class="line">		<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">getDataIndex</span><span class="params">()</span></span>&#123;</div><div class="line">			<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"SpotWeld::getDataIndex"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">			<span class="keyword">return</span> <span class="literal">true</span>; </div><div class="line">		&#125;</div><div class="line"></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ACM2</span> :</span> <span class="keyword">public</span> SpotWeld&#123;</div><div class="line">	<span class="keyword">public</span>:</div><div class="line">		ACM2()&#123;&#125;;</div><div class="line">		~ACM2()&#123;&#125;;</div><div class="line">		<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">getDataIndex</span><span class="params">()</span></span>&#123;</div><div class="line">			<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"ACM2::getDataIndex"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="function"><span class="keyword">bool</span> <span class="title">getPoints</span><span class="params">()</span></span>&#123;</div><div class="line">			<span class="keyword">return</span> getInternalDataList();</div><div class="line">		&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">	ACM2  acm2 ;</div><div class="line">	acm2.getPoints();</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>output is:</p>
<pre><code>ACM2::getDataIndex
</code></pre><p>so the derived object always calls the member function that most closest to its own class domain first, even if this member function is called from a base class member function.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/13/multi-core-at-work/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/13/multi-core-at-work/" itemprop="url">multi-core at work</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-13T17:21:04-04:00">
                2018-07-13
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/13/multi-core-at-work/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/07/13/multi-core-at-work/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="NUMA"><a href="#NUMA" class="headerlink" title="NUMA"></a>NUMA</h2><p>uniform memory arch,  all CPUs in the same sokcet shall the memory, and the memory IO is bottleneck; non uniform memory acess(NUMA), each CPU has itw own memory, inter-CPU memory access is remote.</p>
<pre><code>numctl  cpu_node_bind
MPI binding APIs
</code></pre><p>memory allocation strategy in NUMA</p>
<pre><code>interleave: place the memory on alternating node,
the first memory portion in node0, the next 
portion in node1
membind: forcely to allocate memory in special node
</code></pre><h2 id="CPU-affinity"><a href="#CPU-affinity" class="headerlink" title="CPU affinity"></a>CPU affinity</h2><p>the benifit of CPU affinity is to reduce context switch since one special process is binded to one speical CPU, so the data required in this process (no other process data will be switched in), can always in the CPU cache. espcially for NUMA arch to access data locally. and this is specially true when the application generate a large cache footprint, e.g. in scientific computing.</p>
<p>for general applications, CPU afinity may reduce performance, since in this way the CPU scheduler can’t work properly.</p>
<h2 id="CPU-info"><a href="#CPU-info" class="headerlink" title="CPU info"></a>CPU info</h2><pre><code>/proc/cpuinfo
</code></pre><p>physical id:  socket index<br>siblings:   number of cores in each socket<br>core id:   current core index </p>
<p>e.g. Ford HPC CPU architecture:</p>
<pre><code>2 or 4 CPU sockets group into one computing node
each socket has 10 or 12 CPU cores
each socket has a on-board shared memory
</code></pre><h2 id="atomic-operation"><a href="#atomic-operation" class="headerlink" title="atomic operation"></a>atomic operation</h2><p>CPU physical mechanism:</p>
<pre><code>physically there is a bus #hlock pin. 
if #lock is added before the assembly instruction, 
the corresponding machine code will be pulled down
during the execution of the #hlock pin till the
end, basically the bus is locked only for current 
instruction
</code></pre><p>cache coherence:</p>
<p>the cache unit tranfered between CPU and main memory is cache line. in one socket, as slibings share L3 cache, there is an scenario, when CPU1 modified one variable, but not yet writen to main memory, and CPU2 read from main memory and did modified again, then the variable in CPU1 and CPU2 is not coherence. </p>
<pre><code>volatile in C, forcely to read the variable value 
from main memory every time, to avoid use dirty
memory in cache
</code></pre><p>another scenario, to achieve and cache coherence, and the same variable is read and write repeatly by multiple processes, the performance is worse, “false sharing” </p>
<p>lock:</p>
<pre><code>signal, also called &quot;sleeping lock&quot;: used when the
lock need to keep for a longer time 
spin lock: at most hold by one thread, to block
other threads into critial area, used to keep 
for a short time.
write/read lock:
</code></pre><h2 id="system-performance"><a href="#system-performance" class="headerlink" title="system performance"></a>system performance</h2><p>resident memory(res), the portion of virtual memory space that is actually in RAM; swapped memory, when the physical memory is full and the system needs more memory, inactive pages in memory moved to the shared space, and swapped usable memory in</p>
<pre><code>virtual memory = res memory +  swapped memory
</code></pre><p>mmap, to access the remote (data block) like access local RAM. </p>
<p>voluntary context switches(vcs):</p>
<pre><code>when a thread makes a system call that blocks. vcs
measures the frequency of calling blocked system I/O 
</code></pre><p>involuntary context switches(ivcs):</p>
<pre><code>when a thread has being runing too long without
making a system call that blocks, and there are
other processes waiting for CPU, then OS will
switch for other CPUs. ivcs measures the CPU
competition, an unfinished processed is switched off
</code></pre><p>in general, as more threads, the context switch cost increase, due to the total amount of switch increase and as well each switch is more expensive, since CPU cache is limited, and each process will hold fewer data in cache. </p>
<p>cpu_time (clock_t):<br>    the total amount of time that a process has actually used</p>
<p>user CPU time:<br>     the amount of time spend in user space running </p>
<p>system CPU time:<br>      the amount of time spent during kernel space running </p>
<p>wall-clock time:<br>    the whole time from the process start to end</p>
<h2 id="Linux-IPC"><a href="#Linux-IPC" class="headerlink" title="Linux IPC"></a>Linux IPC</h2><p>inter-process communication(IPC) share memory is used in our application to cowork with MPI. while IPC helps to balance memory distributed in multi computing nodes, and MPI threads are the working horse to eat shared data. there are other IPC libs, e.g.  Boost.interprocess.</p>
<pre><code>ftok() -&gt; to generate a IPC key, based on a special file path

shmget() -&gt; generate a shared memory portion and return a shm_id

shmat() -&gt; attach to the shm_id and return a pointer to that shared memory

shmctl() 

shmdt() 
</code></pre><p>in design, all threads call shmget() to get a pointer to the share memory section, but actually only master thread do create the portion, others read it. since all thread can access the share memory section, it’s important to keep the first returned pointer from master thread clean/unpolluated. </p>
<h1 id="MPI"><a href="#MPI" class="headerlink" title="MPI"></a>MPI</h1><p>there are a few <a href="http://mpitutorial.com/tutorials" target="_blank" rel="external">basic MPI APIs</a>. </p>
<p>in our project, to benefit both CPU and memory performance, we actually need: 1) subgroup the MPI comm, 2) bind MPI threads to sockets.</p>
<pre><code>MPI_COMM_GROUP()
MPI_Group_incl() 
MPI_COMM_create()
</code></pre><p>apis and numctl during run-time:</p>
<pre><code>mpirun -bycore -bind-to-socket -&gt; bind process to each core on the socket 

mpirun -bysocket  -bind-to-socket 

mpirun numctl -membind=0 -np 32 ./run 
</code></pre>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/12/vehicle-network/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/12/vehicle-network/" itemprop="url">vehicle network</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-07-12T17:55:12-04:00">
                2018-07-12
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/12/vehicle-network/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/07/12/vehicle-network/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>vehicle networ is what connects the different parts together as a vehile. </p>
<h2 id="the-lower-level-basic"><a href="#the-lower-level-basic" class="headerlink" title="the lower-level basic"></a>the lower-level basic</h2><p>A few basic concepts:  TCP/UDP socket, CAN Bus, Ethernet, MCU register, Ip address, MAC address, Ethernet driver, network configure, how to code a ECU/MCU etc. </p>
<p>there are EE students working on this close to physical level implementation, on how to talk with register, MCU pins and controls, and some implementing the data traffic protocol in network. While both are isolated from top applications, since no matter where the data come from, either AV application or connected vehicle or media data, doesn’t make a difference.  </p>
<h2 id="architecture"><a href="#architecture" class="headerlink" title="architecture"></a>architecture</h2><p> <a href="https://autoelectricalsystems.wordpress.com/2015/11/07/typical-vehicle-network-architecture/" target="_blank" rel="external">typical vehicle network architecture</a></p>
<p>beyond the basic, network architecture brings a good vision to understand what makes a vehicle electronicly as a whole. and which is serving all apps with v2x, in-vehicle entertainment, AV.</p>
<p>I was thought ECU handling events the same as web server. while they are very different. each ECU is doing only one special task. e.g. ABS ECU only dealing with ABS events, there are no many ABS events happening simultaneously to seize the ECU computing resource; however, a web server have to deal with multiplex request simultaneously, either using thread pool or asynchronous event callbacks. </p>
<p>each ECU actually has an easy life, but the bus seems easily choked since around 100+ ECU nodes in the vehicle network. however again, typical vehicle network architecture is very matured products, without data-heavy applications arising, current CAN bus is great.</p>
<h2 id="smart-phone-in-wheels"><a href="#smart-phone-in-wheels" class="headerlink" title="smart phone in wheels?"></a>smart phone in wheels?</h2><p>one day in future, every vehicle running on road is requesting some data from cloud seamlessly, the scenario is like billions of browsers send requests to Google server seamlessly, then the cloud may face same issues in today’s web server. </p>
<p>Service oriented architecture(SOA) is also rising in vehicle network architeture design, but what kind of services is better locally in vehicle, and which services in cloud ? as hardwares evolution, even the computing-heavy tasks, e.g. vision based detection, path planning in AV, suppose not be a burden for local ECUs. so these services make sense locally served.  </p>
<p>except that, I only image future vehicle as a smart phone on wheels. so remote cloud server do connect to, e.g. talk to another vehicle, play online game during driving, check weather, find out a parking lot, resturant or similar, or the car company want to steal user data privately? </p>
<p>SOA is a good move to decouple ECU modules and make the network bus light, and it’s fun to try some vehicle network architecture open project or play with ROS simulator if hardware required. but in a business view, I don’t know a good story to attract investors, namely vehicle network sounds not that blinking amazing.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/29/gnu-make/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/29/gnu-make/" itemprop="url">gnu-make</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-06-29T17:45:40-04:00">
                2018-06-29
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/06/29/gnu-make/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/06/29/gnu-make/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p> websocket projects recently reviewed: <a href="https://github.com/uNetworking/uWebSockets" target="_blank" rel="external">uWebSocket</a>, which is used in Udacity self-driving car term2 projects. the other is <a href="https://github.com/warmcat/libwebsockets" target="_blank" rel="external">libwebsocket</a>, which is used in <a href="https://github.com/otcshare/automotive-message-broker/tree/master/ambd" target="_blank" rel="external">automotive message broker</a>(amb). </p>
<h2 id="gcc-compiler-options"><a href="#gcc-compiler-options" class="headerlink" title="gcc compiler options"></a>gcc compiler options</h2><p><a href="https://www3.ntu.edu.sg/home/ehchua/programming/cpp/gcc_make.html" target="_blank" rel="external">gcc and make:  a tutorial on how to compile, link and build c/c++ projects</a></p>
<pre><code>-wall : print all warning messages 
-c : compile into object, by default the object has same name as the source file
-o : specify the output executable filename
</code></pre><h2 id="headers-h-static-libs-lib-a-amp-shared-libs-dll-so"><a href="#headers-h-static-libs-lib-a-amp-shared-libs-dll-so" class="headerlink" title="headers(.h), static libs(.lib, .a) &amp; shared libs(.dll, .so)"></a>headers(.h), static libs(.lib, .a) &amp; shared libs(.dll, .so)</h2><p>gcc by default, links to the shared libraries if available.</p>
<p>the compiler search “include-paths” for headers, which is specified via -L\<dir\> option or CPATH; </dir\></p>
<p>the linker search “library-paths” to link the program into an executable object, which is specified via -L\<dir\> or LIBRARY_PATH, in addition, need to specify the library name via -l<name></name></dir\></p>
<p>the system default “include-paths” can be found by “cpp -v”</p>
<h2 id="gcc-environment-variables"><a href="#gcc-environment-variables" class="headerlink" title="gcc environment variables"></a>gcc environment variables</h2><p>PATH is used to search executable and run-time shared libs. (woo, this suppose to replace LD-LIBRARY-PATH)<br>CPATH is used to search “include-paths”, it’s searched after paths specified in -I&lt;dir> options. C_INCLUDE_PATH &amp; CPLUS_INCLUDE_PATH can be used to specify C &amp; C++ headers<br>LIBRARY_PATH is used to search linking-time “library-paths”, it’s searched after paths specified in -L\<dir\> options. the standard directories is  /usr/lib </dir\></p>
<h2 id="Linux-utils"><a href="#Linux-utils" class="headerlink" title="Linux utils"></a>Linux utils</h2><p>1) readelf: read <a href="https://amir.rachum.com/blog/2016/09/17/shared-libraries/" target="_blank" rel="external">ELF</a> </p>
<p>2) ldconfig : by default, read /etc/ls.so.conf, sets up the appropirate symbolic links in the dynamic link dir, and then write a cache to /etc/ld.so.cache, which then is used by other programs</p>
<p>3) ldd: to see recursive shared library dependencies</p>
<p>4) file: determine file type </p>
<p>5) nm: list symbol table of an object file, commonly-used to check if a particular func or variable is defined in an object file. “T” indicates   it is defined; “U” means undefined, which should be resolved by the linker.</p>
<h2 id="make-amp-cmake"><a href="#make-amp-cmake" class="headerlink" title="make &amp; cmake"></a>make &amp; cmake</h2><p>[gnu make] (<a href="https://www.gnu.org/software/make/manual/html_node/index.html#SEC_Contents" target="_blank" rel="external">https://www.gnu.org/software/make/manual/html_node/index.html#SEC_Contents</a>) </p>
<p>there are many best practical, e.g. <a href="https://gist.github.com/mbinna/c61dbb39bca0e4fb7d1f73b0d66a4fd1" target="_blank" rel="external">effective cmake</a></p>
<h2 id="build-libuv"><a href="#build-libuv" class="headerlink" title="build libuv"></a>build libuv</h2><p>it’s built based on GNU autotools</p>
<pre><code>sh autogen.sh  
&quot;libtoolize: AC_CONFIG_MACRO_DIR([m4]) conflicts with ACLOCAL_AMFLAGS=-I m4&quot;
</code></pre><p><a href="https://pete.akeo.ie/2010/12/that-darn-libtoolize-acconfigmacrodirm4.html" target="_blank" rel="external">fixing-solution</a>, then make all &amp; make install, so here is libuv.so, add the directory to \$LIBRARY_PATH in ~/.bashrc </p>
<h2 id="build-uWebSockets"><a href="#build-uWebSockets" class="headerlink" title="build uWebSockets"></a>build uWebSockets</h2><p>it’s built based on gnu make. the tests command has dependents on libuv. since already added libuv directory to \$LIBRARY_PATH, run through. if else, errors output:</p>
<pre><code>cannot find -luv
collect2: error: ld returned 1 exit status
Makefile:xx recipe for targe &apos;tests&apos; failed    
make: *** [tests] Error 1 
</code></pre><p>try to run ./testsBin, get another error:</p>
<pre><code>error while loading shared libraries: libuWS.so: cannot open shared object file: No such file or directory 
</code></pre><p>that’s run-time error, since libuWS.so is not included in \$PATH or speically for building/testing purpose, define $LD_LIBRARY_PATH. </p>
<h2 id="build-libwebsockets"><a href="#build-libwebsockets" class="headerlink" title="build libwebsockets"></a>build libwebsockets</h2><p>it’s built based on cmake. there is some dependent, but should go through well.</p>
<h2 id="beyond-the-note"><a href="#beyond-the-note" class="headerlink" title="beyond the note"></a>beyond the note</h2><p>when 2-months ago, looking at amb project, which has websocket plugin module, then find uWebSocket lib, during reading this tiny lib, where libuv APIs are highly-used, and soon found out libuv is actually the event-loop in nodejs. Woo, somehow they are related.</p>
<p>build tools are highly used in each project, but prior experience is more done by luck.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/25/career-thoughts/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/25/career-thoughts/" itemprop="url">career thoughts</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-06-25T16:49:59-04:00">
                2018-06-25
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/06/25/career-thoughts/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/06/25/career-thoughts/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="product-data-managment"><a href="#product-data-managment" class="headerlink" title="product data managment"></a>product data managment</h2><p>an interesting meeting with material research group, these guys have some IT needs, but does’nt reach there. e.g. there are plenty of material fatigue data, including metadata, tables, S-N plots, so how to organize/manage them? one solution is from MSC Material Center[<a href="http://www.mscsoftware.com/news/msc-software-reinvents-materials-lifecycle-management-materialcenter" target="_blank" rel="external">http://www.mscsoftware.com/news/msc-software-reinvents-materials-lifecycle-management-materialcenter</a>]</p>
<p>what triggered me is “data management” in general. In manufacturing industry, like automotive, many old style data used and storied in different departments, e.g. the material property data, load time history data for CAE department, the vehicle diagnostic logging data in vehcile control department, the vehicle dynamics records in vehicle test department. but neither are well-structured nor easy to track.</p>
<p>two fields so far:  data dashboard, requires data visulization and data mining; product lifecycle management, it’s a product driven, and may also have data dashboard needs. currently as I see, most data analysis is in bussiness driven view, not in product itself. how to accelerate product iteration through better using history products data suppose to be a big thing. </p>
<p>on another side, industry data management is a little different than bussiness/market data. e.g. every year Ford releases a new F-150 truck, does it start out of new? no, the 2018 mois stly iterate by the 2017. so there is product data management, just managed through all component departments. </p>
<p>maybe the questions should ask is: 1 do we get the most value from these whole product level data? 2 how to make special data manageble at subsystem level? it needs more experience in the whole process, but bring some thoughts in next career: PLM software and data management in special domain, e.g. material datacenter product. </p>
<h2 id="cloud-CAE"><a href="#cloud-CAE" class="headerlink" title="cloud CAE"></a>cloud CAE</h2><p>since dashboard is so popluar to migrate the traditional software GUI to web/mobile app; and CAE solver can deployed in cloud, which is a better stronger reason to do user-side dashboard: with job submission, job status, and result plot/visulization sections.</p>
<p>but why is it necessary to migrate CAE solvers in cloud? why the manufacturing product companines would like to share their prodcuts data with cloud providers? </p>
<p>turn one step back, the most obvious reason is whenever internet is needed, e.g. communication among different end-users, cloud is good chonice; and for startup companies, who can’t afford to run jobs locally, have to migrate their calculation in cloud. </p>
<p>I am kind of curious who is using AWS? Netflix, BMW, Autodesk! I was so suprised at first, how BMW and Autodesk would like to use AWS? anyway Netflix is data-flow based company, the core business is client-server communication, which make sense to use AWS. </p>
<p>while BMW is using AWS for new business: connected service, all a sudden it makes sense. the car product business won’t be shared with AWS, but cloud is required as infrastructure for v2x connected service. that’s amazing.</p>
<p>AutoDesk say a different story in cloud, since they sell CAD softwares,  few people want to buy and own an expensive software but choose to pay for the service, by all meaning, this is not a new business, but AWS offer a mature channel.</p>
<p>even though, cloud providers say they are cost-reducing, high-scalability, but I don’t think manufacturing companies will buy it due to security,  instead they maintain their own clusters and share limited business in cloud.</p>
<p>so standing in manufacturing industry, it’s better to figure out new services, which require communications through cloud, than migrate CAE solvers to cloud. that’s my second point.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/20/muduo3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/20/muduo3/" itemprop="url">muduo 3</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-06-20T17:17:33-04:00">
                2018-06-20
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/06/20/muduo3/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/06/20/muduo3/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>one concern yesterday: does each worker thread call loop() and run the whole active channels callback ?</p>
<p>suppose no. let’s track the process :</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">tcpServer.start() -&gt;</div><div class="line">	threadPool.start() -&gt;</div><div class="line">		<span class="keyword">new</span> EventLoopThread(eventLoopThread::threadFunc, threadName)</div><div class="line">		eventLoopThread-&gt;startLoop() -&gt;</div><div class="line">	   		thread.start() -&gt; detail::startThread() -&gt; </div><div class="line">	   		runInThread()::func_()</div></pre></td></tr></table></figure>
<p>the real func_ during creating new eventLoopThread, is threadFunc(), in which call loop.loop().</p>
<p>first, this loop object is created inside this new eventLoopThread object, no issue that the loop.threadId_ is current threadID. </p>
<p>when multiple worker threads exist, what happens ?</p>
<table>
<thead>
<tr>
<th>threads</th>
<th style="text-align:center">A</th>
<th style="text-align:center">B</th>
<th style="text-align:right">C</th>
</tr>
</thead>
<tbody>
<tr>
<td>conns</td>
<td style="text-align:center">T1</td>
<td style="text-align:center">T2</td>
<td style="text-align:right">T3</td>
</tr>
</tbody>
</table>
<p>suppose T1 is assigend to worker thread A, etc. when calling  eventLoopThread A.loop(),  epoll_wait() is first called and return number of active events, epoll_wait() is thread-safe, no worry.</p>
<p>then activeChannels:HandleEvents() is called. the real executor of this handleEvents is in the TcpConnection objects, namely: T1 or T2 or T3.</p>
<p>each TcpConnection object has its own loop-, and only the worker thread with the same loop- can execute the events. so even though threadA get the list of all active events, but only events in T1 conenction will be executed by threadA.</p>
<p>so we can see, in per (worker) thread per epoll, each (worker) epoll looks like only return the active channels/events in current worker thread’s eventLoop. There is no conflict among multiple worker threads, since each worker threas has its own eventLoop. </p>
<h2 id="how-about-eventLoop-in-server-client"><a href="#how-about-eventLoop-in-server-client" class="headerlink" title="how about eventLoop in server/client"></a>how about eventLoop in server/client</h2><p>the eventLoopThread is kind of triggered inside Muduo, where is Tcp server/client eventLoop triggered ? from outsiders.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/19/muduo2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/19/muduo2/" itemprop="url">moduo 2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-06-19T22:16:11-04:00">
                2018-06-19
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/06/19/muduo2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/06/19/muduo2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>The several classes defined in Moduo: TcpServer,  Acceptor, TcpConnection, EventLoop, epoller, channel, eventLoopThread, eventLoopThreadPool.</p>
<h2 id="1-TcpServer-construction"><a href="#1-TcpServer-construction" class="headerlink" title="1) TcpServer construction"></a>1) TcpServer construction</h2><p>each TcpServer suppose have multi- tcp connections, the acceptor works as the main I/O thread, which listen the server-side I/O socket, and handle all client input connections at first, (later will assign the connection task to each worker thread from pool). so the input argument “loop” during TcpServer construction is the main I/O eventLoop. </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">TcpServer::TcpServer(EventLoop* loop,</div><div class="line">                     <span class="keyword">const</span> InetAddress&amp; listenAddr,</div><div class="line">                     <span class="keyword">const</span> <span class="built_in">string</span>&amp; nameArg,</div><div class="line">                     Option option)</div><div class="line">  : loop_(CHECK_NOTNULL(loop)),	                  ipPort_(listenAddr.toIpPort()),</div><div class="line">    name_(nameArg),</div><div class="line">    acceptor_(<span class="keyword">new</span> Acceptor(loop, listenAddr, option == kReusePort)),</div><div class="line">    threadPool_(<span class="keyword">new</span> EventLoopThreadPool(loop, name_)),		    connectionCallback_(defaultConnectionCallback),</div><div class="line">    messageCallback_(defaultMessageCallback),</div><div class="line">    nextConnId_(<span class="number">1</span>)</div><div class="line">&#123;</div><div class="line">  acceptor_-&gt;setNewConnectionCallback(</div><div class="line">      boost::bind(&amp;TcpServer::newConnection, <span class="keyword">this</span>, _1, _2));</div><div class="line">&#125;</div><div class="line"></div><div class="line">``` </div><div class="line"></div><div class="line">one advantage of bind/callback is to <span class="keyword">import</span> functors to different <span class="class"><span class="keyword">class</span> <span class="title">domain</span>. <span class="title">and</span> <span class="title">server</span> <span class="title">has</span> <span class="title">always</span> <span class="title">one</span> <span class="title">I</span>/<span class="title">O</span> <span class="title">socket</span>, <span class="title">but</span> <span class="title">client</span>-<span class="title">socket</span>-<span class="title">fd</span> <span class="title">suppose</span> <span class="title">be</span> <span class="title">a</span> <span class="title">lot</span>. </span></div><div class="line"></div><div class="line">## 2) <span class="title">TcpServer</span> <span class="title">newConnection</span></div><div class="line"><span class="title">Each</span> <span class="title">new</span> <span class="title">tcp</span> <span class="title">connection</span>, <span class="title">will</span> <span class="title">assign</span> <span class="title">a</span> <span class="title">worker</span> <span class="title">thread</span> <span class="title">to</span> <span class="title">execute</span> <span class="title">the</span> <span class="title">speical</span> <span class="title">callback</span> <span class="title">functor</span> <span class="title">for</span> <span class="title">this</span> <span class="title">new</span> <span class="title">connection</span>, <span class="title">How</span> <span class="title">to</span> <span class="title">schedule</span> <span class="title">thread</span> <span class="title">in</span> <span class="title">threadpool</span> <span class="title">is</span> <span class="title">implemented</span> <span class="title">by</span> <span class="title">round</span>-<span class="title">robin</span>, <span class="title">which</span> <span class="title">are</span> <span class="title">implemented</span> <span class="title">as</span>:</div><div class="line"></div><div class="line">```c</div><div class="line">ioLoop-&gt;runInLoop(boost::bind(&amp;TcpConnection::connectEstablished, conn));  </div><div class="line">EventLoopThreadPool::getNextLoop()</div></pre></td></tr></table></figure>
<h3 id="does-each-worker-thread-run-EventLoop-loop-which-will-call-epoll-wait-and-execute-all-active-channels-suppose-no"><a href="#does-each-worker-thread-run-EventLoop-loop-which-will-call-epoll-wait-and-execute-all-active-channels-suppose-no" class="headerlink" title="does each worker thread run EventLoop.loop(), which will call epoll_wait(), and execute all active channels? suppose no."></a>does each worker thread run EventLoop.loop(), which will call epoll_wait(), and execute all active channels? suppose no.</h3><h2 id="3-TcpConnection-construction"><a href="#3-TcpConnection-construction" class="headerlink" title="3) TcpConnection construction"></a>3) TcpConnection construction</h2><p>each new client connection will reponse to a new socket fd, and a new channel. (channel is actually the container of socket fd); and the functors on this connection is also imported to channel callbacks. basically from outside, we only see channel objects, TcpConnection object is the inner class. </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">TcpConnection::TcpConnection(EventLoop* loop,</div><div class="line">                             <span class="keyword">const</span> <span class="built_in">string</span>&amp; nameArg,</div><div class="line">                             <span class="keyword">int</span> sockfd,</div><div class="line">                             <span class="keyword">const</span> InetAddress&amp; localAddr,</div><div class="line">                             <span class="keyword">const</span> InetAddress&amp; peerAddr)</div><div class="line">  : loop_(CHECK_NOTNULL(loop)),</div><div class="line">    name_(nameArg),</div><div class="line">    state_(kConnecting),</div><div class="line">    reading_(<span class="literal">true</span>),</div><div class="line">    socket_(<span class="keyword">new</span> Socket(sockfd)),</div><div class="line">    channel_(<span class="keyword">new</span> Channel(loop, sockfd)),</div><div class="line">    localAddr_(localAddr),</div><div class="line">    peerAddr_(peerAddr),</div><div class="line">    highWaterMark_(<span class="number">64</span>*<span class="number">1024</span>*<span class="number">1024</span>)</div><div class="line">&#123;</div><div class="line">  channel_-&gt;setReadCallback(</div><div class="line">      boost::bind(&amp;TcpConnection::handleRead, <span class="keyword">this</span>, _1));</div><div class="line">  channel_-&gt;setWriteCallback(</div><div class="line">      boost::bind(&amp;TcpConnection::handleWrite, <span class="keyword">this</span>));</div><div class="line">  channel_-&gt;setCloseCallback(</div><div class="line">      boost::bind(&amp;TcpConnection::handleClose, <span class="keyword">this</span>));</div><div class="line">  channel_-&gt;setErrorCallback(</div><div class="line">      boost::bind(&amp;TcpConnection::handleError, <span class="keyword">this</span>));</div><div class="line">  LOG_DEBUG &lt;&lt; <span class="string">"TcpConnection::ctor["</span> &lt;&lt;  name_ &lt;&lt; <span class="string">"] at "</span> &lt;&lt; <span class="keyword">this</span></div><div class="line">            &lt;&lt; <span class="string">" fd="</span> &lt;&lt; sockfd;</div><div class="line">  socket_-&gt;setKeepAlive(<span class="literal">true</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>so where are channel (read/write/error/close) handleEvent callbacks triggered? it is during the eventloop.loop, after epoller return the active events, based on the status of each revent, special handleEvent is called.</p>
<h2 id="4-eventLoop-construction"><a href="#4-eventLoop-construction" class="headerlink" title="4) eventLoop construction"></a>4) eventLoop construction</h2><p>during constrution of eventLoop, a new poller is created based on this eventLoop itself, also a new wakeupfd and a new wakeupChannel. the purpose of wakeup fd/channel is to  immediately wake up the work thread, rather than waiting till PollTime. and the wakeupfd bind handleRead, in which read one byte to make this wakeupfd I/O readable, which then is ready for I/O. </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">EventLoop::EventLoop()</div><div class="line">  : looping_(<span class="literal">false</span>),</div><div class="line">    quit_(<span class="literal">false</span>),</div><div class="line">    eventHandling_(<span class="literal">false</span>),</div><div class="line">    callingPendingFunctors_(<span class="literal">false</span>),</div><div class="line">    iteration_(<span class="number">0</span>),</div><div class="line">    threadId_(CurrentThread::tid()),</div><div class="line">    poller_(Poller::newDefaultPoller(<span class="keyword">this</span>)),</div><div class="line">    timerQueue_(<span class="keyword">new</span> TimerQueue(<span class="keyword">this</span>)),</div><div class="line">    wakeupFd_(createEventfd()),		</div><div class="line">    wakeupChannel_(<span class="keyword">new</span> Channel(<span class="keyword">this</span>, wakeupFd_)),</div><div class="line">    currentActiveChannel_(<span class="literal">NULL</span>)</div><div class="line">&#123;</div><div class="line">  LOG_DEBUG &lt;&lt; <span class="string">"EventLoop created "</span> &lt;&lt; <span class="keyword">this</span> &lt;&lt; <span class="string">" in thread "</span> &lt;&lt; threadId_;</div><div class="line">  <span class="keyword">if</span> (t_loopInThisThread)</div><div class="line">  &#123;</div><div class="line">    LOG_FATAL &lt;&lt; <span class="string">"Another EventLoop "</span> &lt;&lt; t_loopInThisThread</div><div class="line">              &lt;&lt; <span class="string">" exists in this thread "</span> &lt;&lt; threadId_;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">else</span></div><div class="line">  &#123;</div><div class="line">    t_loopInThisThread = <span class="keyword">this</span>;</div><div class="line">  &#125;</div><div class="line">  wakeupChannel_-&gt;setReadCallback(</div><div class="line">      boost::bind(&amp;EventLoop::handleRead, <span class="keyword">this</span>));	    <span class="comment">// we are always reading the wakeupfd</span></div><div class="line">  wakeupChannel_-&gt;enableReading();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>“activeChannels” suppose to be a class variable, which is shared by eventLoop objects, but it’s ok to keep a copy for each eventLoop object to avoid multi-thread competing. and suppose epoll_wait() is thread-safe, so later during construction of eventLoopThreadPool, multi eventLoopThreads won’t conflict with “active channels”</p>
<h2 id="5-epoller-construction"><a href="#5-epoller-construction" class="headerlink" title="5) epoller construction"></a>5) epoller construction</h2><p>epoller object is created during eventloop construction. since the three interface of epoll instance are thread-safe, they look like global funcs.</p>
<p>epoll_create(), return an epfd referring to the new epoll instance, this epfd is used by all subsequent calsl to the epoll interface. </p>
<p>epoll_wait(), return all ready events on the epoll instance referred by epfd. </p>
<p>epoll_ctl(), traverse the red-black tree strucutre to return the existing fd, or add new fd to the tree. </p>
<h2 id="6-channel-construction"><a href="#6-channel-construction" class="headerlink" title="6) channel construction"></a>6) channel construction</h2><p>channel is the container of one fd, and is related to one eventLoop. channel is not responsible to create/delete fd, the real owner of each fd is TcpConnection or acceptor. Channel object works like a pipe to send fd from inner object TcpConnection to the eventLoop. the advantage  here is eventLoop is independent from connections. </p>
<h2 id="7-channel-update"><a href="#7-channel-update" class="headerlink" title="7) channel:update()"></a>7) channel:update()</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">channel::update() --&gt;</div><div class="line">	loop-&gt;updateChannel() --&gt; </div><div class="line">		poller-&gt;updateChannel() --&gt;</div><div class="line">			<span class="comment">//poller maintain a channel list, call epoll_ctl to add/return/delete the requiring channel</span></div></pre></td></tr></table></figure>
<h2 id="8-one-epoll-threadpool-vs-per-thread-per-epoll"><a href="#8-one-epoll-threadpool-vs-per-thread-per-epoll" class="headerlink" title="8) one epoll + threadpool vs per thread per epoll"></a>8) one epoll + threadpool vs per thread per epoll</h2><p>the first method, one global epoll listens all new connections, and send each connection callback to a new thread to execute. method 2, to listen the server I/O socket need to bind a unique epoll, in Moduo which is the acceptor epoll. then all client connection socket will be dealt with their own worker epoll.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/12/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><span class="page-number current">13</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/14/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="David Z.J. Lee" />
          <p class="site-author-name" itemprop="name">David Z.J. Lee</p>
           
              <p class="site-description motion-element" itemprop="description">what I don't know</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">138</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">33</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/ZJLi2013" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.linkedin.com/in/zhengjia13/" target="_blank" title="LinkedIn">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  LinkedIn
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">David Z.J. Lee</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://zjlee.disqus.com/count.js" async></script>
    

    

  




	





  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
