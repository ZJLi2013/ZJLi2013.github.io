<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="what I don&apos;t know">
<meta property="og:type" content="website">
<meta property="og:title" content="Serious Autonomous Vehicles">
<meta property="og:url" content="http://yoursite.com/page/6/index.html">
<meta property="og:site_name" content="Serious Autonomous Vehicles">
<meta property="og:description" content="what I don&apos;t know">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Serious Autonomous Vehicles">
<meta name="twitter:description" content="what I don&apos;t know">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/6/"/>





  <title>Serious Autonomous Vehicles</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Serious Autonomous Vehicles</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/22/Lidar-in-AV/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/22/Lidar-in-AV/" itemprop="url">Lidar in  AV</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-22T02:51:30-04:00">
                2019-06-22
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/06/22/Lidar-in-AV/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/06/22/Lidar-in-AV/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>science, religion, music, universe as well as other sources of beauty, are what we humans should look for.  – zj </p>
<hr>
<h4 id="operational-theory"><a href="#operational-theory" class="headerlink" title="operational theory"></a>operational theory</h4><p><a href="http://web.pdx.edu/~jduh/courses/geog493f12/Week04.pdf" target="_blank" rel="external">a pulse</a> of light is emitted and the precise time is recorded. the reflection of that pulse is detected and the precise time is recorded. using the constant speed of light and the delay can convert into distance, with the known position and orientation of the sensor,  the xyz position of the reflective surface can be calculated. </p>
<h4 id="components"><a href="#components" class="headerlink" title="components"></a>components</h4><ul>
<li><p>laser scanner/emitter and laser detector </p>
</li>
<li><p>high-precision clock</p>
</li>
<li><p>GPS and GPS ground station<br>  record xyz of the scanner</p>
</li>
<li><p>IMU<br>  record angular orientation of the scanner </p>
</li>
</ul>
<h4 id="field-of-view-FOV"><a href="#field-of-view-FOV" class="headerlink" title="field of view(FOV)"></a>field of view(FOV)</h4><p><a href="http://www.wangdali.net/lidar/" target="_blank" rel="external">azimuth</a> with fixed vertical angle resolution, the neighboring laser emmiter-detector pair will create concentric circle, the distance between two neighboring concentric circle will grow with the distance from detected objects to Lidar. </p>
<p><img src="http://www.wangdali.net/wp-content/uploads/2017/04/point_cloud.png" alt="pic of point cloud concentric circle"></p>
<h4 id="light-source"><a href="#light-source" class="headerlink" title="light source"></a>light source</h4><p><a href="https://blog.csdn.net/real_myth/article/details/78636592" target="_blank" rel="external">950nm wavelength</a> producer is Si-based, which makes it cheaper than 1550nm, the InGaAs based, making it safer to human eyes as 950nm can burn retina and powerful.</p>
<p>1550nm is easier to be absorbed by water than 950nm, which makes it performance better in rainy days. </p>
<p>the laser source emiss lines of pulse every frame, and a few photon return back to Photodetector(光电探测器), there are lots of env photons(noise), we can use narrow-band-filter to tick off some env photons, but not all of them, since the solar radiation is in the range from 905nm 50 1550nm. </p>
<h4 id="solid-state"><a href="#solid-state" class="headerlink" title="solid-state"></a>solid-state</h4><p>there are two ways ongoing:  <a href="https://www.eefocus.com/automobile-electronics/397344/r0" target="_blank" rel="external">MEMS based</a>,  phased array tech(相位阵列）. MEMS tech is using a micro scaning mirror, either rotate or vibrate to control laser direction. the drawback of micro-mirror is the in the process of relection, lots of laser energy is lost. </p>
<p>phased array tech(Quanergy) integerated multi micro laser emission into one socket to control laser direction. and the drawback at this moment is the short detection distance. </p>
<p>the traditional mechanical design Lidar(Velodye) usually has multi light emitters as well as multi corresponded light detectors. while SS-Lidar depends only on one single light emitter and the scanning mirror to control emission direction, which makes it cheaper. for example,  each pair of mechanical <a href="https://www.eefocus.com/automobile-electronics/397344/r0" target="_blank" rel="external">emitter-detector cost</a> <code>200</code> us dollar, so a 64 lines product will cost about <code>12800</code> us dollar, compared to MEMS socket about <code>200</code> us dollar each.</p>
<h4 id="detection-distance-dd-amp-angle-resolution-ar"><a href="#detection-distance-dd-amp-angle-resolution-ar" class="headerlink" title="detection distance(dd) &amp; angle resolution(ar)"></a>detection distance(dd) &amp; angle resolution(ar)</h4><p>detection distacne with 10 % reflectivity</p>
<p>vertical angle range(var)</p>
<p>vertical angle resolution(va_res)</p>
<table>
<thead>
<tr>
<th>company</th>
<th>product</th>
<th>dd(m)</th>
<th>var</th>
<th>va_res</th>
<th>channels</th>
</tr>
</thead>
<tbody>
<tr>
<td>Hesai</td>
<td>Pandar40</td>
<td>200</td>
<td>23&deg;</td>
<td>0.33&deg;</td>
<td>40</td>
</tr>
<tr>
<td>Robo sense</td>
<td>RS-Lidar-32</td>
<td>200</td>
<td>40&deg;</td>
<td>0.33&deg;</td>
<td>32</td>
</tr>
<tr>
<td>Velodyne</td>
<td>HDL-32e</td>
<td>100</td>
<td>41.3&deg;</td>
<td></td>
<td>32</td>
</tr>
<tr>
<td>Quanergy</td>
<td>M8</td>
<td>150</td>
<td>20&deg;</td>
<td></td>
<td>32</td>
</tr>
<tr>
<td>Ibeo</td>
<td>NSH_32</td>
<td>80</td>
<td>16&deg;</td>
<td>0.2&deg;</td>
<td>32</td>
</tr>
<tr>
<td>InnoVusion</td>
<td>Cheetah</td>
<td>200</td>
<td>40&deg;</td>
<td>0.13&deg;</td>
<td>300</td>
</tr>
</tbody>
</table>
<h4 id="env-effects"><a href="#env-effects" class="headerlink" title="env effects"></a>env effects</h4><p>what about weather effects? e.g. snow, dust, rain; what about env effects? e.g. temperature, system vibration.</p>
<h4 id="fusion-with-camera"><a href="#fusion-with-camera" class="headerlink" title="fusion with camera"></a>fusion with camera</h4><h4 id="the-speed-of-productivization"><a href="#the-speed-of-productivization" class="headerlink" title="the speed of productivization"></a>the speed of productivization</h4><p>when I first heard about InnoVusion, the founder <code>Bao Junwei</code> who was working at Baidu AI, then had the idea to produce Lidar around 2015, then he left Baidu and started InnoVusion, at the end of 2016, their first product Cheetah was born. </p>
<p>this process is really speedy, one thought is the drive force either by capital market or industry needs is becoming so fast that every good chance from idea to product is becoming shorter in time; the other thought, only these highly effective persons will survive in this fast-iteration world. </p>
<p>some other founders stories are here : <a href="https://blog.csdn.net/McIl9G4065Q/article/details/80416350" target="_blank" rel="external">the AI masters who left from Baidu</a></p>
<h4 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h4><p><a href="https://www.autonomous-driving-berlin.com/wp-content/uploads/2018/03/D2-SA1_Brumm_Ibeo.pdf" target="_blank" rel="external">Ibeo Next 3D SS-Lidar</a></p>
<p><a href="https://www.oemoffhighway.com/electronics/sensors/product/21073236/innovusion-inc-innovusion-cheetah-lidar-system" target="_blank" rel="external">Innovusion Cheetah Lidar</a></p>
<p><a href="https://velodynelidar.com/lidar/products/manual/HDL-32E%20manual_Rev%20A_APR2011.pdf" target="_blank" rel="external">Velodyne HDL_32e product manual</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/17/principles-of-GNSS-positioning/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/17/principles-of-GNSS-positioning/" itemprop="url">principles of GNSS positioning</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-17T10:35:26-04:00">
                2019-06-17
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/06/17/principles-of-GNSS-positioning/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/06/17/principles-of-GNSS-positioning/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://www.novatel.com/an-introduction-to-gnss/chapter-1-gnss-overview/" target="_blank" rel="external">novatel introduction</a></p>
<h3 id="GNSS-architecture"><a href="#GNSS-architecture" class="headerlink" title="GNSS architecture"></a>GNSS architecture</h3><p>a) space segment</p>
<p>the GNSS satellites, each of which broadcasts a signal that identifies ti and provides its time, orbit and status.</p>
<p>b) control segment </p>
<p>a ground-based network of master control stations, data uploading stations adn monitor stations. in case of GPS, 2 master control stations(one primary and one backup),  4 data uploading stations, and 16 monitor stations</p>
<p>c) user segment </p>
<p>the user equipment that process the received signals. </p>
<h3 id="GNSS-propagation"><a href="#GNSS-propagation" class="headerlink" title="GNSS propagation"></a>GNSS propagation</h3><p>the layer of atmoshpere that most influcences the transmission of GPS signals is the ionosphere(电离层), ionoshperic delays are frequency dependent; and the other layer is troposphere(平流层), whose delay is a function of local temperature, pressure and relative humidity. </p>
<p>some singal energy is reflected on the way to the receiver, called “multipath propagation”. </p>
<h3 id="Antenna"><a href="#Antenna" class="headerlink" title="Antenna"></a>Antenna</h3><p>each GNSS constellation has its own signal frequencies and bandwidths, an antenan must cover the signal frequencies and bandwidth.</p>
<p>antenna gain is defined as the relative measure of an antenna’s ability to direct or concentrate radio frequency energy in a particular direction or pattern. A minimum gain is required to achieve a minimum carrier : power-noise-ratio to track GNSS satellites.</p>
<h3 id="GNSS-error-sources"><a href="#GNSS-error-sources" class="headerlink" title="GNSS error sources"></a>GNSS error sources</h3><pre><code>contributing sources         error range

satellite clocks             +- 2m

orbit errors                       +-2.5m

inospheric delays            +-5m

tropospheric delays            +-0.5m

receiver noies                +-0.3m

multi path                     +-1m
</code></pre><h3 id="Resolving-errors"><a href="#Resolving-errors" class="headerlink" title="Resolving errors"></a>Resolving errors</h3><h4 id="multi-constellation-amp-multi-frequency"><a href="#multi-constellation-amp-multi-frequency" class="headerlink" title="multi-constellation &amp; multi-frequency"></a>multi-constellation &amp; multi-frequency</h4><p>multi-frequency is the most effective way to remove ionospheric error,  by comparing the delays of two GNSS signals, L1 &amp; L2, the receiver can correct for the impact of ionospheric errors.</p>
<p>multi-constellation has benefits:  reduce signal acquisition time,  improve position and time accuracy.</p>
<h4 id="D-GNSS"><a href="#D-GNSS" class="headerlink" title="D-GNSS"></a>D-GNSS</h4><p>in differential GNSS(D-GNSS), the position of a fixed GNSS receiver, refered as a base station, which sends the atmospheric delay related errors to receivers, which incorporate the corrections into their positoin calculations.</p>
<p>differential positiong requires a data link betwen the base station and rovers, if corrections need to be applied in real-time. and D-GNSS works very well with base station-to-rover separations of up to 10km.</p>
<h4 id="Real-time-kinematic-RTK"><a href="#Real-time-kinematic-RTK" class="headerlink" title="Real time kinematic(RTK)"></a>Real time kinematic(RTK)</h4><p>it uses measurements of the phase of the signal’s carrier wave, in addition to the information content of the signal and relies on a single fixed reference station to provide real-time corrections, up to centimetre-level accuracy. </p>
<p>the range to a satellite is calculated by multiplying the carrier wavelength times the number of whole cycles between the satellite and the rover and adding the phase difference. the results in an error equal to the error in the estimated number of cycles times the wavelength, so-called integer ambiguity search, which is 19cm for L1 signal. </p>
<h4 id="Precise-Point-Positioning-PPP"><a href="#Precise-Point-Positioning-PPP" class="headerlink" title="Precise Point Positioning(PPP)"></a>Precise Point Positioning(PPP)</h4><p>PPP solution depends on GNSS satellite clock and orbit corrections, generated from a network of global reference stations. </p>
<h3 id="GNSS-IMU"><a href="#GNSS-IMU" class="headerlink" title="GNSS + IMU"></a>GNSS + IMU</h3><p>the external reference can quite effectively be provided by GNSS, and GNSS provides an absolute set of coordinates that can be used as the initial start point, as well, GNSS provides continuous positions adn velocities thereafter which are used to update the IMU/INS filter estimates.</p>
<p>for additional combined sensors, such as odometers, cameras vision.</p>
<h3 id="challenges-of-GNSS-in-AV"><a href="#challenges-of-GNSS-in-AV" class="headerlink" title="challenges of GNSS in AV"></a>challenges of GNSS in AV</h3><p>talk from iMorpheus.ai </p>
<p>1)  antenna</p>
<p>2)  multipath mitigation</p>
<p>3)  multi-band, multi-constellation signals</p>
<p>4)  integrated navigation (camera )</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/12/Manhanton-SC-review/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/12/Manhanton-SC-review/" itemprop="url">Manhanton SC review</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-12T10:37:16-04:00">
                2019-06-12
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/06/12/Manhanton-SC-review/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/06/12/Manhanton-SC-review/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="conjunctions"><a href="#conjunctions" class="headerlink" title="conjunctions"></a>conjunctions</h3><p>the seven conjunctions can used to connect two independent clauses:</p>
<pre><code>For,   And, Nor,  But, Or,  Yet, So
</code></pre><p>comma only cant connect two sentences;  but can connect two independent clauses using a semicolon(;)</p>
<p>semicolon is often followed by a transition expression, (however, therefore, in addition), but these expression are not conjunctions, so must use semicolons, not commas to join.</p>
<h3 id="noun-modifiers"><a href="#noun-modifiers" class="headerlink" title="noun modifiers"></a>noun modifiers</h3><p>in the format:  prepositon,  part participle, presetn participle without commas. put the noun and its modifier as close together as possible </p>
<p>“ comma which” is a nonessential modifier</p>
<h3 id="relative-pronouns"><a href="#relative-pronouns" class="headerlink" title="relative pronouns"></a>relative pronouns</h3><p>which,  cant modify people, </p>
<p>who/ whom, must modify people </p>
<p>whose,  can modify either people or things</p>
<p>where, can modify a noun place,  can’t modify a metaphorical place, such as situation, case …</p>
<p>when,  can modify a noun event or time </p>
<h3 id="Noun-Modifier-markers"><a href="#Noun-Modifier-markers" class="headerlink" title="Noun Modifier markers"></a>Noun Modifier markers</h3><p>any -ing that are not verbs and not separated from the rest of the sentence by comma will either be a noun, or a modifier of another noun.</p>
<p>any “comma -ing” is adverbial modifiers </p>
<h3 id="adverbial-modifier"><a href="#adverbial-modifier" class="headerlink" title="adverbial modifier"></a>adverbial modifier</h3><p>in the format of:  prepositional phrase,  present participle with commas , past participle with commas </p>
<p>the adverbial modifier must modify a certain verb or clause at a right position, not structurally closer to another verb or clause </p>
<h3 id="participle-modifiers"><a href="#participle-modifiers" class="headerlink" title="participle modifiers"></a>participle modifiers</h3><p>when using particples, the information present earlier in the sentence leads to or results in the information presented later in the sentence .</p>
<h3 id="subordinators"><a href="#subordinators" class="headerlink" title="subordinators"></a>subordinators</h3><p>subordernate clause provides additional info about the main clause.  common subordinatetor markers:</p>
<pre><code>although,  before,  unless, because,  that, so that, 
 if, yet, after, while, since, when. 
</code></pre><p>and using only one connected word per “connection” . .   </p>
<h3 id="which-vs-ing"><a href="#which-vs-ing" class="headerlink" title="which vs  -ing"></a>which vs  -ing</h3><p>whenever using <code>which</code>, must refer to a noun,  can’t modify a whole clause. </p>
<p>so if need to modify the whole clause, use  an  adverbial modifier(either -ing, or past) </p>
<h2 id="quantity"><a href="#quantity" class="headerlink" title="quantity"></a>quantity</h2><p>countable modifiers:   </p>
<pre><code>many,  few, fewer,  fewest,  number of ,  numerous 
</code></pre><p>uncountable modifiers:  </p>
<pre><code>much, little, less, least, amount of , great 
</code></pre><p>more, enough,  all works with both countable and uncountable. </p>
<h2 id="parallelism"><a href="#parallelism" class="headerlink" title="parallelism"></a>parallelism</h2><p>comparable sentence parts must be structurally and logically similar </p>
<h2 id="comparison"><a href="#comparison" class="headerlink" title="comparison"></a>comparison</h2><p>comparison are a subset of parallelism, which requires parallelism between two elements, but also require the two compared items are fundamentally the same type of thing </p>
<pre><code>like,  unlike,  as, than,  as adj as, 
 different from,  in contrast to/with 
</code></pre><h3 id="like-vs-as"><a href="#like-vs-as" class="headerlink" title="like vs  as"></a>like vs  as</h3><p><code>like</code> is used to compare nouns, pronouns or noun phrase, never put a clause or prepositional phrase after like.</p>
<p><code>as</code> can used to compare two clauses.  </p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/06/how-simulation-helps-for-autonomous-vehicle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/06/how-simulation-helps-for-autonomous-vehicle/" itemprop="url">how simulation helps for autonomous vehicle</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-06T05:50:37-04:00">
                2019-06-06
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/06/06/how-simulation-helps-for-autonomous-vehicle/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/06/06/how-simulation-helps-for-autonomous-vehicle/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="prefare"><a href="#prefare" class="headerlink" title="prefare"></a>prefare</h2><p>recently joined another Chinese auto OEM, still work in simulation platform for autonomous vehicle. this experience is a different pratice from GM or Ford. </p>
<p>at first, it’s the mindset update, once for a long time, or even take for granted that I was looking for to be treated greatly, like in NA companies, what the company can offer me. it’s about freedom and responsibility. To have the freedom/right to make a difference in project direction, contents, and methods to achieve sth, first prove that I can take it, which is responsibility.</p>
<p>“ you can you up” that kind of phylosphy is very common and actually I’d love it in some point.</p>
<h2 id="beta-version"><a href="#beta-version" class="headerlink" title="beta version"></a>beta version</h2><p>there are ways to make a virtual simulator. traditional tool vendors include Matlab/Simulink, Prescan, VTD, ANSYS e.t.c. and as the beta version of simulator tool-chain, they are common in most OEMs in China. while have to say, in China, cause most software tools, from engineering tools to modern HR managment tools to product managment tools are kind of in practice process in Chinese companies as I can see, rather than as a matured segment pluged-in the company’s DNA. e.g.  the product development tools are pretty in trial and error, occasionaly some PLM vendors come to introduce their products. and actually except the CAD/CAE tools, which were introduced in China since 80’s, and which sounds matured right now, the simulation tools for autonomous vehicle is pretty new-things, from map, sensor to all kinds of internal algorithms.</p>
<p>the beta version of simulation tools has its DNAs as well. first they are charged by license fee, which is a pretty old way like IBM days. not many modern Internet mobility companies live in this way anymore.  </p>
<p>secondly, they can’t update frequently, once or twice a year with a new version of the product is common, which maybe OK in CAD/CAE tools, since the engineering analysis process are pretty matured and few exceptional requirements jump out in daily work, and there update is sometime by the vendor itself, which is not a required update, maybe optimized the algorithms, maybe added a third-party function, and sometime is from the users conference, usually the tool vendor will organize this kind of user conference to group users together, one way to get some connections, as well as to get some end-user requirements to fix the next version product, which is also a drawback compared to open source tool community, in where the user is more active.</p>
<p>thirdly, the beta version tools are excluding the users someway, who can’t actually manage the tool as part of its whole functions. assuming simulation will be the key to make a difference in future auto product, then this excluding is unacceptable. on the other side, if autonomous simulation tool are at most aided to develop new product, then it becomes a piece of chicken neck either to take or to throw. <strong>from a product view, what is the role of simulation tool or as  a product itself, where it is blooming point</strong></p>
<h2 id="alpha-version"><a href="#alpha-version" class="headerlink" title="alpha version"></a>alpha version</h2><p>why simulation tool become a role in autonomous, except the traditional vendors, mostly coming from Internet companies, e.g. Google, Uber, Baidu, Tecent etc. they are pretty strong to make a software product, including the simulation software in auto industry.  <strong>interesting, these Internet companines never go to make a CAD/CAE software, but they actually prefer to support the cloud/HPC infrastructures for CAD/CAE simulation.</strong></p>
<p>these big mobility companines make their simulation tools now and well cowork with their existing IT development methodlogy, software product ideas as well as all ICT infrastures, which make these tools sounds huge great, and which also make themselves as the core role, rather than the OEMs, few are free or not yet open-sourced.  </p>
<p>and there are a few popular open source simulation tools, e.g. Carla, Airsim, LG simulator e.t.c. I actually get a chance with Carla at GM research team, which even now still great, but does’t study deeper, and for me it is a great tool for AI training, which should be the key role of simulation tool in future, since L3 or below, really cares little environment info, and its rule-based decision has no need for a large chunk of virtual test. that’s also <strong>a difference between Chinese and NA team</strong>,  NA teams have the trend to invest in new tech even without immeditaly money back, but Chinese companies would prefer in immediate invest. </p>
<h3 id="lg-simulator"><a href="#lg-simulator" class="headerlink" title="lg simulator"></a>lg simulator</h3><p>Unreal never tried, but Unity looks pretty easy to use, while still need sometime to get familiar with the editor and play with scenes. lg simulator has give a great reference to build the virtual city and make autonomous vehicles running. the real problem actually for most team is how to make this tool useful in product development. </p>
<p>we can think about the tool strucutre itself, like cloud running features, implement measure/verified methods, and build scenes database as we can think about or from the sort of system engineering port. </p>
<p>as for a L3 or below usage, the whole meaning of simualtion is not driven, but at most additional support of product development, as I can see. so what simulation for ?  L4+, which leads to AI, or data driven product development!</p>
<p>from this point, the simlation itself is not the core, but the AI, so think about that in career development. </p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/10/robust-control-theory/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/10/robust-control-theory/" itemprop="url">robust control theory</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-10T10:54:01-04:00">
                2019-05-10
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/05/10/robust-control-theory/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/05/10/robust-control-theory/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>this is a review from <a href="https://users.ece.cmu.edu/~koopman/des_s99/control_theory/" target="_blank" rel="external">cmu refer</a></p>
<h2 id="state-variable-method"><a href="#state-variable-method" class="headerlink" title="state variable method"></a>state variable method</h2><p>any Nth order differential equation describing a control system could be reduced to N 1st order equations, these equations could be arranged in the form of matrix equations. </p>
<p>define <code>x</code> as system state,  <code>y</code> as output, <code>u</code> as input: </p>
<p><a href="https://www.codecogs.com/eqnedit.php?latex=\dot{X}&space;=&space;AX&space;&plus;&space;Bu&space;\\&space;Y&space;=&space;CX&space;&plus;&space;Du" target="_blank"><img src="https://latex.codecogs.com/gif.latex?\dot{X}&space;=&space;AX&space;&plus;&space;Bu&space;\\&space;Y&space;=&space;CX&space;&plus;&space;Du" title="\dot{X} = AX + Bu \\ Y = CX + Du"></a></p>
<p>modern control methods(ODEs) can handle multiple-input-multiple-outputs, and they can be optimized, and they allow to design performance and cost model. </p>
<h2 id="effects-of-uncertainty"><a href="#effects-of-uncertainty" class="headerlink" title="effects of uncertainty"></a>effects of uncertainty</h2><h4 id="observability"><a href="#observability" class="headerlink" title="observability"></a>observability</h4><p>the ability to observe all of the parameters or state variables in the system</p>
<h4 id="controllability"><a href="#controllability" class="headerlink" title="controllability"></a>controllability</h4><p>the ability to move a system from any given state to any desired state </p>
<h4 id="stability"><a href="#stability" class="headerlink" title="stability"></a>stability</h4><p>the bounded response to any bounded input </p>
<p>robust control theory might be stated as a worst-case analysis, to bound the uncertantiy.</p>
<h2 id="metircs"><a href="#metircs" class="headerlink" title="metircs"></a>metircs</h2><p>how to model the behavior of the test system is one most difficult challenge in design a good control system.</p>
<h4 id="adaptive-control"><a href="#adaptive-control" class="headerlink" title="adaptive control"></a>adaptive control</h4><p>set up observers for each significant state variable. at each iteration loop, the system learns about the changes in the system parameters, and getting closer to the desired. while the method may suffer from convergence issues</p>
<h4 id="H2-or-H-infinity"><a href="#H2-or-H-infinity" class="headerlink" title="H2 or H-infinity"></a>H2 or H-infinity</h4><p>H2 control seeks to bound the power gain of the system, H-infinity seeks to bound the energy gain of the system. gains in power or energy indicate operation of the system near a pole in the transfer function.</p>
<h4 id="parameter-estimation"><a href="#parameter-estimation" class="headerlink" title="parameter estimation"></a>parameter estimation</h4><p>by establishing boundaries in the frequency domain that cannot be crossed to maintain stability. </p>
<h4 id="Lyapanov"><a href="#Lyapanov" class="headerlink" title="Lyapanov"></a>Lyapanov</h4><p>the only universal tech for assessing non-linear systems, the method focus on stability. Lyapanov functions are constructed, which are described as energy-like functions, to model the behavior of real system. </p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/10/Carmaker-8-0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/10/Carmaker-8-0/" itemprop="url">Carmaker 8.0</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-10T10:47:35-04:00">
                2019-05-10
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/05/10/Carmaker-8-0/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/05/10/Carmaker-8-0/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>this is from IPG open house Shang Hai </p>
<h2 id="scenario-generation-task"><a href="#scenario-generation-task" class="headerlink" title="scenario generation task"></a>scenario generation task</h2><h3 id="data-record"><a href="#data-record" class="headerlink" title="data record"></a>data record</h3><p>tracking vehicles, roads, tobstacles</p>
<p>obj:  lane, road, barries, GPS input, vehicle position/orientation, fixed ID, type</p>
<p>the goal of recoding is for road building, which will be used in replay.</p>
<h4 id="road-build"><a href="#road-build" class="headerlink" title="road build"></a>road build</h4><p>GPS input + lane mark info +  vehicle location –&gt;  vehicle  trajectory </p>
<h3 id="replay"><a href="#replay" class="headerlink" title="replay"></a>replay</h3><p>run config, input as tranversal and longitudial position</p>
<p>traffic vehicle location, speed </p>
<h3 id="rearrange"><a href="#rearrange" class="headerlink" title="rearrange"></a>rearrange</h3><p>input as :  traffic vehile info + ego info , list of traffic vehicle info</p>
<p>traffic vehicle manage:</p>
<pre><code>1) manuevor control:  free move 

2) spawn control:  lati +   longi --&gt;  23 cases 

3) support external plugins +   manuevor trigger
</code></pre><h2 id="Synthetic-Scenario"><a href="#Synthetic-Scenario" class="headerlink" title="Synthetic Scenario"></a>Synthetic Scenario</h2><p>junction assistant</p>
<p>road type + traffic rules +  scenario –&gt;</p>
<p>support road topology modification</p>
<p>support different envs: day of time,  weather, </p>
<p>scenario editor to support opendrive import </p>
<h3 id="standardization"><a href="#standardization" class="headerlink" title="standardization"></a>standardization</h3><p>PEGASUS  +  ASAM simulation standards </p>
<p>roads, scenarios, simulation interfaces </p>
<p>Opendrive –&gt;  road topology </p>
<p>opENScenario –&gt;  maneuver &amp; anction abstract definitions </p>
<p>Open simulation interface –&gt; interface developed for PEGASUS </p>
<h3 id="limitations"><a href="#limitations" class="headerlink" title="limitations"></a>limitations</h3><p>pre-define route for vehicle ? </p>
<p>the ego car has AI maneuvor ? </p>
<h2 id="Vitual-Prototype"><a href="#Vitual-Prototype" class="headerlink" title="Vitual Prototype"></a>Vitual Prototype</h2><p>including gearbox loss mode, gas mode,  through look-up table </p>
<p>including hybrid powertrain architectures:  automatic gearbox + parallel hybrid</p>
<p>including powertrain masses(engine, tank, gearbox, battery, motor) </p>
<p>including trailer data set generator </p>
<p>including damping top mount </p>
<h2 id="Simulation-test"><a href="#Simulation-test" class="headerlink" title="Simulation test"></a>Simulation test</h2><p>support:: ADAS/AD, POWERTRAIN, Vehicle Dynamics </p>
<h3 id="steering-system-visual-case"><a href="#steering-system-visual-case" class="headerlink" title="steering system visual case"></a>steering system visual case</h3><p>for less steering will overall comfort and vehicle dynamics </p>
<p>reference measurements(steering-in-loop simulator) -&gt;  model parameter id +  softare + ECU integration –&gt;  parameterization &amp; validation  -&gt; training </p>
<h4 id="how-the-steering-system-works"><a href="#how-the-steering-system-works" class="headerlink" title="how the steering system works"></a>how the steering system works</h4><p>open loop to get mechanical characteristics(stiffness, friction..)</p>
<p>system performance with or without EPS </p>
<p>1) ideal(basis) model vs  physical model</p>
<p>how to cowok the physical model with autopilot control model ?</p>
<h3 id="test-bed"><a href="#test-bed" class="headerlink" title="test bed"></a>test bed</h3><p>to support electrification, durability,  balancing,  driveability,  powertain caillbratio,  connected powertrain </p>
<h3 id="AI-training-with-synthetic-scenario"><a href="#AI-training-with-synthetic-scenario" class="headerlink" title="AI training with synthetic scenario"></a>AI training with synthetic scenario</h3><p>decion making</p>
<p>trajectory planning </p>
<p>image perception </p>
<p>q: how to make sure AI robost ? –&gt; </p>
<p>what CarMaker can do for AI? </p>
<p>1) obj annotation (vehicles, pedestrains) –&gt; auto annotation</p>
<p>2) semantic segmentation </p>
<p>e.g. IPG Movier for auto semantic segmentation </p>
<p>Q: what’s the hardware for ? </p>
<h2 id="Cloud-amp-CPU-GPU-for-Parallelization"><a href="#Cloud-amp-CPU-GPU-for-Parallelization" class="headerlink" title="Cloud &amp; CPU/GPU for Parallelization"></a>Cloud &amp; CPU/GPU for Parallelization</h2><p>q: how to parallel in docker ? </p>
<p>1)  test case in each CPUs </p>
<p>2) even for single test run(with multi sensors, multi cars ) </p>
<pre><code>resources &amp; distribution 
</code></pre><p>CPU: vehile model,  drivel model, envs, ideal sensors </p>
<p>GPU; visual, camera RIS, radar ris, lidar rs </p>
<h3 id="Test-run-in-prallel"><a href="#Test-run-in-prallel" class="headerlink" title="Test run in prallel"></a>Test run in prallel</h3><p>sensor setup(10 ultra,  5 Radar,  1 Lidar, 1 Camera)</p>
<p>host pc (with test manager)  +  4 virtual machines  </p>
<p>output:  key figures,  reports,  statistics,  queries </p>
<p>open archi for scalable processing( on-premise and cloud)</p>
<p>big data anaysis with DaSense by NorCom </p>
<ul>
<li>how it works ?</li>
<li>external scheduler mananger, PBS</li>
<li>HPC light to support local PC parallel</li>
</ul>
<h2 id="new-features-in-8-0"><a href="#new-features-in-8-0" class="headerlink" title="new features in 8.0"></a>new features in 8.0</h2><p>virtual test driving 8.0 </p>
<ul>
<li>simulink lib (through Simscape) </li>
<li>Scenario Editor:  vege geenration,  animated 3D objs, new models(vehicles, trailers, trucks, bus, buildings, houses, street furniture, pedestrains)</li>
<li>visulize road surfaces .. </li>
<li>ipg movie</li>
<li>fisheye distortion from external file </li>
<li>new sensor models(Lidar RSI)</li>
</ul>
<p>q: what’s the difference of open source tool vs  commericial ?  </p>
<h3 id="Lidar-RSI"><a href="#Lidar-RSI" class="headerlink" title="Lidar RSI"></a>Lidar RSI</h3><p>Ideal perfect world –&gt; ground truth </p>
<p>HiFi –&gt;  false positives &amp; negatives </p>
<p>raw data –&gt;   RSI </p>
<p>supporting Lidar type: </p>
<pre><code>moving laser &amp; photot diode

moving mirrors 

solid state 

flash
</code></pre><p>input features :</p>
<ul>
<li><p>Laser beam, including custom beam pattern, Raytracing rays </p>
</li>
<li><p>Scene Interaction, including atmoshpere attenuation, color or material or surface or transparent dependency </p>
</li>
<li><p>detection, including threashold, multiple echoes per beam, separability</p>
</li>
</ul>
<p>output features:</p>
<ul>
<li>sending &amp; receiving direction of every beam </li>
<li>light intensity of every beam</li>
<li>time &amp; lenght of light</li>
<li>pluse width</li>
<li>number of interactions </li>
</ul>
<h2 id="User-Case-Nio-Pilot"><a href="#User-Case-Nio-Pilot" class="headerlink" title="User Case : Nio Pilot"></a>User Case : Nio Pilot</h2><p>by sun peng </p>
<h3 id="cases"><a href="#cases" class="headerlink" title="cases"></a>cases</h3><p>inter-city,  parking, closed space, crowded space </p>
<p>sensors:  3 front camera, 4 surround camera, 4 mm RADARS,  12 Ultra, 1 driver monitor camera </p>
<p>higway pilot in June </p>
<p>perception:  camera, radar,  ult, hd map, location  </p>
<p>planning :  path planning,  maneuvor decsion, system control </p>
<p>cloud &amp; AI </p>
<h3 id="simulation-usage"><a href="#simulation-usage" class="headerlink" title="simulation usage"></a>simulation usage</h3><ul>
<li><p>FDS -&gt; cases -&gt; SIL </p>
</li>
<li><p>platform –&gt;  cases -&gt;  regression test,  abstraction &amp; instantiation ;  scene reconsturction(in-house) /  close loop SIL ;  traffic model training(to do) </p>
</li>
<li><p>integration -&gt;  HIL </p>
</li>
</ul>
<p>what about vd ? –&gt;  co-work with simulation and physical test, the cover percentage of simulation is about 80%, the left is from </p>
<h3 id="data-platform"><a href="#data-platform" class="headerlink" title="data platform"></a>data platform</h3><p>upload nodes -&gt; cloud </p>
<p>med usa API server -&gt; fleet mgmt</p>
<p>log stash –&gt;  elastic search –&gt; Kibana &amp;  Admin (tensn  and spark )</p>
<p>I think they are collecting data, and this data for scene building and simulation usage in future </p>
<h3 id="data-visulazation"><a href="#data-visulazation" class="headerlink" title="data visulazation"></a>data visulazation</h3><h2 id="HIL"><a href="#HIL" class="headerlink" title="HIL"></a>HIL</h2><ul>
<li><p>lane model simualtion on HIL </p>
</li>
<li><p>fusion simulation on HIL </p>
</li>
</ul>
<h2 id="automation-test"><a href="#automation-test" class="headerlink" title="automation test"></a>automation test</h2><p>jenkins master –&gt; jenkins slave (agent IPG) –&gt;   cloud </p>
<h2 id="goal"><a href="#goal" class="headerlink" title="goal"></a>goal</h2><p>simulation server  &lt;—&gt;  data center </p>
<p>parallel sim core +  simulation monitor (data exchange service)</p>
<p>data processing + labelling + case management + traffic model training </p>
<p>(replay,  SIL, REMODEL, Visuliazation )</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/04/PID-control/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/04/PID-control/" itemprop="url">PID control</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-04T04:27:21-04:00">
                2019-05-04
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/05/04/PID-control/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/05/04/PID-control/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="closed-loop-system"><a href="#closed-loop-system" class="headerlink" title="closed loop system"></a>closed loop system</h2><p><code>set point</code> is the desired or command value for the process variable. at any given moment, the difference between the process variable and the set point is used by the control system algorithm to determine the desired actuator output to drive the system.</p>
<p><code>closed loop system</code>, the process of reading sensors to provide constant feedback and calculating the desired actuator output is repeated continuously and at a fixed loop rate.</p>
<p><code>control system performance</code> is measured by applying a step fuction as the set point command variable, and then measuring the response of the process variable.</p>
<p><code>rise time</code> is the amount of time that the system takes to go from 10% to 90% of the steady-state/final.</p>
<p><code>percent overshoot</code> is the amout that the process variable overshoots the final value, expressed as a percentage of the final value.</p>
<p><code>settling time</code> is the time required for the process variable to settle to within a certain percentage(5%) of the finla value</p>
<p><code>steady state error</code> is the final difference between the process variable and set point</p>
<p><code>disturbance rejection</code> is the measure of how well the control system is able to overcome the effects of disturbances. often there is a disturbance in the system that affects the process variables or the measurements of these variables, it’s important to design a control system that performs satisfactorily during the worst case conditions.</p>
<p><code>nonlinear system</code> , in which the control parameters that produe a desired response at one operating point might not produce a satisfactory response at another operating point.</p>
<p><code>deadtime</code> is the delay between when a process variable changes, and when that change can be observed.</p>
<p><code>loop cycle</code> the interval of time between calls to a control system, system that change quickly or have complex behavior requires faster control loop rates.</p>
<h2 id="PID-theory"><a href="#PID-theory" class="headerlink" title="PID theory"></a>PID theory</h2><h3 id="proportional-response"><a href="#proportional-response" class="headerlink" title="proportional response"></a>proportional response</h3><p><code>error</code> the difference between the set point and the process variable. the proportional gain(K_g) determins the ratio of the output response to the error signal.</p>
<p>e.g. the error term has a magnitude of 10, and the K_g is 5, then the proportional response is 50.</p>
<p>increasing K_g will increase the speed of the control system response, but if K_g is too large, the process variable will oscillate(why?)</p>
<h3 id="integral-response"><a href="#integral-response" class="headerlink" title="integral response"></a>integral response</h3><p>the integral component sums the error term over time. the result is that even a small error term will cause the integral component to increase slowly. the integral response will continually increase unless the error is zero, so the effect is to driven the steady-state-zero to zero.</p>
<p><code>integral windup</code> when integral action saturates, still without the controller driving the error signal toward zero</p>
<h3 id="derivative-response"><a href="#derivative-response" class="headerlink" title="derivative response"></a>derivative response</h3><p>the response is portortional to the rate of change of the process variable. increasing the <code>derivative time</code> will cause the control sytem to react more strongly to changes in the error, and react more quickly.</p>
<p>in practice, most control system use very small derivative time, since the derivative response is highly sensitive to noise. </p>
<h2 id="turning"><a href="#turning" class="headerlink" title="turning"></a>turning</h2><p>which is the process of setting the optimal gains of P, I, D to get an ideal response. </p>
<h3 id="trial-and-error"><a href="#trial-and-error" class="headerlink" title="trial and error"></a>trial and error</h3><p>set I, D as zero, and increas P gain.  Once P has been set to obtain a desired fast response, I starts to increase to stop the oscillatins to achieve a minimal steady state error. once P and I have been set, the D is increased untill the loop is acceptably quick to its set point.</p>
<h3 id="filtering"><a href="#filtering" class="headerlink" title="filtering"></a>filtering</h3><p>assume a sinusoidla noise with frequency w, the direvative is:</p>
<p><a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;y(t)&space;=&space;f(t)&space;&plus;&space;a&space;sin(wt)&space;\\&space;dy/dt&space;=&space;df/dt&space;&plus;&space;aw&space;cos(wt)" target="_blank"><img src="https://latex.codecogs.com/gif.latex?\inline&space;y(t)&space;=&space;f(t)&space;&plus;&space;a&space;sin(wt)&space;\\&space;dy/dt&space;=&space;df/dt&space;&plus;&space;aw&space;cos(wt)" title="y(t) = f(t) + a sin(wt) \\ dy/dt = df/dt + aw cos(wt)"></a></p>
<p>so in practice it’s necessary to limit the high frequency gain of the derivative term, either by adding a low pass filtering of the control signal, or implement the derivative term in a cut-off way.</p>
<h2 id="Udacity-Self-driving-Car-project-9"><a href="#Udacity-Self-driving-Car-project-9" class="headerlink" title="Udacity Self driving Car project 9"></a>Udacity Self driving Car project 9</h2><pre><code class="c">
<span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span>
</span>{
    uWS::Hub h ;
    PID pid ; 
    pid.Init(pinit, iinit, dinit);
    h.onMessage(    <span class="comment">// cte, the error </span>
    {
        <span class="keyword">double</span> diff = <span class="built_in">fabs</span>(pid.p_error - cte) ; 
        <span class="keyword">if</span>( diff &gt; <span class="number">0.1</span> &amp;&amp; diff &lt; <span class="number">0.2</span>)
            thr = <span class="number">0.0</span>; 
        <span class="keyword">else</span> <span class="keyword">if</span>( diff &gt; <span class="number">0.2</span> &amp;&amp; speed &gt; <span class="number">30</span>)
            thr = <span class="number">-0.2</span>;

        pid.UpdateError(cte, dt);
        steer_value = -pid.TotalError(speed);
    }
}

<span class="keyword">void</span> PID::UpdateError(<span class="keyword">double</span> cte, <span class="keyword">double</span> dt)
{
    d_error = (cte - p_error) /dt ;
    p_error = cte ;
    i_error = integral(cte * dt);
}

<span class="keyword">double</span> PID::TotalError(<span class="keyword">double</span> speed)
{
    <span class="keyword">return</span> (Kp - <span class="number">0.0032</span> * speed) * p_error + Ki * i_error + (Kd + <span class="number">0.002</span> * speed) * d_error ;
}
</code></pre>
<p>in real self driving control system, usually divide as latitual and longitual control. and in different scenarios, there are plenty of PID controls. in the future will expose: highway autopilot, auto parking, urban L4 </p>
<h2 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h2><p><a href="http://www.ni.com/en-us/innovations/white-papers/06/pid-theory-explained.html" target="_blank" rel="external">PID theory explained</a></p>
<p><a href="https://www.cds.caltech.edu/~murray/courses/cds101/fa02/caltech/astrom-ch6.pdf" target="_blank" rel="external">PID control from Caltech</a></p>
<p><a href="https://github.com/NikolasEnt/PID-controller/blob/master/src/PID.cpp" target="_blank" rel="external">udacity pid control</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/03/Apollo-2-0-Localization-源码/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/03/Apollo-2-0-Localization-源码/" itemprop="url">Apollo 2.0 Localization 源码</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-03T02:36:43-04:00">
                2019-05-03
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/05/03/Apollo-2-0-Localization-源码/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/05/03/Apollo-2-0-Localization-源码/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>there are two localization methods: RTK and multi-sensor fusion(MSF).  RTK using GPS and IMU inputs, MSF using GPS, IMU and Lidar sensor and HD map as inputs. the output is the localization estimated object instance.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Status Localization::Start()</div><div class="line">&#123;</div><div class="line">	localization_ = localization_factory_.CreateObject(cofig_.type());</div><div class="line">	localization_-&gt;Start();</div><div class="line">	<span class="keyword">return</span> Status::OK();</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">Status RTKLocalization::Start()&#123;</div><div class="line">	AdapterManager::Init(FLAGS_rtk_adapter_config_file);</div><div class="line">	timer_ = AdapterManager::CreateTimer(ros::Duration(duration), &amp;RTKLocalization::OnTimer, <span class="keyword">this</span>); </div><div class="line">	AdapterManager::GetGps();</div><div class="line">	AdapterManager::GetImu();	</div><div class="line">	tf2_broadcaster_ = <span class="keyword">new</span> tf2_ros::TransformBroadcaster() ;</div><div class="line">	<span class="keyword">return</span> Status::OK();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> RTKLocalization::OnTimer(<span class="keyword">const</span> ros::TimerEvent &amp;event)</div><div class="line">&#123;</div><div class="line">	AdapterManager::Observe();</div><div class="line">	PublishLocalization(); </div><div class="line">	RunWatchDog();	</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> RTKLocalization::PublishLocalization()&#123;</div><div class="line">	LocalizationEstimate localization ;</div><div class="line">	PrepareLocalizationMsg(&amp;localization);</div><div class="line">	AdapterManager::PublishLocalization(localization);</div><div class="line">	PublishPoseBroadcastTF(localization);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> RTKLocalization::PrepareLocalizationMsg(LocalizationEstimate *localization)&#123;</div><div class="line">	<span class="keyword">const</span> <span class="keyword">auto</span> &amp;gps_msg = AdapterManager::GetGps()-&gt;GetLatestObserved();</div><div class="line">	Imu imu_msg = AdapterManager::GetImu()-&gt;GetLatestObserved();</div><div class="line">	ComposeLocalizationMsg(gps_msg, imu_msg, localization);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> RTKLocalization::ComposeLocalizationMsg(<span class="keyword">const</span> localization::Gps&amp; gps_msg, <span class="keyword">const</span> localization::Imu &amp;img_msg, LocalizationEstimate* localization)</div><div class="line">&#123;</div><div class="line">	<span class="comment">// add header </span></div><div class="line">	<span class="comment">// set measurement time </span></div><div class="line">	<span class="comment">// combine gps and imu </span></div><div class="line">	</div><div class="line">	<span class="keyword">auto</span> mutable_pose = localization-&gt;mutable_pose(); </div><div class="line">	</div><div class="line">	<span class="keyword">if</span>(gps_msg.has_localization())&#123;</div><div class="line">		<span class="keyword">const</span> <span class="keyword">auto</span> &amp;pose = gps_msg.localization();</div><div class="line">		<span class="keyword">if</span>(pose.has_position())&#123; <span class="comment">// update mutable_pose &#125;;</span></div><div class="line">		<span class="keyword">if</span>(pose.has_orientation()) &#123; <span class="comment">//update mutable orientation &#125;;</span></div><div class="line">		<span class="keyword">if</span>(pose.has_linear_velocity())&#123;&#125;;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">if</span>(imu.has_linear_acceleration())&#123;	<span class="comment">//update mutable_pose acc &#125;;</span></div><div class="line">	<span class="keyword">if</span>(imu.has_angular_velocity())&#123;&#125;;</div><div class="line">	<span class="keyword">if</span>(imu.has_euler_angles())&#123;&#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="MSF"><a href="#MSF" class="headerlink" title="MSF"></a>MSF</h2><p><a href="https://github.com/ApolloAuto/apollo/tree/r2.0.0/modules/localization/msf" target="_blank" rel="external">vehicle localization based on multi-sensor fusion</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MSFLocalization</span> &#123;</span>	</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">InitParams</span><span class="params">()</span></span>;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">OnPointCloud</span><span class="params">(<span class="keyword">const</span> sensor_msgs::PointCloud2 &amp;message)</span></span>;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">OnRawImu</span><span class="params">(<span class="keyword">const</span> drivers::gnss::Imu &amp;imu_msg)</span></span>;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">OnGnssRtkObs</span><span class="params">(<span class="keyword">const</span> EpochObservation &amp;raw_obs_msg)</span></span>;</div><div class="line">	<span class="comment">// ...</span></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">PublishPoseBroadcastTF</span><span class="params">(<span class="keyword">const</span> LocalizationEstimate&amp; localization)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">Status MSFLocalization::Start()</div><div class="line">&#123;</div><div class="line">	AdapterManager::Init(FLAGS_msf_adapter_config_file);</div><div class="line">	Status &amp;&amp;status = Init();</div><div class="line">	</div><div class="line">	AdapterManager::GetRawImu();</div><div class="line">	AdapterManager::ADDRawImuCallback(&amp;MSFLocalization::OnRawImu, <span class="keyword">this</span>);</div><div class="line">	</div><div class="line">	AdapterManager::GetPointCloud();</div><div class="line">	AdapterManager::AddPointCloudCallback(&amp;MSFLocalization::OnPointCloud, <span class="keyword">this</span>);</div><div class="line">	</div><div class="line">	<span class="comment">// ...</span></div><div class="line">	</div><div class="line">	<span class="keyword">return</span> Status::OK();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>there is addtional <a href="https://github.com/ApolloAuto/apollo/tree/r2.0.0/modules/localization/msf/local_map" target="_blank" rel="external"><code>local_map</code></a> module, which will be review later.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/03/Apollo-2-0-Prediction源码/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/03/Apollo-2-0-Prediction源码/" itemprop="url">Apollo 2.0 Prediction源码</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-03T01:28:52-04:00">
                2019-05-03
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/05/03/Apollo-2-0-Prediction源码/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/05/03/Apollo-2-0-Prediction源码/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Prediction"><a href="#Prediction" class="headerlink" title="Prediction"></a>Prediction</h2><p>prediction inputs are: obstacles from perception module nad localization from localization module. outputs are obstacles will predicted trajectories. </p>
<p>there are three classes in prediction modules:</p>
<pre><code>* container
store input dat from subscribed channelds, e.g. perception obstacles, vehicle localization 
* evalutor
predicts paths and speed separately for any given obstacles
* predictor
generate predicted trajectories for obstacles. e.g. lane sequence(obstacle moves following the lanes),  free movement, regional moves(move in a possbile region)
</code></pre><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// 模块入口</span></div><div class="line"></div><div class="line">APOLLO_MAIN(apollo::prediction::Prediction);</div><div class="line"></div><div class="line">Status Prediction::Init()</div><div class="line">&#123;</div><div class="line">	predicition_conf_.Clear();</div><div class="line">	adapter_conf_.Clear();</div><div class="line">common::util::GetProtoFromFile(FLAGS_prediction_adapter_config_filename, &amp;adapter_conf_);</div><div class="line">	</div><div class="line">	<span class="comment">//Initial managers</span></div><div class="line">	AdapterManager::Init(adapter_conf_);</div><div class="line">	ContainerManager::instance()-&gt;Init(adapter_conf_);</div><div class="line">	EvaluatorManager::instance()-&gt;Init(prediction_conf_);</div><div class="line">	PredictorManager::instance()-&gt;Init(prediction_conf_);</div><div class="line">	</div><div class="line">	AdapterManager::GetLocalization();</div><div class="line">	AdapterManager::GetPerceptionObstacles(); 	</div><div class="line">			AdapterManger::AddPerceptionObstaclesCallback(&amp;Prediction::RunOnce, <span class="keyword">this</span>);</div><div class="line">	AdapterManger::AddLocalizationCallback(&amp;Prediction::OnLocalization, <span class="keyword">this</span>);</div><div class="line"></div><div class="line">AdapterManger::AddPlanningCallback(&amp;Prediction::OnPlanning, <span class="keyword">this</span>);</div><div class="line">	</div><div class="line"><span class="keyword">return</span> Status::OK();</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> Prediction::RunOnce(<span class="keyword">const</span> PerceptionObstacles&amp; perception_obstacles)</div><div class="line">&#123;</div><div class="line">	ObstaclesContainer* obstacles_container = <span class="keyword">dynamic_cast</span>&lt;ObstaclesContainer*&gt;(ContainerManager::instance()-&gt;GetContainer(AdapterConfig::PERCEPTION_OBSTACLES));</div><div class="line">	</div><div class="line">	obstacles_container-&gt;Insert(perception_obstacles);</div><div class="line">	EvaluatorManager::instace()-&gt;Run(perception_obstacles);</div><div class="line">	PredictorManager::instance()-&gt;Run(perception_obstacles);</div><div class="line">	</div><div class="line">	<span class="keyword">auto</span> prediction_obstacles = PredictorManager::instance()-&gt;prediction_obstacles();</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">auto</span> <span class="keyword">const</span>&amp; prediction_obstacle : prediction_obstacles.prediction_obstalces())&#123;</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">auto</span> <span class="keyword">const</span>&amp; trajectory:prediction_obstacle.trajectory())</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">auto</span> <span class="keyword">const</span>&amp; trajectory_point : trajectory.trajectory_point())</div><div class="line">		&#123;</div><div class="line">			<span class="keyword">if</span>(!IsValidTrajectoryPoint(trajectory_point))&#123;</div><div class="line">				<span class="keyword">return</span> ;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125; </div><div class="line">	</div><div class="line">	Publish(&amp;prediction_obstacles);</div><div class="line">	</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> Prediction::OnLocalization(<span class="keyword">const</span> LocalizationEstimate&amp; localization, ObstaclesContainer* obstacles_container)</div><div class="line"></div><div class="line"><span class="keyword">void</span> Prediction::OnPlanning(<span class="keyword">const</span> planning::ADCTrajectory&amp; adc_trajectory, ADCTrajectoryContainer* adc_trajectory_container)</div></pre></td></tr></table></figure>
<p>Prediction interface has defined: RunOnce() and Pulish(). the Prediction class has defined listener’s callback: <code>OnLocalization</code>, <code>OnPlanning</code>, and <code>Start()</code>, <code>Stop()</code> and implemented interface functions. For both EvaluatorManager and PredictorManager, there are <code>Init()</code> and <code>Run()</code> functions, and there are bunch of apis from container class.</p>
<h2 id="Evaluator"><a href="#Evaluator" class="headerlink" title="Evaluator"></a>Evaluator</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">void</span> EvaluatorManager::Init(<span class="keyword">const</span> PredictionConf&amp; config)</div><div class="line">&#123;</div><div class="line">	<span class="comment">//...</span></div><div class="line">	<span class="keyword">switch</span>(config.obstacle_type())&#123;</div><div class="line">		<span class="keyword">case</span> PerceptionObstacle::VEHICLE :&#123;</div><div class="line">			vehicle_on_lane_evaluator_ = obstalce_conf.evaluator_type();</div><div class="line">			<span class="keyword">break</span>; </div><div class="line">		</div><div class="line">		<span class="keyword">case</span> PerceptionObstacle::BICYCLE:&#123;</div><div class="line">			cyclist_on_lane_evaluator_ = obstlce_conf.evluator_type();</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">			</div><div class="line">		<span class="keyword">case</span> PerceptionObstacle::PEDESTRAIN:&#123;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">case</span> PerceptionObstacle::UNKNOWN:&#123;</div><div class="line">			default_on_lane_evaluator_ = obstacle_conf.evalutor_type();</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">Evaluator* EvaluatorManager::Run(<span class="keyword">const</span> perception::PerceptionObstacles&amp; perception_obstacles)</div><div class="line">&#123;</div><div class="line">	ObstaclesContainer* container = <span class="keyword">dynamic_cast</span>&lt;ObstaclesContainer*&gt;();</div><div class="line">	</div><div class="line">	Evaluator* evaluator = <span class="literal">nullptr</span> ;</div><div class="line">	</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">const</span> <span class="keyword">auto</span>&amp; perception_obstacle : perception_obstacles.perception_obstalce())</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">int</span> id = perception_obstalce.id(); </div><div class="line">		Obstacle* obstacle = container-&gt;GetObstalce(id);</div><div class="line">		<span class="keyword">switch</span>(perception_obstalce.type())</div><div class="line">		&#123;</div><div class="line">			<span class="keyword">case</span> PerceptionObstacle::VEHICLE: &#123;</div><div class="line">				<span class="keyword">if</span>(obstacle-&gt;IsOnLane())&#123;</div><div class="line">					evaluator = GetEvaluator(vehicle_on_lane_evaluator_); </div><div class="line">				&#125;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line">			</div><div class="line">			<span class="keyword">case</span> PerceptionObstacle::BICYCLE:&#123;</div><div class="line">				<span class="keyword">if</span>(obstacle-&gt;IsOnLane())&#123;</div><div class="line">					evaluator = GetEvaluator(cyclist_on_lane_evaluator_);</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line">	</div><div class="line">			<span class="comment">// ...</span></div><div class="line">			</div><div class="line">			<span class="keyword">if</span>(evaluator != <span class="literal">nullptr</span>)</div><div class="line">			&#123;</div><div class="line">				evaluator-&gt;Evaluate(obstacle);</div><div class="line">			&#125;</div><div class="line">		&#125;	</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>and there are a few different evaluators: (multilayer perception approach) MLP and RNN(deep neural network), both will discuss in details in future.</p>
<h2 id="Predictor"><a href="#Predictor" class="headerlink" title="Predictor"></a>Predictor</h2><p>predictor will generate trajectories, a few apis:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">virtual</span> <span class="keyword">void</span> predictor::Predict(Obstacle* obstacle) = <span class="number">0</span>;</div><div class="line"></div><div class="line"><span class="keyword">void</span> predictor::TrimTrajectories(<span class="keyword">const</span> Obstacle, <span class="keyword">const</span> ADCTrajectoryContainer* );</div><div class="line"></div><div class="line"><span class="keyword">static</span> predictor::<span class="function">Trajectory <span class="title">GenerateTrajectory</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;apollo::common::TrajectoryPoint&gt;&amp; points)</span> </span>;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">void</span> PredictorManager::Init(<span class="keyword">const</span> PredictionConf&amp; config)</div><div class="line">&#123;</div><div class="line">	<span class="comment">// ...</span></div><div class="line">	<span class="keyword">switch</span>(obstacle_conf.obstacle_type())</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">case</span> PerceptionObstacle::VEHICLE: &#123;</div><div class="line">			<span class="keyword">if</span>(obstacle_conf.obstacle_status() == ObstacleConfg::ON_LANE)&#123;</div><div class="line">				vehicle_on_lane_predictor_ = obstacle_conf.predictor_type();</div><div class="line">			&#125;<span class="keyword">else</span> <span class="keyword">if</span>(obstacle_conf.obstacle_status() == ObstacleConf::OFF_LANE)&#123;</div><div class="line">			vehicle_off_lane_predictor_ = obstacle_conf.predictor_type();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">break</span>; </div><div class="line">		</div><div class="line">		<span class="comment">// ...</span></div><div class="line">		</div><div class="line"> &#125;</div><div class="line"> </div><div class="line"> <span class="keyword">void</span> PredictorManager::Run(<span class="keyword">const</span> PerceptionObstacles&amp; perception_obstacles)&#123;</div><div class="line"> 	ObstaclesContainer* obstacles_container =  <span class="keyword">dynamic_cast</span>&lt;ObstaclesContainer*&gt;(AdapterConfig::PERCEPTION_OBSTACLES) ;</div><div class="line"> 	ADCTrajectoryContainer *adc_trajectory_container = <span class="keyword">dynamic_cast</span>&lt;ADCTrajectoryContainer*&gt;(AdapterConfig::PLANNING_TRAJECTORY);</div><div class="line"> 	</div><div class="line"> 	Predictor* predictor = <span class="literal">nullptr</span> ; </div><div class="line"> 	<span class="keyword">for</span>(<span class="keyword">const</span> <span class="keyword">auto</span>* perception_obstacle : perception_obstacles.perception_obstacle())</div><div class="line"> 	&#123;</div><div class="line"> 		<span class="keyword">int</span> id = perception_obstacle.id();</div><div class="line"> 		PredictionObstacle prediction_obstacle ;</div><div class="line"> 		Obstacle* obstacle = obstacle_container-&gt;GetObstacle(id);</div><div class="line"> 		</div><div class="line"> 		<span class="keyword">if</span>(obstacle != <span class="literal">nullptr</span>)</div><div class="line"> 		&#123;</div><div class="line"> 			<span class="keyword">switch</span>(perception_obstacle.type())</div><div class="line"> 			&#123;</div><div class="line"> 				<span class="keyword">case</span> PerceptionObstacle::VEHICLE: &#123;</div><div class="line"> 					<span class="keyword">if</span>(obstacle-&gt;IsOnLane())&#123;</div><div class="line"> 						predictor = GetPredictor(vehicle_on_lane_predictor_);</div><div class="line"> 						&#125;<span class="keyword">else</span>&#123;</div><div class="line"> 							predictor = GetPredictor(vehicle_off_lane_predictor_);</div><div class="line"> 						&#125;</div><div class="line"> 						<span class="keyword">break</span>;</div><div class="line"> 					&#125;</div><div class="line"> 					</div><div class="line"> 					<span class="comment">// ...</span></div><div class="line"> 			 &#125;</div><div class="line"> 			 </div><div class="line"> 			 <span class="keyword">if</span>(predictor != <span class="literal">nullptr</span>)</div><div class="line"> 			 &#123;</div><div class="line"> 			 	predictor-&gt;Predict(obstacle);</div><div class="line"> 			 	<span class="keyword">if</span>(obstacle-&gt;type() == PerceptionObstacle::VEHICLE)&#123;</div><div class="line"> 			 		predictor-&gt;TrimTrajectories(obstacle, adc_trajectory_container);</div><div class="line"> 			 	&#125;</div><div class="line"> 			 	</div><div class="line"> 			 	<span class="keyword">for</span>(<span class="keyword">const</span> <span class="keyword">auto</span>&amp; trajectory : predictor-&gt;trajectories())</div><div class="line"> 			 	&#123;</div><div class="line"> 			 		prediction_obstacle.add_trajectory()-&gt;CopyFrom(trajectory);</div><div class="line"> 			 	&#125;</div><div class="line"> 			 &#125;</div><div class="line"> 			 </div><div class="line"> 		&#125;</div><div class="line"> 			</div><div class="line"> 		prediction_obstacle.mutable_perception_obstacle()-&gt;CopyFrom(perception_obstacle);</div><div class="line"> 		</div><div class="line"> 		prediction_obstacles_.add_prediction_obstacle()-&gt;CopyFrom(prediction_obstacle); </div><div class="line"> 	&#125;</div></pre></td></tr></table></figure>
<p>the predictor has a few types:: regional based, free move, lane sequence e.t.c, which defined as subclasses, will discuss more in future.  </p>
<h2 id="Container"><a href="#Container" class="headerlink" title="Container"></a>Container</h2><p>container manager class has a few subclass as adc_trajctory container, obstacles contianer and pose constainer, which should be discussed in details later.</p>
<h2 id="Adapter"><a href="#Adapter" class="headerlink" title="Adapter"></a>Adapter</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// in adapter_manager.cc </span></div><div class="line"><span class="keyword">case</span> AdapterConfig::LOCALIZATION:</div><div class="line">	EnableLocalization(FLAGS_localization_topic, config);</div><div class="line"></div><div class="line"><span class="keyword">case</span> AdatperConfig::PERCEPTION_OBSTACLES:</div><div class="line">	EnablePerceptionObstacles(FLAGS_perception_obstacle_topic, config);</div><div class="line">	</div><div class="line"><span class="comment">// in messsage_adapters.h </span></div><div class="line"><span class="keyword">using</span> PerceptionObstaclesAdapter = Adapter&lt;perception::PerceptionObstacles&gt;; </div><div class="line"><span class="keyword">using</span> LocalizationAdapter = Adapter&lt;apollo::localization::LocalizationEstimate&gt;;</div><div class="line"></div><div class="line"><span class="comment">// in adapter_manager.h </span></div><div class="line"><span class="keyword">static</span> voi Enable#<span class="meta">#name()&#123;</span></div><div class="line">	instance()-&gt;InternalEnable#<span class="meta">#name(topic_name, config);</span></div><div class="line">&#125;; </div><div class="line"></div><div class="line"><span class="keyword">static</span> name##Adapter *Get#<span class="meta">#name()&#123;</span></div><div class="line">	<span class="keyword">return</span> instance()-&gt;InternaleGet##name();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> Add#<span class="meta">#name##Callback(name##Adapter::Callback callback)&#123;</span></div><div class="line">	instance()-&gt;name##_-&gt;AddCallback(callback);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">staic</span> <span class="title">void</span> <span class="title">Add</span>##<span class="title">name</span>##<span class="title">Callback</span>(<span class="title">void</span>(<span class="title">T</span>:</span>: *fp)(<span class="keyword">const</span> name##Adapter::DataType &amp;data), T* obj)</div><div class="line">&#123;</div><div class="line">	Add#<span class="meta">#name##Callback(std::bind(fp, obj, std::placeholders::_1));</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/01/Apollo2-0-Control-源码-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/01/Apollo2-0-Control-源码-3/" itemprop="url">Apollo2.0 Control 源码 (3)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-01T05:18:50-04:00">
                2019-05-01
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/05/01/Apollo2-0-Control-源码-3/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/05/01/Apollo2-0-Control-源码-3/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>the input of Apollo control module includes: chassis info, localization info, and planning info ,the output is steering angle,  acc,  throttle.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// 模块入口</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> APOLLO_MAIN(APP)                                       </span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;                            </div><div class="line">    google::InitGoogleLogging(argv[<span class="number">0</span>]);                        </div><div class="line">    google::ParseCommandLineFlags(&amp;argc, &amp;argv, <span class="literal">true</span>);         </div><div class="line">    signal(SIGINT, apollo::common::apollo_app_sigint_handler); </div><div class="line">    APP apollo_app_;                                           </div><div class="line">    ros::init(argc, argv, apollo_app_.Name());                 </div><div class="line">    apollo_app_.Spin();    <span class="comment">//check previous blog(1)                                  </span></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;                                                  </div><div class="line">  &#125;</div><div class="line"></div><div class="line">	</div><div class="line">Status Control::Init()&#123;</div><div class="line">	init_time_ = Clock::NowInSeconds(); </div><div class="line">	common::util::GetProtoFromFile(FLAGS_control_conf_file, &amp;control_conf_);</div><div class="line">	AdapterManager::Init(FLAGS_control_adapter_config_filename);</div><div class="line">	</div><div class="line">	common::monitor::<span class="function">MonitorLogBuffer <span class="title">buffer</span><span class="params">(&amp;monitor_logger_)</span></span>;</div><div class="line">	</div><div class="line">	controller_agent_.Init(&amp;control_conf_); </div><div class="line">	</div><div class="line">	AdapterManager::GetLocalization(); </div><div class="line">	AdapterManager::GetChassis();</div><div class="line">	AdapterManager::GetPlanning(); </div><div class="line">	AdpaterManager::GetControlCommand(); 	AdapterManager::GetMonitor();</div><div class="line">	</div><div class="line">	AdapterManager::AddMonitorCallback(&amp;Control::OnMonitor, <span class="keyword">this</span>);</div><div class="line">	</div><div class="line">	<span class="keyword">return</span> Status::OK();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>conf_file:   /modules/control/conf/lincoln.pd/txt, </p>
<p>which is derieved from </p>
<p>/modules/calibration/data/mkz8/calibration_table.pd.txt</p>
<p>the topics in control modules are :</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">config &#123;</div><div class="line">	type: LOCALIZATION</div><div class="line">	mode: RECEIVE_ONLY</div><div class="line">&#125;</div><div class="line"></div><div class="line">config &#123;</div><div class="line">	type: PLANNING_TRAJECTORY</div><div class="line">	mode: RECEIVE_ONLY</div><div class="line">&#125;</div><div class="line"></div><div class="line">config &#123;</div><div class="line">	type: CHASSIS</div><div class="line">	mode: RECEIVE_ONLY</div><div class="line">&#125;</div><div class="line"></div><div class="line">config &#123;</div><div class="line">	type: CONTROL_COMMAND</div><div class="line">	mode: PUBLISH_ONLY</div><div class="line">&#125;</div><div class="line"></div><div class="line">config &#123;</div><div class="line">	type: MONITOR</div><div class="line">	mode: DUPLEX</div><div class="line">&#125; </div><div class="line"></div><div class="line">``` </div><div class="line"></div><div class="line">basically, control <span class="keyword">module</span> will receive topic about /localization,  /planning,  /chassis, <span class="keyword">and</span> publish /control_command </div><div class="line"></div><div class="line"></div><div class="line">the controller_agent is an interface <span class="class"><span class="keyword">class</span>, <span class="title">so</span> <span class="title">can</span> <span class="title">support</span> <span class="title">user</span> <span class="title">defined</span> <span class="title">controller</span> <span class="title">algorithms</span>, <span class="title">which</span> <span class="title">only</span> <span class="title">need</span> <span class="title">to</span> <span class="title">configure</span> <span class="title">through</span>  `<span class="title">control_conf</span>` </span></div><div class="line"></div><div class="line">```<span class="title">c</span></div><div class="line"></div><div class="line"><span class="title">Status</span> <span class="title">ControllerAgent</span>::Init(<span class="keyword">const</span> ControlConf* control_conf)</div><div class="line">&#123;</div><div class="line">	RegisterControllers(control_conf); </div><div class="line"></div><div class="line">	InitializeConf(control_conf); </div><div class="line">	</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">auto</span> &amp;controller : controller_list_)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">if</span>(controller == <span class="literal">NULL</span> || !controller-&gt;Init(control_conf_).ok())</div><div class="line">		&#123;</div><div class="line">			<span class="keyword">return</span> Status(ErrorCode);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">return</span> Status::OK();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> ControllerAgent::RegisterControllers(<span class="keyword">const</span> ControlConf *control_conf)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">auto</span> active_controller : control_conf-&gt;active_controllers())</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">switch</span>(active_controller)&#123;</div><div class="line">			</div><div class="line">			<span class="keyword">case</span> ControlConf::MPC_CONTROLLER:</div><div class="line">				controller_factory_.Register(</div><div class="line">					ControlConf::MPC_CONTROLLER, </div><div class="line">					[]()-&gt;Controller * &#123;<span class="keyword">return</span> <span class="keyword">new</span> MPCController();&#125;);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">			</div><div class="line">			<span class="comment">//case LAT_CONTROLLER </span></div><div class="line">			</div><div class="line">			<span class="comment">//case LON_CONTROLLER </span></div><div class="line">			</div><div class="line">		   &#125;</div><div class="line">		&#125;</div><div class="line"> 	&#125;</div><div class="line"> </div><div class="line"> </div><div class="line"> Status Control::Start()&#123;</div><div class="line"> </div><div class="line"> 	<span class="comment">//sleep for advertised channel to ready</span></div><div class="line"> 	</div><div class="line"> 	<span class="built_in">std</span>::this_thread::sleep_for(<span class="built_in">std</span>::chrono::millisecons(<span class="number">1000</span>)); 	</div><div class="line"> 	timer_ = AdapterManager::CreateTimer(ros::Duration(control_conf_.control_period()), </div><div class="line"> 	&amp;Control::OnTimer, <span class="keyword">this</span>);</div><div class="line"> 	</div><div class="line"> 	common::monitor::<span class="function">MonitorLogBuffer <span class="title">buffer</span><span class="params">(&amp;monitor_logger_)</span></span>;</div><div class="line"> 	</div><div class="line"> 	<span class="keyword">return</span> Status::OK();</div><div class="line"> &#125;</div><div class="line"> </div><div class="line"> </div><div class="line"> <span class="keyword">void</span> Control::OnTimer(<span class="keyword">const</span> ros::TimerEvent &amp;)</div><div class="line"> &#123;</div><div class="line"> 	<span class="keyword">double</span> start_timestamp = Clock::NowInSeconds();</div><div class="line"> 	</div><div class="line"> 	ControlCommand control_command ;</div><div class="line"> 	Status status = ProduceControlCommand(&amp;control_command);</div><div class="line"> 	</div><div class="line"> 	<span class="keyword">double</span> end_timestamp = Clock::NowInSeconds(); </div><div class="line"> 	</div><div class="line"> 	status.Save(control_command.mutable_header()-&gt;mutable_status());</div><div class="line"> 	</div><div class="line"> 	SendCmd(&amp;control_command);</div><div class="line"> &#125;</div><div class="line"> </div><div class="line"> </div><div class="line">  Status Control::ProduceControlCommand(ControlCommand *control_command)</div><div class="line">  &#123;</div><div class="line">  	Status status = CheckInput();</div><div class="line">  	Status status_ts = CheckTimestamp();</div><div class="line"> </div><div class="line"> 	Status status_compute = controller_agent_.ComputeControlCommand(</div><div class="line"> 		&amp;localization_, &amp;chassis_, &amp;trajectory_, control_command);</div><div class="line"> 	</div><div class="line"> 	<span class="keyword">return</span> status;</div><div class="line">  &#125;</div><div class="line"> 		</div><div class="line"> </div><div class="line"> </div><div class="line"> Status ControllerAgent::ComputeControlCommand(</div><div class="line"> 	<span class="keyword">const</span> localization::LocalizationEstimate *localization,</div><div class="line"> 	cosnt canbus::Chassis *chassis, <span class="keyword">const</span> planning::ADCTrajectory *trajectory,</div><div class="line"> 	control::ControlCommand *cmd)&#123;</div><div class="line"> 	<span class="keyword">for</span>(<span class="keyword">auto</span> &amp;controller : controller_list_)</div><div class="line"> 	&#123;</div><div class="line"> 		controller-&gt;ComputeControlCommand(localization, chassis, trajectory, cmd) ;</div><div class="line"> 	&#125;</div><div class="line"> 	<span class="keyword">return</span> status::OK();</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>ControllerAgent::ComputeCmd() is the interface, the real control cmd will be computed inside each specified controller modes. there are few controller modes: MPC, Lattice e.g in Apollo.</p>
<p>in next few days continue work on localization, prediction, and decision modules in Apollo 2.0</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="David Z.J. Lee" />
          <p class="site-author-name" itemprop="name">David Z.J. Lee</p>
           
              <p class="site-description motion-element" itemprop="description">what I don't know</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">137</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">32</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/ZJLi2013" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.linkedin.com/in/zhengjia13/" target="_blank" title="LinkedIn">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  LinkedIn
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">David Z.J. Lee</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://zjlee.disqus.com/count.js" async></script>
    

    

  




	





  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
