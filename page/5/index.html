<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="what I don&apos;t know">
<meta property="og:type" content="website">
<meta property="og:title" content="Serious Autonomous Vehicles">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="Serious Autonomous Vehicles">
<meta property="og:description" content="what I don&apos;t know">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Serious Autonomous Vehicles">
<meta name="twitter:description" content="what I don&apos;t know">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/5/"/>





  <title>Serious Autonomous Vehicles</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Serious Autonomous Vehicles</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/04/driving-scenarios-on-going/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/04/driving-scenarios-on-going/" itemprop="url">driving scenarios on-going</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-04T04:18:26-05:00">
                2020-03-04
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/04/driving-scenarios-on-going/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/03/04/driving-scenarios-on-going/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Euro-NCAP-driving-scenarios"><a href="#Euro-NCAP-driving-scenarios" class="headerlink" title="Euro NCAP driving scenarios"></a>Euro NCAP driving scenarios</h2><h3 id="Adaptive-Cruise-Control-ACC"><a href="#Adaptive-Cruise-Control-ACC" class="headerlink" title="Adaptive Cruise Control(ACC)"></a>Adaptive Cruise Control(ACC)</h3><p>ACC is tested in an extended version of AEB. these systems are designed to automatically adapt the speed when approaching a slower moving vehicle or noe that is braking. <strong>notification</strong>, not all systems perform well with stationary obstacles.</p>
<ul>
<li><p>a slow moving vehicle test</p>
</li>
<li><p>a stationary obstacle(e.g. vehicle) test</p>
</li>
</ul>
<h3 id="autonomous-emergency-braking-AEB"><a href="#autonomous-emergency-braking-AEB" class="headerlink" title="autonomous emergency braking(AEB)"></a>autonomous emergency braking(AEB)</h3><h4 id="AEB-pedestrain"><a href="#AEB-pedestrain" class="headerlink" title="AEB pedestrain"></a><a href="https://www.euroncap.com/en/vehicle-safety/the-ratings-explained/vulnerable-road-user-vru-protection/aeb-pedestrian/" target="_blank" rel="external">AEB pedestrain</a></h4><ul>
<li><p>an adult pedestrain running from the driver’s side of the vehicle </p>
</li>
<li><p>an adult walk from the passenger’s side</p>
</li>
<li><p>a child runs from between parked cars on the passenger’s side of the car</p>
</li>
<li><p>pedestrain walking in the same direction as the vehicle algnedwith the centre of vehicle </p>
</li>
<li><p>pedestrain walking in the same direction as the vehicle offset to one side</p>
</li>
</ul>
<h4 id="AEB-cyclist"><a href="#AEB-cyclist" class="headerlink" title="AEB cyclist"></a><a href="https://www.euroncap.com/en/vehicle-safety/the-ratings-explained/vulnerable-road-user-vru-protection/aeb-cyclist/" target="_blank" rel="external">AEB cyclist</a></h4><ul>
<li><p>cyclist is crossing the vehicle’s path </p>
</li>
<li><p>cyclist is travelling in the same direction </p>
</li>
</ul>
<p>Euro NCAP gives greatest reward if a collision is completely avoided; in some case, if AEB is unable to stop the vehicle completely, still give some points. </p>
<h3 id="lane-keeping-assist-LKA"><a href="#lane-keeping-assist-LKA" class="headerlink" title="lane keeping assist(LKA)"></a>lane keeping assist(LKA)</h3><ul>
<li><p>lane centering, a good ADS should continue to support the driver during the manoeuvre and will not resist the driver or deactivate.</p>
</li>
<li><p>cut-in test, a npc from adjacent lane merges into the current lane</p>
</li>
<li><p>cut-off test, a npc leaves the current lane abruptly to avoid a stopped vehicle ahead</p>
</li>
<li><p>swerve around a small obstacle test</p>
</li>
<li><p>speed assistance test, to use map data and/or data from sensors to identify the local speed limit </p>
</li>
</ul>
<h2 id="NHTSA-driving-scenarios"><a href="#NHTSA-driving-scenarios" class="headerlink" title="NHTSA driving scenarios"></a>NHTSA driving scenarios</h2><p>a previous blog <a href="">design scenarios in ADS simulation</a> is based on NHTSA. </p>
<h3 id="forward-collision-prevention"><a href="#forward-collision-prevention" class="headerlink" title="forward collision prevention"></a>forward collision prevention</h3><ul>
<li>Forward collision warning</li>
<li>AEB</li>
<li>pedestrain AEB</li>
<li>Adaptive lighting</li>
</ul>
<h3 id="backing-up-amp-parking"><a href="#backing-up-amp-parking" class="headerlink" title="backing up &amp; parking"></a>backing up &amp; parking</h3><ul>
<li>rear automatic braking </li>
<li>backup camera </li>
<li>rear cross traffic alert</li>
</ul>
<h3 id="lane-amp-side-assist"><a href="#lane-amp-side-assist" class="headerlink" title="lane &amp; side assist"></a>lane &amp; side assist</h3><ul>
<li>lane departure warning</li>
<li>lane keeping assist</li>
<li>blind spot detection</li>
<li>lane centering assist</li>
</ul>
<h3 id="maintaing-safe-distance"><a href="#maintaing-safe-distance" class="headerlink" title="maintaing safe distance"></a>maintaing safe distance</h3><ul>
<li>traffic jam assist</li>
<li>highway pilot</li>
<li>ACC </li>
</ul>
<h2 id="Matlab-Driving-Scenario-samples"><a href="#Matlab-Driving-Scenario-samples" class="headerlink" title="Matlab Driving Scenario samples"></a>Matlab Driving Scenario samples</h2><h3 id="AEB-for-vulnerable-road-users"><a href="#AEB-for-vulnerable-road-users" class="headerlink" title="AEB (for vulnerable road users)"></a>AEB (for vulnerable road users)</h3><ul>
<li><p><code>AEB_Bicyclist_Longitudinal_25width</code>, at collision time, the bicycle is 25% of the way across the width of the ego vehicle.</p>
</li>
<li><p><code>AEB_CCRb_2_initialGap_12m</code>, a car-to-car rear braking(CCRb) scenario where the ego rear hit a braking agent. the deceleration is 2 m/s^2 with initial gap 12m</p>
</li>
<li><p><code>AEB_CCRm_50overlap</code>, a car-to-car rear moving(CCRm) scenario, where the ego rear hits a moving vehicle. at collisio ntime, the ego overlaps with 50% of the width of the moving vehicle</p>
</li>
</ul>
<ul>
<li><code>AEB_CCRs_-75overlap</code>, a car-to-car stationary(CCRs) sceanrio, where the ego rear hits a stationary vehicle. at collision time, the ego overlaps with 75% of the width of the stationary vehicle. when the ego is to the left of the other vehicle, the percent overlap is negative</li>
</ul>
<ul>
<li><p><code>AEB_Pedestrain_Farside_50width</code>, the ego collides with a pedestrain who is traveling from the left side(far side, assuming vehicle drive on right side of the road). at collision time, the pedestrain is 50% of the way across the width of the ego</p>
</li>
<li><p><code>AEB_PedestrainChild_Nearside_50width</code>, the ego collides with a pedestrain who is traveling from the right side(near side), at collision time, the pedestrain is 50% of the way across the width of the ego</p>
</li>
</ul>
<h3 id="Emergency-Lane-Keeping-ELK"><a href="#Emergency-Lane-Keeping-ELK" class="headerlink" title="Emergency Lane Keeping(ELK)"></a>Emergency Lane Keeping(ELK)</h3><ul>
<li><p><code>ELK_FasterOvertakingVeh_Intent_Vlat_0.5</code>, ego intentionally changes lanes but collides with a faster overtaking vehicle, the ego travels at a lateral velocity of 0.5m/s</p>
</li>
<li><p><code>ELK_OncomingVeh_Vlat_0.3</code>, ego unintentionally changes lanes and collides with an oncoming vehicle, with ego’s lateral velocity of 0.3m/s</p>
</li>
<li><p><code>ELK_OvertakingVeh_Unintent_Vlat_0.3</code>, ego unintentionally changes lanes, overtake a vehicle in the other lane and collides. the ego travles at a lateral velocity at 0.3m/s</p>
</li>
<li><p><code>ELK_RoadEdge_NoBndry_Vlat_0.2</code>,  ego unintentionally changes lanes and ends up to hte road edge, with lateral velocity at 0.2m/s</p>
</li>
</ul>
<h3 id="LKA"><a href="#LKA" class="headerlink" title="LKA"></a>LKA</h3><ul>
<li><p><code>LKA_DashedLine_Solid_Left_Vlat_0.5</code></p>
</li>
<li><p><code>LKA_DashedLine_Unmarked_Right_Vlat_0.5</code></p>
</li>
<li><p><code>LKA_RoadEdge_NoBndry_Vlat_0.5</code></p>
</li>
<li><p><code>LKA_RoadEdge_NoMarkings_Vlat_0.5</code></p>
</li>
<li><p><code>LKA_SolidLine_Dashed_Left_Vlat_0.5</code></p>
</li>
<li><p><code>LKA_SolidLine_Unmarked_Right_Vlat_0.5</code></p>
</li>
</ul>
<h2 id="open-source-libs"><a href="#open-source-libs" class="headerlink" title="open source libs"></a>open source libs</h2><ul>
<li><p><a href="https://github.com/Microsoft/AutonomousDrivingCookbook" target="_blank" rel="external">Microsoft: autonomous driving cookbook</a></p>
</li>
<li><p><a href="https://github.com/ZhaobinMo/TrafficNet" target="_blank" rel="external">TrafficNet: an open scenario lib</a></p>
</li>
<li><p><a href="https://github.com/Toyota-ITC-SSD/Vehicle-Simulation-Toolkit" target="_blank" rel="external">Toyota: vehicle simulation unity toolkit</a></p>
</li>
<li><p><a href="https://github.com/mathworks" target="_blank" rel="external">mathworks: github</a></p>
</li>
<li><p><a href="https://drivingstereo-dataset.github.io" target="_blank" rel="external">sensetime: driving stero dataset</a></p>
</li>
<li><p><a href="https://opensimulationinterface.github.io/open-simulation-interface/" target="_blank" rel="external">google: open simulator interface</a></p>
</li>
<li><p><a href="https://ml4ad.github.io" target="_blank" rel="external">cmu: ml4ad</a></p>
</li>
</ul>
<h2 id="scenarios-in-L2-vs-L3"><a href="#scenarios-in-L2-vs-L3" class="headerlink" title="scenarios in L2 vs L3+"></a>scenarios in L2 vs L3+</h2><p>scenarios in l2 is more like point in the whole driving manuevor, at a certain scenario/point, how the ADAS system response. while L3+ is a continously scenario, along each point during driving is part of the scenario, and inside which all kinds of l2 case scenario can happen. it does make sense to integrate l2 scenario planning response to l3+, which makes l3+ system more strict. </p>
<h4 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h4><p><a href="https://www.euroncap.com/en/vehicle-safety/safety-campaigns/2018-automated-driving-tests/" target="_blank" rel="external">2018 Automated driving test</a></p>
<p><a href="https://www.mathworks.com/help/driving/ug/euro-ncap-driving-scenarios-in-driving-scenario-designer.html" target="_blank" rel="external">mathworks: Euro NCAP driving scenarios in driving scenario designer</a></p>
<p><a href="https://cdn.euroncap.com/media/30700/euroncap-roadmap-2025-v4.pdf" target="_blank" rel="external">Euro NCAP roadmap 2025</a></p>
<p><a href="https://www.nhtsa.gov/vehicle-safety-research" target="_blank" rel="external">nhtsa vehicle safety legacy doc</a></p>
<p><a href="https://www.nhtsa.gov/equipment/driver-assistance-technologies#forward-collision-prevention-30631" target="_blank" rel="external">NHTSA driver assitance tech</a></p>
<p><a href="https://silvamfpedro.github.io/thesis-blog/index.html" target="_blank" rel="external">Study and adaptation of the autonomous driving simulator CARLA for ATLASCAR2</a></p>
<p><a href="https://www.mobileye.com/responsibility-sensitive-safety/rss_on_nhtsa.pdf" target="_blank" rel="external">implementing RSS model on NHTSA pre-crash scenarios</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/03/boto3-streamingBody-to-BytesIO/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/03/boto3-streamingBody-to-BytesIO/" itemprop="url">boto3 streamingBody to BytesIO</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-03T03:58:34-05:00">
                2020-03-03
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/03/boto3-streamingBody-to-BytesIO/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/03/03/boto3-streamingBody-to-BytesIO/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="boto3-streamingBody-to-BytesIO"><a href="#boto3-streamingBody-to-BytesIO" class="headerlink" title="boto3 streamingBody to BytesIO"></a>boto3 streamingBody to BytesIO</h1><h3 id="boto3-class-into"><a href="#boto3-class-into" class="headerlink" title="boto3 class into"></a>boto3 class into</h3><ul>
<li>A <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/session.html" target="_blank" rel="external">Session</a> is about a particular configuration. a custom session: </li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">session = boto3.session.Session()</div><div class="line">ads = session.client(<span class="string">'ads'</span>)</div><div class="line">ads_s3 = session.resource(<span class="string">'s3'</span>)</div></pre></td></tr></table></figure>
<ul>
<li><a href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/resources.html" target="_blank" rel="external">Resources</a> is an object-oriented interface to AWS. Every resource instance has a number of attributes and methods. These can conceptually be split up into identifiers, attributes, actions, references, sub-resources, and collections.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">obj = ads_s3.Object(bucket_name=<span class="string">"boto3"</span>, key=<span class="string">"test.mdf"</span>)</div></pre></td></tr></table></figure>
<ul>
<li><a href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/s3.html" target="_blank" rel="external">Client</a> includes common APIs:</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">copy_object()</div><div class="line">delete_object()</div><div class="line">create_bucket()</div><div class="line">delete_bucket()</div><div class="line">delete_objects()</div><div class="line">download_file()</div><div class="line">download_fileobj()</div><div class="line">get_bucket_location()</div><div class="line">get_bucket_policy()</div><div class="line">get_object()</div><div class="line">head_bucket()</div><div class="line">head_object()</div><div class="line">list_buckets()</div><div class="line">list_objects()</div><div class="line">put_bucket_policy()</div><div class="line">put_object()</div><div class="line">upload_file()</div><div class="line">upload_fileobj()</div></pre></td></tr></table></figure>
<ul>
<li><p><a href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/s3.html#service-resource" target="_blank" rel="external">Service Resource</a> have bucket and object subresources, as well as related actions.</p>
</li>
<li><p><a href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/s3.html#bucket" target="_blank" rel="external">Bucket</a>, is an abstract resource representing a S3 bucket.</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">b = ads_s3.Bucket(<span class="string">'name'</span>)</div></pre></td></tr></table></figure>
<ul>
<li><a href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/s3.html#object" target="_blank" rel="external">Object</a>, is an abstract resource representing a S3 object.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">obj = ads_s3.Object(<span class="string">'bucket_name'</span>, <span class="string">'key'</span>)</div></pre></td></tr></table></figure>
<h3 id="read-s3-object-amp-pipeline-to-mdfreader"><a href="#read-s3-object-amp-pipeline-to-mdfreader" class="headerlink" title="read s3 object &amp; pipeline to mdfreader"></a>read s3 object &amp; pipeline to mdfreader</h3><p>there are a few try-and-outs. first is to streaming s3 object as BufferedReader, which give a file-like object, and can read(), but <code>BufferedReader</code> looks more like a IO streaming than a file, which can’t seek. </p>
<h4 id="botocore-response-StreamingBody-as-BufferedReader"><a href="#botocore-response-StreamingBody-as-BufferedReader" class="headerlink" title="botocore.response.StreamingBody as BufferedReader"></a>botocore.response.StreamingBody as BufferedReader</h4><p>the following discussion is really really helpful:<br><a href="https://github.com/boto/boto3/issues/426" target="_blank" rel="external">boto3 issue #426:  how to use botocore.response.StreamingBody as stdin PIPE</a></p>
<p>at the code of the StreamingBody and it seems to me that is is really a wrapper of a class inheriting from io.IOBase) but only the read method from the raw stream is exposed, so not really a file-like object. it would make a lot of sense to expose the io.IOBase interface in the StreamingBody as we could wrapped S3 objects into a io.BufferedReader or a io.TextIOWrapper.read() get a binary string .  the actual file-like object is found in the ._raw_stream attribute of the StreamingBody class</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> io</div><div class="line">buff_reader = io.BufferedReader(body._raw_stream)</div><div class="line">print(buff_reader)</div><div class="line"><span class="comment"># &lt;_io.BufferedReader&gt;</span></div></pre></td></tr></table></figure>
<p>wheras this <code>buff_reader</code> is not seekable, which makes <a href="">mdfreader</a> failure, due to its file operate needs  <code>seek()</code> method.</p>
<p><a href="https://stackoverflow.com/questions/39324151/stream-a-non-seekable-file-like-object-to-multiple-sinks" target="_blank" rel="external">steam a non-seekable file-like object</a></p>
<h4 id="stdio-stream-to-seekable-file-like-object"><a href="#stdio-stream-to-seekable-file-like-object" class="headerlink" title="stdio stream to seekable file-like object"></a>stdio stream to seekable file-like object</h4><p>so I am thinking to transfer the <code>BufferedReader</code> to a seekable file-like object. first, need to understand why it is not seekable. <code>BufferedRandom</code> is seekable, whereas BufferedReader and BufferedWriter <a href="https://github.com/python/cpython/pull/11216" target="_blank" rel="external">are not</a>. <a href="https://grokbase.com/t/python/python-dev/102j1y1dwn/buffered-streams-design-raw-io-gotchas" target="_blank" rel="external">Buffered streams design:</a> BufferedRandom is only suitable when the file is open for reading <strong>and</strong> writing. The ‘rb’ and ‘wb’ modes should return BufferedReader and BufferedWriter, respectively.</p>
<p>is it possbile to first  read() the content of BufferedReader to some memory, than transfer it to BufferedRandom? which gives me the try to BufferedReader.read(), which basicaly read all the binaries and store it in-memoryA, <strong>then good news:</strong> in-memory binary streams are also aviable as <a href="https://docs.python.org/3/library/io.html" target="_blank" rel="external">Bytesio</a> objects: </p>
<pre><code class="python">f = io.BytesIO(<span class="string">b"some in-memory binary data"</span>)
</code></pre>
<p>what if assign <code>BytesIO</code> to this in-memoryA. which really gives me a seekable object:</p>
<pre><code class="python">fid_ = io.BufferedReader(mf4_[<span class="string">'Body'</span>]._raw_stream) ;
read_in_memory = fid_.read()
bio_ = io.BytesIO(read_in_memory);
</code></pre>
<p>then <code>BytesIO</code> object pointer is much more file-like, to do read() and seek(). </p>
<h3 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h3><p><a href="https://boto3.amazonaws.com/v1/documentation/api/latest/index.html" target="_blank" rel="external">boto3 doc</a></p>
<p><a href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/s3.html#examples" target="_blank" rel="external">boto3 s3 api samples</a></p>
<p><a href="https://github.com/ERS-HCL/MDF4Wrapper" target="_blank" rel="external">mdf4wrapper</a></p>
<p><a href="https://bytes.com/topic/c/answers/649819-ifstream-file" target="_blank" rel="external">iftream to FILE</a></p>
<p><a href="https://stackoverflow.com/questions/20935404/what-is-the-concept-behind-file-pointer-or-the-stream-pointer" target="_blank" rel="external">what is the concept behind file pointer or stream pointer</a></p>
<p><a href="https://stackoverflow.com/questions/10199226/using-io-bufferedreader-on-a-stream-obtained-with-open" target="_blank" rel="external">using io.BufferedReader on a stream obtained with open</a></p>
<p><a href="https://www.devdungeon.com/content/working-binary-data-python" target="_blank" rel="external">working with binary data in python</a></p>
<p><a href="https://stackoverflow.com/questions/1035340/reading-binary-file-and-looping-over-each-byte" target="_blank" rel="external">read binary file and loop over each byte</a></p>
<p><a href="https://github.com/RaRe-Technologies/smart_open" target="_blank" rel="external">smart_open project</a></p>
<p><a href="https://www.python.org/dev/peps/pep-3116/" target="_blank" rel="external">PEP 3116 – New I/O</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/28/ceph-boto3-intro/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/28/ceph-boto3-intro/" itemprop="url">ceph & boto3 introduction</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-28T21:16:46-05:00">
                2020-02-28
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/02/28/ceph-boto3-intro/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/02/28/ceph-boto3-intro/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="ceph-intro"><a href="#ceph-intro" class="headerlink" title="ceph intro"></a>ceph intro</h2><p>A Ceph Storage Cluster requires at least one Ceph Monitor, Ceph Manager, and Ceph OSD (Object Storage Daemon)</p>
<h3 id="ceph-storage-cluster"><a href="#ceph-storage-cluster" class="headerlink" title="ceph storage cluster"></a>ceph storage cluster</h3><p>The Ceph File System, Ceph Object Storage and Ceph Block Devices read data from and write data to the Ceph Storage Cluster.</p>
<p><a href="https://docs.ceph.com/docs/master/rados/operations/" target="_blank" rel="external">cluster operations</a></p>
<p><a href="https://docs.ceph.com/docs/master/rados/operations/data-placement/" target="_blank" rel="external">data placement</a></p>
<ul>
<li><p>pools, which are logical groups for storing objects</p>
</li>
<li><p>Placement Groups(PG), PGs are fragments of a logical object pool</p>
</li>
<li><p>CRUSH maps, provide the physical topology of the cluster to the CRUSH algorithm to determine where the data for an object and its replicas should be stored, and how to do so across failure domains for added data safety among other things.</p>
</li>
<li><p>Balancer, a feature that will automatically optimize the distribution of PGs across devices to achieve a balanced data distribution</p>
</li>
</ul>
<h3 id="Librados-APIs-workflow"><a href="#Librados-APIs-workflow" class="headerlink" title="Librados APIs workflow"></a>Librados APIs workflow</h3><p>apis can interact with: Ceph monitor as well as OSD.</p>
<ul>
<li><a href="https://docs.ceph.com/docs/master/rados/api/librados-intro/" target="_blank" rel="external">get libs</a></li>
</ul>
<h4 id="configure-a-cluster-handling"><a href="#configure-a-cluster-handling" class="headerlink" title="configure a cluster handling"></a>configure a cluster handling</h4><ul>
<li>the client app must invoke <code>librados</code> and connected to a Ceph Monitor</li>
<li>librados retrieves the cluster map </li>
<li>when the client app wants to read or write data, it creates an I/O context and bind to a pool</li>
<li>with the I/O context, the client provides the object name to <code>librados</code>, for locating the data. </li>
<li>then the client application can read or write data</li>
</ul>
<p>Thus, the first steps in using the cluster from your app are to 1) create a cluster handle that your app will use to connect to the storage cluster, and then 2) use that handle to connect. To connect to the cluster, the app must supply a monitor address, a username and an authentication key (cephx is enabled by defaul</p>
<p>an easy way, in Ceph configuration file:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[global]</div><div class="line">mon host = 192.168.0.1</div><div class="line">keyring = /etc/ceph/ceph.client.admin.keyring</div></pre></td></tr></table></figure>
<p><img src="https://docs.ceph.com/docs/master/_images/ditaa-bd1070de50515485f116a874684956bc7e26c664.png" alt="image"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> rados</div><div class="line"></div><div class="line"><span class="keyword">try</span>:</div><div class="line">        cluster = rados.Rados(conffile=<span class="string">''</span>)</div><div class="line"><span class="keyword">except</span> TypeError <span class="keyword">as</span> e:</div><div class="line">        <span class="keyword">print</span> <span class="string">'Argument validation error: '</span>, e</div><div class="line">        <span class="keyword">raise</span> e</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"Created cluster handle."</span></div><div class="line"></div><div class="line"><span class="keyword">try</span>:</div><div class="line">        cluster.connect()</div><div class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">        <span class="keyword">print</span> <span class="string">"connection error: "</span>, e</div><div class="line">        <span class="keyword">raise</span> e</div><div class="line"><span class="keyword">finally</span>:</div><div class="line">        <span class="keyword">print</span> <span class="string">"Connected to the cluster."</span></div></pre></td></tr></table></figure>
<p>python api, has default <code>admin</code> as id, <code>ceph</code> as cluster name, and <code>ceph.conf</code> as confffile value</p>
<h4 id="creating-an-I-O-context"><a href="#creating-an-I-O-context" class="headerlink" title="creating an I/O context"></a>creating an I/O context</h4><p>RADOS enables you to interact both synchronously and asynchronously. Once your app has an I/O Context, read/write operations only require you to know the object/xattr name. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">print</span> <span class="string">"\n\nI/O Context and Object Operations"</span></div><div class="line"><span class="keyword">print</span> <span class="string">"================================="</span></div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"\nCreating a context for the 'data' pool"</span></div><div class="line"><span class="keyword">if</span> <span class="keyword">not</span> cluster.pool_exists(<span class="string">'data'</span>):</div><div class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">'No data pool exists'</span>)</div><div class="line">ioctx = cluster.open_ioctx(<span class="string">'data'</span>)</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"\nWriting object 'hw' with contents 'Hello World!' to pool 'data'."</span></div><div class="line">ioctx.write(<span class="string">"hw"</span>, <span class="string">"Hello World!"</span>)</div><div class="line"><span class="keyword">print</span> <span class="string">"Writing XATTR 'lang' with value 'en_US' to object 'hw'"</span></div><div class="line">ioctx.set_xattr(<span class="string">"hw"</span>, <span class="string">"lang"</span>, <span class="string">"en_US"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"\nWriting object 'bm' with contents 'Bonjour tout le monde!' to pool 'data'."</span></div><div class="line">ioctx.write(<span class="string">"bm"</span>, <span class="string">"Bonjour tout le monde!"</span>)</div><div class="line"><span class="keyword">print</span> <span class="string">"Writing XATTR 'lang' with value 'fr_FR' to object 'bm'"</span></div><div class="line">ioctx.set_xattr(<span class="string">"bm"</span>, <span class="string">"lang"</span>, <span class="string">"fr_FR"</span>)</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"\nContents of object 'hw'\n------------------------"</span></div><div class="line"><span class="keyword">print</span> ioctx.read(<span class="string">"hw"</span>)</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"\n\nGetting XATTR 'lang' from object 'hw'"</span></div><div class="line"><span class="keyword">print</span> ioctx.get_xattr(<span class="string">"hw"</span>, <span class="string">"lang"</span>)</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"\nContents of object 'bm'\n------------------------"</span></div><div class="line"><span class="keyword">print</span> ioctx.read(<span class="string">"bm"</span>)</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"Getting XATTR 'lang' from object 'bm'"</span></div><div class="line"><span class="keyword">print</span> ioctx.get_xattr(<span class="string">"bm"</span>, <span class="string">"lang"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"\nRemoving object 'hw'"</span></div><div class="line">ioctx.remove_object(<span class="string">"hw"</span>)</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"Removing object 'bm'"</span></div><div class="line">ioctx.remove_object(<span class="string">"bm"</span>)</div></pre></td></tr></table></figure>
<h4 id="closing-sessions"><a href="#closing-sessions" class="headerlink" title="closing sessions"></a>closing sessions</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">print</span> <span class="string">"\nClosing the connection."</span></div><div class="line">ioctx.close()</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"Shutting down the handle."</span></div><div class="line">cluster.shutdown()</div></pre></td></tr></table></figure>
<h3 id="librados-in-Python"><a href="#librados-in-Python" class="headerlink" title="librados in Python"></a><a href="https://docs.ceph.com/docs/master/rados/api/python/" target="_blank" rel="external">librados in Python</a></h3><h4 id="data-level-operations"><a href="#data-level-operations" class="headerlink" title="data level operations"></a>data level operations</h4><ul>
<li>configure a cluster handle</li>
</ul>
<p>To connect to the Ceph Storage Cluster, your application needs to know where to find the Ceph Monitor. Provide this information to your application by specifying the path to your Ceph configuration file, which contains the location of the initial Ceph monitors.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> rados, sys</div><div class="line">cluster = rados.Rados(conffile=<span class="string">'ceph.conf'</span>)</div></pre></td></tr></table></figure>
<ul>
<li>connect to the cluster </li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">cluster.connect()</div><div class="line"><span class="keyword">print</span> <span class="string">"\nCluster ID: "</span> + cluster.get_fsid()</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"\n\nCluster Statistics"</span></div><div class="line"><span class="keyword">print</span> <span class="string">"=================="</span></div><div class="line">cluster_stats = cluster.get_cluster_stats()</div><div class="line"></div><div class="line"><span class="keyword">for</span> key, value <span class="keyword">in</span> cluster_stats.iteritems():</div><div class="line">        <span class="keyword">print</span> key, value</div></pre></td></tr></table></figure>
<ul>
<li>manage pools </li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">cluster.create_pool(<span class="string">'test'</span>)</div><div class="line">pools = cluster.list_pools()</div><div class="line"><span class="keyword">for</span> pool <span class="keyword">in</span> pools:</div><div class="line">        <span class="keyword">print</span> pool</div><div class="line">cluster.delete_pool(<span class="string">'test'</span>)</div></pre></td></tr></table></figure>
<ul>
<li>I/O context </li>
</ul>
<p>to read from or write to Ceph Storage cluster, requires ioctx.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ioctx = cluster.open_ioctx($ioctx_name)</div><div class="line"><span class="comment">#</span></div><div class="line">ioctx = cluster.open_ioctx2($pool_id)</div></pre></td></tr></table></figure>
<p><code>ioctx_name</code> is the name of the pool, <code>pool_id</code> is the ID of the pool</p>
<ul>
<li>read, write, remove objects </li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ioctx.write_full(<span class="string">"hw"</span>, <span class="string">"hello"</span>)</div><div class="line">ioctx.read(<span class="string">"hw"</span>)</div><div class="line">ioctx.remove_object(<span class="string">"hw"</span>)</div></pre></td></tr></table></figure>
<ul>
<li>with extended attris</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">ioctx.set_xattr(<span class="string">"hw"</span>, <span class="string">"lang"</span> <span class="string">"en_US"</span>)</div><div class="line">ioctx.get_xattr(<span class="string">"hw"</span>, <span class="string">"lang"</span>)</div><div class="line"></div><div class="line">``` </div><div class="line"></div><div class="line">* list objs </div><div class="line"></div><div class="line">```python </div><div class="line"></div><div class="line">obj_itr = ioctx.list_objects()</div><div class="line"></div><div class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">	<span class="keyword">try</span>:</div><div class="line">		rados_obj = obj_itr.next()</div><div class="line">		print(rados_obj.read())</div></pre></td></tr></table></figure>
<h4 id="RADOS-S3-api"><a href="#RADOS-S3-api" class="headerlink" title="RADOS S3 api"></a>RADOS S3 api</h4><p>Ceph supports <a href="https://docs.ceph.com/docs/dumpling/radosgw/s3/" target="_blank" rel="external">RESTful API</a> that is compatible with basic data access model of Amazon S3 api.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">PUT /&#123;bucket&#125;/&#123;object&#125; HTTP/1.1</div><div class="line">DELETE /&#123;bucket&#125;/&#123;object&#125; HTTP/1.1</div><div class="line">GET /&#123;bucket&#125;/&#123;object&#125; HTTP/1.1</div><div class="line">HEAD /&#123;bucket&#125;/&#123;object&#125; HTTP/1.1  //get object info </div><div class="line">GET /&#123;bucket&#125;/&#123;object&#125;?acl HTTP/1.1</div></pre></td></tr></table></figure>
<h2 id="Amazon-S3"><a href="#Amazon-S3" class="headerlink" title="Amazon S3"></a>Amazon S3</h2><p>Simple Storage Serivce(s3) is used as file/object storage system to store and share files across Internet. it can store any type of objects, with simple key-value. elastic computing cluster(ec2) is Amazon’s computing service. there are three class in S3: servivce, bucket, object.</p>
<p>there are two ways to access S3, through SDK(boto), or raw  Restful API(GET, PUT). the following is SDK way.</p>
<h4 id="create-a-bucket"><a href="#create-a-bucket" class="headerlink" title="create a bucket"></a>create a bucket</h4><p>Put(), Get(), return all objects in the bucket. <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/s3-example-creating-buckets.html" target="_blank" rel="external">Bucket</a> is a storage location to hold files(objects). </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_bucket</span><span class="params">(bucket_name, region=None)</span>:</span></div><div class="line">	<span class="keyword">try</span>:</div><div class="line">		<span class="keyword">if</span> region <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">			s3_client = boto3.client(<span class="string">'s3'</span>)</div><div class="line">			s3.client.create_bucket(Bucket=bucket_name)</div><div class="line">		<span class="keyword">else</span>:</div><div class="line">            s3_client = boto3.client(<span class="string">'s3'</span>, region_name=region)</div><div class="line">            location = &#123;<span class="string">'LocationConstraint'</span>: region&#125;</div><div class="line">            s3_client.create_bucket(Bucket=bucket_name,</div><div class="line">            CreateBucketConfiguration=location)</div><div class="line">    <span class="keyword">except</span> ClientError <span class="keyword">as</span> e:</div><div class="line">        logging.error(e)</div><div class="line">        <span class="keyword">return</span> <span class="keyword">False</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">True</span>			</div><div class="line"></div><div class="line">response = s3_client.list_buckets()</div><div class="line"><span class="keyword">for</span> bucket <span class="keyword">in</span> response[<span class="string">'Buckets'</span>]:</div><div class="line">	<span class="keyword">print</span> bucket</div></pre></td></tr></table></figure>
<h4 id="upload-files"><a href="#upload-files" class="headerlink" title="upload files"></a>upload files</h4><p>basically to <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/s3-uploading-files.html" target="_blank" rel="external">upload a file</a> to an S3 bucket. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_file</span><span class="params">(file_name, bucket, object_name=None)</span>:</span></div><div class="line">    <span class="keyword">if</span> object_name <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">        object_name = file_name</div><div class="line"></div><div class="line">    <span class="comment"># Upload the file</span></div><div class="line">    s3_client = boto3.client(<span class="string">'s3'</span>)</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        response = s3_client.upload_file(file_name, bucket, object_name)</div><div class="line">    <span class="keyword">except</span> ClientError <span class="keyword">as</span> e:</div><div class="line">        logging.error(e)</div><div class="line">        <span class="keyword">return</span> <span class="keyword">False</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">True</span></div></pre></td></tr></table></figure>
<p><code>upload_file()</code> handles large files by splitting them into smaller chunks and uploading each chunk in parallel. which is same logic as ceph to hide the lower-level detail of data splitting and transfering.</p>
<p><code>upload_fileobj()</code> accepts a readable file-like object, which should be openedin bin mode, not text mode:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">s3 = boto3.client(<span class="string">'s3'</span>)</div><div class="line"><span class="keyword">with</span> open(<span class="string">"FILE_NAME"</span>, <span class="string">"rb"</span>) <span class="keyword">as</span> f:</div><div class="line">    s3.upload_fileobj(f, <span class="string">"BUCKET_NAME"</span>, <span class="string">"OBJECT_NAME"</span>)</div></pre></td></tr></table></figure>
<p>all <code>Client</code>, <code>Bucket</code> and <code>Object</code> have these two methods. </p>
<h4 id="download-files"><a href="#download-files" class="headerlink" title="download files"></a>download files</h4><p><a href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/s3-example-download-file.html" target="_blank" rel="external">download_file()</a> a pair of upload files method, which accepts the names of bucket and object to download, and the filename to save the downloaded file to.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">s3 = boto3.client(<span class="string">'s3'</span>)</div><div class="line">s3.download_file(<span class="string">'BUCKET_NAME'</span>, <span class="string">'OBJECT_NAME'</span>, <span class="string">'FILE_NAME'</span>)</div></pre></td></tr></table></figure>
<p>same as upload file, there is a read-only open method: <code>download_fileobj()</code>.</p>
<h4 id="bucket-policy"><a href="#bucket-policy" class="headerlink" title="bucket policy"></a>bucket policy</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">s3 = boto3.client(<span class="string">'s3'</span>)</div><div class="line">result = s3.get_bucket_policy(Bucket=<span class="string">'BUCKET_NAME'</span>)</div><div class="line">bucket_policy = json.dumps(bucket_policy)</div><div class="line">s3.put_bucket_policy(Bucket=bucket_name, Policy=bucket_policy)</div><div class="line">s3.delete_bucket_policy(Bucket=<span class="string">'BUCKET_NAME'</span>)</div><div class="line">control_list = s3.get_bucket_acl(Bucket=<span class="string">'BUCKEET_NAME'</span>)</div></pre></td></tr></table></figure>
<h4 id="get-objects"><a href="#get-objects" class="headerlink" title="get objects"></a>get objects</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">obj_list = s3.list_objects(Bucket=<span class="string">'bucket_name'</span>)</div><div class="line">obj_cont = s3.get_object(Bucket=<span class="string">'bucket_name'</span>, Key=<span class="string">'file_key'</span>)</div></pre></td></tr></table></figure>
<p>error: botocore.errorfactory.NoSuchKey: An error occurred (NoSuchKey) when calling the GetObject operation: Unknown</p>
<h4 id="read-objects-through-url-restful-api"><a href="#read-objects-through-url-restful-api" class="headerlink" title="read objects through url (restful api)"></a>read objects through url (restful api)</h4><p>through url path to get a file/object: <code>https://&lt;bucket-name&gt;.s3.amazonaws.com/&lt;key&gt;</code></p>
<h4 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h4><p><a href="https://docs.ceph.com/docs/master/start/intro/" target="_blank" rel="external">ceph official doc</a></p>
<p><a href="https://botocore.amazonaws.com/v1/documentation/api/latest/index.html" target="_blank" rel="external">botocore official doc</a></p>
<p><a href="https://github.com/boto/boto3" target="_blank" rel="external">boto3 github</a></p>
<p><a href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/s3-examples.html" target="_blank" rel="external">amazon S3 example</a></p>
<p><a href="https://www.howtoforge.com/how-to-create-an-s3-bucket-object-storage-on-amazon-aws/" target="_blank" rel="external">GUI: create an S3 bucket and store objects in AWS</a></p>
<p><a href="https://www.cnblogs.com/junneyang/p/5980286.html" target="_blank" rel="external">boto API access S3 object</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/27/from-HPC-to-cloud-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/27/from-HPC-to-cloud-2/" itemprop="url">from HPC to cloud (2) - distributed storage intro</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-27T05:21:54-05:00">
                2020-02-27
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/02/27/from-HPC-to-cloud-2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/02/27/from-HPC-to-cloud-2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="常见分布式存储"><a href="#常见分布式存储" class="headerlink" title="常见分布式存储"></a>常见分布式存储</h2><h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><ul>
<li><a href="https://blog.csdn.net/zds05/article/details/79494870" target="_blank" rel="external">块存储 vs 文件存储</a></li>
</ul>
<p>文件存储读写慢，利于共享；块存储读写快，不利于共享。所有磁盘阵列都是基于Block块的模式，而所有的NAS产品都是文件级存储。物理块与文件系统之间的映射关系：扇区→物理块→逻辑块→文件系统。所以，文件级备份，需要一层一层往下查找，最后才能完成整个文件复制。</p>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/39305618" target="_blank" rel="external">对象存储 vs 块存储</a></li>
</ul>
<p>富含元数据的对象存储使大规模分析成为企业的有吸引力的命题。对象存储也使得提供和管理跨越地理位置的存储变得相对经济。同时，块存储的属性使其成为高性能业务应用程序、事务数据库和虚拟机的理想选择，这些应用程序需要低延迟、细粒度的数据访问和一致的性能。块存储(云盘)只能被一个主机挂载。</p>
<ul>
<li><a href="https://caden16.github.io/对象存储/对象存储VS文件系统/" target="_blank" rel="external">文件存储 vs  对象存储</a></li>
</ul>
<p>对象存储(ceph, Linux block device)和文件系统(hdfs, gfs, restful Web API)在接口上的本质区别是对象存储不支持fread(), fwrite()类似的随机位置读写操作，即一个文件PUT到对象存储里以后，如果要读取，只能GET整个文件，如果要修改一个对象，只能重新PUT一个新的到对象存储里，覆盖之前的对象或者形成一个新的版本。对象存储的接口是REST风格的，通常是基于HTTP协议的RESTful Web API，通过HTTP请求中的PUT和GET等操作进行文件的上传即写入和下载即读取，通过DELETE操作删除文件。文件存储读写api如，file.open(); 对象存储读写api如 s3.open()。文件存储，多次读写；对象存储，一次写，多次读。对象存储的容量是无上限的；文件存储的容量达到一定上限，性能会极差。</p>
<p>对象存储，需要对原数据做解析吗？ </p>
<h4 id="存储类型"><a href="#存储类型" class="headerlink" title="存储类型"></a>存储类型</h4><ul>
<li><p>块存储<br>Direct Attach Storage(DAS), 每台主机服务器有独立的存储设备，各存储设备之间无法互通，需要跨主机存取。 Storage Area Network(SAN), 高速网络连接的专业存储服务器，与主机群通过高速i/o连结。</p>
</li>
<li><p>文件存储<br>Network Attached Storage(NAS), 连接在网络上并提供存取服务。采用NFS或CIFS命令集访问数据，以文件为传输协议，通过TCP/IP实现网络化存储，可扩展性好、价格便宜、用户易管理</p>
</li>
<li><p>对象存储<br>核心是将数据通路（数据读或写）和控制通路（元数据）分离，并且基于对象存储设备（Object-based Storage Device，OSD）构建存储系统。对象存储设备具有一定的智能，它有自己的CPU、内存、网络和磁盘系统. 一般配置metadata server(MDS)。</p>
</li>
</ul>
<h4 id="存储用例"><a href="#存储用例" class="headerlink" title="存储用例"></a>存储用例</h4><ul>
<li><p>对象存储<br>非结构化(文档、图像、视频等)、备份存档、大数据分析（无实时性）</p>
</li>
<li><p>块存储<br>比较适合数据库业务、虚拟机</p>
</li>
<li><p>文件存储<br><a href="https://cloud.tencent.com/document/product/582/9129" target="_blank" rel="external">企业共享</a>、hpc大数据分析、流媒体处理，web服务。</p>
</li>
</ul>
<h2 id="容器云"><a href="#容器云" class="headerlink" title="容器云"></a>容器云</h2><h4 id="容器云架构"><a href="#容器云架构" class="headerlink" title="容器云架构"></a>容器云架构</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">控制台门户(管理员入口）</div><div class="line">saas(）</div><div class="line">paas(容器，微服务、中间件、cicd)</div><div class="line">资源调度管理平台</div><div class="line">iaas(计算、存储、网络），虚拟化提供资源池，</div></pre></td></tr></table></figure>
<ul>
<li>物理机直接架构k8s </li>
</ul>
<p>容器云与私有云搭建的硬件资源分开。</p>
<ul>
<li>虚拟层上支持k8s</li>
</ul>
<p>容器部署在虚拟机上的原因：既需要容器，也需要虚拟机的环境。一般互联网公司倾向分开容器的资源 和  虚拟机的资源。不管是容器云，还是虚拟机，都会有一个web管理平台。考虑弹性升缩，vm更灵活。而如果容器直接部署在x86裸机上，如果没有容器的管理层，docker容器挂了，就无法恢复。</p>
<h4 id="应用部署容器云-vs-私有云"><a href="#应用部署容器云-vs-私有云" class="headerlink" title="应用部署容器云 vs 私有云"></a>应用部署容器云 vs 私有云</h4><ul>
<li><p>仿真计算，倾向容器环境</p>
</li>
<li><p>CI/CD开发工具、中间件，倾向容器环境</p>
</li>
<li><p>web server，倾向容器环境</p>
</li>
<li><p>sql，倾向物理机或虚拟机 </p>
</li>
</ul>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="">KingStack</a></p>
<p><a href="">UCloud</a></p>
<p><a href="">EasyStack</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/25/from-HPC-to-cloud-computing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/25/from-HPC-to-cloud-computing/" itemprop="url">from HPC to cloud computing</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-25T03:13:09-05:00">
                2020-02-25
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/02/25/from-HPC-to-cloud-computing/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/02/25/from-HPC-to-cloud-computing/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="HPC"><a href="#HPC" class="headerlink" title="HPC"></a>HPC</h3><p><a href="https://www.ansys.com/products/platform/ansys-cloud" target="_blank" rel="external">Ansys HPC</a>, <a href="https://www.designworldonline.com/cae-on-the-cloud/" target="_blank" rel="external">OpenFoam in amazon EC2</a>, <a href="https://www.rescale.com" target="_blank" rel="external">rescale</a>, these are some samples of current CAE applications in HPC cloud.</p>
<p>most CAE simulations, in nut, are solving large sparse matrix, either optmization or differential, which depends on famous linear equations solvers/libs, e.g. Petsc, libMesh, Intel Math Kernel e.t.c, inside which are implemented with message passing interface(MPI), share memory, or similar techs. </p>
<p>why MPI is a have-to in these applications? because the problem  interested itself is so huge, which is so much computing heavily than windows office, WeChat. </p>
<p>as engineers want the result more preciesly, the problem interested dimension will increase more. e.g. a normal static stress analysis of vehicle engine is about 6 million elements, each of which will take  6 ~ 12 vertexes, and each vertex has 6 DoF, which gives about <strong>a kinematic matrix with size about 200 million x 200 million</strong>, no single PC can store this much data, and not even to do the matrix computing then.</p>
<p>so all these problems have to be running on super computers, or high-performance computer(HPC), which have more memory or CPU cores. beyond large memory and CPU cores, also need fast-speed network, as each CPU can do calculation really fast, 2 ~ 4 GHz, so if the system can’t feed data that fast, the CPUs are hungry, which is the third feature of HPC: Gb high-speed internal network.</p>
<p>as the <strong>NUMA/multi-core CPU architecture</strong> is popular now, to achieve the best performance from these chips is also a hot topic. </p>
<h3 id="cloud"><a href="#cloud" class="headerlink" title="cloud"></a>cloud</h3><p>if taken HPC as centerlized memory and CPU cores(<strong>the Cathedral</strong>), then cloud is about distributed memory and CPU cores(<strong>the Bazaar</strong>). cloud is more Internet, to connected weak-power nodes anywhere, but totally has great power. the applications in cloud must be easy to decomposed in small pieces, so each weak-power node can handle a little bit. when coming to cloud computing, I’d think about Hadoop, OpenStack, and docker.</p>
<p>hadoop is about to analysis massive data, which is heavily used in e-commercial, social network, games. docker is the way to package small application and each of the small image can run smoothly in one node, which currently is call <strong>micro-serivce</strong>, which is exactly as the name said, MICRO. OpenStack take care virtualization layer from physical memory, cpu resources, which used about in public cloud, or virtual office env.</p>
<h3 id="A-or-B"><a href="#A-or-B" class="headerlink" title="A or B"></a>A or B</h3><p>cloud is more about <strong>DevOps</strong>, as each piece of work is not difference from the single PC, but how to deploy and manage a single piece of work in a large cloud is the key, so develop and operations together. compare to HPC, both develop and operation needs professions.</p>
<p>cloud computing has extended to edge computing, which is more close to normal daily life, and more bussiness-valued; while HPC guys are more like scientist, who do weather forcast, rocket science, molecular dynamics e.t.c.</p>
<p>finally, the tech itself, cloud or HPC, has nothing to do with the bussiness world. </p>
<h3 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h3><p><a href="http://cloudscaling.com/blog/cloud-computing/grid-cloud-hpc-whats-the-diff/" target="_blank" rel="external">cloudscaling: grid, hpc, cloud… what’s the difference</a></p>
<p><a href="https://www.linkedin.com/pulse/supercomputing-vs-cloud-computing-david-stepania/" target="_blank" rel="external">linkedin: supver computer vs cloud</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/24/mdf4-reader/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/24/mdf4-reader/" itemprop="url">mdf4 reader</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-24T23:14:52-05:00">
                2020-02-24
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/02/24/mdf4-reader/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/02/24/mdf4-reader/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="read-mdf4-in-general"><a href="#read-mdf4-in-general" class="headerlink" title="read mdf4 in general"></a>read mdf4 in general</h2><p><img src="https://www.asam.net/index.php?eID=dumpFile&amp;t=p&amp;p=2964&amp;token=90de1236917c0225cbf3bd53101a81296613d367" alt="image"></p>
<p>the most important “branch” in the tree is the list of data groups (DG block).</p>
<p><strong>record</strong> used to store the plain measurement data, the records can either be contianed in one single “data” (DT) block, or distributed over several DT blocks using a “data list” block . </p>
<p>Each DG block has points to the data block, as well as necessary information to understand and decode the data.</p>
<p>the sub-tree of DG is channel group(CG) blocks and channel(CN) blocks. </p>
<h5 id="record-layout"><a href="#record-layout" class="headerlink" title="record layout"></a>record layout</h5><p>each record contains all signal values which have the same time stamp, in the same channel. for different channel groups(CG), each record must start with a “record id”</p>
<p><img src="https://www.asam.net/index.php?eID=dumpFile&amp;t=f&amp;f=195&amp;token=cb0391ba3e0fb5ee7fb91c9f4b8307e45e1e8f08" alt="image"></p>
<p>the record layout of ID 1, will be described by one channel group, the record layout of ID 2 by another channel group. Both channel groups must be children of the DT block’s parent data group.</p>
<h4 id="channels"><a href="#channels" class="headerlink" title="channels"></a>channels</h4><p>Each channel describes a recorded signal and how its values are encoded in the records for the channel’s parent CG block.</p>
<h2 id="vector-APIs"><a href="#vector-APIs" class="headerlink" title="vector APIs"></a>vector APIs</h2><p>which is licensed by <a href="https://www.vector.com/int/en/products/application-areas/ecu-calibration/measurement/mdf/" target="_blank" rel="external">vector</a></p>
<ul>
<li>GetFileManager()</li>
<li>OpenFile()</li>
<li>GetChannelByName()</li>
<li>GetChannelGroup()</li>
<li>CreaterDataPointer()</li>
<li>GetRecordCount()</li>
<li>SetReadMode()</li>
<li>SeekPos()</li>
<li>GetPos()</li>
<li>GetTimeSec()</li>
<li>ReadPhysValueDouble(pChannle, &amp;value, &amp;isvalid)</li>
<li>ReadRawValueDouble(pChannel, &amp;rawValue)</li>
<li>ReadPhysValueDouble(pChannel, &amp;phyValue)</li>
<li>MultiReadPhysValueDouble(pChannel, valueBuffer, size, &amp;read)</li>
</ul>
<h2 id="turbolab"><a href="#turbolab" class="headerlink" title="turbolab"></a><a href="https://www.turbolab.de/mdf_libf.htm" target="_blank" rel="external">turbolab</a></h2><p>ReadFileMF4 class:</p>
<ul>
<li>Open()</li>
<li>Seek(pos)</li>
<li>Read(Size, Buffer)</li>
<li>Close()</li>
</ul>
<p>CMdf4Calc class :</p>
<ul>
<li>Cmdf4Calc(pChan, pblock)</li>
<li>Cmdf4Calc(pChan, mf4file)</li>
</ul>
<p>cmf4DataGroup class:</p>
<ul>
<li>GetRecord()</li>
<li>GetRawValueFromRecord()</li>
<li>GetValueFromRecord()</li>
</ul>
<p>mdf4FileImport class :</p>
<ul>
<li>ImportFile()</li>
<li>ReleaseFile()</li>
</ul>
<p>I am not reading this C++ code. </p>
<h2 id="asammdf"><a href="#asammdf" class="headerlink" title="asammdf"></a><a href="https://github.com/danielhrisca/asammdf" target="_blank" rel="external">asammdf</a></h2><h3 id="MDF-class"><a href="#MDF-class" class="headerlink" title="MDF class"></a>MDF class</h3><ul>
<li><strong>init</strong>(name=None, ): name can be either <code>string</code> or <code>BytesIO</code></li>
<li>filter(channels, ) </li>
<li>get_group(index, channels=None, )</li>
<li>iter_channels(,)</li>
<li>iter_get(channel_name=None,group_id=None, group_index=None, )</li>
<li>iter_groups()</li>
<li>to_dataframe(), generate pandas DataFrame</li>
<li>whereis(channel_name)</li>
</ul>
<h3 id="MDF4-class"><a href="#MDF4-class" class="headerlink" title="MDF4 class"></a>MDF4 class</h3><p>includes <code>data_group</code>, <code>channel_group</code>, <code>channels</code>, <code>data_block</code>, <code>data_location</code>, <code>record_size</code> e.t.c</p>
<ul>
<li>get(channel_name=None, group=None, )</li>
<li>get_can_signal()</li>
<li>get_channel_name(group, index)</li>
<li>get_channel_unit(channel_name=Nont, group=None, )</li>
<li>get_master(index, data=None, ), return the master channel samples for given group</li>
<li>info() </li>
</ul>
<p>the following are sub data blocks of MDF4: </p>
<ul>
<li>Channel class </li>
<li>ChannelGroup class</li>
<li>DataGroup class </li>
<li>DataList class</li>
<li>DataBlock class</li>
<li>HeaderBlock class</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mdf = MDF4(<span class="string">"basic.mf4"</span>)</div><div class="line">db_info = mdf.info()</div></pre></td></tr></table></figure>
<p>all <code>group</code>, <code>channel</code> data is packages as <code>python dict</code>. the most exciting part, as asam-mdf can support <code>BytesIO</code>, which gives the way to read mdf files stores in Amazon S3:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">    mf4_ = obj_api.get_object("bucket_name", "sample.mf4")</div><div class="line">    fid_ = io.BufferedReader(mf4_['Body']._raw_stream) ;</div><div class="line">    read_in_memory = fid_.read()</div><div class="line">    bio_ = io.BytesIO(read_in_memory);</div><div class="line">    if bio_.seekable(): </div><div class="line">        mdf_ = MDF(bio_)</div><div class="line">        mdf_.info()</div><div class="line">``` </div><div class="line"></div><div class="line">### installation of asam-mdf</div><div class="line"></div><div class="line">* [install pandas](https://www.pypandas.cn/en/docs/installation.html#installing-using-your-linux-distribution’s-package-manager)</div><div class="line"></div><div class="line">`python3 -m pip install pandas` (not working)</div><div class="line"></div><div class="line">`sudo apt-get install python3-pandas` </div><div class="line"></div><div class="line">* [install canmatrix](https://canmatrix.readthedocs.io/en/latest/installation.html)</div><div class="line"></div><div class="line">`sudo python3 setup.py install` </div><div class="line"></div><div class="line">* install pathlib2 </div><div class="line"></div><div class="line">`sudo -H pip3 install pathlib2 `</div><div class="line"></div><div class="line">if `WARNING: pip is being invoked by an old script wrapper. This will fail in a future version of pip.`</div><div class="line">using: `sudo -H python3 -m pip install（包名）`</div><div class="line"></div><div class="line"></div><div class="line">## [mdfreader](https://github.com/ratal/mdfreader)</div><div class="line"></div><div class="line">which is open source LSP licensed. and the APIs are clear about getChannels, and read data from each channel, which was my first choice. but later found out it's difficult to support streamIO input, which was the best format I can reached from Amazon S3 pipeline.</div><div class="line"></div><div class="line"></div><div class="line">##### MdfInfo</div><div class="line"></div><div class="line">* read_info()</div><div class="line">* list_channels()</div><div class="line"></div><div class="line">##### Mdf</div><div class="line"></div><div class="line">* read()</div><div class="line">* filter_channel_names()</div><div class="line">* get_channel_data()</div><div class="line">* get_channel_unit()</div><div class="line">* keep_channels()</div><div class="line"></div><div class="line">```python</div><div class="line">import mdfreader</div><div class="line">filename="basic.mf4"</div><div class="line">file_info=mdfreader.MdfInfo()</div><div class="line">channels = file_info.list_channels(filename)</div><div class="line">print(channels)</div><div class="line">file_pointer = mdfreader.Mdf(filename)</div><div class="line">keys_ = file_pointer.keys()</div><div class="line">for k_ in keys_:</div><div class="line">    chan1 = file_pointer.get_channel_data(k_)</div><div class="line">    print(chan1)</div></pre></td></tr></table></figure>
<h2 id="python-necessary"><a href="#python-necessary" class="headerlink" title="python necessary"></a>python necessary</h2><h3 id="buffered-io"><a href="#buffered-io" class="headerlink" title="buffered io"></a>buffered io</h3><p><a href="https://docs.python.org/zh-cn/3/library/io.html" target="_blank" rel="external">binary I/O</a>, usually used in following: </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">f = open(<span class="string">"mdf_file"</span>, <span class="string">"rb"</span>)</div><div class="line">type(f)</div><div class="line">&lt;type <span class="string">'_io.BufferedReader'</span>&gt;</div></pre></td></tr></table></figure>
<p><strong>open(file, mode=’r’, buffering=-1, encoding=…)</strong></p>
<p>if<code>mode=&#39;b&#39;</code>, the returned content is bytes object, can’t encoding. if <code>buffereing</code> is not setted, for binary file with buffering with a fixed length. when with <code>mode=&#39;w/r/t</code>, it returns <code>io.TextIOwrapper</code>, if <code>mode=rb</code>, it returns <code>io.BufferedReader</code>, else if <code>mode=wb</code>, it returns <code>io.BufferedWriter</code>, else <code>mode=wrb</code>, it returns <code>io.BufferedRandom</code>. <a href="https://docs.python.org/zh-cn/3/library/functions.html#open" target="_blank" rel="external">check here</a></p>
<h4 id="dict-built-in-funs"><a href="#dict-built-in-funs" class="headerlink" title="dict built-in funs"></a>dict built-in funs</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">cmp(dict1, dict2) ;</div><div class="line">len(dict)</div><div class="line">str(dict)</div><div class="line">dict.clear()</div><div class="line">dict.get(key)</div><div class="line">dict.has_key(key)</div><div class="line">dict.items()</div><div class="line">dict.keys()</div><div class="line">dict.values()</div><div class="line">pop(key)</div></pre></td></tr></table></figure>
<h2 id="a-bit-about-readers"><a href="#a-bit-about-readers" class="headerlink" title="a bit about readers"></a>a bit about readers</h2><p>a few years ago I was in CAE field, dealing with different kind of CAE format, e.g .nas. during that time, there is a similar need to have a file transfer from vendor specified format to python format e.t.c. </p>
<p>so now it comes again, which is funny to know adapters in CAE and autonomous driving design.</p>
<h2 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h2><p><a href="https://asammdf.readthedocs.io/en/master/api.html#mdf4" target="_blank" rel="external">asammdf API doc</a></p>
<p><a href="https://www.asam.net/standards/detail/mdf/wiki/" target="_blank" rel="external">asam mdf4 doc</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/21/gpu-rendering-in-k8s-cloud/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/21/gpu-rendering-in-k8s-cloud/" itemprop="url">gpu rendering in k8s cloud</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-21T01:48:05-05:00">
                2020-02-21
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/02/21/gpu-rendering-in-k8s-cloud/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/02/21/gpu-rendering-in-k8s-cloud/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="background"><a href="#background" class="headerlink" title="background"></a>background</h2><p>to deploy simulation in docker swarm, there is a hurting that GPU rendering in docker requires a physical monitor(as $DISPLAY env variable). which is due to GeForece(Quadro 2000) GPUs, for Tesla GPUs there is no depends on monitor. really intertesting to know.</p>
<p>there were two thoughts how to deploy simulation rendering in cloud, either a gpu rendering cluster, or a headless mode in container cluster.</p>
<h2 id="unity-rendering"><a href="#unity-rendering" class="headerlink" title="unity rendering"></a>unity rendering</h2><p><a href="https://www.cnblogs.com/alan777/p/6204759.html" target="_blank" rel="external">unity rendering pipeline</a> is as following ：</p>
<ul>
<li><p>CPU calculate what need to draw and how to draw</p>
</li>
<li><p>CPU send commands to GPU</p>
</li>
<li><p>GPU plot </p>
</li>
</ul>
<h4 id="direct-rendering"><a href="#direct-rendering" class="headerlink" title="direct rendering"></a>direct rendering</h4><p><a href="https://unix.stackexchange.com/questions/319052/remote-direct-rendering-for-glx-opengl" target="_blank" rel="external">for remote direct rendering for GLX/openGL</a>, Direct rendering will be done on the X client (the remote machine), then rendering results will be transferred to X server for display. Indirect rendering will transmit GL commands to the X server, where those commands will be rendered using server’s hardware. </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">direct rendering: Yes</div><div class="line">OpenGL vendor string: NVIDIA</div></pre></td></tr></table></figure>
<p>Direct Rendering Infrasturcture(DRI) means the 3D graphics operations are hardware acclerated, Indirect rendering is used to sya the graphics operations are all done in software.</p>
<p>DRI enable to communicate directly with gpus, instead of sending graphics data through X server, resulting in 10x faster than going through X server </p>
<p>for performance, mostly the games/video use direct rendering. </p>
<h4 id="headless-mode"><a href="#headless-mode" class="headerlink" title="headless mode"></a>headless mode</h4><p>to disable rendering, either with dummy display. there is a blog how to <a href="https://towardsdatascience.com/how-to-run-unity-on-amazon-cloud-or-without-monitor-3c10ce022639" target="_blank" rel="external">run opengl in xdummy in AWS cloud</a>; eitherwith <a href="https://github.com/Unity-Technologies/ml-agents/blob/master/docs/Using-Docker.md" target="_blank" rel="external">Unity headless mode</a>, When running in batch mode, <a href="https://answers.unity.com/questions/159079/batchmode-and-nographics.html" target="_blank" rel="external">do not initialize graphics device at all</a>. This makes it possible to run your automated workflows on machines that don’t even have a GPU. to make a game server running on linux, and use the argument “-batchmode” to make it run in headless mode. <a href="https://forum.unity.com/threads/linux-nographics-support.152916/" target="_blank" rel="external">Linux -nographics support</a> <code>-batchmode</code> is normally the headless flag that works without gpu and audio hw acceleration</p>
<h2 id="GPU-container"><a href="#GPU-container" class="headerlink" title="GPU container"></a>GPU container</h2><p>a gpu containeris needs to map NVIDIA driver from host to the container, which is now done by <code>nvidia-docker</code>; the other issue is gpu-based app usually has its own (runtime) libs, which needs to install in the containers. e.g. CUDA, deep learning libs, OpengGL/vulkan libs. </p>
<p><img src="https://static001.infoq.cn/resource/image/25/66/2597b690685978c9a780aa93d6c7c266.png" alt="image"></p>
<h4 id="k8s-device-plugin"><a href="#k8s-device-plugin" class="headerlink" title="k8s device plugin"></a>k8s device plugin</h4><p>k8s has default <code>device plugin</code> model to support gpu, fpga e.t.c devices, but it’s in progress, nvidia has <a href="https://github.com/NVIDIA/k8s-device-plugin" target="_blank" rel="external">a branch</a> to support gpu as device plugin in k8s. </p>
<h4 id="nvidia-docker-mechanism"><a href="#nvidia-docker-mechanism" class="headerlink" title="nvidia docker mechanism"></a>nvidia docker mechanism</h4><p>when application call cuda/vulkan API/libs, it further goes to cuda/vulkan runtime, which further ask operations on GPU devices.</p>
<h2 id="cloud-DevOps"><a href="#cloud-DevOps" class="headerlink" title="cloud DevOps"></a>cloud DevOps</h2><h4 id="simulation-in-cloud"><a href="#simulation-in-cloud" class="headerlink" title="simulation in cloud"></a>simulation in cloud</h4><p>so far, there are plenty of cloud simulation online, e.g. ali, tencent, huawei/octopus, Cognata. so how these products work? all of them has containerized. as our test said, only Tesla GPU is a good one for containers, especially for rendering needs; GeForce GPU requires <code>DISPLAY</code> or physical monitor to be used for rendering. </p>
<h4 id="cloud-vendors-for-carmakers"><a href="#cloud-vendors-for-carmakers" class="headerlink" title="cloud vendors for carmakers"></a>cloud vendors for carmakers</h4><p>as cloud simulation is heavily infrastructure based, OEMs and cloud suppliers are coming together:</p>
<ul>
<li>FAW -&gt; Ali cloud</li>
<li>GAC -&gt; Tencent Cloud</li>
<li>SAC -&gt; Ali cloud / fin-shine </li>
<li>Geely -&gt; Ali cloud </li>
<li>Changan -&gt; Ali cloud </li>
<li>GWM -&gt; Ali cloud </li>
<li>Xpeng, Nio (?)</li>
<li>PonyAI/WeRide (?)</li>
</ul>
<p>obviously, Ali cloud has a major benefit among carmakers, which actually give Ali cloud new industry to deep in. traditionally, carmakers doesn’t have strong DevOps team, but now there is a change.</p>
<p>we can see the changing, as connected vehicles service, sharing cars, MaaS, autonomous vehicles are more and more requring a strong DevOps team. but not the leaders in carmakers realize yet.</p>
<h4 id="fin-shine"><a href="#fin-shine" class="headerlink" title="fin-shine"></a>fin-shine</h4><p><a href="http://fin-shine.com/" target="_blank" rel="external">SAC cloud</a>, which is a great example for other carmakers to study. basically they are building the common cloud service independently.</p>
<ul>
<li>container service &lt;– k8s/docker </li>
<li>storage &lt;– hdfs/ceph</li>
<li>big data &lt;– hadoop/sql </li>
<li>middleware </li>
<li>applications &lt;– AI, simulation</li>
</ul>
<p>it’s an IP for SAC, but on the other hand, to maintain a stable and user-friendly cloud infrastructure is not easy at all. </p>
<h2 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h2><p><a href="https://github.com/rndevfx/docker-blender-render-cluster" target="_blank" rel="external">docker blender render cluster</a></p>
<p><a href="https://docs.nvidia.com/ngc/ngc-vgpu-setup-guide/index.html" target="_blank" rel="external">nvidia vgpu</a></p>
<p><a href="https://engineering.bitnami.com/articles/using-gpus-with-kubernetes.html" target="_blank" rel="external">using GPUs with K8s</a></p>
<p><a href="https://docs.nvidia.com/datacenter/pdf/kubernetes-install-guide.pdf" target="_blank" rel="external">K8S on nvidia gpus</a></p>
<p><a href="https://www.harrisgeospatial.com/Support/Self-Help-Tools/Help-Articles/Help-Articles-Detail/ArtMID/10220/ArticleID/19193/OpenGL-Direct-Hardware-Rendering-on-Linux" target="_blank" rel="external">openGL direct hardware rendering on Linux</a> </p>
<p><a href="https://github.com/carla-simulator/carla/issues/1112" target="_blank" rel="external">runinng carla without display</a></p>
<p><a href="https://partiallydisassembled.net/posts/unity-headless-script.html" target="_blank" rel="external">tips for runing headless unity from a script</a></p>
<p><a href="https://forum.unity.com/threads/unity-server-instance-without-the-3d-graphics.22283/" target="_blank" rel="external">Unity Server instance without 3d graphics</a></p>
<p><a href="https://bluesmilery.github.io/blogs/afcb1072/" target="_blank" rel="external">a blog: nvidia device plugin for k8s</a></p>
<p><a href="https://www.infoq.cn/article/TDfGIikxH9bcgkNyWL6S" target="_blank" rel="external">k8s GPU manage &amp; device plugin mechanism</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/17/review-apollo-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/17/review-apollo-2/" itemprop="url">review-apollo (2).md</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-17T08:56:30-05:00">
                2020-02-17
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/02/17/review-apollo-2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/02/17/review-apollo-2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="review-apollo-2"><a href="#review-apollo-2" class="headerlink" title="review apollo (2)"></a>review apollo (2)</h1><h2 id="EMPlanner"><a href="#EMPlanner" class="headerlink" title="EMPlanner"></a>EMPlanner</h2><p><a href="">in review apollo(1)</a>, we had went through perception, prediction and part of planning module. the ADS planning problem can be summaried with a few input conditions, we can get a few drivable driving path, now <a href="https://github.com/YannZyl/Apollo-Note/blob/master/docs/planning/em_planner.md" target="_blank" rel="external">EMPlanner, here</a> need to find out the best one.</p>
<p>input conditions:</p>
<ul>
<li><p>perception and prediction obstacles and its future(in 5s) trajectory</p>
</li>
<li><p>current road status, e.g. special area, pedestrain cross e.t.c.</p>
</li>
</ul>
<p>both <code>path</code> and <code>speed</code> need to be planned or optimized. the core of EMPlanner is <a href="">Dynamic programming(DP)</a>, which is an classic algorithm to search the global optimized solution. the DP garantee each sub-group best solution accumulated to the final global best solution.</p>
<h3 id="PathOptimizer"><a href="#PathOptimizer" class="headerlink" title="PathOptimizer"></a>PathOptimizer</h3><p>the DP used in path optimizer basic processes:</p>
<p>starting from current location, in every time, move in x-direction about next n meters(to next location), and sample in y-direction at the next location, calcuate the cost from current location to each of the sampling point at the next location, and save cost value for each path for this sub path segment. (<strong>this is the different from DP to greedy algorithm</strong>), finally we retrieve all the cost values tables for each sub-path, and get the final best solution for the whole path. </p>
<p>a few question about DP here:</p>
<ul>
<li><p>how long in x-direction need to plan ?</p>
<pre><code>KMinSampleDistance = 40.0
</code></pre></li>
<li><p>what size of the interval in x-direction is good ?</p>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">step_length = math::Clamp(init_point.v() * SamplePointLookForwardTime, config_.step_length_min(), config_.step_length_max());</div></pre></td></tr></table></figure>
<ul>
<li>how many sample points in y-direction is needed ? </li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">num_sample_per_level = config_.sample_points_num_each_level();</div></pre></td></tr></table></figure>
<ul>
<li>how to sample in y-direction and x-direction ?</li>
</ul>
<p>which is case by case, depends on the ego’s maneuver as well as the lanes info.</p>
<p>basically, we had <code>RouteSegments</code>/<code>ReferenceLine</code> set, which includes the filtered referencelines for ego vehicle. for each referenceLine, we can calcuate the cost, then figure out the min cost referenceline as planning module’s output.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">EMPlanner::Plan(&amp;start_point, *frame)</div><div class="line">&#123;</div><div class="line">	foreach reference_line_info in frame-&gt;reference_line_info():</div><div class="line">		PlanOnReferenceLine();</div><div class="line">&#125;</div><div class="line"></div><div class="line">EMPlanner::PlanOnReferenceLine(start_point, frame, reference_line_info)&#123;</div><div class="line">	foreach optmizer in tasks_ :</div><div class="line">		ret = optmizer-&gt;Execute(frame, reference_line_info);</div><div class="line">&#125;</div><div class="line"></div><div class="line">PathOptimizer::Execute(*frame, *reference_line_info)&#123;</div><div class="line">	ret = Process(speedData, reference_line, start_point, path_data);</div><div class="line">&#125;</div><div class="line"></div><div class="line">DpPolyPathOptimizer::Process(SpeedData, ReferenceLine, init_point, path_data)&#123;</div><div class="line">	dp_road_graph.FindPathTunnel();</div><div class="line">&#125;</div><div class="line"></div><div class="line">DPRoadGraph::FindPathTunnel(init_point, &amp;obstacles, *path_data)&#123;</div><div class="line">	CalculateFrenetPoint(init_point, &amp;init_frenet_frame_point_);</div><div class="line">	GenerateMinCostPath(obstacles, &amp;min_cost_path);</div><div class="line">	foreach point in min_cost_path:</div><div class="line">		frenet_path.append(transfer(point));</div><div class="line">	path_data-&gt;SetFrenetPath(frenet_path);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="point2point-cost-calcualation"><a href="#point2point-cost-calcualation" class="headerlink" title="point2point cost calcualation"></a>point2point cost calcualation</h4><p>e.g. from the left interval sample points(in y-direction) to current interval sample points(in y-direction).</p>
<p>during this cost calcuation, consider pathCost, staticObstacleCost and DynamicObstacleCost. </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">TrajectoryCost::Calculate()&#123;</div><div class="line">	total_cost += CalculatePathCost();</div><div class="line">	total_cost += CalculateStaticObstacleCost();</div><div class="line">	total_cost += CalculateDynamicObstacleCost();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>UpdateNode() </li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">DPRoadGraph::GenerateMinCostPath()&#123;</div><div class="line">	<span class="keyword">for</span>(level=<span class="number">1</span>; level &lt; path_waypoints.size(); ++level)&#123;</div><div class="line">		level_points = path_waypoints[level]; <span class="comment">//all sample points in y-direction at current level </span></div><div class="line">		<span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;level_points.size(); ++i)&#123;</div><div class="line">			cur_point = level_points[i];</div><div class="line">			UpdateNode(prev_dp_points, level, &amp;trajectory_cost, &amp;cur_point);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>PathCost</li>
</ul>
<p>from each point at prevous level to current point at current level, consider the length, 1st order(speed), 2sec order(acc) should be smooth, can give a 5th-order polyfit, same as what’d done in referenceLine smoother. for each interval/curve polyfit(by <strong>curve.Evaluate()</strong>), we can re-sampling it more density, so at each new sampling point, calculate its (position, speed, acc)<code>l, dl, ddl</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">TrajectoryCost::CalculatePathCost(curve, start_s, end_s, curr_level)&#123;</div><div class="line">	foreach sampling_point in (end_s - start_s):</div><div class="line">		l = curve.Evalaute(0, sampling_point)</div><div class="line">		// cost from l </div><div class="line">		path_cost +=  l * l * config_.path_l_cost()</div><div class="line">		// cost from dl </div><div class="line">		dl = curve.Evaluate(1, sampling_point)</div><div class="line">		path_cost +=  dl * dl * config_.path_dl_cost()</div><div class="line">		// cost from ddl </div><div class="line">		ddl = curve.Evaluate(2, sampling_point)</div><div class="line">		path_cost +=  ddl * ddl * config_.path_ddl_cost()		</div><div class="line">&#125;</div><div class="line"></div><div class="line">```	</div><div class="line">		</div><div class="line">* StaticObstacleCost</div><div class="line"></div><div class="line">StaticObstacleCost() used the same idea from PathCost, basically, to resampling the interval, and calculate a cost on each of the sampling point. </div><div class="line"></div><div class="line">```c++</div><div class="line">TrajectoryCost::CalculateStaticObstalceCost(curve, start_s, end_s)&#123;</div><div class="line">	foreach curr_s in (end_s - start_s):</div><div class="line">		curr_l = curve.Evaluate(0, curr_s, start_s);</div><div class="line">		foreach obs_boundary :: static_obstacle_boundaries:</div><div class="line">			obstacle_cost += GetCostFromObs(curr_s, curr_l, obs_boundary);</div><div class="line">&#125;</div><div class="line"></div><div class="line">TrajectoryCost::GetCostFrmObs()&#123;</div><div class="line">	delta_l = fabs(adc_l - obs_center); </div><div class="line">	obstacle_cost.safety_cost += config_.obstacle_collision_cost() * Sigmoid(config_.obstacle_collision_distance() - delta_l) ;</div></pre></td></tr></table></figure>
<ul>
<li>DynamicObstacleCost </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">TrajectoryCost::CalculateDynamicObstacleCost(curve, start_s, end_s)&#123;</div><div class="line">	foreach timestamp:</div><div class="line">		foreach obstacle_trajectory in dynamic_obstacle_boxes_:</div><div class="line">			obstacle_cost += GetCostBetweenObsBoxes(ego_box, obstacle_trajectory.at(timestamp));</div><div class="line">&#125;</div><div class="line"></div><div class="line">TrajectoryCost::GetCostBetweenObsBoxes(ego_box, &amp;obs_box)&#123;</div><div class="line">	distance = obstacle_box.DistanceTo(ego_box);</div><div class="line">	if(distance &gt; config_.obstacle_ignore_distance())</div><div class="line">		return obstacle_cost ;</div><div class="line">	obstacle_cost.safety_cost += ( config_.obstacle_collision_cost() + 20) * Sigmoid(config_.obstacle_collision_distance() - distance);</div></pre></td></tr></table></figure>
<p>static obstacles cost calculating is like one space-dimension, only consider cost from the fixed/static obstacle to the fixed sampling points. for dynamic obstacles case, as the obstacle is moving, so we need a time-dimension, to calculate the cost at each time interval, from the current obstacle location to the fixed sampling points.</p>
<p>for dynamic obstacle cost, there is a risk cost (20), which need to take care.</p>
<h4 id="min-cost-path"><a href="#min-cost-path" class="headerlink" title="min cost path"></a>min cost path</h4><p>we got the cost matrix from the start_s level to the target_s/final level. but the final level in y-direction has 7 sampling points, all of which are drivable. so backward propagation, to get the best path (or a NODE in DAG)</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">DPRoadGraph::GenerateMinCostPath()&#123;</div><div class="line">	<span class="keyword">for</span>(cur_dp_node : graph_nodes.back())&#123;</div><div class="line">		fake_head.UpdateCost()</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<h3 id="SpeedOptimizer"><a href="#SpeedOptimizer" class="headerlink" title="SpeedOptimizer"></a>SpeedOptimizer</h3><p>the previous PathOptimier give the best (s, l) location of ego should arrived at each interval section along the referenceline. so what’s the best speed to reach these interval section ?</p>
<p>to do speed optimzier, two parts:</p>
<ul>
<li><p>constraint speed conditions, e.g. speed limit,  upper/lower boundary of drivable area along the refereneline due to obstacle trajectory</p>
</li>
<li><p>speed planning </p>
</li>
</ul>
<h4 id="BoundaryMapper"><a href="#BoundaryMapper" class="headerlink" title="BoundaryMapper()"></a>BoundaryMapper()</h4><p>for each obstalce’s trajectory, sampling in time-dimension, if its trajectory has overlapped with ego’s trajectory, mark the boundary box.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">StBoundaryMapper::CreateStBoundary()&#123;</div><div class="line">	foreach trajectory_point in trajectory:</div><div class="line">		obs_box = obstacle.GetBoundingBox(trajectory_point);</div><div class="line">		<span class="keyword">for</span>(path_s=<span class="number">0.0</span>, path&lt;s &lt; discretized_path.Length(); path_s += step_length)&#123;</div><div class="line">			curr_adc_path_point = discretized_path.EvaluateUsingLinearApproximation();</div><div class="line">			<span class="keyword">if</span>( CheckOverlap(curr_adc_path_point, obs_box, st_boundary_config_.boundary_buffer()) )</div><div class="line">			&#123;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// only when obs trajectory overlapped with ego's trajectory</span></div><div class="line">StBoundaryMapper::MapWithDecision(path_obstacle, decision)&#123;</div><div class="line">	boundary = StBoundary::GenerateStBoundary(lower_points, upper_points);</div><div class="line">	path_obstacle-&gt;SetStBoundary(boundary);</div><div class="line">	<span class="comment">// assign different boundary type </span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="SpeedLimitDecider"><a href="#SpeedLimitDecider" class="headerlink" title="SpeedLimitDecider"></a>SpeedLimitDecider</h4><ul>
<li><p>speed limit</p>
</li>
<li><p>centripetal acc limit</p>
</li>
<li><p>centripetal force limit </p>
</li>
</ul>
<h4 id="DpStGraph-Search"><a href="#DpStGraph-Search" class="headerlink" title="DpStGraph::Search"></a>DpStGraph::Search</h4><p>so far we have info from <code>boundaryMapper</code>, which tells lower_s and upper_s of safe driving area along reference line, excluding the overlaping area of obstacle’s trajectories; as well as speed limit. so now in the driving safe area, which speed ego should take at each point is also done by <code>DP</code>, speed can be represent in time-space two dimension, in a <code>T-S</code> table. </p>
<p>so speed DP can transfer to find the min cost [T,S] althrough the whole planning drive path. </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">DpStGraph::Search(speed_data)&#123;</div><div class="line">	InitCostTable().ok();</div><div class="line">	CalculateTotalCost().ok();</div><div class="line">	RetriveSpeedProfile(speed_data).ok();</div><div class="line">&#125;</div><div class="line"></div><div class="line">```	</div><div class="line"></div><div class="line"></div><div class="line">### QpSplineSpeedOptimizer </div><div class="line"></div><div class="line">DPSpeedOptimizer output the value pair of (time, location)(t, s) at each interval, then can get the velocity, acc, angular velocity by differencial among the neighbor intervals. QPSpline is a better way to get a polyfit 2nd-order smoothed speed profile along the referenceLine, which is higher-precision than DP.</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">### SpeedOptimizer and PathOptimizer fusion</div><div class="line"></div><div class="line">PathOptimizer outputs driving path in (accumulated_distance, section_direction distance)(s, l), SpeedOptimizer outputs driving path in (time, accumulated_distance)(t, s). now to get the best/optmized path along the referenceLine, need combine these two outputs.</div><div class="line"></div><div class="line">```c++</div><div class="line">for(cur_rel_time=0.0; cur_rel_time &lt; speed_data_.TotalTime(); cur_rel_time += TimeSec)&#123;</div><div class="line">	speed_data_.EvaluateByTime(cur_rel_time, &amp;speed_point);</div><div class="line">	if(speed_point.s() &gt; path_data_.discretized_path().Length()) break; </div><div class="line">	path_data.GetPathPointWithPathS(speed_point.s(), &amp;path_point);</div><div class="line">	path_point.set_s(path_point.s() + start_s);</div><div class="line">	</div><div class="line">	trajectory_point.mutable_path_point()-&gt;CopyFrom(path_point);</div><div class="line">	 trajectory_point.set_v(speed_point.v());</div><div class="line">    trajectory_point.set_a(speed_point.a());</div><div class="line">    trajectory_point.set_relative_time(speed_point.t() + relative_time);</div><div class="line">    ptr_discretized_trajectory-&gt;AppendTrajectoryPoint(trajectory_point);</div><div class="line">   </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>the above fusion is on one ReferenceLine, for all referenceLine, we can reach out the min cost referenceline as following:</p>
<pre><code class="c++">Frame::FindDriveReferenceLineInfo(){
    foreach reference_line_info in reference_line_info_ :
        <span class="keyword">if</span>(reference_line_info.IsDrivable() &amp;&amp; reference_lien_info.Cost &lt; min_cost){
            drive_reference_line_info_ = &amp;reference_line_info;
            min_cost = reference_line_info.Cost();
    }

    <span class="keyword">return</span> drive_reference_line_info_ ;
}
</code></pre>
<h3 id="Planning-in-summary"><a href="#Planning-in-summary" class="headerlink" title="Planning in summary"></a>Planning in summary</h3><p>Planning module has three components, ReferenceLineProvider, Frame and EMPlanner. Frame has <code>ReferencelineInfo</code>, which has everything about once-time planning, including the min-cost ReferenceLineInfo from EMPlanner. EMPlanner do DP and QP for PathPlan and SpeedPlan, seperately, which give a best driving path for each RefereneLine. in the whole, we can reach out the global best(min-cost) referenceLine from EMPlanner, and store back in Frame.</p>
<h2 id="Control"><a href="#Control" class="headerlink" title="Control"></a>Control</h2><p>Control module readin the planning ReferenceLine (Trajectory, VehicleStatus) and Localization, output control command.</p>
<pre><code class="c++">ControlComponent::Proc(){
    chassis_msg = chassis_reader_-&gt;GetLatestObserved();
    OnChassis(chassis_msg);
    trajectory_msg = trajectory_reader_-&gt; GetLatestObserved();
    localization_msg = localization_reader_-&gt; GetLatestObserved();

    status = ProduceControlCommand(&amp;control_command);
    control_cmd_writter_-&gt;Write();
}
</code></pre>
<h2 id="simulation"><a href="#simulation" class="headerlink" title="simulation"></a>simulation</h2><p>simulation is a system level verification/test tool, there are a few topics: </p>
<h4 id="simulate-the-world"><a href="#simulate-the-world" class="headerlink" title="simulate the world"></a>simulate the world</h4><p>how to make a virtual world in simulation, quickly, easily, close to real and massively deploy-friendly. </p>
<p>currently most commericial tools, e.g. PreScan, CarMaker, are supporting well real map(.osm), and on-line/distributed/cloud service, which is good way.</p>
<p>a few pioneers are trying to make the virtual world by 3D build through image/point cloud scanning. which is maybe the closest way to the physical world, but need large computing resource. </p>
<h4 id="integrate-ADS-system"><a href="#integrate-ADS-system" class="headerlink" title="integrate ADS system"></a>integrate ADS system</h4><p>how to integrate ADS system to simulation, easily.</p>
<p>most simulation software/platform is independent from ADS core. </p>
<p>for in-house prototype team, they both develop ADS and simulate in Matlab. which is pretty common in most OEM teams.</p>
<p>in product phase, it’s common to package ADS core as ros node, and talk to the simulation software by ROS.</p>
<h4 id="friendly-API"><a href="#friendly-API" class="headerlink" title="friendly API"></a>friendly API</h4><p>system level simulation has plenty of scenarios, requiring the simulation platform has friendly way to produce massively scenarios. including env, ego/npc behaviors, special cases e.t.c </p>
<p>most common APIs are Python and Matlab.</p>
<h4 id="massively-deployment"><a href="#massively-deployment" class="headerlink" title="massively deployment"></a>massively deployment</h4><p>it’s back to the test purpose, simulation needs to cover as much as possible scenarios, which requires IT infrastructure to support massively deployment. e.g. cloud deployment</p>
<p>`</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/15/review-apollo-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/15/review-apollo-1/" itemprop="url">review apollo (1)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-15T05:18:21-05:00">
                2020-02-15
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/02/15/review-apollo-1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/02/15/review-apollo-1/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://github.com/daohu527/Dig-into-Apollo" target="_blank" rel="external">dig into Apollo/Daohu527</a> and <a href="https://github.com/YannZyl/Apollo-Note" target="_blank" rel="external">YannZ/Apollo-Notes</a> are some good summary of Apollo. </p>
<h2 id="localization"><a href="#localization" class="headerlink" title="localization"></a>localization</h2><h4 id="rtk"><a href="#rtk" class="headerlink" title="rtk"></a>rtk</h4><p><a href="https://raw.githubusercontent.com/daohu527/Dig-into-Apollo/master/localization/img/location_rtk.jpg" target="_blank" rel="external">!image</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">RTKLocalizationComponent::InitIO()</div><div class="line">&#123;</div><div class="line">    corrected_imu_listener_ = node_ -&gt;CreateReader&lt;localization::CorrectImu&gt;();</div><div class="line">    gps_status_listener_ = node_ -&gt; CreateReader&lt;driver::gnss::InsStat&gt;();</div><div class="line">&#125;</div><div class="line"></div><div class="line">RTKLocalizationComponent::Proc(&amp; gps_msg)</div><div class="line">&#123;</div><div class="line"></div><div class="line">  localization_-&gt;GpsCallback(gps_msg);</div><div class="line">  <span class="keyword">if</span>(localization_-&gt;IsServiceStarted())</div><div class="line">  &#123;</div><div class="line">     LocalizationEstimate localization; </div><div class="line">     localization_-&gt;GetLocalization(&amp;localization); </div><div class="line">     localization_-&gt;GetLocalizationStatus(&amp;localization_status); </div><div class="line">     PublishPoseBroadcastTopic(localization);</div><div class="line">    &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h4 id="ndt"><a href="#ndt" class="headerlink" title="ndt"></a>ndt</h4><p>normal distribution transform(NDT) is to match our sensors view points compare to what we see on an existing map. </p>
<p>due to the view points from sensor may be <a href="https://medium.com/self-driving-cars/ndt-matching-acff8e7e01cb" target="_blank" rel="external">a little off from the map</a>, or the world might change a little between when built the map and when we record the view points.</p>
<p>so NDT will try to match view points to a grid of probability functions created from the map, instead of the map itself.</p>
<h4 id="msf"><a href="#msf" class="headerlink" title="msf"></a>msf</h4><h2 id="perception"><a href="#perception" class="headerlink" title="perception"></a>perception</h2><h4 id="module-overview"><a href="#module-overview" class="headerlink" title="module overview"></a>module overview</h4><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">void Perception::RegistAllOnboardClass() &#123;</div><div class="line">  RegisterFactoryLidarProcessSubnode();</div><div class="line">  RegisterFactoryRadarProcessSubnode();</div><div class="line">  RegisterFactoryFusionSubnode();</div><div class="line">  traffic_light::RegisterFactoryTLPreprocessorSubnode();</div><div class="line">  traffic_light::RegisterFactoryTLProcSubnode();</div><div class="line">&#125;</div><div class="line"></div><div class="line">``` </div><div class="line"></div><div class="line">the data flow in perception has two ways, either ROS message send/subscribe, or shared data. Apollo design a `global map` data structure:</div><div class="line"></div><div class="line">```c++</div><div class="line"></div><div class="line">GlobalFactoryMap&lt;string, map&lt;string, ObjectFactory*&gt; &gt;</div><div class="line"></div><div class="line">``` </div><div class="line"></div><div class="line">the first string element can be `SubNode` or `ShareData`.</div><div class="line"></div><div class="line">e.g. </div><div class="line"></div><div class="line">* lidar share data can stored as:  `GlobalFactorMap[sharedata][LidarObjectData]`</div><div class="line"></div><div class="line">* radar subnode data can stored as: `GlobalFactorMap[Subnode][RadarObjectData]`</div><div class="line"></div><div class="line"></div><div class="line">#### DAG process</div><div class="line"></div><div class="line">after ros subnode and shared data registered(not instance), [perception module create a DAG](https://github.com/YannZyl/Apollo-Note/blob/master/docs/perception/perception_software_arch.md)(directional acyclic graph) process, which includes subNode, Edge, and ShareData. </div><div class="line"></div><div class="line">`Edge` defines start node and end node of the data flow. e.g.   LidarProcessSubnode -&gt; FusionSubnode.</div><div class="line"></div><div class="line">* subnode init </div><div class="line"></div><div class="line">```c++</div><div class="line">DAGStreaming::InitSubnodes()</div><div class="line">&#123;</div><div class="line">   for(auto pair: subnode_config_map)</div><div class="line">   &#123;</div><div class="line">      Sunode* inst = SubnodeRegisterer::GetInstanceByName(subnode_config.name());</div><div class="line">      inst-&gt;Init() ;</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<ul>
<li>edge init </li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">DAGStreaming::Init()</div><div class="line">&#123;</div><div class="line">  event_manager_.Init(dag_config_path.edge_config());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>it’s easy to understand <code>EventManager</code> is used to register edge, as the data flow either by ros node or by share data is event driven. inside    <code>EventManager</code> there are two variables:  </p>
<pre><code>event_queue_map &lt;eventID, message_queue&gt;

event_meta_map  &lt;eventID, message_info&gt;
</code></pre><ul>
<li>shareData init </li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">DAGStreaming::Init()</div><div class="line">&#123;</div><div class="line">  InitSharedData(dag_config.data_config());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>each subnode and shareData is a separate ROS/data thread, which started after DAG process initialization finished, the run() process is the event loop:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">DAGStreaming::Schedule()</div><div class="line">&#123;</div><div class="line">  <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; pair: subnode_map_)</div><div class="line">  &#123;</div><div class="line">     pair.second-&gt;Start();</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; pair : subnode_map_)</div><div class="line">  &#123;</div><div class="line">    pair.second-&gt;Join();</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Subnode::Run()</div><div class="line">&#123;</div><div class="line">  <span class="keyword">while</span>(!stop)</div><div class="line">  &#123; </div><div class="line">    status = ProcEvents();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Lidar-process"><a href="#Lidar-process" class="headerlink" title="Lidar process"></a>Lidar process</h4><ul>
<li><a href="https://github.com/YannZyl/Apollo-Note/blob/master/docs/perception/obstacles_lidar_1_hdmap.md" target="_blank" rel="external">hdmap ROI filter</a>. basically compare the lidar cloud points to hdmap area, and filter out the cloud points outside of ROI.</li>
</ul>
<ul>
<li><p><a href="https://github.com/YannZyl/Apollo-Note/blob/master/docs/perception/obstacles_lidar_2_cnn.md" target="_blank" rel="external">CNN image segmentation</a>, basically classfiy the point clouds as obstacles based on CNN. </p>
</li>
<li><p><a href="https://github.com/YannZyl/Apollo-Note/blob/master/docs/perception/obstacles_lidar_3_minibox.md" target="_blank" rel="external">obstacle minBox</a></p>
</li>
<li><p><a href="https://github.com/YannZyl/Apollo-Note/blob/master/docs/perception/obstacles_lidar_4_hmtrack.md" target="_blank" rel="external">obstalce tracking</a></p>
</li>
<li><p><a href="https://github.com/YannZyl/Apollo-Note/blob/master/docs/perception/obstacles_lidar_5_fusion.md" target="_blank" rel="external">lidar fusion</a></p>
</li>
</ul>
<h4 id="Lidar-amp-Radar-fusion"><a href="#Lidar-amp-Radar-fusion" class="headerlink" title="Lidar &amp; Radar fusion"></a>Lidar &amp; Radar fusion</h4><p>the data fusion ros node proces in the following way:</p>
<p>step1: collect sensor’s data </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">FusionSubnode::Process()</div><div class="line">&#123;</div><div class="line">   BuildSensorObjs(events, &amp;sensor_objs);</div><div class="line">   fusion_-&gt;Fusion(sensor_objs, &amp;objects+);</div><div class="line">&#125;</div><div class="line"></div><div class="line">FusionSubnode::BuildSensorObjs(&amp;events, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;SensorObjects&gt; * multi_sensor_objs)&#123;</div><div class="line"></div><div class="line">  foreach event in events:</div><div class="line">  &#123;</div><div class="line">     <span class="keyword">if</span>( event.event_id == lidar )</div><div class="line">     &#123;</div><div class="line">        sensor_objects.sensor_type = VELODYNE ;</div><div class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( event.event_id == radar)&#123;&#125;</div><div class="line">     <span class="keyword">else</span> <span class="keyword">if</span> (event.event_id == camera)  &#123;&#125;</div><div class="line">     <span class="keyword">else</span>&#123;<span class="keyword">return</span> <span class="literal">false</span>;&#125;</div><div class="line">  &#125;</div><div class="line">  multi_sensor_objs-&gt;push_back(*sensor_objects);</div><div class="line">  </div><div class="line">&#125;   </div><div class="line">```   </div><div class="line"></div><div class="line">step2: process sensors data</div><div class="line"></div><div class="line">```c++</div><div class="line"></div><div class="line">ProbabiliticFusion::Fuse(multi_sensor_objs, *fused_objs)</div><div class="line">&#123;</div><div class="line"></div><div class="line">  sensor_mutex.lock();</div><div class="line">  foreach sensor_objs in multi_sensor_objs: </div><div class="line">  &#123;</div><div class="line">     sensor_manager_-&gt;AddSensorMeasurements(sensor_objs);</div><div class="line">  &#125;</div><div class="line">  sensor_manager_-&gt;GetLatestFrames(fusion_time, &amp;frames);</div><div class="line">&#125; </div><div class="line">  sensor_mutex.unlock();</div><div class="line"></div><div class="line">sensor_mutex.lock();</div><div class="line">foreach frame in frames:</div><div class="line">    FuseFrame(frame)</div><div class="line">CollectFusedObjects(fusion_time, fused_objects);</div><div class="line">sensor_mutex.unlock();</div></pre></td></tr></table></figure>
<p>the data structure for sensor_type, timestamp and perceptioned obj is: </p>
<pre><code>std::map&lt;string sensorType, map&lt;int64, SensorObjects&gt; &gt; sensors_;
</code></pre><p><code>sensors_[sensor_id][timestamp]</code> return the sensor’s object at a special timestamp</p>
<p>for Lidar and Radar fusion, we get a frame list, each frame has the object list from both Lidar and Radar. basically, so far it is just matching Lidar objects to Radar objects, assiged to timestamp. Lidar objects and Radar objects are indepenent.</p>
<h2 id="prediction"><a href="#prediction" class="headerlink" title="prediction"></a>prediction</h2><p>in Apollo, prediction module anticipatd the future motion trajectories of the perceived obstacles.</p>
<p>prediction subscribe to localization, planning and perception obstacle messages. when a localization update is received, the prediction module update its internal status, the actual prediction is triggered when perception sends out its perception obstacle messages, as following code :</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">MessageProcess:OnLocalization(*ptr_localization_msg);</div><div class="line">MessageProcess:OnPlanning(*ptr_trajectory_msg)</div><div class="line">MessageProcess:OnPerception(*ptr_perception_msg, &amp;prediction_obstacles)</div></pre></td></tr></table></figure>
<p>take a detail review of <code>OnPerception</code> as following: </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">MessageProcess:OnPerception(perception_obstacles, prediction_obstacles)&#123;</div><div class="line"></div><div class="line">	ptr_obstalces_container = ContainerManager::Instance()-&gt;GetContainer&lt;ObstaclesContainer&gt;();</div><div class="line">	</div><div class="line">	ptr_trajectory_container = ContainerManager::Instance()-&gt;GetContainer&lt;ADCTrajectoryContainer&gt;();</div><div class="line"></div><div class="line">	EvaluatorManager::Instance()-&gt;Run(ptr_obstacles_container);</div><div class="line">	</div><div class="line">	PredictorManager::Instance()-&gt;Run(perception_obstacles, ptr_trajectory_container, ptr_obstacles_container)</div></pre></td></tr></table></figure>
<h4 id="ContainerManager"><a href="#ContainerManager" class="headerlink" title="ContainerManager"></a>ContainerManager</h4><p>used to instancialize an instance of the special container, which is used to store the special type of message. there are three types of contianer:</p>
<ul>
<li>ObstaclesContainer </li>
</ul>
<p>used to store obstalce info and its lane info. obstacle info coming from perception; its lane info coming from hd map and <code>LaneGraph</code>, <code>LaneSequence</code> and <code>LaneSegment</code>. check the <a href="https://github.com/YannZyl/Apollo-Note/blob/master/docs/prediction/container_manager.md" target="_blank" rel="external">explanation of ObstacleContainer</a></p>
<p><code>LaneGraph</code> is namely the lane network. e.g. the pre/post lane, neighbor lane, or where the lane disappear. <code>LaneSegment</code> is the element/piece of discretization of the lane network, which has a start point and end point. <code>LaneSequence</code> is a set of all possible next lane choices from current lane, which is only based on the lane network and current obstacle velocity, rather than from planning.</p>
<ul>
<li>PoseContainer </li>
</ul>
<p>used to store vehicle world coord and the coord transfer matrix, velocity info e.t.c</p>
<ul>
<li>ADCTrajectoryContainer </li>
</ul>
<h4 id="EvaluatorManager"><a href="#EvaluatorManager" class="headerlink" title="EvaluatorManager"></a>EvaluatorManager</h4><p><a href="https://github.com/YannZyl/Apollo-Note/blob/master/docs/prediction/evaluator_manager.md" target="_blank" rel="external">what evaluator does</a>, is to compute the probability of each laneSequence, the obstacle is either vehicle, or pedestrain or bicycle. to compute probability is with multi-layer predictor(MLP) model:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">MLPEvaluator::Evaluate(obstacle_ptr)&#123;</div><div class="line">   foreach lane_sequence_ptr in lane_graph-&gt;lane_sequence_set:</div><div class="line">   ExtractFeatureValues(obstacle_ptr, lane_sequence_ptr, &amp;feaure_values)</div><div class="line">	probability = ComputeProbability(feature_values);  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ObstacleFeature</li>
</ul>
<p>there are <a href="https://github.com/YannZyl/Apollo-Note/blob/master/docs/prediction/evaluator_manager.md" target="_blank" rel="external">22 dimensions</a>, which are greate resources to understand a good prediction model in ADS. </p>
<p>these features includes, dimension, velocity, acc, direction of the obstacle, and relative position, angle to boundary lane e.t.c.</p>
<ul>
<li>LaneFeature </li>
</ul>
<p>since the laneSequence is already discritized as LaneSegment, for each lane Segment, Apollo calculate <code>4 features</code>: the angle from lanePoint position to its direction vector; obstacle’s projected distance to laneSequence; the direction of lanePoint; the direction angle from lanePoint’s direction to obstacle’s direction.</p>
<p>for each LaneSequnce only calculate its first 40 features, namely the first 10 LaneSegment.</p>
<p>from 22 Obstacle features and  40 lane features, compute the probability of each LaneSequence.</p>
<h4 id="PredictorManager"><a href="#PredictorManager" class="headerlink" title="PredictorManager"></a>PredictorManager</h4><p>this is where we answer the predict question, where in the next 5 sec the obstacle located. after EvaluatorManager(), we get the probability of each LaneSequence. then choose the few LaneSequences with high probability, and predict a possible obstacle motion for each high-probability LaneSequence as well as with ADCTrajectory info from planning module.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">PredictorManager::Run(perception_obstalces)</div><div class="line">&#123;</div><div class="line">   foreach obstacle in perception_obstacles:</div><div class="line">      predictor-&gt;Predict(obstacle)</div><div class="line">      foreach trajectory in  predictor-&gt;trajectories():</div><div class="line">          prediction_obstacle.add_trajectory(trajectory)  </div><div class="line">       prediction_obstacles.add_prediction_obstalce(prediction_obstalce)</div><div class="line">&#125;</div><div class="line">``` </div><div class="line">basically <span class="keyword">for</span> each obstacle, we <span class="keyword">do</span> [prediction its next few seconds position](https:<span class="comment">//github.com/YannZyl/Apollo-Note/blob/master/docs/prediction/predictor_manager.md). there are a few predictors: MoveSequencePredictor, LaneSequencePredictor, FreeMovePredictor.</span></div><div class="line"></div><div class="line">```c++</div><div class="line"></div><div class="line">MoveSequencePredictor::Predict(obstacle)</div><div class="line">&#123;</div><div class="line">   feature = obstalce-&gt;latest_feature();</div><div class="line">   num_lane_sequence =  feature.lane_graph().lane_sequence_size()</div><div class="line">   FilterLaneSequence(feature, lane_id, &amp;enable_lane_sequence)</div><div class="line">   foreach sequence in feature.lane_sequence_set</div><div class="line">   &#123;</div><div class="line">      DrawMoveSequenceTrajectoryPoints(*obstacle, sequence, &amp;points)</div><div class="line">      trajectory = GenerateTrajectory(points)</div><div class="line">      trajectory.set_probability(sequence.probability());</div><div class="line">      trajectories_.push_back(trajectory)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="why-need-prediction-module"><a href="#why-need-prediction-module" class="headerlink" title="why need prediction module"></a>why need prediction module</h4><p>whether including motion prediction or not is based on the computing ability of ADS system. for low power system, the planning module update really high frequency, then there is no prediction, or prediction only need be considered in less than a few mic-sec; but for complex ADS  system with low frequency update of planning, the ability to forsee the next few secs is very helpful. </p>
<h2 id="Planning"><a href="#Planning" class="headerlink" title="Planning"></a>Planning</h2><p><a href="https://raw.githubusercontent.com/daohu527/misc/master/blog/planning/planning_flow.png" target="_blank" rel="external">!image</a></p>
<h3 id="VehicleStateProvider"><a href="#VehicleStateProvider" class="headerlink" title="VehicleStateProvider"></a>VehicleStateProvider</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">VehicleStateProvider</span> &#123;</span></div><div class="line">   common::VehicleState vehicle_state_ ;</div><div class="line">   localization::LocalizationEstimate original_localization_ ; </div><div class="line">   </div><div class="line">   Update();</div><div class="line">   </div><div class="line">   EstimateFuturePosition();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="P-amp-C-Map"><a href="#P-amp-C-Map" class="headerlink" title="P&amp;C Map"></a>P&amp;C Map</h3><h4 id="update-routing-response"><a href="#update-routing-response" class="headerlink" title="update routing response"></a>update routing response</h4><p>during PnC map, we need to query waypoints(in s, l coord), e.g. current vehicle position, target position, in which routing laneSegment.</p>
<ul>
<li>get laneSegment info from routing response </li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">PncMap::UpdateRoutingResponse(routing)&#123;</div><div class="line">foreach road_segment in routing.road() :</div><div class="line">   foreach passage in road_segment.passage():</div><div class="line">      foreach lane in passage.segment():</div><div class="line">      &#123;</div><div class="line">         all_lane_id.insert(lane.id());</div><div class="line">       &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>query waypoints </li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">RouteSegments::WithinLaneSegment(&amp;lane_segment, &amp;waypoint)&#123;</div><div class="line">   <span class="keyword">return</span>  lane_segment.lane-&gt;id().id() == waypoint.id() &amp;&amp;  waypoint.s()  &gt;= lane_segment.start_s &amp;&amp; waypoint.s() &lt;= lane_segment.end_s</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>with UpdateRoutingResponse(), basically trafer waypoint in <code>s,l</code> coord to a more readable representation: [route_index, roadSegid, PassageID, laneSegmentID]</p>
<h4 id="generate-RouteSegments"><a href="#generate-RouteSegments" class="headerlink" title="generate RouteSegments"></a>generate RouteSegments</h4><p>based on current vehicle status and routing response, get all driving-avaiable path set, each <code>RouteSegment</code> is one driving-avaiable path in a short period. The length of each RouteSegment depends on the both backward(30m by default) lookup length and forward lookup length, which depends on ego vehicle velocity, a time threashold(8s by default), min_distance(150m by default), max_distance(250m by default). <a href="https://github.com/YannZyl/Apollo-Note/blob/master/docs/planning/pnc_map.md" target="_blank" rel="external">check here</a></p>
<ul>
<li>UpdateVehicleState()</li>
</ul>
<p>it’s not about update vehicle velocity e.t.c, but find out vehicle current location <code>adc_waypoint_</code> in the routing path and the next lane index <code>next_routing_waypoint_index_</code>. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">1. based on current vehicle velocity(x,y) and heading direction, lookup hdmap to find out all possible lanes, where current vehicle is on</div><div class="line"></div><div class="line">2. check if any lane from the possible lanes set, belong to any lanes from routingResponse.road(), the output is the filtered lanes set, on which the vehicle is and which belongs to routingResponse. </div><div class="line"></div><div class="line">3. calculate vehicle projection distance to each lane in the filtered lanes set, the lane with min projection distance is the target/goal lane</div></pre></td></tr></table></figure>
<ul>
<li>GetNeighborPassages()</li>
</ul>
<p>basically, check the next connected and avaiable channel. for situations, e.g. next cross lane is left turn, or lane disappear </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">GetNeighborPassages(road, passage_index)</div><div class="line">&#123;</div><div class="line">   <span class="keyword">if</span> (routing::FORWARD)</div><div class="line">   &#123;</div><div class="line">     <span class="comment">// keep forward, return current passage </span></div><div class="line">   &#125; </div><div class="line">   <span class="keyword">if</span> (source_passage.can_exit())</div><div class="line">   &#123;</div><div class="line">     <span class="comment">// current passage disappear</span></div><div class="line">   &#125;    </div><div class="line">   <span class="keyword">if</span> (IsWaypointOnSegment(next_routing_waypoint))</div><div class="line">   &#123;</div><div class="line">     <span class="comment">// next routing waypoint is in current lane</span></div><div class="line">   &#125; </div><div class="line">   <span class="keyword">if</span>(routing::LEFT <span class="keyword">or</span> routing::RIGHT)&#123;</div><div class="line">     neighbor_lanes = get_all_Left/Right_neighbor_forward_lane_id()</div><div class="line">     foreach passage in road:</div><div class="line">        foreach segment in passage:</div><div class="line">           <span class="keyword">if</span>(neighbor_lanes.count(segment.id())&#123;</div><div class="line">               result.emplace_back(id);</div><div class="line">               <span class="keyword">break</span>; </div><div class="line">           &#125;</div><div class="line">    <span class="keyword">return</span> result; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>GetRouteSegments()</li>
</ul>
<p>once we get the neighbor channels/passenges, the last step is to check if these passenges are drivable, only when current lane where ego vehicle located is the same lane or exactly next one lane when the vehicle projected on the passenge, and make sure the same direction. all other situations are not drivable. </p>
<p>additionaly add forward and backward segments will give current RouteSegments. </p>
<p>tips, passage is the channel where vehicle drive, or lane in physical road. but we use only LaneSegment, there is no keyword <code>Lane</code>.</p>
<h4 id="from-RouteSegment-to-road-sample-points"><a href="#from-RouteSegment-to-road-sample-points" class="headerlink" title="from RouteSegment to road sample points"></a>from RouteSegment to road sample points</h4><p>RouteSegment is similar as LaneSegments from hdMAP, including laneID, start_s, end_s; with additional mapPathPoint info, e.g. heading direction, and other traffic area property, which is used to lookup HD map.</p>
<p>rather than LaneSegments is about 2m, RouteSegment length can be much longer, including a few LaneSegments. if each LaneSegment provides a sample point, and packaging these smaple points as MapPathPoint, then RouteSegments can be represented as a list of MapPathPoint. and in reality, both start_point and end_point of each LaneSegemnt also added as a sample point, but need take off overlap points.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">PnCMap::AppendLaneToPoints()</div></pre></td></tr></table></figure>
<p>each two mapPathPoint again can group as a LaneSegment2d, and for the LaneSegment2d in same lane, can joining as one LaneSegment:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Path::InitLaneSegments()&#123;</div><div class="line">   <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i+<span class="number">1</span>&lt;num_points_; ++i)&#123;</div><div class="line">      FindLaneSegment(path_points_[i], path_points_[i+<span class="number">1</span>], &amp;lane_segment);</div><div class="line">      lane_segments_.push_back(lane_segment);</div><div class="line">   LaneSegment.Join(&amp;lane_segments);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>each small piece of LaneSegment2d helps to calculate the heading direction.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">Path::InitPoints()&#123;</div><div class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;num_points_; ++i)&#123;</div><div class="line">     heading = path_points_[i+<span class="number">1</span>] - path_points[i];</div><div class="line">     heading.Normalize();</div><div class="line">     unit_directions_.push_back(heading);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">``` </div><div class="line">tips, LaneSegment2d is the small piece about <span class="number">2</span>m, LaneSegment is a larger segment, <span class="keyword">and</span> has accumulated_start_s, <span class="keyword">and</span> accumulated_end_s info.</div><div class="line"></div><div class="line">so far, we have LaneSegment <span class="keyword">and</span> MapPathPoints <span class="built_in">set</span> to represent the RouteSegment. the MapPointPoint is about <span class="number">2</span>m each, Apollo(why?) density it about <span class="number">8</span> times to get a <span class="built_in">set</span> of sample path points, which is about <span class="number">0.25</span>m each.</div><div class="line"></div><div class="line">```c++</div><div class="line">Path::InitWidth()&#123;</div><div class="line">   kSampleDistance = <span class="number">0.25</span> ;</div><div class="line">   num_sample_points_ = length_ / kSampleDistance + <span class="number">1</span> ;</div><div class="line">   <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;num_sample_points_; ++i)&#123;</div><div class="line">     mapPathPoint_ = GetSmoothPoint(s);</div><div class="line">     s += kSampleDistance ; </div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>finally, RouteSegment has traffic zone info, e.g. cross road, parking area e.t.c</p>
<h3 id="ReferenceLineProvider"><a href="#ReferenceLineProvider" class="headerlink" title="ReferenceLineProvider"></a>ReferenceLineProvider</h3><p>ReferenceLineProvider has two funcs, <a href="https://github.com/YannZyl/Apollo-Note/blob/master/docs/planning/reference_line_provider.md" target="_blank" rel="external">check here</a>:</p>
<ul>
<li>smoothing sample path_points to get a list of anchor points, which is the exactly vehicle driving waypoints. from path_points to anchor_points is resampling, with a sparse(5m) sampling distance, as well as additionally consider one-side driving correction factor. </li>
</ul>
<p>taking an example about one-side driving correction factor,: when driving on left curve, human driver keeps a little bit left, rather than keeping in the centerline.</p>
<ul>
<li>piecewise smoothing from anchor points</li>
</ul>
<p>the basic idea is split anchor points in <code>n</code> subgroups, and polyfit each subgroup; for the subgroup connection part need to make sure the zero-order, first order and second order differential smooth.</p>
<p>which in final return to an <code>optimization problem</code> with constraints. </p>
<h3 id="Frame"><a href="#Frame" class="headerlink" title="Frame"></a>Frame</h3><p>the previous PnCMap and ReferenceLine is in an ideal driving env, Frame class considers obstacles behavior, and traffic signs. <a href="https://github.com/YannZyl/Apollo-Note/blob/master/docs/planning/frame.md" target="_blank" rel="external">check here</a></p>
<h4 id="obstacle-lagPrediction"><a href="#obstacle-lagPrediction" class="headerlink" title="obstacle lagPrediction"></a>obstacle lagPrediction</h4><p>predictionObstacle info is filtered by the following two cases, before use as the obstacle trajectory for planning. </p>
<ul>
<li>for latest prediction obstacles</li>
</ul>
<p>only if perception_confidence is large than confidence_threshold(0.5 by default) and the distance from the prediction obstacle to ego vehicle is less than distance_threshold(30m by default), then this obstacle is considered</p>
<ul>
<li>for history prediction obstacles </li>
</ul>
<p>only if the prediction_obstacles has more than 3 obstacles. as well as each obstacle appear more than <code>min_appear_num</code>(3 by default), and for the same obstacle, the timestamp distance from its previous prediction to latest prediction is not longger than <code>max_disappear_num</code>(5 by default), then this obstcle need take considerion.</p>
<h4 id="relative-position-from-ego-vehicle-to-obstacle"><a href="#relative-position-from-ego-vehicle-to-obstacle" class="headerlink" title="relative position from ego vehicle to obstacle"></a>relative position from ego vehicle to obstacle</h4><p>as we get the obstacles’ LagPrediction trajectory, as well as ReferenceLine for ego vehicle. now we combine this two information, to understand when the ego is safe and how far ego can drive forward. the output is the referenceline with each obstacle overlapped info. including the time <code>low_t</code> when overlap begins, and the time <code>high_t</code> when overlap ends; and the start location <code>low_s-start</code> and end location <code>high_s-start</code> of the overlap.</p>
<h4 id="rule-based-behavior-to-handle-overlap-area"><a href="#rule-based-behavior-to-handle-overlap-area" class="headerlink" title="rule based behavior to handle overlap area"></a>rule based behavior to handle overlap area</h4><p>there are 11 rule based behavior.</p>
<ul>
<li><p>backside_vehicle </p>
</li>
<li><p>change_lane</p>
</li>
<li><p>crosswalk</p>
</li>
<li><p>destination</p>
</li>
<li><p>front_vehicle</p>
</li>
<li><p>keep_clear </p>
</li>
<li><p>pull_over</p>
</li>
<li><p>reference_line_end </p>
</li>
<li><p>rerouting </p>
</li>
<li><p>signal_light</p>
</li>
<li><p>stop_sign </p>
</li>
</ul>
<pre><code class="c++">Planning::RunOnce()
{
  foreach ref_line_info in  frame_-&gt;reference_line_info()){
     traffic_decider.Init();
     traffic_decider.Execute(&amp;ref_line_info);
  }
}
</code></pre>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/15/ads-ros-and-simulator-in-one-docker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/15/ads-ros-and-simulator-in-one-docker/" itemprop="url">ads ros and simulator in one docker</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-01-15T06:16:36-05:00">
                2020-01-15
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/01/15/ads-ros-and-simulator-in-one-docker/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/01/15/ads-ros-and-simulator-in-one-docker/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="backround"><a href="#backround" class="headerlink" title="backround"></a>backround</h2><p><a href="https://zjli2013.github.io/2020/01/14/ads-ros-and-lgsvl-talk-in-dockers/" target="_blank" rel="external">previously</a>, we had test to run ads ros in one docker container, and lgsvl simulator in another docker container. once they are hosted in the same host machine, the ADS ros nodes and lgsvl can communicate well. based on this work, now it’s the time to integrate ADS ros nodes into the lgsvl docker.</p>
<p>the basic idea of how to combine multi docker images into one, is <a href="https://docs.docker.com/develop/develop-images/multistage-build/" target="_blank" rel="external">use multistage-build</a>, which I call “image level integration”.</p>
<h4 id="image-level-integration"><a href="#image-level-integration" class="headerlink" title="image level integration"></a>image level integration</h4><p>basically we have both <code>ads_ros</code> image and <code>lgsvlsimulator</code> image already, and there are a few components from <code>ads_ros</code> can be imported to <code>lgsvlsimulator</code> container: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">FROM ads_ros:latest  AS ADS</div><div class="line">FROM lgsvlsimulator:latest</div><div class="line">RUN mkdir /catkin_ws</div><div class="line">COPY --from=ADS /root/catkin_ws  /catkin_ws</div><div class="line">COPY --from=ADS /opt/ros /opt/ros </div><div class="line">CMD [&quot;/bin/bash&quot;]</div></pre></td></tr></table></figure>
<p>the problem of <code>image level integration</code>, it actually miss some system level components: <code>/etc/apt/sources.list.d/ros-latest.list</code>, which then can’t update ros modules; other components, e.g. which are installed during building <code>ads_ros</code> image by <code>apt-get install</code>, which are go the system lib path, which of course can distinct out, and copy to <code>lgsvlsimulator</code>, but which is no doubt tedious and easy to miss some components.</p>
<h4 id="component-level-integration"><a href="#component-level-integration" class="headerlink" title="component level integration"></a>component level integration</h4><p>as <code>ads_ros</code> is really indepent to <code>lgsvlsimulator</code>, so another way is use <code>lgsvlsimulator</code> as base image, then add/build <code>ros</code> component and <code>ads_ros</code> compnents inside.</p>
<pre><code>FROM ros:kinetic  AS ROS
# http://wiki.ros.org/kinetic/Installation/Ubuntu

FROM lgsvlsimulator:latest
RUN mkdir -p /catkin_ws/src
COPY --from=ROS /opt/ros /opt/ros 
COPY --from=ROS /etc/apt/sources.list.d/ros1-latest.list /etc/apt/sources.list.d/ros1-latest.list
# ADD ros key
RUN apt-key adv --keyserver &apos;hkp://keyserver.ubuntu.com:80&apos; --recv-key C1CF6E31E6BADE8868B172B4F42ED6FBAB17C654
## -------- install ads ros packages in lgsvlsimulator container ------------ ##
ENV CATKIN_WS=/catkin_ws
ENV ROS_DISTRO=kinetic
## https://docs.ros.org/api/catkin/html/user_guide/installation.html
RUN APT_INSTALL=&quot;apt-get install -y --no-install-recommends&quot; &amp;&amp; \
    apt-get update &amp;&amp; \
    DEBIAN_FRONTEND=noninteractive $APT_INSTALL \
        build-essential \
        apt-utils \
        ca-certificates \ 
        psmisc \
        cmake \
        python-catkin-pkg \ 
        ros-${ROS_DISTRO}-catkin  \ 
        ros-${ROS_DISTRO}-tf  \
        ros-${ROS_DISTRO}-turtlesim \
        ros-${ROS_DISTRO}-rosbridge-suite \
        iputils-ping \   
        net-tools 
# RUN source ~/.bashrc 
# copy ads ros into ws
COPY /ads_ros/src $CATKIN_WS/src
### build msgs 
RUN /bin/bash -c &apos;. /opt/ros/${ROS_DISTRO}/setup.bash; cd ${CATKIN_WS}; catkin_make --pkg pcl_msgs autoware_msgs nmea_msgs &apos;                   
### build ros nodes 
RUN /bin/bash -c &apos;. /opt/ros/${ROS_DISTRO}/setup.bash; cd ${CATKIN_WS}; catkin_make &apos;
# copy ros scripts
COPY /ads_ros/script_docker $CATKIN_WS/script
###--------finished ads ros package -------------- ### 
CMD [&quot;/bin/bash&quot;]
</code></pre><h2 id="runtime-issue"><a href="#runtime-issue" class="headerlink" title="runtime issue"></a>runtime issue</h2><p>with the dockerfile above, we can build the docker image which include both lgsvl and ads ros. one runtime issue is due to lgsvl scenario is run with <code>python3</code>, while our ads ros, especially <code>ros_bridge_launch</code> is based on <code>python2</code>. so need some trick to add <code>python2</code> at <code>$PATH</code> before <code>python3</code> when launch <code>ros_bridge</code>, then exchange back.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/20/">20</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="David Z.J. Lee" />
          <p class="site-author-name" itemprop="name">David Z.J. Lee</p>
           
              <p class="site-description motion-element" itemprop="description">what I don't know</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">193</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">51</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/ZJLi2013" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.linkedin.com/in/zhengjia13/" target="_blank" title="LinkedIn">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  LinkedIn
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">David Z.J. Lee</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://zjlee.disqus.com/count.js" async></script>
    

    

  




	





  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
