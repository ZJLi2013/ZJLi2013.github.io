<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="what I don&apos;t know">
<meta property="og:type" content="website">
<meta property="og:title" content="Serious Autonomous Vehicles">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="Serious Autonomous Vehicles">
<meta property="og:description" content="what I don&apos;t know">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Serious Autonomous Vehicles">
<meta name="twitter:description" content="what I don&apos;t know">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/5/"/>





  <title>Serious Autonomous Vehicles</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Serious Autonomous Vehicles</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/13/vulkan-in-docker-to-support-new-lgsvl/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/13/vulkan-in-docker-to-support-new-lgsvl/" itemprop="url">vulkan in docker to support new lgsvl</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-11-13T08:06:45-05:00">
                2019-11-13
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/11/13/vulkan-in-docker-to-support-new-lgsvl/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/11/13/vulkan-in-docker-to-support-new-lgsvl/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="background"><a href="#background" class="headerlink" title="background"></a>background</h3><p>Docker is a great idea to package apps, the first time to try <a href="https://zjli2013.github.io/2019/07/12/play-with-Docker-swarm-compose/" target="_blank" rel="external">play with docker swarm</a>. <a href="https://github.com/lgsvl/simulator" target="_blank" rel="external">lg-sim</a> has updated to HDRP rendering, which has a higher quality, as well requires more GPU features, <code>Vulkan</code>. currently <code>Vulkan</code> is not supported by standard <code>docker</code> neither <code>nvidia-dcker</code>, which is deprecated after <code>docker enginer &gt; 19.03</code>. </p>
<p>there is <a href="https://gitlab.com/nvidia/container-images" target="_blank" rel="external">nvidia images</a>,  the special one we are interesed is <a href="https://gitlab.com/nvidia/container-images/vulkan" target="_blank" rel="external">vulkan docker</a>, and there is an related <a href="https://github.com/edowson/docker-nvidia-vulkan" target="_blank" rel="external">personal project</a>, which is based on the <code>cudagl=10.1</code>, which is not supported by non-Tesla GPU. so for our platform, which has only <a href="https://developer.nvidia.com/cuda-gpus" target="_blank" rel="external">Quadra P2000 GPUs</a>, the supported CUDA is 9.0, so we need to rebuild the vulkan docker based on <code>CUDA9.0</code>. check the <a href="https://gitlab.com/nvidia/container-images/vulkan/blob/master/Dockerfile" target="_blank" rel="external">vulkan dockerfile</a>, instead of using <code>cudagl:9.0</code>, change to: <code>FROM nvidia/cudagl:9.0-base-ubuntu16.04</code></p>
<p>after build the image, we can build the <a href="https://gitlab.com/nvidia/container-images/samples/tree/master/vulkan/ubuntu16.04" target="_blank" rel="external">vulkan test samples</a>. if no issue, load lg-sim into this vulkan-docker.</p>
<p>a few lines may help:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">/usr/lib/nvidia-384/libGLX_nvidia.s.0 </div><div class="line"></div><div class="line">/usr/share/vulkan/icd.d</div><div class="line"></div><div class="line">/proc/driver/nvidia/version</div></pre></td></tr></table></figure>
<h3 id="new-lgsvl-in-docker"><a href="#new-lgsvl-in-docker" class="headerlink" title="new lgsvl in docker"></a>new lgsvl in docker</h3><p>the previous lg-sim(2019.04) can be easily run in docker, as mentioned <a href="https://github.com/lgsvl/simulator/issues/222" target="_blank" rel="external">here</a>.</p>
<p>the above vulkan-docker image is the base to host lgsvl (2019.09). additionaly, adding <code>vulkan_pso_cache.bin</code> to the docker. the benefit of host lgsvl server in docker, is to access the webUI from host or remote. so the network should be configured to run as <code>--net=host</code>. if configure as a swarm overlay network, it should support swarm cluster.</p>
<p>a few related issue can be checked at <a href="https://github.com/lgsvl/simulator/issues/488" target="_blank" rel="external">lgsvl issues hub</a>.</p>
<h3 id="VOLUME-in-dockerfile"><a href="#VOLUME-in-dockerfile" class="headerlink" title="VOLUME in dockerfile"></a>VOLUME in dockerfile</h3><p>the following sample is from <a href="https://stackoverflow.com/questions/41935435/understanding-volume-instruction-in-dockerfile" target="_blank" rel="external">understand VOLUME instruction in Dockerfile</a></p>
<p>create a Dockerfile as: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">FROM openjdk</div><div class="line">VOLUME vol1 /vol2</div><div class="line">CMD [&quot;/bin/bash&quot;]</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">docker build -t vol_test . </div><div class="line">docker run --rm -it vol_test</div></pre></td></tr></table></figure>
<p>check in the container, <code>vol1</code>, <code>vol2</code> does both exist in the running container.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">bash-4.2# ls </div><div class="line">	bin   dev  home  lib64	mnt  proc  run	 srv  tmp  var	 vol2</div><div class="line">	boot  etc  lib	 media	opt  root  sbin  sys  usr  vol1</div></pre></td></tr></table></figure>
<p>also check in host terminal:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:~# docker volume ls </div><div class="line">DRIVER              VOLUME NAME</div><div class="line">local               0ffca0474fe0d2bf8911fba9cd6b5875e51abe172f6a4b3eb5fd8b784e59ee76</div><div class="line">local               7c03d43aaa018a8fb031ef8ed809d30f025478ef6a64aa87b87b224b83901445</div></pre></td></tr></table></figure>
<p>and check further: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:/var/lib/docker/volumes# ls </div><div class="line">0ffca0474fe0d2bf8911fba9cd6b5875e51abe172f6a4b3eb5fd8b784e59ee76  metadata.db</div><div class="line">7c03d43aaa018a8fb031ef8ed809d30f025478ef6a64aa87b87b224b83901445</div></pre></td></tr></table></figure>
<p>once <code>touch ass_file</code> under container <code>/vol1</code>, we can find immediately in host machine at <code>/var/lib/docker/volumes</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:/var/lib/docker/volumes/0ffca0474fe0d2bf8911fba9cd6b5875e51abe172f6a4b3eb5fd8b784e59ee76/_data# ls -lt </div><div class="line">total 0</div><div class="line">-rw-r--r-- 1 root root 0 Nov  7 11:40 css_file</div><div class="line">-rw-r--r-- 1 root root 0 Nov  7 11:40 ass_file</div></pre></td></tr></table></figure>
<p>also if deleted file from host machine, it equally delete from the runnning container. The <code>_data</code> folder is also referred to as a <code>mount point</code>.  Exit out from the container and list the volumes on the host. They are gone. We used the –rm flag when running the container and this option effectively wipes out not just the container on exit, but also the volumes.</p>
<h3 id="sync-localhost-folder-to-container"><a href="#sync-localhost-folder-to-container" class="headerlink" title="sync localhost folder to container"></a>sync localhost folder to container</h3><p>by default, Dockerfile can not map to a host path, when trying to bring files in from the host to the container during runtime. namely, The Dockerfile can only specify the destination of the volume.  for example, we expect to sync a localshost folder e.g. <code>attach_me</code> to container, by <code>cd /path/to/dockfile &amp;&amp; docker run -v /attache_me -it vol_test</code>. a new data volume named <code>attach_me</code> is, just like the other <code>/vol1</code>, <code>/vol2</code> located in the container, but this one is totally nothing to do with the localhost folder. </p>
<p>while a trick can do the sync:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -it -v $(pwd)/attach_me:/attach_me vol_test</div></pre></td></tr></table></figure>
<p>Both sides of the <code>:</code> character expects an absolute path. Left side being an absolute path on the host machine, right side being an absolute path inside the container.</p>
<h3 id="volumes-in-compose"><a href="#volumes-in-compose" class="headerlink" title="volumes in compose"></a>volumes in compose</h3><p>which is only works during compose build, and has nothing to do with docker container.</p>
<h3 id="copy-folder-from-host-to-container"><a href="#copy-folder-from-host-to-container" class="headerlink" title="copy folder from host to container"></a>copy folder from host to container</h3><ul>
<li>COPY in dockerfile</li>
</ul>
<p>ERROR: Service ‘lg-run’ failed to build: COPY failed: stat /var/lib/docker/tmp/docker-builder322528355/home/wubantu/zj/simulator201909/build: no such file or directory</p>
<p>the solution is to keep the folder in Dockerfile’s current pwd; if else, Docker engine will look from <code>/var/lib/docker/tmp</code>.</p>
<h3 id="VOLUME-summary"><a href="#VOLUME-summary" class="headerlink" title="VOLUME summary"></a>VOLUME summary</h3><p>If you do not provide a volume in your run command, or compose file, the only option for docker is to create an anonymous volume. This is a local named <code>volume with a long unique id</code> for the name and no other indication for why it was created or what data it contains. If you override the volume, pointing to a named or host volume, your data will go there instead.</p>
<p>when <code>VOLUME</code> in DOCKERFILE, it actually has nothing to do with current host path, it actually generate something in host machine, located at <code>/var/lib/docker/volumes/</code>, which is nonreadable and managed by Docker Engine. also don’t forget to use <code>--rm</code>, which will delete the attached volumes in host when the container exit.</p>
<p><a href="https://stackoverflow.com/questions/41935435/understanding-volume-instruction-in-dockerfile" target="_blank" rel="external">warning: VOLUME breaks things</a></p>
<h3 id="understand-docker-compose-yml"><a href="#understand-docker-compose-yml" class="headerlink" title="understand docker-compose.yml"></a>understand docker-compose.yml</h3><p><a href="https://www.ionos.com/community/server-cloud-infrastructure/docker/understanding-and-managing-docker-container-volumes/" target="_blank" rel="external">Understand and manage Docker container volumes</a></p>
<p><a href="https://www.lunarg.com/vulkan-sdk/" target="_blank" rel="external">what is vulkan SDK</a></p>
<p><a href="https://www.wihlidal.com/blog/graphics/2019-05-28-vk-rust-ray-tracing-hlsl/" target="_blank" rel="external">Graham blog</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/06/build-cluster-on-Docker-swarm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/06/build-cluster-on-Docker-swarm/" itemprop="url">build cluster on Docker swarm</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-11-06T07:10:03-05:00">
                2019-11-06
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/11/06/build-cluster-on-Docker-swarm/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/11/06/build-cluster-on-Docker-swarm/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Docker-micro-services"><a href="#Docker-micro-services" class="headerlink" title="Docker micro services"></a>Docker micro services</h3><p><a href="https://docs.docker.com/v17.09/engine/swarm/key-concepts/#services-and-tasks" target="_blank" rel="external">key concepts in Docker</a></p>
<p>when deploy an application(lg-sim) to swarm cluster as a service, which is defined in a/the manager node, the manager node will dispatch units of work as taskes to worker nodes.</p>
<p>when create a service, you specify which container image to use and which commands to execute inside runing containers. In the <code>replicated services</code>, the swarm manager distributes a specific number of replica tasks among the nodes based upon the scale you set in the desired state. For <code>global services</code>, the swarm runs one task for the service on every available node in the cluster.</p>
<p><img src="https://docs.docker.com/v17.09/engine/swarm/images/swarm-diagram.png" alt="docker node"></p>
<h4 id="Docker-swarm-CLI-commands"><a href="#Docker-swarm-CLI-commands" class="headerlink" title="Docker swarm CLI commands"></a>Docker swarm CLI commands</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">docker swarm init </div><div class="line">docker swarm join</div><div class="line">docker service create  --name  --env --workdir --user</div><div class="line">docker service inspect </div><div class="line">docker service ls </div><div class="line">docker service rm</div><div class="line">docker service scale </div><div class="line">docker service ps</div><div class="line">docker service update  --args</div><div class="line">docker node inspect </div><div class="line">docker node update --label-add </div><div class="line">docker node promote/demote </div><div class="line"># run in worker</div><div class="line">docker swarm leave</div><div class="line"># run in manager</div><div class="line">docker node rm worker-node</div><div class="line">docker ps  #get running container ID</div><div class="line">docker exec -it containerID /bin/bash</div><div class="line">docker run -it</div><div class="line">docker-compose up build/run</div></pre></td></tr></table></figure>
<h4 id="delete-unused-Docker-network"><a href="#delete-unused-Docker-network" class="headerlink" title="delete unused Docker network"></a>delete unused Docker network</h4><p>as Docker network may confuse external when access to the local network interfaces, sometimes need to remove the docker networks.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">docker network ls</div><div class="line">docker network disconnect -f  &#123;network&#125; &#123;endpoint-name&#125;</div><div class="line">docker network rm </div><div class="line">docker stop $(docker ps -a -q)</div><div class="line">docker rm $(docker ps -a -q)</div><div class="line">docker volume prune </div><div class="line">docker network prune</div></pre></td></tr></table></figure>
<p>the above scripts will delete the unused(non-active) docker network, then may still active docker related networks, which can be deleted through:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">sudo ip link del docker0</div><div class="line">``` </div><div class="line"></div><div class="line"></div><div class="line">### access Docker service </div><div class="line"></div><div class="line">Docker container has its own virutal IP(172.17.0.1) and port(2347), which allowed to access in the host machine; for externaly access, need to map the hostmachine IP to docker container, by `--publish-add`. the internal communication among docker nodes are configured by `advertise_addr` and `listen-addr`.</div><div class="line"></div><div class="line"></div><div class="line">#### through IP externaly</div><div class="line">To publish a service’s ports externally, use the --publish &lt;PUBLISHED-PORT&gt;:&lt;SERVICE-PORT&gt; flag. When a user or process connects to a service, any worker node running a service task may respond.</div><div class="line"></div><div class="line">taking example from [5mins series](https://www.cnblogs.com/CloudMan6/tag/Swarm/)</div></pre></td></tr></table></figure>
<p>docker service create –name web_server –replicas=2 httpd<br>docker service ps web_server </p>
<h1 id="access-service-only-on-host-machine-through-the-Docker-IP"><a href="#access-service-only-on-host-machine-through-the-Docker-IP" class="headerlink" title="access service only on host machine through the Docker IP"></a>access service only on host machine through the Docker IP</h1><p>curl 172.17.0.1<br>docker service update –publish-add 8080:80 web_server</p>
<h1 id="access-service-externally"><a href="#access-service-externally" class="headerlink" title="access service externally"></a>access service externally</h1><p>curl <a href="http://hostmachineIP:8080" target="_blank" rel="external">http://hostmachineIP:8080</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#### configure websocket protocol</div><div class="line"></div><div class="line">for lg-sim server to pythonAPI client, which is communicated through `websocket`, it&apos;s better if the service can be configured to publish through websocket.</div><div class="line"></div><div class="line"></div><div class="line">#### publish httpd server to swarm service</div></pre></td></tr></table></figure></p>
<p>docker service create –name web_server –publish 880:80 –replicas=2  httpd<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">the container IP is IP in network interface `docker0`(e.g. 172.17.0.1), which can be checked through `ifconfig`.  `80` is the default port used by httpd, which is mapped to the host machine `880` port. so any of the following will check correctly:</div></pre></td></tr></table></figure></p>
<p>curl 172.17.0.1:880<br>curl localhost:880<br>curl 192.168.0.1:880<br>curl 192.168.0.13:880 #the other docker node<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"> </div><div class="line">#### publish lg-sim into swarm service </div><div class="line"></div><div class="line">the previous version(2019.04) of lg-sim doesn&apos;t have a http server built-in, since 2019.7, they have `Nancy http server`, which is a great step toward dockerlize the lg-sim server.</div><div class="line"></div><div class="line"></div><div class="line">### manage data in Docker </div><div class="line"></div><div class="line">`Volumes` are stored in a part of the host filesystem, which is located `/var/lib/docker/volumes`, which is actually managed by Docker, rather than by host machine.</div><div class="line">Volumes are the preferred way to [persist data in Docker](https://docs.docker.com/v17.09/engine/admin/volumes/#more-details-about-mount-types) containers and services. some use cases of volume:</div><div class="line"></div><div class="line">* once created, even the container stops or removed, the volume still exist.</div><div class="line">* multiple containes can mount the same voume simultaneously; </div><div class="line">* when need to store data on a remote host </div><div class="line">* when need to backup, restore, or migrate data from one Dockr to another</div><div class="line"></div><div class="line">#### RexRay</div><div class="line"></div><div class="line">an even high-robost way is to separate volume manager and storge provider manager. [Rex-Ray](https://rexray.readthedocs.io/en/v0.3.3/)</div></pre></td></tr></table></figure></p>
<p>docker service create –name web_s \<br>    –publish 8080:80 \<br>    –mount “type=volume, volume-driver=rexray, source=web_data, target=/usr/local/apache2/htdocs” \<br>    httpd</p>
<p>docker exec -it containerID<br>ls -ld /usr/local/apahce2/htdocs<br>chown www-data:www-data </p>
<h2 id="test-visit"><a href="#test-visit" class="headerlink" title="test visit"></a>test visit</h2><p>curl <a href="http://192.168.0.1:8080" target="_blank" rel="external">http://192.168.0.1:8080</a><br>docker inspect containerID </p>
<p>```</p>
<p><code>source</code> reprensents the name of data volume, if null, will create new<br><code>target</code> reprensents data volume will be mounted to <code>/usr/local/apache2/htdocs</code> in each container</p>
<p>in RexRay, data volume update, scale, failover(when any node crashed, the data volume won’t lose) also be taken care.</p>
<h3 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h3><p><a href="https://www.cnblogs.com/CloudMan6/tag/Swarm/" target="_blank" rel="external">5mins in Docker</a></p>
<p><a href="https://www.bookstack.cn/read/docker-swarm-guides/kai-shi-shi-yong-swarm-swarmmo-shi-duan-kou-lu-you.md" target="_blank" rel="external">Docker swarm in and out</a></p>
<p><a href="https://boxboat.com/2016/08/17/whats-docker-swarm-advertise-addr/" target="_blank" rel="external">what is swarm advertise-addr</a></p>
<p><a href="https://www.reddit.com/r/docker/comments/a5kbte/run_docker_exec_over_a_docker_swarm/" target="_blank" rel="external">can ran exec in swarm</a></p>
<p><a href="https://stackoverflow.com/questions/39362363/execute-a-command-within-docker-swarm-service" target="_blank" rel="external">execute a command within docker swarm service</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/05/Linux-network-tool/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/05/Linux-network-tool/" itemprop="url">Linux network tool</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-11-05T08:11:11-05:00">
                2019-11-05
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/11/05/Linux-network-tool/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/11/05/Linux-network-tool/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Linux-network-commands"><a href="#Linux-network-commands" class="headerlink" title="Linux network commands"></a>Linux network commands</h2><h3 id="ip"><a href="#ip" class="headerlink" title="ip"></a>ip</h3><p><a href="https://www.computerhope.com/unix/ip.htm" target="_blank" rel="external">ip</a> command is used to edit and display the configuration of network interfaces, routing, and tunnels. On many Linux systems, it replaces the deprecated ifconfig command.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">ip link  del docker0   # delete a virtual network interface </div><div class="line">ip addr add 192.168.0.1  dev eth1  #assign IP to a specific interface(eht1)</div><div class="line">ip addr show #check network interface </div><div class="line">ip addr del 192.168.0.1 dev eth1 </div><div class="line">ip link set eth1 up/down</div><div class="line">ip route [show] </div><div class="line">ip route add 192.168.0.1 via 10.10.20.0 dev eth0  #add static route 192.168.0.1</div><div class="line">ip route del 192.168.0.1  #remove static route</div><div class="line">ip route add default via 192.168.0.1 # add default gw</div></pre></td></tr></table></figure>
<h3 id="netstate"><a href="#netstate" class="headerlink" title="netstate"></a>netstate</h3><p><a href="https://www.ibm.com/support/knowledgecenter/en/ssw_aix_72/n_commands/netstat.html" target="_blank" rel="external">netstate</a> used to display active sockets/ports for each protocol (tcp/ip)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">netstat -lat </div><div class="line">netstat -us</div></pre></td></tr></table></figure>
<h3 id="nmcli"><a href="#nmcli" class="headerlink" title="nmcli"></a>nmcli</h3><p><a href="https://developer.gnome.org/NetworkManager/stable/nmcli.html" target="_blank" rel="external">nmcli</a> is a Gnome command tool to control NetworkManager and report network status: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">nmcli  device status </div><div class="line">nmcli connection show =</div></pre></td></tr></table></figure>
<h3 id="route"><a href="#route" class="headerlink" title="route"></a>route</h3><p><a href="http://www.softpanorama.org/Net/Netutils/route_in_linux.shtml" target="_blank" rel="external">route</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">route  ==&gt;  ip route (modern version) ##print router </div><div class="line">route add -net sample-net gw 192.168.0.1 </div><div class="line">route del -net link-local netmask  255.255.0.0  #delete a virtual network interface </div><div class="line">ip route flush  # flashing routing table</div></pre></td></tr></table></figure>
<h3 id="tracepath"><a href="#tracepath" class="headerlink" title="tracepath"></a>tracepath</h3><p><a href="https://www.linux.org/docs/man8/tracepath.html" target="_blank" rel="external">tracepath</a> is used to traces path to a network host discovering MTU along this path. a modern version is <code>traceroute</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">tracepath 192.168.0.1 </div><div class="line">``` </div><div class="line"></div><div class="line">### networking service</div></pre></td></tr></table></figure>
<p>systemctl restart networking<br>/etc/init.d/networking restart </p>
<h1 id="or"><a href="#or" class="headerlink" title="or"></a>or</h1><p>service NetworkManager stop<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">## network interface </div><div class="line"></div><div class="line">location at `/etc/network/interfaces` </div><div class="line"></div><div class="line">`eno1` is onboard Ethernet(wired) adapter. if machines has already `eth1` in its config file, for the second adapter, it will use `eno1` rather than using `eth2`.</div><div class="line"></div><div class="line">[ifconfig](https://www.ibm.com/support/knowledgecenter/ssw_aix_71/i_commands/ifconfig.html) is used to set up network interfaces such as Loopback, Ethernet network interface: a software interface to networking hardware, e.g.  physical or virtual. physical interface, such as `eth0`, namely Ethernet network card. virtual interface such as `Loopback`, `bridges`, `VLANs` e.t.c.</div></pre></td></tr></table></figure></p>
<p>ifconfig -a<br>ifconfig eth0  #check specific network interface<br>ifconfig eth0 192.168.0.1 #assign static IP address to network interface<br>ifconfig eth0 netmask 255.255.0.0 #assign netmask </p>
<p>ifconfig docker0 down/up </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">replaced by `ip` command later.</div><div class="line"></div><div class="line"></div><div class="line">### why enp4s0f2 instead of eth0</div><div class="line"></div><div class="line">[change back to eth0](https://www.itzgeek.com/how-tos/mini-howtos/change-default-network-name-ens33-to-old-eth0-on-ubuntu-16-04.html)</div><div class="line"></div><div class="line">```shell</div><div class="line"></div><div class="line">lspci | grep -i &quot;net&quot;</div><div class="line"></div><div class="line">dmesg | grep -i eth0</div><div class="line"></div><div class="line">ip a </div><div class="line"></div><div class="line">sudo vi /etc/default/grub</div><div class="line">	GRUB_CMDLINELINUX=&quot;net.ifnames=0 biosdevname=0&quot;</div><div class="line">update-grub</div><div class="line"></div><div class="line"># update  /etc/network/interfaces </div><div class="line"></div><div class="line">auto eth0</div><div class="line">iface eth0  inet static </div><div class="line"></div><div class="line">sudo reboot</div></pre></td></tr></table></figure>
<h3 id="Unknown-interface-enp4s0f2"><a href="#Unknown-interface-enp4s0f2" class="headerlink" title="Unknown interface enp4s0f2"></a>Unknown interface enp4s0f2</h3><p>due TO <code>/etc/network/interfaces</code> has <code>auto enp4s0f2</code> line, which always create this network interface , when restart the networking service.</p>
<h3 id="ping-hostname-with-docker0"><a href="#ping-hostname-with-docker0" class="headerlink" title="ping hostname with docker0"></a>ping hostname with docker0</h3><p>usually there may be have multi network interfaces(eth0, docker0, bridge..) on a remote host, when ping this remote host with exisiting docker network (<code>docker0</code>), by default will talk to the docker0, which may not the desired one.</p>
<h2 id="build-LAN-cluster-with-office-PCs"><a href="#build-LAN-cluster-with-office-PCs" class="headerlink" title="build LAN cluster with office PCs"></a>build LAN cluster with office PCs</h2><ul>
<li>setup PC IPs</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">master node: </div><div class="line">IP Address:  192.168.0.1 </div><div class="line">netmask: 24</div><div class="line">Gateway: null</div><div class="line">DNS serer:  10.3.101.101 </div><div class="line"></div><div class="line"></div><div class="line">worker node:</div><div class="line"></div><div class="line">IP address:  192.168.0.12</div><div class="line">netmask: 24</div><div class="line">Gateway: 192.168.0.1</div><div class="line">DNS: 10.255.18.3</div><div class="line"></div><div class="line">``` </div><div class="line"></div><div class="line">* `ufw disable` </div><div class="line"></div><div class="line">*  update `/etc/hosts` file:</div></pre></td></tr></table></figure>
<pre><code>192.168.0.1 master
192.168.0.12 worker 
</code></pre><pre><code>if need to update the default hostname to `worker`, can modify `/etc/hostname` file, and reboot.

* ping test :

```script 

ping -c 3 master 
ping -c 3 worker
</code></pre><ul>
<li>set ssh access(optionally)</li>
</ul>
<pre><code class="script">
sudo apt-get install openssh-server 
ssh-keygen -t rsa 
# use custmized key
cp rsa_pub.key authorized_key
</code></pre>
<h2 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h2><p><a href="https://www.cyberciti.biz/faq/ubuntu-linux-add-static-routing/" target="_blank" rel="external">Ubuntu add static route</a></p>
<p><a href="https://www.tecmint.com/ip-command-examples/" target="_blank" rel="external">10 useful IP commands</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/29/未来5年在哪里11/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/29/未来5年在哪里11/" itemprop="url">未来5年在哪里11</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-29T10:39:40-04:00">
                2019-10-29
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/10/29/未来5年在哪里11/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/10/29/未来5年在哪里11/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>真实一直有隐藏的一面，而那些窥视过隐藏面的人，注定于大多数人不同，光鲜或者孤独。想想不甘心做韭菜又上升无望的漫漫岁月，简直注定了人生悲剧。</p>
<h3 id="脆弱的感情"><a href="#脆弱的感情" class="headerlink" title="脆弱的感情"></a>脆弱的感情</h3><p>自以为是个单纯的人，所以喜欢工程师氛围、高校科研氛围、美国的社区文化。回到国内，这些氛围都找不到了。扑面而来的气息，显得很黑暗森林。我怀疑一个单纯的人，在这样的环境下，如何能生存。所以，花尽心思去思考怎么顺应社会。话语中，充满了数字和术语，像一个机器在聊天，而不是一个有感情的人，女生都没办法接近我这样的人。</p>
<p>谈女生总会到一个话题，你稳定了吗。这个”未来5年“系列已经过了一年了，换环境、换公司、换小方向，到底有什么本质的变化，确定了一个方向，确定了一些问题吗？实际上都没有，甚至还没清楚自己要在哪里（国家、城市），做什么行业（汽车、咨询），都是一些自定义的限制。</p>
<h3 id="小城市的行业"><a href="#小城市的行业" class="headerlink" title="小城市的行业"></a>小城市的行业</h3><p>回来的火车上，遇见了小城的公务员一家去武汉旅游。他们在当地的审计局工作，每年有一些培训在全国各地，比如，南京、武汉。然后一年还有5～10天年薪假。所以一年会有一两次国内的旅行，长一个月，短半个月的。他们的工资在5千 ～ 6千，小城市买了房子，买了10几万的德国/日本车；单位同事，家底好的可以开30-40万的abb。</p>
<ul>
<li>体系内</li>
</ul>
<p>学校、医院、法务机关、警察、税务、工商、建设、银行、电力、通信、交通、烟草、农林牧渔等等，庞大的网络可以解决三四线城市大量优质年轻人就业，因为是政府机关，在这些组织里面的年轻人，自然是党国的忠实跟随者。他们拿着高于当地平均值的工资，足够在小城市活的衣食无忧，甚至如上面的小夫妻，有车有房，有一年两次的度假。相比，大城市里租房、加班、年假等于零的奋斗青年，简直是苦逼。</p>
<ul>
<li>体系外</li>
</ul>
<p>三四线城市，（政府）体系以外的行业典型： 美容养生、学生教育、餐饮、休闲娱乐（电影、健身、文化项目）、汽修、服装、家具，是属于可以创业的行当。江浙以外，很少有三四线城市有自己的传统支柱产业，比如，农产品加工、能源石化、机械加工、小商品生产等等；更鲜有高附加值支柱产业，诸如，电子器件产业群、芯片产业群、汽车产业群、生物制药产业群、it产业群、精密制造产业群、金融服务业等等。</p>
<p>小城就一家国有钢铁厂，因为北方的能源、钢铁产能过剩，也气数不多。在这些小城市发展高附加值的产业，相当于空中楼阁。所以，体系外的年轻人生存状态其实很空心化。</p>
<ul>
<li>空心化</li>
</ul>
<p>“空心化”不是对服务业的贬低，但是相比发达欧美国家的小城市，它们会有一些其貌不扬，但历史百年的世界级的公司和产品。比如，德国狼堡，世界汽车产业中心；美国密西根奥本山小镇，世界级汽车应用软件商聚集地。生活在这些地方的年轻人，当然可以选择进入当地的服务业，诸如快餐连锁、超市服装、甚至房租装修、水电工等等。但是对于做研究、懂技术的年轻人，他们也能找到很容易进入一个创造绝对价值的公司。国内三四线小城市的“空心化”，就是除了传统的服务行业以及政府体系可以吸纳年轻人之外，缺乏生产绝对价值的支柱公司。</p>
<p>倒逼年轻人只能进入传统服务业或者政府机构，能够发挥年轻人创作力的机会太少了。服务业是景上添花，没有高附加值制造业的世界地位，服务业只会被局限在传统的衣食住行。这样一个显著的问题，就是影响了年轻人的价值体系。研究生毕业以后，收入水平、价值实现竟然不如隔壁小学毕业开早点的王老二。那国家投入这么多教育，是为了让这些年轻人去自卑吗。</p>
<ul>
<li>结局</li>
</ul>
<p>愚民之策，老百姓根本看不到问题，实际上在短期内，服务业是滞后价值创造产业的。开早点的王老二，还可以一个月赚5万，而且不需要为一个大学毕业生买单。长远点，低端/传统服务业，比如餐厅、修车店、服装店会慢慢饱和，甚至开展恶性竞争。每家新开的餐厅，头两个月可以吸引顾客，之后就被隔壁新开的餐厅带流量了。</p>
<p>一旦大部分传统服务行业进入这个阶段，除了政府直接控制的体系内，老百姓可能就受不了。要么政府强行维稳，全国陷入“中等收入陷阱”。要么社会就会开始乱。</p>
<p>中国有大量的三四线城市，可能都面对“空心化”的问题。大概率进入“中等收入陷阱”。看到问题而又无奈的人，会选择在这场演化之前逃离。国家层面的软实力，不是一天能建立起来的。这恐怕也是中国虽然有着表面的gdp数据，但实际上社会系统相比成熟的发达国家还差很远的地方。如果在演进之前，能慢慢发展出好的系统话。</p>
<h3 id="自动驾驶失业潮"><a href="#自动驾驶失业潮" class="headerlink" title="自动驾驶失业潮"></a>自动驾驶失业潮</h3><p>有预测，到2030年，l3+自动驾驶的行业渗透可能只在10%。相比普遍的乐观预测，到2020年以后，l3+前装量产。国内近来发了一些很政策导向的产业牌照：全球第一张5G商用牌照， 全球第一张自动驾驶商用牌照。相比，苹果在2020年都不会上5G，美国撤销自动驾驶交通委员会。到底是国内领先，还是国家在画大饼？要保障这么多新生劳动力进入市场，国家也很南啊。</p>
<p>政策可以画行业大饼，但市场比政策更理性。waymo已经被资本市场降低估值，应该就是市场对这个行业的真实回应。按照资本的延后性，大概这个行业的裁员潮会尾随而来。</p>
<p>如果失业了，新职业选择在哪里？变化是永恒的。越是高级的打工仔，受裁员影响越高。在互联网级的快速迭代市场，专业的深度也许不如专业的可移植性对打工仔更合适。</p>
<h3 id="进军服务业"><a href="#进军服务业" class="headerlink" title="进军服务业"></a>进军服务业</h3><p>看《中国机长》又一次加深的这样的体会。飞机设计、航空发动机、自动驾驶飞控系统是远在普通人的关心之外的；相比，机长、空姐、机场运营人员、服务人员容纳着大量就业，也最直接产生价值。而且他们服务产生的价值，也是经济活力的主要贡献和决定者。相比，虽然国家没有自主的民航发动机、没有自主的cae软件，谁又觉得有什么问题呢。不过是一小群人为此担忧，大部分百姓甚至政策决策者只需要看到中国的航运数据又上升了，航运公司对各地gdp的贡献又大了，就可以士气高涨。</p>
<p>离客户越近，价值越大。在核心技术没有先发优势的市场，做技术只是backup的需求。相比，服务业更靠近广大终端客户人群，价值传递最短、损耗最小、获利最大。所以，空心化后的精英都会去高附加值服务业，比如，金融、互联网。</p>
<p>我们确实不该操政策精英的心，相比，做一个短视的普通人，识时务，进挣钱的行业，就是普通人该干的。</p>
<p>所以，还是要好好准备mba。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/29/未来5年在哪里-12/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/29/未来5年在哪里-12/" itemprop="url">未来5年在哪里 12</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-29T10:21:29-04:00">
                2019-10-29
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/10/29/未来5年在哪里-12/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/10/29/未来5年在哪里-12/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>国内工作半年了，先后对开源的仿真软件做了定制化实现，对高精地图、ros、场景定义等有了大量快速的接触。同时也搭建了团队的gitlab, jenkins服务, rosbag管理服务、webviz服务，pg地图服务等等，并且也投入了一些时间去搭建数据基础框架，但并没有实际业务需求。在传统oem，用DevOps去规范开发流程，以及探索数据业务、云服务等相对较新颖。相对，新兴的造车企业，会比较好的融合DevOps流程，开发上云。</p>
<p>本质上是开发ADS支撑工具及数据基础设施，但由于OEM内部的ads开发团队比较弱，这些支撑工具以及数据工具并不发挥价值。作为工具开发者，存在感会变弱。因为离核心业务较远，虽然技术很通用。</p>
<h3 id="OEM’s-role-in-emerging-tech"><a href="#OEM’s-role-in-emerging-tech" class="headerlink" title="OEM’s role in emerging tech"></a>OEM’s role in emerging tech</h3><p>OEM itself mostly doesn’t build tools itself, even like Ford, who hired a great team to develop CAE tools in early days and build them tremendous, still retired most of them or sell them as packages to pure software vendors later.</p>
<p>on the other side, the pioneers or leaders of the industry, usually build and apply new methodlogy before the market is there. and after the market is there, they can have the professional team to take in charge. the leaders take the role as incubators, as many Internet startups got the ideas from giants e.g. Google, Facebook e.t.c</p>
<p>ADS at this moment is the emerging tech, there is no mature solution or tool chain for ADS, so the leaders of automobile makers and suppliers are the guys who should take the lead to set up standards and tools till ADS market goes to mature. and the giants in automobile should catch this great opportunity to take control in long term. </p>
<p>the problems of Chinese OEMs (sadly there is no strong Chinese suppliers yet),  they are customed to be followers, when US or German auto makers do the research and make the new bussiness stratagey, Chinese OEMs will follow.  as the blog said, Chinese has no friend, neither Chinese goverment.  be the followers or imitators is minimal loss strategy for most Chinese companies as well.  and this is also why west coutry companies are afriad of the competition from Chinese. Chinese take copy others ideas as a strategy to success, rather than a shame.</p>
<h3 id="a-tool-developer"><a href="#a-tool-developer" class="headerlink" title="a tool developer"></a>a tool developer</h3><p>机缘巧合，职业最初，就属于工具支撑组，开发和维护工具。随着，ads的爆发，more and more software skills are required by tradititional automobile makers and suppliers; and they prefer transfer themselves to modern digital driven. but a special tool is never the core product of auto makers. </p>
<p>there comes a time, the OEM engineers asked, why you guys build tools, rather than buy from suppliers. The right thing for OEMs is to integrate components, rather than building tools. </p>
<p>the cost of building tools by OEM itself is really too much after a while we realized. But at first, OEMs thought it was too costy to buy commecial tools, which gives survival space of a small team to grow inside OEM teams.</p>
<p>actually at the early time, small team dreams big, especially in these days, many open source projects can be used freely. the small team almost support every aspect related to software tools, and as well to add features to simulation platform, which is also based on an open source project <a href="https://github.com/lgsvl/simulator" target="_blank" rel="external">lg-sim</a>, <code>software manager</code> looks like a good role in the team. but the reality is, to customize any tool, will cost a huge energy for a small team, as we are not involved in these open source projects. more, the manager team doesn’t consider an independent tool team. and even like this, we are moving slowly.</p>
<h3 id="infrasturcture-for-ABC"><a href="#infrasturcture-for-ABC" class="headerlink" title="infrasturcture for ABC"></a>infrasturcture for ABC</h3><p>for ADS startups, they emphasize their infrasturcture features with : </p>
<ul>
<li>cloud platform </li>
<li>remote monitor/control system (for vehicle team management) </li>
<li>OTA </li>
<li>data infrastructure(storage, management, analysis)</li>
</ul>
<p>and in single vehicle features with powerful computing ability, from GTC 2018 speak, most startup use the powerful Xdriver GPU；</p>
<ul>
<li>WeRide </li>
<li>Momenta</li>
<li>Tusimple</li>
<li>AutoX </li>
<li>Roadstar.AI (dead)</li>
<li>plusAI</li>
<li>ponyAI</li>
</ul>
<p>all these looks very Internet, but too far from massive vehicle product. the other mind is these teches are actually common for average engineers, but the chanllenge is to build a team, to realy make it work.</p>
<h3 id="survive-in-OEM"><a href="#survive-in-OEM" class="headerlink" title="survive in OEM"></a>survive in OEM</h3><p>it’s maybe more interested to take myself as an ABC(AI, big data, cloud computing) guy to find application scenarios in automobile industry product development. while ABC application scenarios are not matured yet of course, usually it is driven by leader teams, when it comes to drive by market, may be too late. </p>
<p>beyond automotive, industry IoT maybe an even general domain to quickly apply ABCs. there should be three steps:</p>
<ul>
<li><p>familiar with the tech methods</p>
</li>
<li><p>understand the hurting points of the industry </p>
</li>
<li><p>product and management update -&gt; value return </p>
</li>
</ul>
<p>the life leap happens to a few lucky guys. most guys are common and grow in a linear speed. there is a burden the more you know, the harder your life. sadly … </p>
<h3 id="digitalize"><a href="#digitalize" class="headerlink" title="digitalize"></a>digitalize</h3><p>OEMs are involved more and more in transfering digital, smart. previously most invovled in market, ads strategy, supply chain management; and as connected vehicles, self driving, future mobility service bursting in recent years, digitalization is sinking in vehicle product R&amp;D. AI, big data, cloud, blockchain e.t.c. new techs will be transfering the traditional industry. hopefully we can define the new bussniess together.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/22/lg-sim-source-code-review-2019-09/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/22/lg-sim-source-code-review-2019-09/" itemprop="url">lg-sim source code review (2019.09)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-22T09:02:53-04:00">
                2019-10-22
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/10/22/lg-sim-source-code-review-2019-09/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/10/22/lg-sim-source-code-review-2019-09/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>the recent version of lg-sim <a href="https://github.com/lgsvl/simulator" target="_blank" rel="external">2019.09</a> has additionally support for webUI, cloud, which is a big enhencement. the following code review is focusing on new components to support WebUI, cluster management.</p>
<h2 id="database"><a href="#database" class="headerlink" title="database"></a>database</h2><p>database used <code>sqlite</code> project, which is an embedded in-memory db; the ORM used <code>PetaPoco</code> project; there are a few db related serices, e.g.  vehicleService, simulationService, which will be used in RESTful web request.</p>
<ul>
<li><code>DatabaseManager</code>:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">static IDatabaseBuildConfiguration  DbConfig ;</div><div class="line"></div><div class="line">Init()&#123;</div><div class="line"></div><div class="line">	DbConfig = GetConfig(connectionString)</div><div class="line">	using  db =  new SqliteConnection(connectionString)&#123;</div><div class="line">		db.Open()</div><div class="line">&#125;</div><div class="line"></div><div class="line">CreateDefaultDbAssets()&#123;</div><div class="line"></div><div class="line">	using db = Open() </div><div class="line">	if (info.DownloadEnvs != null)&#123;</div><div class="line">		map =  new MapModel()&#123;url = url  LocalPath=localPath;&#125;</div><div class="line">		id =  db.Insert(map)</div><div class="line">	&#125;</div><div class="line">		</div><div class="line">	if (info.DownloadVehicles != null)&#123;&#125;</div><div class="line"></div><div class="line">	if(defaultMap.HasValue)</div><div class="line">	&#123;</div><div class="line">		sim1 = new SimulationModel()&#123; Cluster=0,  Map=defaultMap.Value,   ApiOnly=false&#125;;</div><div class="line">		AddSimulation(db, sim1, noBridgeVehicle);</div><div class="line">		AddSimulation(db, sim, apolloVehicle);</div><div class="line">		db.Insert(simx)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">AddSimulation(IDatabase db, sim,vehicle)&#123;</div><div class="line">	conn = new ConnectionModel()&#123;</div><div class="line">		simulation = id,</div><div class="line">		vehicle = vehicle.Value,</div><div class="line">	&#125;</div><div class="line">	db.Insert(conn)</div><div class="line">&#125;</div><div class="line"></div><div class="line">AddVehicle(db, sim,vehicle)&#123;</div><div class="line">	conn = new VehicleModel()&#123;</div><div class="line">		Url = url ,</div><div class="line">	&#125;</div><div class="line">	db.Insert(vehicle)</div><div class="line">	</div><div class="line">	return vehicle.Id;</div><div class="line">&#125;</div><div class="line"></div><div class="line">PendingVehicleDownloads()&#123;</div><div class="line">	using db=Open()&#123;</div><div class="line">		var sql =  Sql.Builder.From(&quot;vehicles&quot;).Where(&quot;status=00&quot;, &quot;Downloading&quot;);</div><div class="line">		return db.Query&lt;VehicleModel&gt;(sql);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="database-ORMs"><a href="#database-ORMs" class="headerlink" title="database ORMs"></a>database ORMs</h3><p>using <code>PetaPoco</code> to define <code>ORM</code> models, such as<br><code>users</code>, <code>sessions</code>, <code>maps</code>, <code>vehicles</code>, <code>clusters</code>, <code>simulations</code> </p>
<h4 id="PetaPoco"><a href="#PetaPoco" class="headerlink" title="PetaPoco"></a>PetaPoco</h4><p>a few operators in PetaPoco, such as <code>Page</code>, used to query a page; <code>Single</code>, used to query a single item; <code>Insert</code>; <code>Delete</code>; <code>Update</code></p>
<h3 id="database-provider"><a href="#database-provider" class="headerlink" title="database provider"></a>database provider</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">SQLiteDatabaseProvider =&gt; </div><div class="line">GetFactory(&quot;Mono.Data.Sqlite.SqliteFactory, Mono.Data.Sqlit&quot;)</div></pre></td></tr></table></figure>
<p>called inside <code>DatabaseManager::Init()</code>.</p>
<h3 id="database-services"><a href="#database-services" class="headerlink" title="database services"></a>database services</h3><ul>
<li><p>VehicleService : IVehicleService </p>
</li>
<li><p>MapService </p>
</li>
<li><p>NotificationService =&gt;  NotificationManager.SendNotification()</p>
</li>
<li><p>DownloadService =&gt;  DownloadManager.AddDownloadToQueue()</p>
</li>
<li><p>ClusterService </p>
</li>
<li><p>SessionService </p>
</li>
<li><p>SimulationService</p>
</li>
</ul>
<h2 id="Web-model"><a href="#Web-model" class="headerlink" title="Web model"></a>Web model</h2><p>web model is where WebUI server located, which is served by <code>Nancy</code> project, in which a new design metholody is applied: Inversin of Control Contaner(IoC), namely <code>控制反转</code> in chinese. IoC is used to inject implementation of class, and manage lifecycle,  dependencies.    </p>
<p>web model is the server where talk to webUI through routes, which is defined in the React project.</p>
<h3 id="Nancy"><a href="#Nancy" class="headerlink" title="Nancy"></a>Nancy</h3><p>used to build HTTP based web service,</p>
<ul>
<li>FileStream</li>
<li>StreamResponse  </li>
<li><a href="https://github.com/grumpydev/TinyIoC" target="_blank" rel="external">TinyIoC</a>   </li>
<li>UnityBootstrapper : <a href="https://github.com/NancyFx/Nancy/wiki/Bootstrapper" target="_blank" rel="external">DefaultNancyBootstrapper</a>, used to automatic discovery of modules, custm model binders, dependencies.</li>
</ul>
<ul>
<li>/Assets/Scripts/Web/Nancy/NancyUnityUtils</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">ConfigureApplicatinContainer(TinyIoCContainer container)</div><div class="line">&#123;</div><div class="line">  container.Register&lt;UserMapper&gt;();</div><div class="line">  container.Register&lt;IMapService&gt;(); </div><div class="line">  container.Register&lt;IClusterService&gt;();</div><div class="line">  container.Register&lt;IVehicleService&gt;();</div><div class="line">  container.Register&lt;ISimulationService&gt;();</div><div class="line">&#125; </div><div class="line">``` </div><div class="line"></div><div class="line">### route modules </div><div class="line"></div><div class="line">```c#</div><div class="line"></div><div class="line">SimulationModule : NancyModule()</div><div class="line">&#123;</div><div class="line">  class SimulationRequest&#123;&#125;</div><div class="line">  class SimulationResponse&#123;&#125;</div><div class="line">  </div><div class="line">  Get(&quot;/&quot;,  x=&#123;&#125;)</div><div class="line">  Post(&quot;/&quot;,  x=&#123;&#125;)</div><div class="line">  Put(&quot;/&#123;id:long&#125;&quot;, x=&#123;&#125;)</div><div class="line">  Post(&quot;/&#123;id:long&#125;/start&quot;, x=&#123;&#125;)</div><div class="line">  Post(&quot;/&#123;id:long&#125;/stop&quot;, x=&#123;&#125;)  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>inside some of the route modules will do query or update the sqlite database for special objects. till here is the complete web back-end server, with a http server and an in-memory database.</p>
<p>the webUI frontend is based on React, about React check <a href="https://zjli2013.github.io/2019/08/30/reactjs-introduction/" target="_blank" rel="external">a previous blog</a>. in the React WebUI project will have http requests corresponding to each of routes defined here. </p>
<p>React front end is very independent framework, which should be handled by an independent team in standard pipeline.</p>
<h3 id="Config-amp-Loader"><a href="#Config-amp-Loader" class="headerlink" title="Config &amp; Loader"></a>Config &amp; Loader</h3><ul>
<li>/Assets/Scripts/Web/Config.cs: </li>
</ul>
<p>used to define <code>WebHost</code>,  <code>WebPort</code>, <code>ApiHost</code>, <code>ClourUrl</code>, <code>Headless</code>, <code>Sensors</code>, <code>Bridges</code> e.t.c   </p>
<ul>
<li>Loader.cs :</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Loader Instance ;    //Loader object is never destroyed, even between scene reloads</div><div class="line"></div><div class="line">Loader.Start()&#123;</div><div class="line"></div><div class="line">	DatabaseManager.Init();</div><div class="line">	var config = new HostConfguration&#123;&#125; ;   // ?</div><div class="line">	Server = new NancyHost(Config.WebHost);</div><div class="line">	Server.Start();</div><div class="line">	DownloadManager.Init();</div><div class="line">&#125;</div><div class="line"></div><div class="line">Loader.StartAsync(simulation)&#123;</div><div class="line"></div><div class="line">	Instance.Actions.Enqueue() =&gt;</div><div class="line">	var db = DatabaseManager.Open()</div><div class="line">	AssetBundle mapBundle = null; </div><div class="line">		</div><div class="line">	simulation.Status &quot;Starting&quot; </div><div class="line">	NotificationManager.SendNotification();</div><div class="line">	Instance.LoaderUI.SetLoaderUIState();</div><div class="line"></div><div class="line">	Instance.SimConfig = new SimlationConfig()&#123;</div><div class="line">		Clusters, ApiOnly, Headless, Interative, TimeOfDay, UseTraffic...</div><div class="line">	&#125;	</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">Loader.SetupScene(simulation)&#123;</div><div class="line"></div><div class="line">	var db = DatabaseManager.Open()</div><div class="line">	foreach var agentConfig in Instance.SimConfig.Agents:</div><div class="line">		var bundlePath = agentConfig.AssetBundle </div><div class="line">		var vehicleBundle = AssetBundle.LoadfromFile(bundlePath)</div><div class="line">		var vehicleAssets = vehicleBundle.GetAllAssetNames();</div><div class="line">		agentConfig.Prefab = vehicleBundle.LoadAsset&lt;GO&gt;(vehicleAssets[0])</div><div class="line">		</div><div class="line">	var sim = CreateSimulationManager();	</div><div class="line">	Instance.CurrentSimulation = simulation </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>DownloadManager</li>
</ul>
<pre><code class="c#">
class Download();
Init(){ client = new WebClient();  ManageDownloads(); }
</code></pre>
<h2 id="network-module"><a href="#network-module" class="headerlink" title="network module"></a>network module</h2><p><code>network module</code> is used for communication among master and clients(workers) in the cluster network for cloud support. the P2P network is built on <code>LiteNetLib</code> which is a reliable UDP lib. </p>
<h3 id="LiteNetLib"><a href="#LiteNetLib" class="headerlink" title="LiteNetLib"></a>LiteNetLib</h3><p><a href="https://github.com/RevenantX/LiteNetLib" target="_blank" rel="external">LiteNetLib</a>is Udp package, used to P2P communication among master node and slave nodes here, where are defined as <code>MasterManager</code>, <code>ClientManager</code>.</p>
<p>usage of LiteNetLib can be found in the <a href="https://github.com/RevenantX/LiteNetLib/wiki/NetPacketProcessor-(NetSerializer" target="_blank" rel="external">wiki</a>-usage)</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/22/IoC-in-C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/22/IoC-in-C/" itemprop="url">IoC in C#</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-22T08:58:37-04:00">
                2019-10-22
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/10/22/IoC-in-C/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/10/22/IoC-in-C/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Inversion of Control(IoC) is a design mechanism to decouple components dependencies, a light-weight implementation is: <a href="https://github.com/grumpydev/TinyIoC" target="_blank" rel="external">TinyIoC</a>, which is also part of <a href="http://nancyfx.org" target="_blank" rel="external">Nancy</a>.  </p>
<p>IoC idea uses commonly in webUI(and backend server) apps,  which is an user friendly solution to cloud deployment management as well as apps in mobile, which should be the right direction in future ADS software tool development.</p>
<p>the idea of IoC can be explained by the following example from <a href="https://www.tutorialsteacher.com/ioc/register-and-resolve-in-unity-container" target="_blank" rel="external">register and resolve in unity container</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">public interface ICar</div><div class="line">&#123;</div><div class="line">    int Run();</div><div class="line">&#125;</div><div class="line"></div><div class="line">public class BMW : ICar</div><div class="line">&#123;</div><div class="line">    private int _miles = 0;</div><div class="line"></div><div class="line">    public int Run()</div><div class="line">    &#123;</div><div class="line">        return ++_miles;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">public class Ford : ICar</div><div class="line">&#123;</div><div class="line">    private int _miles = 0;</div><div class="line"></div><div class="line">    public int Run()</div><div class="line">    &#123;</div><div class="line">        return ++_miles;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">public class Driver</div><div class="line">&#123;</div><div class="line">    private ICar _car = null;</div><div class="line"></div><div class="line">    public Driver(ICar car)</div><div class="line">    &#123;</div><div class="line">        _car = car;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void RunCar()</div><div class="line">    &#123;</div><div class="line">        Console.WriteLine(&quot;Running &#123;0&#125; - &#123;1&#125; mile &quot;, _car.GetType().Name, _car.Run());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>the <code>Driver</code> class depends on <code>ICar</code> interface. so when instantiate the <code>Driver</code> class object, need to pass an instance of <code>ICar</code>, e.g.  BMW, Ford as following:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Driver driver = new Driver(new Ford());</div><div class="line">driver.RunCar()</div><div class="line"></div><div class="line">``` </div><div class="line"></div><div class="line"></div><div class="line">**to use IoC**, taking UnityContainer framework as example, a few other choices: TinyIoC e.t.c.</div><div class="line"></div><div class="line">```c#</div><div class="line"></div><div class="line"> var container = new UnityContainer();</div></pre></td></tr></table></figure>
<ul>
<li>Register </li>
</ul>
<p>create an object of the <code>BMW</code> class and inject it through a constructor whenever you need to inject an ojbect of <code>ICar</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">container.Register&lt;ICar, BMW&gt;();</div></pre></td></tr></table></figure>
<ul>
<li>Resolve</li>
</ul>
<p><code>Resolve</code> will create an object of the <code>Driver</code> class by automatically creating and njecting a <code>BMW</code> object in it, since previously register <code>BMW</code> type with <code>ICar</code>.</p>
<pre><code class="c#">
Driver  drv =  container.Resolve&lt;Driver&gt;();
drv.RunCar()
</code></pre>
<h3 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h3><p>there are two obvious advantages with IoC. </p>
<ul>
<li><p>the instantiate of dependent class can be done in run time, rather during compile. e.g.  <code>ICar</code> class doesn’t instantiate in <code>Driver</code> definition</p>
</li>
<li><p>automatic <code>new class</code> management in back. </p>
</li>
</ul>
<p>the power of IoC will be scaled, once the main app is depends on many little services.    </p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/21/rosbag-tools-in-ADS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/21/rosbag-tools-in-ADS/" itemprop="url">rosbag tools in ADS</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-21T06:18:47-04:00">
                2019-10-21
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/10/21/rosbag-tools-in-ADS/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/10/21/rosbag-tools-in-ADS/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="background"><a href="#background" class="headerlink" title="background"></a>background</h2><p>in ADS,  data fusion, sensor performance, L3+ perception, localization algorithms development relys a lot on physicall data collection, commonly in rosbag format with information/data about gps, rtk, camera, Lidar, radar e.t.c.</p>
<p>to build up the development process systemly is a critial thing, but also ignored by most ADS teams. for large OEMs, each section may have their own test vehicles, e.g. data fusion team,  sensor team e.t.c, but few of them take care data systematically, or build a solution to manage data. one reason is the engineers are lack of ability to give software tool feedbacks/requirements, so they still stay and survive with folders or Excel management, which is definitely not acceptable and scalable for massive product team. </p>
<p>thanks for ROS open source community conributing a great rosbag database manage tool: <a href="http://wiki.ros.org/TheBagDatabase" target="_blank" rel="external">bag_database</a>. with docker installation, this tool is really easy to configure. a few tips:</p>
<ul>
<li>web server IP port in Docker can be accessed from LAN by parameter <code>-p</code> during docker run.</li>
</ul>
<h2 id="mount-sbm-drive"><a href="#mount-sbm-drive" class="headerlink" title="mount sbm drive"></a>mount sbm drive</h2><p>as mentioned, most already collected rosbag is stored in a share drive, one way is to mount these data.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sudo mount -t cifs //share_ip_address/ROS_data /home/david/repo/rosbag_manager/data  -o uid=david -o gid=david -o credentials=/home/david/repo/rosbag_manager/data/.pwd </div><div class="line"></div><div class="line"></div><div class="line">sudo umount -t cifs /home/david/repo/rosbag_manager/data</div></pre></td></tr></table></figure>
<h2 id="Tomcat-server-configure"><a href="#Tomcat-server-configure" class="headerlink" title="Tomcat server configure"></a>Tomcat server configure</h2><p>bag_database is hosted by Tomcat, the default port is 8080. For our services, which already host pgAdmin4 for map group; gitlab for team work; xml server for system engineering; for webviz. check the port is occupied or not:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">netstat -an | grep 8088</div></pre></td></tr></table></figure>
<p>so configure <code>/usr/loca/tomcat/conf/server.xml</code>:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">	</div><div class="line">&lt;Service name="Catalina"&gt;</div><div class="line">   &lt;Connector port="your_special_port"</div><div class="line">   ...</div><div class="line">&lt;/Service&gt;</div></pre></td></tr></table></figure>
<h2 id="a-few-other-tools"><a href="#a-few-other-tools" class="headerlink" title="a few other tools"></a>a few other tools</h2><h3 id="ros-hadoop"><a href="#ros-hadoop" class="headerlink" title="ros_hadoop"></a>ros_hadoop</h3><p><a href="https://github.com/valtech/ros_hadoop" target="_blank" rel="external">ros_hadoop</a> is a rosbag analysis tool based on hdfs data management. which is a more scalable platform for massive ADS data requirements. if there is massive ros bag process in need, ros_hadoop should be a great tool. there is a discussion in <a href="https://discourse.ros.org/t/working-with-large-ros-bag-files-on-hadoop-and-spark/2314" target="_blank" rel="external">ros wiki</a></p>
<p><img src="https://github.com/valtech/ros_hadoop/blob/master/doc/images/concept.png" alt="image"></p>
<p><img src="https://github.com/valtech/ros_hadoop/blob/master/doc/images/rosbag-analytics.png" alt="image"></p>
<h4 id="install-hadoop"><a href="#install-hadoop" class="headerlink" title="install hadoop"></a>install hadoop</h4><p><a href="https://hadoop.apache.org/releases.html" target="_blank" rel="external">apache hadoop download</a></p>
<p><a href="https://poweruphosting.com/blog/install-hadoop-ubuntu/" target="_blank" rel="external">single alone install</a></p>
<h4 id="concept-in-hdfs"><a href="#concept-in-hdfs" class="headerlink" title="concept in hdfs"></a>concept in hdfs</h4><ul>
<li>namenode </li>
</ul>
<p>daemon process, used to manage file system</p>
<ul>
<li>datanode </li>
</ul>
<p>used to data block store and query</p>
<ul>
<li>secondary namenode</li>
</ul>
<p>used to backup</p>
<ul>
<li><p><a href="https://cloud.tencent.com/developer/article/1456436" target="_blank" rel="external">hdfs shell command</a></p>
</li>
<li><p><a href="https://www.thomashenson.com/find-hdfs-path-url/" target="_blank" rel="external">hdfs path URL</a></p>
</li>
</ul>
<h4 id="hdfs-site-xml"><a href="#hdfs-site-xml" class="headerlink" title="hdfs-site.xml"></a>hdfs-site.xml</h4><pre><code>/usr/local/hadoop/etc/hadoop/hdfs-site.xml
</code></pre><p><a href="https://hadoop.apache.org/docs/r2.4.1/hadoop-project-dist/hadoop-hdfs/hdfs-default.xml" target="_blank" rel="external">configure file</a></p>
<ul>
<li>dfs.datanode.data.dir -&gt;  local file system where to store data blocks on DataNodes </li>
<li>dfs.replicaiton -&gt;  num of replicated datablocks for protecting data </li>
<li>dfs.namenode.https-address -&gt;  location for NameNode URL </li>
<li>dfs.https.port -&gt; </li>
</ul>
<h4 id="copy-local-data-into-hdfs"><a href="#copy-local-data-into-hdfs" class="headerlink" title="copy local data into hdfs"></a>copy local data into hdfs</h4><pre><code class="script">
hdfs dfs -put /your/local/file/or/folder   [hdfs default data dir]

hdfs dfs -ls
</code></pre>
<h3 id="mongodb-store"><a href="#mongodb-store" class="headerlink" title="mongodb_store"></a>mongodb_store</h3><p><a href="https://github.com/strands-project/mongodb_store" target="_blank" rel="external">mongodb_store</a> is a tool to store and analysis ROS systems. also in <a href="https://answers.ros.org/question/240699/ros_databases/" target="_blank" rel="external">ros wiki</a></p>
<h3 id="mongo-ros"><a href="#mongo-ros" class="headerlink" title="mongo_ros"></a>mongo_ros</h3><p><a href="https://wiki.ros.org/mongo_ros" target="_blank" rel="external">mongo_ros</a> used to store ROS message n MongoDB, with C++ and Python clients.</p>
<h3 id="mongo-hadoop"><a href="#mongo-hadoop" class="headerlink" title="mongo-hadoop"></a>mongo-hadoop</h3><p><a href="https://github.com/mongodb/mongo-hadoop/" target="_blank" rel="external">mongo-hadoop</a> allows MongoDB to be used as an input source or output destination for Hadoop taskes. </p>
<h3 id="ros-pandas"><a href="#ros-pandas" class="headerlink" title="ros_pandas"></a>ros_pandas</h3><p><a href="https://nimbus.unl.edu/2014/11/using-rosbag_pandas-to-analyze-rosbag-files/" target="_blank" rel="external">rosbag_pandas</a></p>
<h3 id="tabbles"><a href="#tabbles" class="headerlink" title="tabbles"></a>tabbles</h3><p><a href="https://tabbles.net/" target="_blank" rel="external">tabbles</a> used to tag any rosbags or folders.</p>
<h3 id="hdfs-fdw"><a href="#hdfs-fdw" class="headerlink" title="hdfs_fdw"></a>hdfs_fdw</h3><p><a href="https://github.com/EnterpriseDB/hdfs_fdw" target="_blank" rel="external">hdfs for postSQL</a> </p>
<h2 id="at-the-end"><a href="#at-the-end" class="headerlink" title="at the end"></a>at the end</h2><p>talked with a friend from DiDi software team, most big Internet companies have their own software tool teams in house, which as I know so far, doesn’t exist in any traditional OEMs. is there a need for tool team in OEMs? the common sense is at the early stage, there is no need to develop and maintain in-house tools, the commericial ones should be more efficient; as the department grows bigger and requires more user special development and commericial tools doesn’t meet the needs any more, tool teams may come out. still most decided by the industry culture, OEM’s needs is often pre-defined by big suppliers, so before OEMs are clear their software tool requirements/need, the suppliers already have the solutions there – this situation is epecially true for Chinese OEMs, as their steps is behind Europen suppliers maybe 50 years.\</p>
<p>I am interested at the bussiness model of <a href="https://autovia.ai/" target="_blank" rel="external">autovia.ai</a>, which focus on <code>distributed machine learning</code> and <code>sensor data analytics</code> in cloud with <code>petabyte of data</code>, with the following skills: </p>
<ul>
<li><p>large scale sensor data(rosbag) processing with Apache Spark</p>
</li>
<li><p>large scale sensro data(rosbag) training with TensorFlow</p>
</li>
<li><p>parallel processing with fast serialization between nodes and clusters </p>
</li>
<li><p>hdmap generation tool in cloud </p>
</li>
<li><p>metrics and visulization in web</p>
</li>
<li><p>loading data directly from hdfs, Amazon S3</p>
</li>
</ul>
<p>all these functions will be a neccessary for a full-stack ADS team in future to development safety products, which I called “ data infrastructure for ADS”.</p>
<h2 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h2><p><a href="http://moore-mike.com/ros-analysis-part-2.html" target="_blank" rel="external">MooreMike: ros analysis in Jupter</a></p>
<p><a href="https://askubuntu.com/questions/29535/how-do-i-access-a-mounted-windows-share-from-the-command-line" target="_blank" rel="external">mount smb share drive to ubuntu</a></p>
<p><a href="https://autovia.ai/" target="_blank" rel="external">autovia.ai</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/16/safety-guy-in-AV/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/16/safety-guy-in-AV/" itemprop="url">safety guy in AV</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-16T07:10:58-04:00">
                2019-10-16
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/10/16/safety-guy-in-AV/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/10/16/safety-guy-in-AV/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="background"><a href="#background" class="headerlink" title="background"></a>background</h2><p>why Waymo still can’t release fully driveless cars on road; why vehicle startups, NIO is going to brankruptcy? one of the hidden reasons vehicle as a consumer product can’t go to fast iteration as social media, mobility apps in Internet companies, is safety. </p>
<p>vehicle development(VD) needs to satisfy safety requiements at first priority. so in VD,  the cutting edge tech/ new solutions usually doesn’t make a difference, but the processes, how to handle safety requirements, system requirements, e.t.c are really the first thing in vehicle engineers’ mind.</p>
<p>so now, deep learning AI in object detection is fairly matured, but it’s not used common in vehicle camera products. and for these start ups, who say themselves as tech-driven doesn’t survive well, because VD should be process driven. </p>
<p> the best managment/survive way for original equipment manufacture(OEM) companies is build up their process system. e.g. GM managemnet is about process, and Toyota agile management is about a more flexible process, too. no OEMs said their team is tech-driven. </p>
<h3 id="what-is-SOTIF"><a href="#what-is-SOTIF" class="headerlink" title="what is SOTIF ?"></a>what is SOTIF ?</h3><p>safety of the intended functionality(SOTIF): the absence of unreasonable risk due to hazards resulting from functional insufficiencies of the intended functionaliyt or by reasonably foreseeable misuse by persons.</p>
<p>SOTIF is a way to define <code>safey by design</code>, while still there are <code>unsafe post design</code>, which is beyond the standards can handle. </p>
<h3 id="safety-chanllenges-in-ADS"><a href="#safety-chanllenges-in-ADS" class="headerlink" title="safety chanllenges in ADS"></a>safety chanllenges in ADS</h3><p>is conserative behaivor of AI unsafe ? YES. as Waymo cars driving in San Fransisco, it’s more conservative than human drivers, which makes itself unsafe and surrounding vehicles unsafe. and the definiation of conservative or aggressive of driving behavior is further area depends, e.g. how human drivers drive in San Fransisco is different than drivers from Michigan, how AI handle this? </p>
<p>how does AI satisfy VD requirements, and how to verify the AI really satisfy? there is no standard solution yet. since AI is black box, it may satisfy VD requirements in 99.9% situations, but failed in 0.1% case. </p>
<p>an ADS solution works well in 99% scenarios is not an acceptable solution at all, which is really big chanllenge for most self driving full-stack solution start-ups. so Waymo and a few giants are working on test driven verification, which requires build up a very strong simulation team to power up safety test by simulation, which’s even chanllenging for most traditional OEMs.</p>
<p>and definitely, there is no way to handle unstructured stochastic traffic environments,  </p>
<h2 id="classification-of-safety-hazards"><a href="#classification-of-safety-hazards" class="headerlink" title="classification of safety hazards"></a>classification of safety hazards</h2><ul>
<li><p>IS26262</p>
</li>
<li><p>internal cyber security (ISO21434)</p>
</li>
<li><p>functional insufficient &amp; human misuse (IS02148)</p>
</li>
<li><p>external infrastructura cyber security (traffic light system, jamming sensors signals)</p>
</li>
</ul>
<h2 id="malfunction-behaviors-of-EE"><a href="#malfunction-behaviors-of-EE" class="headerlink" title="malfunction behaviors of EE"></a>malfunction behaviors of EE</h2><p>Harzard Analysis &amp; Risk Assignment </p>
<pre><code>    |
    |
    V

ASIL B/C/D         &lt;--   sys requires 

* func redundency 

* system safety mechanism 

* predictive safety mechanism 
</code></pre><p>this is a close-loop analysis, to satisfy <code>sys requirement</code> will get new situations, which lead to new system requirements </p>
<pre><code>system requirements 

  ^ 
  |
  |
  V

SOTIF Analysis 
</code></pre><p>this is a double direction design, with any new requiremenst, there is a need to do SOTIF analysis, which may find out some potential bugs/problems in the design, then back to new system requirements.</p>
<p>in summary, the input to SOTIF analysis is system requirements, and output is new system requirements.</p>
<h2 id="functional-insufficients"><a href="#functional-insufficients" class="headerlink" title="functional insufficients"></a>functional insufficients</h2><ul>
<li>unsafe by design </li>
</ul>
<p>e.g. full pressure brake design, is not sufficient in scenarios, when there is rear following vehicle in full speed</p>
<h2 id="Tech-limitations"><a href="#Tech-limitations" class="headerlink" title="Tech limitations"></a>Tech limitations</h2><ul>
<li><p>safe known </p>
</li>
<li><p>unsafe known </p>
</li>
<li><p>safe unknown</p>
</li>
<li><p>unsafe unknown </p>
</li>
</ul>
<p>SOTIF is to identify all unsafe cases and requies to make them safe, but not know how, but SOTIF can’t predict unknown. </p>
<p>back to why Waymo doesn’t release their driveless vehicle yet, cause they don’t have a way to prove their ADS system has zero unsafe unknown situations, and most possiblely the current ADS solution may be reached 80% functions of the final completed fully ADS solution, but that’s even not the turning point for ADS system. </p>
<h2 id="where-to-go"><a href="#where-to-go" class="headerlink" title="where to go?"></a>where to go?</h2><ul>
<li>rule based vs AI based </li>
</ul>
<p>as neither purely rule based nor purely AI based can achieve safety goals, so there are combined ways, but then there need a manager module to decide which should be weighted more in a special situation.</p>
<ul>
<li>a new undeterministic/unpredicted system explaination</li>
</ul>
<p>reinforcement learning is actually a good way to train agents in unpredicted simulation environemnt, but even in simulation, it can’t travel every case in the state space; then to use R.L to train vehicles in real traffic environment with random pedestrains, npcs, situations, which’s impossible so far. </p>
<ul>
<li>a new AI system </li>
</ul>
<p>current AI is still correlation analysis, while human does causal reasoning. </p>
<h2 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h2><p><a href="">safety first for automated driving handover to PR</a></p>
<p><a href="https://www.iso.org/standard/70939.html" target="_blank" rel="external">ISO 26262 standard</a></p>
<p><a href="https://hal.archives-ouvertes.fr/hal-01190734/document" target="_blank" rel="external">how to reach complete safety requirement refinement for autonomous vehicle</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/16/cruise-webriz-configure/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/16/cruise-webriz-configure/" itemprop="url">cruise webriz configure</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-16T07:09:19-04:00">
                2019-10-16
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/10/16/cruise-webriz-configure/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/10/16/cruise-webriz-configure/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="background"><a href="#background" class="headerlink" title="background"></a>background</h2><p>during ADS development, ros bag is used a lot to record the sensor, CAN and scenario info, which helps in vehicle test, data fusion, perception.<br><a href="https://github.com/cruise-automation/webviz" target="_blank" rel="external">cruise webviz</a> is an open source tool to visualize rosbag and allow user defined layout in web environment, without the pain to run <code>roscore</code> and other ros nodes.</p>
<p>while js is not a common tool in my visibility, the way how an js project is organized is really confused at the first time. there are a punch of new things:</p>
<ul>
<li><a href="https://create-react-app.dev/" target="_blank" rel="external">react</a></li>
<li>[regl]<a href="https://www.giacomodebidda.com/how-to-get-started-with-regl-and-webpack/" target="_blank" rel="external">https://www.giacomodebidda.com/how-to-get-started-with-regl-and-webpack/</a>)</li>
</ul>
<p>and <code>js</code> functions/modules are really patches, they can be pached anywhere in the project, so usually it requires a patch manager(e.g. lerna) to deal with versions, dependencies etc; and bigger there are packages, which is independent function component.</p>
<p>webviz has a few packages, e.g. regl-worldview, webviz-core, which has more than 40 patches(modules) used.</p>
<ul>
<li><p><a href="https://webviz.io/worldview/#/docs/tutorial/introduction" target="_blank" rel="external">cruise:worldview</a></p>
</li>
<li><p><a href="">cruise:webviz core</a></p>
</li>
<li><p><a href="https://github.com/cruise-automation/rosbag.js" target="_blank" rel="external">rosbag.js</a></p>
</li>
</ul>
<h2 id="lerna"><a href="#lerna" class="headerlink" title="lerna"></a>lerna</h2><p><a href="https://github.com/lerna/lerna" target="_blank" rel="external">lerna</a> is an open source tool to manage js project with multi packages.</p>
<ul>
<li><p><code>lerna init</code> will generate <code>lerna.json</code>, which defines the required modules</p>
</li>
<li><p><code>package.json</code> defines useful infomation about the module depencies,  CLI(which give a detail about how things work behind) and project description</p>
</li>
<li><p><code>lerna bootstrap --hoist react</code> will install all required modules in the root folder <code>/node_modules</code>, if doesn’t work well, leading to <code>Can&#39;t Resovle module errors</code>,  may need manually install some.</p>
</li>
</ul>
<h2 id="webpack"><a href="#webpack" class="headerlink" title="webpack"></a>webpack</h2><p><a href="https://webpack.js.org/guides/getting-started/" target="_blank" rel="external">webpack</a> is an open source tool for js module bundler. </p>
<p><code>webpack.config.js</code>, defines <code>entry</code>, where the compiler start; <code>output</code> , where the compiler end; <code>module</code>, how to deal with each module; <code>plugin</code>, additionaly content post compiliation; <code>resovle.alias</code> define alias for modules.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">var path=require(<span class="string">"path"</span>)</div><div class="line"></div><div class="line">module.exports =&#123;</div><div class="line">	entry: &#123; app:[<span class="string">"./app/main.js"</span>] &#125;</div><div class="line">     	output: &#123;path: path.resolve(__dirname, <span class="string">"build"</span>)&#125; </div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">npm install webpack-dev-server</div><div class="line"></div><div class="line">npm list | head -n <span class="number">1</span> </div><div class="line"></div><div class="line">webpack-dev-server --inline --hot</div></pre></td></tr></table></figure>
<p>the JS bundle could be loaded from a static HTML page, served with any simple web server. That’s exactly what this /packages/webviz-core/public/index.html file is, which is used for <a href="https://webviz.io/try" target="_blank" rel="external">https://webviz.io/try</a>. The webpack dev server is configured to serve it at /webpack.config.js</p>
<h2 id="npm-commands"><a href="#npm-commands" class="headerlink" title="npm commands"></a>npm commands</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">npm config list </div><div class="line">npm install packages@version.minor [-g] [--save]</div><div class="line">npm uninstall packages </div><div class="line">npm search packages</div><div class="line">npm cache clean --force</div></pre></td></tr></table></figure>
<h2 id="webpack-server"><a href="#webpack-server" class="headerlink" title="webpack-server"></a>webpack-server</h2><p><a href="https://github.com/webpack/docs/wiki/webpack-dev-server" target="_blank" rel="external">webpack-server</a> is a little nodejs Express server. to install it as a CLI tool first, then run it under the webviz project root folder, with optional parameters, e.g.  –host, –port e.t.c</p>
<h2 id="webviz-configure"><a href="#webviz-configure" class="headerlink" title="webviz configure"></a>webviz configure</h2><ul>
<li>npm config set registry <a href="https://r.npm.taobao.org" target="_blank" rel="external">https://r.npm.taobao.org</a></li>
<li>npm install puppeteer –unsafe-perm=true</li>
<li>npm run bootstrap</li>
</ul>
<p>if failed: </p>
<ul>
<li>sudo npm cache  clean –force </li>
<li>npm install -g lerna </li>
<li>npm run bootstrap     </li>
<li>sudo npm install/rebuild node-sass </li>
<li>npm run build</li>
</ul>
<p>if failed, manually installed unresovled modules</p>
<ul>
<li>npm test   </li>
</ul>
<p>if failed based on a few test modules, install then</p>
<ul>
<li>npm install  webpack-dev-server –save </li>
</ul>
<p>webpack-dev-server.js –host IP –port 8085  #under project root</p>
<p>a little hack, by default <code>npm install inter-ui</code> <a href="https://github.com/philipbelesky/inter-ui/tree/master/Inter%20(web" target="_blank" rel="external">phli’s inter-ui</a>), where inside<br><code>webviz/packages/webvix-core/src/styles/fonts.module.scess</code>, it uses: <code>url(&quot;~inter-ui/Inter UI (web)/Inter-UI.var.woff2&quot;) format(&quot;woff2-variations&quot;)</code>, modified this line to: <code>url(&quot;~inter-ui/Inter (web)/Inter.var.woff2&quot;) format(&quot;woff2-variations&quot;)</code></p>
<h2 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h2><p><a href="https://tabbles.net/" target="_blank" rel="external">tabbles</a></p>
<p><a href="https://discourse.ros.org/t/webviz-ros-data-visualization-in-the-browser/9783" target="_blank" rel="external">webviz in ros community</a></p>
<p><a href="https://stackoverflow.com/questions/33272967/how-to-make-the-webpack-dev-server-run-on-port-80-and-on-0-0-0-0-to-make-it-publ" target="_blank" rel="external">access web-server in LAN</a></p>
<p><a href="https://github.com/cruise-automation/webviz/issues/161" target="_blank" rel="external">issue: how to run cruise webviz</a></p>
<p><a href="https://ternaris.com/marv-robotics/" target="_blank" rel="external">Ternaris Marv</a></p>
<p><a href="https://min.io/" target="_blank" rel="external">minio: high performance object storage for AI</a></p>
<p><a href="https://github.com/cruise-automation/webviz/issues/247" target="_blank" rel="external">webviz on remote bag</a></p>
<p><a href="https://github.com/cruise-automation/webviz/issues/118" target="_blank" rel="external">visuaize data from a live server</a></p>
<p><a href="https://stackoverflow.com/questions/22764407/npm-install-goes-to-dead-in-china" target="_blank" rel="external">npm package install in China</a></p>
<p><a href="https://npm.taobao.org/package/cnpm" target="_blank" rel="external">taobao.npm</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="David Z.J. Lee" />
          <p class="site-author-name" itemprop="name">David Z.J. Lee</p>
           
              <p class="site-description motion-element" itemprop="description">what I don't know</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">166</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">41</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/ZJLi2013" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.linkedin.com/in/zhengjia13/" target="_blank" title="LinkedIn">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  LinkedIn
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">David Z.J. Lee</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://zjlee.disqus.com/count.js" async></script>
    

    

  




	





  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
