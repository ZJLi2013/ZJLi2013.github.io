<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="what I don&apos;t know">
<meta property="og:type" content="website">
<meta property="og:title" content="Serious Autonomous Vehicles">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="Serious Autonomous Vehicles">
<meta property="og:description" content="what I don&apos;t know">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Serious Autonomous Vehicles">
<meta name="twitter:description" content="what I don&apos;t know">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/5/"/>





  <title>Serious Autonomous Vehicles</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Serious Autonomous Vehicles</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/20/real-world-env-in-ADS-simulation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/20/real-world-env-in-ADS-simulation/" itemprop="url">real-world env in ADS simulation</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-08-20T06:06:28-04:00">
                2019-08-20
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/08/20/real-world-env-in-ADS-simulation/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/08/20/real-world-env-in-ADS-simulation/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>this topic is based on lg-sim, the advantage is plenty Unity3D resources. to drive planning design, simulation has to keep as real-world env as possible. for <code>L3</code> and below, the high-fidelity is actually most about <code>HD map</code>, since in <code>L3</code> ADS, sensors only cares about the road parternors on road, and <code>planning</code> module take <code>hd map</code> as input. </p>
<p>so there is a need to build simulation envs based on <code>hd map</code>. </p>
<h3 id="osm"><a href="#osm" class="headerlink" title="osm"></a>osm</h3><p>in the Unity engine, all in the env(e.g. traffic light, road lanes, lane mark etc) are GameObjects. to describe a map info, one of most common used map format is <code>OSM</code> (another is opendrive, but no open parser in unity yet), however which is not born to used in <code>hd map</code>, but still is very flexible to extend to descripe all info, a <code>hd map</code> requires. e.g. lane id, lane width, lane mark type e.t.c</p>
<p>the open-source tool <code>OsmImporter</code> is good enough to parse osm meta data into Unity GameObjects. for different map vendors, first to transfer their map format into the extended-osm format. and then can generate all map info related gameObjects in Unity env. that’s the main idea to create real-world env in simualtor.</p>
<p>the end is to make a toolchain from map vendor input to Unity 3D env.</p>
<h3 id="waypoints"><a href="#waypoints" class="headerlink" title="waypoints"></a>waypoints</h3><p>in either lg-sim or carla, the npc vehicles in self-driving mode, is actually controlled by following waypoints in the simulator, and <code>waypoints</code> is generated during creating map in step above.</p>
<p>carla has plenty client APIs to manage the waypoints, and then drive npcs. </p>
<h3 id="hd-map-tool"><a href="#hd-map-tool" class="headerlink" title="hd-map tool"></a>hd-map tool</h3><p>by default, both lg-sim and carla has a tool to create hd-map, that’s basically mark <code>waypoints</code> on the road in an existing map, which is not strong.  carla later support <code>Vector one</code> to build in map more efficiently.</p>
<h2 id="L3-virtual-env-generator"><a href="#L3-virtual-env-generator" class="headerlink" title="L3+ virtual env generator"></a>L3+ virtual env generator</h2><p>there are plenty teams working on building/rendering virtual envs directly from sensor data, e.g Lidar cloud point or camera image, and plenty image-AI techs here, which of course gives better immersed experince. and the test task is mostly for perception, data-fusion modules, which is heavier in L3+</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/16/threading-and-websockets/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/16/threading-and-websockets/" itemprop="url">threading and websockets</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-08-16T09:30:00-04:00">
                2019-08-16
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/08/16/threading-and-websockets/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/08/16/threading-and-websockets/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="threading-Thread"><a href="#threading-Thread" class="headerlink" title="threading.Thread"></a>threading.Thread</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">run()</div><div class="line"></div><div class="line">start()</div><div class="line"></div><div class="line">join([time])</div><div class="line"></div><div class="line">isAlive()</div><div class="line"></div><div class="line">getName()</div><div class="line"></div><div class="line">setName()</div></pre></td></tr></table></figure>
<p>to initialize a thread with:  threadID, name, counter</p>
<h3 id="start-and-run"><a href="#start-and-run" class="headerlink" title="start() and run()"></a>start() and run()</h3><p>start() once for each thread, run() will not spawn a separate thread, but run in current thread </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">myThread</span><span class="params">(threading.Thread)</span>:</span></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args, **kwargs)</span>:</span></div><div class="line">		super(myThread, self).__init__(*args, **kwargs)</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">		print(<span class="string">"run ... from start()"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">	demo = myThread()</div><div class="line">	demo.start()</div><div class="line">	demo.join()</div></pre></td></tr></table></figure>
<h3 id="lock-objects"><a href="#lock-objects" class="headerlink" title="lock objects"></a>lock objects</h3><p>a primitive lock does not belongto a certain thread when locked. by default, when constructed, the lock is in <code>unlocked</code> state.</p>
<ul>
<li><code>acquire()</code>, will set the lock to <code>locked</code> and return the lock immediately(atom operator); if current lock is <code>locked</code>, then <code>acquire()</code> blocks (the thread) untill the occuping-lock thread calls release().</li>
</ul>
<p>if multi-thread blocked by <code>acquire()</code>, only one thread will get the lock when release() is called, but can’t sure which one from the suspended threads</p>
<h3 id="condition-objects"><a href="#condition-objects" class="headerlink" title="condition objects"></a>condition objects</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">threading.Condition(lock=None)</div><div class="line"></div><div class="line">acquire()</div><div class="line"></div><div class="line">wait()</div><div class="line"></div><div class="line">notify()</div><div class="line"></div><div class="line">release()</div></pre></td></tr></table></figure>
<p>thread A aquire() the condition variable, to check if condition satification, if not, thread A wait; if satisfied, update the condition variable status and notify all other threads in waiting.</p>
<h2 id="websocket"><a href="#websocket" class="headerlink" title="websocket"></a>websocket</h2><h3 id="background"><a href="#background" class="headerlink" title="background"></a>background</h3><p>webocket is better than http when the server need actively push message to client, rather than waiting client request first.</p>
<p><a href="http://www.ruanyifeng.com/blog/2017/05/websocket.html" target="_blank" rel="external"></a></p>
<h3 id="client"><a href="#client" class="headerlink" title="client"></a>client</h3><p>usually webSocket client has two methods:  <code>send()</code> to send data to server; <code>close()</code> to close websocket connection, as well a few event callbacks:</p>
<ul>
<li>onopen(): triggered when websocket instance get connected</li>
<li>onerror(),</li>
<li>onclose(), </li>
<li>onmessage(), which triggered when received data from server.</li>
</ul>
<p>when constructing a webSocket instance, a connection is built between server and client. </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// client connect to server </span></div><div class="line"><span class="keyword">var</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">'ws://localhost:8181'</span>);</div><div class="line">ws.onopen = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">   ws.send(<span class="string">"hello server"</span>);</div><div class="line">&#125;</div><div class="line"><span class="comment">// if need run multi callback</span></div><div class="line">ws.addEventListener(<span class="string">'open'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</div><div class="line">	ws.send(<span class="string">'hello server'</span>);</div><div class="line">	&#125;); </div><div class="line">ws.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</div><div class="line">	<span class="keyword">var</span> data = event.data ;</div><div class="line">&#125;;</div><div class="line">ws.addEventListener(<span class="string">"message"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</div><div class="line">	<span class="keyword">var</span> data = event.data ;</div><div class="line">&#125;); </div><div class="line">ws.send(<span class="string">'client message'</span>);</div></pre></td></tr></table></figure>
<h4 id="onmessage"><a href="#onmessage" class="headerlink" title="onmessage()"></a>onmessage()</h4><p>whenever the server send data, onmessage() events get fired.</p>
<h3 id="server"><a href="#server" class="headerlink" title="server"></a>server</h3><ul>
<li>onOpen(), triggered when a new client-server connection setup</li>
<li>onMessage(), triggered when message received </li>
<li>onClose(), </li>
<li>onError(), </li>
</ul>
<h3 id="implementation"><a href="#implementation" class="headerlink" title="implementation"></a>implementation</h3><p>in c#, there is websocket-sharp, in python is python-websockets, in js is nodejs-websocket. as well as websocket protocol is satisified, server can write using websocket-sharp, and client in python-websockets. an example is in lg-simulator.</p>
<p>the message type in websocket can be json or binary, so there should be json parse in c#(SimpleJSON), python(json module) and js (JSON).</p>
<h3 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h3><p><a href="https://stackoverflow.com/questions/16280747/sending-message-to-a-specific-connected-users-using-websocket" target="_blank" rel="external">sending message to a client</a></p>
<p><a href="https://stackoverflow.com/questions/50618425/websockets-get-message-from-a-websocket-server-and-send-it-to-client" target="_blank" rel="external">sent message from server to client</a></p>
<p><a href="https://websockets.readthedocs.io/en/stable/" target="_blank" rel="external">python websockets</a></p>
<p><a href="https://github.com/websockets/ws#server-broadcast" target="_blank" rel="external">nodjs websocket</a></p>
<p><a href="https://www.vcblog.top/article/494/" target="_blank" rel="external">c# websocket</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/16/Unet-intro/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/16/Unet-intro/" itemprop="url">Unet intro</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-08-16T08:06:33-04:00">
                2019-08-16
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/08/16/Unet-intro/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/08/16/Unet-intro/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://docs.unity3d.com/Manual/UNetOverview.html" target="_blank" rel="external">unity3d manual</a></p>
<h3 id="High-Level-API-HLAPI"><a href="#High-Level-API-HLAPI" class="headerlink" title="High Level API(HLAPI)"></a>High Level API(HLAPI)</h3><p> HLAPI is a server authoritative system, triggered from  UnityEngine.Networking</p>
<h4 id="authority"><a href="#authority" class="headerlink" title="authority"></a>authority</h4><p>  host has the authority over all non-player GameObjects;  Player GameObjects are a special case and treated as having “local authority”. </p>
<h4 id="local-client-authority-for-npc"><a href="#local-client-authority-for-npc" class="headerlink" title="local/client authority for npc"></a>local/client authority for npc</h4><p>method1:  spawn the npc using <code>NetworkServer.SpawnWithClientAuthority</code><br>method2:  <code>NetworkIdentity.AssignClientAuthority</code> </p>
<h4 id="network-context-properties"><a href="#network-context-properties" class="headerlink" title="network context properties"></a>network context properties</h4><p>isServer()<br>isClient()<br>sLOcalPlayer()<br>hasAuthority()</p>
<h4 id="networked-GameObjects"><a href="#networked-GameObjects" class="headerlink" title="networked GameObjects"></a>networked GameObjects</h4><pre><code>multiplayer games typically built using Scenes that contain a mix of networked GOs and regular GOs.  networked GOs needs t obe synchronized across all users; non-networked GOs are either static obstacles or GOs don&apos;t need to synchronized across players 

 networked GO is one which has a NetworkIdentiy component. beyond that, you need define what to syncronize. e.g. transform ,variables ..
</code></pre><h4 id="player-GO"><a href="#player-GO" class="headerlink" title="player GO"></a>player GO</h4><p> NetworkBehavior class has a property: isLocalPlayer, each client player GO.isLocalPlayer == true, and invoke OnStartLOcalPlayer() </p>
<p>Player GOs represent the player on the server, and has the ability to run comands from the player’s client. </p>
<h4 id="spawning-GOs"><a href="#spawning-GOs" class="headerlink" title="spawning GOs"></a>spawning GOs</h4><p>the Network Manager can only spawn and synchronize GOs from registered prefabs, and these prefabs must have a NetworkIdentity component</p>
<h4 id="spawning-GOs-with-client-authority"><a href="#spawning-GOs-with-client-authority" class="headerlink" title="spawning GOs with client authority"></a>spawning GOs with client authority</h4><p>NetworkServer.SpawnWithClientAuthority(go, NetworkConnection),<br>for these objects, <code>hasAuthority</code> is true on this client and OnStartAuthority() is called on this client.  Spawned with client authority must have <code>LocalPlayerAuthority</code> set to <code>NetworkIdentity</code>, </p>
<h4 id="state-synchronization"><a href="#state-synchronization" class="headerlink" title="state synchronization"></a>state synchronization</h4><p>[SyncVars] synchronzed from server to client;  if opposite, use [Commands]</p>
<p>the state of SyncVars is applied to GO on clients before <code>OnStartClient()</code> called. </p>
<h3 id="engine-and-editor-integration"><a href="#engine-and-editor-integration" class="headerlink" title="engine and editor integration"></a>engine and editor integration</h3><ul>
<li><code>NetworkIdentity</code> component for networked objects </li>
<li><code>NetworkBehaviour</code> for networked scripts</li>
<li>configurable automatic synchronization of object transforms</li>
<li>automatic snyc var</li>
</ul>
<h4 id="build-in-Internet-services"><a href="#build-in-Internet-services" class="headerlink" title="build-in Internet services"></a>build-in Internet services</h4><h4 id="network-visibility"><a href="#network-visibility" class="headerlink" title="network visibility"></a>network visibility</h4><p>relates to whether data should or not sent about the GOs to a particulr clinet.</p>
<p>method1:  add Network Proximity Checker component to networked GO<br>method2:  </p>
<h4 id="Scene-GOs"><a href="#Scene-GOs" class="headerlink" title="Scene GOs"></a>Scene GOs</h4><p> saved as part of a Scene, no runtime spawn</p>
<h4 id="actions-and-communication"><a href="#actions-and-communication" class="headerlink" title="actions and communication"></a>actions and communication</h4><p>method1:  remote actions, call a method across network<br>method2:  networking manager/behavior callbacks<br>method3:  LL network messages </p>
<h5 id="host-migration"><a href="#host-migration" class="headerlink" title="host migration"></a>host migration</h5><p>host:  a player whose game is acting as a server and a “local client”<br>remote client: all other players<br>so when the host left, host need migrate to one remote client to keep the game alive</p>
<p>how it works:<br>    enable host migration.  so Unity will distribute the address of all peers to other peers. so when host left,  one peer was selected to be the new host (heart-keeping)</p>
<h5 id="network-discovery"><a href="#network-discovery" class="headerlink" title="network discovery"></a>network discovery</h5><p>allow players to find each other on a local area network(LAN)</p>
<p>need component <networkdiscovery>,</networkdiscovery></p>
<p>in server mode, the Network Discovery sends broadcast message over the network o nthe specified port in Inspector;</p>
<p>in client mode, the component listens for broadcast message on the specified port</p>
<h4 id="using-transport-Layer-API-LL-API"><a href="#using-transport-Layer-API-LL-API" class="headerlink" title="using transport Layer API  (LL API)"></a>using transport Layer API  (LL API)</h4><p>socket-based networking</p>
<h3 id="in-the-end"><a href="#in-the-end" class="headerlink" title="in the end"></a>in the end</h3><p>network is basic cornerstone in server-client applications, Unet is deprecated at this moment, but still many good network resource can take in charge. e.g. websockets, nodejs, and what behind these network protocol or languages, e.g. async/coroutines are charming as well. </p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/16/python-generator-and-asynico/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/16/python-generator-and-asynico/" itemprop="url">python generator and asynico</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-08-16T07:54:11-04:00">
                2019-08-16
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/08/16/python-generator-and-asynico/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/08/16/python-generator-and-asynico/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="python-iterator"><a href="#python-iterator" class="headerlink" title="python iterator"></a>python iterator</h3><p>in python, <code>iterator</code> is any object that follows <code>iterator protocol</code>. which means should include method: <code>__iter()__</code>, <code>next()</code>, if no next element should raise <code>StopIteration</code> exception.</p>
<p>take an example, <code>dict</code> and <code>list</code> have implemented <code>__iter()__</code> and <code>__getitem__()</code> methods, but not implemented <code>next()</code> method. so they are  <code>iterable</code> but not <code>iterator</code>.</p>
<h3 id="generator"><a href="#generator" class="headerlink" title="generator"></a>generator</h3><p>to support delay operations, only return result when need, but not immediately return</p>
<ul>
<li><p>generator funcion (with <code>yield</code>) </p>
</li>
<li><p>generator expression </p>
</li>
</ul>
<p>Python generator in other languages is called <code>coroutines</code> </p>
<h3 id="yield"><a href="#yield" class="headerlink" title="yield"></a>yield</h3><p><code>yield</code> is almost of <code>return</code>, but it pauses every step after executing the line with <code>yield</code>, and till call <code>next()</code> will continue from the next line of <code>yield</code>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">	sim.run(timeout, cb)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">cb</span><span class="params">()</span>:</span></div><div class="line">    a = <span class="number">1</span> </div><div class="line">	<span class="keyword">yield</span> print(a)</div><div class="line">	a += <span class="number">1</span></div></pre></td></tr></table></figure>
<h2 id="coroutines"><a href="#coroutines" class="headerlink" title="coroutines"></a>coroutines</h2><p>example: </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">cor1</span><span class="params">(name)</span>:</span></div><div class="line">        print(<span class="string">"start cor1..name.."</span>, name)</div><div class="line">        x = <span class="keyword">yield</span> name</div><div class="line">        print(<span class="string">"send value"</span>, x)</div><div class="line"></div><div class="line">cor_ =  cor1(<span class="string">"zj"</span>)</div><div class="line">print(<span class="string">"next return"</span>, next(cor_))</div><div class="line">print(<span class="string">"send return"</span>, cor_.send(<span class="number">6</span>))</div></pre></td></tr></table></figure>
<p>to run coroutine, need first call next(), then send() is called. namely, if not call next() first, send() will wait, and never be called.</p>
<p>the thing is, when define a python generator/coroutine, it never will run; only through await(), next() call first, which then trigger the generator/coroutine start.</p>
<h2 id="asyncio"><a href="#asyncio" class="headerlink" title="asyncio"></a>asyncio</h2><p>asyncronized IO, event-driven coroutine, so users can add <code>async/await</code> to time-consuming IO.</p>
<ul>
<li>event-loop</li>
</ul>
<p>event loop will always run, track events and enqueue them, when idle dequeue event and  call event-handling() to deal with it.</p>
<ul>
<li>asyncio.Task</li>
</ul>
<h3 id="await"><a href="#await" class="headerlink" title="await"></a>await</h3><p>await only decorate async/coroutine, which is a waitable object, it works to hold the current coroutine(async func A) and wait the other coroutine(async func B) to the end.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">async def funcB():</div><div class="line">	return 1</div><div class="line"></div><div class="line">async def funcA():</div><div class="line">	result = await funcB()</div><div class="line">        return result</div><div class="line"></div><div class="line">run(funcA())</div></pre></td></tr></table></figure>
<h3 id="multi-task-coroutines"><a href="#multi-task-coroutines" class="headerlink" title="multi-task coroutines"></a>multi-task coroutines</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">loop.create_task()</div><div class="line"></div><div class="line"></div><div class="line">run_until_complete() #block the thread untill coroutine completed</div><div class="line"></div><div class="line">asyncio.sleep() #nonblock event-loop, with `await`, will return the control-priority to event-loop, at the end of sleep, control-priority will back to this coroutine </div><div class="line"></div><div class="line">asyncio.wait(), #nonblock event-loop, immeditialy return coroutine object, and add this corutine object to event-loop</div><div class="line"></div><div class="line">``` </div><div class="line"></div><div class="line">the following example:  get the event-loop thread, add coroutine objct(task) in this event-loop, execute task till end.</div><div class="line"></div><div class="line">```python</div><div class="line"></div><div class="line">import asyncio</div><div class="line"></div><div class="line">async def cor1(name):</div><div class="line">        print("executing: ", name)</div><div class="line">        await asyncio.sleep(1)</div><div class="line">        print("executed: ", name)</div><div class="line"></div><div class="line">loop = asyncio.get_event_loop()</div><div class="line">tasks = [cor1("zj_" + str(i)) for i in range(3)]</div><div class="line">wait_cor = asyncio.wait(tasks)</div><div class="line">loop.run_until_complete(wait_cor)</div><div class="line">loop.close()</div><div class="line"></div><div class="line">``` </div><div class="line"><span class="meta"></span></div><div class="line">### dynamically add coroutine</div><div class="line"></div><div class="line"></div><div class="line">```shell </div><div class="line"></div><div class="line">loop.call_soon_threadsafe() # add coroutines sequencially  </div><div class="line">asyncio.run_coroutine_threadsafe() #add coroutines async</div></pre></td></tr></table></figure>
<h4 id="add-coroutine-sequencially"><a href="#add-coroutine-sequencially" class="headerlink" title="add coroutine sequencially"></a>add coroutine sequencially</h4><p>in this sample, main_thread(_loop) will sequencely run from begining to end, during running, there are two coroutines registered, when thread-safe, these two coroutines will be executed.</p>
<p>the whole process actually looks like run in sequencialy</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> asyncio</div><div class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">start_loop</span><span class="params">(loop)</span>:</span></div><div class="line">    asyncio.set_event_loop(loop)</div><div class="line">    loop.run_forever()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">thread_</span><span class="params">(name)</span>:</span></div><div class="line">    print(<span class="string">"executing name:"</span>, name)</div><div class="line">    <span class="keyword">return</span> <span class="string">"return nam:"</span> + name</div><div class="line"></div><div class="line">_loop = asyncio.new_event_loop()</div><div class="line">t = Thread(target=start_loop, args=(_loop,)) <span class="comment">#is a thread or coroutine ?</span></div><div class="line">t.start()</div><div class="line"></div><div class="line"></div><div class="line">handle = _loop.call_soon_threadsafe(thread_, <span class="string">"zj"</span>)</div><div class="line">handle.cancel()</div><div class="line"></div><div class="line">_loop.call_soon_threadsafe(thread_, <span class="string">"zj2"</span>)</div><div class="line"></div><div class="line">print(<span class="string">"main thread non blocking..."</span>)</div><div class="line"></div><div class="line"></div><div class="line">_loop.call_soon_threadsafe(thread_, <span class="string">"zj3"</span>)</div><div class="line"></div><div class="line">print(<span class="string">"main thread on going..."</span>)</div></pre></td></tr></table></figure>
<h4 id="add-coroutines-async"><a href="#add-coroutines-async" class="headerlink" title="add coroutines async"></a>add coroutines async</h4><p>in this way, add/register async coroutine objects to the event-loop and execute the coroutines when thead-safe</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">future = asyncio.run_coroutine_threadsafe(thread_(<span class="string">"zj"</span>), _loop)</div><div class="line">print(future.result())</div><div class="line"></div><div class="line">asyncio.run_coroutine_threadsafe(thread_(<span class="string">"zj2"</span>), _loop)</div><div class="line"></div><div class="line">print(<span class="string">"main thread non blocking..."</span>)</div><div class="line"></div><div class="line"></div><div class="line">asyncio.run_coroutine_threadsafe(thread_(<span class="string">"zj3"</span>), _loop)</div><div class="line"></div><div class="line">print(<span class="string">"main thread on going..."</span>)</div></pre></td></tr></table></figure>
<h2 id="async-callback-vs-coroutines"><a href="#async-callback-vs-coroutines" class="headerlink" title="async callback  vs coroutines"></a>async callback  vs coroutines</h2><p>compare callback and coroutines is hot topic in networking and web-js env. </p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/10/dns-server-in-lan/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/08/10/dns-server-in-lan/" itemprop="url">dns server in lan</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-08-10T10:08:04-04:00">
                2019-08-10
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/08/10/dns-server-in-lan/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/08/10/dns-server-in-lan/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="DNS-server-in-LAN"><a href="#DNS-server-in-LAN" class="headerlink" title="DNS server in LAN"></a>DNS server in LAN</h2><p>to use domain name(e.g. gitlab.com) in LAN rather than IP, it needs every local host machine to store all key-values:: host-IP. if the LAN has many host machines, it will be difficult to maintain. Setting up DNS server will help to automatically map the ip to domain or reverse in the LAN.</p>
<h3 id="bind9"><a href="#bind9" class="headerlink" title="bind9"></a>bind9</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">apt-get install bind9 </div><div class="line">``` </div><div class="line"><span class="meta">#</span>## /etc/bind/named.conf.local</div><div class="line"></div><div class="line">```shell</div><div class="line"></div><div class="line">zone "gitlab.com" &#123;</div><div class="line">	type: master;</div><div class="line">	file "/etc/bind/db.ip2gitlab.com" ;</div><div class="line">&#125;;	</div><div class="line"></div><div class="line">zone "101.20.10.in-addr.arpa" &#123;</div><div class="line">	type: master;</div><div class="line">	file "/etc/bind/db.gitlab2ip.com" ;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">``` </div><div class="line"><span class="meta">#</span>## /etc/bind/db.gitlab2ip.com </div><div class="line"></div><div class="line">[dns zone file format](https://help.dyn.com/how-to-format-a-zone-file/)</div><div class="line"></div><div class="line">gitlab2ip zone file is mapping from domain to ip, as following sample, it works like:</div><div class="line"></div><div class="line">	www.$ORIGIN  --&gt;  10.20.101.119 </div><div class="line"></div><div class="line">```shell</div><div class="line">; command</div><div class="line"><span class="meta">$</span>TTL  6000</div><div class="line">;@ refer to current zone file</div><div class="line">;			 DNS-server-FDNQ notification-email</div><div class="line"><span class="meta">$</span>ORIGIN  gitlab.com</div><div class="line">@ 	IN 	SOA	 	server 	email (</div><div class="line">			 		2	 ;</div><div class="line">			 		1d ;</div><div class="line">			 		1h ;</div><div class="line">			 		5min ;</div><div class="line">			 	)</div><div class="line">@		IN		NS  	server</div><div class="line">www		IN		A		10.20.101.119</div><div class="line">server	IN		A		10.20.101.119</div></pre></td></tr></table></figure>
<h3 id="etc-bind-db-ip2gitlab-com"><a href="#etc-bind-db-ip2gitlab-com" class="headerlink" title="/etc/bind/db.ip2gitlab.com"></a>/etc/bind/db.ip2gitlab.com</h3><p>ip2gitlab zone file is from ip to domain mapping, </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span>TTL  6000</div><div class="line"><span class="meta">$</span>ORIGIN 101.20.10.in-addr.arpa</div><div class="line">@ 	IN 	SOA	 	server. 	email. (</div><div class="line">			 		2	 ;</div><div class="line">			 		1d ;</div><div class="line">			 		1h ;</div><div class="line">			 		5min ;</div><div class="line">			 	)</div><div class="line">@		IN		NS  	server</div><div class="line">119		IN		A		www.gitlab.com</div><div class="line">119		IN		A		server.gitlab.com</div></pre></td></tr></table></figure>
<h3 id="nslookup"><a href="#nslookup" class="headerlink" title="nslookup"></a>nslookup</h3><pre><code class="shell">nslookup www.gitlab.com   #dns forward (domain 2 ip)

nslookup  10.20.101.119   #reverse (ip 2 domain)
</code></pre>
<h2 id="settings"><a href="#settings" class="headerlink" title="settings"></a>settings</h2><p>if the DNS setted above(DNS-git) is the only DNS server in the LAN, then this DNS works like a gateway, to communicate by domain name, every local host talk to it first, to understand the domain name.</p>
<p>but in a large size company LAN newtwork, there may already has a DNS server hosted at IT department (DNS-IT), with a fixed IP e.g. <code>10.10.101.101</code>, and all localhost machines actually set DNS-IT as the default DNS. DNS-git will work as a sub-DNS server. </p>
<p>Inside the small team, either every localhost change default DNS to DNS-git, then DNS-git become the sub-network server.</p>
<p>if every localhost still keep DNS-IT, there is no way(?) to use DNS-git service in LAN, and even make conflicts, as the DNS-git localhost machine will listen on all TCP/IP ports, every new gitlab.com access request (input as IP address) will get an output as domain name, but the others can’t understand this domain-name…</p>
<p>what happened with two DNS server in LAN ? </p>
<h2 id="how-email-works"><a href="#how-email-works" class="headerlink" title="how email works"></a>how email works</h2><p>Mail User Agent(MUA), e.g. Outlook, Foxmail, used to receive and send emails.</p>
<p>MUA is not directly sent emails to end users, but through  Mail Transfer Agent(MTA), e.g. SendMail, Postfix.</p>
<p>an email sent out from MUA will go through one or more MTA, finally reach to Mail Delivery Agent(MDA), the email then store in some database, e.g. mailbox</p>
<p>the receiver then use MUA to review the email in the mailbox</p>
<p>ps, one day work as a IT admin …. </p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/25/design-scenarios-in-ADS-simulation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/25/design-scenarios-in-ADS-simulation/" itemprop="url">design scenarios in ADS simulation</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-07-25T10:15:24-04:00">
                2019-07-25
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/07/25/design-scenarios-in-ADS-simulation/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/07/25/design-scenarios-in-ADS-simulation/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>to design scenarios in self-driving test, one reference is: <a href="https://www.nhtsa.gov/document/framework-automated-driving-system-testable-cases-and-scenarios" target="_blank" rel="external">a framework for automated driving system testable cases and sceanrios</a>, most other scenario classifications have almost the same elements: ODD, e.g. road types, road surfaces; OEDR, namely object and event detection and response, e.g. static obstacles, other road actors, traffic signature, environment conditions, special zones; and failure mode behaviors.</p>
<p>in general, test cases can be grouped as black box test, in which the scenario parterners’ behavior is not pre-defined or unpredictable, e.g. random traffic flow(npcs) scenario, or white box test, where the npcs behavior is pre-defined, e.g. following user-define routings. white box testing is helpful to support performance metrics; while black-box testing is helpful to verify the system completeness and robust.</p>
<p>as for ADS test, there are a few chanllenges coming from:</p>
<ul>
<li><p>heuristics decision-making algorithms, deep-learning algorithms, which is not mathematically completed</p>
</li>
<li><p>the test case completeness, as the number of tests required to achieve statistically significant to claim safe would be staggering</p>
</li>
<li><p>undefined conditions or assumptions</p>
</li>
</ul>
<p>a sample test scenario set maybe looks like: </p>
<table>
<thead>
<tr>
<th>ODD</th>
<th>OEDR-obj</th>
<th>OEDR-loc</th>
<th>maneuver</th>
</tr>
</thead>
<tbody>
<tr>
<td>in rump</td>
<td>static obstacles</td>
<td>in front of current lane</td>
<td></td>
</tr>
<tr>
<td>in rump</td>
<td>static obstacles</td>
<td>in front of targe lane</td>
<td></td>
</tr>
<tr>
<td>in rump</td>
<td>dynamic obstacles</td>
<td>in front of current lane</td>
</tr>
</tbody>
</table>
<h3 id="scenarios-runner"><a href="#scenarios-runner" class="headerlink" title="scenarios_runner"></a>scenarios_runner</h3><p><a href="https://github.com/carla-simulator/scenario_runner" target="_blank" rel="external">carla</a> has offered an scenario engine, which is helpful to define scenarios by test_criteria and behaviors, of course the timeout as well.</p>
<p><code>test_criteria</code>, is like an underline boundary for the scenario to keep, if not, the scenario failed. e.g. max_speed_limitation, collision e.t.c. these are test criterias, no matter simualtion test or physical test, that have to follow the same criterias; in old ways, we always try to find a way to evaluate the simulation result, and thought this may be very complex, but as no clue to go complex further, simple criterias actually is good. even for reinforcement learning, the simple criterias is good enough for the agent to learn the drive policy. </p>
<p>of course, I can expect there are some expert system about test criterias.  </p>
<p>For simulation itself, there has another metric to descibe how close the simulation itself to physical world, namley to performance how well the simulator is, which is beyond here.</p>
<p><code>behaivor</code> is a good way to describe the dynamic processing in the scenario. e.g. npc follow lane to next intersection, and stop in right lane, ego follow npc till the stop area.</p>
<p>OpenScenario has similar ideas to descibe the dynamic. to support <code>behaivor</code>, the simulator should have the features to control ego and npc with the atomic behaviors, e.g. lane-follow, lane-change, stop at intersection e.t.c. </p>
<p>in lg simulator, npc has simple AI routing and lane-following API, basically is limited to follow pre-defined behaviors; ego has only cruise-control, but external planner is avialable through ROS.</p>
<p>for both <code>test_criteria</code> and <code>behavior</code>, carla has a few existing atomic elements, which is a good idea to build up complex scenarios. </p>
<h3 id="OpenScenario"><a href="#OpenScenario" class="headerlink" title="OpenScenario"></a>OpenScenario</h3><p>not sure if this is a project still on-going, carla has interface and a few other open source parsers there, but as it is a standard in popular projects, e.g. PEGUS, should be worthy to take further study.  </p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/18/model-based-design-sucks/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/18/model-based-design-sucks/" itemprop="url">model based design sucks</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-07-18T11:06:00-04:00">
                2019-07-18
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/07/18/model-based-design-sucks/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/07/18/model-based-design-sucks/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>AV development includes <code>perception</code>, <code>sensor fusion</code>, <code>location &amp; mapping</code>, <code>decision-making &amp; control</code> (or motion planning),  <code>embedded</code>, <code>simulation</code> and maybe many system-glue software tools.</p>
<p>L3 <code>planning &amp; control</code> is now expert-based decision system, which basically defines rules to make decision, where model based design(mbd) is a helper.</p>
<p>Waymo mentioned their hybrid decision-making solution, basically Machine Learning(ML) will take a big part of the situations, but still space to allow rule-based solution to take priority. </p>
<p>when consider to <a href="https://36kr.com/p/5063036" target="_blank" rel="external">ML decision making</a>, mdb will become less useful.  </p>
<h3 id="why-model-based"><a href="#why-model-based" class="headerlink" title="why model-based"></a>why model-based</h3><p>Traditional OEMs follow vehicle-level safety requirements(ASIL-D) to develop vehicle products and  components, usually can be represented as the <code>V</code> style development, from user requirs, system design,  implmenent to test verification. </p>
<p>to go through the whole <code>V</code> process take a rather long time, e.g. for a new vehicle model, it means 2~5 years. Commercial hardware and software(mobile apps) products which has lower level safety requirements, however, can iterate in a quicker frequency. </p>
<p>the safety requirements drive the product development in a very different way, compared to common Internet products, which include more straight-forward programming skills and software architecture mindset. but to satisfy the additional, or should say the priority safety requirements, how to organize the code is less important than how to verify the functions is to satisfy the safety.</p>
<p>so there comes the model-based design, the most-highly feature of which is to support system test and verify at pre-product period.</p>
<p>of course, model-based design should be easily to build up prototype and visualize the system, which is the second feature of mbd, working similar like a microsoft vision e.t.c</p>
<p>thirdly, from design to product, is auto code generation. which means once the design is verified, you don’t need to go back to write code again, but directly generate code from the design graph. </p>
<p>model-based design toolchain is already a whole eco-system, e.g. system design, auto code generator, test tools. and all these tools should be first verified by ASIL-D standard. </p>
<p>Internet AI companies once thought it would be easy to take over this traditional development by Internet agile development, while the reality is they still depends on model-based design at first to verify the system, then back to implement code again, which should be more optimized than auto-generated ones, which is one drawbacks of mbd, as mbd is tool-depended, e.g. Matlab, if Matlab doesn’t support some most updated libs, then they are not in the auto-code, and most time Matlab is far behind the stable version of libs outside. </p>
<h3 id="what-mbd-can’t-do"><a href="#what-mbd-can’t-do" class="headerlink" title="what mbd can’t do"></a>what mbd can’t do</h3><p>mbd is born to satisfy safety requirments in product development. so any non safety required product won’t use mbd.</p>
<p>and by nature, mbd is good at turning mathematical expressions to system languages, and logical relations to state flows, so any non-articulatable system is difficult to represent in mdb languages.  </p>
<p>in vehicle product development, engine, powertrain, ECU, brake system, ADAS, L3 motion planning, e.t.c have depends heavily on mbd.</p>
<p>but also we can predict, L3+ applications arise, with image, cloud point based object detection, data fusion, SLAM, AI-driven planning, IVI, V2X, will hybrid mbd with many Internet code style.</p>
<h3 id="industry-experience-a-metaphysics"><a href="#industry-experience-a-metaphysics" class="headerlink" title="industry experience: a metaphysics"></a>industry experience: a metaphysics</h3><p>some friends say mass-product-experience makes him more value than new birds. since industry experience is not transparent, as there is a no clear bar to test the ability/value of the enginer, unlike developers, who can valued by their product, or skills, also the same reason make these guys who stay long in the industry sounds more valued, and they have more likey went through one or many mass product experience. </p>
<p>but at most, industry product depends e.g. vehicle, on teamwork, even the team lead can’t make it by himself, unlike developer, a top developer can make a huge difference, much valued than a team of ordinary ones.  </p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/15/autosar-sucks/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/15/autosar-sucks/" itemprop="url">autosar sucks</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-07-15T10:29:53-04:00">
                2019-07-15
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/07/15/autosar-sucks/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/07/15/autosar-sucks/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="what-is-AUTOSAR"><a href="#what-is-AUTOSAR" class="headerlink" title="what is AUTOSAR"></a>what is AUTOSAR</h2><p>basically it’s an micro-service architecture for vehicle EE system. </p>
<p>Each micro-service is called software component(<code>swc</code>), and it has uniform interfaces, while of which the implementation is varied. as the goal of AUTOSAR said: share on the standard (interface), compete in the implementation. </p>
<p>the inter-connect of micro-services is through virtual function bus(<code>vfb</code>),  which works as a gateway, guiding data flow from port A, from micro-serviceA to port B, from micro-serviceB</p>
<p>the benefits of AUTOSAR is obvious, to design the interface at system level first, if any changed need, it can be updated quickly. after the system architecture is fixed, then go to the implementation details.</p>
<p><a href="https://automotivetechis.wordpress.com/autosar-concepts/" target="_blank" rel="external">refer</a> </p>
<h3 id="input-description"><a href="#input-description" class="headerlink" title="input description"></a>input description</h3><ul>
<li><p>software components(micro-services) description, only define the data flow, interface functions</p>
</li>
<li><p>system, system topology(interconnection among ECUs, and available data buses, protocols etc)</p>
</li>
<li><p>hardware, the available hardware(processors, sensors, actuators etc) </p>
</li>
</ul>
<h3 id="system-configuration"><a href="#system-configuration" class="headerlink" title="system configuration"></a>system configuration</h3><p>used to distributes the software component descritpions to different ECU</p>
<h3 id="ECU-configuration"><a href="#ECU-configuration" class="headerlink" title="ECU configuration"></a>ECU configuration</h3><p>the basic software(BST) and run-time environment(<code>rte</code>) of each ECU has been configured, this is based on the dedication of the application software components to each ECU.</p>
<h3 id="generation-of-executables"><a href="#generation-of-executables" class="headerlink" title="generation of executables"></a>generation of executables</h3><p>in this step to implement the software components, then build.  this can be automated done by tool-chains. </p>
<p>all steps up to now are supported by defining exchange formats(xml) and work methods.</p>
<p><img src="https://automotivetechis.files.wordpress.com/2012/05/untitled2.jpg" alt="image"></p>
<h2 id="basic-software"><a href="#basic-software" class="headerlink" title="basic software"></a>basic software</h2><p>each swc has well-defined ports, either provider port(PPort) or request port(RPort), the swc interface can either be a client-server interface or sender-receiver interface. </p>
<p>with a PPort, the swc will impelment data generation; with a RPort, the swc will implement data read.</p>
<p><code>communication manager</code> (ComM), is a resource mananger to encapsulates communication related basic software modules. </p>
<p>the actual bus states are controlled by the corresponding <code>bus state manager</code>, e.g.  CAN/FlexRay/Lin bus. when ComM request a specific commmunication mode from the state manager, it will map the communication mode to a special bus state.</p>
<p><code>network management modules</code> (NM) works in bus-sleep mode and only support broadcast communication.</p>
<p><code>diagnostic communication manager</code>(DCM), a common API for diagnostic services. </p>
<p><code>CAN driver</code> performs the hardware access and provides a hardware-independent API to upper layers; it can access hardware resources and converts the given information for transmission into a hardware specic format and triggers the transmission.</p>
<h3 id="runtime-environment-RTE"><a href="#runtime-environment-RTE" class="headerlink" title="runtime environment(RTE)"></a>runtime environment(RTE)</h3><p>between basic software to upper application softwares, I think it’s mostly <code>vfb</code>. </p>
<h3 id="application-software-components"><a href="#application-software-components" class="headerlink" title="application software components"></a>application software components</h3><p>for now, e.g. ADAS, traditional EE.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/13/play-with-ros/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/13/play-with-ros/" itemprop="url">play with ros</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-07-13T11:31:42-04:00">
                2019-07-13
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/07/13/play-with-ros/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/07/13/play-with-ros/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="ros-filesystem-tools"><a href="#ros-filesystem-tools" class="headerlink" title="ros filesystem tools"></a>ros filesystem tools</h2><p>first check ROS_PACKAGE_PATH, where defines all ROS packages that are within the directories.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">rospack find [package-name]</div><div class="line">rospack list </div><div class="line">roscd [package-name]</div><div class="line">``` </div><div class="line"></div><div class="line">take an example, to locate `rosbridge_websocket.launch` </div><div class="line"></div><div class="line">```shell </div><div class="line">rospack find rosbridge*    #rosbridge_server</div><div class="line">roscd rosbridge_server</div><div class="line">cd launch</div></pre></td></tr></table></figure>
<p>another tool to view ros-launch: <code>roslaunch-logs</code></p>
<h2 id="write-a-launch-file"><a href="#write-a-launch-file" class="headerlink" title="write a .launch file"></a>write a .launch file</h2><p>launch files, which uses XML format, usually make a directory named “launch” inside the workspace to organize all launch files, and it provides a convenient way to start up multiple nodes and master, it processs in a <a href="http://wiki.ros.org/roslaunch/XML" target="_blank" rel="external">depth-first tarversal order</a>. usually launch files can be put a <code>launch</code> folder under a ros node project. </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">roslaunch package_name launch_file</div><div class="line"><span class="meta">#</span>or </div><div class="line">roslaunch /path/to/launch_file</div></pre></td></tr></table></figure>
<p>an sample launch file:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">launch</span>&gt;</span> </div><div class="line">   <span class="tag">&lt;<span class="name">node</span> <span class="attr">pkg</span>=<span class="string">"package_name"</span>  <span class="attr">type</span>=<span class="string">" "</span>   <span class="attr">name</span>=<span class="string">" "</span>  <span class="attr">output</span>=<span class="string">" "</span> <span class="attr">args</span>=<span class="string">" "</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">launch</span>&gt;</span></div></pre></td></tr></table></figure>
<p><code>args</code> can define either env variables or a command.</p>
<p><a href="http://wiki.ros.org/roslaunch/XML/node" target="_blank" rel="external">node/type</a> There must be a corresponding executable with the same name.</p>
<h2 id="rviz"><a href="#rviz" class="headerlink" title="rviz"></a>rviz</h2><p>rviz can help to playback sensor rosbag at lab. and also the visualization tool in algorithm/simulation development. </p>
<p>someone(at 2014) said Google’s self-driving simulation has used rviz:</p>
<p><img src="http://community.bwbot.org/assets/uploads/files/1472264009114-3.png?v=qboavrogdv4" alt="google simulation"> </p>
<p><a href="http://stevenshi.me/2017/07/11/ros-intermediate-tutorial-2/" target="_blank" rel="external">a sample</a> with rviz to visualize rosbag info: </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> terminal 1 </div><div class="line">roscore </div><div class="line"><span class="meta">#</span> terminal 2 </div><div class="line">rosbag play kitti.bag -l </div><div class="line">rosrun rviz rviz -f kitti-velodyne</div></pre></td></tr></table></figure>
<h2 id="rosbag"><a href="#rosbag" class="headerlink" title="rosbag"></a>rosbag</h2><p>the sensor ros node will collect data in rosbag during physical or vitual test, then playback rosbag to develop or verify the sensing algorithms. or use to build simulation scene. </p>
<p>a few <a href="http://wiki.ros.org/rosbag/Commandline" target="_blank" rel="external">common commands</a>, and also rosbag support interactive <a href="http://wiki.ros.org/rosbag/Code%20API" target="_blank" rel="external">C++/Python APIs</a>. </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">rosbag record #use to write a bag file wit contents on the specified topics</div><div class="line">rosbag info #display the contents of bag files </div><div class="line">rosbag play #play back bag file in a time-synchronized fashion</div></pre></td></tr></table></figure>
<h2 id="kitti-dataset"><a href="#kitti-dataset" class="headerlink" title="kitti dataset"></a>kitti dataset</h2><p><code>are we ready for autonoous driving?</code> – the KITTI vision benchmark suite, which is a famous test dataset in self-driving sensing, prediction also mapping and SLAM algorithm development. </p>
<p>there are a few benchmars includes:</p>
<ul>
<li><p>stereo,  basically rebuild the 3D object from multi 2D images.</p>
</li>
<li><p>optical flow, used to detect object movement(speed, direction)</p>
</li>
<li>scene flow, include other 3D env info, and  objects from optical flow </li>
<li>depth </li>
<li>visual odometry</li>
<li>object detection </li>
<li>object tracking </li>
<li>road/lane detection </li>
<li>semantic evaluation </li>
</ul>
<h2 id="catkin-package"><a href="#catkin-package" class="headerlink" title="catkin package"></a>catkin package</h2><p>catkin is ros package build/manage tool. </p>
<pre><code class="shell">mkdir -p ~/catkin_ws/src
cd ~/catkin_ws/src
catkin_create_pgk demo std_msgs rviz 
cd demo
mkdir launch
cat "&lt;launch&gt; &lt;node  name="demo"  type="rviz" -d="ls `pwd`" /&gt; &lt;/launch&gt; " &gt;  demo.launch
cd ~/catkin_ws
catkin_make --pkg demo
<span class="meta">
#</span> add catkin_ws to 
cat "export ROS_PACKAGE_PATH=$ROS_PACKAGE_PATH:/path/to/catkin_ws/" &gt;&gt; ~/.bashrc
</code></pre>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/12/play-with-Docker-swarm-compose/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/12/play-with-Docker-swarm-compose/" itemprop="url">play with Docker swarm/compose</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-07-12T11:18:26-04:00">
                2019-07-12
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/07/12/play-with-Docker-swarm-compose/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/07/12/play-with-Docker-swarm-compose/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Docker-swarm"><a href="#Docker-swarm" class="headerlink" title="Docker swarm"></a>Docker swarm</h2><p>docker swarm is Docker nature cluster manager, with built-in DNS service found mechanism, and load-balancing mechanism. compare to k8s, is a light-weight and easy goers.</p>
<h3 id="create-a-swarm-cluster"><a href="#create-a-swarm-cluster" class="headerlink" title="create a swarm cluster"></a>create a swarm cluster</h3><figure class="highlight bat"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">export MASTER_IP=<span class="number">192</span>.<span class="number">168</span>.<span class="number">0</span>.<span class="number">1</span></div><div class="line"></div><div class="line">docker swarm init --advertise-addr $&#123;MASTER_IP&#125; --name master</div><div class="line"></div><div class="line">docker swarm join --token tokens $&#123;MASTER_IP&#125;  --name  worker1 </div><div class="line"></div><div class="line">docker node ls </div><div class="line"></div><div class="line"># demote/ promote nodeID as manager</div><div class="line">docker node demote/promote nodeID</div><div class="line"></div><div class="line"># rm node </div><div class="line">docker node rm worker1</div><div class="line"># stop swarm <span class="built_in">mode</span> </div><div class="line">docker swarm leave</div></pre></td></tr></table></figure>
<h3 id="create-service"><a href="#create-service" class="headerlink" title="create service"></a>create service</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">docker service create  service-name</div><div class="line"><span class="meta"></span></div><div class="line"> # scale service</div><div class="line">docker service scael SERVICE=replicas </div><div class="line"></div><div class="line">docker service rm </div><div class="line"></div><div class="line">docker service inspect</div></pre></td></tr></table></figure>
<h3 id="create-overlay-network"><a href="#create-overlay-network" class="headerlink" title="create overlay network"></a>create overlay network</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">docker network create --subnet=192.168.0.0/24  -d overlay ppss-net</div><div class="line"></div><div class="line">docker network rm</div><div class="line"></div><div class="line">docker network connect network-name  docker-node</div></pre></td></tr></table></figure>
<p>in swarm mode, there are three network created by default:</p>
<ul>
<li>bridge0, the default network</li>
<li>docker_gwbridge,  local bridge used to connect containers hosted in the same host</li>
<li>ingress,  is a overlay network used in the swarm cluster</li>
</ul>
<p>however, in swarm mode, the default network for service is <code>bridge</code>, to across physical host, services need go through <code>overlay</code> network. </p>
<h3 id="load-balancing"><a href="#load-balancing" class="headerlink" title="load balancing"></a>load balancing</h3><h4 id="Ingress-load-balancing"><a href="#Ingress-load-balancing" class="headerlink" title="Ingress load balancing"></a>Ingress load balancing</h4><p>expose Docker service to external network env</p>
<h4 id="Internal-load-balancing"><a href="#Internal-load-balancing" class="headerlink" title="Internal load balancing"></a>Internal load balancing</h4><p>swarm mode has build-in DNS</p>
<h2 id="Docker-compose"><a href="#Docker-compose" class="headerlink" title="Docker compose"></a>Docker compose</h2><p>docker compose is a manage/build tool to create application, which combine a bunch of micro-services, each of which can be ran as a Docker container.</p>
<p>the <code>docker-compose.yml</code> configure file has to include  each micro-service Dockerfile, and the application running scripts.</p>
<h3 id="service-startup-order"><a href="#service-startup-order" class="headerlink" title="service startup order"></a>service startup order</h3><p>the services defined in <code>docker-compose.yml</code> is not necessary depended to each other, so each serice can <code>up</code> individually, but of course they can has based on each other. </p>
<h3 id="docker-compose-yml"><a href="#docker-compose-yml" class="headerlink" title="docker-compose.yml"></a>docker-compose.yml</h3><p><a href="https://yeasy.gitbooks.io/docker_practice/compose/compose_file.html#volumes" target="_blank" rel="external">best practice</a></p>
<ul>
<li><p>build</p>
<p>path to Dockerfile, can be absolute path or relative (to .yml) path. Compose will buid the image based on </p>
</li>
<li><p>context<br>sub-choice under build, point to the Dockerfile</p>
</li>
<li><p>image </p>
<p>the image will be used, if not locally, will pull from hub (vs Dockerfile) </p>
</li>
<li><p>containe_name</p>
</li>
<li><p>volumes<br>  path to attached volumes, in the format <code>HOST:CONTAINER[:access mode]</code></p>
</li>
<li>network_mode</li>
</ul>
<p>same as  <code>docker run --network</code></p>
<ul>
<li><p>init</p>
</li>
<li><p>privileged</p>
</li>
</ul>
<ul>
<li>command</li>
</ul>
<p>override launch command when service contianer start</p>
<ul>
<li>environment</li>
</ul>
<p>set env variables, in the format <code>ENV:value</code><br>if only <code>ENV</code>, the value will be derived from host machine</p>
<ul>
<li>runtime:  nvidia </li>
</ul>
<p>to suuport <code>nvidia-docker</code> </p>
<p>e.g.  </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">nvsmi:</div><div class="line">	image: ubuntu:16.04</div><div class="line">	runtime: nvidia</div><div class="line">	environment:</div><div class="line">	     - NVIDIA VISIBLE DEVICES=all</div><div class="line">	command:  nvidia-smi</div></pre></td></tr></table></figure>
<ul>
<li>stdin_open</li>
</ul>
<p>std io aviable</p>
<ul>
<li>tty </li>
</ul>
<p>virtual terminal </p>
<h4 id="sample-yml-from-project"><a href="#sample-yml-from-project" class="headerlink" title="sample yml from project"></a>sample yml from project</h4><p>a sample yml for web app:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">services:</div><div class="line"></div><div class="line">	web:</div><div class="line">	   build: . </div><div class="line">	   links: </div><div class="line">	   		- "db: database"</div><div class="line">   db:</div><div class="line">       image: postgres</div></pre></td></tr></table></figure>
<p>a sample yml for general <a href="https://github.com/lgsvl/second-ros/blob/master/docker-compose.yml" target="_blank" rel="external">app CI</a>:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">services:</div><div class="line"></div><div class="line">	build:</div><div class="line">	</div><div class="line">		build: </div><div class="line">			context: ./Dockerfile</div><div class="line">	    image:  docker-image</div><div class="line">	    container_name: build_app</div><div class="line">	    volumes:</div><div class="line">	    	- ./build_scripts: /root/build</div><div class="line">	    commands:  /root/build/build.sh</div><div class="line">	   </div><div class="line">	    run:</div><div class="line">	    	context:	./Dockerfile</div><div class="line">	    	image:   docker-iamge</div><div class="line">	    	container_name: run_app</div><div class="line">	    	volumes:</div><div class="line">	    	   - ./run_scripts:/root/run</div><div class="line">	    	environments:</div><div class="line">	    	   -DISPLAY</div><div class="line">	    	   -ROS_MASTER</div><div class="line">	    	network_mode: host</div><div class="line">	    	runtime: nvidia</div><div class="line">	    	command: /root/run/run.sh </div><div class="line">	    </div><div class="line">	    test:</div><div class="line">	       #TODO</div></pre></td></tr></table></figure>
<h2 id="docker-machine"><a href="#docker-machine" class="headerlink" title="docker-machine"></a>docker-machine</h2><p>docker-machine is a tool to build virtial host when hosted in one physical host or among multi-physical hosts. </p>
<h2 id="ros-docker"><a href="#ros-docker" class="headerlink" title="ros-docker"></a>ros-docker</h2><p>in self-driving software stack, ros is often used. and there is a need to deploy ros in docker. next time.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="David Z.J. Lee" />
          <p class="site-author-name" itemprop="name">David Z.J. Lee</p>
           
              <p class="site-description motion-element" itemprop="description">what I don't know</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">140</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">33</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/ZJLi2013" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.linkedin.com/in/zhengjia13/" target="_blank" title="LinkedIn">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  LinkedIn
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">David Z.J. Lee</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://zjlee.disqus.com/count.js" async></script>
    

    

  




	





  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
