<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="what I don&apos;t know">
<meta property="og:type" content="website">
<meta property="og:title" content="Serious Autonomous Vehicles">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="Serious Autonomous Vehicles">
<meta property="og:description" content="what I don&apos;t know">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Serious Autonomous Vehicles">
<meta name="twitter:description" content="what I don&apos;t know">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/"/>





  <title>Serious Autonomous Vehicles</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Serious Autonomous Vehicles</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/06/design-a-data-center-for-ADS-applications/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/06/design-a-data-center-for-ADS-applications/" itemprop="url">design a data center for ADS applications</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-04-06T04:57:57-04:00">
                2020-04-06
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/04/06/design-a-data-center-for-ADS-applications/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/04/06/design-a-data-center-for-ADS-applications/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="background"><a href="#background" class="headerlink" title="background"></a>background</h2><p>A system’s back end can be made up of a number of bare metal servers, data storage facilities, virtual machines, a security mechanism, and services, all built in conformance with a deployment model, and all together responsible for providing a service.</p>
<h4 id="points-to-consider"><a href="#points-to-consider" class="headerlink" title="points to consider"></a>points to consider</h4><ul>
<li><p>it’s the primary authority and responsibility of the back end to provide a built-in security mechanism, traffic control and protocols.</p>
</li>
<li><p>a central server is responsible for managing and running the system, systematically reviewing the traffic and client request to make certain that everything is running smoothly.</p>
</li>
</ul>
<h2 id="service-viewport"><a href="#service-viewport" class="headerlink" title="service viewport"></a>service viewport</h2><h4 id="busniess-services"><a href="#busniess-services" class="headerlink" title="busniess services"></a>busniess services</h4><p>the most common busniess services or <code>application-as-a-service(aaas)</code> in ADS data center includes:</p>
<ul>
<li><p>massively scenario simualtion</p>
</li>
<li><p>open-loop re-play simulation </p>
</li>
<li><p>AI training </p>
</li>
<li><p>sensor data analysis</p>
</li>
<li><p>test driven algorithms dev</p>
</li>
</ul>
<h4 id="platform-as-a-service"><a href="#platform-as-a-service" class="headerlink" title="platform as a service"></a>platform as a service</h4><p>busniess services can be considered as the most abstract level services,  paas consider how to support the upper level needs. a few components are obvious:</p>
<ul>
<li><p>distributed data storage(aws s3, ceph)</p>
</li>
<li><p>massively data analysis(hadoop)</p>
</li>
<li><p>massively compute nodes(k8s/docker)</p>
</li>
<li><p>vdi server pool</p>
</li>
<li><p>sql</p>
</li>
<li><p>web server for end-user UI</p>
</li>
</ul>
<h4 id="IaaS"><a href="#IaaS" class="headerlink" title="IaaS"></a>IaaS</h4><p>to support PaaS, we need CPUs, GPUs, network, either in physical mode or virtual mode. the common private cloud vendor would suggest a general virtualization layer, to manage all resources in one shot. but there is always an balance between the easy manage and performance lost. </p>
<p>for large auto industry OEMs, no doubt <code>easy manage</code> is crucial. so it’s suggested to implement virtual layer(either vmware or customized kvm). if not, I wonder the self-maintainaince will be a disaster in future. </p>
<h2 id="security-in-cloud"><a href="#security-in-cloud" class="headerlink" title="security in cloud"></a>security in cloud</h2><h4 id="who-is-Cybersecurity-professional"><a href="#who-is-Cybersecurity-professional" class="headerlink" title="who is Cybersecurity professional"></a><a href="https://cloudacademy.com/blog/how-to-become-a-cybersecurity-professional/" target="_blank" rel="external">who is Cybersecurity professional</a></h4><p>the guy who provide security during the development stages of software systems, networks, and data centers. </p>
<p>must make security measures for any information by designing various defensive systems and strategies against intruders. </p>
<p> The specialist must create new defensive systems and protocols and report incidents. Granting permissions and privileges to authorized users is also their job.</p>
<p> The cybersecurity professional must maintain IT security controls documentation, recognize the security gaps, and prepare an action plan accordingly. </p>
<p> Cybersecurity professionals enable security in IT infrastructure, data, edge devices, and networks.</p>
<h4 id="Azure-Security-best-practices"><a href="#Azure-Security-best-practices" class="headerlink" title="Azure Security: best practices"></a><a href="https://cloudacademy.com/blog/azure-security-best-practices-you-need-to-know/" target="_blank" rel="external">Azure Security: best practices</a></h4><ul>
<li><p>control network access </p>
<p>   At this ring you typically find Firewall policies, Distributed Denial of Service (DDoS) prevention, Intrusion Detection and Intrusion Prevention systems (IDS/IPS), Web Content Filtering, and Vulnerability Management such as Network Anti-Malware, Application Controls, and Antivirus.</p>
<p>   The second ring is often a Network Security Group (or NSG) applied to the subnet. Network Security Groups allow you to filter network traffic to and from Azure resources in an Azure virtual network.</p>
<pre><code>all subnets in an Azure Virtual Network (VNet) can communicate freely. By using a network security group for network access control between subnets, you can establish a different security zone or role for each subnet. As such, all subnets should be associated with a properly configured Network Security Group. 

With a virtual server, there is a third ring which is a Network Security Group (NSG) applied to virtual machines network interfaces, 

avoid exposure to the internet with a dedicated WAN connection. Azure offers both site-to-site VPN and ExpressRoute for this purpose.
</code></pre></li>
</ul>
<ul>
<li>disable remote access (ssh/rdp) </li>
</ul>
<p>disable remote access to vm from internet. ssh/rdp only should be provided over a secure dedicated conenction using Just-In-time(JIT) vm access.</p>
<p> the Just-In-Time VM access policy configures at the NSG to lock down the virtual machines remote management ports. When an authorized user requires access to the VM, they will use Just-In-Time VM Access to request access for up to three hours. After the requested time has elapsed, Azure locks the management ports down to help reduce susceptibility to an attack.</p>
<ul>
<li>update vm</li>
</ul>
<p>You need to run antivirus and anti-malware. and requires system updates for VMs hosted in Azure</p>
<ul>
<li><p>safeguard sensitive data </p>
</li>
<li><p>enable encryption </p>
</li>
</ul>
<ul>
<li><a href="https://docs.microsoft.com/en-us/archive/blogs/azuresecurity/what-does-shared-responsibility-in-the-cloud-mean" target="_blank" rel="external">shared responsibility</a></li>
</ul>
<p><img src="https://msdnshared.blob.core.windows.net/media/2016/04/image_thumb601.png" alt="image"></p>
<h4 id="aws-security-instance-level-security"><a href="#aws-security-instance-level-security" class="headerlink" title="aws security: instance level security"></a><a href="https://cloudacademy.com/blog/aws-security-groups-instance-level-security/" target="_blank" rel="external">aws security: instance level security</a></h4><ul>
<li><p>AWS security groups, provides security at the protocol and port access level, working much the same way as a firewall – contains a set of rules that filter traffic coming in and out of an EC2 instance. </p>
</li>
<li><p>os security path management </p>
</li>
<li><p>key pairs(public and private key to login EC2 instance)</p>
</li>
</ul>
<h4 id="aws-security-network-ACL-and-subnets-network-level-security"><a href="#aws-security-network-ACL-and-subnets-network-level-security" class="headerlink" title="aws security: network ACL and subnets: network level security"></a><a href="https://cloudacademy.com/blog/aws-network-acl-vpc-subnets-network-security/" target="_blank" rel="external">aws security: network ACL and subnets: network level security</a></h4><h4 id="aws-security-bastion-hosts"><a href="#aws-security-bastion-hosts" class="headerlink" title="aws security: bastion hosts"></a><a href="https://cloudacademy.com/blog/aws-bastion-host-nat-instances-vpc-peering-security/" target="_blank" rel="external">aws security: bastion hosts</a></h4><p>the connectivity flowing from an end-user to resources on a private subnet through a bastion host: </p>
<p><img src="https://d1o2okarmduwny.cloudfront.net/wp-content/uploads/2015/11/aws-bastion-host-1.png" alt="image"></p>
<ul>
<li>updates to bastion host </li>
</ul>
<p>skip bastion if using Session Manager, to securely connect to private instance in virtual private cloud wthout needing bastion host or key-pairs</p>
<p>now push keys for short periods of time and use IAM policies to restrict access as you see fit. This reduces your compliance and audit footprint as well</p>
<ul>
<li>NAT(network address translation) [gateway] instance </li>
</ul>
<p>allows private instance outgoing connectivity to the internet while at the same time blocking inboud traffic from the internet </p>
<ul>
<li>VPC(virtual private cloud) peering </li>
</ul>
<p><img src="https://d1o2okarmduwny.cloudfront.net/wp-content/uploads/2015/11/aws-bastion-host-3.png" alt="image"></p>
<h4 id="aws-security-identity-and-access-management-IAM"><a href="#aws-security-identity-and-access-management-IAM" class="headerlink" title="aws security: identity and access management(IAM)"></a><a href="https://cloudacademy.com/blog/aws-security-identity-and-access-management-iam/" target="_blank" rel="external">aws security: identity and access management(IAM)</a></h4><p>governs and control user acces to VPC resoruces, it achieves the goal through Users/Group/Roles and Policies.</p>
<h2 id="network-topology-in-cloud"><a href="#network-topology-in-cloud" class="headerlink" title="network topology in cloud"></a>network topology in cloud</h2><h4 id="network-topology-at-first"><a href="#network-topology-at-first" class="headerlink" title="network topology at first"></a>network topology at first</h4><p>I would consider the data center network topology and security mechanism from the following four points:</p>
<ul>
<li>internal network topology</li>
</ul>
<p>basically the data center will have an internal network, to connect infrastructures, e.g. data storage nodes, k8s compute nodes, hadoop compute nodes, web server nodes,  vdi server nodes e.t.c.</p>
<ul>
<li>network gateway to end-users</li>
</ul>
<p>there should be a unique network gateway in data center, which is the only network IO for end-user access.</p>
<ul>
<li>network gateway to other private/public cloud</li>
</ul>
<p>we also need connect to other IT infrastructure, so needanother network gateway.</p>
<p>the two gateways above, can be either virtual gateway or physical gateway, depends on our hardware. e.g. vlan, bridge, or physical gateway</p>
<ul>
<li>admin pass-through network</li>
</ul>
<p>network gateway is the normal user access port, but for admin, specially for sysm management, trouble-shooting, e.t.c, we need a pass-through network, which basically directly connect to internal network of data center,<br>admin pass-through network is speed limited, so only for special admin usage.</p>
<h4 id="h3c-浅谈数据中心网络架构的发展"><a href="#h3c-浅谈数据中心网络架构的发展" class="headerlink" title="h3c: 浅谈数据中心网络架构的发展"></a><a href="http://www.h3c.com/CN/D_201405/826868_30008_0.htm" target="_blank" rel="external">h3c: 浅谈数据中心网络架构的发展</a></h4><ul>
<li>接入层，用于连接所有的计算节点，在较大规模的数据中心中，通常以柜顶交换机的形式存在；</li>
<li>汇聚层，用于接入层的互联，并作为该汇聚区域二三层的边界，同时各种防火墙、负载均衡等业务也部署于此；</li>
<li>核心层，用于汇聚层的的互联，并实现整个数据中心与外部网络的三层通信。</li>
</ul>
<p>传统的数据中心内，服务器主要用于对外提供业务访问，不同的业务通过安全分区及VLAN隔离。一个分区通常集中了该业务所需的计算、网络及存储资源，不同的分区之间或者禁止互访，或者经由核心交换通过三层网络交互，数据中心的网络流量大部分集中于南北向.</p>
<p>在这种设计下，不同分区间计算资源无法共享，资源利用率低下的问题越来越突出。通过虚拟化技术、云计算管理技术等，将各个分区间的资源进行池化，实现数据中心内资源的有效利用。而随着这些新技术的兴起和应用，新的业务需求如虚拟机迁移、数据同步、数据备份、协同计算等在数据中心内开始实现部署，数据中心内部东西向流量开始大幅度增加。</p>
<h4 id="h3c-two-layer-network-arch"><a href="#h3c-two-layer-network-arch" class="headerlink" title="h3c: two-layer network arch"></a><a href="http://www.h3c.com/cn/d_201010/697894_30008_0.htm" target="_blank" rel="external">h3c: two-layer network arch</a></h4><ul>
<li>网络三层互联，或称为，数据中心前端网络互联。“前端网络”，是指数据中心面向企业园区的出口。不同数据中心的前端网络通过ip实现互联，园区或分支的客户端通过前端网络访问各数据中心。</li>
</ul>
<ul>
<li><p>网络两层互联，或称为，数据中心服务器网络互联。在不同数据中心服务器网络接入层，构建一个跨数据中心的搭二层网络(vlan)，以满足服务器集群或虚拟机动态迁移等场景</p>
</li>
<li><p>san互联，也称为，后端存储网络互联。借助传输技术，实现主中心、灾备中心间磁盘阵列的数据复制</p>
</li>
</ul>
<p>二层互联的业务需求：保证服务器的高可用集群。</p>
<p>二层互联设计要点：面对中小企业客户（ip网络）</p>
<h4 id="openstack-neutron-network-for-cloud"><a href="#openstack-neutron-network-for-cloud" class="headerlink" title="openstack neutron: network for cloud"></a><a href="https://www.cnblogs.com/pmyewei/p/6280445.html" target="_blank" rel="external">openstack neutron: network for cloud</a></h4><ul>
<li>data flow in data center: </li>
</ul>
<ul>
<li><p>manage(API) network, basically the internal managed network</p>
</li>
<li><p>user network</p>
</li>
<li><p>external network, including vpn, firewall </p>
</li>
<li><p>storage network, connect from computing nodes to storage ndoes </p>
</li>
</ul>
<ul>
<li>NSX arch</li>
</ul>
<p><img src="https://images2015.cnblogs.com/blog/1009737/201701/1009737-20170116004552494-794532203.png" alt="image"></p>
<p>the left most part is computing nodes, for customers bussniess, the dataflow includes: user-network, storage, internal-network, all of which requires 3 NIC</p>
<p>the middle part is infrastructure, including managing nodes, shared storage, which brings IP based storage for the left most part.</p>
<p>the right edge part, is external(internet) network services for users, including network to users, as well as network to Internet, firewall, public IP address translation e.t.c.</p>
<p><img src="https://images2015.cnblogs.com/blog/1009737/201701/1009737-20170116004801510-1392260872.png" alt="image"></p>
<h4 id="ceph-subnets"><a href="#ceph-subnets" class="headerlink" title="ceph subnets"></a>ceph subnets</h4><p><img src="http://docs.ceph.org.cn/_images/ditaa-2452ee22ef7d825a489a08e0b935453f2b06b0e6.png" alt="image"></p>
<p>when consider ceph storage for k8s computing nodes, the public network also includes network switches to k8s, as well as normal user data access network switches.</p>
<ul>
<li><p>cluster network (Gb NIC, including osd and monitor)</p>
</li>
<li><p>ceph client(to k8s) network (gb)</p>
</li>
<li><p>ceph admin/user network(mb)</p>
</li>
</ul>
<h4 id="k8s-subnets"><a href="#k8s-subnets" class="headerlink" title="k8s subnets"></a>k8s subnets</h4><p><a href="https://zhuanlan.zhihu.com/p/90992878" target="_blank" rel="external">understand k8s network：pods, service, ingress</a></p>
<ul>
<li><p>pods, all containers in one pod, share the same network namespace. the network namespace of pod is different from that of the host machine, but the two is connected by <code>docker bridge</code> </p>
</li>
<li><p>services, handle the load balance among pods, as well as encapsulate the IPs of pods, so we don’t directly deal with the local dynamic IPs of pods.</p>
</li>
<li><p>how to access k8s service from exteral, or how user acces the k8s hosted in a remote data center?  <strong><a href="https://www.kuboard.cn/learning/k8s-intermediate/service/ingress.html#ingress" target="_blank" rel="external">ingress for k8s</a></strong></p>
</li>
</ul>
<p><img src="https://upload-images.jianshu.io/upload_images/1401434-5216e7cf94351457.jpg?imageMogr2/auto-orient/strip|imageView2/2/w/1200" alt="image"></p>
<p><a href="https://www.jianshu.com/p/ae2889daa0a5" target="_blank" rel="external">flannel</a><br> setup a two-layer network, the ip of pod is assigend by <code>flannel</code>, each node will has a <code>flannel0</code> virtual NIC, used for node-node communication. </p>
<h4 id="gpu-vdi-subnets"><a href="#gpu-vdi-subnets" class="headerlink" title="gpu vdi subnets"></a>gpu vdi subnets</h4><p>as mentioned in <a href="https://zjli2013.github.io/2020/04/02/gpu-vdi/" target="_blank" rel="external">gpu vdi</a>,  most solution has a customized vdi client, the vm manager internal network is handled by the vendors, maybe communicate through one Gb NIC, the client-server is simple TCP/ip.</p>
<h4 id="webserver-subnets"><a href="#webserver-subnets" class="headerlink" title="webserver subnets"></a>webserver subnets</h4><p>a few things in mind:</p>
<ul>
<li>using vm.</li>
</ul>
<p>web servers are better to deploy in vm, so whenever there is a hardware failure, it can detect and automatically transfer to another vm. </p>
<ul>
<li>communicate with in-house services </li>
</ul>
<p>in ADS data center, most web application need access data from either sql or even storage services directly, which means the web server need both external ingress services as well as handling internal IP access. </p>
<h4 id="network-manager"><a href="#network-manager" class="headerlink" title="network manager"></a>network manager</h4><p>the above subnet classification only consider each component itself, for a data center in whole, it’s better to manage all networks of internal subnets and access to external Internet in one module: network manager.</p>
<p>as mentioned in the previous section: <a href="">security in cloud</a>, the network manager module can further add some security mechanisms.  </p>
<h2 id="refere"><a href="#refere" class="headerlink" title="refere"></a>refere</h2><p><a href="https://cloudacademy.com/blog/cloud-computing-architecture-an-overview/" target="_blank" rel="external">cloud arch: front end &amp; back end</a></p>
<p><a href="https://cloudacademy.com/learning-paths/az-500-exam-preparation-microsoft-azure-security-technologies-650/" target="_blank" rel="external">Microsoft Azure security tech training courses</a></p>
<p><a href="https://cloudacademy.com/blog/foundation-certificate-in-cyber-security-fccs-learning-path/" target="_blank" rel="external">introduction the Foundation certificate in Cyber Security</a></p>
<p><a href="https://www2.cs.duke.edu/courses/fall10/cps296.2/lectures/16RoutingTopology.pdf" target="_blank" rel="external">datacenter network: topology and routing</a></p>
<p><a href="https://www.sdnlab.com/mininet-topology/" target="_blank" rel="external">miniNet for data center network topology</a></p>
<p><a href="https://www.cnblogs.com/pmyewei/p/6413875.html" target="_blank" rel="external">openstack neutron: two-layer network</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/02/gpu-vdi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/02/gpu-vdi/" itemprop="url">gpu vdi</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-04-02T03:44:08-04:00">
                2020-04-02
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/04/02/gpu-vdi/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/04/02/gpu-vdi/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="backgroud"><a href="#backgroud" class="headerlink" title="backgroud"></a>backgroud</h2><p>preivously, reviewed:</p>
<ul>
<li><p><a href="https://zjli2013.github.io/2020/03/14/hypervisor-and-gpu-virtualization/" target="_blank" rel="external">hypervisor and gpu virtualization</a></p>
</li>
<li><p><a href="https://zjli2013.github.io/2020/03/28/vmware-virtualization/" target="_blank" rel="external">vmware introduction</a></p>
</li>
</ul>
<p>this blog is a little bit futher of vmware and AMD GPU virtualization sln. </p>
<h2 id="AMD-virtualization"><a href="#AMD-virtualization" class="headerlink" title="AMD virtualization"></a>AMD virtualization</h2><h4 id="S7150x2"><a href="#S7150x2" class="headerlink" title="S7150x2"></a>S7150x2</h4><p>for remote graphic workstation, usually we separate host machine and local machines, where host machine is located in data center, and local machines are the end-user terminals at offices. </p>
<p>the host OS can be Windows 7/8, Linux, and hypervisor can be vmware ESXi 6.0;  guest os can be windows7/8, supported API includes: DX11.1, OpenGL</p>
<p>since S7150 has no local IO, os there is no <code>display</code> interface, just like a Nvidia Tesla GPU. </p>
<h4 id="SR-IOV"><a href="#SR-IOV" class="headerlink" title="SR-IOV"></a>SR-IOV</h4><ul>
<li>sr-iov arch </li>
</ul>
<p><img src="https://docs.microsoft.com/en-us/windows-hardware/drivers/network/images/sriovarchitecture.png" alt="image"></p>
<ul>
<li>Physical Function (PF)</li>
</ul>
<p>it’s  PCI-Express function of a network adapter that supports single root I/O virtualization(SR-IOV) interface. PF is exposed as a virtual network adapter(vLan) in the host OS, and the GPU driver in install in PF. </p>
<ul>
<li>Virtual Function (VF)</li>
</ul>
<p>it’s a lightweight PCIe function on a network adapter that supports SR-IOV. VF is associated with the PF on the network adapter, and represents a virtualized instance of the network adapter. each VF has its own PCI configuration space, and shares one or more physical resources(e.g. GPU) on the network adapter. </p>
<ul>
<li>GPU SR-IOV</li>
</ul>
<p>sr-iov basically split one PF(a PCIe resource) into multi VF(virtual PCIe resource). and each vf has its own Bus/Slot/Function id, which can used to access physical device/resources(e.g. GPU); Nvidia Grid vGPU is a different mechanism, where virtualization is implemented only in host machine side to assign device MAC address.</p>
<h4 id="GPU-resource-managment"><a href="#GPU-resource-managment" class="headerlink" title="GPU resource managment"></a>GPU resource managment</h4><ul>
<li>display </li>
</ul>
<p>GPU PF mangae the size of frameBuffer to each vf, and display virtualization. </p>
<ul>
<li>security check</li>
</ul>
<p>PF also do an address audit check and security check</p>
<ul>
<li>VF schedule</li>
</ul>
<p>GPU vf scheduler is similar as CPU process time-split. in a certain time period, the gpu is occupied by a certain vf. </p>
<h4 id="Multiuser-GPU-MxGPU"><a href="#Multiuser-GPU-MxGPU" class="headerlink" title="Multiuser GPU(MxGPU)"></a>Multiuser GPU(MxGPU)</h4><p><a href="https://www.amd.com/en/graphics/workstation-virtual-graphics" target="_blank" rel="external">AMD MxGPU</a> is the first hardware-based virtualized GPU solution, based on SR-IOV, and allows up to 16 vm per GPU to work remotely. </p>
<p><img src="https://www.amd.com/system/files/styles/1200px/private/76826-VDI-infographic-07032017-1260wide.png?itok=S5lPjqXR" alt="image"></p>
<p>now we see two GPU virtualization solutions:  </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">* Nvidia Tesla vGPU</div><div class="line">* AMD SR-VIO MxGPU</div></pre></td></tr></table></figure>
<p>vGPU is more software-based virtualization, but the performance is a little better; while MxGPU is hardware based. </p>
<h2 id="vmware-products"><a href="#vmware-products" class="headerlink" title="vmware products"></a>vmware products</h2><ul>
<li><p>the license-free products, e.g. vSphere Hypervisor, VMware Remote Console</p>
</li>
<li><p>the licensed and 60days-free products, e.g. vSAN, Horizon 7, vSphere</p>
</li>
</ul>
<h2 id="vSphere"><a href="#vSphere" class="headerlink" title="vSphere"></a>vSphere</h2><p>vSphere is the virtualization(hypervisor) layer of vmware products. there are two components: ESXi and vCenter Server. <code>exsi</code> is the core hypervisor, and <code>vcenter</code> is the service to mange multi vm in a network and host resources pool.</p>
<p><img src="https://docs.vmware.com/en/VMware-vSphere/images/GUID-CC660699-9EEC-4BAF-84AB-D992B0D8F2CA-low.png" alt="image"></p>
<h4 id="install-and-setup"><a href="#install-and-setup" class="headerlink" title="install and setup"></a>install and setup</h4><p>a few steps including:</p>
<ul>
<li><p>install ESXi on at least one host, either interactively or install through vSphere auto deploy, which include vServer. basically, <code>esxi</code> is free, and can be install on system as the hypervisor layer for any future vms. </p>
</li>
<li><p>setup esxi, e.g. esxi boot, network settings, direct console, syslog server for remote logging</p>
</li>
<li><p>deploy or install vCenter and services controller</p>
</li>
</ul>
<h2 id="Horizon"><a href="#Horizon" class="headerlink" title="Horizon"></a>Horizon</h2><p><img src="https://docs.vmware.com/en/VMware-Horizon-7/7.12/horizon-architecture-planning/images/GUID-5942D59B-AC5A-42F9-AD95-552C728E85AF-high.png" alt="image"></p>
<ul>
<li><p>client devices</p>
</li>
<li><p>Horizon client </p>
</li>
</ul>
<p>the client software for accesing remote desktops and apps, which will run on client devices. after logging in, users select from a list of remote desktops and apps that they are authorized to use. and admin can configure Horizon client to allow end users to select a display protocol.</p>
<ul>
<li>Horizon agent </li>
</ul>
<p>it’s installed on all vms, physical machines, storage server that used as <code>sources</code> for remote desktops and apps. if the remote desktop source is a vm, then first need install Horizon Agent service on that vm, and use the vm as a tepmplate, when create a pool from this vm, the agent is automatically installed on every remote desktop.</p>
<ul>
<li>Horizon admin</li>
</ul>
<p>used to configure Horizon connection server, deploy and manage remote desktops and apps, control user authentication e.t.c.</p>
<ul>
<li>Horizon connection server </li>
</ul>
<p>serve as a broker for client connections. </p>
<h4 id="a-rich-user-experience"><a href="#a-rich-user-experience" class="headerlink" title="a rich user experience"></a>a rich user experience</h4><ul>
<li>usb devices with remote desktops and apps </li>
</ul>
<p>basically can configure the ability to use USB devices from virtual desktop</p>
<ul>
<li>real-time video for webcams </li>
</ul>
<p>basically can use local client(end-user terminal)’s webcam or microphone in a remote desktop or published app. </p>
<ul>
<li>3d graphics</li>
</ul>
<p>with Blast or PCoIP display protocol enable remote desktop users to run 3D apps, e.g. google earch, CAD.</p>
<p>vSphere 6.0+ supports NVIDIA vGPU, basically share GPU among vms, as well as support amd GPU by vDAG, basically share gpu by making GPU appear as multiple PCI passthrough devies. </p>
<h4 id="desktop-or-app-pool"><a href="#desktop-or-app-pool" class="headerlink" title="desktop or app pool"></a>desktop or app pool</h4><p>first create one vm as a base image, then Horizon7 can generate a pool of remote desktops from the base image. similar for apps. </p>
<p>the benefit of desktop pool, if using vSphere vm as the base, is to automate the process of making as many identical virtual desktops as need, and the pool has manage tools to set or deploy apps to all virtual desktops in the same pool. for user assignment, either <code>dedicated-assignment pool</code>, which means each user is assigned a particular remote desktop adn returns to the same v-desktop at each login. it’s a one-to-one desktop-to-user relationship; or <code>floating-assignment pool</code>, basically users can shift to any v-desktop in the pool.</p>
<h4 id="security-features"><a href="#security-features" class="headerlink" title="security features"></a>security features</h4><ul>
<li><p>Horizon Client and Horizon Administrator communicate with a Horizon Connection Server host over secure HTTPS connections. </p>
</li>
<li><p>integrate two-factor authentication for user login</p>
</li>
<li><p>restrict remote desktop access by matching tags in v-desktop pool, but further restriction need design network topology to force certain clients to connect through. </p>
</li>
</ul>
<h2 id="refere"><a href="#refere" class="headerlink" title="refere"></a>refere</h2><p><a href="https://www.vmware.com/cn.html" target="_blank" rel="external">vmware product lists</a></p>
<p><a href="http://vga.zol.com.cn/581/5818519_all.html" target="_blank" rel="external">amd S7150 review</a></p>
<p><a href="https://developer.aliyun.com/ask/215008" target="_blank" rel="external">GPU SR-IOV</a></p>
<p><a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/network/sr-iov-virtual-functions--vfs-" target="_blank" rel="external">windows driver tech: PF &amp; VF</a></p>
<p><a href="https://docs.vmware.com/en/VMware-vSphere/6.7/com.vmware.esxi.install.doc/GUID-A71D7F56-6F47-43AB-9C4E-BAA89310F295.html" target="_blank" rel="external">vSphere install and setup doc</a></p>
<p><a href="https://docs.vmware.com/en/VMware-Horizon-7/index.html" target="_blank" rel="external">horizon7 install and setup doc</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/28/vmware-virtualization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/28/vmware-virtualization/" itemprop="url">vmware introduction</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-28T05:40:37-04:00">
                2020-03-28
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/28/vmware-virtualization/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/03/28/vmware-virtualization/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="background"><a href="#background" class="headerlink" title="background"></a>background</h2><p>sooner or later, we are in the direction of gpu virtualization, previously <a href="https://zjli2013.github.io/2020/03/14/hypervisor-and-gpu-virtualization/" target="_blank" rel="external">hypervisor and gpu virtual</a> is the first blog. recently, I’d went through openstack/kvm, vnc and now vmware. there is no doubt, any licensed product is not my prefer, but on the hand, it’s more expensive to hire an openstack engineer, compared to pay vmware. </p>
<p>vmware is not a windows-only, I had to throw my old mind first. the basic or back-end idea looks very similar to kvm. anyway, the core is <code>hypervisor layer</code>. once get understand one type of virtualization, it’s really easy to understand another. </p>
<h4 id="VMware-ESXi"><a href="#VMware-ESXi" class="headerlink" title="VMware ESXi"></a>VMware ESXi</h4><p><a href="https://www.vmware.com/products/esxi-and-esx.html" target="_blank" rel="external">ESXi hypervisor</a> is a Type1 or “bare metal” hypervisor,  also called <strong>vmware hypervisor</strong>, is a thin layer of software that interacts with the underlying resources of a physical computer(host machine), and allocates those resources to other os(guest machine).<br>and can support remotely access, just like kvm.</p>
<p>check <a href="https://pubs.vmware.com/vsphere-50/index.jsp?topic=%2Fcom.vmware.vsphere.install.doc_50%2FGUID-F3A960E9-57DF-4D2E-9127-A65AA670E643.html" target="_blank" rel="external">vSphere doc</a> about how to set BIOS and manage ESXi remotely.</p>
<p> <strong>BIOS boot configuration</strong> can be setted by configuring the boot order in BIOS during startup or by selecting a boot device from the boot device selection menu. the system BIOS has two options. One is for the boot sequence (floppy, CD-ROM, hard disk) and another for the hard disk boot order (USB key, local hard disk).</p>
<h4 id="VMware-workstation"><a href="#VMware-workstation" class="headerlink" title="VMware workstation"></a>VMware workstation</h4><p>workstation support multi guest os in a single host os(either windows or Linux), is a Type2 hypervisor, run as an app on host OS. one limitation of <code>workstation</code> is it only works in local host, can’t access remotely. </p>
<ul>
<li><p>free version,  <code>workstation player</code> </p>
</li>
<li><p>licensed version,  <code>workstation prof</code> </p>
</li>
</ul>
<p>in one word, workstation is good enough to multiple hardware usage, but not useful if remote access is required  </p>
<h4 id="VMware-vSphere"><a href="#VMware-vSphere" class="headerlink" title="VMware vSphere"></a>VMware vSphere</h4><p>the arch of vSphere has three layers:</p>
<ul>
<li><p>virtualization layer </p>
</li>
<li><p>management layer </p>
</li>
<li><p>interface layer(web, sdk, cli, virtual console)</p>
</li>
</ul>
<p>ESXi is the core hypervisor for VMware products, and also is the core of the vSphere package, the other two is: vSphere client and vSphere server.</p>
<p>vSphere server is enterprise-oriented, which is run based on ESXi layer. vSphere client is a client console/terminal. </p>
<ul>
<li><p><a href="https://www.vmware.com/cn/products/vsphere-hypervisor.html" target="_blank" rel="external">free version:  vSphere hypervisor</a></p>
</li>
<li><p><a href="https://www.vmware.com/cn/products/vcenter-server.html" target="_blank" rel="external">licensed fee version : vSphere with vServer</a></p>
</li>
</ul>
<p>nowadays there are no limitations on Physical CPU or RAM for Free ESXi. <a href="http://www.vmware.com/products/vsphere-hypervisor/gettingstarted.html" target="_blank" rel="external">here</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Specifications: </div><div class="line">Number of cores per physical CPU: No <span class="built_in">limit</span></div><div class="line">Number of physical CPUs per host: No <span class="built_in">limit</span></div><div class="line">Number of logical CPUs per host: 480</div><div class="line">Maximum vCPUs per virtual machine: 8</div></pre></td></tr></table></figure>
<h4 id="virtual-desktop-integration-VDI"><a href="#virtual-desktop-integration-VDI" class="headerlink" title="virtual desktop integration (VDI)"></a>virtual desktop integration (VDI)</h4><p>VDI virtualize a desktop OS on a server.  VDI offers centralized desktop management. the vmware tool is <code>VMware Horizon</code></p>
<h4 id="Horizon"><a href="#Horizon" class="headerlink" title="Horizon"></a>Horizon</h4><p>VMware Horizon can run VDI and apps in IT data center, and make VDI and apps as services to users. Horizon auto manage VDI and apps by simple setup configure files, then deliver apps or data from data center to end-user.</p>
<p>the modules in Horizon is extended-able and plug-in available:  physical layer, virtualization layer, desktop resource layer, app resource layer and user access. </p>
<p>Horizon basically delivers desktops and apps as a service. there are three versions:</p>
<ul>
<li><p>Horizon standard, a simple VDI.</p>
</li>
<li><p>Horizon advanced, can deliver desktops and apps through a unified workspace </p>
</li>
<li><p>Horizon enterprise, with a closed-loop management adn automation</p>
</li>
</ul>
<p>the <a href="https://techzone.vmware.com/resource/deploying-hardware-accelerated-graphics-vmware-horizon-7#sec1-sub1" target="_blank" rel="external">Horizon 7</a> has new features: </p>
<ul>
<li><p>Blast extrem display protocol</p>
</li>
<li><p>instant clone provisioning</p>
</li>
<li><p>vm app volumes app delivery </p>
</li>
<li><p>user env manager </p>
</li>
<li><p>integrated into remote desktop session host(RDSH) sessions </p>
</li>
</ul>
<h4 id="gpu-support-in-vmware"><a href="#gpu-support-in-vmware" class="headerlink" title="gpu support in vmware"></a>gpu support in vmware</h4><p>for vSphere, PCI passthrough can be used with any vSphere, including free vSphere Hypervisor. the only limitation is HW, may not supprot virtual well. GPU remotely accessible is our first-priority concern. </p>
<p>but vmware recommend their <a href="https://www.vmware.com/content/dam/digitalmarketing/vmware/en/pdf/partners/nvidia/vmware-nvidia-grid-vgpu-faq.pdf" target="_blank" rel="external">Horzion with NV’s vGPU</a><br>which has better flexibility and scalability. </p>
<p><a href="https://techzone.vmware.com/resource/deploying-hardware-accelerated-graphics-vmware-horizon-7#virtualsharedpassthroughgraphics" target="_blank" rel="external">Horizon support vGPU</a>, the user must install the appropriate vendor driver on the guest vm, all graphics commands are passed directly to GPU without having to be translated by the hypervisor. a vSphere Installation Bundle(VIB) is installed, which aids or perform the scheduling. depending on the card, up to 24 vm can share a GPU. most NV’s GPU which has vGPU feature can support. </p>
<p>on the other hand, the price of vGPU products(e.g. T4, M10, P6, V100, RTX8000 e.t.c) are 5 ~ 10 times higher than normal customer GPUs. e.g. GeFS not 5~10 times better. and the license fee for vgpu is horrible. </p>
<p>however, most enterprise still choice the Horzion and vGPU solution, even with this high cost. </p>
<p><a href="https://www.vmware.com/resources/compatibility/search.php" target="_blank" rel="external">VMware compatibility guide</a></p>
<h4 id="GPU-VDI-service-in-cloud"><a href="#GPU-VDI-service-in-cloud" class="headerlink" title="GPU VDI service in cloud"></a>GPU VDI service in cloud</h4><ul>
<li><a href="https://cloud.tencent.com/product/gpu" target="_blank" rel="external">tencent gpu cloud</a></li>
</ul>
<p>the gpu types for video decoding is Tesla P4, for  AI and HPC is Tesla v100, and for image workstation(VDI) is an AMD S7150.  </p>
<ul>
<li><a href="https://www.aliyun.com/product/ecs/gpu?spm=5176.224200.h2v3icoap.18.34ff6ed6KYchPn&amp;aly_as=aPNPrcAtg" target="_blank" rel="external">ali gpu cloud desktop</a></li>
</ul>
<p>the product is call <code>GA1(S7150)</code>, which is specially for cloud desktop.</p>
<p><a href="https://community.amd.com/thread/230570" target="_blank" rel="external">s7150x2 MxGPU with Horizon 7.5</a></p>
<h4 id="vnc-vs-vm"><a href="#vnc-vs-vm" class="headerlink" title="vnc vs vm"></a>vnc vs vm</h4><p>virtual network computing (vnc), applications running on one computer but displaying their windows on another. VNC provides remote control of a computer at some other location, any resources that are avaiable at the remote computer are available.  vpn simply connect you to a remote network.</p>
<p>no doubt, vm is much heavier than vnc. check <a href="https://blog.calsoftinc.com/2017/03/virtual-desktop-infrastructure-vdi-vs-remote-desktop-services-rds.html" target="_blank" rel="external">this blog</a> for compartion from vdi(a vm app) to vnc. vnc can’t tell if the remote is a physical server or a virtual server. come to our user case, we need about 100 separated user space, so virtualization provide better HW efficient and security, compared to deploy a single <code>bare metal OS</code> on the physical machine. </p>
<p>there are a few Linux based vnc client/server, e.g. <a href="https://linux.die.net/man/1/vncviewer" target="_blank" rel="external">vncviewer CLI</a>, as well as which supports OpenGL well, which helps to support better GPU usage. </p>
<ul>
<li><p><a href="https://virtualgl.org" target="_blank" rel="external">virtualGL</a></p>
</li>
<li><p><a href="http://www.karlrunge.com/x11vnc/" target="_blank" rel="external">x11vnc</a></p>
</li>
</ul>
<h2 id="refee"><a href="#refee" class="headerlink" title="refee"></a>refee</h2><p><a href="https://www.ibm.com/cloud/learn/vmware" target="_blank" rel="external">an essential vmware introduction from IBM</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/32873934" target="_blank" rel="external">what are vsphere, esxi, vcenter in Chienese</a></p>
<p><a href="https://www.vmware.com/products/vsphere-hypervisor.html" target="_blank" rel="external">vSphere Hypervisor</a></p>
<p><a href="https://pubs.vmware.com/vsphere-50/index.jsp?topic=%2Fcom.vmware.vsphere.install.doc_50%2FGUID-F3A960E9-57DF-4D2E-9127-A65AA670E643.html" target="_blank" rel="external">vmware vsphere doc</a></p>
<p><a href="https://blogs.vmware.com/apps/2018/10/how-to-enable-nvidia-v100-gpu-in-passthrough-mode-on-vsphere-for-machine-learning-and-other-hpc-workloads.html" target="_blank" rel="external">how to enable nvidia gpu in passthrough mode on vSphere</a></p>
<p><a href="https://docs.nvidia.com/grid/10.0/grid-vgpu-release-notes-vmware-vsphere/index.html" target="_blank" rel="external">nvidia vgpu for vmware release notes</a></p>
<p><a href="https://www.dell.com/support/article/en-us/sln288103/how-to-enable-a-vmware-virtual-machine-for-gpu-pass-through?lang=en" target="_blank" rel="external">how to enable vmware vm for GPU pass-through</a></p>
<p><a href="https://docs.openstack.org/project-deploy-guide/charm-deployment-guide/latest/app-pci-passthrough-gpu.html" target="_blank" rel="external">openstack PCI passthrough</a></p>
<p><a href="https://serverfault.com/questions/174003/how-can-opengl-graphics-be-displayed-remotely-using-vnc" target="_blank" rel="external">how can openGL graphics be displayed remotely using VNC</a></p>
<p><a href="http://www.azurew.com/vmware/horizon-7/3647.html" target="_blank" rel="external">vmware Horizon introduction in Chinese</a></p>
<p><a href="http://www.azurew.com/vmware/esxi-6-7/3622.html" target="_blank" rel="external">vmware ESXi 7.0 U1 test env build up</a></p>
<p><a href="https://www.sohu.com/a/334627623_314773" target="_blank" rel="external">云游戏能接盘矿卡市场吗</a></p>
<p><a href="http://www.azurew.com" target="_blank" rel="external">王哥哥的博客</a></p>
<p><a href="https://mp.sohu.com/profile?xpt=c29odXptdHoxem53c3ZAc29odS5jb20=&amp;_f=index_pagemp_1&amp;spm=smpc.content.author.2.1585641772438lK2g5Sw" target="_blank" rel="external">企业存储的博客</a></p>
<p><a href="https://blogs.vmware.com/euc/2015/03/nvidia-grid-vgpu-vmware-horizon.html" target="_blank" rel="external">in-depth: nv grid vGPU with vmware horizon 6.1</a></p>
<p><a href="https://www.nvidia.com/en-us/data-center/graphics-cards-for-virtualization/" target="_blank" rel="external">nvidia gpus recommended for virtualization</a></p>
<p><a href="https://developer.aliyun.com/ask/215008" target="_blank" rel="external">GPU SRIOV and AMD S7150</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/27/kvm-in-linux-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/27/kvm-in-linux-2/" itemprop="url">kvm in linux (2)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-27T04:04:00-04:00">
                2020-03-27
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/27/kvm-in-linux-2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/03/27/kvm-in-linux-2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="history-of-terminal"><a href="#history-of-terminal" class="headerlink" title="history of terminal"></a>history of terminal</h2><p>in history, computer is so huge and hosted at a big room, while the operator stay in another office room with another small machine as terminal to the host computer. as the host computer can run multi-users, each of which needs a terminal. </p>
<p>when times goes to personal computer(PC), there is no need for multi-users login, so each PC has integrated with I/O device(monitor and keybord)</p>
<p>nowadays, we have plenty of end-user terminals, e.g. smart phone, smart watch, Ipad e.t.c, all of these are <code>terminal</code>, as the real host computer is in cloud now. </p>
<p>in a word, any device that can accept input and display output is a <code>terminal</code>, which play the role as the human-machine interface.</p>
<h4 id="three-kinds-of-terminal"><a href="#three-kinds-of-terminal" class="headerlink" title="three kinds of terminal"></a>three kinds of terminal</h4><p>ssh is TCP/IP protocol, what’s inside is the remote terminal streaming flow.  the TCP/IP plays as the tunnel. of course, any communication protocol can play the role as the <code>tunnel</code>. </p>
<ul>
<li><p>local terminal, with usb to keyboard and monitor. </p>
</li>
<li><p>serial terminal, the guest machine connect to the host machine, who has keyboard and monitor. basically the guest machine borrow the host machine’s IO, which needs the host machine to run a terminal elmulator.</p>
</li>
<li><p>tcp/ip tunnel terminal, e.g. ssh</p>
</li>
</ul>
<p>both local terminal and serial terminal, directly connect to physical device, e.g. VGA interface, usb, serial e.t.c, so both are called  <strong>physical terminal</strong>.  ssh has nothing to do with physical device. </p>
<h4 id="tty"><a href="#tty" class="headerlink" title="tty"></a>tty</h4><p>in Linux,  <code>/dev/ttyX</code> represents a physical-terminal. from <code>tty1</code> to <code>tty63</code> are all local terminal. during Linux kernal init, 63 local terminals are generated, which can be switched by <code>Fn-Alt-Fx</code>, (x can be 1, 2, 3…). each current terminal is called <strong>focus terminal</strong>. </p>
<p>focus terminal is taken as global variable, so any input will transfer to current focus terminal. for serial, there is no focus terminal. </p>
<p>in Linux,  <code>/dev/console</code> represents current <strong>focus terminal</strong>, consider as a pointer to current focus terminal, wherever write sth to <code>/dev/console</code> will present at current focus terminal. </p>
<p><code>/dev/tty</code> is the global variable itself. whichever terminal you are working with, when write to <code>/dev/tty</code>, it will be present.</p>
<p><code>/dev/ttyS#num#</code> represents <strong>serial terminal</strong>. </p>
<h4 id="getty-amp-login"><a href="#getty-amp-login" class="headerlink" title="getty &amp; login"></a>getty &amp; login</h4><p>in multi-terminal time, each terminal must bind to one user, user must first login the terminal, <code>getty</code> is the login process, which is called in <code>init</code>. after login successfully, the terminal <code>tty#num#</code> can be owned by the user. </p>
<p>there are a few differenet version of <code>getty</code>, e.g. <code>agetty</code> e.t.c.</p>
<h4 id="pty-amp-pts"><a href="#pty-amp-pts" class="headerlink" title="pty &amp; pts"></a>pty &amp; pts</h4><p>pty stands for <code>pseudo-tty</code>, pty is a (master-slave) pair terminal device, including:  pts <code>pseudo-terminal slave</code>, and ptmx <code>pseudo-terminal master</code>. </p>
<p>a few concepts as following: </p>
<ul>
<li><p>serial terminal  <code>/dev/ttySn</code></p>
</li>
<li><p>pseudo-termianl  <code>/dev/pty/</code></p>
</li>
<li><p>controlling terminal <code>/dev/tty</code></p>
</li>
<li><p>console terminal  <code>/dev/console</code></p>
</li>
</ul>
<h2 id="Linux-Serial-Console"><a href="#Linux-Serial-Console" class="headerlink" title="Linux Serial Console"></a>Linux Serial Console</h2><h4 id="serial-communication"><a href="#serial-communication" class="headerlink" title="serial communication"></a>serial communication</h4><p>in old-style PC, serial is COM interface, also called <code>DB9 interface</code>, with RS-232 standard. </p>
<p>each user can connect to host machine through a <strong>terminal</strong>. <code>console</code> is same as <code>terminal</code> to connect user to host machine, but <code>console</code> is higher priority than <code>terminal</code>. nowadays less difference between terminal and console.  </p>
<p><code>Teletype</code> is the earliest terminal device, <code>tty</code> is physical or pseudo terminal connect to the host machine, nowadays <code>tty</code> also used for serial device.</p>
<p><code>serial</code> is the connection from terminal/keyboard to dev-board. </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ls /dev/tty*</div></pre></td></tr></table></figure>
<h4 id="configuration"><a href="#configuration" class="headerlink" title="configuration"></a>configuration</h4><p>Linux kernel must be configured to use the serial port as its console, which is done by passing the kernel the <code>console</code> parameter when the kernel is started by the boot loader.</p>
<p>the init system should keep a process runnign to monitor the serial console for logins, the monitoring process is traditionally named <strong>getty</strong></p>
<p>a number of system utilities need to be configured tomake them aware of the console, or configured to prevent them from disrupting the console.</p>
<h4 id="serial-port"><a href="#serial-port" class="headerlink" title="serial port"></a>serial port</h4><p>Linux names as the first serial port has the file name <code>/dev/ttys0</code>, the second serial port has the file name <code>/dev/ttyS1</code> and so on. most boot loaders have yet another naming scheme, the first serial port is numbered <code>0</code>, the second serial port is numbered <code>1</code></p>
<h4 id="configure-GRUB-boot-loader"><a href="#configure-GRUB-boot-loader" class="headerlink" title="configure GRUB boot loader"></a>configure GRUB boot loader</h4><p><a href="http://tldp.org/HOWTO/Remote-Serial-Console-HOWTO/configure-boot-loader-grub.html" target="_blank" rel="external">configure GRUB to use the serial console</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">info grub</div><div class="line">/boot/grub/grub.cfg</div><div class="line">serial --unit=0 --speed=9600 --word=8 --parity=no --stop=1 </div><div class="line">terminal serial</div></pre></td></tr></table></figure>
<h4 id="init-system"><a href="#init-system" class="headerlink" title="init system"></a>init system</h4><p>getty is started by <code>init</code>:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">co:2345:respawn:/sbin/getty ttyS0 CON9600 vt102</div></pre></td></tr></table></figure>
<ul>
<li><p><code>co</code> is an arbitrary entry, representing <code>console</code></p>
</li>
<li><p><code>2345</code>, run levels where this entry gets started. </p>
</li>
<li><p><code>respawn</code>, re-run the program if it dies</p>
</li>
<li><p><code>/sbin/getty ttyS0 CON9600 vt102</code>, getty connecting to /dev/ttyS0 with the settings for CON9600bps, and the terminal is VT100 model</p>
</li>
</ul>
<h2 id="virsh-console"><a href="#virsh-console" class="headerlink" title="virsh console"></a>virsh console</h2><p><a href="http://www.geekpills.com/operating-system/linux/kvm-virtualization-enable-kvm-virsh-console-access-ubuntu-linux-vm" target="_blank" rel="external">how to</a> connect ubuntu kvm virtual machine through serial console. in earlier version and distributions, it need to configure serial console in grub file, but in Ubuntu it’s very easy adn reliable as most of configurations and settings are already configured in OS.</p>
<h4 id="setup"><a href="#setup" class="headerlink" title="setup"></a>setup</h4><p>runs ubuntu14.04 guest mahcine on ubuntu 16.04 host machine. how to setup serial console, we have to connect guest machine and login on as root user</p>
<h4 id="login-through-SSH"><a href="#login-through-SSH" class="headerlink" title="login through SSH"></a>login through SSH</h4><ul>
<li>connect on KVM guest machine through ssh from host machine </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ssh 192.168.122.1</div><div class="line">hostname</div></pre></td></tr></table></figure>
<h4 id="connect-through-VNC"><a href="#connect-through-VNC" class="headerlink" title="connect through VNC"></a>connect through VNC</h4><p>conenct guest machine through VNC viewer and setup <code>serial console</code>. There are times when we need to troubleshoot Virtual Machines with unknown status like Hang in between, IP address issues, password problems, Serial console Hang etc. In case scenarios, we could relay on VNC configuration of KVM Guest Machines. </p>
<p>vnc viewer is a graphic viewer, so only need add <code>graphics</code> component in <a href="http://www.geekpills.com/wp-content/uploads/2017/08/ubuntu-17.04.txt" target="_blank" rel="external">config.xml</a>:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">graphics</span> <span class="attr">type</span>=<span class="string">'vnc'</span> <span class="attr">port</span>=<span class="string">'-1'</span> <span class="attr">autoport</span>=<span class="string">'yes'</span> <span class="attr">passwd</span>=<span class="string">'mypassword'</span>/&gt;</span></div></pre></td></tr></table></figure>
<p>run <code>virsh vncdisplay #vm_name#</code> we can get our vnc (server) IP, which then can be accessed by <code>vnc guest viewer</code>. here, <code>kvm virtual machine</code> has implemented a vnc server, and any <code>vnc viewer</code> in the same physical machine, can access this vnc server, even without external networking. </p>
<h4 id="configure-serial-console-in-ubuntu-guest"><a href="#configure-serial-console-in-ubuntu-guest" class="headerlink" title="configure serial console in ubuntu guest"></a>configure serial console in ubuntu guest</h4><p>after getting login console, we can start <code>serial console</code> and enable it with:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># systemctl start serial-getty@ttyS0</span></div><div class="line"><span class="comment"># systemctl enable serial-getty@ttyS0</span></div><div class="line">Created symlink /etc/systemd/system/getty.target.wants/serial-getty@ttyS0.service → /lib/systemd/system/serial-getty@.service.</div></pre></td></tr></table></figure>
<p>now we can connect <code>serial console</code> with <code>virsh console</code>:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">virsh console vm_name</div></pre></td></tr></table></figure>
<p>after installnation, reboot first, then the physical machine has dual-OS: <a href="https://www.server-world.info/en/note?os=Ubuntu_14.04&amp;p=kvm&amp;f=2" target="_blank" rel="external">GuestOS and HostOS</a>, which can exit GuestOS by <code>Ctrl + ]</code>, or login GuestOS by <code>virsh consoel #guest_vm#</code></p>
<p><strong>in summary</strong>, <code>virsh console</code> implement a serial console for kvm guest machine, which connect the guest machine to host machine through <code>serial</code>, which is not a <code>ssh</code>, need new knowledges about <code>serial</code>. </p>
<h2 id="virsh-console-hangs"><a href="#virsh-console-hangs" class="headerlink" title="virsh console hangs"></a>virsh console hangs</h2><p><code>virsh console vm</code> hangs at: <code>Escape character is ^]</code>, which can exit by <strong>ctrl + ]</strong> </p>
<h4 id="sol1"><a href="#sol1" class="headerlink" title="sol1:"></a><a href="https://stackoverflow.com/questions/11845280/virsh-console-hangs-at-the-escape-character" target="_blank" rel="external">sol1</a>:</h4><p>go to guest machine/terminal, and edit <code>/etc/default/grub</code>, appending;</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">GRUB_TERMINAL=serial</div><div class="line">GRUB_SERIAL_COMMAND=<span class="string">"serial --unit=0 --speed=115200 --word=8 --parity=no --stop=1"</span></div></pre></td></tr></table></figure>
<p>then execute:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">update-grub</div><div class="line">reboot</div></pre></td></tr></table></figure>
<p>the problem here, as the KVM vm shares the kernel of the host machine, if update <code>grub</code>, the host machine will reboot with serial connection(?)</p>
<h4 id="Centos-virsh-console-hangs"><a href="#Centos-virsh-console-hangs" class="headerlink" title="Centos virsh console hangs"></a><a href="https://www.cnblogs.com/xieshengsen/p/6215168.html" target="_blank" rel="external">Centos virsh console hangs</a></h4><ul>
<li><p>go to <code>/etc/securetty</code> and append <code>ttyS0</code></p>
</li>
<li><p>append <code>S0:12345:respawn:/sbin/agetty ttyS0 115200</code> to <code>/etc/init/ttyS0.conf</code></p>
</li>
<li><p>/etc/grub.conf(Centos) </p>
</li>
</ul>
<p>I only found <code>/boot/grub/grub.cfg</code> in ubuntu. In the <code>kernel</code> line, appending <code>console=ttyS0</code>. but there is no <code>kernel</code> line in <code>ubuntu grub.cfg</code>.</p>
<h4 id="Ubuntu-virsh-console-hangs"><a href="#Ubuntu-virsh-console-hangs" class="headerlink" title="Ubuntu virsh console hangs"></a><a href="https://www.cnblogs.com/sixloop/p/8044785.html" target="_blank" rel="external">Ubuntu virsh console hangs</a></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">systemctl <span class="built_in">disable</span> systemd-networkd-wait-online</div><div class="line">systemctl <span class="built_in">enable</span> serial-getty@ttyS0.service</div><div class="line">systemctl start serial-getty@ttyS0.service</div></pre></td></tr></table></figure>
<p>which gives: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Mar 27 11:17:18 ubuntu systemd[1]: Started Serial Getty on ttyS0.</div><div class="line">Mar 27 11:17:18 ubuntu agetty[445120]: /dev/ttyS0: not a tty</div></pre></td></tr></table></figure>
<p>check in <code>/dev/ttyS*</code> : </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">crw-rw---- 1 root dialout 4, 73 Mar 24 09:20 ttyS9</div><div class="line">crw--w---- 1 root tty     4, 64 Mar 24 09:20 ttyS0</div><div class="line">crw-rw---- 1 root dialout 4, 65 Mar 24 09:20 ttyS1</div></pre></td></tr></table></figure>
<p>interesting here,  <code>ttyS0</code> belongs to <code>tty</code> group, all otehr <code>ttyS#num#</code> belongs to <code>dialout</code> group. </p>
<h5 id="tty-and-dialout"><a href="#tty-and-dialout" class="headerlink" title="tty and dialout"></a>tty and dialout</h5><p><a href="https://stackoverflow.com/questions/30846176/how-to-change-tty-group-on-linux-build-with-buildroot" target="_blank" rel="external">change /dev/ttyS0 to tty group</a></p>
<p><a href="https://askubuntu.com/questions/210177/serial-port-terminal-cannot-open-dev-ttys0-permission-denied" target="_blank" rel="external">can’t access /dev/ttyS</a></p>
<p>add USER to tty/dialout group</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo usermod -a -G tty <span class="variable">$USER</span></div><div class="line">sudo usermod -a -G dialout <span class="variable">$USER</span></div></pre></td></tr></table></figure>
<p>reboot and go on</p>
<h2 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h2><p><a href="http://tldp.org/HOWTO/Remote-Serial-Console-HOWTO/" target="_blank" rel="external">remote serial console HOWTO</a></p>
<p><a href="https://www.cnblogs.com/huan-huan/p/8522472.html" target="_blank" rel="external">remote serial console HOWTO in Chinese</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1527544" target="_blank" rel="external">understand Linux terminal history in Chinese</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1533217" target="_blank" rel="external">Linux terminal introduction in Chinese</a></p>
<p><a href="https://tutorial.linux.doc.embedfire.com/zh_CN/latest/linux_app/uart_tty.html" target="_blank" rel="external">serial communication in Chinese</a></p>
<p><a href="https://wiki.archlinux.org/index.php/Working_with_the_serial_console" target="_blank" rel="external">arhLinux: working with the serial console</a></p>
<p><a href="https://www.gnu.org/software/grub/manual/grub/grub.html" target="_blank" rel="external">gnu org: grub</a></p>
<p><a href="http://www.geekpills.com/operating-system/linux/kvm-virtualization-start-vnc-remote-access-guest-operating-systems" target="_blank" rel="external">geekpills: start vnc remote access for guest operating systems</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/24/kvm-libvert-in-linux-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/24/kvm-libvert-in-linux-1/" itemprop="url">kvm/libvert in linux (1)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-24T07:10:18-04:00">
                2020-03-24
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/24/kvm-libvert-in-linux-1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/03/24/kvm-libvert-in-linux-1/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="kvm-background"><a href="#kvm-background" class="headerlink" title="kvm background"></a>kvm background</h2><p>kernel based virtual machine(KVM), is a Linux kernel module, which transfer Linux to a Hypervisor, which depends on the ability of hardware virtualization. usually the physical machine is called <code>Host</code>, and the virtual machine(VM) run in host is called <code>Guest</code>. </p>
<p>kvm itself doesn’t do any hardware emulator, which needs guest space to set an address space through <code>dev/kvm</code> interface, to which provides virtual I/O, e.g. QEMU.</p>
<p><a href="https://github.com/virt-manager/virt-manager" target="_blank" rel="external">virt-manager</a> is a GUI tool for managing virtual machines via <strong>libvirt</strong>, mostly used by QEMU/KVM virtual machines. </p>
<ul>
<li>check kvm model info </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">modinfo kvm</div></pre></td></tr></table></figure>
<ul>
<li>whether CPU support hardware virtualization</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">egrep -c <span class="string">'(vmx|svm)'</span> /proc/cpuinfo</div><div class="line">kvm-ok</div></pre></td></tr></table></figure>
<h2 id="install-kvm"><a href="#install-kvm" class="headerlink" title="install kvm"></a>install kvm</h2><ul>
<li>install libvirt and qemu packages </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sudo apt install qemu qemu-kvm libvirt-bin bridge-utils</div><div class="line">modprobe kvm <span class="comment">#load kvm module</span></div><div class="line">systemctl start libvirtd.service <span class="comment">#</span></div><div class="line">vrish iface-bridge ens33 virbr0 <span class="comment">#create a bridge network mac address</span></div></pre></td></tr></table></figure>
<ul>
<li><a href="https://www.howtogeek.com/50787/add-a-user-to-a-group-or-second-group-on-linux/" target="_blank" rel="external">add current user</a> to libvirtd group </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo usermod -aG libvirtd $(whoami)</div><div class="line">sudo usermod -aG libvirt-qemu $(whoami)</div><div class="line">sudo reboot</div></pre></td></tr></table></figure>
<h4 id="network-in-kvm"><a href="#network-in-kvm" class="headerlink" title="network in kvm"></a>network in kvm</h4><p><a href="https://www.linux.com/topic/networking/creating-virtual-machines-kvm-part-2-networking/" target="_blank" rel="external">default network</a> is NAT(network address transation), when you create a new virtual machine, this forwards network traffic through your host system; if the host is connected to the Internet, then your vm have Internet access.</p>
<p>VM manager also creates an Ethernet bridge between the host and virtual network, so can ping IP address of VM from host, also ok on the other way.</p>
<ul>
<li>List of network cards</li>
</ul>
<p>go to <code>/sys/class/net</code> there are a few nic:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">lrwxrwxrwx 1 root root 0 Mar 24 16:18 docker0 -&gt; ../../devices/virtual/net/docker0</div><div class="line">lrwxrwxrwx 1 root root 0 Mar 24 16:18 docker_gwbridge -&gt; ../../devices/virtual/net/docker_gwbridge</div><div class="line">lrwxrwxrwx 1 root root 0 Mar 24 16:18 eno1 -&gt; ../../devices/pci0000:00/0000:00:1f.6/net/eno1</div><div class="line">lrwxrwxrwx 1 root root 0 Mar 24 16:18 enp4s0f2 -&gt; ../../devices/pci0000:00/0000:00:1c.4/0000:02:00.0/0000:03:03.0/0000:04:00.2/net/enp4s0f2</div><div class="line">lrwxrwxrwx 1 root root 0 Mar 24 16:18 lo -&gt; ../../devices/virtual/net/lo</div><div class="line">lrwxrwxrwx 1 root root 0 Mar 24 16:18 veth1757da9 -&gt; ../../devices/virtual/net/veth1757da9</div><div class="line">lrwxrwxrwx 1 root root 0 Mar 24 16:18 vethd4d0e7f -&gt; ../../devices/virtual/net/vethd4d0e7f</div><div class="line">lrwxrwxrwx 1 root root 0 Mar 24 16:18 virbr0 -&gt; ../../devices/virtual/net/virbr0</div><div class="line">lrwxrwxrwx 1 root root 0 Mar 24 16:18 virbr0-nic -&gt; ../../devices/virtual/net/virbr0-nic</div></pre></td></tr></table></figure>
<ul>
<li>multi interfaces on same MAC addresss</li>
</ul>
<p>when <a href="https://networkengineering.stackexchange.com/questions/34754/same-mac-on-different-interfaces" target="_blank" rel="external">a switch receives</a> a frame from an interface, it creates an entry in the mac-address table with the source mac and interface. it the source mac is known, it will update the table with the new interface. so bascially if you assign the mac address of an external-network-avialable NIC-A to the special vm, NIC-A is lost. </p>
<ul>
<li>virbr0 </li>
</ul>
<p>the <code>default</code> bridge NIC of libvirt is <code>virbr0</code>. bridge network means the guest and host share the same physical Network Cards, as well as offer the guest a special IP, which can be used to access the guest directly. the <code>virbr0</code> do <code>network address translation</code>(NAT), basically transfer the internal IP address to an external IP address, which means the internal IP address is un-visiable from outside. </p>
<p>to add the <code>virbr0</code>, when it is deleted previously: </p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">brctl addbr virbr0</div><div class="line">brctl stp virbr0 on</div><div class="line">brctl setf virbr0 0</div><div class="line">ifconfig virbr0 192.168.122.1 netmask 255.255.255.0 up</div></pre></td></tr></table></figure>
<p> to disable or delete <code>virbr0</code>:</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">virsh net-destroy default</div><div class="line">virsh net-undefine default</div><div class="line">service libvirtd restart</div><div class="line">ifconfig</div></pre></td></tr></table></figure>
<p> after starting the vm, can check the bridge network by:</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">virsh domiflist vm-name</div><div class="line">virsh domifaddr vm-name</div></pre></td></tr></table></figure>
<p> and we can login the vm, (after we assign current user to <code>libvert</code> group), and check NAT is working: </p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ssh 192.168.122.1 </div><div class="line">ping www.bing.com</div><div class="line">ping 10.20.xxx.xxx  <span class="comment"># ping the host external IP</span></div></pre></td></tr></table></figure>
<p>basically the vm can access external website, but external web can’t access vm_name.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">attach-interface/detach-interface/domiflist</div></pre></td></tr></table></figure>
<h2 id="create-vm"><a href="#create-vm" class="headerlink" title="create vm"></a>create vm</h2><p>create a virtual machine,  can be done either through <code>virt-install</code> or <code>config.xml</code>:</p>
<h3 id="virt-install"><a href="#virt-install" class="headerlink" title="virt-install"></a>virt-install</h3><p><code>virt-install</code> has depends on system python, pip. if current ptyhon version is 2.7, it gives warnning and return -1 due to unfound module. so make sure the #PYTHONPATH# point to the correct path if you have multi python in system. and <code>virt-install</code> has to run with <code>root</code>. </p>
<p>then can start a virtual machine with <a href="https://unix.stackexchange.com/questions/502560/virsh-connected-to-domain-name-escape-character-is" target="_blank" rel="external">following command options</a>)</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">sudo virt-install \</div><div class="line">--name v1 \</div><div class="line">--ram 2048 \</div><div class="line"><span class="comment"># --cdrom=ubuntu-16.04.3-server-amd64.iso \</span></div><div class="line">--disk path=/var/lib/libvirt/images/ubuntu.qcow2 \</div><div class="line">--vcpus 2 \</div><div class="line">--virt-type kvm \</div><div class="line">--os-type linux \</div><div class="line">--os-variant ubuntu16.04 \</div><div class="line">--graphics none \</div><div class="line">--console pty, target_type=serial \</div><div class="line">--location /var/lib/libvirt/images/ubuntu-16.04.3-server-amd64.iso \</div><div class="line">--network bridge:virbr0 \ </div><div class="line">--extra-args console=ttyS0</div></pre></td></tr></table></figure>
<p>during the installation, the process looks very much like Linux installation on a bare machine. I suppose this way, it’s like install a dual-OS in the bare machine. during the installation, there is an error <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=833706" target="_blank" rel="external">failed to load installer component libc6-udeb</a>, it’s may due to the iso or img has missing component.</p>
<h3 id="config-xml"><a href="#config-xml" class="headerlink" title="config.xml"></a>config.xml</h3><ul>
<li><p>create volumes </p>
<p>go to /var/lib/libvirt/images, and create volume as following: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">qemu-img create -f qcow2 ubuntu.qcow2 40G</div></pre></td></tr></table></figure>
</li>
</ul>
<p>check <a href="https://www.jianshu.com/p/4a50c02aa16e" target="_blank" rel="external">qemu-kvm &amp; qemu-img introduction</a></p>
<ul>
<li><p>add vm image </p>
<p>cp ubuntu.iso to <code>/var/lib/libvirt/images</code> as well:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ubuntu.qcow2</div><div class="line">ubuntu-16.04.3-server-amd64.iso</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="vm-xml"><a href="#vm-xml" class="headerlink" title="vm.xml"></a>vm.xml</h4><p>follow an <a href="https://docs.fedoraproject.org/en-US/Fedora/18/html/" target="_blank" rel="external">xml sample</a>: </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">domain</span> <span class="attr">type</span>=<span class="string">'kvm'</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>v1<span class="tag">&lt;/<span class="name">name</span>&gt;</span> </div><div class="line">        <span class="tag">&lt;<span class="name">memory</span>&gt;</span>4048576<span class="tag">&lt;/<span class="name">memory</span>&gt;</span> </div><div class="line">        <span class="tag">&lt;<span class="name">currentMemory</span>&gt;</span>4048576<span class="tag">&lt;/<span class="name">currentMemory</span>&gt;</span> </div><div class="line">        <span class="tag">&lt;<span class="name">vcpu</span>&gt;</span>2<span class="tag">&lt;/<span class="name">vcpu</span>&gt;</span> </div><div class="line">        <span class="tag">&lt;<span class="name">os</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">type</span> <span class="attr">arch</span>=<span class="string">'x86_64'</span> <span class="attr">machine</span>=<span class="string">'pc'</span>&gt;</span>hvm<span class="tag">&lt;/<span class="name">type</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">boot</span> <span class="attr">dev</span>=<span class="string">'cdrom'</span>/&gt;</span> </div><div class="line">       <span class="tag">&lt;/<span class="name">os</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">features</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">acpi</span>/&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">apic</span>/&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">pae</span>/&gt;</span></div><div class="line">       <span class="tag">&lt;/<span class="name">features</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">clock</span> <span class="attr">offset</span>=<span class="string">'localtime'</span>/&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">on_poweroff</span>&gt;</span>destroy<span class="tag">&lt;/<span class="name">on_poweroff</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">on_reboot</span>&gt;</span>restart<span class="tag">&lt;/<span class="name">on_reboot</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">on_crash</span>&gt;</span>destroy<span class="tag">&lt;/<span class="name">on_crash</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">serial</span> <span class="attr">type</span>=<span class="string">'pty'</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">target</span> <span class="attr">port</span>=<span class="string">'0'</span> /&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">serial</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">console</span> <span class="attr">type</span>=<span class="string">'pty'</span> &gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">'serial'</span> <span class="attr">port</span>=<span class="string">'0'</span> /&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">console</span>&gt;</span> </div><div class="line">      <span class="tag">&lt;<span class="name">devices</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">emulator</span>&gt;</span>/usr/bin/qemu-system-x86_64<span class="tag">&lt;/<span class="name">emulator</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">'file'</span> <span class="attr">device</span>=<span class="string">'disk'</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">'qemu'</span> <span class="attr">type</span>=<span class="string">'qcow2'</span>/&gt;</span></div><div class="line">           <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">'/var/lib/libvirt/images/ubuntu.qcow2'</span>/&gt;</span> </div><div class="line">           <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">'hda'</span> <span class="attr">bus</span>=<span class="string">'ide'</span>/&gt;</span></div><div class="line">         <span class="tag">&lt;/<span class="name">disk</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">'file'</span> <span class="attr">device</span>=<span class="string">'cdrom'</span>&gt;</span></div><div class="line">           <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">'/var/lib/libvirt/images/ubuntu-16.04.3-server-amd64.iso'</span>/&gt;</span> </div><div class="line">           <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">'hdb'</span> <span class="attr">bus</span>=<span class="string">'ide'</span>/&gt;</span></div><div class="line">         <span class="tag">&lt;/<span class="name">disk</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">'bridge'</span> &gt;</span></div><div class="line">           <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">'52:54:00:98:45:3b'</span> /&gt;</span></div><div class="line">           <span class="tag">&lt;<span class="name">source</span> <span class="attr">bridge</span>=<span class="string">'virbr0'</span> /&gt;</span></div><div class="line">	   <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">'virtio'</span> /&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">interface</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">serial</span> <span class="attr">type</span>=<span class="string">'pty'</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">target</span> <span class="attr">port</span>=<span class="string">'0'</span> /&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">serial</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">console</span> <span class="attr">type</span>=<span class="string">'pty'</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">'serial'</span> <span class="attr">port</span>=<span class="string">'0'</span> /&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">console</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">'mouse'</span> <span class="attr">bus</span>=<span class="string">'ps2'</span>/&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">graphics</span> <span class="attr">type</span>=<span class="string">'vnc'</span> <span class="attr">port</span>=<span class="string">'-1'</span> <span class="attr">autoport</span>=<span class="string">'no'</span> <span class="attr">listen</span> = <span class="string">'0.0.0.0'</span> <span class="attr">keymap</span>=<span class="string">'en-us'</span>&gt;</span></div><div class="line">	   <span class="tag">&lt;<span class="name">listen</span> <span class="attr">type</span>=<span class="string">'address'</span> <span class="attr">address</span>=<span class="string">'0.0.0.0'</span> /&gt;</span></div><div class="line">	 <span class="tag">&lt;/<span class="name">graphics</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">devices</span>&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">domain</span>&gt;</span></div></pre></td></tr></table></figure>
<p>a few tips about the xml above:</p>
<ul>
<li><p>\<interface\> component is necessary for network interface. </interface\></p>
</li>
<li><p>if not assign a special <code>mac address</code> in the interface. since we had define <code>virbr0</code>, an automatic mac address will be assigned, which is unique from the host machine’s IP, but if ssh login to the guest (ssh username@guest_ip), it actually can ping host machine’s iP or any external ip(www.being.com)</p>
</li>
<li><p>\<serial tty\=""> compoennt, is setting for <code>console</code>.</serial></p>
</li>
</ul>
<p>finally run the following CLI to start vm: v1:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">virsh define vm1.xml </div><div class="line">virsh start ubuntu(the image)</div><div class="line">virsh list</div></pre></td></tr></table></figure>
<h2 id="libvert"><a href="#libvert" class="headerlink" title="libvert"></a>libvert</h2><p>libvert is a software package to manage vm, including libvirtAPI, libvirtd(daemon process), and virsh tool. </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo systemctl restart libvirtd</div><div class="line">systemctl status libvirtd</div></pre></td></tr></table></figure>
<p>only when <code>libvirtd</code> service is running, can we manage vm through <code>libvert</code>. all configure of the vm is stored ad <code>/etc/libvirt/qemu</code>. for <code>virsh</code> there are two mode:</p>
<ul>
<li>immediate way e.g. in host shell <code>virsh list</code> </li>
<li>interactive shell e.g. by <code>virsh</code> to virsh shell</li>
</ul>
<h4 id="common-virsh-commands"><a href="#common-virsh-commands" class="headerlink" title="common virsh commands"></a>common virsh commands</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">virsh &lt;command&gt; &lt;domain-id&gt; [options]</div><div class="line">virsh uri #hypervisor&apos;s URI</div><div class="line">virsh hostname</div><div class="line">virsh nodeinfo </div><div class="line">virsh list (running, idel, paused, shutdown, shutoff, crashed, dying)</div><div class="line">virsh shutdown &lt;domain&gt;</div><div class="line">virsh start &lt;domain&gt;</div><div class="line">virsh destroy &lt;domain&gt;</div><div class="line">virsh undefine &lt;domain&gt;</div><div class="line">virsh create #through config.xml</div><div class="line">virsh connect  #reconnect to hypervisor </div><div class="line">virsh nodeinfo </div><div class="line">virsh define #file domain</div><div class="line">virsh  setmem domain-id kbs #immediately</div><div class="line">virsh sertmaxmem domain-id kbs</div><div class="line">virsh setvcpus domain-id count </div><div class="line">virsh vncdisplay domain-id #listed vnc port</div><div class="line">virsh console &lt;domain&gt;</div></pre></td></tr></table></figure>
<h4 id="virsh-network-commands"><a href="#virsh-network-commands" class="headerlink" title="virsh network commands"></a>virsh network commands</h4><ul>
<li>host configure </li>
</ul>
<p>Every standard libvirt installation provides NAT based connectivity to virtual machines out of the box. This is the so called ‘default virtual network’ </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">virsh net-list </div><div class="line">virsh net-define /usr/share/libvirt/networks/default.xml</div><div class="line">virsh net-start default</div><div class="line">virsh net-info default</div><div class="line">virsh net-dumpxml default</div></pre></td></tr></table></figure>
<p>When the <a href="https://wiki.libvirt.org/page/Networking" target="_blank" rel="external">libvirt default network</a>is running, you will see an isolated bridge device. This device explicitly does <em>NOT</em> have any physical interfaces added, since it uses NAT + forwarding to connect to outside world. <strong>Do not add interfaces</strong>. Libvirt will add iptables rules to allow traffic to/from guests attached to the virbr0 device in the INPUT, FORWARD, OUTPUT and POSTROUTING chains.</p>
<p>if <code>default.xml</code> is not found, check <a href="https://blog.programster.org/kvm-missing-default-network" target="_blank" rel="external">fix missing default network</a>, <code>default.xml</code> is sth like:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">network</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>default<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>9a05da11-e96b-47f3-8253-a3a482e445f5<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">forward</span> <span class="attr">mode</span>=<span class="string">'nat'</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">bridge</span> <span class="attr">name</span>=<span class="string">'virbr0'</span> <span class="attr">stp</span>=<span class="string">'on'</span> <span class="attr">delay</span>=<span class="string">'0'</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">'52:54:00:0a:cd:21'</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">ip</span> <span class="attr">address</span>=<span class="string">'192.168.122.1'</span> <span class="attr">netmask</span>=<span class="string">'255.255.255.0'</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dhcp</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">range</span> <span class="attr">start</span>=<span class="string">'192.168.122.2'</span> <span class="attr">end</span>=<span class="string">'192.168.122.254'</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dhcp</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">ip</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">network</span>&gt;</span></div></pre></td></tr></table></figure>
<p>then run:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo virsh net-define --file default.xml</div><div class="line">sudo virsh net-start default</div><div class="line">sudo virsh net-autostart --network default</div></pre></td></tr></table></figure>
<p>if bind <code>default</code> to <code>virbr0</code> already, need delete this brige first.</p>
<ul>
<li>guest configure </li>
</ul>
<p>add the following to guest xml configure:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">'network'</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">source</span> <span class="attr">network</span>=<span class="string">'default'</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">'00:16:3e:1a:b3:4a'</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">interface</span>&gt;</span></div></pre></td></tr></table></figure>
<p>more details can check <a href="https://wiki.libvirt.org/page/Networking" target="_blank" rel="external">virsh networking doc</a></p>
<h4 id="snapshots"><a href="#snapshots" class="headerlink" title="snapshots"></a>snapshots</h4><p>snapshots used to save the state(disk mem, time..) of a domain</p>
<ul>
<li>create a snapshot for a vm </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">virsh snapshot-create-as --domain test_vm  \</div><div class="line">--name <span class="string">"test_vm_snapshot1"</span> \ </div><div class="line">--description <span class="string">"test vm snapshot "</span></div></pre></td></tr></table></figure>
<ul>
<li>list all snapshots for vm</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">virsh snapshot-list test_vm</div></pre></td></tr></table></figure>
<ul>
<li>display info about a snapshot </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">virsh snapshot-info --domain test_vm --snapshotname test_vm_snapshot1</div><div class="line">``` </div><div class="line"></div><div class="line">* delete a snapshot </div><div class="line"></div><div class="line">```sh</div><div class="line">virsh snapshot-delete --domain test_vm --snapshotname test_vm_shapshot1</div></pre></td></tr></table></figure>
<h4 id="manage-volumes"><a href="#manage-volumes" class="headerlink" title="manage volumes"></a>manage volumes</h4><ul>
<li>create a storage volume</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">virsh vol-create-as default test_vol.qcow2 10G</div><div class="line"><span class="comment"># create test_vol on the deafult storage pool</span></div><div class="line">du -sh /var/lib/libvirt/images/test_vol.qcow2</div></pre></td></tr></table></figure>
<ul>
<li>attach  to a vm</li>
</ul>
<p>attache <code>test-vol</code> to vm <code>test</code> </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">virsh attach-disk --domain <span class="built_in">test</span> \</div><div class="line">--<span class="built_in">source</span> /var/lib/libvirt/images/<span class="built_in">test</span>-vol.qcow2 \</div><div class="line">--persistent --target vdb</div></pre></td></tr></table></figure>
<p>which can be check that the vm has added a block device <code>/dev/vdb</code> </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ssh <span class="built_in">test</span>  <span class="comment">#how to ssh to vm </span></div><div class="line">lsblk --output NAME,SIZE,TYPE</div></pre></td></tr></table></figure>
<p>or directly grow disk image:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">qemu-img resize /var/lib/libvirt/images/test.qcow2 +1G</div></pre></td></tr></table></figure>
<ul>
<li>detach from a vm</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">virsh detach-disk --domain <span class="built_in">test</span> --persistent --live --target vdb</div></pre></td></tr></table></figure>
<ul>
<li>delete a vm </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">virsh vol-delete test_vol.qcow2 --pool default</div><div class="line">virsh pool-refresh default</div><div class="line">virsh vol-list default</div></pre></td></tr></table></figure>
<h4 id="fs-virsh-commands"><a href="#fs-virsh-commands" class="headerlink" title="fs virsh commands"></a>fs virsh commands</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">virt-ls -l -d &lt;domain&gt; &lt;directory&gt;</div><div class="line">virt-cat -d &lt;domain&gt; &lt;file_path&gt;</div></pre></td></tr></table></figure>
<h2 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h2><p><a href="http://www.178linux.com/103971" target="_blank" rel="external">kvm introduction in chinese</a></p>
<p><a href="https://help.ubuntu.com/community/KVM/Installation" target="_blank" rel="external">kvm pre-install checklist</a></p>
<p><a href="http://www.yolinux.com/TUTORIALS/LinuxTutorialNetworking.html" target="_blank" rel="external">Linux network configuration</a></p>
<p><a href="https://help.ubuntu.com/community/KVM/Installation" target="_blank" rel="external">kvm installation official doc</a></p>
<p><a href="https://graspingtech.com/creating-virtual-machine-virt-install/" target="_blank" rel="external">creating vm with virt-install</a></p>
<p><a href="https://linuxhint.com/install_kvm_ubuntu/" target="_blank" rel="external">install KVM in ubuntu</a></p>
<p><a href="https://www.jianshu.com/p/110b60c14a8b" target="_blank" rel="external">jianshu: kvm network configure</a></p>
<p><a href="https://www.cnblogs.com/CloudMan6/p/5308071.html" target="_blank" rel="external">cloudman: understand virbr0</a></p>
<p><a href="https://libvirt.org/sources/virshcmdref/html-single/" target="_blank" rel="external">virsh command refer</a></p>
<p><a href="https://www.ibm.com/developerworks/cn/linux/1409_qiaoly_qemuimgages/index.html" target="_blank" rel="external">qcow2  vs  raw</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/20/real-time-matlab-simulink-code-generation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/20/real-time-matlab-simulink-code-generation/" itemprop="url">real-time matlab/simulink code generation</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-20T06:44:35-04:00">
                2020-03-20
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/20/real-time-matlab-simulink-code-generation/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/03/20/real-time-matlab-simulink-code-generation/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="real-time-matlab-code-generation"><a href="#real-time-matlab-code-generation" class="headerlink" title="real-time matlab code generation"></a>real-time matlab code generation</h1><h2 id="backgroud"><a href="#backgroud" class="headerlink" title="backgroud"></a>backgroud</h2><p>Python and Linux vs Matlab and Windows, I prefer the front. but as a teamwork, I have to understand how matlab/Simulink code generation works, especially with real-time model. </p>
<h2 id="Simulink-Coder"><a href="#Simulink-Coder" class="headerlink" title="Simulink Coder"></a>Simulink Coder</h2><p>previously named as Real-Time workshop(rtw).</p>
<h4 id="real-time-model-data-structure"><a href="#real-time-model-data-structure" class="headerlink" title="real time model data structure"></a>real time model data structure</h4><p>access rtModel data by using a set of macros analogous to the ssSetxxx and ssGetxxx macros that S-functions use to access SimStruct data, including noninlined S-functions compiled by the code generator.</p>
<p>You need to use the set of macros rtmGetxxx and rtmSetxxx to access the real-time model data structure. The rtModel is an optimized data structure that replaces SimStruct as the top level data structure for a model. The rtmGetxxx and rtmSetxxx macros are used in the generated code as well as from the main.c or main.cpp module.</p>
<p>Usage of rtmGetxxx and rtmSetxxx macros is the same as for the ssSetxxx and ssGetxxx versions, except that you replace SimStruct S by real-time model data structure rtM. </p>
<table>
<thead>
<tr>
<th>rtm macro</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td> rtmGetdX(rtm)</td>
<td>get the derivatives of block continous states</td>
<td></td>
</tr>
<tr>
<td> rtmGetNumSampleTimes(RT_MDL rtM)</td>
<td>Get the number of sample times that a block has</td>
<td></td>
</tr>
<tr>
<td>rtmGetSampleTime(RT_MDL rtM, int TID)</td>
<td>Get task sample time</td>
</tr>
<tr>
<td>rtmGetStepSize(RT_MDL)</td>
<td>Return the fundamental step size of the model</td>
</tr>
<tr>
<td>rtmGetT(RT_MDL,t)</td>
<td>Get the current simulation time </td>
</tr>
<tr>
<td>rtmGetErrorStatus(rtm)</td>
<td>Get the current error status</td>
</tr>
</tbody>
</table>
<h4 id="code-generation-to-used-externally"><a href="#code-generation-to-used-externally" class="headerlink" title="code generation to used externally :"></a>code generation to used externally :</h4><p>1) Install the Real-Time Workshop (RTW) Toolbox for MATLAB;</p>
<p>2) Create the Simulink Model and Prepare it for autocoding;</p>
<p>3) Correctly configure the RTW options and include a *.tcl file;</p>
<p>4) Build any S-Functions of the model;</p>
<p>5) Build the model (generate autocode including makefile);</p>
<p>6) Tune up the makefile with any missing options/libraries/files;</p>
<p>7) Integrate autocoded model in RTEMS using the wrapper.</p>
<h4 id="ert-main"><a href="#ert-main" class="headerlink" title="ert_main()"></a>ert_main()</h4><p>the following is a common sample of real-time model generated C code. </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">rt_OneStep(<span class="keyword">void</span>)&#123;</div><div class="line">	simulation_custom_step() ;</div><div class="line">&#125;</div><div class="line"></div><div class="line">main()&#123;</div><div class="line">	simulation_initialize();</div><div class="line">	<span class="keyword">while</span>(rtmGetErrorStatus(xx_M) == (<span class="literal">NULL</span>))&#123;</div><div class="line">		 rt_OneStep();</div><div class="line">    &#125;</div><div class="line">    simulation_terminate();</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div></pre></td></tr></table></figure>
<p>if no time interupt setting up, there is a <a href="https://www.mathworks.com/matlabcentral/answers/92639-how-do-i-customize-the-main-function-generated-by-real-time-workshop-embedded-coder-5-2-r2008b" target="_blank" rel="external">Warning: The simulation will run forever. Generated ERT main won’t simulate model step behavior. To change this behavior select the ‘MAT-file logging’ option.</a></p>
<p>from real-time Matlab/Simulink model to C/C++ code, we need manually set the while-loop break statement. for example, we can  run 100 times or based on some event-trigger.</p>
<h4 id="Timing"><a href="#Timing" class="headerlink" title="Timing"></a>Timing</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">  <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">    uint16_T clockTick1;  <span class="comment">//base rate counter (5s)</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">      uint16_T TID[<span class="number">2</span>];</div><div class="line">    &#125; TaskCounters;  <span class="comment">//subtask counter (0.02s)</span></div><div class="line">  &#125; Timing;</div><div class="line">  </div><div class="line">currentTime =  Timing.clockTick1 * <span class="number">5.0</span> ;</div></pre></td></tr></table></figure>
<p>absolute timer for sample time: [5.0s, 0.0s]. the resolution of this integer timer is 5.0, which is the step size of the task. so bascially, assuming to run one step need physcially 5s, but inside the module, each internal step is 0.02s. </p>
<p>if we run a test scenario with 20s, basically we have 4 clockTick1 and inside each clockTick1, we have 250 times internal steps.</p>
<h2 id="a-few-modification"><a href="#a-few-modification" class="headerlink" title="a few modification"></a>a few modification</h2><p>the following is a few modification based on the auto-generated C code:</p>
<ul>
<li>redefine data structure</li>
</ul>
<p>matlab coder use most <code>C structure</code> to package signals. in our adas model, most signals have similar inner items, so first I’d like to define a <code>parent structre</code>, then define all other adas signals using <code>typedef</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> structure parent  adas_sig1 ;</div><div class="line"><span class="keyword">typedef</span> structure parent  adas_sig2 ;</div><div class="line"><span class="keyword">typedef</span> structure parent  adas_sig3 ;</div><div class="line"><span class="keyword">typedef</span> structure parent  adas_sig4 ;</div></pre></td></tr></table></figure>
<p>with the <code>parent struct</code>, we can define one method to handle all adas signals. </p>
<ul>
<li>add trigger model in rt_oneStep()</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">checkTriggerSigs(&amp;FunctionSignal, outputs_name);</div><div class="line">	<span class="keyword">int</span> idx = <span class="number">0</span>;</div><div class="line">	<span class="keyword">for</span>(; idx&lt;outputs_name.size(); idx++)&#123;</div><div class="line">			<span class="keyword">if</span> ( outputs_name[idx] == <span class="string">"adas_sig1"</span>) &#123;</div><div class="line">				<span class="keyword">double</span> *vals = gd1_struc_2arr(adas_ig1) ; </div><div class="line">				outputs_data.push_back(als);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span> <span class="keyword">if</span>( outputs_name[idx] ==  <span class="string">"adas_sig2"</span>) &#123;</div><div class="line">				<span class="keyword">double</span> *vals = gd1_struc_2arr(adas_sig2) ;</div><div class="line">				outputs_data.push_back(vals);</div><div class="line">			&#125;</div><div class="line"></div><div class="line"><span class="comment">// ws msg send model</span></div></pre></td></tr></table></figure>
<ul>
<li>add sim_time to break the loop</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">real_T sim_time = <span class="number">5.0</span> ; </div><div class="line">fflush((<span class="literal">NULL</span>));</div><div class="line"><span class="keyword">while</span> (rtmGetErrorStatus(OpenLoopSimulation_M) == (<span class="literal">NULL</span>) &amp;&amp;  (Timing.clockTick1) * <span class="number">5.0</span> &lt;=  sim_time) &#123;</div><div class="line">      rt_OneStep();</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h2 id="in-summary"><a href="#in-summary" class="headerlink" title="in summary"></a>in summary</h2><p>the work above is the core modifcation to make real-time matlab/simulink model with trigger model translated to C/C++ code, which can be integrated in <a href="https://zjli2013.github.io/2020/03/18/massively-adas-test-pipeline/" target="_blank" rel="external">massively adas test pipeline</a>.  </p>
<h2 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h2><p><a href="https://devel.rtems.org/wiki/Packages/Matlab" target="_blank" rel="external">matlab code generation from rtems</a></p>
<p><a href="https://www.mathworks.com/company/newsletters/articles/the-joy-of-generating-c-code-from-matlab.html" target="_blank" rel="external">the joy of generating C code from MATLAB</a></p>
<p><a href="https://ww2.mathworks.cn/products/matlab-coder.html" target="_blank" rel="external">matlab coder introduction</a></p>
<p><a href="https://www.mathworks.com/help/rtw/index.html" target="_blank" rel="external">matlab code doc</a></p>
<p><a href="https://www.mathworks.com/help/rtw/ug/use-the-real-time-model-data-structure.html" target="_blank" rel="external">real-time model data structure</a></p>
<p><a href="https://ww2.mathworks.cn/help/simulink/ug/generate-code-from-rate-based-model.html" target="_blank" rel="external">generate code from rate-based model</a></p>
<p><a href="https://www.mathworks.com/help/stateflow/ug/schedule-one-subsystem-in-a-single-step.html" target="_blank" rel="external">schedule a subsystem multiple times in a single step</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/18/massively-adas-test-pipeline/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/18/massively-adas-test-pipeline/" itemprop="url">massively adas test pipeline</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-18T05:20:39-04:00">
                2020-03-18
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/18/massively-adas-test-pipeline/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/03/18/massively-adas-test-pipeline/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="background"><a href="#background" class="headerlink" title="background"></a>background</h2><p>ADAS engineers in OEM use Matlab/Simulink(model based design) to develop the adas algorithms, e.g. aeb. Simulink way is enough for fuction verification in L2 and below; for L2+ scenario, often need to test these adas functions in system level, basically test it in scenarios as much as possible, kind of L3 requirements. </p>
<p>one way to do sytem level verification is through <strong>replay</strong>, basically the test vehicle fleet can collect large mount of data, then feed in a <strong>test pipeline</strong>, to check if these adas functions are triggered well or missed. </p>
<p>for replay system test, we handle large mount of data, e.g. Pb, so the Simulink model run is too slow. the <strong>adas test pipeline</strong> with the ability to <strong>run massively</strong> is required. </p>
<p>the previous blog <a href="https://zjli2013.github.io/2020/03/11/high-concurrent-ws-log-server/" target="_blank" rel="external">high concurrent ws server</a> mentioned about the archetecture of this massively adas test pipeline: with each adas model integrated with a <strong>websocket client</strong>, and all of these ws clients talk to a <strong>websocekt server</strong>, which has api to write database. </p>
<h2 id="encode-in-C"><a href="#encode-in-C" class="headerlink" title="encode in C"></a>encode in C</h2><p>the adas simulink model can be <a href="https://www.mathworks.com/company/newsletters/articles/the-joy-of-generating-c-code-from-matlab.html" target="_blank" rel="external">encode in c</a>, which of course can encode as c++, while not powerful yet. as in C is more scalable then simulink/matlab. </p>
<p>matlab/simulink encode has a few choices, massively run is mostly in Linux-like os, here we choose <code>ert</code> env to encode the model, after we can build and test as:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">gcc -c adas_model.c -I . </div><div class="line">gcc -c ert_main.c </div><div class="line">gcc ert_main.o adas_model.c -o mytest</div></pre></td></tr></table></figure>
<h2 id="json-c"><a href="#json-c" class="headerlink" title="json-c"></a>json-c</h2><p>as all messages in <code>adas model in c</code> is stored in program memory, first thing is to serialize these to json.  here we choose <a href="https://github.com/json-c/json-c" target="_blank" rel="external">json-c</a>:</p>
<ul>
<li>install on local Ubuntu </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install autoconf automake libtool </div><div class="line">sh autogen.sh</div><div class="line">./configure</div><div class="line">make &amp;&amp; make install</div></pre></td></tr></table></figure>
<p>then the json-c header is at:  </p>
<pre><code>/usr/local/include/json-c
</code></pre><p>and the libs at: </p>
<pre><code>/usr/local/lib/libjson-c.so *.al
</code></pre><p>when using we can add the following flags:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">JSON_C_DIR=/path/to/json_c/install</div><div class="line">CFLAGS += -I$(JSON_C_DIR)/include/json-c</div><div class="line">LDFLAGS+= -L$(JSON_C_DIR)/lib -ljson-c</div></pre></td></tr></table></figure>
<p>the json object can be created as:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">json_object</span> *<span class="title">json_obj</span> =  <span class="title">json_object_new_object</span>();</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">json_object</span> *<span class="title">json_arr</span> = <span class="title">json_object_new_array</span>();</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">json_object</span> *<span class="title">json_string</span> = <span class="title">json_object_new_string</span>(<span class="title">name</span>);</span></div><div class="line"><span class="keyword">int</span> i=<span class="number">0</span>;</div><div class="line"><span class="keyword">for</span>(; i&lt;<span class="number">20</span>; i++)&#123;</div><div class="line">	    <span class="class"><span class="keyword">struct</span> <span class="title">json_object</span> *<span class="title">json_double</span> = <span class="title">json_object_new_double</span>(<span class="title">vals</span>[<span class="title">i</span>]);</span></div><div class="line">  	    json_object_array_put_idx(json_arr, i, json_double);</div><div class="line">&#125;</div><div class="line">json_object_object_add(json_obj, <span class="string">"name"</span>, json_string);</div><div class="line">json_object_object_add(json_obj, <span class="string">"signals"</span>, json_arr);</div></pre></td></tr></table></figure>
<p>modern c++ json libs are more pretty, e.g. <a href="https://github.com/open-source-parsers/jsoncpp" target="_blank" rel="external">jsoncpp</a>, <a href="http://rapidjson.org" target="_blank" rel="external">rapidJSON</a>, <a href="https://github.com/nlohmann/json" target="_blank" rel="external">json for modern c++</a></p>
<h2 id="wsclient-c"><a href="#wsclient-c" class="headerlink" title="wsclient-c"></a>wsclient-c</h2><p>the first ws client I tried is: <a href="https://github.com/payden/libwsclient" target="_blank" rel="external">wsclient in c</a>, with default install, can find the headers and libs, separately at: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/usr/<span class="built_in">local</span>/include/wsclient</div><div class="line">/usr/<span class="built_in">local</span>/lib/libwsclient.so or *.a</div></pre></td></tr></table></figure>
<p>when using:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gcc -o client wsclient.c -I/usr/<span class="built_in">local</span>/include -L/usr/<span class="built_in">local</span>/lib/ -lwsclient</div></pre></td></tr></table></figure>
<h4 id="onopen"><a href="#onopen" class="headerlink" title="onopen()"></a>onopen()</h4><p>as we need send custom message through this client, and the default message was sent inside <code>onopen()</code>, I have to add additionaly argument <code>char\*</code> into the default function pointer <code>onopen</code> </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">int onopen(wsclient *c, char* message) &#123;</div><div class="line">          libwsclient_send(c, message);</div><div class="line">          return 0;</div><div class="line">&#125;</div><div class="line"> </div><div class="line">void libwsclient_onopen(wsclient *client, int (*cb)(wsclient *c, char* ), char* msg) &#123;</div><div class="line">           pthread_mutex_lock(&amp;client-&gt;lock);</div><div class="line">           client-&gt;onopen = cb;</div><div class="line">           pthread_mutex_unlock(&amp;client-&gt;lock);</div><div class="line">&#125;</div><div class="line"></div><div class="line">	if(pthread_create(&amp;client-&gt;handshake_thread, NULL, libwsclient_handshake_thread, (void *)client)) &#123;</div></pre></td></tr></table></figure>
<p>and the <a href="https://github.com/payden/libwsclient/issues/15" target="_blank" rel="external">onopen callback</a> is actually excuted inside handshake thread, in which is not legacy to pass char* message. further as there is no global alive status to tell the client-server channel is alive, to call  <code>libwsclient_send()</code> in another thread sounds trouble-possible. </p>
<p>looks wsclient-c is limited, I transfer to wsclient c++. but need make sure <code>model in c</code> workable with <code>g++</code>. </p>
<h2 id="wsclient-c-1"><a href="#wsclient-c-1" class="headerlink" title="wsclient c++"></a>wsclient c++</h2><p><a href="https://github.com/zaphoyd/websocketpp" target="_blank" rel="external">websocketpp</a> is <a href="https://github.com/zaphoyd/websocketpp/issues/856" target="_blank" rel="external">a header only C++ library</a>, there is no <code>libs</code> after built, but it is depends on <code>boost</code>, so to use this lib, we can add header and libs as following: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/usr/local/include/websocketpp </div><div class="line">/usr/lib/x86_64-linux-gnu/libboost_*.so</div></pre></td></tr></table></figure>
<p>I am using the <a href="https://github.com/zaphoyd/websocketpp/blob/master/tutorials/utility_client/step6.cpp" target="_blank" rel="external">wsclient from sample</a>, and define a public method as the client process:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">client_process</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">string</span>&amp; server_url, <span class="built_in">std</span>::<span class="built_in">string</span>&amp; message)</span></span>&#123;</div><div class="line">    websocket_endpoint endpoint;</div><div class="line">    <span class="keyword">int</span> connection_id = endpoint.connect(server_url);</div><div class="line">    <span class="keyword">if</span> (connection_id != <span class="number">-1</span>) &#123;</div><div class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"&gt; Created connection with id "</span> &lt;&lt; connection_id &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">    &#125;</div><div class="line">    connection_metadata::ptr mtdata = endpoint.get_metadata(connection_id);</div><div class="line">    <span class="comment">//<span class="doctag">TODO:</span> optimized with this sleeping time</span></div><div class="line"> boost::this_thread::sleep(boost::posix_time::milliseconds(<span class="number">200</span>));</div><div class="line">    <span class="keyword">int</span> retry_num = <span class="number">0</span>; </div><div class="line">    <span class="keyword">while</span>(mtdata-&gt;get_status() != <span class="string">"Open"</span> &amp;&amp; retry_num &lt; <span class="number">100</span>)&#123;</div><div class="line">	<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"&gt; connected is not open "</span> &lt;&lt; connection_id &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</div><div class="line">	boost::this_thread::sleep(boost::posix_time::milliseconds(<span class="number">100</span>));</div><div class="line">	connection_id = endpoint.connect(server_url); </div><div class="line">        mtdata = endpoint.get_metadata(connection_id);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">   <span class="keyword">if</span>(mtdata-&gt;get_status() != <span class="string">"Open"</span>) &#123;</div><div class="line">	<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"retry failed, exit -1"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span> ;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">   &#125;</div><div class="line">   endpoint.send(connection_id, message);</div><div class="line">   <span class="built_in">std</span>::<span class="built_in">cout</span>  &lt;&lt; message &lt;&lt;<span class="string">" send successfully"</span>  &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span> ;</div></pre></td></tr></table></figure>
<p>there is more elegent <a href="https://github.com/maldworth/websocketpp-retry-client" target="_blank" rel="external">retry client</a> solution. </p>
<p>to build our wsclient: </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"> g++ wsclient.cpp -o ec  -I/usr/local/include -L/usr/lib/x86_64-linux-gnu -lpthread  -lboost_system -lboost_random -lboost_thread -lboost_chrono </div><div class="line">``` </div><div class="line"></div><div class="line">## ws server in python</div><div class="line"></div><div class="line">we implemented a simple ws server with [websockets]():</div><div class="line"></div><div class="line">```python</div><div class="line">#!/usr/bin/env python3</div><div class="line"></div><div class="line">import asyncio</div><div class="line">import websockets</div><div class="line">import json </div><div class="line">from db_ model import dbwriter, adas_msg, Base</div><div class="line"></div><div class="line">class wsdb(object):</div><div class="line">    def __init__(self, host=None, port=None):</div><div class="line">        self.host = host</div><div class="line">        self.port = port</div><div class="line">        self.dbwriter_ = dbwriter()</div><div class="line"></div><div class="line">    async def process(self, websocket, path):</div><div class="line">        try:</div><div class="line">            raw_ = await websocket.recv()</div><div class="line">            jdata = json.loads(raw_)</div><div class="line">            orm_obj = adas_msg(jdata)</div><div class="line">            try:</div><div class="line">                self.dbwriter_.write(orm_obj)</div><div class="line">                self.dbwriter_.commit()</div><div class="line">            except Exception as e:</div><div class="line">                self.dbwriter_.rollback()</div><div class="line">                print(e)</div><div class="line">        except Exception as e:</div><div class="line">            print(e)</div><div class="line"></div><div class="line">        greeting = "hello from server"</div><div class="line">        await websocket.send(greeting)</div><div class="line">        print(f"&gt; &#123;greeting&#125;")</div><div class="line"></div><div class="line">    def run(self):</div><div class="line">        if self.host and self.port :</div><div class="line">            start_server = websockets.serve(self.process, self.host, self.port)</div><div class="line">        else:</div><div class="line">            start_server = websockets.serve(self.process, "localhost", 8867)</div><div class="line">        asyncio.get_event_loop().run_until_complete(start_server)</div><div class="line">        asyncio.get_event_loop().run_forever()       </div><div class="line"></div><div class="line">if __name__=="__main__":</div><div class="line">    test1 = wsdb()</div><div class="line">    test1.run()</div></pre></td></tr></table></figure>
<p>the simple orm <code>db_writer</code> is from <a href="">sqlalchemy</a> model.</p>
<h2 id="in-makefile"><a href="#in-makefile" class="headerlink" title="in makefile"></a>in makefile</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">CC=g++</div><div class="line">JSONC_IDIR=/usr/<span class="built_in">local</span>/include</div><div class="line">CFLAGS=-I. -I$(JSONC_IDIR)</div><div class="line">OPEN_LOOP_DEPS= rtwtypes.h adas_test.h </div><div class="line">LDIR=-L/usr/<span class="built_in">local</span>/lib/</div><div class="line">LIBS=-ljson-c</div><div class="line">BOOST_LDIR=-L/usr/lib/x86_64-linux-gnu</div><div class="line">BOOST_LIBS= -pthread -lboost_system -lboost_random -lboost_thread -lboost_chrono</div><div class="line">JSON_DEPS= wsclientpp.h</div><div class="line">obj = adas_test.o ert_main.o </div><div class="line">src=*.c</div><div class="line"></div><div class="line">$(obj): $(src) $(DEPS) $(JSON_DEPS)</div><div class="line">	$(CC) -c $(src) $(CFLAGS)</div><div class="line"></div><div class="line">mytest: $(obj)</div><div class="line">	$(CC) -o mytest $(obj) $(CFLAGS) $(LDIR) $(LIBS) $(BOOST_LDIR) $(BOOST_LIBS)</div><div class="line"></div><div class="line">.PHONY: clean</div><div class="line"></div><div class="line">clean:</div><div class="line">	rm -f *.o</div></pre></td></tr></table></figure>
<p>so now we have encode adas simulink model to C code, and integrate this model C with a websocket client, which can talk to a ws server, which further write to database, which further can be used an data analysis model. </p>
<p>we can add front-end web UI and system monitor UI if needed, but so far this <strong>adas test pipeline</strong> can support a few hundred adas test cores to run concurrently.  </p>
<h2 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h2><p> <a href="https://stackoverflow.com/questions/1352749/multiple-arguments-to-function-called-by-pthread-create" target="_blank" rel="external">pthread_create with multi args</a></p>
<p><a href="https://github.com/maldworth/websocketpp-retry-client" target="_blank" rel="external">wscpp retry client</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/14/stanford-cs-linked-list-problems/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/14/stanford-cs-linked-list-problems/" itemprop="url">stanford cs linked list problems</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-14T23:00:12-04:00">
                2020-03-14
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/14/stanford-cs-linked-list-problems/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/03/14/stanford-cs-linked-list-problems/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="background"><a href="#background" class="headerlink" title="background"></a>background</h2><p><a href="http://cslibrary.stanford.edu" target="_blank" rel="external">stanford cs</a> gives me some confidence to deal with linked list.</p>
<h2 id="linked-list-basics"><a href="#linked-list-basics" class="headerlink" title="linked list basics"></a>linked list basics</h2><p><a href="http://cslibrary.stanford.edu/102/PointersAndMemory.pdf" target="_blank" rel="external">basic pointers</a> as well as <a href="">previous blog</a>: </p>
<ul>
<li><p>a <code>pointer</code> stores a reference to another variable(<code>pointee</code>). what stored inside <code>pointer</code> is an reference to its pointee’s type.</p>
</li>
<li><p>NULL pointer, points to nothing.</p>
</li>
<li><p>pointer assignment <code>p=q</code>, makes the two pointers point to the same pointee, namely the two pointers point to the same pointee memory.</p>
</li>
</ul>
<p>it’s a good habit to remember to check the empty list case. </p>
<p>define the Linked-List structure:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ListNode</span> &#123;</span></div><div class="line">	<span class="keyword">int</span> val ;</div><div class="line">	ListNode *next;</div><div class="line">	ListNode(<span class="keyword">int</span> x): val(x), next(<span class="literal">NULL</span>)&#123;&#125;</div><div class="line">&#125;;</div><div class="line"><span class="keyword">typedef</span> ListNode node_ ;</div></pre></td></tr></table></figure>
<ul>
<li>iterate over the list with a local pointer</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">node_ *current = head ;</div><div class="line"><span class="keyword">while</span>(current)&#123;</div><div class="line">	current = current-&gt;next;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">for</span>(current=head; current!=<span class="literal">NULL</span>; current=current-&gt;next)&#123;&#125;;</div></pre></td></tr></table></figure>
<ul>
<li>push a new node to the front of the list </li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Push</span><span class="params">(ListNode** headRef, <span class="keyword">int</span> val)</span></span>&#123;</div><div class="line">	ListNode newNode = <span class="keyword">new</span> ListNode(val);</div><div class="line">	newNode.next = *headRef ;</div><div class="line">	*headRef = newNode ; </div><div class="line">&#125;</div><div class="line">``` </div><div class="line"></div><div class="line">* changes the head pointer by a reference pointer</div><div class="line"></div><div class="line">```c++</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">changetoNull</span><span class="params">(ListNode** head)</span></span>&#123;</div><div class="line">	*head = <span class="literal">NULL</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>build up a list by adding nodes at its head</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function">ListNode* <span class="title">AddatHead</span><span class="params">()</span></span>&#123;</div><div class="line">	ListNode *head = <span class="literal">NULL</span> ;</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>; i&lt;<span class="number">5</span>; i++)&#123;</div><div class="line">		Push(&amp;head, i);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> head;</div><div class="line">&#125;</div><div class="line">``` </div><div class="line"></div><div class="line">which gives a <span class="built_in">list</span> &#123;<span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>&#125; </div><div class="line"></div><div class="line">* build up a <span class="built_in">list</span> by appending nodes to the tail</div><div class="line"></div><div class="line">```c++</div><div class="line"><span class="function">ListNode* <span class="title">BuildwithSpecialCase</span><span class="params">()</span></span>&#123;</div><div class="line">	ListNode* head = <span class="literal">NULL</span> ;</div><div class="line">	ListNode* tail ; </div><div class="line">   Push(&amp;head, <span class="number">1</span>);</div><div class="line">   tail = head ; </div><div class="line">   <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">2</span>; i&lt;<span class="number">5</span>; i++)&#123;</div><div class="line">       Push(&amp;(tail-&gt;next), i);</div><div class="line">       tail = tail-&gt;next;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> head; </div><div class="line">&#125;</div><div class="line">``` </div><div class="line"></div><div class="line">which gives a <span class="built_in">list</span> &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;</div><div class="line"></div><div class="line">* build up a <span class="built_in">list</span> with dummy node </div><div class="line"></div><div class="line">```c++</div><div class="line"><span class="function">ListNode* <span class="title">BuildWithDummy</span><span class="params">()</span></span>&#123;</div><div class="line">   ListNode dummy = <span class="keyword">new</span> ListNode(<span class="number">0</span>);</div><div class="line">   ListNode* tail = &amp;dummy ; </div><div class="line">   <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>; i&lt;<span class="number">5</span>; i++)&#123;</div><div class="line">   		Push(&amp;(tail-&gt;next), i);</div><div class="line">   		tail = tail-&gt;next;</div><div class="line">   	&#125;</div><div class="line">   	<span class="keyword">return</span> dummy.next ; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>which returns a list {1, 2, 3, 4} </p>
<ul>
<li>appendNode(), add new node at the tail</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="function">ListNode* <span class="title">appendNode</span><span class="params">(ListNode** headRef, <span class="keyword">int</span> val)</span></span>&#123;</div><div class="line">	ListNode *current  = *headRef ;</div><div class="line">	ListNode newNode = <span class="keyword">new</span> ListNode(num);</div><div class="line">	<span class="keyword">if</span>(!current)&#123;</div><div class="line">		current = &amp;newNode ;</div><div class="line">	&#125;<span class="keyword">else</span>&#123;</div><div class="line">		<span class="keyword">while</span>(current-&gt;next)&#123;</div><div class="line">			current = current-&gt;next ;</div><div class="line">		&#125;</div><div class="line">		current-&gt;next = &amp;newNode ;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">``` </div><div class="line"></div><div class="line">* copyList()</div><div class="line"></div><div class="line">```c++</div><div class="line"><span class="function">ListNode* <span class="title">copyList</span><span class="params">(ListNode* head)</span></span>&#123;</div><div class="line">	ListNode *current = head ;</div><div class="line">	ListNode *newList = <span class="literal">NULL</span> ;</div><div class="line">	ListNode *tail = <span class="literal">NULL</span> ;</div><div class="line">	</div><div class="line">	<span class="keyword">while</span>(current)&#123;</div><div class="line">		<span class="keyword">if</span>(!newList)&#123;</div><div class="line">			newList = &amp;(<span class="keyword">new</span> ListNode(current-&gt;val));</div><div class="line">			tail = newList ;</div><div class="line">		&#125;<span class="keyword">else</span>&#123;</div><div class="line">			tail-&gt;next = &amp;(<span class="keyword">new</span> ListNode(current-&gt;val));</div><div class="line">			tail = tail-&gt;next ; </div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">return</span> newList ; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>copyList() recursive </li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function">ListNode* <span class="title">CopyList</span><span class="params">(ListNode* head)</span></span>&#123;</div><div class="line">	<span class="keyword">if</span>(!head) <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">	<span class="keyword">else</span>&#123;</div><div class="line">		ListNode *current = head ;</div><div class="line">		ListNode *newList = &amp;(ListNode(current-&gt;val));</div><div class="line">		newList-&gt;next = CopyList(current-&gt;next);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="linked-list-problems-further"><a href="#linked-list-problems-further" class="headerlink" title="linked list problems further"></a>linked list problems further</h2><ul>
<li>InsertNth()</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">insertNth</span><span class="params">(node_ **head, <span class="keyword">int</span> index, <span class="keyword">int</span> data)</span></span>&#123;</div><div class="line">	<span class="keyword">if</span>(index==<span class="number">0</span>) Push(head, data);</div><div class="line">	<span class="keyword">else</span>&#123;</div><div class="line">		node_ * cur = *head ;</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;index<span class="number">-1</span>; i++)&#123;</div><div class="line">				cur = cur-&gt;next ;</div><div class="line">		&#125;	</div><div class="line">		Push(&amp;*cur-&gt;next), data);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>sortedInsert()</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// be notified, here we using **, to use the pointer of the head, as the head node may be updated  </span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">sortedInsert</span><span class="params">(node_ **head, node* newNode)</span></span>&#123;</div><div class="line">	<span class="keyword">if</span>(*head == <span class="literal">NULL</span> || head-&gt;val &gt;= newNode-&gt;val)&#123;</div><div class="line">		newNode-&gt;next = *head;</div><div class="line">		*head = newNode;</div><div class="line">	&#125;<span class="keyword">else</span>&#123;</div><div class="line">		node_ *cur = *head ;</div><div class="line">		<span class="keyword">while</span>(cur-&gt;next &amp;&amp; cur-&gt;next-&gt;val &lt; newNode-&gt;val)&#123;</div><div class="line">			cur = cur-&gt;next;</div><div class="line">		&#125; </div><div class="line">		newNode-&gt;next = cur-&gt;next ;</div><div class="line">		cur-&gt;next = newNode ;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//with dummy head</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">sortedInsert</span><span class="params">(node_ **head, node* newNode)</span></span>&#123;</div><div class="line">	<span class="function">node_ <span class="title">dummy</span><span class="params">(<span class="number">0</span>)</span></span>;</div><div class="line">	dummy.next = *head ; 	</div><div class="line">	node_ *cur = &amp;dummy ;</div><div class="line">	<span class="keyword">while</span>(cur-&gt;next &amp;&amp; cur-&gt;next-&gt;val &lt; newNode-&gt;val)&#123;</div><div class="line">		cur = cur-&gt;next;</div><div class="line">	&#125;</div><div class="line">	newNode-&gt;next = cur-&gt;next ;</div><div class="line">	cur-&gt;next = newNode ;</div><div class="line">	*head = dummy-&gt;next;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>insertSort()</li>
</ul>
<p>given  as unsorted list, and output with an sorted list</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">InsertSort</span><span class="params">(node_ ** head)</span></span>&#123;</div><div class="line">	node_ *result = <span class="literal">NULL</span> ;</div><div class="line">	node_ *cur = *head ;</div><div class="line">	node_ *next ;</div><div class="line">	<span class="keyword">while</span>(cur)&#123;</div><div class="line">		next = cur-&gt;next ;  <span class="comment">// ticky- note the next pointer, before we change it</span></div><div class="line">		sortedInsert(result, cur);</div><div class="line">		cur = next ;</div><div class="line">	&#125;</div><div class="line">	*head = result ;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>append() </li>
</ul>
<p>append list b to the end of list a </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">append</span><span class="params">(node_ **a, node_ **b)</span></span>&#123;</div><div class="line">	node_ * cur ;</div><div class="line">	<span class="keyword">if</span>( *a == <span class="literal">NULL</span>)&#123; *a = *b ;&#125;</div><div class="line">	<span class="keyword">else</span>&#123;</div><div class="line">		cur = *a ;</div><div class="line">		<span class="keyword">while</span>(cur-&gt;next)&#123;</div><div class="line">			cur = cur-&gt;next;</div><div class="line">		&#125;</div><div class="line">		cur-&gt;next = *b ;</div><div class="line">	&#125;</div><div class="line">	*b = <span class="literal">NULL</span> ; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>frontBackSplit()</li>
</ul>
<p>given a list, split it into two sublists: one for the front half, one for the back half</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">frontBackSplit</span><span class="params">(node_ **head, node_ **front, node_ **back)</span></span>&#123;</div><div class="line">	<span class="keyword">int</span> len = length(head);</div><div class="line">	node_ *cur = *head ;</div><div class="line">	<span class="keyword">if</span>(len &lt; <span class="number">2</span>)&#123;</div><div class="line">		*front = *head;</div><div class="line">		*back = <span class="literal">NULL</span> ;</div><div class="line">	&#125;<span class="keyword">else</span>&#123;</div><div class="line">		<span class="keyword">int</span> half = len/<span class="number">2</span>; </div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;half<span class="number">-1</span>; i++)&#123;</div><div class="line">			cur = cur-&gt;next;</div><div class="line">		&#125;</div><div class="line">		*front = *head;		</div><div class="line"> 		*back = cur;</div><div class="line">		cur = <span class="literal">NULL</span> ;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">frontBackSplit2</span><span class="params">(node_ **head, node_ **front, node_ **back)</span></span>&#123;</div><div class="line">	node_ *fast, *slow ;</div><div class="line">	<span class="keyword">if</span>(*head == <span class="literal">NULL</span> || (*head)-&gt;next == <span class="literal">NULL</span>)&#123;</div><div class="line">		*front = *head ;</div><div class="line">		*back = <span class="literal">NULL</span> ;</div><div class="line">	&#125;<span class="keyword">else</span>&#123;</div><div class="line">		slow = head;</div><div class="line">		fast = head-&gt;next ;</div><div class="line">		<span class="keyword">while</span>(fast)&#123;</div><div class="line">			fast = fast-&gt;next;</div><div class="line">			<span class="keyword">if</span>(fast)&#123;</div><div class="line">				fast = fast-&gt;next;</div><div class="line">				slow = slow-&gt;next;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		*front = *head;</div><div class="line">		*back = slow-&gt;next ;</div><div class="line">		slow-&gt;next = <span class="literal">NULL</span> ;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>removeDuplicates()</li>
</ul>
<p>remove duplicated node from a sorted list </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">removeDuplicates</span><span class="params">(node_ ** head)</span></span></div><div class="line">&#123;</div><div class="line">	node_ *slow, *fast ;</div><div class="line">	<span class="keyword">if</span>(head == <span class="literal">NULL</span> || head-&gt;next == <span class="literal">NULL</span>)&#123;</div><div class="line"> 		<span class="keyword">return</span> ;</div><div class="line">        &#125;</div><div class="line">	slow = *head ;</div><div class="line">	fast = (*head)-&gt;next ;</div><div class="line">	<span class="keyword">while</span>(fast)&#123;</div><div class="line">		<span class="keyword">if</span>(slow-&gt;val == fast-&gt;val)&#123;</div><div class="line">			node_ * needfree = fast ;</div><div class="line">			fast = fast-&gt;next ;</div><div class="line">			<span class="built_in">free</span>(needfree); </div><div class="line">		&#125;<span class="keyword">else</span>&#123;</div><div class="line">		   slow = slow-&gt;next;</div><div class="line">		   fast = fast-&gt;next;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">removeDuplicate</span><span class="params">(node_ **head)</span></span>&#123;</div><div class="line">	node_ *cur = *head;</div><div class="line">	<span class="keyword">if</span>(cur==<span class="literal">NULL</span>) <span class="keyword">return</span> ;</div><div class="line">	<span class="keyword">while</span>(cur-&gt;next)&#123;</div><div class="line">		<span class="keyword">if</span>(cur-&gt;val == cur-&gt;next-&gt;val)&#123;</div><div class="line">			node_ *nextNext = cur-&gt;next-&gt;next ;</div><div class="line">			<span class="built_in">free</span>(cur-&gt;next);</div><div class="line">			cur-&gt;next = nextNext;</div><div class="line">		&#125;<span class="keyword">else</span>&#123;</div><div class="line">			cur = cur-&gt;next;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>moveNode()</li>
</ul>
<p>given two list, remove the front node from the second list, and push it onto the front of the first.</p>
<p>// a = {1, 2, 3};  b = {1, 2, 3}  =&gt;  a={1, 1, 2, 3}, b={2, 3}</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">moveNode</span><span class="params">(node_ **dest, node_ **source)</span></span>&#123;</div><div class="line">	node_ *newNode = *source ; </div><div class="line">	*source = newNode-&gt;next ; </div><div class="line">	newNode-&gt;next = *dest ;</div><div class="line">	*dest = newNode ; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>alternatingSplit()</li>
</ul>
<p>given a list, split its nodes into two shorter lists. if we number the elements 0, 1, 2, …, then all the even elements go to the first sublist, and all the odd elements go to tthe second</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">alternatingSplit</span><span class="params">(node_ *source, node_ **ahead, node_ **bhead)</span></span>&#123;</div><div class="line">	node_ *a = <span class="literal">NULL</span> ;</div><div class="line">	node_ *b = <span class="literal">NULL</span> ;</div><div class="line">	node_ *cur = *source ;</div><div class="line">	<span class="keyword">while</span>(cur)&#123;</div><div class="line">		moveNode(&amp;a, &amp;cur);</div><div class="line">		<span class="keyword">if</span>(cur)&#123;</div><div class="line">			moveNode(&amp;b, &amp;cur);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	*ahead = a ;</div><div class="line">	*bhead = b;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>shuffleMerge()</li>
</ul>
<p>given two list, merge their nodes together to make one list, takign nodes alternatively between the two lists </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="function">node_* <span class="title">shufflMerge</span><span class="params">(node_ *a, node_ *b)</span></span>&#123;</div><div class="line">	node_ *res = <span class="literal">NULL</span> ;</div><div class="line">	<span class="keyword">int</span> i=<span class="number">0</span>;</div><div class="line">	<span class="keyword">while</span>(a || b)&#123;</div><div class="line">		<span class="keyword">if</span>(i % <span class="number">2</span> == <span class="number">0</span> &amp;&amp; a)&#123;</div><div class="line">			moveNode(&amp;res, &amp;a);</div><div class="line">		&#125;<span class="keyword">else</span> <span class="keyword">if</span>(b)&#123;</div><div class="line">			moveNode(&amp;res, &amp;b);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125; <span class="comment">//but this gives the tail to front order</span></div><div class="line"></div><div class="line"><span class="function">node_* <span class="title">shufflMerge2</span><span class="params">(node_ *a, node_ *b)</span></span>&#123;</div><div class="line">	<span class="function">node_ <span class="title">dummy</span><span class="params">(<span class="number">0</span>)</span></span>;</div><div class="line">	node *tail = &amp;dummy ;</div><div class="line">	<span class="keyword">while</span>(<span class="number">1</span>)&#123;</div><div class="line">		<span class="keyword">if</span>(a==<span class="literal">NULL</span>)&#123;</div><div class="line">			tail-&gt;next = b;</div><div class="line">			<span class="keyword">break</span> ;</div><div class="line">		&#125;<span class="keyword">else</span> <span class="keyword">if</span>(b == <span class="literal">NULL</span>)&#123;</div><div class="line">			tail-&gt;next = a;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;<span class="keyword">else</span>&#123;</div><div class="line">			tail-&gt;next = a ;</div><div class="line">			tail = a ;</div><div class="line">			a = a-&gt;next ;</div><div class="line">			tail-&gt;next = b;</div><div class="line">			tail = b;</div><div class="line">			b = b-&gt;next;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> dummy.next ;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// recursive ?</span></div><div class="line"><span class="function">node_* <span class="title">shufflMerge3</span><span class="params">(node_ *a, node_ *b)</span></span>&#123;</div><div class="line">	node_ *res ;</div><div class="line">	node_ *recur ; </div><div class="line">	<span class="keyword">if</span>(a==<span class="literal">NULL</span>) <span class="keyword">return</span> b ;</div><div class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(b=<span class="literal">NULL</span>) <span class="keyword">return</span> a ;</div><div class="line">	<span class="keyword">else</span>&#123;</div><div class="line">		recur = shuffleMerge3(a-&gt;next, b-&gt;next);</div><div class="line">		res = a ;</div><div class="line">		a-&gt;next = b ;</div><div class="line">		b-&gt;next = recur ;</div><div class="line">		<span class="keyword">return</span> res;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>sortedMerge()</li>
</ul>
<p>given two sorted in incresing order listes, merge into one in increasing order </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="function">node_ *<span class="title">sortedMerge</span><span class="params">(node_ *a, node_ *b)</span></span>&#123;</div><div class="line">	<span class="function">node_ <span class="title">dummy</span><span class="params">(<span class="number">0</span>)</span></span>;</div><div class="line">        node_ *tail = &amp;dummy ;</div><div class="line">	dummy.next = <span class="literal">NULL</span> ;</div><div class="line">	<span class="keyword">while</span>(<span class="number">1</span>)&#123;</div><div class="line">		<span class="keyword">if</span>(a==<span class="literal">NULL</span>)&#123;</div><div class="line">			tail-&gt;next = b ;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;<span class="keyword">else</span> <span class="keyword">if</span>(b==<span class="literal">NULL</span>)&#123;</div><div class="line">			tail-&gt;next = a;</div><div class="line">			<span class="keyword">break</span> ;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span>(a-&gt;val &lt;= b-&gt;val)&#123;</div><div class="line">			moveNode(&amp;(tail-&gt;next), &amp;a);</div><div class="line">		&#125;<span class="keyword">else</span>&#123;</div><div class="line">			moveNode(&amp;(tail-&gt;next), &amp;b);</div><div class="line">		&#125;</div><div class="line">		tail = tail-&gt;next; </div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> dummy.next ;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// how this works?</span></div><div class="line"><span class="function">node_ *<span class="title">sortedMerge2</span><span class="params">(node_ *a, node_ *b)</span></span>&#123;</div><div class="line">	node_ *result = <span class="literal">NULL</span> ;</div><div class="line">	<span class="keyword">if</span>(a==<span class="literal">NULL</span>) <span class="keyword">return</span> b;</div><div class="line">	<span class="keyword">if</span>(b==<span class="literal">NULL</span>) <span class="keyword">return</span> a;</div><div class="line"></div><div class="line">	<span class="keyword">if</span>(a-&gt;val &lt;= b-&gt;val)&#123;</div><div class="line">		result = a;</div><div class="line">		result-&gt;next = sortedMerge2(a-&gt;next, b);</div><div class="line">	&#125;<span class="keyword">else</span>&#123;</div><div class="line">		result = b;</div><div class="line">		result-&gt;next = sortedMerge2(a, b-&gt;next);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span>  result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>mergeSort()</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">mergeSor</span><span class="params">(node_ ** headRef)</span></span>&#123;</div><div class="line">	node_ *head = *headRef ;</div><div class="line">	node_ *a, *b;</div><div class="line">	<span class="keyword">if</span>( (head==<span class="literal">NULL</span>) || (head-&gt;next == <span class="literal">NULL</span>))&#123;</div><div class="line">		<span class="keyword">return</span> ;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	frontBacksplit(head, &amp;a, &amp;b);</div><div class="line">	mergeSort(&amp;a);</div><div class="line">	mergeSort(&amp;b);</div><div class="line"></div><div class="line">	*headRef = sortedMerge(a,b):</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>reverse()</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">reverse</span><span class="params">(node_ **head)</span></span>&#123;</div><div class="line">	node_ *res = <span class="literal">NULL</span>;</div><div class="line">	node_ *cur = *head ;</div><div class="line">	node_ *next ;</div><div class="line"></div><div class="line">	<span class="keyword">while</span>(cur)&#123;</div><div class="line">		next = cur-&gt;next;</div><div class="line">		cur-&gt;next = res ;</div><div class="line">		res = cur ;</div><div class="line">		cur = next ; </div><div class="line">	&#125;</div><div class="line"></div><div class="line">	*head = res;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>recursive reverse()</li>
</ul>
<p>// concerned </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">recursiveReverse</span><span class="params">(node_ **head)</span></span>&#123;</div><div class="line">	ndoe_ *first, *rest ;</div><div class="line"></div><div class="line">	<span class="keyword">if</span>(*head == <span class="literal">NULL</span>) <span class="keyword">return</span> ;</div><div class="line">	first = *head ;</div><div class="line">	rest = first-&gt;next ;</div><div class="line">	<span class="keyword">if</span>(rest == <span class="literal">NULL</span>) <span class="keyword">return</span> ;	</div><div class="line">	recursiveReverse(&amp;rest);</div><div class="line">	first-&gt;next-&gt;next = first ;</div><div class="line">	first-&gt;next = <span class="literal">NULL</span> ;</div><div class="line">	</div><div class="line">	*head = rest ;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h2><p><a href="http://cslibrary.stanford.edu/105/LinkedListProblems.pdf" target="_blank" rel="external">linked list problems</a></p>
<p><a href="http://cslibrary.stanford.edu/103/LinkedListBasics.pdf" target="_blank" rel="external">linked list basics from standford cs</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/14/hypervisor-and-gpu-virtualization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/14/hypervisor-and-gpu-virtualization/" itemprop="url">hypervisor and gpu virtualization</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-14T00:18:55-04:00">
                2020-03-14
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/14/hypervisor-and-gpu-virtualization/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/03/14/hypervisor-and-gpu-virtualization/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="background"><a href="#background" class="headerlink" title="background"></a>background</h2><p>to build a private data center for ads training and SIL. a few concepts there:</p>
<h3 id="linux-remote-desktop"><a href="#linux-remote-desktop" class="headerlink" title="linux remote desktop"></a>linux remote desktop</h3><p>Linux GUI is based on x-protocol, which is kind of CPU based, during deploying gpu-based app in docker swarm, I have studied <a href="https://zjli2013.github.io/2019/11/29/X11-GUI-in-docker/" target="_blank" rel="external">xserver</a>, <code>ssh -X</code> channels give the way for visualization desktop and simple apps(e.g. glxgears) among xserver and xclient. while for really gpu-densive app, e.g. game rendering, machine learning, <code>ssh -X</code> can’t really use gpu resource well, which needs further support from device management mechanism from docker or k8s. </p>
<h3 id="virutal-machine-cloud-desktop"><a href="#virutal-machine-cloud-desktop" class="headerlink" title="virutal machine/ cloud desktop"></a>virutal machine/ cloud desktop</h3><p>VM is based on <a href="https://www.vmware.com/topics/glossary/content/hypervisor.html?SRC=WWW_US_GP_bare-metal-hypervisor_SiteLink" target="_blank" rel="external">hypervisor</a>, known as a virtual machine monitor(VMM), a type of virtualization software that supports the creation and management of VMs, hypervisor translate requests between the physical and virtual resources, making virtualization possible.</p>
<p>A hypervisor allows one host computer to support multiple guest VMs by virtually sharing its resources, like memory and processing. </p>
<p>Generally, there are two types of hypervisors. Type 1 hypervisors, called “bare metal,” run directly on the host’s hardware. Type 2 hypervisors, called “hosted,” run as a software layer on an operating system, like other computer programs, the most common e.g. vmware, citrix. </p>
<p>When a hypervisor is installed directly on the hardware of a physical machine, between the hardware and the operating system (OS), it is called a <a href="https://www.vmware.com/topics/glossary/content/bare-metal-hypervisor" target="_blank" rel="external">bare metal hypervisor</a>, which separates the OS from the underlying hardware, the software no longer relies on or is limited to specific hardware devices or drivers.</p>
<h3 id="VDI"><a href="#VDI" class="headerlink" title="VDI"></a>VDI</h3><p>a type of vm application is <a href="https://www.vmware.com/topics/glossary/content/virtual-desktop-infrastructure-vdi" target="_blank" rel="external">virtual desktop inftrastructure(vdi)</a>, VDI hosts desktop environments on a centralized server and deploys them to end-users on request. this process also known as <a href="https://www.vmware.com/topics/glossary/content/server-virtualization" target="_blank" rel="external">server virtualization</a></p>
<p>VDI is not necessarily requires a physical gpu, without a gpu, we can still run vmware, but the performance is poor. but for many other VM usage, beyond VDI, we still need ways to access GPU devices in VM.</p>
<h2 id="GPU-techs-in-VM"><a href="#GPU-techs-in-VM" class="headerlink" title="GPU techs in VM"></a>GPU techs in VM</h2><p>vwmare has an introduction about <a href="https://blogs.vmware.com/china/2017/11/09/horizon-7-中的-gpu-方案/" target="_blank" rel="external">gpu tech</a> in vm: </p>
<ul>
<li><p>software 3D. using software to mimic GPU calculating. all 3d calculating is done by CPU</p>
</li>
<li><p>vsga(vitual shared graphics acceleration), each virtual desktop has a vsga driver, which has a ESXi module, inside which has a GPU driver, which can call the physical gpu, but this shared mode is through Hypervisor</p>
</li>
</ul>
<p><img src="https://blogs.vmware.com/china/files/2017/11/vSGA.png" alt="image"></p>
<ul>
<li>vdga(virtual dedicated graphics accleration), or pass through mode, the physical GPU is assigned to a special virtual desktop for one user only.</li>
</ul>
<p><img src="http://blogs.vmware.com/china/files/2017/11/vDGA.png" alt="image"></p>
<ul>
<li>vgpu, split physical GPU to a few virtual-GPU, each virtual desk can have one vGPU.</li>
</ul>
<p><img src="http://blogs.vmware.com/china/files/2017/11/vGPU.png" alt="image"></p>
<h2 id="VM-vs-docker"><a href="#VM-vs-docker" class="headerlink" title="VM vs docker"></a>VM vs docker</h2><p>docker is a light-weight virtualization way, which  don’t need hypervisor, and the app in docker is access the host physical devices directly, making docker looks like a process, rather than a virtual OS; and scientfic computing apps run in VM is actually using the virtual CPU from hypervisor, which <a href="http://blog.itpub.net/35489/viewspace-2120397/" target="_blank" rel="external">bypass the cpu optimzation</a> used for math calcualting. so usually a physical machine can start hundres or thousands docker, but can only run a few VM.  </p>
<h2 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h2><p><a href="http://blog.sina.com.cn/s/blog_59cf67260100l5h4.html" target="_blank" rel="external">linux remote desktop</a></p>
<p><a href="https://blogs.gartner.com/gunnar-berger/understanding-virtual-desktop-vdi-gpu-technologies/" target="_blank" rel="external">understand vdi gpu tech</a></p>
<p><a href="https://blogs.vmware.com/apps/2018/09/using-gpus-with-virtual-machines-on-vsphere-part-3-installing-the-nvidia-grid-technology.html" target="_blank" rel="external">nvidia vgpu tech in vSphere</a></p>
<p><a href="https://www.brightcomputing.com/blog/setting-up-gpu-hypervisors-on-bright-openstack" target="_blank" rel="external">GPU hypervisors on OpenStack </a></p>
<p><a href="https://cumulusnetworks.com/blog/containers-vs-hypervisors/" target="_blank" rel="external">containers vs hypervisors</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/13/pure-c-c-pointer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/13/pure-c-c-pointer/" itemprop="url">pure c/c++ pointer</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-13T04:49:57-04:00">
                2020-03-13
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/13/pure-c-c-pointer/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/03/13/pure-c-c-pointer/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="pointer-assignment"><a href="#pointer-assignment" class="headerlink" title="pointer assignment"></a>pointer assignment</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">  <span class="keyword">int</span> a = <span class="number">10</span> ;</div><div class="line">  <span class="keyword">int</span> *pa = &amp;a ;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">"pa add "</span> &lt;&lt; &amp;pa &lt;&lt; <span class="string">"pa val "</span> &lt;&lt; *pa &lt;&lt; <span class="built_in">endl</span> ;</div><div class="line">  <span class="keyword">int</span> b = <span class="number">22</span>;</div><div class="line">  <span class="keyword">int</span> *pb = &amp;b ;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">"pb add "</span> &lt;&lt; &amp;pb &lt;&lt; <span class="string">"pb val "</span> &lt;&lt; *pb &lt;&lt; <span class="built_in">endl</span> ;</div><div class="line">  <span class="keyword">int</span> d = <span class="number">100</span> ;</div><div class="line">  <span class="keyword">int</span> *pd = &amp;d ;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">"pd add "</span> &lt;&lt; &amp;pd &lt;&lt; <span class="string">"pd val "</span> &lt;&lt; *pd &lt;&lt; <span class="built_in">endl</span> ;</div><div class="line">  <span class="keyword">int</span> *pc = pb ; <span class="comment">//pointer assignment </span></div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">"pc add "</span> &lt;&lt; &amp;pc &lt;&lt; <span class="string">"pc val "</span> &lt;&lt; *pc &lt;&lt; <span class="built_in">endl</span> ;</div><div class="line">  pb = pd ;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">"pb add "</span> &lt;&lt; &amp;pb &lt;&lt; <span class="string">"pb val "</span> &lt;&lt; *pb &lt;&lt; <span class="built_in">endl</span> ;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">"pd add "</span> &lt;&lt; &amp;pd &lt;&lt; <span class="string">"pd val "</span> &lt;&lt; *pd &lt;&lt; <span class="built_in">endl</span> ;</div><div class="line">  pd = pa ;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">"pd add "</span> &lt;&lt; &amp;pd &lt;&lt; <span class="string">"pd val "</span> &lt;&lt; *pd &lt;&lt; <span class="built_in">endl</span> ;</div><div class="line">  pa = pc ;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">"pa add "</span> &lt;&lt; &amp;pa &lt;&lt; <span class="string">"pa val "</span> &lt;&lt; *pa &lt;&lt; <span class="built_in">endl</span> ;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">"pc add "</span> &lt;&lt; &amp;pc &lt;&lt; <span class="string">"pc val "</span> &lt;&lt; *pc &lt;&lt; <span class="built_in">endl</span> ;</div><div class="line">  </div><div class="line">  <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125; </div><div class="line"></div><div class="line"><span class="comment">/* </span></div><div class="line">pb add 0x7fff5e744b30pb val 22</div><div class="line">pd add 0x7fff5e744b28pd val 100</div><div class="line">pc add 0x7fff5e744b20pc val 22</div><div class="line">pb add 0x7fff5e744b30pb val 100</div><div class="line">pd add 0x7fff5e744b28pd val 100</div><div class="line">pd add 0x7fff5e744b28pd val 10</div><div class="line">pa add 0x7fff5e744b40pa val 22</div><div class="line">pc add 0x7fff5e744b20pc val 22</div><div class="line">*/</div></pre></td></tr></table></figure>
<p>pointer assigment used a lot in linked list problems, the sample above is a pointer solution for <code>linked list reverse</code>. consider pointer as a container with an address to another object. pointer assignment, e.g. <code>pointerA = pointerB</code> only changes the content in the container. but the address of the container itself doesn’t change. and with  *(dereference) the pointer, we can see the content is changed. </p>
<p>further, taken <code>pc</code>, <code>pb</code>, <code>pd</code> as another example.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">pc = pb ;</div><div class="line">pb = pd;</div></pre></td></tr></table></figure></p>
<p>the first line will make container <code>pc</code> to store what is stored in container <code>pb</code>, in another word, the first line will make <code>pc</code> point to the address, which is stored in <code>pb</code>. </p>
<p>and the second line will then put what’s stored in container <code>pd</code> to container <code>pb</code>. </p>
<p>after this two updates, <code>pc</code> points to the original content in <code>pb</code>; <code>pb</code>  and <code>pd</code> points to the same content. obviously, what’s inside <code>pc</code> now, has nothing to do with pointer <code>pb</code>.  </p>
<h3 id="pointer-forward"><a href="#pointer-forward" class="headerlink" title="pointer++ forward"></a>pointer++ forward</h3><p>the basic scenario is as following, will <code>p2</code> move forward as well ? </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> *p1 = &amp;int_var ;</div><div class="line"><span class="keyword">int</span> *p2 = p1; </div><div class="line">p1++ ;</div></pre></td></tr></table></figure>
<p>we can see from the following <code>test.c</code>,  <code>p2</code> won’t move forward as <code>p1++</code>.  </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">  <span class="keyword">int</span> a[<span class="number">4</span>] = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span> &#125; ; </div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">" a addr "</span> &lt;&lt; &amp;a &lt;&lt; <span class="string">" a val "</span> &lt;&lt; *a &lt;&lt; <span class="built_in">endl</span> ;</div><div class="line">  <span class="keyword">int</span> *p = a ;</div><div class="line">  <span class="keyword">int</span> *q = p ;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">" p addr "</span> &lt;&lt; &amp;p &lt;&lt; <span class="string">" p val "</span> &lt;&lt; *p &lt;&lt; <span class="built_in">endl</span> ;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">" q addr "</span> &lt;&lt; &amp;q &lt;&lt; <span class="string">" q val "</span> &lt;&lt; *q &lt;&lt; <span class="built_in">endl</span> ;</div><div class="line"> </div><div class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">3</span>; i++)&#123;</div><div class="line">      q++;</div><div class="line">  &#125;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">" a addr "</span> &lt;&lt; &amp;a &lt;&lt; <span class="string">" a val "</span> &lt;&lt; *a &lt;&lt; <span class="built_in">endl</span> ;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">" p addr "</span> &lt;&lt; &amp;p &lt;&lt; <span class="string">" p val "</span> &lt;&lt; *p &lt;&lt; <span class="built_in">endl</span> ;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">" q addr "</span> &lt;&lt; &amp;q &lt;&lt; <span class="string">" q val "</span> &lt;&lt; *q &lt;&lt; <span class="built_in">endl</span> ;</div><div class="line"> </div><div class="line">  <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125; </div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> a addr 0x7fff5e968bb0 a val 1</div><div class="line"> p addr 0x7fff5e968b40 p val 1</div><div class="line"> q addr 0x7fff5e968b38 q val 1</div><div class="line"> a addr 0x7fff5e968bb0 a val 1</div><div class="line"> p addr 0x7fff5e968b40 p val 1</div><div class="line"> q addr 0x7fff5e968b38 q val 4</div><div class="line">*/</div></pre></td></tr></table></figure>
<p><code>pointer++</code> can be reviewed as a same type pointer in current pointer’s neighbor, then do a pointer assigment: </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span>* tmp_p = <span class="number">0x7fff5e744b30</span> ; </div><div class="line"><span class="keyword">int</span>* p1 = <span class="number">0x7fff5e744b28</span> ; </div><div class="line">p1 = tmp_p ;</div><div class="line">``` </div><div class="line"></div><div class="line">##<span class="meta"># int++</span></div><div class="line"></div><div class="line">```c++</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">  <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; nums ;</div><div class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">5</span>; i++)&#123;</div><div class="line">     nums.push_back(i);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">int</span> p=<span class="number">0</span>;</div><div class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"nums[p++] "</span> &lt;&lt; nums[p++] &lt;&lt; <span class="string">" p val "</span> &lt;&lt; p &lt;&lt; <span class="built_in">endl</span> ; </div><div class="line">  <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125; </div><div class="line"></div><div class="line"><span class="comment">/* nums[p++]: 0 p val:  1 */</span></div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="David Z.J. Lee" />
          <p class="site-author-name" itemprop="name">David Z.J. Lee</p>
           
              <p class="site-description motion-element" itemprop="description">what I don't know</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">178</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">47</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/ZJLi2013" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.linkedin.com/in/zhengjia13/" target="_blank" title="LinkedIn">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  LinkedIn
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">David Z.J. Lee</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://zjlee.disqus.com/count.js" async></script>
    

    

  




	





  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
