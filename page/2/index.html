<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="what I don&apos;t know">
<meta property="og:type" content="website">
<meta property="og:title" content="Serious Autonomous Vehicles">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="Serious Autonomous Vehicles">
<meta property="og:description" content="what I don&apos;t know">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Serious Autonomous Vehicles">
<meta name="twitter:description" content="what I don&apos;t know">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/"/>





  <title>Serious Autonomous Vehicles</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Serious Autonomous Vehicles</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/14/hypervisor-and-gpu-virtualization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/14/hypervisor-and-gpu-virtualization/" itemprop="url">hypervisor and gpu virtualization</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-14T00:18:55-04:00">
                2020-03-14
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/14/hypervisor-and-gpu-virtualization/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/03/14/hypervisor-and-gpu-virtualization/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="background"><a href="#background" class="headerlink" title="background"></a>background</h2><p>to build a private data center for ads training and SIL. a few concepts there:</p>
<h3 id="linux-remote-desktop"><a href="#linux-remote-desktop" class="headerlink" title="linux remote desktop"></a>linux remote desktop</h3><p>Linux GUI is based on x-protocol, which is kind of CPU based, during deploying gpu-based app in docker swarm, I have studied <a href="https://zjli2013.github.io/2019/11/29/X11-GUI-in-docker/" target="_blank" rel="external">xserver</a>, <code>ssh -X</code> channels give the way for visualization desktop and simple apps(e.g. glxgears) among xserver and xclient. while for really gpu-densive app, e.g. game rendering, machine learning, <code>ssh -X</code> can’t really use gpu resource well, which needs further support from device management mechanism from docker or k8s. </p>
<h3 id="virutal-machine-cloud-desktop"><a href="#virutal-machine-cloud-desktop" class="headerlink" title="virutal machine/ cloud desktop"></a>virutal machine/ cloud desktop</h3><p>VM is based on <a href="https://www.vmware.com/topics/glossary/content/hypervisor.html?SRC=WWW_US_GP_bare-metal-hypervisor_SiteLink" target="_blank" rel="external">hypervisor</a>, known as a virtual machine monitor(VMM), a type of virtualization software that supports the creation and management of VMs, hypervisor translate requests between the physical and virtual resources, making virtualization possible.</p>
<p>A hypervisor allows one host computer to support multiple guest VMs by virtually sharing its resources, like memory and processing. </p>
<p>Generally, there are two types of hypervisors. Type 1 hypervisors, called “bare metal,” run directly on the host’s hardware. Type 2 hypervisors, called “hosted,” run as a software layer on an operating system, like other computer programs, the most common e.g. vmware, citrix. </p>
<p>When a hypervisor is installed directly on the hardware of a physical machine, between the hardware and the operating system (OS), it is called a <a href="https://www.vmware.com/topics/glossary/content/bare-metal-hypervisor" target="_blank" rel="external">bare metal hypervisor</a>, which separates the OS from the underlying hardware, the software no longer relies on or is limited to specific hardware devices or drivers.</p>
<h3 id="VDI"><a href="#VDI" class="headerlink" title="VDI"></a>VDI</h3><p>a type of vm application is <a href="https://www.vmware.com/topics/glossary/content/virtual-desktop-infrastructure-vdi" target="_blank" rel="external">virtual desktop inftrastructure(vdi)</a>, VDI hosts desktop environments on a centralized server and deploys them to end-users on request. this process also known as <a href="https://www.vmware.com/topics/glossary/content/server-virtualization" target="_blank" rel="external">server virtualization</a></p>
<p>VDI is not necessarily requires a physical gpu, without a gpu, we can still run vmware, but the performance is poor. but for many other VM usage, beyond VDI, we still need ways to access GPU devices in VM.</p>
<h2 id="GPU-techs-in-VM"><a href="#GPU-techs-in-VM" class="headerlink" title="GPU techs in VM"></a>GPU techs in VM</h2><p>vwmare has an introduction about <a href="https://blogs.vmware.com/china/2017/11/09/horizon-7-中的-gpu-方案/" target="_blank" rel="external">gpu tech</a> in vm: </p>
<ul>
<li><p>software 3D. using software to mimic GPU calculating. all 3d calculating is done by CPU</p>
</li>
<li><p>vsga(vitual shared graphics acceleration), each virtual desktop has a vsga driver, which has a ESXi module, inside which has a GPU driver, which can call the physical gpu, but this shared mode is through Hypervisor</p>
</li>
</ul>
<p><img src="https://blogs.vmware.com/china/files/2017/11/vSGA.png" alt="image"></p>
<ul>
<li>vdga(virtual dedicated graphics accleration), or pass through mode, the physical GPU is assigned to a special virtual desktop for one user only.</li>
</ul>
<p><img src="http://blogs.vmware.com/china/files/2017/11/vDGA.png" alt="image"></p>
<ul>
<li>vgpu, split physical GPU to a few virtual-GPU, each virtual desk can have one vGPU.</li>
</ul>
<p><img src="http://blogs.vmware.com/china/files/2017/11/vGPU.png" alt="image"></p>
<h2 id="VM-vs-docker"><a href="#VM-vs-docker" class="headerlink" title="VM vs docker"></a>VM vs docker</h2><p>docker is a light-weight virtualization way, which  don’t need hypervisor, and the app in docker is access the host physical devices directly, making docker looks like a process, rather than a virtual OS; and scientfic computing apps run in VM is actually using the virtual CPU from hypervisor, which <a href="http://blog.itpub.net/35489/viewspace-2120397/" target="_blank" rel="external">bypass the cpu optimzation</a> used for math calcualting. so usually a physical machine can start hundres or thousands docker, but can only run a few VM.  </p>
<h2 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h2><p><a href="http://blog.sina.com.cn/s/blog_59cf67260100l5h4.html" target="_blank" rel="external">linux remote desktop</a></p>
<p><a href="https://blogs.gartner.com/gunnar-berger/understanding-virtual-desktop-vdi-gpu-technologies/" target="_blank" rel="external">understand vdi gpu tech</a></p>
<p><a href="https://blogs.vmware.com/apps/2018/09/using-gpus-with-virtual-machines-on-vsphere-part-3-installing-the-nvidia-grid-technology.html" target="_blank" rel="external">nvidia vgpu tech in vSphere</a></p>
<p><a href="https://www.brightcomputing.com/blog/setting-up-gpu-hypervisors-on-bright-openstack" target="_blank" rel="external">GPU hypervisors on OpenStack </a></p>
<p><a href="https://cumulusnetworks.com/blog/containers-vs-hypervisors/" target="_blank" rel="external">containers vs hypervisors</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/13/pure-c-c-pointer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/13/pure-c-c-pointer/" itemprop="url">pure c/c++ pointer</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-13T04:49:57-04:00">
                2020-03-13
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/13/pure-c-c-pointer/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/03/13/pure-c-c-pointer/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="pointer-assignment"><a href="#pointer-assignment" class="headerlink" title="pointer assignment"></a>pointer assignment</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">  <span class="keyword">int</span> a = <span class="number">10</span> ;</div><div class="line">  <span class="keyword">int</span> *pa = &amp;a ;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">"pa add "</span> &lt;&lt; &amp;pa &lt;&lt; <span class="string">"pa val "</span> &lt;&lt; *pa &lt;&lt; <span class="built_in">endl</span> ;</div><div class="line">  <span class="keyword">int</span> b = <span class="number">22</span>;</div><div class="line">  <span class="keyword">int</span> *pb = &amp;b ;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">"pb add "</span> &lt;&lt; &amp;pb &lt;&lt; <span class="string">"pb val "</span> &lt;&lt; *pb &lt;&lt; <span class="built_in">endl</span> ;</div><div class="line">  <span class="keyword">int</span> d = <span class="number">100</span> ;</div><div class="line">  <span class="keyword">int</span> *pd = &amp;d ;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">"pd add "</span> &lt;&lt; &amp;pd &lt;&lt; <span class="string">"pd val "</span> &lt;&lt; *pd &lt;&lt; <span class="built_in">endl</span> ;</div><div class="line">  <span class="keyword">int</span> *pc = pb ; <span class="comment">//pointer assignment </span></div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">"pc add "</span> &lt;&lt; &amp;pc &lt;&lt; <span class="string">"pc val "</span> &lt;&lt; *pc &lt;&lt; <span class="built_in">endl</span> ;</div><div class="line">  pb = pd ;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">"pb add "</span> &lt;&lt; &amp;pb &lt;&lt; <span class="string">"pb val "</span> &lt;&lt; *pb &lt;&lt; <span class="built_in">endl</span> ;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">"pd add "</span> &lt;&lt; &amp;pd &lt;&lt; <span class="string">"pd val "</span> &lt;&lt; *pd &lt;&lt; <span class="built_in">endl</span> ;</div><div class="line">  pd = pa ;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">"pd add "</span> &lt;&lt; &amp;pd &lt;&lt; <span class="string">"pd val "</span> &lt;&lt; *pd &lt;&lt; <span class="built_in">endl</span> ;</div><div class="line">  pa = pc ;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">"pa add "</span> &lt;&lt; &amp;pa &lt;&lt; <span class="string">"pa val "</span> &lt;&lt; *pa &lt;&lt; <span class="built_in">endl</span> ;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">"pc add "</span> &lt;&lt; &amp;pc &lt;&lt; <span class="string">"pc val "</span> &lt;&lt; *pc &lt;&lt; <span class="built_in">endl</span> ;</div><div class="line">  </div><div class="line">  <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125; </div><div class="line"></div><div class="line"><span class="comment">/* </span></div><div class="line">pb add 0x7fff5e744b30pb val 22</div><div class="line">pd add 0x7fff5e744b28pd val 100</div><div class="line">pc add 0x7fff5e744b20pc val 22</div><div class="line">pb add 0x7fff5e744b30pb val 100</div><div class="line">pd add 0x7fff5e744b28pd val 100</div><div class="line">pd add 0x7fff5e744b28pd val 10</div><div class="line">pa add 0x7fff5e744b40pa val 22</div><div class="line">pc add 0x7fff5e744b20pc val 22</div><div class="line">*/</div></pre></td></tr></table></figure>
<p>pointer assigment used a lot in linked list problems, the sample above is a pointer solution for <code>linked list reverse</code>. consider pointer as a container with an address to another object. pointer assignment, e.g. <code>pointerA = pointerB</code> only changes the content in the container. but the address of the container itself doesn’t change. and with  *(dereference) the pointer, we can see the content is changed. </p>
<p>further, taken <code>pc</code>, <code>pb</code>, <code>pd</code> as another example.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">pc = pb ;</div><div class="line">pb = pd;</div></pre></td></tr></table></figure></p>
<p>the first line will make container <code>pc</code> to store what is stored in container <code>pb</code>, in another word, the first line will make <code>pc</code> point to the address, which is stored in <code>pb</code>. </p>
<p>and the second line will then put what’s stored in container <code>pd</code> to container <code>pb</code>. </p>
<p>after this two updates, <code>pc</code> points to the original content in <code>pb</code>; <code>pb</code>  and <code>pd</code> points to the same content. obviously, what’s inside <code>pc</code> now, has nothing to do with pointer <code>pb</code>.  </p>
<h3 id="pointer-forward"><a href="#pointer-forward" class="headerlink" title="pointer++ forward"></a>pointer++ forward</h3><p>the basic scenario is as following, will <code>p2</code> move forward as well ? </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> *p1 = &amp;int_var ;</div><div class="line"><span class="keyword">int</span> *p2 = p1; </div><div class="line">p1++ ;</div></pre></td></tr></table></figure>
<p>we can see from the following <code>test.c</code>,  <code>p2</code> won’t move forward as <code>p1++</code>.  </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">  <span class="keyword">int</span> a[<span class="number">4</span>] = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span> &#125; ; </div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">" a addr "</span> &lt;&lt; &amp;a &lt;&lt; <span class="string">" a val "</span> &lt;&lt; *a &lt;&lt; <span class="built_in">endl</span> ;</div><div class="line">  <span class="keyword">int</span> *p = a ;</div><div class="line">  <span class="keyword">int</span> *q = p ;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">" p addr "</span> &lt;&lt; &amp;p &lt;&lt; <span class="string">" p val "</span> &lt;&lt; *p &lt;&lt; <span class="built_in">endl</span> ;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">" q addr "</span> &lt;&lt; &amp;q &lt;&lt; <span class="string">" q val "</span> &lt;&lt; *q &lt;&lt; <span class="built_in">endl</span> ;</div><div class="line"> </div><div class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">3</span>; i++)&#123;</div><div class="line">      q++;</div><div class="line">  &#125;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">" a addr "</span> &lt;&lt; &amp;a &lt;&lt; <span class="string">" a val "</span> &lt;&lt; *a &lt;&lt; <span class="built_in">endl</span> ;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">" p addr "</span> &lt;&lt; &amp;p &lt;&lt; <span class="string">" p val "</span> &lt;&lt; *p &lt;&lt; <span class="built_in">endl</span> ;</div><div class="line">  <span class="built_in">cout</span> &lt;&lt; <span class="string">" q addr "</span> &lt;&lt; &amp;q &lt;&lt; <span class="string">" q val "</span> &lt;&lt; *q &lt;&lt; <span class="built_in">endl</span> ;</div><div class="line"> </div><div class="line">  <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125; </div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> a addr 0x7fff5e968bb0 a val 1</div><div class="line"> p addr 0x7fff5e968b40 p val 1</div><div class="line"> q addr 0x7fff5e968b38 q val 1</div><div class="line"> a addr 0x7fff5e968bb0 a val 1</div><div class="line"> p addr 0x7fff5e968b40 p val 1</div><div class="line"> q addr 0x7fff5e968b38 q val 4</div><div class="line">*/</div></pre></td></tr></table></figure>
<p><code>pointer++</code> can be reviewed as a same type pointer in current pointer’s neighbor, then do a pointer assigment: </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span>* tmp_p = <span class="number">0x7fff5e744b30</span> ; </div><div class="line"><span class="keyword">int</span>* p1 = <span class="number">0x7fff5e744b28</span> ; </div><div class="line">p1 = tmp_p ;</div><div class="line">``` </div><div class="line"></div><div class="line">##<span class="meta"># int++</span></div><div class="line"></div><div class="line">```c++</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">  <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; nums ;</div><div class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">5</span>; i++)&#123;</div><div class="line">     nums.push_back(i);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">int</span> p=<span class="number">0</span>;</div><div class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"nums[p++] "</span> &lt;&lt; nums[p++] &lt;&lt; <span class="string">" p val "</span> &lt;&lt; p &lt;&lt; <span class="built_in">endl</span> ; </div><div class="line">  <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125; </div><div class="line"></div><div class="line"><span class="comment">/* nums[p++]: 0 p val:  1 */</span></div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/12/nodejs-introduction/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/12/nodejs-introduction/" itemprop="url">nodejs introduction</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-12T06:07:23-04:00">
                2020-03-12
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/12/nodejs-introduction/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/03/12/nodejs-introduction/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="callback-asnyc"><a href="#callback-asnyc" class="headerlink" title="callback / asnyc"></a>callback / asnyc</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>) ;</div><div class="line"></div><div class="line">fs.readFile(<span class="string">"input.txt"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>)</span>&#123;</div><div class="line">	<span class="keyword">if</span>(err) <span class="keyword">return</span> <span class="built_in">console</span>.error(err);</div><div class="line">	<span class="built_in">console</span>.log(data.toString());</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>the async fun take the callback fun as its last parameter. </p>
<h3 id="event-loop"><a href="#event-loop" class="headerlink" title="event loop"></a>event loop</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> events = <span class="built_in">require</span>(<span class="string">'events'</span>)</div><div class="line"><span class="keyword">var</span> emitter = <span class="keyword">new</span> events.EventEmitter();</div><div class="line"><span class="keyword">var</span> connectH = <span class="function"><span class="keyword">function</span> <span class="title">connected</span>(<span class="params"></span>)</span>&#123;</div><div class="line">		<span class="built_in">console</span>.log(<span class="string">"connected"</span>)</div><div class="line">		emitter.emit(<span class="string">'data_received'</span>); <span class="comment">// trig 'data_received'</span></div><div class="line">&#125;</div><div class="line">emitter.on(<span class="string">'connection'</span>, connectH);</div><div class="line">emitter.on(<span class="string">'data_received'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">		<span class="built_in">console</span>.log(<span class="string">'data received'</span>);</div><div class="line">&#125;)</div><div class="line">emitter.emit(<span class="string">'connection'</span>); <span class="comment">// trig 'connection'</span></div></pre></td></tr></table></figure>
<h3 id="event-emitter"><a href="#event-emitter" class="headerlink" title="event emitter"></a>event emitter</h3><p>when async IO is done, will send an event to the Event queue. e.g. when fs.readStream() open a file will trig an event. e.t.c</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">addListener(event, listener)</div><div class="line">on(event, listener) #listening</div><div class="line">emit(evnet, [arg1], ...)   #trig</div></pre></td></tr></table></figure>
<h3 id="file-system"><a href="#file-system" class="headerlink" title="file system"></a>file system</h3><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">var fs = require("fs")</div><div class="line">fs.open("input.log", "r+", function(err, fd)&#123;&#125;);</div><div class="line">fs.state("input.log", function(err, stats_info)&#123;&#125;);</div><div class="line">fs.readFile("input.log", function(err, data)&#123;</div><div class="line">		if(err)&#123;</div><div class="line">			return console.error(err);</div><div class="line">		&#125;</div><div class="line">		console.log(data.toString());</div><div class="line">&#125;);</div><div class="line">fs.writeFile("output.log", function(err)&#123;</div><div class="line">	if(err)&#123; return console.error(err);&#125;</div><div class="line">	console.log("write successfully")</div><div class="line">&#125;);</div><div class="line">fs.read(fd,buffer, [args..]) #read binary stream</div></pre></td></tr></table></figure>
<h3 id="buffer"><a href="#buffer" class="headerlink" title="buffer"></a>buffer</h3><p>as js language has only txt bytes data, to deal with binary data, introduce <code>Buffer</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Buffer.alloc(size)</div><div class="line">Buffer.from(buffer||array||string)</div><div class="line">Buffer.write()  #write to buffer</div><div class="line">buffer.toString() #read from buffer</div><div class="line">buffer.toJSON()</div></pre></td></tr></table></figure>
<h3 id="stream"><a href="#stream" class="headerlink" title="stream"></a>stream</h3><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">var fs=require("fs");</div><div class="line">var readerStream = fs.createReadstream("input.file")</div><div class="line">readerStream.on('data', function(chunk, err)&#123;&#125;)</div><div class="line">var writeStream = fs.createWriteStream("output.file")</div><div class="line">writeStream.on('finished', function()&#123;&#125;)</div><div class="line">readerStream.pipe(writeStream); #pipe from a reader stream to a writer stream</div></pre></td></tr></table></figure>
<h3 id="module-system"><a href="#module-system" class="headerlink" title="module system"></a>module system</h3><p>to enable different nodejs files can use each other, there is a module system, the module can be a nodejs file, or JSON, or compiled C/C++ code.</p>
<p>nodejs has <code>exports</code> and <code>require</code> used to export modules’ APIs to external usage, or access external APIs.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;</div><div class="line">exports.method = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;</div></pre></td></tr></table></figure>
<p>the first way export the object itself, the second way only export the certain method.</p>
<h3 id="Global-Object"><a href="#Global-Object" class="headerlink" title="Global Object"></a>Global Object</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">console</span>.log()</div><div class="line"><span class="built_in">console</span>.error()</div></pre></td></tr></table></figure>
<h3 id="common-modules"><a href="#common-modules" class="headerlink" title="common modules"></a>common modules</h3><ul>
<li>path </li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</div><div class="line">path.join(<span class="string">"/user/"</span>, <span class="string">"test1"</span>); </div><div class="line">path.dirname(p_);</div></pre></td></tr></table></figure>
<ul>
<li>http server </li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>);</div><div class="line">http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">request, response</span>)</span>&#123;</div><div class="line">	<span class="keyword">var</span> url_path = request.url ;</div><div class="line">	server(url_path, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>)</span>&#123;</div><div class="line">		<span class="keyword">if</span>(err)&#123;</div><div class="line">			<span class="built_in">console</span>.log(err);</div><div class="line">			response.writeHead(<span class="number">404</span>, <span class="string">"xx"</span>);</div><div class="line">		&#125;<span class="keyword">else</span>&#123;</div><div class="line">			response.writeHeead(<span class="number">200</span>, <span class="string">"yy"</span>);</div><div class="line">			response.write(data.toString());</div><div class="line">		&#125;</div><div class="line">		response.end();</div><div class="line">   &#125;);</div><div class="line">&#125;).listen(<span class="number">8080</span>);</div></pre></td></tr></table></figure>
<ul>
<li>http client </li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</div><div class="line">url = <span class="string">"http://localhost:8080/index.html"</span></div><div class="line"><span class="keyword">var</span> req = http.request(url, callback);</div><div class="line"><span class="keyword">var</span> callback = <span class="function"><span class="keyword">function</span>(<span class="params">response</span>)</span>&#123;</div><div class="line">   <span class="keyword">var</span> body = <span class="string">''</span> ;</div><div class="line">	response.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</div><div class="line">		body += data; </div><div class="line">	&#125;);</div><div class="line">	response.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">		<span class="built_in">console</span>.log(body);</div><div class="line">	&#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="Express"><a href="#Express" class="headerlink" title="Express"></a>Express</h3><p>Express has <code>requst</code> and <code>response</code> object to handle request and reponse. <code>express.static</code> can handle static resources, e.g. image, css e.t.c</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">"repress"</span>);</div><div class="line"><span class="keyword">var</span> app = express();</div><div class="line">app.use(<span class="string">'/public'</span>, express.static(<span class="string">'public'</span>));</div><div class="line">app.get(<span class="string">'/index'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;&#125;)</div><div class="line">app.get(<span class="string">'/user'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</div><div class="line">	<span class="keyword">var</span> response = &#123;</div><div class="line">		<span class="string">"name"</span>: req.query.name,</div><div class="line">		<span class="string">"id"</span>: req.query.id</div><div class="line">	&#125;;</div><div class="line">	res.send(<span class="built_in">JSON</span>.stringify(response));</div><div class="line">&#125;);</div><div class="line">app.post(<span class="string">'/user'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</div><div class="line">	<span class="keyword">var</span> response = &#123;</div><div class="line">		<span class="string">"name"</span> : req.body.name ;</div><div class="line">		<span class="string">"id"</span> : req.body.id </div><div class="line">	&#125;;</div><div class="line">	res.send(<span class="built_in">JSON</span>.stringify(response));</div><div class="line">&#125;); </div><div class="line">app.post(<span class="string">'file_upload'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</div><div class="line">	<span class="keyword">var</span> des_file = __dirname + <span class="string">"/"</span> + req.files[<span class="number">0</span>].originalname ;</div><div class="line">	fs.readFile(req.files[<span class="number">0</span>].path, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>)</span>&#123;</div><div class="line">		fs.writeFile(des_file, data, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</div><div class="line">			<span class="keyword">if</span>(err)&#123;<span class="built_in">console</span>.error(err);&#125;</div><div class="line">			<span class="keyword">else</span>&#123;</div><div class="line">				<span class="keyword">var</span> response = &#123;</div><div class="line">						<span class="attr">message</span>: <span class="string">"file uploaded successfully"</span> ,</div><div class="line">						<span class="attr">filename</span>: req.files[<span class="number">0</span>].originalname</div><div class="line">				&#125;;</div><div class="line">			&#125;</div><div class="line">			res.send(<span class="built_in">JSON</span>.stringify(response));</div><div class="line">		&#125;);</div><div class="line">	&#125;);</div><div class="line">&#125;)</div><div class="line"><span class="keyword">var</span> server = app.listen(<span class="number">8080</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;)</div></pre></td></tr></table></figure>
<p><code>res</code> is what send from server to client, for both <code>/get</code>, <code>/post</code> methods. <a href="https://www.tutorialspoint.com/nodejs/nodejs_request_object.htm" target="_blank" rel="external">req object</a> represents the HTTP request and has properties for the request query string, parameters, body, HTTP headers e.t.c</p>
<ul>
<li>req.body</li>
</ul>
<p>contains key-value pairs of data submitted in the request body. by default, it’s undefined, and is populated when using body-parsing middleware. e.g. <strong>body-parser</strong></p>
<ul>
<li>req.cookies</li>
</ul>
<p>when using cookie-parser middleware, this property is an object that contains cookies send by the request</p>
<ul>
<li>req.path </li>
</ul>
<p>contains the path part of the request url</p>
<ul>
<li>req.query </li>
</ul>
<p>an object containing a property for each query string parameter in the route</p>
<ul>
<li>req.route</li>
</ul>
<p>the current mathced route, a string </p>
<h2 id="data-access-object-DAO"><a href="#data-access-object-DAO" class="headerlink" title="data access object(DAO)"></a>data access object(DAO)</h2><p>Dao pattern is used to <a href="https://www.tutorialspoint.com/design_pattern/data_access_object_pattern.htm" target="_blank" rel="external">separate</a> low level data accessing API or operations form high level business services. usually there are three parts:</p>
<ul>
<li><p>DAO interface, which defines the standard operations to be performed on a model object </p>
</li>
<li><p>DAO class, the class that implement DAO interfaces, this class is responsible to get data from database, or other storage mechanism</p>
</li>
<li><p>model object, a simple POJO containing get/set methods to store data retrieved using DAO class</p>
</li>
</ul>
<p>o/r mapping (orm) is used a lot to map database itme to a special class, and it’s easy to use, but a little drawback of orm is it assume the database is <a href="https://www.open-open.com/lib/view/open1425277196118.html" target="_blank" rel="external">normalized well</a>. DAO is a middleware to do directly SQL mapping, who mapes SQL query language to the output class. </p>
<h3 id="separting-models-logic-and-daos"><a href="#separting-models-logic-and-daos" class="headerlink" title="separting models, logic and daos"></a>separting models, logic and daos</h3><ul>
<li><p>routes.js, where to put routes, usually referenced as <code>controllers</code></p>
</li>
<li><p>models.js, where to put functions talk to database, usually referenced as <code>dao layer</code></p>
</li>
<li><p>views.js</p>
</li>
</ul>
<p>these three components can put under <a href="https://github.com/csanz/node-expressjs-example" target="_blank" rel="external">app</a>;  all static data usually put under <code>public</code> folder; the Express <code>package.json</code> and <code>index.js</code> are at the same level as <code>app</code>.</p>
<h2 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h2><p><a href="https://www.runoob.com/nodejs/" target="_blank" rel="external">nodejs at runoob.com</a></p>
<p><a href="https://www.jianshu.com/p/dab01487a9df" target="_blank" rel="external">nodejs &amp; mysql</a></p>
<p><a href="https://www.open-open.com/lib/view/open1425277196118.html" target="_blank" rel="external">bearcat-dao introduction</a></p>
<p><a href="https://koajs.com" target="_blank" rel="external">koa</a></p>
<p><a href="https://github.com/paulmillr/chokidar" target="_blank" rel="external">chokidar</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/11/high-concurrent-ws-log-server/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/11/high-concurrent-ws-log-server/" itemprop="url">high concurrent ws log server</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-11T03:50:40-04:00">
                2020-03-11
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/11/high-concurrent-ws-log-server/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/03/11/high-concurrent-ws-log-server/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="backgroud"><a href="#backgroud" class="headerlink" title="backgroud"></a>backgroud</h2><p>previously, we designed <a href="https://zjli2013.github.io/2020/03/09/design-a-logger-from-ws-to-db" target="_blank" rel="external">a logger module from ws to db</a>/, this blog is one real implementation of the python solution.</p>
<h2 id="high-concurrent-ws-server-online"><a href="#high-concurrent-ws-server-online" class="headerlink" title="high concurrent ws server online"></a>high concurrent ws server online</h2><h4 id="single-server-with-multi-clients-a-simple-C"><a href="#single-server-with-multi-clients-a-simple-C" class="headerlink" title="single server with multi clients: a simple C++"></a><a href="https://www.codeproject.com/articles/7785/single-server-with-multiple-clients-a-simple-cplus" target="_blank" rel="external">single server with multi clients: a simple C++</a></h4><ul>
<li><p>the server is started first, and wait for the incoming client calls, periodically report its status: how many clients keep connected. meanwhile, once an incoming call is detected and accepted, the server will create a separate thread to handle this client. therefore, the server creates as many separate sessions as there are incoming clients. </p>
</li>
<li><p>how handle multiple clients? once an incoming client call is received and accepted, the main server thread will create a new thread, and pass the client connection to this thread</p>
</li>
<li><p>what if client threads need access some global variables? a semaphore instance ish helpful.</p>
</li>
</ul>
<h4 id="how-ws-server-handles-multiple-incomming-connections"><a href="#how-ws-server-handles-multiple-incomming-connections" class="headerlink" title="how ws server handles multiple incomming connections"></a><a href="https://stackoverflow.com/questions/28516962/how-websocket-server-handles-multiple-incoming-connection-requests" target="_blank" rel="external">how ws server handles multiple incomming connections</a></h4><ul>
<li><p>socket object is often thought to represent a connection, but not entirely true, since they can be active or passive.  a socket object in <strong>passive/listen</strong> mode is created by listen() for incoming connection requets. by definition, such a socket is not a connection, it just listen for conenction requets.</p>
</li>
<li><p><strong>accept()</strong> doesn’t change the state of the <strong>passive</strong> socket created by <strong>listen()</strong> previously, but it returns an <strong>active/connected</strong> socket, which represents a real conenction. after <strong>accept()</strong> has returned the connected socket object, it can be called again on the passive socket, and again and again. or known as <code>accept loop</code></p>
</li>
<li><p>But call <code>accept()</code> takes time, can’t it miss incoming conenction requests? it won’t, there is a queue of pending connection requests, it is handled automatically by TCP/IP stack of the OS. meaning, while <code>accept()</code> can only deal with incoming connection request <strong>one-by-one</strong>, no incoming request will be missed even when they are incoming at a high rate. </p>
</li>
</ul>
<h2 id="python-env-setup"><a href="#python-env-setup" class="headerlink" title="python env setup"></a>python env setup</h2><p><code>websockets</code> module requires python3.6, the python version in bare OS is 3.5, which gives:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">  File <span class="string">"/usr/lib/python3/dist-packages/websockets/compatibility.py"</span>, line <span class="number">8</span></div><div class="line">    asyncio_ensure_future = asyncio.<span class="keyword">async</span>           <span class="comment"># Python &lt; 3.5</span></div><div class="line">                                       ^</div><div class="line">SyntaxError: invalid syntaxß</div><div class="line">``` </div><div class="line"></div><div class="line">basically, [asyncio.<span class="keyword">async</span>](https://stackoverflow.com/questions/<span class="number">51292523</span>/why-does-asyncio-ensure-future-asyncio-<span class="keyword">async</span>-<span class="keyword">raise</span>-a-syntaxerror-invalid-synt) <span class="keyword">and</span> another depend module [discord.py](https://github.com/Rapptz/discord.py/issues/<span class="number">1396</span>), require python &lt; <span class="number">3.5</span>v, then gives another error:</div><div class="line"></div><div class="line">```python</div><div class="line">TypeError: unsupported operand type(s) <span class="keyword">for</span> -=: <span class="string">'Retry'</span> <span class="keyword">and</span> <span class="string">'int'</span></div></pre></td></tr></table></figure>
<p>the <a href="https://www.jianshu.com/p/b2d308c0311d" target="_blank" rel="external">Retry error</a> fixed by adding the following lines to <code>~/.pip/pip.conf</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[<span class="keyword">global</span>]</div><div class="line">index-url = https://pypi.tuna.tsinghua.edu.cn/simple</div><div class="line">``` </div><div class="line"><span class="keyword">in</span> a bare system <span class="keyword">with</span> pre-installed python3<span class="number">.5</span>, I did the following steps: </div><div class="line"></div><div class="line">```python</div><div class="line">sudo apt install software-properties-common</div><div class="line">sudo add-apt-repository ppa:deadsnakes/ppa</div><div class="line">sudo apt-get install python3<span class="number">.7</span> </div><div class="line">sudo update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3<span class="number">.7</span> <span class="number">2</span></div><div class="line">sudo apt-get install python3-websockets</div><div class="line">sudo apt-get install python3-websocket</div><div class="line">sudo apt-get install python3-sqlalchemy</div><div class="line">sudo pip3 install threadpool</div><div class="line">sudo apt-get remove --purge python3-websocket  <span class="comment">#based on python3.5</span></div><div class="line">sudo apt-get install python3-websocket  <span class="comment">#based on python3.7</span></div></pre></td></tr></table></figure>
<p>which gives another error:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">/var/lib/dpkg/info/python3-websocket.postinst: 6: /var/lib/dpkg/info/python3-websocket.postinst: py3compile: not found</div><div class="line">dpkg: error processing package python3-websocket (--configure):</div><div class="line"> subprocess installed post-installation script returned error exit status 127</div><div class="line">Errors were encountered while processing:</div><div class="line"> python3-websocket</div><div class="line">E: Sub-process /usr/bin/dpkg returned an error code (1)</div></pre></td></tr></table></figure>
<p>which then be <a href="https://askubuntu.com/questions/438345/how-to-remove-install-a-package-that-is-not-fully-installed" target="_blank" rel="external">fixed</a> by go to <code>/var/lib/dpkg/info/</code> and delete all <code>python3-websocket.*</code> files:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo rm /var/lib/dpkg/info/[package_name].*</div><div class="line">sudo dpkg --configure -a</div><div class="line">sudo apt-get update</div></pre></td></tr></table></figure>
<p>everything looks good, but still report: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ModuleNotFoundError: No module named &apos;websockets&apos;</div></pre></td></tr></table></figure>
<p><strong>Gave up setting up with the bare python</strong>, then create a new conda env, and ran the following settings inside, clean and simple: </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">pip install websockets</div><div class="line">pip install websocket-client  <span class="comment">#rather websocket</span></div><div class="line">pip install threadpool</div><div class="line">pip install sqlalchemy</div><div class="line">pip install psycopg2</div></pre></td></tr></table></figure>
<p>during remote test, if ws server down unexpected, need <a href="https://unix.stackexchange.com/questions/140021/how-to-close-ports-in-linux" target="_blank" rel="external">kill the ws pid</a>:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">sudo netstat -tlnp  #find the special running port and its pid </div><div class="line">kill $pid</div><div class="line">``` </div><div class="line">or `kill $(lsof -t -i:$port)`</div><div class="line"><span class="meta"></span></div><div class="line">#<span class="bash"><span class="comment"># websockets &amp; websocket-client</span></span></div><div class="line"></div><div class="line">the long-lived connection sample from [ws-client](https://github.com/websocket-client/websocket-client) is good base, as here need to test a high concurrent clients, we add `threadpool`:</div><div class="line"></div><div class="line">```python</div><div class="line">  def on_open(ws, num):</div><div class="line">      def run(*args): ##args</div><div class="line">          for i in range(3):</div><div class="line">              time.sleep(1)</div><div class="line">              message = "your_message"</div><div class="line">              ws.send(json.dumps(message))</div><div class="line">          time.sleep(1)</div><div class="line">          ws.close()</div><div class="line">          print("thread terminating...")</div><div class="line">      thread.start_new_thread(run, ())</div><div class="line"> </div><div class="line"> def on_start(num):</div><div class="line">      websocket.enableTrace(True)</div><div class="line">      ws = websocket.WebSocketApp("ws://localhost:8888/",</div><div class="line">                                on_message = on_message,</div><div class="line">                                on_error = on_error,</div><div class="line">                                on_close = on_close)</div><div class="line">      ws.on_open = on_open(ws, num)</div><div class="line">      ws.run_forever()</div><div class="line">  </div><div class="line">  def threadpool_test():</div><div class="line">      start_time = time.time()</div><div class="line">      pool = ThreadPool(100)</div><div class="line">      test = list()</div><div class="line">      for itr in range(100):</div><div class="line">          test.append(itr)</div><div class="line">      requests = makeRequests(on_start, test)</div><div class="line">      [pool.putRequest(req) for req in requests]</div><div class="line">      pool.wait()</div><div class="line">      print('%d second'% (time.time() - start_time))</div></pre></td></tr></table></figure>
<p>in <a href="">ws-client src</a>, we see: </p>
<ul>
<li><p>on_open: callable object which is called at opening websocket. this function has one argument. The argument is this class object. but all customized callback func can add more arguments, which is helpful.</p>
</li>
<li><p>on_message: callable object which is called when received data. on_message has 2 arguments. The 1st argument is this class object. the 2nd argument is utf-8 string which we get from the server.</p>
</li>
</ul>
<p>we can implement a simple <a href="">sqlalchemy orm</a> db-writer, and add to the ws-server:</p>
<pre><code class="python"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">process</span><span class="params">(self, websocket, path)</span>:</span>
     raw_ = <span class="keyword">await</span> websocket.recv()
     jdata = json.loads(raw_)
     orm_obj = orm_(jdata)
     <span class="keyword">try</span>:
         self.dbwriter_.write(orm_obj)
         print(jdata, <span class="string">"write to db successfully"</span>)
     <span class="keyword">except</span> Exception <span class="keyword">as</span> e:
         dbwriter_.rollback()
         print(e)

     greeting = <span class="string">"hello from server"</span>
     <span class="keyword">await</span> websocket.send(greeting)
     print(<span class="string">f"&gt; <span class="subst">{greeting}</span>"</span>)

 <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span>
     <span class="keyword">if</span> self.host <span class="keyword">and</span> self.port :
         start_server = websockets.serve(self.process, self.host, self.port)
     <span class="keyword">else</span>:
         start_server = websockets.serve(self.process, <span class="string">"localhost"</span>, <span class="number">8867</span>)
     asyncio.get_event_loop().run_until_complete(start_server)
     asyncio.get_event_loop().run_forever()
</code></pre>
<h2 id="in-summary"><a href="#in-summary" class="headerlink" title="in summary"></a>in summary</h2><p>in reality, each ws-client is integrated to one upper application, which generate messages/log, and send to ws-server, inside which write to db, due to <code>asyncio</code>, the performance is good so far. in future, we maybe need some buffer at ws-server. </p>
<h3 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h3><p><a href="https://mcguirev10.com/2019/01/15/simple-multi-client-websocket-server.html" target="_blank" rel="external">a simple multi-client ws server</a></p>
<p><a href="https://www.toptal.com/tornado/simple-python-websocket-server" target="_blank" rel="external">create a simple python sw server using Tornado</a></p>
<p><a href="https://websockets.readthedocs.io/en/stable/intro.html" target="_blank" rel="external">python: websockets</a></p>
<p><a href="https://docs.python.org/3/library/json.html" target="_blank" rel="external">python: json</a></p>
<p><a href="https://chrisarndt.de/projects/threadpool/api/" target="_blank" rel="external">python: threadpool</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/09/design-a-logger-from-ws-to-db/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/09/design-a-logger-from-ws-to-db/" itemprop="url">design a logger from ws to db</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-09T03:54:00-04:00">
                2020-03-09
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/09/design-a-logger-from-ws-to-db/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/03/09/design-a-logger-from-ws-to-db/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="background"><a href="#background" class="headerlink" title="background"></a>background</h2><p>for now, we had <a href="https://zjli2013.github.io/2020/03/05/design-a-nodejs-web-server-from-db-to-s3/" target="_blank" rel="external">design a file server from db to s3</a> and <a href="https://zjli2013.github.io/2020/03/07/asam-mdf-reader/" target="_blank" rel="external">mf reader</a> to feed data to the ads test module, which run in SIMD mode, e.g. k8s. for a closed-loop SIL, another component is how to record test message/outputs to database. </p>
<p>I am thinking firstly <a href="https://stackoverflow.com/questions/1066413/eventdriven-webframework-for-python" target="_blank" rel="external">event driven webframework python</a>, or <a href="https://github.com/quantmind/pulsar" target="_blank" rel="external">plusar</a>, which is a popular python event-driven project. as lgsvl pythonAPI is really a good choice to transfer message among server and clients. so the basic idea is to integrate websocket/tcp channel inside aeb model</p>
<h2 id="websocket-vs-tcp"><a href="#websocket-vs-tcp" class="headerlink" title="websocket vs tcp"></a>websocket vs tcp</h2><p>most ADAS models developed in OEM are matlab based, and the most common communication protocol in Matlab is <a href="https://www.mathworks.com/matlabcentral/fileexchange/345-tcp-udp-ip-toolbox-2-0-6" target="_blank" rel="external">UDP</a>, a little review about <a href="https://www.diffen.com/difference/TCP_vs_UDP" target="_blank" rel="external">tcp vs udp</a>, I personally don’t like udp, no reason. so narrow to <strong>TCP</strong>, the further question is:  should it be <a href="https://stackoverflow.com/questions/16945345/differences-between-tcp-sockets-and-web-sockets-one-more-time" target="_blank" rel="external">a raw TCP or Websocket</a>),  websocket enables a stream of messages instead of a stream of bytes. WebSockets is built on normal TCP sockets and uses frame headers that contains the size of each frame and indicate which frames are part of a message. The WebSocket API re-assembles the TCP chunks of data into frames which are assembled into messages before invoking the message event handler once per message. WebSocket is basically an application protocol (with reference to the ISO/OSI network stack), message-oriented, which makes use of TCP as transport layer. btw, TCP is bidirectional because it can send data in both directions, and it is full-duplex because it can do that simultaneously, without requiring line turnarounds, at the API level</p>
<p>for ADAS test outputs, it’s plain txt, I’d prefer <strong>websocket</strong>. so make the decision. </p>
<h3 id="matlab-websocket-client"><a href="#matlab-websocket-client" class="headerlink" title="matlab websocket client"></a>matlab websocket client</h3><p>there is an github project: <a href="https://github.com/jebej/MatlabWebSocket" target="_blank" rel="external">matlab websocket</a>, which is enough to implement a simple websocket in Matlab. <a href="https://stackoverflow.com/questions/20645774/can-matlab-talk-to-a-websocket" target="_blank" rel="external">discussion at stackoverflow</a></p>
<p>basically, here we bind a weboscket client to the adas model, in matlab. which is a good choice, so when runnign adas model in massively, the whole system looks like multi ws clients concurrently communicate with one ws server, which is well separated from adas model, and can freely implmented in either nodejs, python or c# e.t.c., totally friendly to other third-party data analysis tools in down-stream.</p>
<h2 id="multi-write-db-concurrently"><a href="#multi-write-db-concurrently" class="headerlink" title="multi-write db concurrently"></a>multi-write db concurrently</h2><p>once we get the message from ws clients, we need transfer all of them to a database, e.g. pySQL. but the first thing need to understand is <a href="https://stackoverflow.com/questions/32087233/how-does-mysql-handle-concurrent-inserts" target="_blank" rel="external">whether SQL can concurrent inserts</a>. if there are multiple INSERT statements, they are queued and performed in sequence, concurrently with the SELECT statements. SQL doesn’t support parallel data inserts into the same table, with InnoDB or MyISAM storage engine. </p>
<p>this also answered another question, why not directly adas model write to db, since the parallel runinng cases increase, writing DB will be the bottleneck. so has the websocket middle level, is a good choice. </p>
<h2 id="nodejs-solution"><a href="#nodejs-solution" class="headerlink" title="nodejs solution"></a>nodejs solution</h2><p>nodejs is really powerful to implement the solution above. basically, a <a href="https://www.npmjs.com/package/nodejs-websocket" target="_blank" rel="external">ws server</a> and <a href="https://github.com/mysqljs/mysql" target="_blank" rel="external">sql writer: mysqljs</a></p>
<h2 id="python-solution"><a href="#python-solution" class="headerlink" title="python solution"></a>python solution</h2><p>similar as nodejs, python has matured websocket module and ORM moduel to write db. </p>
<h3 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h3><p><a href="https://www.liaoxuefeng.com/wiki/897692888725344/923056653167136" target="_blank" rel="external">liaoxuefeng tcp</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/29150809" target="_blank" rel="external">zhihu mysql lock</a></p>
<p><a href="https://www.runoob.com/nodejs/nodejs-mysql.html" target="_blank" rel="external">nodejs connect mysql</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/07/asam-mdf-reader/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/07/asam-mdf-reader/" itemprop="url">asam mdf reader</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-07T02:40:17-05:00">
                2020-03-07
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/07/asam-mdf-reader/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/03/07/asam-mdf-reader/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://zjli2013.github.io/2020/02/24/mdf4-reader/" target="_blank" rel="external">previously</a> reviewed a few open source mdf readers as well as get basic concept about mdf. here is a working process with asammdf, which is step by step to understand this lib.</p>
<p>the basic problem here is to read a special signal data, not know its channel and group id.</p>
<h4 id="first-try"><a href="#first-try" class="headerlink" title="first try"></a>first try</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">reader = MDF4(file_name)</div><div class="line">data_dict = reader.info()</div><div class="line">print(<span class="string">"the total len of dict: "</span>, len(data_dict))</div><div class="line">print(data_dict.keys())</div><div class="line">block_ =  data_dict[<span class="string">'group 117'</span>]</div><div class="line">channel_metadata = reader.get_channel_metadata(<span class="string">'t'</span>, <span class="number">117</span>)</div><div class="line">channel117_comment = reader.get_channel_comment(<span class="string">'t'</span>, <span class="number">117</span>)</div><div class="line">channel117_name = reader.get_channel_name(<span class="number">117</span>, <span class="number">0</span>)</div><div class="line">pattern=<span class="string">"channel 123"</span></div><div class="line"><span class="keyword">for</span> key <span class="keyword">in</span> block_ :</div><div class="line">    r1 = re.search(pattern, str(block_[key]), re.M|re.I)</div><div class="line">    <span class="keyword">if</span> r1:</div><div class="line">       print(key)</div><div class="line"></div><div class="line">data_ = reader.get(<span class="string">"channel 123"</span>) <span class="comment">#doesn't work, as it reports can't find Channel</span></div><div class="line">data_ = reader.get(<span class="string">"fus_lidar_camera"</span>, <span class="string">"group 123"</span>) <span class="comment">#doesn't work, as it reports can't find the Group</span></div><div class="line">data_ = reader.get(<span class="string">"fus_lidar_camera"</span>) <span class="comment">#works</span></div></pre></td></tr></table></figure>
<p>so first, “channel 123” is actually not the name. and with the right name can reading data, but no guarantee which group this channel is from, and further can’t know is there additional groups has record this type of data.</p>
<h4 id="second-try"><a href="#second-try" class="headerlink" title="second try"></a>second try</h4><p>as mentioned <a href="https://asammdf.readthedocs.io/en/latest/api.html#mdf4" target="_blank" rel="external">mdf4 groups</a> have attributes, how about to access these <strong>attributes</strong>. so far, especially helpful attributes are:</p>
<ul>
<li><p>groups:list, list of data group dicts </p>
</li>
<li><p>channels_db:dict, used for fast channel access by name. for each name key the value is a list of (group index, channel index) tuples</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">channels = reader.groups[<span class="number">2</span>] <span class="comment">#with the same order as found in mdf, even with index 0, 1, ...</span></div><div class="line">print(<span class="string">"type of channels: "</span>, type(channels)) <span class="comment">#dict</span></div><div class="line"><span class="keyword">if</span> <span class="string">"fus.ObjData_Qm_TC.FusObj.i17.alpPiYawAngle"</span> <span class="keyword">in</span> channels:   print(channels[<span class="string">"fus.ObjData_Qm_TC.FusObj.i17.alpPiYawAngle"</span>].id) <span class="comment">#none</span></div><div class="line">print(<span class="string">" chanels type: "</span> , type(channels[<span class="string">"channels"</span>])) <span class="comment">#list </span></div><div class="line">print(<span class="string">" chanels len: "</span> , len(channels[<span class="string">"channels"</span>])) <span class="comment">#577</span></div><div class="line">print(<span class="string">"chanel_group type: "</span> , type(channels[<span class="string">"channel_group"</span>])) <span class="comment"># ChannelGroup object</span></div><div class="line">print(<span class="string">"chanel_group len: "</span> , len(channels[<span class="string">"channel_group"</span>])) <span class="comment">#17</span></div><div class="line">print(<span class="string">" data_group type: "</span> , type(channels[<span class="string">"data_group"</span>])) <span class="comment">#DataGroup object</span></div><div class="line">print(<span class="string">" data_group len: "</span> , len(channels[<span class="string">"data_group"</span>])) <span class="comment">#10</span></div></pre></td></tr></table></figure>
<p>which is far more less as expected, but give an good exploring about the reader’s attributes.</p>
<h4 id="third-try"><a href="#third-try" class="headerlink" title="third try"></a>third try</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">reader = MDF4(file_name)</div><div class="line">cdb = reader.channels_db</div><div class="line"><span class="comment">#print("size of c_db ", len(cdb))</span></div><div class="line"><span class="comment">#print("type of cdb ", type(cdb))</span></div><div class="line"></div><div class="line"><span class="comment">#for more sigles interested, please append to this list</span></div><div class="line">sig_list = [<span class="string">'sensor_1'</span>, <span class="string">'sensor_2'</span>, <span class="string">'sensor_3'</span>]</div><div class="line"></div><div class="line"><span class="keyword">for</span> sig <span class="keyword">in</span> sig_list:</div><div class="line">    <span class="keyword">if</span> sig <span class="keyword">in</span> cdb:</div><div class="line">        print(cdb[sig])</div><div class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> cdb[sig]:</div><div class="line">            (gid, cid) = item</div><div class="line">            alp = reader.get(sig, gid, cid)</div><div class="line">            print(<span class="string">"type of current sig "</span>, type(alp))</div><div class="line">            print(<span class="string">"size of current sig "</span>, len(alp))</div><div class="line">            <span class="comment">#alp is the raw sig data, here is only test print</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        print(sig, <span class="string">" is not in cdb"</span></div></pre></td></tr></table></figure>
<p>which gives me the right way to access the interested signals’ raw data. combing with <strong>s3 streaming body read</strong>, as mentioned in previous mdf-reader, which finally gives the powerful pipeline from reading mdf4 files from s3 storage to downside appilication</p>
<h3 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h3><p><a href="https://www.runoob.com/python3/python3-reg-expressions.html" target="_blank" rel="external">pyton reg</a></p>
<p><a href="https://techeplanet.com/python-string-contains/" target="_blank" rel="external">python substring</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/05/design-a-nodejs-web-server-from-db-to-s3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/05/design-a-nodejs-web-server-from-db-to-s3/" itemprop="url">design a nodejs web server from db to s3</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-05T02:00:38-05:00">
                2020-03-05
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/05/design-a-nodejs-web-server-from-db-to-s3/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/03/05/design-a-nodejs-web-server-from-db-to-s3/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="background"><a href="#background" class="headerlink" title="background"></a>background</h2><p>during ADS road test, there are Tb~Pb mount of data generated, e.g. sensor raw data(rosbag, mf4), images, point cloud e.t.c.  <a href="https://zjli2013.github.io/2020/02/28/ceph-boto3-intro/" target="_blank" rel="external">previous few blogs</a> are focusing on data storage. for a more robost and user-friendly data/file server, also need consider database and UI. </p>
<p>from the end-user/engineers viewpoint, a few basic functions are required: </p>
<ul>
<li>query certain features and view the data/files filtered</li>
<li>download a single/a batch of interested files (for further usage or analysis)</li>
<li>upload large mount of files quickly to storage (mostly by admin users)</li>
</ul>
<h2 id="a-FTP-server-to-support-s3"><a href="#a-FTP-server-to-support-s3" class="headerlink" title="a FTP server to support s3"></a>a FTP server to support s3</h2><p>traditionally, for many large size files to download, FTP is common used.  the prons and corns <a href="https://stackoverflow.com/questions/717200/comparing-http-and-ftp-for-transferring-files" target="_blank" rel="external">comparing fttp and ftp for transfering files</a>: HTTP is more responsive for request-response of small files, but FTP may be better for large files if tuned properly. but nowadays most prefer HTTP. doing search a little more, there are a lot discussions to connect amazon s3 to ftp server:</p>
<p><a href="https://stackoverflow.com/questions/58233979/need-to-copy-transfer-files-from-amazon-s3-storage-to-ftp-server" target="_blank" rel="external">transfer files from s3 storage to ftp server</a></p>
<p><a href="https://stackoverflow.com/questions/17126053/ftp-server-using-s3-as-storage" target="_blank" rel="external">FTP server using s3 as storage</a></p>
<p><a href="https://serverfault.com/questions/336827/using-amazon-s3-as-storage-for-attachments-in-a-web-mail-system" target="_blank" rel="external">using S3 as storage for attachments in a web-mail system</a></p>
<p><a href="https://stackoverflow.com/questions/23939179/ftp-sftp-access-to-an-amazon-s3-bucket?noredirect=1" target="_blank" rel="external">FTP/SFTP access to amazon s3 bucket</a></p>
<p>and there are popular ftp clients which support s3, e.g. <a href="https://winscp.net/eng/docs/guide_amazon_s3_sftp#managed" target="_blank" rel="external">winSCP</a>, <a href="https://cyberduck.io" target="_blank" rel="external">cyberduck</a>, of course, aws has it own <a href="(https://aws.amazon.com/sftp/?whats-new-cards.sort-by=item.additionalFields.postDateTime&amp;whats-new-cards.sort-order=desc">sftp client</a>, as well as <a href="https://s3browser.com" target="_blank" rel="external">aws s3 browser windows client</a>), more client tools check <a href="https://stackoverflow.com/questions/13096313/store-each-aws-s3-file-in-a-database-as-a-separate-row" target="_blank" rel="external">here</a></p>
<p>however, ftp can’t do metadata query. for some cases, e.g. resimulation of all stored scenarios, which makes no difference for each scenario, we can grab one by one and send it to resmiluator; but for many other cases, we need a certain pattern of data, rather than reading the whole storage, then a sql filter is much efficient and helpful. so a simple FTP is not enough in these cases.</p>
<h2 id="s3-objects-files-to-db"><a href="#s3-objects-files-to-db" class="headerlink" title="s3 objects/files to db"></a>s3 objects/files to db</h2><p>starting from a common bs framework, e.g. react-nodejs, and nodejs can talk to db as well.</p>
<p>** nodejs query buckets/object header info from s3 server, and update these metadata into db. </p>
<p>there is a great disscussion about <a href="https://stackoverflow.com/questions/3748/storing-images-in-db-yea-or-nay" target="_blank" rel="external">storing images in db - yea or nay</a>: when manage many TB of images/mdf files, storing file paths in db is the best solution: </p>
<ul>
<li>db storage is more expensive than file system storge</li>
<li>you can super-acc file system access: e.g.  os sendfile() system call to asynchronously send a file directly from fs to network interface, sql can’t</li>
<li>web server need no special coding to access images in fs</li>
<li>db win out where transactional integrity between image/file and its metadata are important, since it’s more complex to manage integrity between db metdata to fs data; and it’s difficult to guarantee data has been flushed to disk in the fs </li>
</ul>
<p>so for this file server, the metadata include <code>file-path-in-s3</code>, and other user interested items. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">file_id  feature     file_path</div><div class="line">  1          1       http://s3.aws.amazon.com/my-bucket/item1/img1a.jpg</div><div class="line">  2          2       http://s3.aws.amazon.com/my-bucket/item1/img1b.jpg</div><div class="line">  3          3       http://s3.aws.amazon.com/my-bucket/item2/img2a.jpg</div><div class="line">  4          4       http://s3.aws.amazon.com/my-bucket/item2/img2b.jpg</div></pre></td></tr></table></figure>
<p>** during browser user query/list request, nodejs talk to db, which is a normal bs case.</p>
<p>** when the browser user want to download a certain file, then nodejs parse the file metadata and talk to s3</p>
<h2 id="nodejs-to-s3"><a href="#nodejs-to-s3" class="headerlink" title="nodejs to s3"></a>nodejs to s3</h2><h4 id="nodejs-fs-readFile"><a href="#nodejs-fs-readFile" class="headerlink" title="nodejs fs.readFile()"></a>nodejs fs.readFile()</h4><p>taking an example from <a href="https://nodejs.org/api/fs.html" target="_blank" rel="external">official nodejs fs doc</a>: </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</div><div class="line">fs.readFileSync(pathname, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>)</span>&#123;</div><div class="line">	<span class="keyword">if</span>(err)&#123;</div><div class="line">		res.statusCode = <span class="number">500</span> ;</div><div class="line">		res.end(<span class="string">`Err getting file: $[err&#125;`</span>)</div><div class="line">	&#125;<span class="keyword">else</span>&#123;</div><div class="line">		res.end(data);</div><div class="line">	&#125;</div><div class="line">&#125;); </div><div class="line"></div><div class="line"><span class="keyword">const</span> fileUrl = <span class="keyword">new</span> URL(<span class="string">'file://tmp/mdf'</span>)</div><div class="line">fs.readFileSync(fileUrl);</div></pre></td></tr></table></figure>
<p>if not file directly, maybe <code>fs.Readstream</code> class is another good choice to read s3 streaming object. <code>fs.readFile()</code> and <code>fs.readFileSync()</code> both read full content of the file in memory before returning the data. <a href="https://nodejs.dev/reading-files-with-nodejs/" target="_blank" rel="external">which means</a>, the big files are going to have a major impact on your memory consumption adn speed of execution of the program. another choice is <a href="https://www.npmjs.com/package/fs-readfile-promise" target="_blank" rel="external">fs-readfile-promise</a>. </p>
<h4 id="express-res-download"><a href="#express-res-download" class="headerlink" title="express res.download"></a>express res.download</h4><p><code>res</code> object represent the HTTP response that an Express app sends when it gets an HTTP request. <a href="http://expressjs.com/en/api.html#res.download" target="_blank" rel="external">expressjs res.download</a> </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">res.downlaod(<span class="string">'/ads/basic.mf4'</span>, <span class="string">'as_basic.mf4'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</div><div class="line">	<span class="keyword">if</span>(err)&#123;</div><div class="line">		log(<span class="string">`download file error: <span class="subst">$&#123;err&#125;</span>`</span>)</div><div class="line">	&#125;<span class="keyword">else</span>&#123;</div><div class="line">		log(<span class="string">`download file successfully`</span>)</div><div class="line">	&#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h4 id="aws-sdk-for-nodejs"><a href="#aws-sdk-for-nodejs" class="headerlink" title="aws sdk for nodejs"></a>aws sdk for nodejs</h4><p>taking an <a href="https://github.com/aws-samples/aws-nodejs-sample/blob/master/sample.js" target="_blank" rel="external">example</a> from <a href="https://amazonaws-china.com/developers/getting-started/nodejs/" target="_blank" rel="external">aws sdk for js</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> aws = <span class="built_in">require</span>(<span class="string">'aws-sdk'</span>)</div><div class="line"><span class="keyword">var</span> s3 = <span class="keyword">new</span> aws.S3()</div><div class="line"></div><div class="line">s3.createBucket(&#123;<span class="attr">Bucket</span>: your_bucket_name, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">   <span class="keyword">var</span> params=&#123;<span class="attr">Bucket</span>: your_bucket_name, <span class="attr">Key</span>: your_key, <span class="attr">Body</span>: mf4.streaming&#125;;</div><div class="line">   s3.putObject(params, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>)</span>&#123;</div><div class="line">   		<span class="keyword">if</span>(err) <span class="built_in">console</span>.log(err)</div><div class="line">   		<span class="keyword">else</span> <span class="built_in">console</span>.log(<span class="string">"upload data to s3 succesffully"</span>)</div><div class="line">   	&#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>check <a href="">aws sdk for nodejs</a> api for more details. </p>
<h2 id="in-summary"><a href="#in-summary" class="headerlink" title="in summary"></a>in summary</h2><p>either a FTP server or a nodejs server, it depends on the upper usage cases.</p>
<ul>
<li><p>a single large-size(&gt;100mb) file(e.g. mf4, rosbag) download, nodejs with db is ok, as db helps to filter out the file first, and a few miniutes download is needed</p>
</li>
<li><p>many of little-size(~1mb) files(e.g. image, json) downlaod, nodejs is strong without doubt. </p>
</li>
<li><p>many of large-size files download/upload, a friendly UI is not necessary, comparing to the performance, then FTP may be the solution. </p>
</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/04/driving-scenarios-on-going/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/04/driving-scenarios-on-going/" itemprop="url">driving scenarios on-going</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-04T04:18:26-05:00">
                2020-03-04
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/04/driving-scenarios-on-going/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/03/04/driving-scenarios-on-going/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Euro-NCAP-driving-scenarios"><a href="#Euro-NCAP-driving-scenarios" class="headerlink" title="Euro NCAP driving scenarios"></a>Euro NCAP driving scenarios</h2><h3 id="Adaptive-Cruise-Control-ACC"><a href="#Adaptive-Cruise-Control-ACC" class="headerlink" title="Adaptive Cruise Control(ACC)"></a>Adaptive Cruise Control(ACC)</h3><p>ACC is tested in an extended version of AEB. these systems are designed to automatically adapt the speed when approaching a slower moving vehicle or noe that is braking. <strong>notification</strong>, not all systems perform well with stationary obstacles.</p>
<ul>
<li><p>a slow moving vehicle test</p>
</li>
<li><p>a stationary obstacle(e.g. vehicle) test</p>
</li>
</ul>
<h3 id="autonomous-emergency-braking-AEB"><a href="#autonomous-emergency-braking-AEB" class="headerlink" title="autonomous emergency braking(AEB)"></a>autonomous emergency braking(AEB)</h3><h4 id="AEB-pedestrain"><a href="#AEB-pedestrain" class="headerlink" title="AEB pedestrain"></a><a href="https://www.euroncap.com/en/vehicle-safety/the-ratings-explained/vulnerable-road-user-vru-protection/aeb-pedestrian/" target="_blank" rel="external">AEB pedestrain</a></h4><ul>
<li><p>an adult pedestrain running from the driver’s side of the vehicle </p>
</li>
<li><p>an adult walk from the passenger’s side</p>
</li>
<li><p>a child runs from between parked cars on the passenger’s side of the car</p>
</li>
<li><p>pedestrain walking in the same direction as the vehicle algnedwith the centre of vehicle </p>
</li>
<li><p>pedestrain walking in the same direction as the vehicle offset to one side</p>
</li>
</ul>
<h4 id="AEB-cyclist"><a href="#AEB-cyclist" class="headerlink" title="AEB cyclist"></a><a href="https://www.euroncap.com/en/vehicle-safety/the-ratings-explained/vulnerable-road-user-vru-protection/aeb-cyclist/" target="_blank" rel="external">AEB cyclist</a></h4><ul>
<li><p>cyclist is crossing the vehicle’s path </p>
</li>
<li><p>cyclist is travelling in the same direction </p>
</li>
</ul>
<p>Euro NCAP gives greatest reward if a collision is completely avoided; in some case, if AEB is unable to stop the vehicle completely, still give some points. </p>
<h3 id="lane-keeping-assist-LKA"><a href="#lane-keeping-assist-LKA" class="headerlink" title="lane keeping assist(LKA)"></a>lane keeping assist(LKA)</h3><ul>
<li><p>lane centering, a good ADS should continue to support the driver during the manoeuvre and will not resist the driver or deactivate.</p>
</li>
<li><p>cut-in test, a npc from adjacent lane merges into the current lane</p>
</li>
<li><p>cut-off test, a npc leaves the current lane abruptly to avoid a stopped vehicle ahead</p>
</li>
<li><p>swerve around a small obstacle test</p>
</li>
<li><p>speed assistance test, to use map data and/or data from sensors to identify the local speed limit </p>
</li>
</ul>
<h2 id="NHTSA-driving-scenarios"><a href="#NHTSA-driving-scenarios" class="headerlink" title="NHTSA driving scenarios"></a>NHTSA driving scenarios</h2><p>a previous blog <a href="">design scenarios in ADS simulation</a> is based on NHTSA. </p>
<h3 id="forward-collision-prevention"><a href="#forward-collision-prevention" class="headerlink" title="forward collision prevention"></a>forward collision prevention</h3><ul>
<li>Forward collision warning</li>
<li>AEB</li>
<li>pedestrain AEB</li>
<li>Adaptive lighting</li>
</ul>
<h3 id="backing-up-amp-parking"><a href="#backing-up-amp-parking" class="headerlink" title="backing up &amp; parking"></a>backing up &amp; parking</h3><ul>
<li>rear automatic braking </li>
<li>backup camera </li>
<li>rear cross traffic alert</li>
</ul>
<h3 id="lane-amp-side-assist"><a href="#lane-amp-side-assist" class="headerlink" title="lane &amp; side assist"></a>lane &amp; side assist</h3><ul>
<li>lane departure warning</li>
<li>lane keeping assist</li>
<li>blind spot detection</li>
<li>lane centering assist</li>
</ul>
<h3 id="maintaing-safe-distance"><a href="#maintaing-safe-distance" class="headerlink" title="maintaing safe distance"></a>maintaing safe distance</h3><ul>
<li>traffic jam assist</li>
<li>highway pilot</li>
<li>ACC </li>
</ul>
<h2 id="Matlab-Driving-Scenario-samples"><a href="#Matlab-Driving-Scenario-samples" class="headerlink" title="Matlab Driving Scenario samples"></a>Matlab Driving Scenario samples</h2><h3 id="AEB-for-vulnerable-road-users"><a href="#AEB-for-vulnerable-road-users" class="headerlink" title="AEB (for vulnerable road users)"></a>AEB (for vulnerable road users)</h3><ul>
<li><p><code>AEB_Bicyclist_Longitudinal_25width</code>, at collision time, the bicycle is 25% of the way across the width of the ego vehicle.</p>
</li>
<li><p><code>AEB_CCRb_2_initialGap_12m</code>, a car-to-car rear braking(CCRb) scenario where the ego rear hit a braking agent. the deceleration is 2 m/s^2 with initial gap 12m</p>
</li>
<li><p><code>AEB_CCRm_50overlap</code>, a car-to-car rear moving(CCRm) scenario, where the ego rear hits a moving vehicle. at collisio ntime, the ego overlaps with 50% of the width of the moving vehicle</p>
</li>
</ul>
<ul>
<li><code>AEB_CCRs_-75overlap</code>, a car-to-car stationary(CCRs) sceanrio, where the ego rear hits a stationary vehicle. at collision time, the ego overlaps with 75% of the width of the stationary vehicle. when the ego is to the left of the other vehicle, the percent overlap is negative</li>
</ul>
<ul>
<li><p><code>AEB_Pedestrain_Farside_50width</code>, the ego collides with a pedestrain who is traveling from the left side(far side, assuming vehicle drive on right side of the road). at collision time, the pedestrain is 50% of the way across the width of the ego</p>
</li>
<li><p><code>AEB_PedestrainChild_Nearside_50width</code>, the ego collides with a pedestrain who is traveling from the right side(near side), at collision time, the pedestrain is 50% of the way across the width of the ego</p>
</li>
</ul>
<h3 id="Emergency-Lane-Keeping-ELK"><a href="#Emergency-Lane-Keeping-ELK" class="headerlink" title="Emergency Lane Keeping(ELK)"></a>Emergency Lane Keeping(ELK)</h3><ul>
<li><p><code>ELK_FasterOvertakingVeh_Intent_Vlat_0.5</code>, ego intentionally changes lanes but collides with a faster overtaking vehicle, the ego travels at a lateral velocity of 0.5m/s</p>
</li>
<li><p><code>ELK_OncomingVeh_Vlat_0.3</code>, ego unintentionally changes lanes and collides with an oncoming vehicle, with ego’s lateral velocity of 0.3m/s</p>
</li>
<li><p><code>ELK_OvertakingVeh_Unintent_Vlat_0.3</code>, ego unintentionally changes lanes, overtake a vehicle in the other lane and collides. the ego travles at a lateral velocity at 0.3m/s</p>
</li>
<li><p><code>ELK_RoadEdge_NoBndry_Vlat_0.2</code>,  ego unintentionally changes lanes and ends up to hte road edge, with lateral velocity at 0.2m/s</p>
</li>
</ul>
<h3 id="LKA"><a href="#LKA" class="headerlink" title="LKA"></a>LKA</h3><ul>
<li><p><code>LKA_DashedLine_Solid_Left_Vlat_0.5</code></p>
</li>
<li><p><code>LKA_DashedLine_Unmarked_Right_Vlat_0.5</code></p>
</li>
<li><p><code>LKA_RoadEdge_NoBndry_Vlat_0.5</code></p>
</li>
<li><p><code>LKA_RoadEdge_NoMarkings_Vlat_0.5</code></p>
</li>
<li><p><code>LKA_SolidLine_Dashed_Left_Vlat_0.5</code></p>
</li>
<li><p><code>LKA_SolidLine_Unmarked_Right_Vlat_0.5</code></p>
</li>
</ul>
<h2 id="open-source-libs"><a href="#open-source-libs" class="headerlink" title="open source libs"></a>open source libs</h2><ul>
<li><p><a href="https://github.com/Microsoft/AutonomousDrivingCookbook" target="_blank" rel="external">Microsoft: autonomous driving cookbook</a></p>
</li>
<li><p><a href="https://github.com/ZhaobinMo/TrafficNet" target="_blank" rel="external">TrafficNet: an open scenario lib</a></p>
</li>
<li><p><a href="https://github.com/Toyota-ITC-SSD/Vehicle-Simulation-Toolkit" target="_blank" rel="external">Toyota: vehicle simulation unity toolkit</a></p>
</li>
<li><p><a href="https://github.com/mathworks" target="_blank" rel="external">mathworks: github</a></p>
</li>
<li><p><a href="https://drivingstereo-dataset.github.io" target="_blank" rel="external">sensetime: driving stero dataset</a></p>
</li>
<li><p><a href="https://opensimulationinterface.github.io/open-simulation-interface/" target="_blank" rel="external">google: open simulator interface</a></p>
</li>
<li><p><a href="https://ml4ad.github.io" target="_blank" rel="external">cmu: ml4ad</a></p>
</li>
</ul>
<h2 id="scenarios-in-L2-vs-L3"><a href="#scenarios-in-L2-vs-L3" class="headerlink" title="scenarios in L2 vs L3+"></a>scenarios in L2 vs L3+</h2><p>scenarios in l2 is more like point in the whole driving manuevor, at a certain scenario/point, how the ADAS system response. while L3+ is a continously scenario, along each point during driving is part of the scenario, and inside which all kinds of l2 case scenario can happen. it does make sense to integrate l2 scenario planning response to l3+, which makes l3+ system more strict. </p>
<h4 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h4><p><a href="https://www.euroncap.com/en/vehicle-safety/safety-campaigns/2018-automated-driving-tests/" target="_blank" rel="external">2018 Automated driving test</a></p>
<p><a href="https://www.mathworks.com/help/driving/ug/euro-ncap-driving-scenarios-in-driving-scenario-designer.html" target="_blank" rel="external">mathworks: Euro NCAP driving scenarios in driving scenario designer</a></p>
<p><a href="https://cdn.euroncap.com/media/30700/euroncap-roadmap-2025-v4.pdf" target="_blank" rel="external">Euro NCAP roadmap 2025</a></p>
<p><a href="https://www.nhtsa.gov/vehicle-safety-research" target="_blank" rel="external">nhtsa vehicle safety legacy doc</a></p>
<p><a href="https://www.nhtsa.gov/equipment/driver-assistance-technologies#forward-collision-prevention-30631" target="_blank" rel="external">NHTSA driver assitance tech</a></p>
<p><a href="https://silvamfpedro.github.io/thesis-blog/index.html" target="_blank" rel="external">Study and adaptation of the autonomous driving simulator CARLA for ATLASCAR2</a></p>
<p><a href="https://www.mobileye.com/responsibility-sensitive-safety/rss_on_nhtsa.pdf" target="_blank" rel="external">implementing RSS model on NHTSA pre-crash scenarios</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/03/boto3-streamingBody-to-BytesIO/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/03/boto3-streamingBody-to-BytesIO/" itemprop="url">boto3 streamingBody to BytesIO</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-03T03:58:34-05:00">
                2020-03-03
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/03/boto3-streamingBody-to-BytesIO/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/03/03/boto3-streamingBody-to-BytesIO/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="boto3-streamingBody-to-BytesIO"><a href="#boto3-streamingBody-to-BytesIO" class="headerlink" title="boto3 streamingBody to BytesIO"></a>boto3 streamingBody to BytesIO</h1><h3 id="boto3-class-into"><a href="#boto3-class-into" class="headerlink" title="boto3 class into"></a>boto3 class into</h3><ul>
<li>A <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/session.html" target="_blank" rel="external">Session</a> is about a particular configuration. a custom session: </li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">session = boto3.session.Session()</div><div class="line">ads = session.client(<span class="string">'ads'</span>)</div><div class="line">ads_s3 = session.resource(<span class="string">'s3'</span>)</div></pre></td></tr></table></figure>
<ul>
<li><a href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/resources.html" target="_blank" rel="external">Resources</a> is an object-oriented interface to AWS. Every resource instance has a number of attributes and methods. These can conceptually be split up into identifiers, attributes, actions, references, sub-resources, and collections.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">obj = ads_s3.Object(bucket_name=<span class="string">"boto3"</span>, key=<span class="string">"test.mdf"</span>)</div></pre></td></tr></table></figure>
<ul>
<li><a href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/s3.html" target="_blank" rel="external">Client</a> includes common APIs:</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">copy_object()</div><div class="line">delete_object()</div><div class="line">create_bucket()</div><div class="line">delete_bucket()</div><div class="line">delete_objects()</div><div class="line">download_file()</div><div class="line">download_fileobj()</div><div class="line">get_bucket_location()</div><div class="line">get_bucket_policy()</div><div class="line">get_object()</div><div class="line">head_bucket()</div><div class="line">head_object()</div><div class="line">list_buckets()</div><div class="line">list_objects()</div><div class="line">put_bucket_policy()</div><div class="line">put_object()</div><div class="line">upload_file()</div><div class="line">upload_fileobj()</div></pre></td></tr></table></figure>
<ul>
<li><p><a href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/s3.html#service-resource" target="_blank" rel="external">Service Resource</a> have bucket and object subresources, as well as related actions.</p>
</li>
<li><p><a href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/s3.html#bucket" target="_blank" rel="external">Bucket</a>, is an abstract resource representing a S3 bucket.</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">b = ads_s3.Bucket(<span class="string">'name'</span>)</div></pre></td></tr></table></figure>
<ul>
<li><a href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/s3.html#object" target="_blank" rel="external">Object</a>, is an abstract resource representing a S3 object.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">obj = ads_s3.Object(<span class="string">'bucket_name'</span>, <span class="string">'key'</span>)</div></pre></td></tr></table></figure>
<h3 id="read-s3-object-amp-pipeline-to-mdfreader"><a href="#read-s3-object-amp-pipeline-to-mdfreader" class="headerlink" title="read s3 object &amp; pipeline to mdfreader"></a>read s3 object &amp; pipeline to mdfreader</h3><p>there are a few try-and-outs. first is to streaming s3 object as BufferedReader, which give a file-like object, and can read(), but <code>BufferedReader</code> looks more like a IO streaming than a file, which can’t seek. </p>
<h4 id="botocore-response-StreamingBody-as-BufferedReader"><a href="#botocore-response-StreamingBody-as-BufferedReader" class="headerlink" title="botocore.response.StreamingBody as BufferedReader"></a>botocore.response.StreamingBody as BufferedReader</h4><p>the following discussion is really really helpful:<br><a href="https://github.com/boto/boto3/issues/426" target="_blank" rel="external">boto3 issue #426:  how to use botocore.response.StreamingBody as stdin PIPE</a></p>
<p>at the code of the StreamingBody and it seems to me that is is really a wrapper of a class inheriting from io.IOBase) but only the read method from the raw stream is exposed, so not really a file-like object. it would make a lot of sense to expose the io.IOBase interface in the StreamingBody as we could wrapped S3 objects into a io.BufferedReader or a io.TextIOWrapper.read() get a binary string .  the actual file-like object is found in the ._raw_stream attribute of the StreamingBody class</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> io</div><div class="line">buff_reader = io.BufferedReader(body._raw_stream)</div><div class="line">print(buff_reader)</div><div class="line"><span class="comment"># &lt;_io.BufferedReader&gt;</span></div></pre></td></tr></table></figure>
<p>wheras this <code>buff_reader</code> is not seekable, which makes <a href="">mdfreader</a> failure, due to its file operate needs  <code>seek()</code> method.</p>
<p><a href="https://stackoverflow.com/questions/39324151/stream-a-non-seekable-file-like-object-to-multiple-sinks" target="_blank" rel="external">steam a non-seekable file-like object</a></p>
<h4 id="stdio-stream-to-seekable-file-like-object"><a href="#stdio-stream-to-seekable-file-like-object" class="headerlink" title="stdio stream to seekable file-like object"></a>stdio stream to seekable file-like object</h4><p>so I am thinking to transfer the <code>BufferedReader</code> to a seekable file-like object. first, need to understand why it is not seekable. <code>BufferedRandom</code> is seekable, whereas BufferedReader and BufferedWriter <a href="https://github.com/python/cpython/pull/11216" target="_blank" rel="external">are not</a>. <a href="https://grokbase.com/t/python/python-dev/102j1y1dwn/buffered-streams-design-raw-io-gotchas" target="_blank" rel="external">Buffered streams design:</a> BufferedRandom is only suitable when the file is open for reading <strong>and</strong> writing. The ‘rb’ and ‘wb’ modes should return BufferedReader and BufferedWriter, respectively.</p>
<p>is it possbile to first  read() the content of BufferedReader to some memory, than transfer it to BufferedRandom? which gives me the try to BufferedReader.read(), which basicaly read all the binaries and store it in-memoryA, <strong>then good news:</strong> in-memory binary streams are also aviable as <a href="https://docs.python.org/3/library/io.html" target="_blank" rel="external">Bytesio</a> objects: </p>
<pre><code class="python">f = io.BytesIO(<span class="string">b"some in-memory binary data"</span>)
</code></pre>
<p>what if assign <code>BytesIO</code> to this in-memoryA. which really gives me a seekable object:</p>
<pre><code class="python">fid_ = io.BufferedReader(mf4_[<span class="string">'Body'</span>]._raw_stream) ;
read_in_memory = fid_.read()
bio_ = io.BytesIO(read_in_memory);
</code></pre>
<p>then <code>BytesIO</code> object pointer is much more file-like, to do read() and seek(). </p>
<h3 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h3><p><a href="https://boto3.amazonaws.com/v1/documentation/api/latest/index.html" target="_blank" rel="external">boto3 doc</a></p>
<p><a href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/s3.html#examples" target="_blank" rel="external">boto3 s3 api samples</a></p>
<p><a href="https://github.com/ERS-HCL/MDF4Wrapper" target="_blank" rel="external">mdf4wrapper</a></p>
<p><a href="https://bytes.com/topic/c/answers/649819-ifstream-file" target="_blank" rel="external">iftream to FILE</a></p>
<p><a href="https://stackoverflow.com/questions/20935404/what-is-the-concept-behind-file-pointer-or-the-stream-pointer" target="_blank" rel="external">what is the concept behind file pointer or stream pointer</a></p>
<p><a href="https://stackoverflow.com/questions/10199226/using-io-bufferedreader-on-a-stream-obtained-with-open" target="_blank" rel="external">using io.BufferedReader on a stream obtained with open</a></p>
<p><a href="https://www.devdungeon.com/content/working-binary-data-python" target="_blank" rel="external">working with binary data in python</a></p>
<p><a href="https://stackoverflow.com/questions/1035340/reading-binary-file-and-looping-over-each-byte" target="_blank" rel="external">read binary file and loop over each byte</a></p>
<p><a href="https://github.com/RaRe-Technologies/smart_open" target="_blank" rel="external">smart_open project</a></p>
<p><a href="https://www.python.org/dev/peps/pep-3116/" target="_blank" rel="external">PEP 3116 – New I/O</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/28/ceph-boto3-intro/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/28/ceph-boto3-intro/" itemprop="url">ceph & boto3 introduction</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-28T21:16:46-05:00">
                2020-02-28
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/02/28/ceph-boto3-intro/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/02/28/ceph-boto3-intro/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="ceph-intro"><a href="#ceph-intro" class="headerlink" title="ceph intro"></a>ceph intro</h2><p>A Ceph Storage Cluster requires at least one Ceph Monitor, Ceph Manager, and Ceph OSD (Object Storage Daemon)</p>
<h3 id="ceph-storage-cluster"><a href="#ceph-storage-cluster" class="headerlink" title="ceph storage cluster"></a>ceph storage cluster</h3><p>The Ceph File System, Ceph Object Storage and Ceph Block Devices read data from and write data to the Ceph Storage Cluster.</p>
<p><a href="https://docs.ceph.com/docs/master/rados/operations/" target="_blank" rel="external">cluster operations</a></p>
<p><a href="https://docs.ceph.com/docs/master/rados/operations/data-placement/" target="_blank" rel="external">data placement</a></p>
<ul>
<li><p>pools, which are logical groups for storing objects</p>
</li>
<li><p>Placement Groups(PG), PGs are fragments of a logical object pool</p>
</li>
<li><p>CRUSH maps, provide the physical topology of the cluster to the CRUSH algorithm to determine where the data for an object and its replicas should be stored, and how to do so across failure domains for added data safety among other things.</p>
</li>
<li><p>Balancer, a feature that will automatically optimize the distribution of PGs across devices to achieve a balanced data distribution</p>
</li>
</ul>
<h3 id="Librados-APIs-workflow"><a href="#Librados-APIs-workflow" class="headerlink" title="Librados APIs workflow"></a>Librados APIs workflow</h3><p>apis can interact with: Ceph monitor as well as OSD.</p>
<ul>
<li><a href="https://docs.ceph.com/docs/master/rados/api/librados-intro/" target="_blank" rel="external">get libs</a></li>
</ul>
<h4 id="configure-a-cluster-handling"><a href="#configure-a-cluster-handling" class="headerlink" title="configure a cluster handling"></a>configure a cluster handling</h4><ul>
<li>the client app must invoke <code>librados</code> and connected to a Ceph Monitor</li>
<li>librados retrieves the cluster map </li>
<li>when the client app wants to read or write data, it creates an I/O context and bind to a pool</li>
<li>with the I/O context, the client provides the object name to <code>librados</code>, for locating the data. </li>
<li>then the client application can read or write data</li>
</ul>
<p>Thus, the first steps in using the cluster from your app are to 1) create a cluster handle that your app will use to connect to the storage cluster, and then 2) use that handle to connect. To connect to the cluster, the app must supply a monitor address, a username and an authentication key (cephx is enabled by defaul</p>
<p>an easy way, in Ceph configuration file:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[global]</div><div class="line">mon host = 192.168.0.1</div><div class="line">keyring = /etc/ceph/ceph.client.admin.keyring</div></pre></td></tr></table></figure>
<p><img src="https://docs.ceph.com/docs/master/_images/ditaa-bd1070de50515485f116a874684956bc7e26c664.png" alt="image"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> rados</div><div class="line"></div><div class="line"><span class="keyword">try</span>:</div><div class="line">        cluster = rados.Rados(conffile=<span class="string">''</span>)</div><div class="line"><span class="keyword">except</span> TypeError <span class="keyword">as</span> e:</div><div class="line">        <span class="keyword">print</span> <span class="string">'Argument validation error: '</span>, e</div><div class="line">        <span class="keyword">raise</span> e</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"Created cluster handle."</span></div><div class="line"></div><div class="line"><span class="keyword">try</span>:</div><div class="line">        cluster.connect()</div><div class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">        <span class="keyword">print</span> <span class="string">"connection error: "</span>, e</div><div class="line">        <span class="keyword">raise</span> e</div><div class="line"><span class="keyword">finally</span>:</div><div class="line">        <span class="keyword">print</span> <span class="string">"Connected to the cluster."</span></div></pre></td></tr></table></figure>
<p>python api, has default <code>admin</code> as id, <code>ceph</code> as cluster name, and <code>ceph.conf</code> as confffile value</p>
<h4 id="creating-an-I-O-context"><a href="#creating-an-I-O-context" class="headerlink" title="creating an I/O context"></a>creating an I/O context</h4><p>RADOS enables you to interact both synchronously and asynchronously. Once your app has an I/O Context, read/write operations only require you to know the object/xattr name. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">print</span> <span class="string">"\n\nI/O Context and Object Operations"</span></div><div class="line"><span class="keyword">print</span> <span class="string">"================================="</span></div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"\nCreating a context for the 'data' pool"</span></div><div class="line"><span class="keyword">if</span> <span class="keyword">not</span> cluster.pool_exists(<span class="string">'data'</span>):</div><div class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">'No data pool exists'</span>)</div><div class="line">ioctx = cluster.open_ioctx(<span class="string">'data'</span>)</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"\nWriting object 'hw' with contents 'Hello World!' to pool 'data'."</span></div><div class="line">ioctx.write(<span class="string">"hw"</span>, <span class="string">"Hello World!"</span>)</div><div class="line"><span class="keyword">print</span> <span class="string">"Writing XATTR 'lang' with value 'en_US' to object 'hw'"</span></div><div class="line">ioctx.set_xattr(<span class="string">"hw"</span>, <span class="string">"lang"</span>, <span class="string">"en_US"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"\nWriting object 'bm' with contents 'Bonjour tout le monde!' to pool 'data'."</span></div><div class="line">ioctx.write(<span class="string">"bm"</span>, <span class="string">"Bonjour tout le monde!"</span>)</div><div class="line"><span class="keyword">print</span> <span class="string">"Writing XATTR 'lang' with value 'fr_FR' to object 'bm'"</span></div><div class="line">ioctx.set_xattr(<span class="string">"bm"</span>, <span class="string">"lang"</span>, <span class="string">"fr_FR"</span>)</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"\nContents of object 'hw'\n------------------------"</span></div><div class="line"><span class="keyword">print</span> ioctx.read(<span class="string">"hw"</span>)</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"\n\nGetting XATTR 'lang' from object 'hw'"</span></div><div class="line"><span class="keyword">print</span> ioctx.get_xattr(<span class="string">"hw"</span>, <span class="string">"lang"</span>)</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"\nContents of object 'bm'\n------------------------"</span></div><div class="line"><span class="keyword">print</span> ioctx.read(<span class="string">"bm"</span>)</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"Getting XATTR 'lang' from object 'bm'"</span></div><div class="line"><span class="keyword">print</span> ioctx.get_xattr(<span class="string">"bm"</span>, <span class="string">"lang"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"\nRemoving object 'hw'"</span></div><div class="line">ioctx.remove_object(<span class="string">"hw"</span>)</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"Removing object 'bm'"</span></div><div class="line">ioctx.remove_object(<span class="string">"bm"</span>)</div></pre></td></tr></table></figure>
<h4 id="closing-sessions"><a href="#closing-sessions" class="headerlink" title="closing sessions"></a>closing sessions</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">print</span> <span class="string">"\nClosing the connection."</span></div><div class="line">ioctx.close()</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"Shutting down the handle."</span></div><div class="line">cluster.shutdown()</div></pre></td></tr></table></figure>
<h3 id="librados-in-Python"><a href="#librados-in-Python" class="headerlink" title="librados in Python"></a><a href="https://docs.ceph.com/docs/master/rados/api/python/" target="_blank" rel="external">librados in Python</a></h3><h4 id="data-level-operations"><a href="#data-level-operations" class="headerlink" title="data level operations"></a>data level operations</h4><ul>
<li>configure a cluster handle</li>
</ul>
<p>To connect to the Ceph Storage Cluster, your application needs to know where to find the Ceph Monitor. Provide this information to your application by specifying the path to your Ceph configuration file, which contains the location of the initial Ceph monitors.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> rados, sys</div><div class="line">cluster = rados.Rados(conffile=<span class="string">'ceph.conf'</span>)</div></pre></td></tr></table></figure>
<ul>
<li>connect to the cluster </li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">cluster.connect()</div><div class="line"><span class="keyword">print</span> <span class="string">"\nCluster ID: "</span> + cluster.get_fsid()</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"\n\nCluster Statistics"</span></div><div class="line"><span class="keyword">print</span> <span class="string">"=================="</span></div><div class="line">cluster_stats = cluster.get_cluster_stats()</div><div class="line"></div><div class="line"><span class="keyword">for</span> key, value <span class="keyword">in</span> cluster_stats.iteritems():</div><div class="line">        <span class="keyword">print</span> key, value</div></pre></td></tr></table></figure>
<ul>
<li>manage pools </li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">cluster.create_pool(<span class="string">'test'</span>)</div><div class="line">pools = cluster.list_pools()</div><div class="line"><span class="keyword">for</span> pool <span class="keyword">in</span> pools:</div><div class="line">        <span class="keyword">print</span> pool</div><div class="line">cluster.delete_pool(<span class="string">'test'</span>)</div></pre></td></tr></table></figure>
<ul>
<li>I/O context </li>
</ul>
<p>to read from or write to Ceph Storage cluster, requires ioctx.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ioctx = cluster.open_ioctx($ioctx_name)</div><div class="line"><span class="comment">#</span></div><div class="line">ioctx = cluster.open_ioctx2($pool_id)</div></pre></td></tr></table></figure>
<p><code>ioctx_name</code> is the name of the pool, <code>pool_id</code> is the ID of the pool</p>
<ul>
<li>read, write, remove objects </li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ioctx.write_full(<span class="string">"hw"</span>, <span class="string">"hello"</span>)</div><div class="line">ioctx.read(<span class="string">"hw"</span>)</div><div class="line">ioctx.remove_object(<span class="string">"hw"</span>)</div></pre></td></tr></table></figure>
<ul>
<li>with extended attris</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">ioctx.set_xattr(<span class="string">"hw"</span>, <span class="string">"lang"</span> <span class="string">"en_US"</span>)</div><div class="line">ioctx.get_xattr(<span class="string">"hw"</span>, <span class="string">"lang"</span>)</div><div class="line"></div><div class="line">``` </div><div class="line"></div><div class="line">* list objs </div><div class="line"></div><div class="line">```python </div><div class="line"></div><div class="line">obj_itr = ioctx.list_objects()</div><div class="line"></div><div class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">	<span class="keyword">try</span>:</div><div class="line">		rados_obj = obj_itr.next()</div><div class="line">		print(rados_obj.read())</div></pre></td></tr></table></figure>
<h4 id="RADOS-S3-api"><a href="#RADOS-S3-api" class="headerlink" title="RADOS S3 api"></a>RADOS S3 api</h4><p>Ceph supports <a href="https://docs.ceph.com/docs/dumpling/radosgw/s3/" target="_blank" rel="external">RESTful API</a> that is compatible with basic data access model of Amazon S3 api.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">PUT /&#123;bucket&#125;/&#123;object&#125; HTTP/1.1</div><div class="line">DELETE /&#123;bucket&#125;/&#123;object&#125; HTTP/1.1</div><div class="line">GET /&#123;bucket&#125;/&#123;object&#125; HTTP/1.1</div><div class="line">HEAD /&#123;bucket&#125;/&#123;object&#125; HTTP/1.1  //get object info </div><div class="line">GET /&#123;bucket&#125;/&#123;object&#125;?acl HTTP/1.1</div></pre></td></tr></table></figure>
<h2 id="Amazon-S3"><a href="#Amazon-S3" class="headerlink" title="Amazon S3"></a>Amazon S3</h2><p>Simple Storage Serivce(s3) is used as file/object storage system to store and share files across Internet. it can store any type of objects, with simple key-value. elastic computing cluster(ec2) is Amazon’s computing service. there are three class in S3: servivce, bucket, object.</p>
<p>there are two ways to access S3, through SDK(boto), or raw  Restful API(GET, PUT). the following is SDK way.</p>
<h4 id="create-a-bucket"><a href="#create-a-bucket" class="headerlink" title="create a bucket"></a>create a bucket</h4><p>Put(), Get(), return all objects in the bucket. <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/s3-example-creating-buckets.html" target="_blank" rel="external">Bucket</a> is a storage location to hold files(objects). </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_bucket</span><span class="params">(bucket_name, region=None)</span>:</span></div><div class="line">	<span class="keyword">try</span>:</div><div class="line">		<span class="keyword">if</span> region <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">			s3_client = boto3.client(<span class="string">'s3'</span>)</div><div class="line">			s3.client.create_bucket(Bucket=bucket_name)</div><div class="line">		<span class="keyword">else</span>:</div><div class="line">            s3_client = boto3.client(<span class="string">'s3'</span>, region_name=region)</div><div class="line">            location = &#123;<span class="string">'LocationConstraint'</span>: region&#125;</div><div class="line">            s3_client.create_bucket(Bucket=bucket_name,</div><div class="line">            CreateBucketConfiguration=location)</div><div class="line">    <span class="keyword">except</span> ClientError <span class="keyword">as</span> e:</div><div class="line">        logging.error(e)</div><div class="line">        <span class="keyword">return</span> <span class="keyword">False</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">True</span>			</div><div class="line"></div><div class="line">response = s3_client.list_buckets()</div><div class="line"><span class="keyword">for</span> bucket <span class="keyword">in</span> response[<span class="string">'Buckets'</span>]:</div><div class="line">	<span class="keyword">print</span> bucket</div></pre></td></tr></table></figure>
<h4 id="upload-files"><a href="#upload-files" class="headerlink" title="upload files"></a>upload files</h4><p>basically to <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/s3-uploading-files.html" target="_blank" rel="external">upload a file</a> to an S3 bucket. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_file</span><span class="params">(file_name, bucket, object_name=None)</span>:</span></div><div class="line">    <span class="keyword">if</span> object_name <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">        object_name = file_name</div><div class="line"></div><div class="line">    <span class="comment"># Upload the file</span></div><div class="line">    s3_client = boto3.client(<span class="string">'s3'</span>)</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        response = s3_client.upload_file(file_name, bucket, object_name)</div><div class="line">    <span class="keyword">except</span> ClientError <span class="keyword">as</span> e:</div><div class="line">        logging.error(e)</div><div class="line">        <span class="keyword">return</span> <span class="keyword">False</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">True</span></div></pre></td></tr></table></figure>
<p><code>upload_file()</code> handles large files by splitting them into smaller chunks and uploading each chunk in parallel. which is same logic as ceph to hide the lower-level detail of data splitting and transfering.</p>
<p><code>upload_fileobj()</code> accepts a readable file-like object, which should be openedin bin mode, not text mode:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">s3 = boto3.client(<span class="string">'s3'</span>)</div><div class="line"><span class="keyword">with</span> open(<span class="string">"FILE_NAME"</span>, <span class="string">"rb"</span>) <span class="keyword">as</span> f:</div><div class="line">    s3.upload_fileobj(f, <span class="string">"BUCKET_NAME"</span>, <span class="string">"OBJECT_NAME"</span>)</div></pre></td></tr></table></figure>
<p>all <code>Client</code>, <code>Bucket</code> and <code>Object</code> have these two methods. </p>
<h4 id="download-files"><a href="#download-files" class="headerlink" title="download files"></a>download files</h4><p><a href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/s3-example-download-file.html" target="_blank" rel="external">download_file()</a> a pair of upload files method, which accepts the names of bucket and object to download, and the filename to save the downloaded file to.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">s3 = boto3.client(<span class="string">'s3'</span>)</div><div class="line">s3.download_file(<span class="string">'BUCKET_NAME'</span>, <span class="string">'OBJECT_NAME'</span>, <span class="string">'FILE_NAME'</span>)</div></pre></td></tr></table></figure>
<p>same as upload file, there is a read-only open method: <code>download_fileobj()</code>.</p>
<h4 id="bucket-policy"><a href="#bucket-policy" class="headerlink" title="bucket policy"></a>bucket policy</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">s3 = boto3.client(<span class="string">'s3'</span>)</div><div class="line">result = s3.get_bucket_policy(Bucket=<span class="string">'BUCKET_NAME'</span>)</div><div class="line">bucket_policy = json.dumps(bucket_policy)</div><div class="line">s3.put_bucket_policy(Bucket=bucket_name, Policy=bucket_policy)</div><div class="line">s3.delete_bucket_policy(Bucket=<span class="string">'BUCKET_NAME'</span>)</div><div class="line">control_list = s3.get_bucket_acl(Bucket=<span class="string">'BUCKEET_NAME'</span>)</div></pre></td></tr></table></figure>
<h4 id="get-objects"><a href="#get-objects" class="headerlink" title="get objects"></a>get objects</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">obj_list = s3.list_objects(Bucket=<span class="string">'bucket_name'</span>)</div><div class="line">obj_cont = s3.get_object(Bucket=<span class="string">'bucket_name'</span>, Key=<span class="string">'file_key'</span>)</div></pre></td></tr></table></figure>
<p>error: botocore.errorfactory.NoSuchKey: An error occurred (NoSuchKey) when calling the GetObject operation: Unknown</p>
<h4 id="read-objects-through-url-restful-api"><a href="#read-objects-through-url-restful-api" class="headerlink" title="read objects through url (restful api)"></a>read objects through url (restful api)</h4><p>through url path to get a file/object: <code>https://&lt;bucket-name&gt;.s3.amazonaws.com/&lt;key&gt;</code></p>
<h4 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h4><p><a href="https://docs.ceph.com/docs/master/start/intro/" target="_blank" rel="external">ceph official doc</a></p>
<p><a href="https://botocore.amazonaws.com/v1/documentation/api/latest/index.html" target="_blank" rel="external">botocore official doc</a></p>
<p><a href="https://github.com/boto/boto3" target="_blank" rel="external">boto3 github</a></p>
<p><a href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/s3-examples.html" target="_blank" rel="external">amazon S3 example</a></p>
<p><a href="https://www.howtoforge.com/how-to-create-an-s3-bucket-object-storage-on-amazon-aws/" target="_blank" rel="external">GUI: create an S3 bucket and store objects in AWS</a></p>
<p><a href="https://www.cnblogs.com/junneyang/p/5980286.html" target="_blank" rel="external">boto API access S3 object</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="David Z.J. Lee" />
          <p class="site-author-name" itemprop="name">David Z.J. Lee</p>
           
              <p class="site-description motion-element" itemprop="description">what I don't know</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">170</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">46</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/ZJLi2013" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.linkedin.com/in/zhengjia13/" target="_blank" title="LinkedIn">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  LinkedIn
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">David Z.J. Lee</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://zjlee.disqus.com/count.js" async></script>
    

    

  




	





  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
