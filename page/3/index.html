<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="what I don&apos;t know">
<meta property="og:type" content="website">
<meta property="og:title" content="Serious Autonomous Vehicles">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="Serious Autonomous Vehicles">
<meta property="og:description" content="what I don&apos;t know">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Serious Autonomous Vehicles">
<meta name="twitter:description" content="what I don&apos;t know">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/3/"/>





  <title>Serious Autonomous Vehicles</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Serious Autonomous Vehicles</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/25/from-HPC-to-cloud-computing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/25/from-HPC-to-cloud-computing/" itemprop="url">from HPC to cloud computing</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-25T03:13:09-05:00">
                2020-02-25
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/02/25/from-HPC-to-cloud-computing/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/02/25/from-HPC-to-cloud-computing/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="HPC"><a href="#HPC" class="headerlink" title="HPC"></a>HPC</h3><p><a href="https://www.ansys.com/products/platform/ansys-cloud" target="_blank" rel="external">Ansys HPC</a>, <a href="https://www.designworldonline.com/cae-on-the-cloud/" target="_blank" rel="external">OpenFoam in amazon EC2</a>, <a href="https://www.rescale.com" target="_blank" rel="external">rescale</a>, these are some samples of current CAE applications in HPC cloud.</p>
<p>most CAE simulations, in nut, are solving large sparse matrix, either optmization or differential, which depends on famous linear equations solvers/libs, e.g. Petsc, libMesh, Intel Math Kernel e.t.c, inside which are implemented with message passing interface(MPI), share memory, or similar techs. </p>
<p>why MPI is a have-to in these applications? because the problem  interested itself is so huge, which is so much computing heavily than windows office, WeChat. </p>
<p>as engineers want the result more preciesly, the problem interested dimension will increase more. e.g. a normal static stress analysis of vehicle engine is about 6 million elements, each of which will take  6 ~ 12 vertexes, and each vertex has 6 DoF, which gives about <strong>a kinematic matrix with size about 200 million x 200 million</strong>, no single PC can store this much data, and not even to do the matrix computing then.</p>
<p>so all these problems have to be running on super computers, or high-performance computer(HPC), which have more memory or CPU cores. beyond large memory and CPU cores, also need fast-speed network, as each CPU can do calculation really fast, 2 ~ 4 GHz, so if the system can’t feed data that fast, the CPUs are hungry, which is the third feature of HPC: Gb high-speed internal network.</p>
<p>as the <strong>NUMA/multi-core CPU architecture</strong> is popular now, to achieve the best performance from these chips is also a hot topic. </p>
<h3 id="cloud"><a href="#cloud" class="headerlink" title="cloud"></a>cloud</h3><p>if taken HPC as centerlized memory and CPU cores(<strong>the Cathedral</strong>), then cloud is about distributed memory and CPU cores(<strong>the Bazaar</strong>). cloud is more Internet, to connected weak-power nodes anywhere, but totally has great power. the applications in cloud must be easy to decomposed in small pieces, so each weak-power node can handle a little bit. when coming to cloud computing, I’d think about Hadoop, OpenStack, and docker.</p>
<p>hadoop is about to analysis massive data, which is heavily used in e-commercial, social network, games. docker is the way to package small application and each of the small image can run smoothly in one node, which currently is call <strong>micro-serivce</strong>, which is exactly as the name said, MICRO. OpenStack take care virtualization layer from physical memory, cpu resources, which used about in public cloud, or virtual office env.</p>
<h3 id="A-or-B"><a href="#A-or-B" class="headerlink" title="A or B"></a>A or B</h3><p>cloud is more about <strong>DevOps</strong>, as each piece of work is not difference from the single PC, but how to deploy and manage a single piece of work in a large cloud is the key, so develop and operations together. compare to HPC, both develop and operation needs professions.</p>
<p>cloud computing has extended to edge computing, which is more close to normal daily life, and more bussiness-valued; while HPC guys are more like scientist, who do weather forcast, rocket science, molecular dynamics e.t.c.</p>
<p>finally, the tech itself, cloud or HPC, has nothing to do with the bussiness world. </p>
<h3 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h3><p><a href="http://cloudscaling.com/blog/cloud-computing/grid-cloud-hpc-whats-the-diff/" target="_blank" rel="external">cloudscaling: grid, hpc, cloud… what’s the difference</a></p>
<p><a href="https://www.linkedin.com/pulse/supercomputing-vs-cloud-computing-david-stepania/" target="_blank" rel="external">linkedin: supver computer vs cloud</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/24/mdf4-reader/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/24/mdf4-reader/" itemprop="url">mdf4 reader</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-24T23:14:52-05:00">
                2020-02-24
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/02/24/mdf4-reader/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/02/24/mdf4-reader/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="read-mdf4-in-general"><a href="#read-mdf4-in-general" class="headerlink" title="read mdf4 in general"></a>read mdf4 in general</h2><p><img src="https://www.asam.net/index.php?eID=dumpFile&amp;t=p&amp;p=2964&amp;token=90de1236917c0225cbf3bd53101a81296613d367" alt="image"></p>
<p>the most important “branch” in the tree is the list of data groups (DG block).</p>
<p><strong>record</strong> used to store the plain measurement data, the records can either be contianed in one single “data” (DT) block, or distributed over several DT blocks using a “data list” block . </p>
<p>Each DG block has points to the data block, as well as necessary information to understand and decode the data.</p>
<p>the sub-tree of DG is channel group(CG) blocks and channel(CN) blocks. </p>
<h5 id="record-layout"><a href="#record-layout" class="headerlink" title="record layout"></a>record layout</h5><p>each record contains all signal values which have the same time stamp, in the same channel. for different channel groups(CG), each record must start with a “record id”</p>
<p><img src="https://www.asam.net/index.php?eID=dumpFile&amp;t=f&amp;f=195&amp;token=cb0391ba3e0fb5ee7fb91c9f4b8307e45e1e8f08" alt="image"></p>
<p>the record layout of ID 1, will be described by one channel group, the record layout of ID 2 by another channel group. Both channel groups must be children of the DT block’s parent data group.</p>
<h4 id="channels"><a href="#channels" class="headerlink" title="channels"></a>channels</h4><p>Each channel describes a recorded signal and how its values are encoded in the records for the channel’s parent CG block.</p>
<h2 id="vector-APIs"><a href="#vector-APIs" class="headerlink" title="vector APIs"></a>vector APIs</h2><p>which is licensed by <a href="https://www.vector.com/int/en/products/application-areas/ecu-calibration/measurement/mdf/" target="_blank" rel="external">vector</a></p>
<ul>
<li>GetFileManager()</li>
<li>OpenFile()</li>
<li>GetChannelByName()</li>
<li>GetChannelGroup()</li>
<li>CreaterDataPointer()</li>
<li>GetRecordCount()</li>
<li>SetReadMode()</li>
<li>SeekPos()</li>
<li>GetPos()</li>
<li>GetTimeSec()</li>
<li>ReadPhysValueDouble(pChannle, &amp;value, &amp;isvalid)</li>
<li>ReadRawValueDouble(pChannel, &amp;rawValue)</li>
<li>ReadPhysValueDouble(pChannel, &amp;phyValue)</li>
<li>MultiReadPhysValueDouble(pChannel, valueBuffer, size, &amp;read)</li>
</ul>
<h2 id="turbolab"><a href="#turbolab" class="headerlink" title="turbolab"></a><a href="https://www.turbolab.de/mdf_libf.htm" target="_blank" rel="external">turbolab</a></h2><p>ReadFileMF4 class:</p>
<ul>
<li>Open()</li>
<li>Seek(pos)</li>
<li>Read(Size, Buffer)</li>
<li>Close()</li>
</ul>
<p>CMdf4Calc class :</p>
<ul>
<li>Cmdf4Calc(pChan, pblock)</li>
<li>Cmdf4Calc(pChan, mf4file)</li>
</ul>
<p>cmf4DataGroup class:</p>
<ul>
<li>GetRecord()</li>
<li>GetRawValueFromRecord()</li>
<li>GetValueFromRecord()</li>
</ul>
<p>mdf4FileImport class :</p>
<ul>
<li>ImportFile()</li>
<li>ReleaseFile()</li>
</ul>
<p>I am not reading this C++ code. </p>
<h2 id="asammdf"><a href="#asammdf" class="headerlink" title="asammdf"></a><a href="https://github.com/danielhrisca/asammdf" target="_blank" rel="external">asammdf</a></h2><h3 id="MDF-class"><a href="#MDF-class" class="headerlink" title="MDF class"></a>MDF class</h3><ul>
<li><strong>init</strong>(name=None, ): name can be either <code>string</code> or <code>BytesIO</code></li>
<li>filter(channels, ) </li>
<li>get_group(index, channels=None, )</li>
<li>iter_channels(,)</li>
<li>iter_get(channel_name=None,group_id=None, group_index=None, )</li>
<li>iter_groups()</li>
<li>to_dataframe(), generate pandas DataFrame</li>
<li>whereis(channel_name)</li>
</ul>
<h3 id="MDF4-class"><a href="#MDF4-class" class="headerlink" title="MDF4 class"></a>MDF4 class</h3><p>includes <code>data_group</code>, <code>channel_group</code>, <code>channels</code>, <code>data_block</code>, <code>data_location</code>, <code>record_size</code> e.t.c</p>
<ul>
<li>get(channel_name=None, group=None, )</li>
<li>get_can_signal()</li>
<li>get_channel_name(group, index)</li>
<li>get_channel_unit(channel_name=Nont, group=None, )</li>
<li>get_master(index, data=None, ), return the master channel samples for given group</li>
<li>info() </li>
</ul>
<p>the following are sub data blocks of MDF4: </p>
<ul>
<li>Channel class </li>
<li>ChannelGroup class</li>
<li>DataGroup class </li>
<li>DataList class</li>
<li>DataBlock class</li>
<li>HeaderBlock class</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mdf = MDF4(<span class="string">"basic.mf4"</span>)</div><div class="line">db_info = mdf.info()</div></pre></td></tr></table></figure>
<p>all <code>group</code>, <code>channel</code> data is packages as <code>python dict</code>. the most exciting part, as asam-mdf can support <code>BytesIO</code>, which gives the way to read mdf files stores in Amazon S3:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">    mf4_ = obj_api.get_object("bucket_name", "sample.mf4")</div><div class="line">    fid_ = io.BufferedReader(mf4_['Body']._raw_stream) ;</div><div class="line">    read_in_memory = fid_.read()</div><div class="line">    bio_ = io.BytesIO(read_in_memory);</div><div class="line">    if bio_.seekable(): </div><div class="line">        mdf_ = MDF(bio_)</div><div class="line">        mdf_.info()</div><div class="line">``` </div><div class="line"></div><div class="line">### installation of asam-mdf</div><div class="line"></div><div class="line">* [install pandas](https://www.pypandas.cn/en/docs/installation.html#installing-using-your-linux-distribution’s-package-manager)</div><div class="line"></div><div class="line">`python3 -m pip install pandas` (not working)</div><div class="line"></div><div class="line">`sudo apt-get install python3-pandas` </div><div class="line"></div><div class="line">* [install canmatrix](https://canmatrix.readthedocs.io/en/latest/installation.html)</div><div class="line"></div><div class="line">`sudo python3 setup.py install` </div><div class="line"></div><div class="line">* install pathlib2 </div><div class="line"></div><div class="line">`sudo -H pip3 install pathlib2 `</div><div class="line"></div><div class="line">if `WARNING: pip is being invoked by an old script wrapper. This will fail in a future version of pip.`</div><div class="line">using: `sudo -H python3 -m pip install（包名）`</div><div class="line"></div><div class="line"></div><div class="line">## [mdfreader](https://github.com/ratal/mdfreader)</div><div class="line"></div><div class="line">which is open source LSP licensed. and the APIs are clear about getChannels, and read data from each channel, which was my first choice. but later found out it's difficult to support streamIO input, which was the best format I can reached from Amazon S3 pipeline.</div><div class="line"></div><div class="line"></div><div class="line">##### MdfInfo</div><div class="line"></div><div class="line">* read_info()</div><div class="line">* list_channels()</div><div class="line"></div><div class="line">##### Mdf</div><div class="line"></div><div class="line">* read()</div><div class="line">* filter_channel_names()</div><div class="line">* get_channel_data()</div><div class="line">* get_channel_unit()</div><div class="line">* keep_channels()</div><div class="line"></div><div class="line">```python</div><div class="line">import mdfreader</div><div class="line">filename="basic.mf4"</div><div class="line">file_info=mdfreader.MdfInfo()</div><div class="line">channels = file_info.list_channels(filename)</div><div class="line">print(channels)</div><div class="line">file_pointer = mdfreader.Mdf(filename)</div><div class="line">keys_ = file_pointer.keys()</div><div class="line">for k_ in keys_:</div><div class="line">    chan1 = file_pointer.get_channel_data(k_)</div><div class="line">    print(chan1)</div></pre></td></tr></table></figure>
<h2 id="python-necessary"><a href="#python-necessary" class="headerlink" title="python necessary"></a>python necessary</h2><h3 id="buffered-io"><a href="#buffered-io" class="headerlink" title="buffered io"></a>buffered io</h3><p><a href="https://docs.python.org/zh-cn/3/library/io.html" target="_blank" rel="external">binary I/O</a>, usually used in following: </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">f = open(<span class="string">"mdf_file"</span>, <span class="string">"rb"</span>)</div><div class="line">type(f)</div><div class="line">&lt;type <span class="string">'_io.BufferedReader'</span>&gt;</div></pre></td></tr></table></figure>
<p><strong>open(file, mode=’r’, buffering=-1, encoding=…)</strong></p>
<p>if<code>mode=&#39;b&#39;</code>, the returned content is bytes object, can’t encoding. if <code>buffereing</code> is not setted, for binary file with buffering with a fixed length. when with <code>mode=&#39;w/r/t</code>, it returns <code>io.TextIOwrapper</code>, if <code>mode=rb</code>, it returns <code>io.BufferedReader</code>, else if <code>mode=wb</code>, it returns <code>io.BufferedWriter</code>, else <code>mode=wrb</code>, it returns <code>io.BufferedRandom</code>. <a href="https://docs.python.org/zh-cn/3/library/functions.html#open" target="_blank" rel="external">check here</a></p>
<h4 id="dict-built-in-funs"><a href="#dict-built-in-funs" class="headerlink" title="dict built-in funs"></a>dict built-in funs</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">cmp(dict1, dict2) ;</div><div class="line">len(dict)</div><div class="line">str(dict)</div><div class="line">dict.clear()</div><div class="line">dict.get(key)</div><div class="line">dict.has_key(key)</div><div class="line">dict.items()</div><div class="line">dict.keys()</div><div class="line">dict.values()</div><div class="line">pop(key)</div></pre></td></tr></table></figure>
<h2 id="a-bit-about-readers"><a href="#a-bit-about-readers" class="headerlink" title="a bit about readers"></a>a bit about readers</h2><p>a few years ago I was in CAE field, dealing with different kind of CAE format, e.g .nas. during that time, there is a similar need to have a file transfer from vendor specified format to python format e.t.c. </p>
<p>so now it comes again, which is funny to know adapters in CAE and autonomous driving design.</p>
<h2 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h2><p><a href="https://asammdf.readthedocs.io/en/master/api.html#mdf4" target="_blank" rel="external">asammdf API doc</a></p>
<p><a href="https://www.asam.net/standards/detail/mdf/wiki/" target="_blank" rel="external">asam mdf4 doc</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/21/gpu-rendering-in-k8s-cloud/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/21/gpu-rendering-in-k8s-cloud/" itemprop="url">gpu rendering in k8s cloud</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-21T01:48:05-05:00">
                2020-02-21
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/02/21/gpu-rendering-in-k8s-cloud/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/02/21/gpu-rendering-in-k8s-cloud/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="background"><a href="#background" class="headerlink" title="background"></a>background</h2><p>to deploy simulation in docker swarm, there is a hurting that GPU rendering in docker requires a physical monitor(as $DISPLAY env variable). which is due to GeForece(Quadro 2000) GPUs, for Tesla GPUs there is no depends on monitor. really intertesting to know.</p>
<p>there were two thoughts how to deploy simulation rendering in cloud, either a gpu rendering cluster, or a headless mode in container cluster.</p>
<h2 id="unity-rendering"><a href="#unity-rendering" class="headerlink" title="unity rendering"></a>unity rendering</h2><p><a href="https://www.cnblogs.com/alan777/p/6204759.html" target="_blank" rel="external">unity rendering pipeline</a> is as following ：</p>
<ul>
<li><p>CPU calculate what need to draw and how to draw</p>
</li>
<li><p>CPU send commands to GPU</p>
</li>
<li><p>GPU plot </p>
</li>
</ul>
<h4 id="direct-rendering"><a href="#direct-rendering" class="headerlink" title="direct rendering"></a>direct rendering</h4><p><a href="https://unix.stackexchange.com/questions/319052/remote-direct-rendering-for-glx-opengl" target="_blank" rel="external">for remote direct rendering for GLX/openGL</a>, Direct rendering will be done on the X client (the remote machine), then rendering results will be transferred to X server for display. Indirect rendering will transmit GL commands to the X server, where those commands will be rendered using server’s hardware. </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">direct rendering: Yes</div><div class="line">OpenGL vendor string: NVIDIA</div></pre></td></tr></table></figure>
<p>Direct Rendering Infrasturcture(DRI) means the 3D graphics operations are hardware acclerated, Indirect rendering is used to sya the graphics operations are all done in software.</p>
<p>DRI enable to communicate directly with gpus, instead of sending graphics data through X server, resulting in 10x faster than going through X server </p>
<p>for performance, mostly the games/video use direct rendering. </p>
<h4 id="headless-mode"><a href="#headless-mode" class="headerlink" title="headless mode"></a>headless mode</h4><p>to disable rendering, either with dummy display. there is a blog how to <a href="https://towardsdatascience.com/how-to-run-unity-on-amazon-cloud-or-without-monitor-3c10ce022639" target="_blank" rel="external">run opengl in xdummy in AWS cloud</a>; eitherwith <a href="https://github.com/Unity-Technologies/ml-agents/blob/master/docs/Using-Docker.md" target="_blank" rel="external">Unity headless mode</a>, When running in batch mode, <a href="https://answers.unity.com/questions/159079/batchmode-and-nographics.html" target="_blank" rel="external">do not initialize graphics device at all</a>. This makes it possible to run your automated workflows on machines that don’t even have a GPU. to make a game server running on linux, and use the argument “-batchmode” to make it run in headless mode. <a href="https://forum.unity.com/threads/linux-nographics-support.152916/" target="_blank" rel="external">Linux -nographics support</a> <code>-batchmode</code> is normally the headless flag that works without gpu and audio hw acceleration</p>
<h2 id="GPU-container"><a href="#GPU-container" class="headerlink" title="GPU container"></a>GPU container</h2><p>a gpu containeris needs to map NVIDIA driver from host to the container, which is now done by <code>nvidia-docker</code>; the other issue is gpu-based app usually has its own (runtime) libs, which needs to install in the containers. e.g. CUDA, deep learning libs, OpengGL/vulkan libs. </p>
<p><img src="https://static001.infoq.cn/resource/image/25/66/2597b690685978c9a780aa93d6c7c266.png" alt="image"></p>
<h4 id="k8s-device-plugin"><a href="#k8s-device-plugin" class="headerlink" title="k8s device plugin"></a>k8s device plugin</h4><p>k8s has default <code>device plugin</code> model to support gpu, fpga e.t.c devices, but it’s in progress, nvidia has <a href="https://github.com/NVIDIA/k8s-device-plugin" target="_blank" rel="external">a branch</a> to support gpu as device plugin in k8s. </p>
<h4 id="nvidia-docker-mechanism"><a href="#nvidia-docker-mechanism" class="headerlink" title="nvidia docker mechanism"></a>nvidia docker mechanism</h4><p>when application call cuda/vulkan API/libs, it further goes to cuda/vulkan runtime, which further ask operations on GPU devices.</p>
<h2 id="cloud-DevOps"><a href="#cloud-DevOps" class="headerlink" title="cloud DevOps"></a>cloud DevOps</h2><h4 id="simulation-in-cloud"><a href="#simulation-in-cloud" class="headerlink" title="simulation in cloud"></a>simulation in cloud</h4><p>so far, there are plenty of cloud simulation online, e.g. ali, tencent, huawei/octopus, Cognata. so how these products work? all of them has containerized. as our test said, only Tesla GPU is a good one for containers, especially for rendering needs; GeForce GPU requires <code>DISPLAY</code> or physical monitor to be used for rendering. </p>
<h4 id="cloud-vendors-for-carmakers"><a href="#cloud-vendors-for-carmakers" class="headerlink" title="cloud vendors for carmakers"></a>cloud vendors for carmakers</h4><p>as cloud simulation is heavily infrastructure based, OEMs and cloud suppliers are coming together:</p>
<ul>
<li>FAW -&gt; Ali cloud</li>
<li>GAC -&gt; Tencent Cloud</li>
<li>SAC -&gt; Ali cloud / fin-shine </li>
<li>Geely -&gt; Ali cloud </li>
<li>Changan -&gt; Ali cloud </li>
<li>GWM -&gt; Ali cloud </li>
<li>Xpeng, Nio (?)</li>
<li>PonyAI/WeRide (?)</li>
</ul>
<p>obviously, Ali cloud has a major benefit among carmakers, which actually give Ali cloud new industry to deep in. traditionally, carmakers doesn’t have strong DevOps team, but now there is a change.</p>
<p>we can see the changing, as connected vehicles service, sharing cars, MaaS, autonomous vehicles are more and more requring a strong DevOps team. but not the leaders in carmakers realize yet.</p>
<h4 id="fin-shine"><a href="#fin-shine" class="headerlink" title="fin-shine"></a>fin-shine</h4><p><a href="http://fin-shine.com/" target="_blank" rel="external">SAC cloud</a>, which is a great example for other carmakers to study. basically they are building the common cloud service independently.</p>
<ul>
<li>container service &lt;– k8s/docker </li>
<li>storage &lt;– hdfs/ceph</li>
<li>big data &lt;– hadoop/sql </li>
<li>middleware </li>
<li>applications &lt;– AI, simulation</li>
</ul>
<p>it’s an IP for SAC, but on the other hand, to maintain a stable and user-friendly cloud infrastructure is not easy at all. </p>
<h2 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h2><p><a href="https://github.com/rndevfx/docker-blender-render-cluster" target="_blank" rel="external">docker blender render cluster</a></p>
<p><a href="https://docs.nvidia.com/ngc/ngc-vgpu-setup-guide/index.html" target="_blank" rel="external">nvidia vgpu</a></p>
<p><a href="https://engineering.bitnami.com/articles/using-gpus-with-kubernetes.html" target="_blank" rel="external">using GPUs with K8s</a></p>
<p><a href="https://docs.nvidia.com/datacenter/pdf/kubernetes-install-guide.pdf" target="_blank" rel="external">K8S on nvidia gpus</a></p>
<p><a href="https://www.harrisgeospatial.com/Support/Self-Help-Tools/Help-Articles/Help-Articles-Detail/ArtMID/10220/ArticleID/19193/OpenGL-Direct-Hardware-Rendering-on-Linux" target="_blank" rel="external">openGL direct hardware rendering on Linux</a> </p>
<p><a href="https://github.com/carla-simulator/carla/issues/1112" target="_blank" rel="external">runinng carla without display</a></p>
<p><a href="https://partiallydisassembled.net/posts/unity-headless-script.html" target="_blank" rel="external">tips for runing headless unity from a script</a></p>
<p><a href="https://forum.unity.com/threads/unity-server-instance-without-the-3d-graphics.22283/" target="_blank" rel="external">Unity Server instance without 3d graphics</a></p>
<p><a href="https://bluesmilery.github.io/blogs/afcb1072/" target="_blank" rel="external">a blog: nvidia device plugin for k8s</a></p>
<p><a href="https://www.infoq.cn/article/TDfGIikxH9bcgkNyWL6S" target="_blank" rel="external">k8s GPU manage &amp; device plugin mechanism</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/17/review-apollo-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/17/review-apollo-2/" itemprop="url">review-apollo (2).md</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-17T08:56:30-05:00">
                2020-02-17
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/02/17/review-apollo-2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/02/17/review-apollo-2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="review-apollo-2"><a href="#review-apollo-2" class="headerlink" title="review apollo (2)"></a>review apollo (2)</h1><h2 id="EMPlanner"><a href="#EMPlanner" class="headerlink" title="EMPlanner"></a>EMPlanner</h2><p><a href="">in review apollo(1)</a>, we had went through perception, prediction and part of planning module. the ADS planning problem can be summaried with a few input conditions, we can get a few drivable driving path, now <a href="https://github.com/YannZyl/Apollo-Note/blob/master/docs/planning/em_planner.md" target="_blank" rel="external">EMPlanner, here</a> need to find out the best one.</p>
<p>input conditions:</p>
<ul>
<li><p>perception and prediction obstacles and its future(in 5s) trajectory</p>
</li>
<li><p>current road status, e.g. special area, pedestrain cross e.t.c.</p>
</li>
</ul>
<p>both <code>path</code> and <code>speed</code> need to be planned or optimized. the core of EMPlanner is <a href="">Dynamic programming(DP)</a>, which is an classic algorithm to search the global optimized solution. the DP garantee each sub-group best solution accumulated to the final global best solution.</p>
<h3 id="PathOptimizer"><a href="#PathOptimizer" class="headerlink" title="PathOptimizer"></a>PathOptimizer</h3><p>the DP used in path optimizer basic processes:</p>
<p>starting from current location, in every time, move in x-direction about next n meters(to next location), and sample in y-direction at the next location, calcuate the cost from current location to each of the sampling point at the next location, and save cost value for each path for this sub path segment. (<strong>this is the different from DP to greedy algorithm</strong>), finally we retrieve all the cost values tables for each sub-path, and get the final best solution for the whole path. </p>
<p>a few question about DP here:</p>
<ul>
<li><p>how long in x-direction need to plan ?</p>
<pre><code>KMinSampleDistance = 40.0
</code></pre></li>
<li><p>what size of the interval in x-direction is good ?</p>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">step_length = math::Clamp(init_point.v() * SamplePointLookForwardTime, config_.step_length_min(), config_.step_length_max());</div></pre></td></tr></table></figure>
<ul>
<li>how many sample points in y-direction is needed ? </li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">num_sample_per_level = config_.sample_points_num_each_level();</div></pre></td></tr></table></figure>
<ul>
<li>how to sample in y-direction and x-direction ?</li>
</ul>
<p>which is case by case, depends on the ego’s maneuver as well as the lanes info.</p>
<p>basically, we had <code>RouteSegments</code>/<code>ReferenceLine</code> set, which includes the filtered referencelines for ego vehicle. for each referenceLine, we can calcuate the cost, then figure out the min cost referenceline as planning module’s output.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">EMPlanner::Plan(&amp;start_point, *frame)</div><div class="line">&#123;</div><div class="line">	foreach reference_line_info in frame-&gt;reference_line_info():</div><div class="line">		PlanOnReferenceLine();</div><div class="line">&#125;</div><div class="line"></div><div class="line">EMPlanner::PlanOnReferenceLine(start_point, frame, reference_line_info)&#123;</div><div class="line">	foreach optmizer in tasks_ :</div><div class="line">		ret = optmizer-&gt;Execute(frame, reference_line_info);</div><div class="line">&#125;</div><div class="line"></div><div class="line">PathOptimizer::Execute(*frame, *reference_line_info)&#123;</div><div class="line">	ret = Process(speedData, reference_line, start_point, path_data);</div><div class="line">&#125;</div><div class="line"></div><div class="line">DpPolyPathOptimizer::Process(SpeedData, ReferenceLine, init_point, path_data)&#123;</div><div class="line">	dp_road_graph.FindPathTunnel();</div><div class="line">&#125;</div><div class="line"></div><div class="line">DPRoadGraph::FindPathTunnel(init_point, &amp;obstacles, *path_data)&#123;</div><div class="line">	CalculateFrenetPoint(init_point, &amp;init_frenet_frame_point_);</div><div class="line">	GenerateMinCostPath(obstacles, &amp;min_cost_path);</div><div class="line">	foreach point in min_cost_path:</div><div class="line">		frenet_path.append(transfer(point));</div><div class="line">	path_data-&gt;SetFrenetPath(frenet_path);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="point2point-cost-calcualation"><a href="#point2point-cost-calcualation" class="headerlink" title="point2point cost calcualation"></a>point2point cost calcualation</h4><p>e.g. from the left interval sample points(in y-direction) to current interval sample points(in y-direction).</p>
<p>during this cost calcuation, consider pathCost, staticObstacleCost and DynamicObstacleCost. </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">TrajectoryCost::Calculate()&#123;</div><div class="line">	total_cost += CalculatePathCost();</div><div class="line">	total_cost += CalculateStaticObstacleCost();</div><div class="line">	total_cost += CalculateDynamicObstacleCost();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>UpdateNode() </li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">DPRoadGraph::GenerateMinCostPath()&#123;</div><div class="line">	<span class="keyword">for</span>(level=<span class="number">1</span>; level &lt; path_waypoints.size(); ++level)&#123;</div><div class="line">		level_points = path_waypoints[level]; <span class="comment">//all sample points in y-direction at current level </span></div><div class="line">		<span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;level_points.size(); ++i)&#123;</div><div class="line">			cur_point = level_points[i];</div><div class="line">			UpdateNode(prev_dp_points, level, &amp;trajectory_cost, &amp;cur_point);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>PathCost</li>
</ul>
<p>from each point at prevous level to current point at current level, consider the length, 1st order(speed), 2sec order(acc) should be smooth, can give a 5th-order polyfit, same as what’d done in referenceLine smoother. for each interval/curve polyfit(by <strong>curve.Evaluate()</strong>), we can re-sampling it more density, so at each new sampling point, calculate its (position, speed, acc)<code>l, dl, ddl</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">TrajectoryCost::CalculatePathCost(curve, start_s, end_s, curr_level)&#123;</div><div class="line">	foreach sampling_point in (end_s - start_s):</div><div class="line">		l = curve.Evalaute(0, sampling_point)</div><div class="line">		// cost from l </div><div class="line">		path_cost +=  l * l * config_.path_l_cost()</div><div class="line">		// cost from dl </div><div class="line">		dl = curve.Evaluate(1, sampling_point)</div><div class="line">		path_cost +=  dl * dl * config_.path_dl_cost()</div><div class="line">		// cost from ddl </div><div class="line">		ddl = curve.Evaluate(2, sampling_point)</div><div class="line">		path_cost +=  ddl * ddl * config_.path_ddl_cost()		</div><div class="line">&#125;</div><div class="line"></div><div class="line">```	</div><div class="line">		</div><div class="line">* StaticObstacleCost</div><div class="line"></div><div class="line">StaticObstacleCost() used the same idea from PathCost, basically, to resampling the interval, and calculate a cost on each of the sampling point. </div><div class="line"></div><div class="line">```c++</div><div class="line">TrajectoryCost::CalculateStaticObstalceCost(curve, start_s, end_s)&#123;</div><div class="line">	foreach curr_s in (end_s - start_s):</div><div class="line">		curr_l = curve.Evaluate(0, curr_s, start_s);</div><div class="line">		foreach obs_boundary :: static_obstacle_boundaries:</div><div class="line">			obstacle_cost += GetCostFromObs(curr_s, curr_l, obs_boundary);</div><div class="line">&#125;</div><div class="line"></div><div class="line">TrajectoryCost::GetCostFrmObs()&#123;</div><div class="line">	delta_l = fabs(adc_l - obs_center); </div><div class="line">	obstacle_cost.safety_cost += config_.obstacle_collision_cost() * Sigmoid(config_.obstacle_collision_distance() - delta_l) ;</div></pre></td></tr></table></figure>
<ul>
<li>DynamicObstacleCost </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">TrajectoryCost::CalculateDynamicObstacleCost(curve, start_s, end_s)&#123;</div><div class="line">	foreach timestamp:</div><div class="line">		foreach obstacle_trajectory in dynamic_obstacle_boxes_:</div><div class="line">			obstacle_cost += GetCostBetweenObsBoxes(ego_box, obstacle_trajectory.at(timestamp));</div><div class="line">&#125;</div><div class="line"></div><div class="line">TrajectoryCost::GetCostBetweenObsBoxes(ego_box, &amp;obs_box)&#123;</div><div class="line">	distance = obstacle_box.DistanceTo(ego_box);</div><div class="line">	if(distance &gt; config_.obstacle_ignore_distance())</div><div class="line">		return obstacle_cost ;</div><div class="line">	obstacle_cost.safety_cost += ( config_.obstacle_collision_cost() + 20) * Sigmoid(config_.obstacle_collision_distance() - distance);</div></pre></td></tr></table></figure>
<p>static obstacles cost calculating is like one space-dimension, only consider cost from the fixed/static obstacle to the fixed sampling points. for dynamic obstacles case, as the obstacle is moving, so we need a time-dimension, to calculate the cost at each time interval, from the current obstacle location to the fixed sampling points.</p>
<p>for dynamic obstacle cost, there is a risk cost (20), which need to take care.</p>
<h4 id="min-cost-path"><a href="#min-cost-path" class="headerlink" title="min cost path"></a>min cost path</h4><p>we got the cost matrix from the start_s level to the target_s/final level. but the final level in y-direction has 7 sampling points, all of which are drivable. so backward propagation, to get the best path (or a NODE in DAG)</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">DPRoadGraph::GenerateMinCostPath()&#123;</div><div class="line">	<span class="keyword">for</span>(cur_dp_node : graph_nodes.back())&#123;</div><div class="line">		fake_head.UpdateCost()</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<h3 id="SpeedOptimizer"><a href="#SpeedOptimizer" class="headerlink" title="SpeedOptimizer"></a>SpeedOptimizer</h3><p>the previous PathOptimier give the best (s, l) location of ego should arrived at each interval section along the referenceline. so what’s the best speed to reach these interval section ?</p>
<p>to do speed optimzier, two parts:</p>
<ul>
<li><p>constraint speed conditions, e.g. speed limit,  upper/lower boundary of drivable area along the refereneline due to obstacle trajectory</p>
</li>
<li><p>speed planning </p>
</li>
</ul>
<h4 id="BoundaryMapper"><a href="#BoundaryMapper" class="headerlink" title="BoundaryMapper()"></a>BoundaryMapper()</h4><p>for each obstalce’s trajectory, sampling in time-dimension, if its trajectory has overlapped with ego’s trajectory, mark the boundary box.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">StBoundaryMapper::CreateStBoundary()&#123;</div><div class="line">	foreach trajectory_point in trajectory:</div><div class="line">		obs_box = obstacle.GetBoundingBox(trajectory_point);</div><div class="line">		<span class="keyword">for</span>(path_s=<span class="number">0.0</span>, path&lt;s &lt; discretized_path.Length(); path_s += step_length)&#123;</div><div class="line">			curr_adc_path_point = discretized_path.EvaluateUsingLinearApproximation();</div><div class="line">			<span class="keyword">if</span>( CheckOverlap(curr_adc_path_point, obs_box, st_boundary_config_.boundary_buffer()) )</div><div class="line">			&#123;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// only when obs trajectory overlapped with ego's trajectory</span></div><div class="line">StBoundaryMapper::MapWithDecision(path_obstacle, decision)&#123;</div><div class="line">	boundary = StBoundary::GenerateStBoundary(lower_points, upper_points);</div><div class="line">	path_obstacle-&gt;SetStBoundary(boundary);</div><div class="line">	<span class="comment">// assign different boundary type </span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="SpeedLimitDecider"><a href="#SpeedLimitDecider" class="headerlink" title="SpeedLimitDecider"></a>SpeedLimitDecider</h4><ul>
<li><p>speed limit</p>
</li>
<li><p>centripetal acc limit</p>
</li>
<li><p>centripetal force limit </p>
</li>
</ul>
<h4 id="DpStGraph-Search"><a href="#DpStGraph-Search" class="headerlink" title="DpStGraph::Search"></a>DpStGraph::Search</h4><p>so far we have info from <code>boundaryMapper</code>, which tells lower_s and upper_s of safe driving area along reference line, excluding the overlaping area of obstacle’s trajectories; as well as speed limit. so now in the driving safe area, which speed ego should take at each point is also done by <code>DP</code>, speed can be represent in time-space two dimension, in a <code>T-S</code> table. </p>
<p>so speed DP can transfer to find the min cost [T,S] althrough the whole planning drive path. </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">DpStGraph::Search(speed_data)&#123;</div><div class="line">	InitCostTable().ok();</div><div class="line">	CalculateTotalCost().ok();</div><div class="line">	RetriveSpeedProfile(speed_data).ok();</div><div class="line">&#125;</div><div class="line"></div><div class="line">```	</div><div class="line"></div><div class="line"></div><div class="line">### QpSplineSpeedOptimizer </div><div class="line"></div><div class="line">DPSpeedOptimizer output the value pair of (time, location)(t, s) at each interval, then can get the velocity, acc, angular velocity by differencial among the neighbor intervals. QPSpline is a better way to get a polyfit 2nd-order smoothed speed profile along the referenceLine, which is higher-precision than DP.</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">### SpeedOptimizer and PathOptimizer fusion</div><div class="line"></div><div class="line">PathOptimizer outputs driving path in (accumulated_distance, section_direction distance)(s, l), SpeedOptimizer outputs driving path in (time, accumulated_distance)(t, s). now to get the best/optmized path along the referenceLine, need combine these two outputs.</div><div class="line"></div><div class="line">```c++</div><div class="line">for(cur_rel_time=0.0; cur_rel_time &lt; speed_data_.TotalTime(); cur_rel_time += TimeSec)&#123;</div><div class="line">	speed_data_.EvaluateByTime(cur_rel_time, &amp;speed_point);</div><div class="line">	if(speed_point.s() &gt; path_data_.discretized_path().Length()) break; </div><div class="line">	path_data.GetPathPointWithPathS(speed_point.s(), &amp;path_point);</div><div class="line">	path_point.set_s(path_point.s() + start_s);</div><div class="line">	</div><div class="line">	trajectory_point.mutable_path_point()-&gt;CopyFrom(path_point);</div><div class="line">	 trajectory_point.set_v(speed_point.v());</div><div class="line">    trajectory_point.set_a(speed_point.a());</div><div class="line">    trajectory_point.set_relative_time(speed_point.t() + relative_time);</div><div class="line">    ptr_discretized_trajectory-&gt;AppendTrajectoryPoint(trajectory_point);</div><div class="line">   </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>the above fusion is on one ReferenceLine, for all referenceLine, we can reach out the min cost referenceline as following:</p>
<pre><code class="c++">Frame::FindDriveReferenceLineInfo(){
    foreach reference_line_info in reference_line_info_ :
        <span class="keyword">if</span>(reference_line_info.IsDrivable() &amp;&amp; reference_lien_info.Cost &lt; min_cost){
            drive_reference_line_info_ = &amp;reference_line_info;
            min_cost = reference_line_info.Cost();
    }

    <span class="keyword">return</span> drive_reference_line_info_ ;
}
</code></pre>
<h3 id="Planning-in-summary"><a href="#Planning-in-summary" class="headerlink" title="Planning in summary"></a>Planning in summary</h3><p>Planning module has three components, ReferenceLineProvider, Frame and EMPlanner. Frame has <code>ReferencelineInfo</code>, which has everything about once-time planning, including the min-cost ReferenceLineInfo from EMPlanner. EMPlanner do DP and QP for PathPlan and SpeedPlan, seperately, which give a best driving path for each RefereneLine. in the whole, we can reach out the global best(min-cost) referenceLine from EMPlanner, and store back in Frame.</p>
<h2 id="Control"><a href="#Control" class="headerlink" title="Control"></a>Control</h2><p>Control module readin the planning ReferenceLine (Trajectory, VehicleStatus) and Localization, output control command.</p>
<pre><code class="c++">ControlComponent::Proc(){
    chassis_msg = chassis_reader_-&gt;GetLatestObserved();
    OnChassis(chassis_msg);
    trajectory_msg = trajectory_reader_-&gt; GetLatestObserved();
    localization_msg = localization_reader_-&gt; GetLatestObserved();

    status = ProduceControlCommand(&amp;control_command);
    control_cmd_writter_-&gt;Write();
}
</code></pre>
<h2 id="simulation"><a href="#simulation" class="headerlink" title="simulation"></a>simulation</h2><p>simulation is a system level verification/test tool, there are a few topics: </p>
<h4 id="simulate-the-world"><a href="#simulate-the-world" class="headerlink" title="simulate the world"></a>simulate the world</h4><p>how to make a virtual world in simulation, quickly, easily, close to real and massively deploy-friendly. </p>
<p>currently most commericial tools, e.g. PreScan, CarMaker, are supporting well real map(.osm), and on-line/distributed/cloud service, which is good way.</p>
<p>a few pioneers are trying to make the virtual world by 3D build through image/point cloud scanning. which is maybe the closest way to the physical world, but need large computing resource. </p>
<h4 id="integrate-ADS-system"><a href="#integrate-ADS-system" class="headerlink" title="integrate ADS system"></a>integrate ADS system</h4><p>how to integrate ADS system to simulation, easily.</p>
<p>most simulation software/platform is independent from ADS core. </p>
<p>for in-house prototype team, they both develop ADS and simulate in Matlab. which is pretty common in most OEM teams.</p>
<p>in product phase, it’s common to package ADS core as ros node, and talk to the simulation software by ROS.</p>
<h4 id="friendly-API"><a href="#friendly-API" class="headerlink" title="friendly API"></a>friendly API</h4><p>system level simulation has plenty of scenarios, requiring the simulation platform has friendly way to produce massively scenarios. including env, ego/npc behaviors, special cases e.t.c </p>
<p>most common APIs are Python and Matlab.</p>
<h4 id="massively-deployment"><a href="#massively-deployment" class="headerlink" title="massively deployment"></a>massively deployment</h4><p>it’s back to the test purpose, simulation needs to cover as much as possible scenarios, which requires IT infrastructure to support massively deployment. e.g. cloud deployment</p>
<p>`</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/15/review-apollo-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/15/review-apollo-1/" itemprop="url">review apollo (1)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-15T05:18:21-05:00">
                2020-02-15
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/02/15/review-apollo-1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/02/15/review-apollo-1/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://github.com/daohu527/Dig-into-Apollo" target="_blank" rel="external">dig into Apollo/Daohu527</a> and <a href="https://github.com/YannZyl/Apollo-Note" target="_blank" rel="external">YannZ/Apollo-Notes</a> are some good summary of Apollo. </p>
<h2 id="localization"><a href="#localization" class="headerlink" title="localization"></a>localization</h2><h4 id="rtk"><a href="#rtk" class="headerlink" title="rtk"></a>rtk</h4><p><a href="https://raw.githubusercontent.com/daohu527/Dig-into-Apollo/master/localization/img/location_rtk.jpg" target="_blank" rel="external">!image</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">RTKLocalizationComponent::InitIO()</div><div class="line">&#123;</div><div class="line">    corrected_imu_listener_ = node_ -&gt;CreateReader&lt;localization::CorrectImu&gt;();</div><div class="line">    gps_status_listener_ = node_ -&gt; CreateReader&lt;driver::gnss::InsStat&gt;();</div><div class="line">&#125;</div><div class="line"></div><div class="line">RTKLocalizationComponent::Proc(&amp; gps_msg)</div><div class="line">&#123;</div><div class="line"></div><div class="line">  localization_-&gt;GpsCallback(gps_msg);</div><div class="line">  <span class="keyword">if</span>(localization_-&gt;IsServiceStarted())</div><div class="line">  &#123;</div><div class="line">     LocalizationEstimate localization; </div><div class="line">     localization_-&gt;GetLocalization(&amp;localization); </div><div class="line">     localization_-&gt;GetLocalizationStatus(&amp;localization_status); </div><div class="line">     PublishPoseBroadcastTopic(localization);</div><div class="line">    &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h4 id="ndt"><a href="#ndt" class="headerlink" title="ndt"></a>ndt</h4><p>normal distribution transform(NDT) is to match our sensors view points compare to what we see on an existing map. </p>
<p>due to the view points from sensor may be <a href="https://medium.com/self-driving-cars/ndt-matching-acff8e7e01cb" target="_blank" rel="external">a little off from the map</a>, or the world might change a little between when built the map and when we record the view points.</p>
<p>so NDT will try to match view points to a grid of probability functions created from the map, instead of the map itself.</p>
<h4 id="msf"><a href="#msf" class="headerlink" title="msf"></a>msf</h4><h2 id="perception"><a href="#perception" class="headerlink" title="perception"></a>perception</h2><h4 id="module-overview"><a href="#module-overview" class="headerlink" title="module overview"></a>module overview</h4><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">void Perception::RegistAllOnboardClass() &#123;</div><div class="line">  RegisterFactoryLidarProcessSubnode();</div><div class="line">  RegisterFactoryRadarProcessSubnode();</div><div class="line">  RegisterFactoryFusionSubnode();</div><div class="line">  traffic_light::RegisterFactoryTLPreprocessorSubnode();</div><div class="line">  traffic_light::RegisterFactoryTLProcSubnode();</div><div class="line">&#125;</div><div class="line"></div><div class="line">``` </div><div class="line"></div><div class="line">the data flow in perception has two ways, either ROS message send/subscribe, or shared data. Apollo design a `global map` data structure:</div><div class="line"></div><div class="line">```c++</div><div class="line"></div><div class="line">GlobalFactoryMap&lt;string, map&lt;string, ObjectFactory*&gt; &gt;</div><div class="line"></div><div class="line">``` </div><div class="line"></div><div class="line">the first string element can be `SubNode` or `ShareData`.</div><div class="line"></div><div class="line">e.g. </div><div class="line"></div><div class="line">* lidar share data can stored as:  `GlobalFactorMap[sharedata][LidarObjectData]`</div><div class="line"></div><div class="line">* radar subnode data can stored as: `GlobalFactorMap[Subnode][RadarObjectData]`</div><div class="line"></div><div class="line"></div><div class="line">#### DAG process</div><div class="line"></div><div class="line">after ros subnode and shared data registered(not instance), [perception module create a DAG](https://github.com/YannZyl/Apollo-Note/blob/master/docs/perception/perception_software_arch.md)(directional acyclic graph) process, which includes subNode, Edge, and ShareData. </div><div class="line"></div><div class="line">`Edge` defines start node and end node of the data flow. e.g.   LidarProcessSubnode -&gt; FusionSubnode.</div><div class="line"></div><div class="line">* subnode init </div><div class="line"></div><div class="line">```c++</div><div class="line">DAGStreaming::InitSubnodes()</div><div class="line">&#123;</div><div class="line">   for(auto pair: subnode_config_map)</div><div class="line">   &#123;</div><div class="line">      Sunode* inst = SubnodeRegisterer::GetInstanceByName(subnode_config.name());</div><div class="line">      inst-&gt;Init() ;</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<ul>
<li>edge init </li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">DAGStreaming::Init()</div><div class="line">&#123;</div><div class="line">  event_manager_.Init(dag_config_path.edge_config());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>it’s easy to understand <code>EventManager</code> is used to register edge, as the data flow either by ros node or by share data is event driven. inside    <code>EventManager</code> there are two variables:  </p>
<pre><code>event_queue_map &lt;eventID, message_queue&gt;

event_meta_map  &lt;eventID, message_info&gt;
</code></pre><ul>
<li>shareData init </li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">DAGStreaming::Init()</div><div class="line">&#123;</div><div class="line">  InitSharedData(dag_config.data_config());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>each subnode and shareData is a separate ROS/data thread, which started after DAG process initialization finished, the run() process is the event loop:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">DAGStreaming::Schedule()</div><div class="line">&#123;</div><div class="line">  <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; pair: subnode_map_)</div><div class="line">  &#123;</div><div class="line">     pair.second-&gt;Start();</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; pair : subnode_map_)</div><div class="line">  &#123;</div><div class="line">    pair.second-&gt;Join();</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Subnode::Run()</div><div class="line">&#123;</div><div class="line">  <span class="keyword">while</span>(!stop)</div><div class="line">  &#123; </div><div class="line">    status = ProcEvents();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Lidar-process"><a href="#Lidar-process" class="headerlink" title="Lidar process"></a>Lidar process</h4><ul>
<li><a href="https://github.com/YannZyl/Apollo-Note/blob/master/docs/perception/obstacles_lidar_1_hdmap.md" target="_blank" rel="external">hdmap ROI filter</a>. basically compare the lidar cloud points to hdmap area, and filter out the cloud points outside of ROI.</li>
</ul>
<ul>
<li><p><a href="https://github.com/YannZyl/Apollo-Note/blob/master/docs/perception/obstacles_lidar_2_cnn.md" target="_blank" rel="external">CNN image segmentation</a>, basically classfiy the point clouds as obstacles based on CNN. </p>
</li>
<li><p><a href="https://github.com/YannZyl/Apollo-Note/blob/master/docs/perception/obstacles_lidar_3_minibox.md" target="_blank" rel="external">obstacle minBox</a></p>
</li>
<li><p><a href="https://github.com/YannZyl/Apollo-Note/blob/master/docs/perception/obstacles_lidar_4_hmtrack.md" target="_blank" rel="external">obstalce tracking</a></p>
</li>
<li><p><a href="https://github.com/YannZyl/Apollo-Note/blob/master/docs/perception/obstacles_lidar_5_fusion.md" target="_blank" rel="external">lidar fusion</a></p>
</li>
</ul>
<h4 id="Lidar-amp-Radar-fusion"><a href="#Lidar-amp-Radar-fusion" class="headerlink" title="Lidar &amp; Radar fusion"></a>Lidar &amp; Radar fusion</h4><p>the data fusion ros node proces in the following way:</p>
<p>step1: collect sensor’s data </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">FusionSubnode::Process()</div><div class="line">&#123;</div><div class="line">   BuildSensorObjs(events, &amp;sensor_objs);</div><div class="line">   fusion_-&gt;Fusion(sensor_objs, &amp;objects+);</div><div class="line">&#125;</div><div class="line"></div><div class="line">FusionSubnode::BuildSensorObjs(&amp;events, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;SensorObjects&gt; * multi_sensor_objs)&#123;</div><div class="line"></div><div class="line">  foreach event in events:</div><div class="line">  &#123;</div><div class="line">     <span class="keyword">if</span>( event.event_id == lidar )</div><div class="line">     &#123;</div><div class="line">        sensor_objects.sensor_type = VELODYNE ;</div><div class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( event.event_id == radar)&#123;&#125;</div><div class="line">     <span class="keyword">else</span> <span class="keyword">if</span> (event.event_id == camera)  &#123;&#125;</div><div class="line">     <span class="keyword">else</span>&#123;<span class="keyword">return</span> <span class="literal">false</span>;&#125;</div><div class="line">  &#125;</div><div class="line">  multi_sensor_objs-&gt;push_back(*sensor_objects);</div><div class="line">  </div><div class="line">&#125;   </div><div class="line">```   </div><div class="line"></div><div class="line">step2: process sensors data</div><div class="line"></div><div class="line">```c++</div><div class="line"></div><div class="line">ProbabiliticFusion::Fuse(multi_sensor_objs, *fused_objs)</div><div class="line">&#123;</div><div class="line"></div><div class="line">  sensor_mutex.lock();</div><div class="line">  foreach sensor_objs in multi_sensor_objs: </div><div class="line">  &#123;</div><div class="line">     sensor_manager_-&gt;AddSensorMeasurements(sensor_objs);</div><div class="line">  &#125;</div><div class="line">  sensor_manager_-&gt;GetLatestFrames(fusion_time, &amp;frames);</div><div class="line">&#125; </div><div class="line">  sensor_mutex.unlock();</div><div class="line"></div><div class="line">sensor_mutex.lock();</div><div class="line">foreach frame in frames:</div><div class="line">    FuseFrame(frame)</div><div class="line">CollectFusedObjects(fusion_time, fused_objects);</div><div class="line">sensor_mutex.unlock();</div></pre></td></tr></table></figure>
<p>the data structure for sensor_type, timestamp and perceptioned obj is: </p>
<pre><code>std::map&lt;string sensorType, map&lt;int64, SensorObjects&gt; &gt; sensors_;
</code></pre><p><code>sensors_[sensor_id][timestamp]</code> return the sensor’s object at a special timestamp</p>
<p>for Lidar and Radar fusion, we get a frame list, each frame has the object list from both Lidar and Radar. basically, so far it is just matching Lidar objects to Radar objects, assiged to timestamp. Lidar objects and Radar objects are indepenent.</p>
<h2 id="prediction"><a href="#prediction" class="headerlink" title="prediction"></a>prediction</h2><p>in Apollo, prediction module anticipatd the future motion trajectories of the perceived obstacles.</p>
<p>prediction subscribe to localization, planning and perception obstacle messages. when a localization update is received, the prediction module update its internal status, the actual prediction is triggered when perception sends out its perception obstacle messages, as following code :</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">MessageProcess:OnLocalization(*ptr_localization_msg);</div><div class="line">MessageProcess:OnPlanning(*ptr_trajectory_msg)</div><div class="line">MessageProcess:OnPerception(*ptr_perception_msg, &amp;prediction_obstacles)</div></pre></td></tr></table></figure>
<p>take a detail review of <code>OnPerception</code> as following: </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">MessageProcess:OnPerception(perception_obstacles, prediction_obstacles)&#123;</div><div class="line"></div><div class="line">	ptr_obstalces_container = ContainerManager::Instance()-&gt;GetContainer&lt;ObstaclesContainer&gt;();</div><div class="line">	</div><div class="line">	ptr_trajectory_container = ContainerManager::Instance()-&gt;GetContainer&lt;ADCTrajectoryContainer&gt;();</div><div class="line"></div><div class="line">	EvaluatorManager::Instance()-&gt;Run(ptr_obstacles_container);</div><div class="line">	</div><div class="line">	PredictorManager::Instance()-&gt;Run(perception_obstacles, ptr_trajectory_container, ptr_obstacles_container)</div></pre></td></tr></table></figure>
<h4 id="ContainerManager"><a href="#ContainerManager" class="headerlink" title="ContainerManager"></a>ContainerManager</h4><p>used to instancialize an instance of the special container, which is used to store the special type of message. there are three types of contianer:</p>
<ul>
<li>ObstaclesContainer </li>
</ul>
<p>used to store obstalce info and its lane info. obstacle info coming from perception; its lane info coming from hd map and <code>LaneGraph</code>, <code>LaneSequence</code> and <code>LaneSegment</code>. check the <a href="https://github.com/YannZyl/Apollo-Note/blob/master/docs/prediction/container_manager.md" target="_blank" rel="external">explanation of ObstacleContainer</a></p>
<p><code>LaneGraph</code> is namely the lane network. e.g. the pre/post lane, neighbor lane, or where the lane disappear. <code>LaneSegment</code> is the element/piece of discretization of the lane network, which has a start point and end point. <code>LaneSequence</code> is a set of all possible next lane choices from current lane, which is only based on the lane network and current obstacle velocity, rather than from planning.</p>
<ul>
<li>PoseContainer </li>
</ul>
<p>used to store vehicle world coord and the coord transfer matrix, velocity info e.t.c</p>
<ul>
<li>ADCTrajectoryContainer </li>
</ul>
<h4 id="EvaluatorManager"><a href="#EvaluatorManager" class="headerlink" title="EvaluatorManager"></a>EvaluatorManager</h4><p><a href="https://github.com/YannZyl/Apollo-Note/blob/master/docs/prediction/evaluator_manager.md" target="_blank" rel="external">what evaluator does</a>, is to compute the probability of each laneSequence, the obstacle is either vehicle, or pedestrain or bicycle. to compute probability is with multi-layer predictor(MLP) model:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">MLPEvaluator::Evaluate(obstacle_ptr)&#123;</div><div class="line">   foreach lane_sequence_ptr in lane_graph-&gt;lane_sequence_set:</div><div class="line">   ExtractFeatureValues(obstacle_ptr, lane_sequence_ptr, &amp;feaure_values)</div><div class="line">	probability = ComputeProbability(feature_values);  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ObstacleFeature</li>
</ul>
<p>there are <a href="https://github.com/YannZyl/Apollo-Note/blob/master/docs/prediction/evaluator_manager.md" target="_blank" rel="external">22 dimensions</a>, which are greate resources to understand a good prediction model in ADS. </p>
<p>these features includes, dimension, velocity, acc, direction of the obstacle, and relative position, angle to boundary lane e.t.c.</p>
<ul>
<li>LaneFeature </li>
</ul>
<p>since the laneSequence is already discritized as LaneSegment, for each lane Segment, Apollo calculate <code>4 features</code>: the angle from lanePoint position to its direction vector; obstacle’s projected distance to laneSequence; the direction of lanePoint; the direction angle from lanePoint’s direction to obstacle’s direction.</p>
<p>for each LaneSequnce only calculate its first 40 features, namely the first 10 LaneSegment.</p>
<p>from 22 Obstacle features and  40 lane features, compute the probability of each LaneSequence.</p>
<h4 id="PredictorManager"><a href="#PredictorManager" class="headerlink" title="PredictorManager"></a>PredictorManager</h4><p>this is where we answer the predict question, where in the next 5 sec the obstacle located. after EvaluatorManager(), we get the probability of each LaneSequence. then choose the few LaneSequences with high probability, and predict a possible obstacle motion for each high-probability LaneSequence as well as with ADCTrajectory info from planning module.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">PredictorManager::Run(perception_obstalces)</div><div class="line">&#123;</div><div class="line">   foreach obstacle in perception_obstacles:</div><div class="line">      predictor-&gt;Predict(obstacle)</div><div class="line">      foreach trajectory in  predictor-&gt;trajectories():</div><div class="line">          prediction_obstacle.add_trajectory(trajectory)  </div><div class="line">       prediction_obstacles.add_prediction_obstalce(prediction_obstalce)</div><div class="line">&#125;</div><div class="line">``` </div><div class="line">basically <span class="keyword">for</span> each obstacle, we <span class="keyword">do</span> [prediction its next few seconds position](https:<span class="comment">//github.com/YannZyl/Apollo-Note/blob/master/docs/prediction/predictor_manager.md). there are a few predictors: MoveSequencePredictor, LaneSequencePredictor, FreeMovePredictor.</span></div><div class="line"></div><div class="line">```c++</div><div class="line"></div><div class="line">MoveSequencePredictor::Predict(obstacle)</div><div class="line">&#123;</div><div class="line">   feature = obstalce-&gt;latest_feature();</div><div class="line">   num_lane_sequence =  feature.lane_graph().lane_sequence_size()</div><div class="line">   FilterLaneSequence(feature, lane_id, &amp;enable_lane_sequence)</div><div class="line">   foreach sequence in feature.lane_sequence_set</div><div class="line">   &#123;</div><div class="line">      DrawMoveSequenceTrajectoryPoints(*obstacle, sequence, &amp;points)</div><div class="line">      trajectory = GenerateTrajectory(points)</div><div class="line">      trajectory.set_probability(sequence.probability());</div><div class="line">      trajectories_.push_back(trajectory)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="why-need-prediction-module"><a href="#why-need-prediction-module" class="headerlink" title="why need prediction module"></a>why need prediction module</h4><p>whether including motion prediction or not is based on the computing ability of ADS system. for low power system, the planning module update really high frequency, then there is no prediction, or prediction only need be considered in less than a few mic-sec; but for complex ADS  system with low frequency update of planning, the ability to forsee the next few secs is very helpful. </p>
<h2 id="Planning"><a href="#Planning" class="headerlink" title="Planning"></a>Planning</h2><p><a href="https://raw.githubusercontent.com/daohu527/misc/master/blog/planning/planning_flow.png" target="_blank" rel="external">!image</a></p>
<h3 id="VehicleStateProvider"><a href="#VehicleStateProvider" class="headerlink" title="VehicleStateProvider"></a>VehicleStateProvider</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">VehicleStateProvider</span> &#123;</span></div><div class="line">   common::VehicleState vehicle_state_ ;</div><div class="line">   localization::LocalizationEstimate original_localization_ ; </div><div class="line">   </div><div class="line">   Update();</div><div class="line">   </div><div class="line">   EstimateFuturePosition();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="P-amp-C-Map"><a href="#P-amp-C-Map" class="headerlink" title="P&amp;C Map"></a>P&amp;C Map</h3><h4 id="update-routing-response"><a href="#update-routing-response" class="headerlink" title="update routing response"></a>update routing response</h4><p>during PnC map, we need to query waypoints(in s, l coord), e.g. current vehicle position, target position, in which routing laneSegment.</p>
<ul>
<li>get laneSegment info from routing response </li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">PncMap::UpdateRoutingResponse(routing)&#123;</div><div class="line">foreach road_segment in routing.road() :</div><div class="line">   foreach passage in road_segment.passage():</div><div class="line">      foreach lane in passage.segment():</div><div class="line">      &#123;</div><div class="line">         all_lane_id.insert(lane.id());</div><div class="line">       &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>query waypoints </li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">RouteSegments::WithinLaneSegment(&amp;lane_segment, &amp;waypoint)&#123;</div><div class="line">   <span class="keyword">return</span>  lane_segment.lane-&gt;id().id() == waypoint.id() &amp;&amp;  waypoint.s()  &gt;= lane_segment.start_s &amp;&amp; waypoint.s() &lt;= lane_segment.end_s</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>with UpdateRoutingResponse(), basically trafer waypoint in <code>s,l</code> coord to a more readable representation: [route_index, roadSegid, PassageID, laneSegmentID]</p>
<h4 id="generate-RouteSegments"><a href="#generate-RouteSegments" class="headerlink" title="generate RouteSegments"></a>generate RouteSegments</h4><p>based on current vehicle status and routing response, get all driving-avaiable path set, each <code>RouteSegment</code> is one driving-avaiable path in a short period. The length of each RouteSegment depends on the both backward(30m by default) lookup length and forward lookup length, which depends on ego vehicle velocity, a time threashold(8s by default), min_distance(150m by default), max_distance(250m by default). <a href="https://github.com/YannZyl/Apollo-Note/blob/master/docs/planning/pnc_map.md" target="_blank" rel="external">check here</a></p>
<ul>
<li>UpdateVehicleState()</li>
</ul>
<p>it’s not about update vehicle velocity e.t.c, but find out vehicle current location <code>adc_waypoint_</code> in the routing path and the next lane index <code>next_routing_waypoint_index_</code>. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">1. based on current vehicle velocity(x,y) and heading direction, lookup hdmap to find out all possible lanes, where current vehicle is on</div><div class="line"></div><div class="line">2. check if any lane from the possible lanes set, belong to any lanes from routingResponse.road(), the output is the filtered lanes set, on which the vehicle is and which belongs to routingResponse. </div><div class="line"></div><div class="line">3. calculate vehicle projection distance to each lane in the filtered lanes set, the lane with min projection distance is the target/goal lane</div></pre></td></tr></table></figure>
<ul>
<li>GetNeighborPassages()</li>
</ul>
<p>basically, check the next connected and avaiable channel. for situations, e.g. next cross lane is left turn, or lane disappear </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">GetNeighborPassages(road, passage_index)</div><div class="line">&#123;</div><div class="line">   <span class="keyword">if</span> (routing::FORWARD)</div><div class="line">   &#123;</div><div class="line">     <span class="comment">// keep forward, return current passage </span></div><div class="line">   &#125; </div><div class="line">   <span class="keyword">if</span> (source_passage.can_exit())</div><div class="line">   &#123;</div><div class="line">     <span class="comment">// current passage disappear</span></div><div class="line">   &#125;    </div><div class="line">   <span class="keyword">if</span> (IsWaypointOnSegment(next_routing_waypoint))</div><div class="line">   &#123;</div><div class="line">     <span class="comment">// next routing waypoint is in current lane</span></div><div class="line">   &#125; </div><div class="line">   <span class="keyword">if</span>(routing::LEFT <span class="keyword">or</span> routing::RIGHT)&#123;</div><div class="line">     neighbor_lanes = get_all_Left/Right_neighbor_forward_lane_id()</div><div class="line">     foreach passage in road:</div><div class="line">        foreach segment in passage:</div><div class="line">           <span class="keyword">if</span>(neighbor_lanes.count(segment.id())&#123;</div><div class="line">               result.emplace_back(id);</div><div class="line">               <span class="keyword">break</span>; </div><div class="line">           &#125;</div><div class="line">    <span class="keyword">return</span> result; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>GetRouteSegments()</li>
</ul>
<p>once we get the neighbor channels/passenges, the last step is to check if these passenges are drivable, only when current lane where ego vehicle located is the same lane or exactly next one lane when the vehicle projected on the passenge, and make sure the same direction. all other situations are not drivable. </p>
<p>additionaly add forward and backward segments will give current RouteSegments. </p>
<p>tips, passage is the channel where vehicle drive, or lane in physical road. but we use only LaneSegment, there is no keyword <code>Lane</code>.</p>
<h4 id="from-RouteSegment-to-road-sample-points"><a href="#from-RouteSegment-to-road-sample-points" class="headerlink" title="from RouteSegment to road sample points"></a>from RouteSegment to road sample points</h4><p>RouteSegment is similar as LaneSegments from hdMAP, including laneID, start_s, end_s; with additional mapPathPoint info, e.g. heading direction, and other traffic area property, which is used to lookup HD map.</p>
<p>rather than LaneSegments is about 2m, RouteSegment length can be much longer, including a few LaneSegments. if each LaneSegment provides a sample point, and packaging these smaple points as MapPathPoint, then RouteSegments can be represented as a list of MapPathPoint. and in reality, both start_point and end_point of each LaneSegemnt also added as a sample point, but need take off overlap points.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">PnCMap::AppendLaneToPoints()</div></pre></td></tr></table></figure>
<p>each two mapPathPoint again can group as a LaneSegment2d, and for the LaneSegment2d in same lane, can joining as one LaneSegment:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Path::InitLaneSegments()&#123;</div><div class="line">   <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i+<span class="number">1</span>&lt;num_points_; ++i)&#123;</div><div class="line">      FindLaneSegment(path_points_[i], path_points_[i+<span class="number">1</span>], &amp;lane_segment);</div><div class="line">      lane_segments_.push_back(lane_segment);</div><div class="line">   LaneSegment.Join(&amp;lane_segments);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>each small piece of LaneSegment2d helps to calculate the heading direction.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">Path::InitPoints()&#123;</div><div class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;num_points_; ++i)&#123;</div><div class="line">     heading = path_points_[i+<span class="number">1</span>] - path_points[i];</div><div class="line">     heading.Normalize();</div><div class="line">     unit_directions_.push_back(heading);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">``` </div><div class="line">tips, LaneSegment2d is the small piece about <span class="number">2</span>m, LaneSegment is a larger segment, <span class="keyword">and</span> has accumulated_start_s, <span class="keyword">and</span> accumulated_end_s info.</div><div class="line"></div><div class="line">so far, we have LaneSegment <span class="keyword">and</span> MapPathPoints <span class="built_in">set</span> to represent the RouteSegment. the MapPointPoint is about <span class="number">2</span>m each, Apollo(why?) density it about <span class="number">8</span> times to get a <span class="built_in">set</span> of sample path points, which is about <span class="number">0.25</span>m each.</div><div class="line"></div><div class="line">```c++</div><div class="line">Path::InitWidth()&#123;</div><div class="line">   kSampleDistance = <span class="number">0.25</span> ;</div><div class="line">   num_sample_points_ = length_ / kSampleDistance + <span class="number">1</span> ;</div><div class="line">   <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;num_sample_points_; ++i)&#123;</div><div class="line">     mapPathPoint_ = GetSmoothPoint(s);</div><div class="line">     s += kSampleDistance ; </div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>finally, RouteSegment has traffic zone info, e.g. cross road, parking area e.t.c</p>
<h3 id="ReferenceLineProvider"><a href="#ReferenceLineProvider" class="headerlink" title="ReferenceLineProvider"></a>ReferenceLineProvider</h3><p>ReferenceLineProvider has two funcs, <a href="https://github.com/YannZyl/Apollo-Note/blob/master/docs/planning/reference_line_provider.md" target="_blank" rel="external">check here</a>:</p>
<ul>
<li>smoothing sample path_points to get a list of anchor points, which is the exactly vehicle driving waypoints. from path_points to anchor_points is resampling, with a sparse(5m) sampling distance, as well as additionally consider one-side driving correction factor. </li>
</ul>
<p>taking an example about one-side driving correction factor,: when driving on left curve, human driver keeps a little bit left, rather than keeping in the centerline.</p>
<ul>
<li>piecewise smoothing from anchor points</li>
</ul>
<p>the basic idea is split anchor points in <code>n</code> subgroups, and polyfit each subgroup; for the subgroup connection part need to make sure the zero-order, first order and second order differential smooth.</p>
<p>which in final return to an <code>optimization problem</code> with constraints. </p>
<h3 id="Frame"><a href="#Frame" class="headerlink" title="Frame"></a>Frame</h3><p>the previous PnCMap and ReferenceLine is in an ideal driving env, Frame class considers obstacles behavior, and traffic signs. <a href="https://github.com/YannZyl/Apollo-Note/blob/master/docs/planning/frame.md" target="_blank" rel="external">check here</a></p>
<h4 id="obstacle-lagPrediction"><a href="#obstacle-lagPrediction" class="headerlink" title="obstacle lagPrediction"></a>obstacle lagPrediction</h4><p>predictionObstacle info is filtered by the following two cases, before use as the obstacle trajectory for planning. </p>
<ul>
<li>for latest prediction obstacles</li>
</ul>
<p>only if perception_confidence is large than confidence_threshold(0.5 by default) and the distance from the prediction obstacle to ego vehicle is less than distance_threshold(30m by default), then this obstacle is considered</p>
<ul>
<li>for history prediction obstacles </li>
</ul>
<p>only if the prediction_obstacles has more than 3 obstacles. as well as each obstacle appear more than <code>min_appear_num</code>(3 by default), and for the same obstacle, the timestamp distance from its previous prediction to latest prediction is not longger than <code>max_disappear_num</code>(5 by default), then this obstcle need take considerion.</p>
<h4 id="relative-position-from-ego-vehicle-to-obstacle"><a href="#relative-position-from-ego-vehicle-to-obstacle" class="headerlink" title="relative position from ego vehicle to obstacle"></a>relative position from ego vehicle to obstacle</h4><p>as we get the obstacles’ LagPrediction trajectory, as well as ReferenceLine for ego vehicle. now we combine this two information, to understand when the ego is safe and how far ego can drive forward. the output is the referenceline with each obstacle overlapped info. including the time <code>low_t</code> when overlap begins, and the time <code>high_t</code> when overlap ends; and the start location <code>low_s-start</code> and end location <code>high_s-start</code> of the overlap.</p>
<h4 id="rule-based-behavior-to-handle-overlap-area"><a href="#rule-based-behavior-to-handle-overlap-area" class="headerlink" title="rule based behavior to handle overlap area"></a>rule based behavior to handle overlap area</h4><p>there are 11 rule based behavior.</p>
<ul>
<li><p>backside_vehicle </p>
</li>
<li><p>change_lane</p>
</li>
<li><p>crosswalk</p>
</li>
<li><p>destination</p>
</li>
<li><p>front_vehicle</p>
</li>
<li><p>keep_clear </p>
</li>
<li><p>pull_over</p>
</li>
<li><p>reference_line_end </p>
</li>
<li><p>rerouting </p>
</li>
<li><p>signal_light</p>
</li>
<li><p>stop_sign </p>
</li>
</ul>
<pre><code class="c++">Planning::RunOnce()
{
  foreach ref_line_info in  frame_-&gt;reference_line_info()){
     traffic_decider.Init();
     traffic_decider.Execute(&amp;ref_line_info);
  }
}
</code></pre>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/15/ads-ros-and-simulator-in-one-docker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/15/ads-ros-and-simulator-in-one-docker/" itemprop="url">ads ros and simulator in one docker</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-01-15T06:16:36-05:00">
                2020-01-15
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/01/15/ads-ros-and-simulator-in-one-docker/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/01/15/ads-ros-and-simulator-in-one-docker/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="backround"><a href="#backround" class="headerlink" title="backround"></a>backround</h2><p><a href="https://zjli2013.github.io/2020/01/14/ads-ros-and-lgsvl-talk-in-dockers/" target="_blank" rel="external">previously</a>, we had test to run ads ros in one docker container, and lgsvl simulator in another docker container. once they are hosted in the same host machine, the ADS ros nodes and lgsvl can communicate well. based on this work, now it’s the time to integrate ADS ros nodes into the lgsvl docker.</p>
<p>the basic idea of how to combine multi docker images into one, is <a href="https://docs.docker.com/develop/develop-images/multistage-build/" target="_blank" rel="external">use multistage-build</a>, which I call “image level integration”.</p>
<h4 id="image-level-integration"><a href="#image-level-integration" class="headerlink" title="image level integration"></a>image level integration</h4><p>basically we have both <code>ads_ros</code> image and <code>lgsvlsimulator</code> image already, and there are a few components from <code>ads_ros</code> can be imported to <code>lgsvlsimulator</code> container: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">FROM ads_ros:latest  AS ADS</div><div class="line">FROM lgsvlsimulator:latest</div><div class="line">RUN mkdir /catkin_ws</div><div class="line">COPY --from=ADS /root/catkin_ws  /catkin_ws</div><div class="line">COPY --from=ADS /opt/ros /opt/ros </div><div class="line">CMD [&quot;/bin/bash&quot;]</div></pre></td></tr></table></figure>
<p>the problem of <code>image level integration</code>, it actually miss some system level components: <code>/etc/apt/sources.list.d/ros-latest.list</code>, which then can’t update ros modules; other components, e.g. which are installed during building <code>ads_ros</code> image by <code>apt-get install</code>, which are go the system lib path, which of course can distinct out, and copy to <code>lgsvlsimulator</code>, but which is no doubt tedious and easy to miss some components.</p>
<h4 id="component-level-integration"><a href="#component-level-integration" class="headerlink" title="component level integration"></a>component level integration</h4><p>as <code>ads_ros</code> is really indepent to <code>lgsvlsimulator</code>, so another way is use <code>lgsvlsimulator</code> as base image, then add/build <code>ros</code> component and <code>ads_ros</code> compnents inside.</p>
<pre><code>FROM ros:kinetic  AS ROS
# http://wiki.ros.org/kinetic/Installation/Ubuntu

FROM lgsvlsimulator:latest
RUN mkdir -p /catkin_ws/src
COPY --from=ROS /opt/ros /opt/ros 
COPY --from=ROS /etc/apt/sources.list.d/ros1-latest.list /etc/apt/sources.list.d/ros1-latest.list
# ADD ros key
RUN apt-key adv --keyserver &apos;hkp://keyserver.ubuntu.com:80&apos; --recv-key C1CF6E31E6BADE8868B172B4F42ED6FBAB17C654
## -------- install ads ros packages in lgsvlsimulator container ------------ ##
ENV CATKIN_WS=/catkin_ws
ENV ROS_DISTRO=kinetic
## https://docs.ros.org/api/catkin/html/user_guide/installation.html
RUN APT_INSTALL=&quot;apt-get install -y --no-install-recommends&quot; &amp;&amp; \
    apt-get update &amp;&amp; \
    DEBIAN_FRONTEND=noninteractive $APT_INSTALL \
        build-essential \
        apt-utils \
        ca-certificates \ 
        psmisc \
        cmake \
        python-catkin-pkg \ 
        ros-${ROS_DISTRO}-catkin  \ 
        ros-${ROS_DISTRO}-tf  \
        ros-${ROS_DISTRO}-turtlesim \
        ros-${ROS_DISTRO}-rosbridge-suite \
        iputils-ping \   
        net-tools 
# RUN source ~/.bashrc 
# copy ads ros into ws
COPY /ads_ros/src $CATKIN_WS/src
### build msgs 
RUN /bin/bash -c &apos;. /opt/ros/${ROS_DISTRO}/setup.bash; cd ${CATKIN_WS}; catkin_make --pkg pcl_msgs autoware_msgs nmea_msgs &apos;                   
### build ros nodes 
RUN /bin/bash -c &apos;. /opt/ros/${ROS_DISTRO}/setup.bash; cd ${CATKIN_WS}; catkin_make &apos;
# copy ros scripts
COPY /ads_ros/script_docker $CATKIN_WS/script
###--------finished ads ros package -------------- ### 
CMD [&quot;/bin/bash&quot;]
</code></pre><h2 id="runtime-issue"><a href="#runtime-issue" class="headerlink" title="runtime issue"></a>runtime issue</h2><p>with the dockerfile above, we can build the docker image which include both lgsvl and ads ros. one runtime issue is due to lgsvl scenario is run with <code>python3</code>, while our ads ros, especially <code>ros_bridge_launch</code> is based on <code>python2</code>. so need some trick to add <code>python2</code> at <code>$PATH</code> before <code>python3</code> when launch <code>ros_bridge</code>, then exchange back.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/14/ads-ros-and-lgsvl-talk-in-dockers/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/14/ads-ros-and-lgsvl-talk-in-dockers/" itemprop="url">ads ros and lgsvl talk in dockers</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-01-14T08:45:38-05:00">
                2020-01-14
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/01/14/ads-ros-and-lgsvl-talk-in-dockers/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/01/14/ads-ros-and-lgsvl-talk-in-dockers/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="backgound"><a href="#backgound" class="headerlink" title="backgound"></a>backgound</h3><p>previously, we had integrated ads ros nodes into one launch file. now we try to put ads nodes into docker, and talk to lgsvl simulator in another docker. </p>
<h4 id="run-dockerimage"><a href="#run-dockerimage" class="headerlink" title="run dockerimage"></a>run dockerimage</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">docker build -t ads_ros . </div><div class="line">docker run -it ads_ros  /bin/bash</div></pre></td></tr></table></figure>
<h4 id="unable-to-run-cakin-make-in-dockerfile"><a href="#unable-to-run-cakin-make-in-dockerfile" class="headerlink" title="unable to run cakin_make in dockerfile"></a>unable to run cakin_make in dockerfile</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">RUN /bin/bash -c &apos;. /opt/ros/kinetic/setup.bash; cd &lt;into the desired folder e.g. ~/catkin_ws/src&gt;; catkin_make&apos;</div><div class="line"></div><div class="line">``` </div><div class="line"></div><div class="line">#### dockerfile for ads ros</div><div class="line"></div><div class="line">``` </div><div class="line">FROM ros:kinetic </div><div class="line"></div><div class="line"># create local catkin workspace </div><div class="line">ENV CATKIN_WS=/root/catkin_ws</div><div class="line">ENV ROS_DISTRO=kinetic</div><div class="line">RUN mkdir -p $CATKIN_WS/src</div><div class="line"></div><div class="line">## install catkin_make </div><div class="line">## https://docs.ros.org/api/catkin/html/user_guide/installation.html</div><div class="line">RUN APT_INSTALL=&quot;apt-get install -y --no-install-recommends&quot; &amp;&amp; \</div><div class="line">    apt-get update &amp;&amp; \</div><div class="line">    DEBIAN_FRONTEND=noninteractive $APT_INSTALL \</div><div class="line">        build-essential \</div><div class="line">        apt-utils \</div><div class="line">        ca-certificates \ </div><div class="line">        psmisc \</div><div class="line">        cmake \</div><div class="line">        vim \ </div><div class="line">        python-catkin-pkg \ </div><div class="line">        ros-$&#123;ROS_DISTRO&#125;-catkin  \ </div><div class="line">        ros-$&#123;ROS_DISTRO&#125;-tf  \</div><div class="line">        ros-$&#123;ROS_DISTRO&#125;-turtlesim \</div><div class="line">        ros-$&#123;CATKIN_WS&#125;-rosbridge-suite </div><div class="line">        iputils-ping \   </div><div class="line">        net-tools </div><div class="line">### add third-party headers</div><div class="line"># RUN source ~/.bashrc </div><div class="line"># copy ads ros into ws</div><div class="line">COPY /src $CATKIN_WS/src</div><div class="line">### build msgs </div><div class="line">RUN /bin/bash -c &apos;. /opt/ros/$&#123;ROS_DISTRO&#125;/setup.bash; cd $&#123;CATKIN_WS&#125;; catkin_make --pkg pcl_msgs pb_msgs autoware_msgs mobileye_msgs ibeo_msgs nmea_msgs &apos;                   </div><div class="line">### build ros nodes </div><div class="line">RUN /bin/bash -c &apos;. /opt/ros/$&#123;ROS_DISTRO&#125;/setup.bash; cd $&#123;CATKIN_WS&#125;; catkin_make &apos;</div><div class="line"># copy ros scripts</div><div class="line">COPY /script $CATKIN_WS/scripts </div><div class="line"># run ros shell</div><div class="line">WORKDIR $&#123;CATKIN_WS&#125;/scripts</div></pre></td></tr></table></figure>
<h4 id="ros-envs"><a href="#ros-envs" class="headerlink" title="ros envs"></a>ros envs</h4><p>set <code>ROS_IP</code> on all involved containers to their IP, and set <code>ROS_MASTER_URI</code> to the IP of the roscore container. That would avoid the DNS problem. understand <a href="http://wiki.ros.org/ROS/EnvironmentVariables" target="_blank" rel="external">ros environment variables</a></p>
<ul>
<li><p>$ROS_ROOT :   set the location whre the ROS core packages are installed </p>
</li>
<li><p>$ROS_MASTER_URI :  a required setting that tells nodes where they can locate the master</p>
</li>
<li><p>$ROS_IP or $ROS_HOSTNAME : sets the declared network address of a ROS node</p>
</li>
</ul>
<h4 id="get-docker-container’s-IP"><a href="#get-docker-container’s-IP" class="headerlink" title="get docker container’s IP"></a>get docker container’s IP</h4><pre><code>docker inspect -f &quot;{{ .NetworkSettings.Networks.<network_name>.IPAddress }}&quot; &lt;container_name||container_id&gt; 
</network_name></code></pre><p>tips, network_name: e.g. host, bridge, ingress e.t.c.</p>
<p>with <a href="https://docs.docker.com/network/host/" target="_blank" rel="external">docker host net</a>, then the container doesn’t have its own IP address allocated, but the application is available on the host’s IP address with customized port.</p>
<h4 id="run-roscore-in-docker-and-talk-to-rosnodes-at-host"><a href="#run-roscore-in-docker-and-talk-to-rosnodes-at-host" class="headerlink" title="run roscore in docker and talk to rosnodes at host"></a>run roscore in docker and talk to rosnodes at host</h4><ul>
<li><p>start roscore from docker container as following :</p>
<p>  sudo docker run -it –net host ads_ros /bin/bash<br>  roscore </p>
</li>
<li><p>start other ros nodes at host </p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">rosnode list  ## &gt;&gt;&gt;  /rosout </div><div class="line">source $ROS_PACKAGE/setup.sh</div><div class="line">rosrun rtk_sensor rtk_sensor   ### run successfully </div><div class="line">``` </div><div class="line"></div><div class="line">how to understand ?  once the docker container start with `host network`, the `roscore` run inside docker, is same as run in the host machine !! </div><div class="line"><span class="meta"></span></div><div class="line"></div><div class="line">#### ads ros in docker talk to lgsvl in another docker with HOST network </div><div class="line"></div><div class="line">* once we start ads ros docker as following: </div><div class="line"></div><div class="line">```shell</div><div class="line">sudo docker run -it --net host ads_ros /bin/bash</div><div class="line">roscore </div><div class="line">``` </div><div class="line"></div><div class="line">* start lgsvl in docker: </div><div class="line"></div><div class="line">```shell</div><div class="line"><span class="meta">#</span>! /usr/bin/env bash</div><div class="line">xhost + </div><div class="line">sudo nvidia-docker run -it  -p 8080:8080  -e DISPLAY=unix$DISPLAY --net host -v /tmp/.X11-unix:/tmp/.X11-unix lgsvlsimulator /bin/bash</div></pre></td></tr></table></figure>
<p>then access webUI in host machine, and add <code>host: 10.20.181.132</code> in <code>Clusters</code> page, and  add <code>10.20.181.132:9090</code> for Selected Vehicles. as lgsvl is also in <code>host network</code>. so these two docker can communicate through ros well !! </p>
<h4 id="ads-ros-container-talk-to-lgsvl-container-with-ROS-IP"><a href="#ads-ros-container-talk-to-lgsvl-container-with-ROS-IP" class="headerlink" title="ads ros container talk to lgsvl container with ROS_IP"></a>ads ros container talk to lgsvl container with ROS_IP</h4><p>since lgsvl will run in docker swarm env, we can’t depend on <code>host network</code>, which requires ROS_IP env. the following test is in one host machine. </p>
<ul>
<li>in host terminal </li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">export ROS_MASTER_URI=http://192.168.0.10:11311</div><div class="line">export ROS_HOSTNAME=192.168.0.10</div><div class="line">export ROS_IP=192.168.0.10   </div><div class="line"></div><div class="line">roscore </div><div class="line">``` </div><div class="line"></div><div class="line">* in ads ros docker </div><div class="line"></div><div class="line">```shell</div><div class="line">sudo docker run -it \ </div><div class="line">     --env ROS_MASTER_URI=http://10.20.181.132:11311 \ </div><div class="line">     --env ROS_IP=10.20.181.132 \ </div><div class="line">     ads_ros /bin/bash</div><div class="line"></div><div class="line">rosnod list </div><div class="line">``` </div><div class="line"></div><div class="line">however, when start `roscore` in docker, it reports:</div><div class="line"></div><div class="line">```shell</div><div class="line">Unable to contact my own server at [http://10.20.181.132:33818/].</div><div class="line">This usually means that the network is not configured properly.</div><div class="line"></div><div class="line">A common cause is that the machine cannot ping itself.  Please check</div><div class="line">for errors by running:</div><div class="line"></div><div class="line">	ping 10.20.181.132</div><div class="line"></div><div class="line">``` </div><div class="line"></div><div class="line">if checking the IP address inside the docker container by `ifconfig`, which reports `172.17.0.3`, which then make sense that the container can't talk to `10.20.181.132`, which means we can't assign a special IP address for a docker container. so reset in the docker container as:</div><div class="line"></div><div class="line">```shell</div><div class="line">export ROS_MASTER_URI=http://172.17.0.3:11311</div><div class="line">export ROS_HOSTNAME=172.17.0.3</div></pre></td></tr></table></figure>
<p>actually, the host terminal can talk to the ads ros container directly, with no need to set <code>$ROS_HOSTNAME</code> &amp; <code>$ROS_MASTER_URI</code> specially; as well as another docker container in this host machine, e.g. lgsvl. </p>
<p>a little bit knowledge about docker network. so each docker container does have an virtual IP, e.g. 172.17.0.1. while if run the docker image with <code>host network</code>, there is no special container IP, but the container directly share the IP of the host machine. as multi docker containers run in the same host machine, even without <code>host network</code>, they are in the same network range, so they can communicate to each other. additionaly for <code>ros_master</code>, which may requires to add <code>$ROS_HOSTNAME</code> &amp; <code>$ROS_MASTER_URI</code>.</p>
<ul>
<li>start lgsvl in another docker </li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span>! /usr/bin/env bash</div><div class="line">xhost + </div><div class="line">sudo nvidia-docker run -it \ </div><div class="line">     -p 8080:8080 \  </div><div class="line">     -e DISPLAY=unix$DISPLAY \ </div><div class="line">     -v /tmp/.X11-unix:/tmp/.X11-unix \ </div><div class="line">     --env ROS_MASTER_URI=http://172.17.0.3:11311  \ </div><div class="line">     --env ROS_HOSTNAME=172.17.0.3   </div><div class="line">     lgsvlsimulator /bin/bash</div></pre></td></tr></table></figure>
<h4 id="in-summary"><a href="#in-summary" class="headerlink" title="in summary"></a>in summary</h4><p>so far, we have host ads ros in one docker, and lgsvl in another docker, and they are in the same machine, and they can talk to each other. the next thing is to put ads ros and lgsvl in one image.</p>
<h2 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h2><p><a href="http://wiki.ros.org/rosdep" target="_blank" rel="external">rosdep</a></p>
<p><a href="https://stackoverflow.com/questions/35742807/docker-1-10-containers-ip-in-lan/39285950#39285950" target="_blank" rel="external">docker 1.10 container’s IP in LAN</a></p>
<p><a href="https://answers.ros.org/question/244424/listening-to-ros-messages-in-docker-containers/" target="_blank" rel="external">listening to ROS messages in docker containers</a></p>
<p><a href="https://answers.ros.org/question/228292/exposing-ros-containers-to-host-machine/" target="_blank" rel="external">exposing ROS containers to host machine</a></p>
<p><a href="https://takacsmark.com/how-to-get-docker-container-ip-address/" target="_blank" rel="external">why you need IP address of Docker container</a></p>
<p><a href="https://answers.ros.org/question/312577/catkin_make-command-not-found-executing-by-a-dockerfile/" target="_blank" rel="external">catkin_make not found in dockerfile</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/10/ROS-ADS-integrated-to-python-talk-to-lgsvl/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/10/ROS-ADS-integrated-to-python-talk-to-lgsvl/" itemprop="url">ROS ADS integrated to python talk to lgsvl</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-01-10T08:35:12-05:00">
                2020-01-10
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/01/10/ROS-ADS-integrated-to-python-talk-to-lgsvl/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/01/10/ROS-ADS-integrated-to-python-talk-to-lgsvl/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="background"><a href="#background" class="headerlink" title="background"></a>background</h2><p><a href="https://zjli2013.github.io/2020/01/04/ADS-stack-in-ros-talk-to-lgsvl/" target="_blank" rel="external">previously</a>, we had done ADS ros package directly talk with lgsvl. the step further is to trigger ADS ros nodes from scenario python script</p>
<p>a few requirements:</p>
<ul>
<li><p>for ADS ros should be integrated with each scenario python script, which means, when the python script finished, the ADS ros should exit</p>
</li>
<li><p>the ads ros package shell script is independ of python script </p>
</li>
</ul>
<h4 id="execute-shell-in-Python"><a href="#execute-shell-in-Python" class="headerlink" title="execute shell in Python"></a>execute shell in Python</h4><ul>
<li>to <a href="http://dreamsyssoft.com/python-scripting-tutorial/shell-tutorial.php" target="_blank" rel="external">call a shell command</a> directly with <code>os.system(cmd)</code> or </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">subprocess.call(&quot;ls -lt&quot;, shell=True)</div></pre></td></tr></table></figure>
<ul>
<li>to run shell script with a python subprocess </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">proc=subprocess.Popen([&quot;&quot;], stdout=subprocess.PIPE)</div></pre></td></tr></table></figure>
<p><code>subprocess.Popen()</code> return the process object</p>
<p>a few helpful commands to debug rosrun:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">ps -aux | grep &quot;roscore&quot;  </div><div class="line"></div><div class="line">ps -aux | grep &quot;rosmaster&quot;</div><div class="line"></div><div class="line">killall -9 roscore </div><div class="line"></div><div class="line">killall -9 rosmaster</div></pre></td></tr></table></figure>
<h2 id="ros1-to-python3"><a href="#ros1-to-python3" class="headerlink" title="ros1 to python3"></a>ros1 to python3</h2><p>there is an real issue, due to the ADS ros package is mostly implemented by ROS1, maintained by the algorithm team. but lgsvl scenario is running with python3. <a href="http://design.ros2.org/articles/changes.html" target="_blank" rel="external">ROS1 matches Python2</a>. so there comes the solution, either to upgrade the ADS ros pakcage to ROS2, or find a way to run ROS1 in python3 env.</p>
<h4 id="conda-base-env"><a href="#conda-base-env" class="headerlink" title="conda base env"></a>conda base env</h4><p>we had decided to adapt ROS1 in python3 env. as the host machine has conda env, first need to <a href="https://stackoverflow.com/questions/54429210/how-do-i-prevent-conda-from-activating-the-base-environment-by-default" target="_blank" rel="external">disable conda base</a>. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">conda config --set auto_activate_base false</div></pre></td></tr></table></figure>
<p>as lgsvl scenario is runned with conda python3 env, inside which used <code>subprocess</code> to run ADS ros shell, in which creates a few new <code>gnome-terminal</code>s, which are non log-in terminal, and the trick things here: even though disabled auto activate base, and the terminal has no header <code>(base)</code>, but when check the python path, it still points to the <code>conda/bin/python</code>, which will fail <code>rosbridge_launch.server</code>, which is a pure ros1 and python2 module.</p>
<p>so need check if <code>conda --version</code> in the ads ros shell script is  in current terminal, if does, run <code>conda deactivate</code>, which gives error:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CommandNotFoundError: Your shell has not been properly configured to use &apos;conda deactivate&apos;.</div></pre></td></tr></table></figure>
<p>it looks there is some mess up, with init <code>conda.sh</code> is in <code>~/.bashrc</code>, but during the new terminal ceated, it doens’t confgiure all right. which can be fixed :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">conda --version </div><div class="line">if [ $? == 0 ]</div><div class="line">then </div><div class="line">    source ~/anaconda3/etc/profile.d/conda.sh</div><div class="line">    conda deactivate</div><div class="line">fi</div></pre></td></tr></table></figure>
<p>in this way, we run lgsvl scenario in python3, as well as can new with python2 terminals to run ads ros nodes from this python3 terminal</p>
<h4 id="ros-scripts-path-is-not-python-path"><a href="#ros-scripts-path-is-not-python-path" class="headerlink" title="ros scripts path is not python path"></a>ros scripts path is not python path</h4><p>as we try to separate python scripts from ads ros nodes, so need some global env variable for the ros scripts path. </p>
<h2 id="kill-all-ros-nodes-gracefully"><a href="#kill-all-ros-nodes-gracefully" class="headerlink" title="kill all ros nodes gracefully"></a>kill all ros nodes gracefully</h2><p>we need restart/shutdown the ads ros nodes package at each time when python scenario script start/stop, which has two steps:</p>
<ul>
<li><p>to shutdown ros nodes, e.g.  <a href="https://answers.ros.org/question/237862/rosnode-kill/" target="_blank" rel="external">rosnode kill</a></p>
</li>
<li><p>to close all the gnome-terminals to run the ros nodes</p>
</li>
</ul>
<p>the second step is very tricky, need some understand. A terminal is a file. Like /dev/tty. Files do not have a process id. The process that “owns” the terminal is usually called the controlling process, or more correctly, the process group leader. <code>gnome-terminal</code> <a href="https://askubuntu.com/questions/775025/how-to-detect-the-number-of-opened-terminals-by-the-user" target="_blank" rel="external">runs a single pid</a>, it creates a child process for each and every window and/or tab. and can retrieve these child processes by the command:</p>
<pre><code>$ pgrep -P &lt;pid_of_gnome-terminal&gt;
</code></pre><p>Many terminals seem to <a href="https://askubuntu.com/questions/640096/how-do-i-check-which-terminal-i-am-using" target="_blank" rel="external">mask themselves as xterm-compatible</a>, which is reported by echo $TERM or echo $COLORTERM. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$! is the PID of the last backgrounded process.</div><div class="line">kill -0 $PID checks whether it&apos;s still running.</div><div class="line">$$ is the PID of the current shell.</div></pre></td></tr></table></figure>
<pre><code>#! /bin/bash

gnome_pid=`pgrep gnome-terminal`
subpids=`pgrep -P ${gnome_pid}`

if [ ! $1 ]; then
   echo &quot;missing the gnome-terminal pid, exit&quot;
   exit -1
fi

#shutdown the ros nodes 
rosnode kill -a  &gt; /dev/null  2&gt;&amp;1
killall -9 rosmaster &gt; /dev/null  2&gt;&amp;1

#shutdown the terminals where ros nodes hosted
for pid in $subpids
do
        if [[ $pid != $1 ]] ; then
                echo $pid
                kill $pid
        fi
done
</code></pre><p>tips: the implement has a litle problem when integrate with lgsvl when the simulation time is short, e.g. 1sec, then <code>ros_clear.sh</code> can’t catch the opened gnome-terminals from <code>ros_start.sh</code>. </p>
<h4 id="find-the-process-name-using-PID"><a href="#find-the-process-name-using-PID" class="headerlink" title="find the process name using PID"></a><a href="https://www.tecmint.com/find-process-name-pid-number-linux/" target="_blank" rel="external">find the process name using PID</a></h4><pre><code>$ ps aux | grep PID
$ ps -p PID -o format         
$ curpid=`ps -p $$ -o ppid=`
</code></pre><h4 id="the-output-of-ps-aux"><a href="#the-output-of-ps-aux" class="headerlink" title="the output of ps aux"></a><a href="https://www.computernetworkingnotes.com/linux-tutorials/ps-aux-command-and-ps-command-explained.html" target="_blank" rel="external">the output of ps aux</a></h4><ul>
<li>–&gt;  in the foreground process group<br>s –&gt;  is a session leader </li>
</ul>
<h2 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h2><p>so far, we integrated ads ros packages into python, which then talk to lgsvl. </p>
<h2 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h2><p><a href="https://www.jianshu.com/p/2eb33b491024" target="_blank" rel="external">pythn subprocess from Jianshu</a></p>
<p><a href="https://www.cnblogs.com/vamei/archive/2012/10/07/2713023.html" target="_blank" rel="external">understand linux process group</a></p>
<p><a href="https://www.cyberciti.biz/faq/linux-pidof-command-examples-find-pid-of-program/" target="_blank" rel="external">pidof command</a></p>
<p><a href="https://askubuntu.com/questions/476641/how-can-i-get-the-name-of-the-current-terminal-from-command-line/476663#476663" target="_blank" rel="external">which_term</a></p>
<p><a href="https://stackoverflow.com/questions/9378021/how-to-get-process-details-from-its-pid" target="_blank" rel="external">get the info of a PID</a></p>
<p><a href="https://askubuntu.com/questions/476641/how-can-i-get-the-name-of-the-current-terminal-from-command-line" target="_blank" rel="external">get the pid of running terminal</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/04/ADS-stack-in-ros-talk-to-lgsvl/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/04/ADS-stack-in-ros-talk-to-lgsvl/" itemprop="url">ADS stack in ros talk to lgsvl</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-01-04T23:02:13-05:00">
                2020-01-04
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/01/04/ADS-stack-in-ros-talk-to-lgsvl/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/01/04/ADS-stack-in-ros-talk-to-lgsvl/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<h2 id="learning-is-about-repeat-100-times"><a href="#learning-is-about-repeat-100-times" class="headerlink" title="learning is about repeat 100 times !"></a>learning is about repeat 100 times !</h2><p>this maybe the third time to go through ROS, which still looks fresh, but does give a whole picture about how ROS works in ADS dev. </p>
<ul>
<li>what is ros topic and message </li>
</ul>
<p>the topic is the channel where nodes are subscribed for to read messages or where the nodes publish those messages; the message is the data itself, previously defined. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">rostopic echo [topic]</div><div class="line"></div><div class="line">rostopic list </div><div class="line"></div><div class="line">rosmsg show [message]</div><div class="line"></div><div class="line">rosrun [package_name] [node_name]</div><div class="line"></div><div class="line">rospack find [package_name]</div><div class="line"></div><div class="line">rosnode info [node_name]</div></pre></td></tr></table></figure>
<ul>
<li>what is a publisher/subscriber</li>
</ul>
<p>a publisher (node) publishes messages to a particular topic. <a href="http://wiki.ros.org/roscpp/Overview/Publishers%20and%20Subscribers" target="_blank" rel="external">publish()</a> is asynchronous, and only does work if there are subscribers connected on that topic. <code>publish()</code> itself is very fast, and it does as little work as possible:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">serialize the message to a buffer </div><div class="line">push the buffer onto a queue for later processing</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ros::Publisher advertise(const std::string&amp; topic, uint32_t queue_size, bool latch = false);</div></pre></td></tr></table></figure>
<p>the <code>queue size</code> is defined in  publihser/outgoing message queue. if publishing faster than roscpp can send the message over the wire, roscpp will start dropping OLD messages. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ros::Subscriber subscribe(const std::string&amp; topic, uint32_t queue_size, &lt;callback, which may involve multiple arguments&gt;, const ros::TransportHints&amp; transport_hints = ros::TransportHints());</div></pre></td></tr></table></figure>
<p>the queue_size is the incoming message/subscriber queue size, roscpp will use for your callback. if messages are arriving too fast and you are unable to keep up, roscpp will start throwing away OLD messages.</p>
<p><a href="https://answers.ros.org/question/243855/how-do-publishersubscriber-message-queues-work/" target="_blank" rel="external">in summary</a>: </p>
<pre><code>* publish() is asynchronous.
* When you publish, messages are pushed into a queue (A) for later processing. This queue is immediately pushed into the outgoing/publisher queue (B) . PS: If no one subscribes to the topic, the end is here.
* When a subscriber subscribes to that topic. Messages will be sent/pushed from the corresponding outgoing/publisher queue (B) to the incoming/subscriber queue (C).--&gt; this is done by internal thread
* When you spin/ callback, the messages handled are from the incoming/subscriber queue (C).
</code></pre><ul>
<li><a href="http://wiki.ros.org/Messages" target="_blank" rel="external">messages</a></li>
</ul>
<p><strong>msg</strong> files are simple text files for specifying the data structure of a message. These files are stored in the msg subdirectory of a package. the publisher and subscriber must send and receive the same <strong>type/topic</strong> of message</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&quot;op&quot;: &quot;publish&quot;, &quot;topic&quot;: &quot;/talker&quot;, &quot;msg&quot;: &#123;&quot;data&quot; : &quot;_my_message&quot; &#125;&#125;</div></pre></td></tr></table></figure>
<p>lgsvl defines the rosBridge class, which has a Reader() and Writer(), corresponding to Subsciber and Publisher, respectfually. </p>
<h2 id="rosBridge-in-lgsvl"><a href="#rosBridge-in-lgsvl" class="headerlink" title="rosBridge in lgsvl"></a>rosBridge in lgsvl</h2><p>rosbridge is an adapter for non-ros apps to talk with ros. it’s common to package ADS software as ros node during dev stage, and rosbridge is the common way to integrate simulator with ADS software.</p>
<p>the base implementation of <code>rosBridge</code> in lgsvl is as following: </p>
<h4 id="RosBridge-cs"><a href="#RosBridge-cs" class="headerlink" title="RosBridge.cs"></a>RosBridge.cs</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ConcurrentQueue&lt;Action&gt;  QueuedActions ;</div><div class="line">Dictionary&lt;string, Tuple&lt;Func&lt;JSONNode, object&gt;, List&lt;Action&lt;object&gt;&gt;&gt;&gt; Readers ;</div></pre></td></tr></table></figure>
<p>the topic is packaged as:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123; &quot;op&quot;:  &quot;subscribe or publish or call_service or service_response or set_level&quot;,</div><div class="line">  &quot;topic&quot;:  &#123;&#125;,</div><div class="line">  &quot;type&quot;:  &#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>AddReader(topic, callback)</li>
</ul>
<p>a few types/topices supported: </p>
<pre><code>Deteced3DObjectArray, 

Deteced2DObjectArray, 

VehicleControlData, 

Autoware.VehicleCmd, 

TwistStamped, 

Apollo.control_command 
</code></pre><p>which is the list of ros messages that lgsvl can parsing.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">if(!Readers.ContainsKey(topic))</div><div class="line">&#123;</div><div class="line">   Readers.Add(topic, Tuple.Create&lt;Func&lt;JSONNode, object&gt;, List&lt;Action&lt;object&gt;&gt;&gt;(msg=&gt;converter(msg),  new List&lt;Action&lt;object&gt;&gt;()) ) ;</div><div class="line"></div><div class="line">&#125;  </div><div class="line"></div><div class="line">Readers[topic].Item2.Add(msg=&gt;callback(T)msg));</div></pre></td></tr></table></figure>
<p><code>AddReader</code> is the subscriber nodes in lgsvl. in <code>Sensor</code> group, there are three sensors do <code>AddReader</code>: </p>
<pre><code>GroundTruth3DVisualizer 

VehicleControlSensor 

GroudTruth2DVisualizer
</code></pre><p>which means, lgsvl server can read these three typies of messsages. </p>
<p>if there is no rendering/visual needs, only vehicle conroller (acc, brake) message is required for lgsvl. </p>
<ul>
<li>AddWriter(topic)</li>
</ul>
<p>the types/topic supported are: </p>
<pre><code>ImageData, 
PointCloudData, 
Detected3DObjectData, 
Detected2DObjectData, 
SignalDataArray, 
DetectedRadarObjectData, 
CanBusData, 
GpsData, 
ImuData, 
CorrectedImuData, 
GpsOdometryData, 
ClockData
</code></pre><p><code>AddWriter()</code> is a writer adapter, which returns a special type/topic writer/publisher. <code>AddWriter</code> is the publisher nodes in lgsvl, in <code>Sensor</code> group, the following sensors can publish message out:</p>
<pre><code>LidarSensor 
SignalSensor
 GpsInsSensor
GpsOdometrySensor
DepthCameraSensor
ImuSensor
SemanticCameraSensor
GroudTruth2DSensor
CanBusSensor
RadarSensor
GroudTruth3DSensor
ClockSensor
GpsSensor
ColorCameraSensor
</code></pre><ul>
<li>AddService(topic, callback)</li>
</ul>
<ul>
<li>OnMessage(sender, args)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">if (args.op==&quot;publish&quot;)</div><div class="line">&#123;</div><div class="line">   topic = json[&quot;topic&quot;]</div><div class="line">   Readers.TryGetValue(topic, out readerPair)</div><div class="line">   var parse = readerPair.Item1 ; </div><div class="line">   var readers = readerPair.Item2; </div><div class="line">   var msg = parse(json[&quot;msg&quot;]);</div><div class="line">   foreach (var reader in readers)</div><div class="line">   &#123;</div><div class="line">     QueuedActions.Enqueue(()=&gt;reader(msg));   //</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>ros subscriber uses a callback mechanism, when the message is coming, all readers who subscribe this topic will read in this message. </p>
<h4 id="RosWriter-cs"><a href="#RosWriter-cs" class="headerlink" title="RosWriter.cs"></a>RosWriter.cs</h4><p>the message output is in the format as:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123; </div><div class="line">  &quot;op&quot; :  &quot;publish&quot; ,</div><div class="line">  &quot;topic&quot; :  Topic, </div><div class="line">  &quot;msg&quot;:  message </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="websocket-in-ros-bridge"><a href="#websocket-in-ros-bridge" class="headerlink" title="websocket in ros bridge"></a>websocket in ros bridge</h4><p>the implementation of ros bridge in lgsvl is by <code>WebSocket</code>, which maintained a continously communication pipeline, for external ros nodes publishers.</p>
<h2 id="ros-ads-talk-to-lgsvl-rosbridge"><a href="#ros-ads-talk-to-lgsvl-rosbridge" class="headerlink" title="ros ads talk to lgsvl rosbridge"></a>ros ads talk to lgsvl rosbridge</h2><p>from the previous section, lgsvl talk to external ros nodes (which is the ADS stack) through rosbridge, and which needs external inputs, e.g. vehicle control command, 2d/3d ground truth visualizer. and the ADS stack ros nodes can subscribes Gps, canbus, Lidar, Radar, GroudTruth, SemanticCamera, DeepCamera topics through lgsvl rosbrige.</p>
<p>so the pipeline are simple as following:</p>
<pre><code>lgsvl rosbridge  --&gt;  {gps, radar, camera, lidar, groudTruth message} --&gt;  ADS stack nodes 

ADS stack nodes --&gt;  {vehicle control command message} --&gt; lgsvl rosbridge 
</code></pre><p>usually, the ADS stack nodes are a few related ros nodes, including RTK/GPS sensor, Lidar/Camera/Radar sensors, hdmap node, data fusion node e.t.c.</p>
<h4 id="run-ROS-ADS-stack"><a href="#run-ROS-ADS-stack" class="headerlink" title="run ROS ADS stack"></a>run ROS ADS stack</h4><p>the following nodes are used commonly in ADS dev:</p>
<ul>
<li><p>gps_node</p>
<pre><code>subscribe: /gps, /odom e.t.c

publish: /sensor/data topics
</code></pre></li>
<li><p>camera_node</p>
<pre><code>subscribe: /camera/raw_data

publish:  /objects_list,  /lane_object e.t.c
</code></pre></li>
<li><p>radar_node</p>
<pre><code>subscribe:  /radar/raw_data

publish: /obstacle/velocity , /obstacle/distance
</code></pre></li>
<li><p>hdmap_node</p>
<pre><code>subcribe: /rtk/data, /ins/data. 

publish:  /lane/info,  /speed_limit e.t.c.
</code></pre></li>
<li><p>fusion_node </p>
<pre><code>subscribe topics: /canbus, rtk/data, /ifv_lane,  /radar/blind, /radar/corner, /esr, /velodey, /lane/info e.t.c

publish topics: /object_list/, /road/info, /vehicle/status and visual related messages e.t.c.
</code></pre></li>
<li><p>planning_node </p>
<pre><code>subscribe topics:  /object_list,  /road/info, /vehicle/status from fusion_node

publish topics: /vehicle/cmd_ctl 
</code></pre></li>
</ul>
<h4 id="ADS-ros-launch"><a href="#ADS-ros-launch" class="headerlink" title="ADS ros launch"></a>ADS ros launch</h4><p>the previous section has a basic idea about what kind of ROS nodes usually needs to run the ADS stack. In road test or simulaiton test, we prefer a simple way to launch all ADS related nodes in one launch.</p>
<p>which usually give a simple launch file to start all nodes, or a shell script to start each ros nodes sequencially. </p>
<h4 id="system-verification"><a href="#system-verification" class="headerlink" title="system verification"></a>system verification</h4><p>ros is a common solution to package ADS stack and integrate with the simulation env during SIL sysem verification, as well as road test data collection. since ROS is the cheap solution for ADS dev and test, compared to CAEape/Vector, Dspace solution.</p>
<p>on the other hand, due to the hardware computing limitation, drivers depends, and espeically the ros is mostly run in Linux kind of non-realtime OS, which is not good for domain controller(HAD) test. so during the real test envrionment, we need to consider these true issues.</p>
<p>another topic is about how to quick build up a user-friend verification pipeline for, which keeps as little modification as possible, but can run in both simulation verification and physical verification.</p>
<h2 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h2><p><a href="http://wiki.ros.org/ROS/Tutorials" target="_blank" rel="external">ros overview</a></p>
<p><a href="https://msadowski.github.io/ros-web-tutorial-pt1/" target="_blank" rel="external">understand rosbridge:  simple ROS UI</a></p>
<p><a href="http://wiki.ros.org/roslibjs/Tutorials/BasicRosFunctionality" target="_blank" rel="external">roslibjs</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/29/mobile-vehicle-interface/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/29/mobile-vehicle-interface/" itemprop="url">mobile vehicle interface</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-12-29T08:00:38-05:00">
                2019-12-29
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/12/29/mobile-vehicle-interface/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/12/29/mobile-vehicle-interface/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="background"><a href="#background" class="headerlink" title="background"></a>background</h2><p>human-machine interface(HMI), in-vehicle device(IVD).</p>
<p>human-vehicle interface(HVI), e.g. voice control, touch screen, face detection, e.t.c, which does well for young and passion generation, who have great voice, sharp fingers, and good-look face, and all these improving user experienced tech are based on similar AI. </p>
<p>what about the elders ? which should be, in the next 10 - 20 years, the most tough family and society issues in China, and as well as for Japan right now. </p>
<p>the basicaly option here is HVI is not enough for the elders groups, or at least is not the only choice for elders, who don’t have great voice, good-look face, or sharp fingers, and even no patient to talk/look/touch with the weak AI system. a very good alternative or additional supportting solution should be mobility vehicle interface(MVI)</p>
<h2 id="mobility-vehicle-interface"><a href="#mobility-vehicle-interface" class="headerlink" title="mobility vehicle interface"></a>mobility vehicle interface</h2><h4 id="what-kind-of-mobility-device"><a href="#what-kind-of-mobility-device" class="headerlink" title="what kind of mobility device"></a>what kind of mobility device</h4><p>mobility is a general name, for all kinds of mobile devices, especially for Iphone, Android smart phone and personal care robot. </p>
<h4 id="application-scenarios"><a href="#application-scenarios" class="headerlink" title="application scenarios"></a>application scenarios</h4><p>for an elder, who has daily needs for traffic transfer. e.g. go to hospital, to supermarket, to a special restuarant or a park for dinner or sit down with some old friends. </p>
<p>the elders are slow in movement and talk, and the current AI based human-vehicle-interface(HVI) definitely make the elders feel pressure.</p>
<p>a better or alternative solution is let the mobility device to talk to the vehicle, through an interface </p>
<h4 id="mobility-vehicle-interface-1"><a href="#mobility-vehicle-interface-1" class="headerlink" title="mobility vehicle interface"></a>mobility vehicle interface</h4><p>the mobility vehicle interface(MVI) can be based on existing vehicle OS and mobility OS. there are plenty existing in-vehicle OS, e.g. CarPlayer, Baidu OS, GENIV, QNX e.t.c; and on mobility OS side, the most common are iOS and Andriod.</p>
<p>most in-vehicle OS can run the same apps on mobility OS, e.g. google navigation map, instant messages, music, emergency call service e.t.c.</p>
<p>so the first solution is app2app. basically the same app ran in the personal mobility device(PMD) talk to the same app run in vehicle OS. </p>
<p>PMD has more time with the owner, so has more personality than vehicle, especially as vehicle in future is more like a public service, rather than a personal asset. </p>
<p>that’s why mobility vehicle interface(MVI) is a good option, especially for elders, who may not enjoy talk to AI.</p>
<p>beyond the easy to implement at this moment, app2app solution has a few limitations:</p>
<ul>
<li><p>the security is mainly provided by the app supplier, which is not a unit solution, as different app suppliers have different security mechanism.</p>
</li>
<li><p>as apps hosted in this system is growing, the adapters or interfaces to make the bridge grows too, which decrease the user experince and increase the system cost.</p>
</li>
</ul>
<p>so a better solution is a new mobility-vehicle interface protocol, which is the only bridge between personal mobility and vehicles. and no matter what kind of apps and how many apps hosts in both system, won’t be a burden for the sytem anymore.</p>
<h4 id="moblity-vehicle-interface-protocol"><a href="#moblity-vehicle-interface-protocol" class="headerlink" title="moblity vehicle interface protocol"></a>moblity vehicle interface protocol</h4>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="David Z.J. Lee" />
          <p class="site-author-name" itemprop="name">David Z.J. Lee</p>
           
              <p class="site-description motion-element" itemprop="description">what I don't know</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">169</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">45</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/ZJLi2013" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.linkedin.com/in/zhengjia13/" target="_blank" title="LinkedIn">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  LinkedIn
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">David Z.J. Lee</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://zjlee.disqus.com/count.js" async></script>
    

    

  




	





  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
