<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="what I don&apos;t know">
<meta property="og:type" content="website">
<meta property="og:title" content="Serious Autonomous Vehicles">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="Serious Autonomous Vehicles">
<meta property="og:description" content="what I don&apos;t know">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Serious Autonomous Vehicles">
<meta name="twitter:description" content="what I don&apos;t know">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/3/"/>





  <title>Serious Autonomous Vehicles</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Serious Autonomous Vehicles</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/28/services-deploy-in-docker-swarm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/28/services-deploy-in-docker-swarm/" itemprop="url">services deploy in docker swarm</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-04-28T08:54:49-04:00">
                2020-04-28
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/04/28/services-deploy-in-docker-swarm/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/04/28/services-deploy-in-docker-swarm/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="backgroud"><a href="#backgroud" class="headerlink" title="backgroud"></a>backgroud</h2><p>our application so far includes the following three services:</p>
<ul>
<li><p>simulator</p>
</li>
<li><p>pythonAPI</p>
</li>
<li><p>redisJQ</p>
</li>
</ul>
<p><strong>docker swarm network</strong> has the following three kind of networks, of course <code>bridge</code> to host network.</p>
<ul>
<li><p>overlay network, services in the same overlay network, can communicate to each other </p>
</li>
<li><p>routing network, the service requested can be hosted in any of the running nodes, further as load balancer.</p>
</li>
<li><p>host network </p>
</li>
</ul>
<p>usually,  <a href="https://docs.microsoft.com/en-us/dotnet/architecture/microservices/multi-container-microservice-net-applications/multi-container-applications-docker-compose" target="_blank" rel="external">multi-container apps can be deployed with docker-compose.yml</a>, check <a href="https://docs.docker.com/compose/compose-file/" target="_blank" rel="external">docker compse</a> for more details.</p>
<h2 id="DNS-service-discovery"><a href="#DNS-service-discovery" class="headerlink" title="DNS service discovery"></a>DNS service discovery</h2><p>the following is an example from (<a href="https://github.com/docker/labs/blob/master/networking/A3-overlay-networking.md" target="_blank" rel="external">overlay networking and service discovery</a>:</p>
<p>my test env includes 2 nodes, with host IP as following. when running docker services, it will generate a responding virtual IP, while which is dynamic assgined. </p>
<table>
<thead>
<tr>
<th>hostname</th>
<th>virtualIP</th>
<th>hostIP</th>
</tr>
</thead>
<tbody>
<tr>
<td>node1</td>
<td>10.0.0.4</td>
<td>xx.20.181.132</td>
</tr>
<tr>
<td>node2</td>
<td>10.0.0.2</td>
<td>xx.20.180.212</td>
</tr>
</tbody>
</table>
<p>a common issue when try first to use overlay network in swarm, e.g. ping the other service doesn’t work, check <code>/etc/resolv.conf</code> file: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cat /etc/resolv.conf </span></div><div class="line">nameserver 8.8.8.8</div><div class="line">nameserver 8.8.4.4</div><div class="line">``` </div><div class="line"></div><div class="line">the default `dns=8.8.8.8` can<span class="string">'t ping either hostIP or any docker0 IP. the reason can find [#moby/#23910](https://github.com/moby/moby/issues/23910): When spinning up a container, Docker will by default check for a DNS server defined in /etc/resolv.conf in the host OS, and if it doesn'</span>t find one, or finds only 127.0.0.1, will opt to use Google<span class="string">'s public DNS server 8.8.8.8. </span></div><div class="line"></div><div class="line">one solution mentioned:</div><div class="line"></div><div class="line">* cat /etc/docker/daemon.json </div><div class="line"></div><div class="line">```xml</div><div class="line">&#123;</div><div class="line"></div><div class="line">		"dns": ["172.17.0.1", "your.dns.server.ip", "8.8.8.8"]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>add a file <code>/etc/NetworkManager/dnsmasq.d/docker-bridge.conf</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">listen-address=172.17.0.1</div></pre></td></tr></table></figure>
<p>so basically, the default DNS setting only listens to DNS requests from 127.0.0.1 (ie, your computer). by adding <code>listen-address=172.17.0.1</code>, it tells it to listen to the docker bridge also. very importantly, <strong>Docker DNS server is used only for the user created networks</strong>, so need create a new docker network. if use the default <code>ingress</code> overlay network, the dns setup above still doesn’t work.</p>
<p>another solution is using <strong>host network</strong>, mentioned <a href="https://l-lin.github.io/post/2018/2018-09-03-docker_ubuntu_18_dns/" target="_blank" rel="external">using host DNS in docker container with Ubuntu</a> </p>
<h4 id="test-virtualIP-network"><a href="#test-virtualIP-network" class="headerlink" title="test virtualIP network"></a>test virtualIP network</h4><ul>
<li>create a new docker network</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker network create -d overlay l3</div></pre></td></tr></table></figure>
<p>why here need a new network ?  due to <strong>Docker DNS server(172.17.0.1) is used only for the user created networks</strong></p>
<ul>
<li>start the service with the created network: </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">docker service create --name lg --replicas 2 --network l3 20.20.180.212:5000/lg</div><div class="line">``` </div><div class="line"></div><div class="line">* check vip on both nodes</div><div class="line"></div><div class="line">```sh</div><div class="line"> docker network inspect l3</div></pre></td></tr></table></figure>
<p>check vip by the line <code>IPv4Address</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">node1 vip : `10.0.1.5/24`</div><div class="line">node2 vip: `10.0.1.6/24`</div></pre></td></tr></table></figure>
<ul>
<li>go to the running container </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">docker <span class="built_in">exec</span> -it 788e667ea9cb  /bin/bash </div><div class="line">apt-get update &amp;&amp; apt-get install iputils-ping</div><div class="line">ping 10.0.1.5</div><div class="line">ping 10.0.1.6</div></pre></td></tr></table></figure>
<ul>
<li>now ping service-name directly </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ping lg </div><div class="line">PING lg (10.0.1.2) 56(84) bytes of data.</div></pre></td></tr></table></figure>
<ul>
<li>inspect service </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">docker service inspect lg </div><div class="line">            <span class="string">"VirtualIPs"</span>: [</div><div class="line">                &#123;</div><div class="line">                    <span class="string">"Addr"</span>: <span class="string">"10.0.1.2/24"</span></div><div class="line">                &#125;</div><div class="line">            ]</div></pre></td></tr></table></figure>
<ul>
<li>ping host IP from contianer vip</li>
</ul>
<p>as far as we add both <code>host dns</code> and <code>docker0 dns</code> to the dns option in <code>/etc/docker/daemon.json</code>, the container vip can ping host IP.</p>
<h4 id="assign-ENV-variable-from-script"><a href="#assign-ENV-variable-from-script" class="headerlink" title="assign ENV variable from script"></a>assign ENV variable from script</h4><ul>
<li>get services vip </li>
</ul>
<p><a href="https://serverfault.com/questions/925267/how-do-i-list-docker-vip-addresses" target="_blank" rel="external">get vip list</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">vip=`sudo docker service inspect --format <span class="string">'&#123;&#123;.Endpoint.VirtualIPs&#125;&#125;'</span>  lgsvl | awk <span class="string">'&#123;print substr($2, 1, length($2)-5)&#125;'</span>`</div><div class="line"><span class="built_in">echo</span> <span class="variable">$vip</span></div></pre></td></tr></table></figure>
<ul>
<li>create docker service with runtime env</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">ping -c 1 lg  | awk <span class="string">'NR==1 &#123;print $2&#125;'</span> </div><div class="line">``` </div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">## multi-services test</span></div><div class="line"></div><div class="line"><span class="comment">#### run all services in single docker mode</span></div><div class="line"></div><div class="line">```sh</div><div class="line">docker run -it -p 6379:6379 --mount <span class="built_in">source</span>=jq-vol,target=/job_queue redisjq /bin/bash </div><div class="line">docker run xx.xx.xx.xxx:5000/lg</div><div class="line">docker run -it --mount <span class="built_in">source</span>=jq-vol,target=/pythonAPI/job_queue xx.xx.xx.xxx:5000/redispythonapi  /bin/bash</div></pre></td></tr></table></figure>
<ul>
<li>check docker-IP of <code>lg</code> :</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">docker sh </div><div class="line">docker container inspect &lt;lg&gt; <span class="comment">#get its IP-address</span></div></pre></td></tr></table></figure>
<ul>
<li>update <code>SIMULATOR_HOST</code> for <code>redispythonapi</code> </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">docker <span class="built_in">exec</span> -it &lt;redispythonapi&gt; /bin/bash</div><div class="line"><span class="built_in">export</span> SIMULATOR_HOST=lg_ip_address <span class="comment">#from the step above</span></div><div class="line">./redis_worker.sh  <span class="comment">#where all python scenarios are running in queue</span></div></pre></td></tr></table></figure>
<p>here we can check the lg container’s IP is <code>172.17.0.3</code> and redispythonapi’s IP is <code>172.17.0.4</code>, then update <code>start_redis_worker.sh</code> with <code>SIMULATOR_HOST=172.17.0.3</code></p>
<ul>
<li>get the container IP</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">docker container ls  | grep -w xx.xx.xx.xxx:5000/lg | awk <span class="string">'&#123;print $1&#125;'</span> </div><div class="line">docker inspect --format=<span class="string">'&#123;&#123;range .NetworkSettings.Networks&#125;&#125;&#123;&#123;.IPAddress&#125;&#125;&#123;&#123;end&#125;&#125;'</span>  $(docker container ls  | grep -w xx.xx.xx.xxx:5000/lg | awk <span class="string">'&#123;print $1&#125;'</span> )</div></pre></td></tr></table></figure>
<h2 id="assign-a-special-IP-to-service-in-swarm"><a href="#assign-a-special-IP-to-service-in-swarm" class="headerlink" title="assign a special IP to service in swarm"></a>assign a special IP to service in swarm</h2><p>docker network create support <a href="https://docs.docker.com/engine/reference/commandline/network_create/" target="_blank" rel="external">subnet</a>, which only ip-addressing function, namely we can use custom-defined virtual IP for our services. a sample: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">docker network create -d overlay \</div><div class="line">  --subnet=192.168.10.0/25 \</div><div class="line">  --subnet=192.168.20.0/25 \</div><div class="line">  --gateway=192.168.10.100 \</div><div class="line">  --gateway=192.168.20.100 \</div><div class="line">  --aux-address=<span class="string">"my-router=192.168.10.5"</span> --aux-address=<span class="string">"my-switch=192.168.10.6"</span> \</div><div class="line">  --aux-address=<span class="string">"my-printer=192.168.20.5"</span> --aux-address=<span class="string">"my-nas=192.168.20.6"</span> \</div><div class="line">  my-multihost-network</div><div class="line">``` </div><div class="line"></div><div class="line">we can run our application as:</div><div class="line"></div><div class="line">```sh</div><div class="line">docker network create --driver=overlay --subnet=192.168.10.0/28  lgsvl-net</div><div class="line">docker service create --name lgsvl --replicas 2 --network lgsvl-net --host <span class="string">"host:192.168.10.2"</span>  xx.xx.xx.xxx:5000/lgsvl</div><div class="line">docker service create --name redis --replicas 1 --network lgsvl-net  -p 6379:6379 --mount <span class="built_in">source</span>=jq-vol,target=/job_queue  --constraint <span class="string">'node.hostname==ubuntu'</span> xx.xx.xx.xxx:5000/redisjq</div><div class="line">docker service create --name pythonapi --replicas 1 --network lgsvl-net --mount <span class="built_in">source</span>=jq-vol,target=/pythonAPI/job_queue  xx.xx.xx.xxx:5000/redispythonapi</div></pre></td></tr></table></figure>
<p><a href="https://www.cnblogs.com/milantgh/p/4075912.html" target="_blank" rel="external">understand subnet mask</a>. IP address include <code>master IP</code> and <code>subnet mask</code>, we choose <code>28</code> here, basically generate about <code>2^(32-28)-2= 14</code> avaiable IP address in the subnet. but in a swarm env, subnet IPs are consuming more as the nodes or replicas of service increase.</p>
<p>taking an example, with 2-nodes and 2-replicas of service, <strong>5 subnet IPs are occupied, rather than 2</strong></p>
<p>run <code>docker network inspect lgsvl-net</code> on both nodes:</p>
<ul>
<li>on node1 gives:</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">lg.1 IPV4Address: 192.168.10.11/28</div><div class="line">lgssvl-net-endpoint: 192.168.10.6/28</div></pre></td></tr></table></figure>
<ul>
<li>on node2 gives:</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">lg.2 IPV4Address: 192.168.10.4/28</div><div class="line">lgssvl-net-endpoint: 192.168.10.3/28</div><div class="line">``` </div><div class="line"></div><div class="line">* `docker service inspect lg` gives:</div><div class="line"></div><div class="line">```xml</div><div class="line">VirualIPs: 192.168.10.2/28</div></pre></td></tr></table></figure>
<p>clearly 5 IP address are occupied. and the IP for each internal service is random picked, there is no gurantee <code>service</code> will always get the first avaiable IP. </p>
<h4 id="docker-serivce-with-–ip"><a href="#docker-serivce-with-–ip" class="headerlink" title="docker serivce with –ip"></a>docker serivce with –ip</h4><p><strong>only docker run –ip</strong> works, there is no similar <code>--ip</code> option in <code>docker service create</code>. but a lot case require this feature: <a href="https://success.docker.com/article/how-do-i-publish-a-service-port-to-a-specific-ip-address" target="_blank" rel="external">how to publish a service port to a specific IP address</a>,  when publishing a port using <code>--publish</code>, the port is published to <code>0.0.0.0</code> instead of a specific interface’s assigned IP. and there is no way to assign an fixed IP to a service in swarm. </p>
<p>a few disscussion in <a href="https://github.com/moby/moby/issues/26696" target="_blank" rel="external">moby/#26696</a>, <a href="https://github.com/moby/moby/issues/25303" target="_blank" rel="external">add more options to `service create</a>, <a href="https://github.com/moby/moby/issues/24170#issuecomment-300771012" target="_blank" rel="external">a possible solution</a>, <a href="https://github.com/moby/moby/issues/24170" target="_blank" rel="external">Static/Reserved IP addresses for swarm services</a></p>
<p>mostly depend on the issues like “ip address is not known in advance, since docker service launched in swarm mode will end up on multiple docker servers”. there should not be applicable to docker swarm setup, since if one decides to go with docker swarm service, has to accept that service will run on multiple hosts with different ip addresses. I.e. trying to attach service / service instance to specific IP address somewhat contradicting with docker swarm service concept. </p>
<p><a href="https://docs.docker.com/engine/reference/commandline/service_create/" target="_blank" rel="external">docker service create</a> does have options <code>--host host:ip-address</code> and <code>--hostname</code> and similar in <a href="https://docs.docker.com/engine/reference/commandline/service_update/" target="_blank" rel="external">docker service update</a>  support <code>host-add</code> and <code>host-rm</code>.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">$ docker service create --name redis --host <span class="string">"redishost:192.168.10.2"</span> --hostname myredis redis:3.0.6</div><div class="line">``` </div><div class="line"></div><div class="line"><span class="keyword">then</span> <span class="built_in">exec</span> into the running container, we can check out `192.168.10.2 redishost` is one line <span class="keyword">in</span> `/etc/hosts` and `myredis` is <span class="keyword">in</span> `/etc/hostname`</div><div class="line"></div><div class="line">but remember, the DNS <span class="keyword">for</span> this hostIP(192.168.10.2) should be first configured <span class="keyword">in</span> the docker engine DNS list. <span class="keyword">if</span> not, even the hostIP is <span class="keyword">in</span> the arrange of the subnet, it is unreachable from the containers.</div><div class="line"></div><div class="line">[another explain](https://www.freecodecamp.org/news/docker-nginx-letsencrypt-easy-secure-reverse-proxy-40165ba3aee2/): by default docker containers are put on their own network. This means that you won’t be able to access your container by it’s hostname, <span class="keyword">if</span> you’re sitting on your laptop on your host network. It is only the containers that are able to access each other through their hostname.</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#### dnsrr vs vip </span></div><div class="line"></div><div class="line">```sh</div><div class="line">--endpoint-mode dnsrr</div></pre></td></tr></table></figure>
<p><code>dnsrr</code> mode, namely DNS round Robin mode, when query Docker’s internal DNS server to get the IP address of the service, it will return IP address of every node running the service.</p>
<p><code>vip</code> mode, return the IP address of only one of the running cntainers. </p>
<p>When you submit a DNS query for a service name to the Swarm DNS service, it will return one, or all, the IP addresses of the related containers, depending on the endpoint-mode.</p>
<p><a href="https://stackoverflow.com/questions/42875572/how-to-load-balance-websocket-apps-in-docker-swarm" target="_blank" rel="external">dnsrr vs vip</a>: Swarm defaults to use a virtual ip (endpoint-mode vip). So each service gets its own IP address, and the swarm load balancer assigns the request as it sees fit; to prevent a service from having an IP address, you can run <code>docker service update your_app --endpoint-mode dnsrr</code>, which will allow an internal load balancer to <code>run a DNS query against a service name</code>, to discover each task/container’s IP for a given service</p>
<p>in our case, we want to assign a speical IP to the service in swarm. <strong>why?</strong> because our app has websocket server/client communicataion, which is IP address based. we can’ assign <code>service name</code> for WS server/client.</p>
<p>check another issue: <a href="https://stackoverflow.com/questions/54101508/how-do-you-dockerize-a-websocket-server" target="_blank" rel="external">dockerlize a websocket server</a></p>
<h2 id="global-mode-to-run-swarm"><a href="#global-mode-to-run-swarm" class="headerlink" title="global mode to run swarm"></a>global mode to run swarm</h2><p>when deploying service with global mode, namely each node will only run one replicas of the service. the benefit of <code>global mode</code> is we can always find the node IP, no matter the IP address is in host network or user-defined overlay network/subnetwork. </p>
<h4 id="get-service’s-IP-in-global-mode"><a href="#get-service’s-IP-in-global-mode" class="headerlink" title="get service’s IP in global mode"></a>get service’s IP in global mode</h4><p><a href="https://www.cyberciti.biz/faq/unix-linux-check-if-port-is-in-use-command/" target="_blank" rel="external">get listened port</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">root@c7279faebefa:/lgsvl<span class="comment"># netstat -tulpn | grep LISTEN</span></div><div class="line">tcp        0      0 127.0.0.11:33263        0.0.0.0:*               LISTEN      -               </div><div class="line">tcp        0      0 0.0.0.0:8080            0.0.0.0:*               LISTEN      7/lgsvl_Core.x86_64</div><div class="line">tcp        0      0 0.0.0.0:8181            0.0.0.0:*               LISTEN      7/lgsvl_Core.x86_64</div></pre></td></tr></table></figure>
<p>both <code>8080</code> and <code>8181</code> is listening after <code>lgsvl</code> service started. on the <code>lgsvl</code> side, we can modify it to listen on all address with <code>8181</code> port. then the following <a href="https://www.jb51.net/article/173931.htm" target="_blank" rel="external">python script</a> to find node’s IP:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> socket</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_host_ip</span><span class="params">()</span>:</span></div><div class="line">  <span class="keyword">try</span>:</div><div class="line">    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</div><div class="line">    s.connect((<span class="string">'8.8.8.8'</span>, <span class="number">80</span>))</div><div class="line">    ip = s.getsockname()[<span class="number">0</span>]</div><div class="line">  <span class="keyword">finally</span>:</div><div class="line">    s.close()</div><div class="line"> </div><div class="line">  <span class="keyword">return</span> ip</div></pre></td></tr></table></figure>
<p>in this way, no need to pre-define the <code>SIMULATOR_HOST</code> env variable at first. the pythonAPI only need to find out its own IP and detect if <code>8181</code> is listening on in runtime.</p>
<h4 id="container-vs-service"><a href="#container-vs-service" class="headerlink" title="container vs service"></a>container vs service</h4><p><a href="https://stackoverflow.com/questions/43408493/what-is-the-difference-between-docker-service-and-docker-container" target="_blank" rel="external">difference between service and container</a>:</p>
<ul>
<li><p><code>docker run</code> is used to create a standalone container</p>
</li>
<li><p><code>docker service</code> is the one run in a distributed env. when create a service, you specify which container image to use and which commands to execue inside the running containers. </p>
</li>
</ul>
<p>There is only one command(no matter the format is <code>CMD</code> <code>ENTRYPOINT</code> or <code>command in docker-compose</code>) that docker will run to start your container, and when that command exits, the container exits. in swarm service mode, with default restart option(any), the container run and exit and restart again with a different containeID. check <a href="https://stackoverflow.com/questions/56328330/dockerfile-docker-compose-and-swarm-mode-lifecycle" target="_blank" rel="external">dockerfile, docker-compose and swarm mode lifecycle</a> for details. </p>
<h4 id="docker-container-restart-policy"><a href="#docker-container-restart-policy" class="headerlink" title="docker container restart policy:"></a><a href="https://rollout.io/blog/ensuring-containers-are-always-running-with-dockers-restart-policy/" target="_blank" rel="external">docker container restart policy</a>:</h4><p><a href="https://docs.docker.com/config/containers/start-containers-automatically/" target="_blank" rel="external">docker official doc: start containers automatically</a></p>
<ul>
<li><p>no, simply doesn’t restart under any circumstance </p>
</li>
<li><p>on-failure, to restart if the exit code has error. user can specify a maximum number of times Docker will automatically restart the container; the container will not restart when app exit with a successful exit code. </p>
</li>
<li><p>unless-stopped, only stop when Docker is stopped. so most time, this policy work exactly like <code>always</code>, one exception, when a container is stopped and the server is reboot or the DOcker serivce is restarted, the container won’t restart itself. if the container was running before the reboot, the container would be restarted once the system restarted.</p>
</li>
<li><p>always, tells Docker to restart the container under any circumstance. and the service will restart even with reboot. any other policy can’t restart when system reboot.</p>
</li>
</ul>
<p>similar restart policy can be found in :</p>
<ul>
<li><a href="https://docs.docker.com/compose/compose-file/#restart_policy" target="_blank" rel="external">docker-compose restart policy</a></li>
</ul>
<ul>
<li><a href="https://docs.docker.com/engine/reference/commandline/service_create/" target="_blank" rel="external">docker service create restat-condition</a></li>
</ul>
<h4 id="keep-redisJQ-alive-in-python-script"><a href="#keep-redisJQ-alive-in-python-script" class="headerlink" title="keep redisJQ alive in python script"></a>keep redisJQ alive in python script</h4><p>by default setup, <code>redis server</code> is keep restarting and running, which make the <code>pythonapi</code> service always report: <code>redis.exceptions.ConnectionError: Error 111 connecting to xx.xxx.xxx:6379. Connection refused.</code></p>
<p>so we can keep redisJQ alive in python script level by simply a <code>while loop</code>.</p>
<p>for test purpose, we also make pythonAPI restart policy as none, so the service won’t automatically run even with empty jobQueue.</p>
<p>the final test script can run in the following:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">docker service create --name lgsvl --network lgsvl-net --mode global xx.xx.xx.xxx:5000/lgsvl</div><div class="line">docker service create --name redis -p 6379:6379 --network lgsvl-net --mount <span class="built_in">source</span>=jq-vol,target=/job_queue  --constraint <span class="string">'node.hostname==ubuntu'</span> xx.xx.xx.xxx:5000/redisjq </div><div class="line">docker service create --name pythonapi --network lgsvl-net --mode global --mount <span class="built_in">source</span>=jq-vol,target=/pythonAPI/job_queue --restart-condition none xx.xx.xx.xxx:5000/pythonapi</div></pre></td></tr></table></figure>
<h4 id="use-python-variable-in-os-system"><a href="#use-python-variable-in-os-system" class="headerlink" title="use python variable in os.system"></a>use python variable in os.system</h4><p><a href="https://stackoverflow.com/questions/27128851/how-to-use-python-variable-in-os-system" target="_blank" rel="external">sample</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">os.system(<span class="string">"ls -lt %s"</span>%your_py_variable)</div></pre></td></tr></table></figure>
<h2 id="proxy-in-docker-swarm"><a href="#proxy-in-docker-swarm" class="headerlink" title="proxy in docker swarm"></a>proxy in docker swarm</h2><p><a href="https://www.haproxy.com/blog/haproxy-on-docker-swarm-load-balancing-and-dns-service-discovery/" target="_blank" rel="external">HAProxy</a></p>
<p>Routing external traffic into the cluster, load balancing across replicas, and DNS service discovery are a few capabilities that require finesse. but proxy can’t either assign a special IP to a special service, neither can expose the service with a fixed IP, so in our case, no helpful.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/28/redis-task-queue-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/28/redis-task-queue-2/" itemprop="url">redis task queue (2)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-04-28T08:52:02-04:00">
                2020-04-28
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/04/28/redis-task-queue-2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/04/28/redis-task-queue-2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="background"><a href="#background" class="headerlink" title="background"></a>background</h2><p>currently, we add <code>job_queue</code> list inside Dockerfile by <code>COPY</code> the <code>job_queue</code> folder from local host to the docker image, which is not dynamically well, and can’t support additionaly scenarios.</p>
<p>to design a <code>redisJQ</code> service that can used in swarm/k8s env, need consider <code>DNS</code> to make the servie available and <code>shared volume</code> to share the data in job queue to other services. </p>
<h4 id="ceph-rbd-driver-for-docker"><a href="#ceph-rbd-driver-for-docker" class="headerlink" title="ceph rbd driver for docker"></a>ceph rbd driver for docker</h4><p>ceph can store files in three ways:</p>
<ul>
<li><p>rbd, block storage, which usually used with virtualization kvm</p>
</li>
<li><p>object storage, through <code>radosgw</code> api, or access by boto3 APIs. </p>
</li>
<li><p>cephfs, mount ceph as file system</p>
</li>
</ul>
<p>the first idea is from local host mount to remote volume(e.g. ceph storage) mount. there are a few popular <a href="https://ceph.io/geen-categorie/getting-started-with-the-docker-rbd-volume-plugin/" target="_blank" rel="external">rbd-drive plugins</a>: </p>
<ul>
<li><p><a href="https://github.com/yp-engineering/rbd-docker-plugin" target="_blank" rel="external">Yp engineering</a></p>
</li>
<li><p>AcalephStorage </p>
</li>
<li><p>Volplugin</p>
</li>
<li><p><a href="https://rexray.readthedocs.io/en/stable/" target="_blank" rel="external">rexray.io</a></p>
</li>
</ul>
<p>check <a href="https://ceph.com/geen-categorie/getting-started-with-the-docker-rbd-volume-plugin/" target="_blank" rel="external">ceph rbd driver</a> to understand more details. </p>
<p>to support rbd-driver plugin in docker, the ceph server also need support block device driver, which sometime is not avaiable, as most small ceph team would support one or another type, either objec storage or block storage. and that’s our situation. so we can’t go with <code>rbd-driver plugin</code>.</p>
<p>another way is to use <a href="https://gitlab.com/n0r1sk/docker-volume-cephfs" target="_blank" rel="external">docker volume cephfs</a>, similar reason our ceph team doesn’t support <code>cephfs</code>.  </p>
<h4 id="ceph-object-storage-access"><a href="#ceph-object-storage-access" class="headerlink" title="ceph object storage access"></a>ceph object storage access</h4><p>as the ceph team can support boto3 API to access ceph, which gives us the one and only way to access scenarios: boto3.</p>
<p>basically the <code>redis_JQ</code> first download all scenaio files from remote ceph through boto3 APIs, then scan the downloaded files into JQ, then feed into the python executors in front.</p>
<h4 id="s3-client"><a href="#s3-client" class="headerlink" title="s3 client"></a>s3 client</h4><ul>
<li><a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-welcome.html" target="_blank" rel="external">aws cli</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">curl <span class="string">"https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip"</span> -o <span class="string">"awscliv2.zip"</span></div><div class="line">unzip awscliv2.zip</div><div class="line">sudo ./aws/install</div><div class="line">/usr/<span class="built_in">local</span>/bin/aws --version</div></pre></td></tr></table></figure>
<ul>
<li><a href="https://github.com/s3tools/s3cmd" target="_blank" rel="external">s3cmd</a></li>
</ul>
<h4 id="access-files-in-folders-in-s3-bucket"><a href="#access-files-in-folders-in-s3-bucket" class="headerlink" title="access files in folders in s3 bucket"></a>access files in folders in s3 bucket</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_files</span><span class="params">(self, bucket_name, folder_name)</span>:</span></div><div class="line">    files_with_prefix = self.s3_client.list_objects_v2(Bucket=bucket_name, Prefix=folder_name)</div><div class="line">    scenario_basename = <span class="string">"/pythonAPI/job_queue/scenario"</span></div><div class="line">    i = <span class="number">0</span> </div><div class="line">    <span class="keyword">for</span> file_ <span class="keyword">in</span> files_with_prefix[<span class="string">"Contents"</span>]:</div><div class="line">        scenario_name = scenario_basename + <span class="string">"%d"</span>%i + <span class="string">".py"</span></div><div class="line">        print(scenario_name)</div><div class="line">        self.download_file(bucket_name, file_[<span class="string">'Key'</span>], scenario_name, <span class="keyword">False</span>)</div><div class="line">        time.sleep(<span class="number">0.01</span>)</div><div class="line">        i += <span class="number">1</span></div></pre></td></tr></table></figure>
<h2 id="manage-python-modules"><a href="#manage-python-modules" class="headerlink" title="manage python modules"></a>manage python modules</h2><p>during the project, we really need take care python packages installed by <code>apt-get</code>, <code>pip</code> and <code>conda</code>, if not there will conflicts among different version of modules:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">import websockets</div><div class="line">Trackbac:</div><div class="line">  File <span class="string">"/usr/lib/python3/dist-packages/websockets/compatibility.py"</span>, line 8</div><div class="line">    asyncio_ensure_future = asyncio.async           <span class="comment"># Python &lt; 3.5</span></div></pre></td></tr></table></figure>
<p>so it’s better to use conda or python virtual-env to separate the different running envs. and install packages by <code>conda install</code> is better choice, than the global <code>apt-get install</code>:</p>
<ul>
<li><p><a href="https://anaconda.org/conda-forge/websockets" target="_blank" rel="external">conda install ws</a></p>
</li>
<li><p><a href="https://anaconda.org/anaconda/pandas" target="_blank" rel="external">conda install pandas</a> </p>
</li>
<li><p><a href="https://github.com/danielhrisca/asammdf" target="_blank" rel="external">conda install asammdf</a></p>
</li>
<li><p><a href="https://anaconda.org/conda-forge/botocore" target="_blank" rel="external">conda install botocore</a></p>
</li>
<li><p><a href="https://anaconda.org/anaconda/sqlalchemy" target="_blank" rel="external">conda install sqlalchemy</a> </p>
</li>
<li><p><a href="https://anaconda.org/anaconda/websocket-client" target="_blank" rel="external">conda install websocket-client</a></p>
</li>
<li><p><a href="https://anaconda.org/anaconda/redis" target="_blank" rel="external">conda install redis</a></p>
</li>
<li><p><a href="https://anaconda.org/anaconda/boto3" target="_blank" rel="external">conda install boto3</a></p>
</li>
</ul>
<h4 id="basic-of-python-import"><a href="#basic-of-python-import" class="headerlink" title="basic of python import"></a>basic of python import</h4><ul>
<li><p>module,  any <code>*.py</code> file, where its name is the file name </p>
</li>
<li><p>package,  any folder containing a file named <code>__init__.py</code> in i, its name is the name of the folder.</p>
</li>
</ul>
<p>When a module named <code>module1</code> is imported, the interpreter first searches for a built-in module with that name. If not found, it then searches for a file named <code>module1.py</code> or a folder named <code>module1</code> in a list of directories given by the variable <code>sys.path</code></p>
<p><code>sys.path</code> is initialized from 3 locations:</p>
<ul>
<li><p>the directory containing the input script, or the current directory</p>
</li>
<li><p><code>PYTHONPATH</code> </p>
</li>
<li><p>the installation-dependent default</p>
</li>
</ul>
<p>if using <code>export PYTHONPATH</code> directly, it works. but once defined in <code>~/.bashrc</code> it doesn’t actually triggered in <code>conda</code> env.<br>it simpler to add the root directory of the project to the <code>PYTHONPATH</code> environment variable and then running all the scripts from that directory’s level and changing the import statements accordingly. <code>import</code> search for your packages in specific places, listed in sys.path. and The current directory is always appended to this list</p>
<h2 id="redis-service"><a href="#redis-service" class="headerlink" title="redis service"></a>redis service</h2><p>the common error: <code>redis.exceptions.ConnectionError: Error 111 connecting to 10.20.181.132:6379. Connection refused.</code> , which basically means the system can’t connect to redis server, due to by default redis <a href="https://www.cnblogs.com/likwo/p/5903377.html" target="_blank" rel="external">only allow localhost</a> to access. so we need configure non-localhost IP to access redis db. </p>
<ul>
<li>check redis-server running status </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ps aux | grep redis-server</div><div class="line">netstat -tunple | grep 6379</div><div class="line">redis-cli info</div></pre></td></tr></table></figure>
<ul>
<li>shutdown redis-server</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo <span class="built_in">kill</span> -9 <span class="variable">$pid</span></div></pre></td></tr></table></figure>
<h4 id="redis-server-amp-redis-cli"><a href="#redis-server-amp-redis-cli" class="headerlink" title="redis-server &amp; redis-cli"></a>redis-server &amp; redis-cli</h4><p><code>redis-server</code> start redis server with a default config file at <code>/etc/redis/redis.config</code></p>
<p>a few item in the configure file need take care:</p>
<ul>
<li>bind, check <a href="https://stackoverflow.com/questions/16120287/redis-bind-to-more-than-one-ip" target="_blank" rel="external">here</a></li>
</ul>
<p>the default setting is to <code>bind 127.0.0.1</code>,which means redis db is stored and only can be access through <code>localhost</code>.  for our case, to allow hostIP(10.20.181.132), or even any IP to access, need :</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bind 0.0.0.0</div></pre></td></tr></table></figure>
<ul>
<li>redislog, default place at <code>/var/log/redis/redis-server.log</code> </li>
</ul>
<ul>
<li><p>requirepass, for <a href="https://blog.csdn.net/qq_40460909/article/details/84838245" target="_blank" rel="external">security issues</a>, please consider this item</p>
</li>
<li><p>login client with hostIP</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">redis-cli -h 10.20.181.132</div></pre></td></tr></table></figure>
<ul>
<li><a href="https://www.tutorialspoint.com/redis/redis_lists.htm" target="_blank" rel="external">basic operation of redis-cli</a></li>
</ul>
<p>log in redis-cli first, then run the following: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">LPUSH your_list_name item1 </div><div class="line">LPUSH your_list_name item2 </div><div class="line">LLEN your_list_name</div><div class="line">EXISTS your_list_name</div></pre></td></tr></table></figure>
<h4 id="redis-service-in-docker"><a href="#redis-service-in-docker" class="headerlink" title="redis service in docker"></a>redis service in docker</h4><p>the following is an example from <a href="https://docker-doc.readthedocs.io/zh_CN/stable/examples/running_redis_service.html" target="_blank" rel="external">create a redis service</a></p>
<ul>
<li>connect to the redis container directly</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -it redis-image /usr/bin/redis-server /etc/redis/myconfig.conf</div></pre></td></tr></table></figure>
<p>in this way, <code>redis service</code> will use its docker VIP, which can be checked from:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">docker ps </div><div class="line">docker inspect &lt;container_id&gt;</div></pre></td></tr></table></figure>
<p>which will give somehing like:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">"bridge": &#123;</div><div class="line">    "Gateway": "172.17.0.1",</div><div class="line">    "IPAddress": "172.17.0.2",</div></pre></td></tr></table></figure>
<p>then the redis-server can connect by:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">redis-cli -h 172.17.0.2</div></pre></td></tr></table></figure>
<ul>
<li>connect to the host os </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -it -p 6379 redis-image /usr/bin/redis-server /etc/redis/myconfig.conf</div></pre></td></tr></table></figure>
<p><strong>the redis container has exported 6379, which may map to another port on host os</strong>, check:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">docker ps </div><div class="line">docker port &lt;container_id&gt; 6379  <span class="comment">#gives the &lt;exernal_port&gt; on host</span></div><div class="line">rdis-cli -h 10.20.181.132 -p &lt;external_port&gt;</div></pre></td></tr></table></figure>
<ul>
<li>run redis service with host network</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -it --network=host redis-image /usr/bin/redis-server /etc/redis/myconfig.conf</div></pre></td></tr></table></figure>
<p>in this way, there is no bridge network, or docker VIP. the host IP and port is directly used. so the following works</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">redis-cli -h 10.20.181.132 -p 6379</div></pre></td></tr></table></figure>
<p>A good way now, is to map host redis_port to container redis_port, and use the second way to access redis.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -it -p 6379:6379 redisjq /bin/bash</div></pre></td></tr></table></figure>
<p>tips, need to confirm <code>6379</code> port at host machine is free.</p>
<h4 id="share-volumes-among-multi-volumes"><a href="#share-volumes-among-multi-volumes" class="headerlink" title="share volumes among multi volumes"></a>share volumes among multi volumes</h4><p>the problem is <code>redisjq service</code> download all scenarios scripts in its own docker container, and only store the scenario name in <code>redis db</code>. when <code>redis_worker</code> access the db, there is no real python scripts. so need to share this <code>job-queue</code> to all <code>redis_worker</code>s</p>
<p><a href="https://docs.docker.com/storage/volumes/" target="_blank" rel="external">mount volume</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -it -p 6379:6379 --mount <span class="built_in">source</span>=jq-vol,target=/job_queue redisjq /bin/bash</div></pre></td></tr></table></figure>
<h4 id="start-pythonapi-to-access-the-shared-volume"><a href="#start-pythonapi-to-access-the-shared-volume" class="headerlink" title="start pythonapi to access the shared volume"></a>start pythonapi to access the shared volume</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -it --mount <span class="built_in">source</span>=jq-vol,target=/pythonAPI/job_queue  redispythonapi  /bin/bash</div></pre></td></tr></table></figure>
<h2 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h2><p><a href="https://www.cnblogs.com/sammyliu/p/5095976.html" target="_blank" rel="external">qemu/kvm &amp; ceph: rbd drver in qemu</a></p>
<p><a href="https://www.ibm.com/developerworks/cn/opensource/os-cn-ceph-rbd-docker-storage/index.html" target="_blank" rel="external">基于 Ceph RBD 实现 Docker 集群的分布式存储</a></p>
<p><a href="https://my.oschina.net/u/561758/blog/1813161" target="_blank" rel="external">rexray/rbd 参考</a></p>
<p><a href="https://stackoverflow.com/questions/22359132/access-cephfs-inside-docker-container-without-mounting-cephfs-on-the-host" target="_blank" rel="external">access cephFS inside docker container without mounting cephFS in host</a></p>
<p><a href="https://docs.aws.amazon.com/AmazonS3/latest/user-guide/using-folders.html" target="_blank" rel="external">how to use folders in s3 bucket</a></p>
<p><a href="https://chrisyeh96.github.io/2017/08/08/definitive-guide-python-imports.html" target="_blank" rel="external">the definitive guide to python import statements</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/09/play-with-k8s/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/09/play-with-k8s/" itemprop="url">play with k8s</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-04-09T03:31:23-04:00">
                2020-04-09
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/04/09/play-with-k8s/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/04/09/play-with-k8s/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="basic-k8s"><a href="#basic-k8s" class="headerlink" title="basic k8s"></a>basic k8s</h2><h4 id="kubeadm-init"><a href="#kubeadm-init" class="headerlink" title="kubeadm init"></a>kubeadm init</h4><p>init options can be: </p>
<ul>
<li><p><code>--apiserver-bind-port int32</code>, by default, port=6443</p>
</li>
<li><p><code>--config string</code>, can pass in a kubeadm.config file to create a kube master node </p>
</li>
<li><p><code>--node-name string</code>, attach node name </p>
</li>
<li><p><code>--pod-network-cidr string</code>,  used to set the IP address range for all Pods. </p>
</li>
<li><p><code>--service-cide string</code>,  set service CIDRs, default value is <code>10.96.0.0/12</code></p>
</li>
<li><p><code>--service-dns-domain string</code>, default value is <code>cluster.local</code> </p>
</li>
<li><code>--apiserver-advertise-address string</code>, the broadcast listened address by API Server</li>
</ul>
<h4 id="nodes-components"><a href="#nodes-components" class="headerlink" title="nodes components"></a>nodes components</h4><table>
<thead>
<tr>
<th>IP</th>
<th>hostname</th>
<th>components</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.0.1</td>
<td>master</td>
<td>kube-apiserver, kube-controller-manager, kube-scheduler, etcd, kubelet, docker, flannel, dashboard</td>
</tr>
<tr>
<td>192.168.0.2</td>
<td>worker</td>
<td>kubelet, docker, flannel</td>
</tr>
</tbody>
</table>
<h4 id="ApiServer"><a href="#ApiServer" class="headerlink" title="ApiServer"></a>ApiServer</h4><p>when first launch Kubelet, it will send the Bootstrapping request to kube-apiserver, which then verify the sent token is matched or not. </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">--advertise-address = <span class="variable">$&#123;master_ip&#125;</span></div><div class="line"></div><div class="line">--<span class="built_in">bind</span>-address = <span class="variable">$&#123;master_ip&#125;</span>  <span class="comment">#can't be 127.0.0.1 </span></div><div class="line"></div><div class="line">--insecure-bind-address = <span class="variable">$&#123;master_ip&#125;</span></div><div class="line"></div><div class="line">--token-auth-file = /etc/kubernets/token.csv</div><div class="line"></div><div class="line">--service-node-port-range=<span class="variable">$&#123;NODE_PORT_RANGE&#125;</span></div></pre></td></tr></table></figure>
<p><a href="https://jimmysong.io/posts/kubernetes-installation-on-centos/" target="_blank" rel="external">how to configure master node</a></p>
<h4 id="cluster-IP"><a href="#cluster-IP" class="headerlink" title="cluster IP"></a>cluster IP</h4><p>it’s the service IP, which is internal, usually expose the service name.</p>
<p>the cluse IP default values as following:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">--service-cluster-ip-range=10.254.0.0/16</div><div class="line">--service-node-port-range=30000-32767</div></pre></td></tr></table></figure>
<h2 id="k8s-in-practice"><a href="#k8s-in-practice" class="headerlink" title="k8s in practice"></a>k8s in practice</h2><p><img src="https://jimmysong.io/kubernetes-handbook/images/kubernetes-high-level-component-archtecture.jpg" alt="image"></p>
<p><img src="https://jimmysong.io/kubernetes-handbook/images/kubernetes-whole-arch.png" alt="image"></p>
<p><img src="https://jimmysong.io/kubernetes-handbook/images/kubernetes-layers-arch.png" alt="image"></p>
<p>blueKing is a k8s solution from TenCent. here is a <a href="https://bk.tencent.com/docs/document/5.1/13/652" target="_blank" rel="external">quickstart</a>: </p>
<ul>
<li><p>create a task</p>
</li>
<li><p>add agnet for the task </p>
</li>
<li><p>run the task &amp; check the sys log </p>
</li>
<li><p>create task pipeline (CI/CD)</p>
</li>
</ul>
<h4 id="create-a-new-service-in-k8s"><a href="#create-a-new-service-in-k8s" class="headerlink" title="create a new service in k8s"></a>create a new service in k8s</h4><ul>
<li>create namespace for speical bussiness</li>
<li>create serivces, <a href="https://www.jianshu.com/p/3f24bbee72ad" target="_blank" rel="external">pull images from private registry hub</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">kubectl create -f  my-nginx-2.yaml</div><div class="line">kubctl get pods -o wide</div></pre></td></tr></table></figure>
<h4 id="how-external-access-to-k8s-pod-service"><a href="#how-external-access-to-k8s-pod-service" class="headerlink" title="how external access to k8s pod service ?"></a>how external access to k8s pod service ?</h4><p>pod has itw own special IP and a lifecyle period. once the node shutdown, the controller manager can transfer the pod to another node. when multi pods, provides the same service for front-end users, the front end users doesn’t care which pod is exactaly running, then here is the concept of <code>service</code>:</p>
<pre><code>service is an abstraction which defines a logical set of Pods and a policy by which to access them
</code></pre><p>service can be defined by <code>yaml</code>, <code>json</code>, the target pod can be define by <code>LabelSeletor</code>. a few ways to expose service:</p>
<ul>
<li><p><code>ClusterIP</code>, which is the default way, which only  works inside k8s cluster</p>
</li>
<li><p><code>NodePort</code>, which use NAT to provide external access through a special port, the port should be among <code>8400~9000</code>. then in this way, no matter where exactly the pod is running on, when access <code>*.portID</code>, we can get the serivce. </p>
</li>
<li><p><code>LoadBalancer</code></p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">kubectl get services</div><div class="line">kubectl expose your_service --<span class="built_in">type</span>=<span class="string">"NodePort"</span> --port 8889</div><div class="line">kubctl describe your_service</div></pre></td></tr></table></figure>
<h4 id="use-persistent-volume"><a href="#use-persistent-volume" class="headerlink" title="use persistent volume"></a>use persistent volume</h4><ul>
<li><p>access external sql </p>
</li>
<li><p>use volume </p>
</li>
</ul>
<p><code>volume</code> is for persistent, <code>k8s volume</code> is similar like <code>docker volume</code>, working as dictory, when mount a volume to a pod, all containers in that pod can access that volume. </p>
<ul>
<li>EmptyDir</li>
<li>hostPath</li>
<li>external storage service(aws, azure), k8s can directly use cloud storage as volume, or distributed storage system(ceph):</li>
</ul>
<p><a href="https://www.cnblogs.com/benjamin77/p/9940266.html" target="_blank" rel="external">sample</a></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">apiVersion: v1</div><div class="line">kind: Pod</div><div class="line">metadata: </div><div class="line">	name: using-ebs</div><div class="line">metadata:</div><div class="line">	name: using-ceph</div><div class="line">spec:</div><div class="line">	containers:</div><div class="line">		-image: busybox1</div><div class="line">		 name: using-ebs</div><div class="line">		 volumeMounts:</div><div class="line">		 	-mountPath: /test-ebs</div><div class="line">		 	name: ebs-volume</div><div class="line">		-image: busybox2</div><div class="line">			name: using-ceph</div><div class="line">			volumeMounts:</div><div class="line">				-name: ceph-volume</div><div class="line">				mountPath: /test-ceph</div><div class="line">				</div><div class="line">		volumes:</div><div class="line">		-name: ebs-volume</div><div class="line">		awsElasticBlockStore:</div><div class="line">			volumeID:  <span class="tag">&lt;<span class="name">volume_id</span>&gt;</span></div><div class="line">			fsType: ext4</div><div class="line">		</div><div class="line">		-name: ceph-volume</div><div class="line">		cephfs:</div><div class="line">			path: /path/in/ceph</div><div class="line">			monitors: "10.20.181.112:6679"</div><div class="line">			secretFile: "/etc/ceph/admin/secret"</div></pre></td></tr></table></figure>
<h4 id="containers-communication-in-same-pod"><a href="#containers-communication-in-same-pod" class="headerlink" title="containers communication in same pod"></a>containers communication in same pod</h4><p>first, <a href="https://www.mirantis.com/blog/multi-container-pods-and-container-communication-in-kubernetes/" target="_blank" rel="external">containers in the same pod</a>, the share same network namespace and same iPC namespace, and shared volumes. </p>
<ul>
<li>shared volumes in a pod </li>
</ul>
<p>when one container writes logs or other files to the shared directory, and the other container reads from the shared directory. </p>
<p><img src="https://cdn.mirantis.com/wp-content/uploads/2017/08/MultiContainerPods.png?resize=565x288" alt="image"></p>
<ul>
<li>inter-process communication(IPC)</li>
</ul>
<p>as they share the same IPC namespace, they can communicate with each other using standard ipc, e.g. POSIX shared memory, SystemV semaphores</p>
<p><img src="https://cdn.mirantis.com/wp-content/uploads/2017/08/multicontainerpodproducerconsumer.png?resize=565x288" alt="image"></p>
<ul>
<li>inter-container network communication</li>
</ul>
<p>containers in a pod are accessible via <code>localhost</code>, as they share the same network namespace. for externals, the observable host name is the pod’s name, as containers all have the same IP and port space, so need differnt ports for each container for incoming connections.</p>
<p><img src="https://cdn.mirantis.com/wp-content/uploads/2017/08/multicontainerwebapp.png?resize=565x288" alt="image"></p>
<p>basically, the external incoming HTTP request to port 80 is forwarded to port 5000 on localhost, in pod, and which is not visiable to external. </p>
<h4 id="how-two-services-communicate"><a href="#how-two-services-communicate" class="headerlink" title="how two services communicate"></a><a href="https://stackoverflow.com/questions/45720084/how-to-make-two-kubernetes-services-talk-to-each-other" target="_blank" rel="external">how two services communicate</a></h4><ul>
<li>ads_runner</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">apiVersion: v1</div><div class="line">kind: Service</div><div class="line">metadata:</div><div class="line">	name: ads_runner</div><div class="line">spec:</div><div class="line">	selector:</div><div class="line">		app: ads</div><div class="line">		tier: api</div><div class="line">	ports:</div><div class="line">		-protocol: TCP</div><div class="line">		 port: 5000</div><div class="line">		 nodePort: 30400</div><div class="line">	type: NodePort</div></pre></td></tr></table></figure>
<p>if there is a need to autoscale the service, check<br><a href="https://stackoverflow.com/questions/37377119/in-kubernetes-how-do-i-autoscale-based-on-the-size-of-a-queue" target="_blank" rel="external">k8s autoscale based on the size of queue</a>. </p>
<ul>
<li>redis-job-queue</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">apiVersion: v1</div><div class="line">kind: Service</div><div class="line">metadata:</div><div class="line">	name: redis-job-queue</div><div class="line">spec:</div><div class="line">	selector:</div><div class="line">		app: redis</div><div class="line">		tier: broker</div><div class="line">	ports:</div><div class="line">		-portocol: TCP </div><div class="line">		port: 6379</div><div class="line">		targetPort: [the port exposed by Redis pod]</div></pre></td></tr></table></figure>
<p>ads_runner can reach Redis by address: <code>redis-server:6379</code> in the k8s cluster.</p>
<p><a href="https://redis.io/topics/replication" target="_blank" rel="external">redis replication</a> has great async mechanism to support multi redis instance simutanously, when need scale the redis service, it is ok to start a few replicas of <code>redis</code> service as well.</p>
<h4 id="redis-work-queue"><a href="#redis-work-queue" class="headerlink" title="redis work queue"></a>redis work queue</h4><p>check <a href="https://zjli2013.github.io/2020/04/09/redis-task-queue/" target="_blank" rel="external">redis task queue</a>: </p>
<ul>
<li>start a storage service(redis) to hold the work queue</li>
<li>create a queu, and fill it with messages, each message represents one task to be done</li>
<li>start a job that works on tasks from the queue</li>
</ul>
<h3 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h3><p><a href="https://jimmysong.io/kubernetes-handbook/cloud-native/play-with-kubernetes.html" target="_blank" rel="external">jimmysong</a></p>
<p><a href="https://github.com/Tencent/bk-cmdb" target="_blank" rel="external">BlueKing configure manage DB</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1501395" target="_blank" rel="external">k8s: volumes and persistent storage</a></p>
<p><a href="https://cdn.mirantis.com/wp-content/uploads/2017/08/MultiContainerPods.png?resize=565x288" target="_blank" rel="external">multi-container pods and container communication in k8s</a></p>
<p><a href="https://kubernetes.io/docs/tasks/access-application-cluster/communicate-containers-same-pod-shared-volume/" target="_blank" rel="external">k8s doc: communicate between containers in the same pod using a shared volume</a></p>
<p><a href="https://kubemq.io" target="_blank" rel="external">kubeMQ: k8s message queue broker</a></p>
<p><a href="https://blog.cloudthat.com/3-types-of-cluster-networking-in-kubernetes/" target="_blank" rel="external">3 types of cluster networking in k8s</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/09/redis-task-queue/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/09/redis-task-queue/" itemprop="url">redis task queue</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-04-09T02:26:42-04:00">
                2020-04-09
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/04/09/redis-task-queue/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/04/09/redis-task-queue/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="background"><a href="#background" class="headerlink" title="background"></a>background</h2><p>redis is a in-memory database, like SQlite, but the other part of redis, is that it can use to write message queue for task scheduler.</p>
<p>job/task scheduler is a popular automatic tool used in cloud/HPC, when need to deal with lots of taskes/jobs. </p>
<p>for ADS simulation, a job scheduler can be used to manage the scenarios feed into the simulator. where the existing scenarios are stored as items in redis, and the redis server looks like a shared volume, which can be access by any worker services through <code>redis_host</code>. where simulator can enpacakged in a redis_worker. </p>
<h2 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h2><h4 id="redis-commands"><a href="#redis-commands" class="headerlink" title="redis commands"></a>redis commands</h4><p>redis is database, so there are plenty of commands used to do db operation. e.g. </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">GET, SET <span class="comment">#string</span></div><div class="line">HGET, HSET, <span class="comment">#hash table</span></div><div class="line">LPUSH, LPOP, BLPOP <span class="comment">#list</span></div><div class="line">SADD, SPOP, <span class="comment">#set</span></div><div class="line">PUBLISH, SUBSCRIBE, UNSUBSCRIBE, PUBSUB <span class="comment">#pub&amp;sub</span></div><div class="line">...</div></pre></td></tr></table></figure>
<h4 id="redis-in-python"><a href="#redis-in-python" class="headerlink" title="redis in python"></a>redis in python</h4><p>the following is from <a href="https://github.com/andymccurdy/redis-py" target="_blank" rel="external">redis-py api reference</a></p>
<ul>
<li>get/set string</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">r = redis.Redis(host=<span class="string">'localhost'</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</div><div class="line">r.set(<span class="string">'foo'</span>, <span class="string">'bar'</span>)</div><div class="line">r.get(<span class="string">'foo'</span>)</div></pre></td></tr></table></figure>
<ul>
<li>connection pools</li>
</ul>
<p>redis-py uses a connection pool to manage connections to a Redis server. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">pool = redis.ConnectionPool(host=<span class="string">'localhost'</span>, port=<span class="number">6379</span>, db=<span class="number">0</span>)</div><div class="line">r = redis.Redis(connection_pool=pool)</div></pre></td></tr></table></figure>
<ul>
<li>connections </li>
</ul>
<p>connectionPools manage a set of Connection instances. the default connection is a normal TCP  socket based; also it can use UnixDomainSocketConnection, or customized protocol.</p>
<p>connection maintain an open socket to Redis server. when these sockets are disconnected, redis-py will raise a <code>ConnectionError</code> to the caller, also redis-py can issue regular <code>health check</code> to assess the liveliness of a connection. </p>
<ul>
<li>parsers</li>
</ul>
<p>parser provides the way to control how response from Redis server are parsed, redis-py has: PythonParser and the default HiredisParser. </p>
<ul>
<li>response callbacks</li>
</ul>
<p>the redis-py has its own client callbacks in <code>RESPONSE_CALLBACKS</code>. custom callbacks can add on per-instance using <code>set_response_callback(command_name, callfn)</code></p>
<ul>
<li>pub/sub </li>
</ul>
<p>PubSub object can subscribes/unsubscribes to channels or patterns and listens for new messages.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">r = redis.Redis(...)</div><div class="line">p = r.pubsub()</div><div class="line">p.subscribe(<span class="string">'my-first-channel'</span>, ...)</div><div class="line">p.psubscribe(<span class="string">'my-first-patttern'</span>, ...)</div><div class="line">p.unsubscribe(<span class="string">'my-first-channel'</span>)</div><div class="line">p.punsubscribe(<span class="string">'my-first-pattern'</span>)</div></pre></td></tr></table></figure>
<p>every message read from a PubSub instance will be a dict with following keys:</p>
<pre><code>- type, e.g. subscribe, unsubscribe, psubscribe, message e.t.c
- channel
- pattern
- data
</code></pre><p>redis-py allows to register callback funs to handle published messages. these message handlers take a single argument <code>the message</code>. when a message is read with a message handler, the message is created and passed to the message handler:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">a_handler</span><span class="params">(message)</span>:</span></div><div class="line">	<span class="keyword">print</span> message[<span class="string">'data'</span>]</div><div class="line"></div><div class="line">p.subscribe(**(<span class="string">'my-channel'</span>: a_handler&#125;)</div><div class="line">r.publish(<span class="string">'my-channel'</span>, <span class="string">'awesome handler'</span>)</div><div class="line">p.get_message()</div></pre></td></tr></table></figure>
<ul>
<li>get_message()</li>
</ul>
<p>get_message() use system’s <code>select</code> module to quickly poll the connection’s socket. if there’s data available to be read, get_message() will read it; if there’s no data to be read, get_message() will immediately return <code>None</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">	message = p.get_message()</div><div class="line">	<span class="keyword">if</span> message:</div><div class="line">		<span class="comment">#do something with the message</span></div><div class="line">	time.sleep(<span class="number">0.01</span>)</div></pre></td></tr></table></figure>
<ul>
<li>listen()</li>
</ul>
<p>listen() is a generator(e.g. <code>yield</code> keyword), which blocks until a message is avaiable. if the app is ok to be blocked until next message avaiable, listen() is an easy way:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> message <span class="keyword">in</span> p.listen():</div><div class="line">	<span class="comment">#do something with the message</span></div></pre></td></tr></table></figure>
<ul>
<li>run_in_thread()</li>
</ul>
<p>run an event loop in a separate thread. run_in_thread() returns a thread object, and it is simply a wrapper around get_message(), that runs in a separate thread, essentially creating a tiny non-blocking event loop. since it’s running in a separate thread, there is no way to handle message that aren’t automatically handled with registered message handlers. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">p.subscribe(**&#123;<span class="string">'my-channel'</span>: a_handler&#125;)</div><div class="line">thread = p.run_in_thread(sleep_time = <span class="number">0.01</span>)</div><div class="line"><span class="comment">#when need shut down</span></div><div class="line">thread.stop()</div></pre></td></tr></table></figure>
<h2 id="redis-task-queue-in-k8s"><a href="#redis-task-queue-in-k8s" class="headerlink" title="redis task queue in k8s"></a>redis task queue in k8s</h2><p><a href="https://kubernetes.io/docs/tasks/job/fine-parallel-processing-work-queue/" target="_blank" rel="external">fine parallel processing using work queue</a> is an good example of how to use redis as task queue.</p>
<p>first, fill the existing task lists into redis database(server) as a shared volume, then start mutli worker services to the shared volume to get the job to run.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/06/design-a-data-center-for-ADS-applications/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/06/design-a-data-center-for-ADS-applications/" itemprop="url">design a data center for ADS applications</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-04-06T04:57:57-04:00">
                2020-04-06
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/04/06/design-a-data-center-for-ADS-applications/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/04/06/design-a-data-center-for-ADS-applications/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="background"><a href="#background" class="headerlink" title="background"></a>background</h2><p>A system’s back end can be made up of a number of bare metal servers, data storage facilities, virtual machines, a security mechanism, and services, all built in conformance with a deployment model, and all together responsible for providing a service.</p>
<h4 id="points-to-consider"><a href="#points-to-consider" class="headerlink" title="points to consider"></a>points to consider</h4><ul>
<li><p>it’s the primary authority and responsibility of the back end to provide a built-in security mechanism, traffic control and protocols.</p>
</li>
<li><p>a central server is responsible for managing and running the system, systematically reviewing the traffic and client request to make certain that everything is running smoothly.</p>
</li>
</ul>
<h2 id="service-viewport"><a href="#service-viewport" class="headerlink" title="service viewport"></a>service viewport</h2><h4 id="busniess-services"><a href="#busniess-services" class="headerlink" title="busniess services"></a>busniess services</h4><p>the most common busniess services or <code>application-as-a-service(aaas)</code> in ADS data center includes:</p>
<ul>
<li><p>massively scenario simualtion</p>
</li>
<li><p>open-loop re-play simulation </p>
</li>
<li><p>AI training </p>
</li>
<li><p>sensor data analysis</p>
</li>
<li><p>test driven algorithms dev</p>
</li>
</ul>
<h4 id="platform-as-a-service"><a href="#platform-as-a-service" class="headerlink" title="platform as a service"></a>platform as a service</h4><p>busniess services can be considered as the most abstract level services,  paas consider how to support the upper level needs. a few components are obvious:</p>
<ul>
<li><p>distributed data storage(aws s3, ceph)</p>
</li>
<li><p>massively data analysis(hadoop)</p>
</li>
<li><p>massively compute nodes(k8s/docker)</p>
</li>
<li><p>vdi server pool</p>
</li>
<li><p>sql</p>
</li>
<li><p>web server for end-user UI</p>
</li>
</ul>
<h4 id="IaaS"><a href="#IaaS" class="headerlink" title="IaaS"></a>IaaS</h4><p>to support PaaS, we need CPUs, GPUs, network, either in physical mode or virtual mode. the common private cloud vendor would suggest a general virtualization layer, to manage all resources in one shot. but there is always an balance between the easy manage and performance lost. </p>
<p>for large auto industry OEMs, no doubt <code>easy manage</code> is crucial. so it’s suggested to implement virtual layer(either vmware or customized kvm). if not, I wonder the self-maintainaince will be a disaster in future. </p>
<h2 id="security-in-cloud"><a href="#security-in-cloud" class="headerlink" title="security in cloud"></a>security in cloud</h2><h4 id="who-is-Cybersecurity-professional"><a href="#who-is-Cybersecurity-professional" class="headerlink" title="who is Cybersecurity professional"></a><a href="https://cloudacademy.com/blog/how-to-become-a-cybersecurity-professional/" target="_blank" rel="external">who is Cybersecurity professional</a></h4><p>the guy who provide security during the development stages of software systems, networks, and data centers. </p>
<p>must make security measures for any information by designing various defensive systems and strategies against intruders. </p>
<p> The specialist must create new defensive systems and protocols and report incidents. Granting permissions and privileges to authorized users is also their job.</p>
<p> The cybersecurity professional must maintain IT security controls documentation, recognize the security gaps, and prepare an action plan accordingly. </p>
<p> Cybersecurity professionals enable security in IT infrastructure, data, edge devices, and networks.</p>
<h4 id="Azure-Security-best-practices"><a href="#Azure-Security-best-practices" class="headerlink" title="Azure Security: best practices"></a><a href="https://cloudacademy.com/blog/azure-security-best-practices-you-need-to-know/" target="_blank" rel="external">Azure Security: best practices</a></h4><ul>
<li><p>control network access </p>
<p>   At this ring you typically find Firewall policies, Distributed Denial of Service (DDoS) prevention, Intrusion Detection and Intrusion Prevention systems (IDS/IPS), Web Content Filtering, and Vulnerability Management such as Network Anti-Malware, Application Controls, and Antivirus.</p>
<p>   The second ring is often a Network Security Group (or NSG) applied to the subnet. Network Security Groups allow you to filter network traffic to and from Azure resources in an Azure virtual network.</p>
<pre><code>all subnets in an Azure Virtual Network (VNet) can communicate freely. By using a network security group for network access control between subnets, you can establish a different security zone or role for each subnet. As such, all subnets should be associated with a properly configured Network Security Group. 

With a virtual server, there is a third ring which is a Network Security Group (NSG) applied to virtual machines network interfaces, 

avoid exposure to the internet with a dedicated WAN connection. Azure offers both site-to-site VPN and ExpressRoute for this purpose.
</code></pre></li>
</ul>
<ul>
<li>disable remote access (ssh/rdp) </li>
</ul>
<p>disable remote access to vm from internet. ssh/rdp only should be provided over a secure dedicated conenction using Just-In-time(JIT) vm access.</p>
<p> the Just-In-Time VM access policy configures at the NSG to lock down the virtual machines remote management ports. When an authorized user requires access to the VM, they will use Just-In-Time VM Access to request access for up to three hours. After the requested time has elapsed, Azure locks the management ports down to help reduce susceptibility to an attack.</p>
<ul>
<li>update vm</li>
</ul>
<p>You need to run antivirus and anti-malware. and requires system updates for VMs hosted in Azure</p>
<ul>
<li><p>safeguard sensitive data </p>
</li>
<li><p>enable encryption </p>
</li>
</ul>
<ul>
<li><a href="https://docs.microsoft.com/en-us/archive/blogs/azuresecurity/what-does-shared-responsibility-in-the-cloud-mean" target="_blank" rel="external">shared responsibility</a></li>
</ul>
<p><img src="https://msdnshared.blob.core.windows.net/media/2016/04/image_thumb601.png" alt="image"></p>
<h4 id="aws-security-instance-level-security"><a href="#aws-security-instance-level-security" class="headerlink" title="aws security: instance level security"></a><a href="https://cloudacademy.com/blog/aws-security-groups-instance-level-security/" target="_blank" rel="external">aws security: instance level security</a></h4><ul>
<li><p>AWS security groups, provides security at the protocol and port access level, working much the same way as a firewall – contains a set of rules that filter traffic coming in and out of an EC2 instance. </p>
</li>
<li><p>os security path management </p>
</li>
<li><p>key pairs(public and private key to login EC2 instance)</p>
</li>
</ul>
<h4 id="aws-security-network-ACL-and-subnets-network-level-security"><a href="#aws-security-network-ACL-and-subnets-network-level-security" class="headerlink" title="aws security: network ACL and subnets: network level security"></a><a href="https://cloudacademy.com/blog/aws-network-acl-vpc-subnets-network-security/" target="_blank" rel="external">aws security: network ACL and subnets: network level security</a></h4><h4 id="aws-security-bastion-hosts"><a href="#aws-security-bastion-hosts" class="headerlink" title="aws security: bastion hosts"></a><a href="https://cloudacademy.com/blog/aws-bastion-host-nat-instances-vpc-peering-security/" target="_blank" rel="external">aws security: bastion hosts</a></h4><p>the connectivity flowing from an end-user to resources on a private subnet through a bastion host: </p>
<p><img src="https://d1o2okarmduwny.cloudfront.net/wp-content/uploads/2015/11/aws-bastion-host-1.png" alt="image"></p>
<ul>
<li>updates to bastion host </li>
</ul>
<p>skip bastion if using Session Manager, to securely connect to private instance in virtual private cloud wthout needing bastion host or key-pairs</p>
<p>now push keys for short periods of time and use IAM policies to restrict access as you see fit. This reduces your compliance and audit footprint as well</p>
<ul>
<li>NAT(network address translation) [gateway] instance </li>
</ul>
<p>allows private instance outgoing connectivity to the internet while at the same time blocking inboud traffic from the internet </p>
<ul>
<li>VPC(virtual private cloud) peering </li>
</ul>
<p><img src="https://d1o2okarmduwny.cloudfront.net/wp-content/uploads/2015/11/aws-bastion-host-3.png" alt="image"></p>
<h4 id="aws-security-identity-and-access-management-IAM"><a href="#aws-security-identity-and-access-management-IAM" class="headerlink" title="aws security: identity and access management(IAM)"></a><a href="https://cloudacademy.com/blog/aws-security-identity-and-access-management-iam/" target="_blank" rel="external">aws security: identity and access management(IAM)</a></h4><p>governs and control user acces to VPC resoruces, it achieves the goal through Users/Group/Roles and Policies.</p>
<h2 id="network-topology-in-cloud"><a href="#network-topology-in-cloud" class="headerlink" title="network topology in cloud"></a>network topology in cloud</h2><h4 id="network-topology-at-first"><a href="#network-topology-at-first" class="headerlink" title="network topology at first"></a>network topology at first</h4><p>I would consider the data center network topology and security mechanism from the following four points:</p>
<ul>
<li>internal network topology</li>
</ul>
<p>basically the data center will have an internal network, to connect infrastructures, e.g. data storage nodes, k8s compute nodes, hadoop compute nodes, web server nodes,  vdi server nodes e.t.c.</p>
<ul>
<li>network gateway to end-users</li>
</ul>
<p>there should be a unique network gateway in data center, which is the only network IO for end-user access.</p>
<ul>
<li>network gateway to other private/public cloud</li>
</ul>
<p>we also need connect to other IT infrastructure, so needanother network gateway.</p>
<p>the two gateways above, can be either virtual gateway or physical gateway, depends on our hardware. e.g. vlan, bridge, or physical gateway</p>
<ul>
<li>admin pass-through network</li>
</ul>
<p>network gateway is the normal user access port, but for admin, specially for sysm management, trouble-shooting, e.t.c, we need a pass-through network, which basically directly connect to internal network of data center,<br>admin pass-through network is speed limited, so only for special admin usage.</p>
<h4 id="h3c-浅谈数据中心网络架构的发展"><a href="#h3c-浅谈数据中心网络架构的发展" class="headerlink" title="h3c: 浅谈数据中心网络架构的发展"></a><a href="http://www.h3c.com/CN/D_201405/826868_30008_0.htm" target="_blank" rel="external">h3c: 浅谈数据中心网络架构的发展</a></h4><ul>
<li>接入层，用于连接所有的计算节点，在较大规模的数据中心中，通常以柜顶交换机的形式存在；</li>
<li>汇聚层，用于接入层的互联，并作为该汇聚区域二三层的边界，同时各种防火墙、负载均衡等业务也部署于此；</li>
<li>核心层，用于汇聚层的的互联，并实现整个数据中心与外部网络的三层通信。</li>
</ul>
<p>传统的数据中心内，服务器主要用于对外提供业务访问，不同的业务通过安全分区及VLAN隔离。一个分区通常集中了该业务所需的计算、网络及存储资源，不同的分区之间或者禁止互访，或者经由核心交换通过三层网络交互，数据中心的网络流量大部分集中于南北向.</p>
<p>在这种设计下，不同分区间计算资源无法共享，资源利用率低下的问题越来越突出。通过虚拟化技术、云计算管理技术等，将各个分区间的资源进行池化，实现数据中心内资源的有效利用。而随着这些新技术的兴起和应用，新的业务需求如虚拟机迁移、数据同步、数据备份、协同计算等在数据中心内开始实现部署，数据中心内部东西向流量开始大幅度增加。</p>
<h4 id="h3c-two-layer-network-arch"><a href="#h3c-two-layer-network-arch" class="headerlink" title="h3c: two-layer network arch"></a><a href="http://www.h3c.com/cn/d_201010/697894_30008_0.htm" target="_blank" rel="external">h3c: two-layer network arch</a></h4><ul>
<li>网络三层互联，或称为，数据中心前端网络互联。“前端网络”，是指数据中心面向企业园区的出口。不同数据中心的前端网络通过ip实现互联，园区或分支的客户端通过前端网络访问各数据中心。</li>
</ul>
<ul>
<li><p>网络两层互联，或称为，数据中心服务器网络互联。在不同数据中心服务器网络接入层，构建一个跨数据中心的搭二层网络(vlan)，以满足服务器集群或虚拟机动态迁移等场景</p>
</li>
<li><p>san互联，也称为，后端存储网络互联。借助传输技术，实现主中心、灾备中心间磁盘阵列的数据复制</p>
</li>
</ul>
<p>二层互联的业务需求：保证服务器的高可用集群。</p>
<p>二层互联设计要点：面对中小企业客户（ip网络）</p>
<h4 id="openstack-neutron-network-for-cloud"><a href="#openstack-neutron-network-for-cloud" class="headerlink" title="openstack neutron: network for cloud"></a><a href="https://www.cnblogs.com/pmyewei/p/6280445.html" target="_blank" rel="external">openstack neutron: network for cloud</a></h4><ul>
<li>data flow in data center: </li>
</ul>
<ul>
<li><p>manage(API) network, basically the internal managed network</p>
</li>
<li><p>user network</p>
</li>
<li><p>external network, including vpn, firewall </p>
</li>
<li><p>storage network, connect from computing nodes to storage ndoes </p>
</li>
</ul>
<ul>
<li>NSX arch</li>
</ul>
<p><img src="https://images2015.cnblogs.com/blog/1009737/201701/1009737-20170116004552494-794532203.png" alt="image"></p>
<p>the left most part is computing nodes, for customers bussniess, the dataflow includes: user-network, storage, internal-network, all of which requires 3 NIC</p>
<p>the middle part is infrastructure, including managing nodes, shared storage, which brings IP based storage for the left most part.</p>
<p>the right edge part, is external(internet) network services for users, including network to users, as well as network to Internet, firewall, public IP address translation e.t.c.</p>
<p><img src="https://images2015.cnblogs.com/blog/1009737/201701/1009737-20170116004801510-1392260872.png" alt="image"></p>
<h4 id="ceph-subnets"><a href="#ceph-subnets" class="headerlink" title="ceph subnets"></a>ceph subnets</h4><p><img src="http://docs.ceph.org.cn/_images/ditaa-2452ee22ef7d825a489a08e0b935453f2b06b0e6.png" alt="image"></p>
<p>when consider ceph storage for k8s computing nodes, the public network also includes network switches to k8s, as well as normal user data access network switches.</p>
<ul>
<li><p>cluster network (Gb NIC, including osd and monitor)</p>
</li>
<li><p>ceph client(to k8s) network (gb)</p>
</li>
<li><p>ceph admin/user network(mb)</p>
</li>
</ul>
<h4 id="k8s-subnets"><a href="#k8s-subnets" class="headerlink" title="k8s subnets"></a>k8s subnets</h4><p><a href="https://zhuanlan.zhihu.com/p/90992878" target="_blank" rel="external">understand k8s network：pods, service, ingress</a></p>
<ul>
<li><p>pods, all containers in one pod, share the same network namespace. the network namespace of pod is different from that of the host machine, but the two is connected by <code>docker bridge</code> </p>
</li>
<li><p>services, handle the load balance among pods, as well as encapsulate the IPs of pods, so we don’t directly deal with the local dynamic IPs of pods.</p>
</li>
<li><p>how to access k8s service from exteral, or how user acces the k8s hosted in a remote data center?  <strong><a href="https://www.kuboard.cn/learning/k8s-intermediate/service/ingress.html#ingress" target="_blank" rel="external">ingress for k8s</a></strong></p>
</li>
</ul>
<p><img src="https://upload-images.jianshu.io/upload_images/1401434-5216e7cf94351457.jpg?imageMogr2/auto-orient/strip|imageView2/2/w/1200" alt="image"></p>
<p><a href="https://www.jianshu.com/p/ae2889daa0a5" target="_blank" rel="external">flannel</a><br> setup a two-layer network, the ip of pod is assigend by <code>flannel</code>, each node will has a <code>flannel0</code> virtual NIC, used for node-node communication. </p>
<h4 id="gpu-vdi-subnets"><a href="#gpu-vdi-subnets" class="headerlink" title="gpu vdi subnets"></a>gpu vdi subnets</h4><p>as mentioned in <a href="https://zjli2013.github.io/2020/04/02/gpu-vdi/" target="_blank" rel="external">gpu vdi</a>,  most solution has a customized vdi client, the vm manager internal network is handled by the vendors, maybe communicate through one Gb NIC, the client-server is simple TCP/ip.</p>
<h4 id="webserver-subnets"><a href="#webserver-subnets" class="headerlink" title="webserver subnets"></a>webserver subnets</h4><p>a few things in mind:</p>
<ul>
<li>using vm.</li>
</ul>
<p>web servers are better to deploy in vm, so whenever there is a hardware failure, it can detect and automatically transfer to another vm. </p>
<ul>
<li>communicate with in-house services </li>
</ul>
<p>in ADS data center, most web application need access data from either sql or even storage services directly, which means the web server need both external ingress services as well as handling internal IP access. </p>
<h4 id="network-manager"><a href="#network-manager" class="headerlink" title="network manager"></a>network manager</h4><p>the above subnet classification only consider each component itself, for a data center in whole, it’s better to manage all networks of internal subnets and access to external Internet in one module: network manager.</p>
<p>as mentioned in the previous section: <a href="">security in cloud</a>, the network manager module can further add some security mechanisms.  </p>
<h2 id="refere"><a href="#refere" class="headerlink" title="refere"></a>refere</h2><p><a href="https://cloudacademy.com/blog/cloud-computing-architecture-an-overview/" target="_blank" rel="external">cloud arch: front end &amp; back end</a></p>
<p><a href="https://cloudacademy.com/learning-paths/az-500-exam-preparation-microsoft-azure-security-technologies-650/" target="_blank" rel="external">Microsoft Azure security tech training courses</a></p>
<p><a href="https://cloudacademy.com/blog/foundation-certificate-in-cyber-security-fccs-learning-path/" target="_blank" rel="external">introduction the Foundation certificate in Cyber Security</a></p>
<p><a href="https://www2.cs.duke.edu/courses/fall10/cps296.2/lectures/16RoutingTopology.pdf" target="_blank" rel="external">datacenter network: topology and routing</a></p>
<p><a href="https://www.sdnlab.com/mininet-topology/" target="_blank" rel="external">miniNet for data center network topology</a></p>
<p><a href="https://www.cnblogs.com/pmyewei/p/6413875.html" target="_blank" rel="external">openstack neutron: two-layer network</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/02/gpu-vdi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/02/gpu-vdi/" itemprop="url">gpu vdi</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-04-02T03:44:08-04:00">
                2020-04-02
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/04/02/gpu-vdi/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/04/02/gpu-vdi/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="backgroud"><a href="#backgroud" class="headerlink" title="backgroud"></a>backgroud</h2><p>preivously, reviewed:</p>
<ul>
<li><p><a href="https://zjli2013.github.io/2020/03/14/hypervisor-and-gpu-virtualization/" target="_blank" rel="external">hypervisor and gpu virtualization</a></p>
</li>
<li><p><a href="https://zjli2013.github.io/2020/03/28/vmware-virtualization/" target="_blank" rel="external">vmware introduction</a></p>
</li>
</ul>
<p>this blog is a little bit futher of vmware and AMD GPU virtualization sln. </p>
<h2 id="AMD-virtualization"><a href="#AMD-virtualization" class="headerlink" title="AMD virtualization"></a>AMD virtualization</h2><h4 id="S7150x2"><a href="#S7150x2" class="headerlink" title="S7150x2"></a>S7150x2</h4><p>for remote graphic workstation, usually we separate host machine and local machines, where host machine is located in data center, and local machines are the end-user terminals at offices. </p>
<p>the host OS can be Windows 7/8, Linux, and hypervisor can be vmware ESXi 6.0;  guest os can be windows7/8, supported API includes: DX11.1, OpenGL</p>
<p>since S7150 has no local IO, os there is no <code>display</code> interface, just like a Nvidia Tesla GPU. </p>
<h4 id="SR-IOV"><a href="#SR-IOV" class="headerlink" title="SR-IOV"></a>SR-IOV</h4><ul>
<li>sr-iov arch </li>
</ul>
<p><img src="https://docs.microsoft.com/en-us/windows-hardware/drivers/network/images/sriovarchitecture.png" alt="image"></p>
<ul>
<li>Physical Function (PF)</li>
</ul>
<p>it’s  PCI-Express function of a network adapter that supports single root I/O virtualization(SR-IOV) interface. PF is exposed as a virtual network adapter(vLan) in the host OS, and the GPU driver in install in PF. </p>
<ul>
<li>Virtual Function (VF)</li>
</ul>
<p>it’s a lightweight PCIe function on a network adapter that supports SR-IOV. VF is associated with the PF on the network adapter, and represents a virtualized instance of the network adapter. each VF has its own PCI configuration space, and shares one or more physical resources(e.g. GPU) on the network adapter. </p>
<ul>
<li>GPU SR-IOV</li>
</ul>
<p>sr-iov basically split one PF(a PCIe resource) into multi VF(virtual PCIe resource). and each vf has its own Bus/Slot/Function id, which can used to access physical device/resources(e.g. GPU); Nvidia Grid vGPU is a different mechanism, where virtualization is implemented only in host machine side to assign device MAC address.</p>
<h4 id="GPU-resource-managment"><a href="#GPU-resource-managment" class="headerlink" title="GPU resource managment"></a>GPU resource managment</h4><ul>
<li>display </li>
</ul>
<p>GPU PF mangae the size of frameBuffer to each vf, and display virtualization. </p>
<ul>
<li>security check</li>
</ul>
<p>PF also do an address audit check and security check</p>
<ul>
<li>VF schedule</li>
</ul>
<p>GPU vf scheduler is similar as CPU process time-split. in a certain time period, the gpu is occupied by a certain vf. </p>
<h4 id="Multiuser-GPU-MxGPU"><a href="#Multiuser-GPU-MxGPU" class="headerlink" title="Multiuser GPU(MxGPU)"></a>Multiuser GPU(MxGPU)</h4><p><a href="https://www.amd.com/en/graphics/workstation-virtual-graphics" target="_blank" rel="external">AMD MxGPU</a> is the first hardware-based virtualized GPU solution, based on SR-IOV, and allows up to 16 vm per GPU to work remotely. </p>
<p><img src="https://www.amd.com/system/files/styles/1200px/private/76826-VDI-infographic-07032017-1260wide.png?itok=S5lPjqXR" alt="image"></p>
<p>now we see two GPU virtualization solutions:  </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">* Nvidia Tesla vGPU</div><div class="line">* AMD SR-VIO MxGPU</div></pre></td></tr></table></figure>
<p>vGPU is more software-based virtualization, but the performance is a little better; while MxGPU is hardware based. </p>
<h2 id="vmware-products"><a href="#vmware-products" class="headerlink" title="vmware products"></a>vmware products</h2><ul>
<li><p>the license-free products, e.g. vSphere Hypervisor, VMware Remote Console</p>
</li>
<li><p>the licensed and 60days-free products, e.g. vSAN, Horizon 7, vSphere</p>
</li>
</ul>
<h2 id="vSphere"><a href="#vSphere" class="headerlink" title="vSphere"></a>vSphere</h2><p>vSphere is the virtualization(hypervisor) layer of vmware products. there are two components: ESXi and vCenter Server. <code>exsi</code> is the core hypervisor, and <code>vcenter</code> is the service to mange multi vm in a network and host resources pool.</p>
<p><img src="https://docs.vmware.com/en/VMware-vSphere/images/GUID-CC660699-9EEC-4BAF-84AB-D992B0D8F2CA-low.png" alt="image"></p>
<h4 id="install-and-setup"><a href="#install-and-setup" class="headerlink" title="install and setup"></a>install and setup</h4><p>a few steps including:</p>
<ul>
<li><p>install ESXi on at least one host, either interactively or install through vSphere auto deploy, which include vServer. basically, <code>esxi</code> is free, and can be install on system as the hypervisor layer for any future vms. </p>
</li>
<li><p>setup esxi, e.g. esxi boot, network settings, direct console, syslog server for remote logging</p>
</li>
<li><p>deploy or install vCenter and services controller</p>
</li>
</ul>
<h2 id="Horizon"><a href="#Horizon" class="headerlink" title="Horizon"></a>Horizon</h2><p><img src="https://docs.vmware.com/en/VMware-Horizon-7/7.12/horizon-architecture-planning/images/GUID-5942D59B-AC5A-42F9-AD95-552C728E85AF-high.png" alt="image"></p>
<ul>
<li><p>client devices</p>
</li>
<li><p>Horizon client </p>
</li>
</ul>
<p>the client software for accesing remote desktops and apps, which will run on client devices. after logging in, users select from a list of remote desktops and apps that they are authorized to use. and admin can configure Horizon client to allow end users to select a display protocol.</p>
<ul>
<li>Horizon agent </li>
</ul>
<p>it’s installed on all vms, physical machines, storage server that used as <code>sources</code> for remote desktops and apps. if the remote desktop source is a vm, then first need install Horizon Agent service on that vm, and use the vm as a tepmplate, when create a pool from this vm, the agent is automatically installed on every remote desktop.</p>
<ul>
<li>Horizon admin</li>
</ul>
<p>used to configure Horizon connection server, deploy and manage remote desktops and apps, control user authentication e.t.c.</p>
<ul>
<li>Horizon connection server </li>
</ul>
<p>serve as a broker for client connections. </p>
<h4 id="a-rich-user-experience"><a href="#a-rich-user-experience" class="headerlink" title="a rich user experience"></a>a rich user experience</h4><ul>
<li>usb devices with remote desktops and apps </li>
</ul>
<p>basically can configure the ability to use USB devices from virtual desktop</p>
<ul>
<li>real-time video for webcams </li>
</ul>
<p>basically can use local client(end-user terminal)’s webcam or microphone in a remote desktop or published app. </p>
<ul>
<li>3d graphics</li>
</ul>
<p>with Blast or PCoIP display protocol enable remote desktop users to run 3D apps, e.g. google earch, CAD.</p>
<p>vSphere 6.0+ supports NVIDIA vGPU, basically share GPU among vms, as well as support amd GPU by vDAG, basically share gpu by making GPU appear as multiple PCI passthrough devies. </p>
<h4 id="desktop-or-app-pool"><a href="#desktop-or-app-pool" class="headerlink" title="desktop or app pool"></a>desktop or app pool</h4><p>first create one vm as a base image, then Horizon7 can generate a pool of remote desktops from the base image. similar for apps. </p>
<p>the benefit of desktop pool, if using vSphere vm as the base, is to automate the process of making as many identical virtual desktops as need, and the pool has manage tools to set or deploy apps to all virtual desktops in the same pool. for user assignment, either <code>dedicated-assignment pool</code>, which means each user is assigned a particular remote desktop adn returns to the same v-desktop at each login. it’s a one-to-one desktop-to-user relationship; or <code>floating-assignment pool</code>, basically users can shift to any v-desktop in the pool.</p>
<h4 id="security-features"><a href="#security-features" class="headerlink" title="security features"></a>security features</h4><ul>
<li><p>Horizon Client and Horizon Administrator communicate with a Horizon Connection Server host over secure HTTPS connections. </p>
</li>
<li><p>integrate two-factor authentication for user login</p>
</li>
<li><p>restrict remote desktop access by matching tags in v-desktop pool, but further restriction need design network topology to force certain clients to connect through. </p>
</li>
</ul>
<h2 id="refere"><a href="#refere" class="headerlink" title="refere"></a>refere</h2><p><a href="https://www.vmware.com/cn.html" target="_blank" rel="external">vmware product lists</a></p>
<p><a href="http://vga.zol.com.cn/581/5818519_all.html" target="_blank" rel="external">amd S7150 review</a></p>
<p><a href="https://developer.aliyun.com/ask/215008" target="_blank" rel="external">GPU SR-IOV</a></p>
<p><a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/network/sr-iov-virtual-functions--vfs-" target="_blank" rel="external">windows driver tech: PF &amp; VF</a></p>
<p><a href="https://docs.vmware.com/en/VMware-vSphere/6.7/com.vmware.esxi.install.doc/GUID-A71D7F56-6F47-43AB-9C4E-BAA89310F295.html" target="_blank" rel="external">vSphere install and setup doc</a></p>
<p><a href="https://docs.vmware.com/en/VMware-Horizon-7/index.html" target="_blank" rel="external">horizon7 install and setup doc</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/28/vmware-virtualization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/28/vmware-virtualization/" itemprop="url">vmware introduction</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-28T05:40:37-04:00">
                2020-03-28
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/28/vmware-virtualization/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/03/28/vmware-virtualization/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="background"><a href="#background" class="headerlink" title="background"></a>background</h2><p>sooner or later, we are in the direction of gpu virtualization, previously <a href="https://zjli2013.github.io/2020/03/14/hypervisor-and-gpu-virtualization/" target="_blank" rel="external">hypervisor and gpu virtual</a> is the first blog. recently, I’d went through openstack/kvm, vnc and now vmware. there is no doubt, any licensed product is not my prefer, but on the hand, it’s more expensive to hire an openstack engineer, compared to pay vmware. </p>
<p>vmware is not a windows-only, I had to throw my old mind first. the basic or back-end idea looks very similar to kvm. anyway, the core is <code>hypervisor layer</code>. once get understand one type of virtualization, it’s really easy to understand another. </p>
<h4 id="VMware-ESXi"><a href="#VMware-ESXi" class="headerlink" title="VMware ESXi"></a>VMware ESXi</h4><p><a href="https://www.vmware.com/products/esxi-and-esx.html" target="_blank" rel="external">ESXi hypervisor</a> is a Type1 or “bare metal” hypervisor,  also called <strong>vmware hypervisor</strong>, is a thin layer of software that interacts with the underlying resources of a physical computer(host machine), and allocates those resources to other os(guest machine).<br>and can support remotely access, just like kvm.</p>
<p>check <a href="https://pubs.vmware.com/vsphere-50/index.jsp?topic=%2Fcom.vmware.vsphere.install.doc_50%2FGUID-F3A960E9-57DF-4D2E-9127-A65AA670E643.html" target="_blank" rel="external">vSphere doc</a> about how to set BIOS and manage ESXi remotely.</p>
<p> <strong>BIOS boot configuration</strong> can be setted by configuring the boot order in BIOS during startup or by selecting a boot device from the boot device selection menu. the system BIOS has two options. One is for the boot sequence (floppy, CD-ROM, hard disk) and another for the hard disk boot order (USB key, local hard disk).</p>
<h4 id="VMware-workstation"><a href="#VMware-workstation" class="headerlink" title="VMware workstation"></a>VMware workstation</h4><p>workstation support multi guest os in a single host os(either windows or Linux), is a Type2 hypervisor, run as an app on host OS. one limitation of <code>workstation</code> is it only works in local host, can’t access remotely. </p>
<ul>
<li><p>free version,  <code>workstation player</code> </p>
</li>
<li><p>licensed version,  <code>workstation prof</code> </p>
</li>
</ul>
<p>in one word, workstation is good enough to multiple hardware usage, but not useful if remote access is required  </p>
<h4 id="VMware-vSphere"><a href="#VMware-vSphere" class="headerlink" title="VMware vSphere"></a>VMware vSphere</h4><p>the arch of vSphere has three layers:</p>
<ul>
<li><p>virtualization layer </p>
</li>
<li><p>management layer </p>
</li>
<li><p>interface layer(web, sdk, cli, virtual console)</p>
</li>
</ul>
<p>ESXi is the core hypervisor for VMware products, and also is the core of the vSphere package, the other two is: vSphere client and vSphere server.</p>
<p>vSphere server is enterprise-oriented, which is run based on ESXi layer. vSphere client is a client console/terminal. </p>
<ul>
<li><p><a href="https://www.vmware.com/cn/products/vsphere-hypervisor.html" target="_blank" rel="external">free version:  vSphere hypervisor</a></p>
</li>
<li><p><a href="https://www.vmware.com/cn/products/vcenter-server.html" target="_blank" rel="external">licensed fee version : vSphere with vServer</a></p>
</li>
</ul>
<p>nowadays there are no limitations on Physical CPU or RAM for Free ESXi. <a href="http://www.vmware.com/products/vsphere-hypervisor/gettingstarted.html" target="_blank" rel="external">here</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Specifications: </div><div class="line">Number of cores per physical CPU: No <span class="built_in">limit</span></div><div class="line">Number of physical CPUs per host: No <span class="built_in">limit</span></div><div class="line">Number of logical CPUs per host: 480</div><div class="line">Maximum vCPUs per virtual machine: 8</div></pre></td></tr></table></figure>
<h4 id="virtual-desktop-integration-VDI"><a href="#virtual-desktop-integration-VDI" class="headerlink" title="virtual desktop integration (VDI)"></a>virtual desktop integration (VDI)</h4><p>VDI virtualize a desktop OS on a server.  VDI offers centralized desktop management. the vmware tool is <code>VMware Horizon</code></p>
<h4 id="Horizon"><a href="#Horizon" class="headerlink" title="Horizon"></a>Horizon</h4><p>VMware Horizon can run VDI and apps in IT data center, and make VDI and apps as services to users. Horizon auto manage VDI and apps by simple setup configure files, then deliver apps or data from data center to end-user.</p>
<p>the modules in Horizon is extended-able and plug-in available:  physical layer, virtualization layer, desktop resource layer, app resource layer and user access. </p>
<p>Horizon basically delivers desktops and apps as a service. there are three versions:</p>
<ul>
<li><p>Horizon standard, a simple VDI.</p>
</li>
<li><p>Horizon advanced, can deliver desktops and apps through a unified workspace </p>
</li>
<li><p>Horizon enterprise, with a closed-loop management adn automation</p>
</li>
</ul>
<p>the <a href="https://techzone.vmware.com/resource/deploying-hardware-accelerated-graphics-vmware-horizon-7#sec1-sub1" target="_blank" rel="external">Horizon 7</a> has new features: </p>
<ul>
<li><p>Blast extrem display protocol</p>
</li>
<li><p>instant clone provisioning</p>
</li>
<li><p>vm app volumes app delivery </p>
</li>
<li><p>user env manager </p>
</li>
<li><p>integrated into remote desktop session host(RDSH) sessions </p>
</li>
</ul>
<h4 id="gpu-support-in-vmware"><a href="#gpu-support-in-vmware" class="headerlink" title="gpu support in vmware"></a>gpu support in vmware</h4><p>for vSphere, PCI passthrough can be used with any vSphere, including free vSphere Hypervisor. the only limitation is HW, may not supprot virtual well. GPU remotely accessible is our first-priority concern. </p>
<p>but vmware recommend their <a href="https://www.vmware.com/content/dam/digitalmarketing/vmware/en/pdf/partners/nvidia/vmware-nvidia-grid-vgpu-faq.pdf" target="_blank" rel="external">Horzion with NV’s vGPU</a><br>which has better flexibility and scalability. </p>
<p><a href="https://techzone.vmware.com/resource/deploying-hardware-accelerated-graphics-vmware-horizon-7#virtualsharedpassthroughgraphics" target="_blank" rel="external">Horizon support vGPU</a>, the user must install the appropriate vendor driver on the guest vm, all graphics commands are passed directly to GPU without having to be translated by the hypervisor. a vSphere Installation Bundle(VIB) is installed, which aids or perform the scheduling. depending on the card, up to 24 vm can share a GPU. most NV’s GPU which has vGPU feature can support. </p>
<p>on the other hand, the price of vGPU products(e.g. T4, M10, P6, V100, RTX8000 e.t.c) are 5 ~ 10 times higher than normal customer GPUs. e.g. GeFS not 5~10 times better. and the license fee for vgpu is horrible. </p>
<p>however, most enterprise still choice the Horzion and vGPU solution, even with this high cost. </p>
<p><a href="https://www.vmware.com/resources/compatibility/search.php" target="_blank" rel="external">VMware compatibility guide</a></p>
<h4 id="GPU-VDI-service-in-cloud"><a href="#GPU-VDI-service-in-cloud" class="headerlink" title="GPU VDI service in cloud"></a>GPU VDI service in cloud</h4><ul>
<li><a href="https://cloud.tencent.com/product/gpu" target="_blank" rel="external">tencent gpu cloud</a></li>
</ul>
<p>the gpu types for video decoding is Tesla P4, for  AI and HPC is Tesla v100, and for image workstation(VDI) is an AMD S7150.  </p>
<ul>
<li><a href="https://www.aliyun.com/product/ecs/gpu?spm=5176.224200.h2v3icoap.18.34ff6ed6KYchPn&amp;aly_as=aPNPrcAtg" target="_blank" rel="external">ali gpu cloud desktop</a></li>
</ul>
<p>the product is call <code>GA1(S7150)</code>, which is specially for cloud desktop.</p>
<p><a href="https://community.amd.com/thread/230570" target="_blank" rel="external">s7150x2 MxGPU with Horizon 7.5</a></p>
<h4 id="vnc-vs-vm"><a href="#vnc-vs-vm" class="headerlink" title="vnc vs vm"></a>vnc vs vm</h4><p>virtual network computing (vnc), applications running on one computer but displaying their windows on another. VNC provides remote control of a computer at some other location, any resources that are avaiable at the remote computer are available.  vpn simply connect you to a remote network.</p>
<p>no doubt, vm is much heavier than vnc. check <a href="https://blog.calsoftinc.com/2017/03/virtual-desktop-infrastructure-vdi-vs-remote-desktop-services-rds.html" target="_blank" rel="external">this blog</a> for compartion from vdi(a vm app) to vnc. vnc can’t tell if the remote is a physical server or a virtual server. come to our user case, we need about 100 separated user space, so virtualization provide better HW efficient and security, compared to deploy a single <code>bare metal OS</code> on the physical machine. </p>
<p>there are a few Linux based vnc client/server, e.g. <a href="https://linux.die.net/man/1/vncviewer" target="_blank" rel="external">vncviewer CLI</a>, as well as which supports OpenGL well, which helps to support better GPU usage. </p>
<ul>
<li><p><a href="https://virtualgl.org" target="_blank" rel="external">virtualGL</a></p>
</li>
<li><p><a href="http://www.karlrunge.com/x11vnc/" target="_blank" rel="external">x11vnc</a></p>
</li>
</ul>
<h2 id="refee"><a href="#refee" class="headerlink" title="refee"></a>refee</h2><p><a href="https://www.ibm.com/cloud/learn/vmware" target="_blank" rel="external">an essential vmware introduction from IBM</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/32873934" target="_blank" rel="external">what are vsphere, esxi, vcenter in Chienese</a></p>
<p><a href="https://www.vmware.com/products/vsphere-hypervisor.html" target="_blank" rel="external">vSphere Hypervisor</a></p>
<p><a href="https://pubs.vmware.com/vsphere-50/index.jsp?topic=%2Fcom.vmware.vsphere.install.doc_50%2FGUID-F3A960E9-57DF-4D2E-9127-A65AA670E643.html" target="_blank" rel="external">vmware vsphere doc</a></p>
<p><a href="https://blogs.vmware.com/apps/2018/10/how-to-enable-nvidia-v100-gpu-in-passthrough-mode-on-vsphere-for-machine-learning-and-other-hpc-workloads.html" target="_blank" rel="external">how to enable nvidia gpu in passthrough mode on vSphere</a></p>
<p><a href="https://docs.nvidia.com/grid/10.0/grid-vgpu-release-notes-vmware-vsphere/index.html" target="_blank" rel="external">nvidia vgpu for vmware release notes</a></p>
<p><a href="https://www.dell.com/support/article/en-us/sln288103/how-to-enable-a-vmware-virtual-machine-for-gpu-pass-through?lang=en" target="_blank" rel="external">how to enable vmware vm for GPU pass-through</a></p>
<p><a href="https://docs.openstack.org/project-deploy-guide/charm-deployment-guide/latest/app-pci-passthrough-gpu.html" target="_blank" rel="external">openstack PCI passthrough</a></p>
<p><a href="https://serverfault.com/questions/174003/how-can-opengl-graphics-be-displayed-remotely-using-vnc" target="_blank" rel="external">how can openGL graphics be displayed remotely using VNC</a></p>
<p><a href="http://www.azurew.com/vmware/horizon-7/3647.html" target="_blank" rel="external">vmware Horizon introduction in Chinese</a></p>
<p><a href="http://www.azurew.com/vmware/esxi-6-7/3622.html" target="_blank" rel="external">vmware ESXi 7.0 U1 test env build up</a></p>
<p><a href="https://www.sohu.com/a/334627623_314773" target="_blank" rel="external">云游戏能接盘矿卡市场吗</a></p>
<p><a href="http://www.azurew.com" target="_blank" rel="external">王哥哥的博客</a></p>
<p><a href="https://mp.sohu.com/profile?xpt=c29odXptdHoxem53c3ZAc29odS5jb20=&amp;_f=index_pagemp_1&amp;spm=smpc.content.author.2.1585641772438lK2g5Sw" target="_blank" rel="external">企业存储的博客</a></p>
<p><a href="https://blogs.vmware.com/euc/2015/03/nvidia-grid-vgpu-vmware-horizon.html" target="_blank" rel="external">in-depth: nv grid vGPU with vmware horizon 6.1</a></p>
<p><a href="https://www.nvidia.com/en-us/data-center/graphics-cards-for-virtualization/" target="_blank" rel="external">nvidia gpus recommended for virtualization</a></p>
<p><a href="https://developer.aliyun.com/ask/215008" target="_blank" rel="external">GPU SRIOV and AMD S7150</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/27/kvm-in-linux-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/27/kvm-in-linux-2/" itemprop="url">kvm in linux (2)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-27T04:04:00-04:00">
                2020-03-27
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/27/kvm-in-linux-2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/03/27/kvm-in-linux-2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="history-of-terminal"><a href="#history-of-terminal" class="headerlink" title="history of terminal"></a>history of terminal</h2><p>in history, computer is so huge and hosted at a big room, while the operator stay in another office room with another small machine as terminal to the host computer. as the host computer can run multi-users, each of which needs a terminal. </p>
<p>when times goes to personal computer(PC), there is no need for multi-users login, so each PC has integrated with I/O device(monitor and keybord)</p>
<p>nowadays, we have plenty of end-user terminals, e.g. smart phone, smart watch, Ipad e.t.c, all of these are <code>terminal</code>, as the real host computer is in cloud now. </p>
<p>in a word, any device that can accept input and display output is a <code>terminal</code>, which play the role as the human-machine interface.</p>
<h4 id="three-kinds-of-terminal"><a href="#three-kinds-of-terminal" class="headerlink" title="three kinds of terminal"></a>three kinds of terminal</h4><p>ssh is TCP/IP protocol, what’s inside is the remote terminal streaming flow.  the TCP/IP plays as the tunnel. of course, any communication protocol can play the role as the <code>tunnel</code>. </p>
<ul>
<li><p>local terminal, with usb to keyboard and monitor. </p>
</li>
<li><p>serial terminal, the guest machine connect to the host machine, who has keyboard and monitor. basically the guest machine borrow the host machine’s IO, which needs the host machine to run a terminal elmulator.</p>
</li>
<li><p>tcp/ip tunnel terminal, e.g. ssh</p>
</li>
</ul>
<p>both local terminal and serial terminal, directly connect to physical device, e.g. VGA interface, usb, serial e.t.c, so both are called  <strong>physical terminal</strong>.  ssh has nothing to do with physical device. </p>
<h4 id="tty"><a href="#tty" class="headerlink" title="tty"></a>tty</h4><p>in Linux,  <code>/dev/ttyX</code> represents a physical-terminal. from <code>tty1</code> to <code>tty63</code> are all local terminal. during Linux kernal init, 63 local terminals are generated, which can be switched by <code>Fn-Alt-Fx</code>, (x can be 1, 2, 3…). each current terminal is called <strong>focus terminal</strong>. </p>
<p>focus terminal is taken as global variable, so any input will transfer to current focus terminal. for serial, there is no focus terminal. </p>
<p>in Linux,  <code>/dev/console</code> represents current <strong>focus terminal</strong>, consider as a pointer to current focus terminal, wherever write sth to <code>/dev/console</code> will present at current focus terminal. </p>
<p><code>/dev/tty</code> is the global variable itself. whichever terminal you are working with, when write to <code>/dev/tty</code>, it will be present.</p>
<p><code>/dev/ttyS#num#</code> represents <strong>serial terminal</strong>. </p>
<h4 id="getty-amp-login"><a href="#getty-amp-login" class="headerlink" title="getty &amp; login"></a>getty &amp; login</h4><p>in multi-terminal time, each terminal must bind to one user, user must first login the terminal, <code>getty</code> is the login process, which is called in <code>init</code>. after login successfully, the terminal <code>tty#num#</code> can be owned by the user. </p>
<p>there are a few differenet version of <code>getty</code>, e.g. <code>agetty</code> e.t.c.</p>
<h4 id="pty-amp-pts"><a href="#pty-amp-pts" class="headerlink" title="pty &amp; pts"></a>pty &amp; pts</h4><p>pty stands for <code>pseudo-tty</code>, pty is a (master-slave) pair terminal device, including:  pts <code>pseudo-terminal slave</code>, and ptmx <code>pseudo-terminal master</code>. </p>
<p>a few concepts as following: </p>
<ul>
<li><p>serial terminal  <code>/dev/ttySn</code></p>
</li>
<li><p>pseudo-termianl  <code>/dev/pty/</code></p>
</li>
<li><p>controlling terminal <code>/dev/tty</code></p>
</li>
<li><p>console terminal  <code>/dev/console</code></p>
</li>
</ul>
<h2 id="Linux-Serial-Console"><a href="#Linux-Serial-Console" class="headerlink" title="Linux Serial Console"></a>Linux Serial Console</h2><h4 id="serial-communication"><a href="#serial-communication" class="headerlink" title="serial communication"></a>serial communication</h4><p>in old-style PC, serial is COM interface, also called <code>DB9 interface</code>, with RS-232 standard. </p>
<p>each user can connect to host machine through a <strong>terminal</strong>. <code>console</code> is same as <code>terminal</code> to connect user to host machine, but <code>console</code> is higher priority than <code>terminal</code>. nowadays less difference between terminal and console.  </p>
<p><code>Teletype</code> is the earliest terminal device, <code>tty</code> is physical or pseudo terminal connect to the host machine, nowadays <code>tty</code> also used for serial device.</p>
<p><code>serial</code> is the connection from terminal/keyboard to dev-board. </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ls /dev/tty*</div></pre></td></tr></table></figure>
<h4 id="configuration"><a href="#configuration" class="headerlink" title="configuration"></a>configuration</h4><p>Linux kernel must be configured to use the serial port as its console, which is done by passing the kernel the <code>console</code> parameter when the kernel is started by the boot loader.</p>
<p>the init system should keep a process runnign to monitor the serial console for logins, the monitoring process is traditionally named <strong>getty</strong></p>
<p>a number of system utilities need to be configured tomake them aware of the console, or configured to prevent them from disrupting the console.</p>
<h4 id="serial-port"><a href="#serial-port" class="headerlink" title="serial port"></a>serial port</h4><p>Linux names as the first serial port has the file name <code>/dev/ttys0</code>, the second serial port has the file name <code>/dev/ttyS1</code> and so on. most boot loaders have yet another naming scheme, the first serial port is numbered <code>0</code>, the second serial port is numbered <code>1</code></p>
<h4 id="configure-GRUB-boot-loader"><a href="#configure-GRUB-boot-loader" class="headerlink" title="configure GRUB boot loader"></a>configure GRUB boot loader</h4><p><a href="http://tldp.org/HOWTO/Remote-Serial-Console-HOWTO/configure-boot-loader-grub.html" target="_blank" rel="external">configure GRUB to use the serial console</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">info grub</div><div class="line">/boot/grub/grub.cfg</div><div class="line">serial --unit=0 --speed=9600 --word=8 --parity=no --stop=1 </div><div class="line">terminal serial</div></pre></td></tr></table></figure>
<h4 id="init-system"><a href="#init-system" class="headerlink" title="init system"></a>init system</h4><p>getty is started by <code>init</code>:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">co:2345:respawn:/sbin/getty ttyS0 CON9600 vt102</div></pre></td></tr></table></figure>
<ul>
<li><p><code>co</code> is an arbitrary entry, representing <code>console</code></p>
</li>
<li><p><code>2345</code>, run levels where this entry gets started. </p>
</li>
<li><p><code>respawn</code>, re-run the program if it dies</p>
</li>
<li><p><code>/sbin/getty ttyS0 CON9600 vt102</code>, getty connecting to /dev/ttyS0 with the settings for CON9600bps, and the terminal is VT100 model</p>
</li>
</ul>
<h2 id="virsh-console"><a href="#virsh-console" class="headerlink" title="virsh console"></a>virsh console</h2><p><a href="http://www.geekpills.com/operating-system/linux/kvm-virtualization-enable-kvm-virsh-console-access-ubuntu-linux-vm" target="_blank" rel="external">how to</a> connect ubuntu kvm virtual machine through serial console. in earlier version and distributions, it need to configure serial console in grub file, but in Ubuntu it’s very easy adn reliable as most of configurations and settings are already configured in OS.</p>
<h4 id="setup"><a href="#setup" class="headerlink" title="setup"></a>setup</h4><p>runs ubuntu14.04 guest mahcine on ubuntu 16.04 host machine. how to setup serial console, we have to connect guest machine and login on as root user</p>
<h4 id="login-through-SSH"><a href="#login-through-SSH" class="headerlink" title="login through SSH"></a>login through SSH</h4><ul>
<li>connect on KVM guest machine through ssh from host machine </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ssh 192.168.122.1</div><div class="line">hostname</div></pre></td></tr></table></figure>
<h4 id="connect-through-VNC"><a href="#connect-through-VNC" class="headerlink" title="connect through VNC"></a>connect through VNC</h4><p>conenct guest machine through VNC viewer and setup <code>serial console</code>. There are times when we need to troubleshoot Virtual Machines with unknown status like Hang in between, IP address issues, password problems, Serial console Hang etc. In case scenarios, we could relay on VNC configuration of KVM Guest Machines. </p>
<p>vnc viewer is a graphic viewer, so only need add <code>graphics</code> component in <a href="http://www.geekpills.com/wp-content/uploads/2017/08/ubuntu-17.04.txt" target="_blank" rel="external">config.xml</a>:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">graphics</span> <span class="attr">type</span>=<span class="string">'vnc'</span> <span class="attr">port</span>=<span class="string">'-1'</span> <span class="attr">autoport</span>=<span class="string">'yes'</span> <span class="attr">passwd</span>=<span class="string">'mypassword'</span>/&gt;</span></div></pre></td></tr></table></figure>
<p>run <code>virsh vncdisplay #vm_name#</code> we can get our vnc (server) IP, which then can be accessed by <code>vnc guest viewer</code>. here, <code>kvm virtual machine</code> has implemented a vnc server, and any <code>vnc viewer</code> in the same physical machine, can access this vnc server, even without external networking. </p>
<h4 id="configure-serial-console-in-ubuntu-guest"><a href="#configure-serial-console-in-ubuntu-guest" class="headerlink" title="configure serial console in ubuntu guest"></a>configure serial console in ubuntu guest</h4><p>after getting login console, we can start <code>serial console</code> and enable it with:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># systemctl start serial-getty@ttyS0</span></div><div class="line"><span class="comment"># systemctl enable serial-getty@ttyS0</span></div><div class="line">Created symlink /etc/systemd/system/getty.target.wants/serial-getty@ttyS0.service → /lib/systemd/system/serial-getty@.service.</div></pre></td></tr></table></figure>
<p>now we can connect <code>serial console</code> with <code>virsh console</code>:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">virsh console vm_name</div></pre></td></tr></table></figure>
<p>after installnation, reboot first, then the physical machine has dual-OS: <a href="https://www.server-world.info/en/note?os=Ubuntu_14.04&amp;p=kvm&amp;f=2" target="_blank" rel="external">GuestOS and HostOS</a>, which can exit GuestOS by <code>Ctrl + ]</code>, or login GuestOS by <code>virsh consoel #guest_vm#</code></p>
<p><strong>in summary</strong>, <code>virsh console</code> implement a serial console for kvm guest machine, which connect the guest machine to host machine through <code>serial</code>, which is not a <code>ssh</code>, need new knowledges about <code>serial</code>. </p>
<h2 id="virsh-console-hangs"><a href="#virsh-console-hangs" class="headerlink" title="virsh console hangs"></a>virsh console hangs</h2><p><code>virsh console vm</code> hangs at: <code>Escape character is ^]</code>, which can exit by <strong>ctrl + ]</strong> </p>
<h4 id="sol1"><a href="#sol1" class="headerlink" title="sol1:"></a><a href="https://stackoverflow.com/questions/11845280/virsh-console-hangs-at-the-escape-character" target="_blank" rel="external">sol1</a>:</h4><p>go to guest machine/terminal, and edit <code>/etc/default/grub</code>, appending;</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">GRUB_TERMINAL=serial</div><div class="line">GRUB_SERIAL_COMMAND=<span class="string">"serial --unit=0 --speed=115200 --word=8 --parity=no --stop=1"</span></div></pre></td></tr></table></figure>
<p>then execute:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">update-grub</div><div class="line">reboot</div></pre></td></tr></table></figure>
<p>the problem here, as the KVM vm shares the kernel of the host machine, if update <code>grub</code>, the host machine will reboot with serial connection(?)</p>
<h4 id="Centos-virsh-console-hangs"><a href="#Centos-virsh-console-hangs" class="headerlink" title="Centos virsh console hangs"></a><a href="https://www.cnblogs.com/xieshengsen/p/6215168.html" target="_blank" rel="external">Centos virsh console hangs</a></h4><ul>
<li><p>go to <code>/etc/securetty</code> and append <code>ttyS0</code></p>
</li>
<li><p>append <code>S0:12345:respawn:/sbin/agetty ttyS0 115200</code> to <code>/etc/init/ttyS0.conf</code></p>
</li>
<li><p>/etc/grub.conf(Centos) </p>
</li>
</ul>
<p>I only found <code>/boot/grub/grub.cfg</code> in ubuntu. In the <code>kernel</code> line, appending <code>console=ttyS0</code>. but there is no <code>kernel</code> line in <code>ubuntu grub.cfg</code>.</p>
<h4 id="Ubuntu-virsh-console-hangs"><a href="#Ubuntu-virsh-console-hangs" class="headerlink" title="Ubuntu virsh console hangs"></a><a href="https://www.cnblogs.com/sixloop/p/8044785.html" target="_blank" rel="external">Ubuntu virsh console hangs</a></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">systemctl <span class="built_in">disable</span> systemd-networkd-wait-online</div><div class="line">systemctl <span class="built_in">enable</span> serial-getty@ttyS0.service</div><div class="line">systemctl start serial-getty@ttyS0.service</div></pre></td></tr></table></figure>
<p>which gives: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Mar 27 11:17:18 ubuntu systemd[1]: Started Serial Getty on ttyS0.</div><div class="line">Mar 27 11:17:18 ubuntu agetty[445120]: /dev/ttyS0: not a tty</div></pre></td></tr></table></figure>
<p>check in <code>/dev/ttyS*</code> : </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">crw-rw---- 1 root dialout 4, 73 Mar 24 09:20 ttyS9</div><div class="line">crw--w---- 1 root tty     4, 64 Mar 24 09:20 ttyS0</div><div class="line">crw-rw---- 1 root dialout 4, 65 Mar 24 09:20 ttyS1</div></pre></td></tr></table></figure>
<p>interesting here,  <code>ttyS0</code> belongs to <code>tty</code> group, all otehr <code>ttyS#num#</code> belongs to <code>dialout</code> group. </p>
<h5 id="tty-and-dialout"><a href="#tty-and-dialout" class="headerlink" title="tty and dialout"></a>tty and dialout</h5><p><a href="https://stackoverflow.com/questions/30846176/how-to-change-tty-group-on-linux-build-with-buildroot" target="_blank" rel="external">change /dev/ttyS0 to tty group</a></p>
<p><a href="https://askubuntu.com/questions/210177/serial-port-terminal-cannot-open-dev-ttys0-permission-denied" target="_blank" rel="external">can’t access /dev/ttyS</a></p>
<p>add USER to tty/dialout group</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo usermod -a -G tty <span class="variable">$USER</span></div><div class="line">sudo usermod -a -G dialout <span class="variable">$USER</span></div></pre></td></tr></table></figure>
<p>reboot and go on</p>
<h2 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h2><p><a href="http://tldp.org/HOWTO/Remote-Serial-Console-HOWTO/" target="_blank" rel="external">remote serial console HOWTO</a></p>
<p><a href="https://www.cnblogs.com/huan-huan/p/8522472.html" target="_blank" rel="external">remote serial console HOWTO in Chinese</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1527544" target="_blank" rel="external">understand Linux terminal history in Chinese</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1533217" target="_blank" rel="external">Linux terminal introduction in Chinese</a></p>
<p><a href="https://tutorial.linux.doc.embedfire.com/zh_CN/latest/linux_app/uart_tty.html" target="_blank" rel="external">serial communication in Chinese</a></p>
<p><a href="https://wiki.archlinux.org/index.php/Working_with_the_serial_console" target="_blank" rel="external">arhLinux: working with the serial console</a></p>
<p><a href="https://www.gnu.org/software/grub/manual/grub/grub.html" target="_blank" rel="external">gnu org: grub</a></p>
<p><a href="http://www.geekpills.com/operating-system/linux/kvm-virtualization-start-vnc-remote-access-guest-operating-systems" target="_blank" rel="external">geekpills: start vnc remote access for guest operating systems</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/24/kvm-libvert-in-linux-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/24/kvm-libvert-in-linux-1/" itemprop="url">kvm/libvert in linux (1)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-24T07:10:18-04:00">
                2020-03-24
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/24/kvm-libvert-in-linux-1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/03/24/kvm-libvert-in-linux-1/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="kvm-background"><a href="#kvm-background" class="headerlink" title="kvm background"></a>kvm background</h2><p>kernel based virtual machine(KVM), is a Linux kernel module, which transfer Linux to a Hypervisor, which depends on the ability of hardware virtualization. usually the physical machine is called <code>Host</code>, and the virtual machine(VM) run in host is called <code>Guest</code>. </p>
<p>kvm itself doesn’t do any hardware emulator, which needs guest space to set an address space through <code>dev/kvm</code> interface, to which provides virtual I/O, e.g. QEMU.</p>
<p><a href="https://github.com/virt-manager/virt-manager" target="_blank" rel="external">virt-manager</a> is a GUI tool for managing virtual machines via <strong>libvirt</strong>, mostly used by QEMU/KVM virtual machines. </p>
<ul>
<li>check kvm model info </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">modinfo kvm</div></pre></td></tr></table></figure>
<ul>
<li>whether CPU support hardware virtualization</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">egrep -c <span class="string">'(vmx|svm)'</span> /proc/cpuinfo</div><div class="line">kvm-ok</div></pre></td></tr></table></figure>
<h2 id="install-kvm"><a href="#install-kvm" class="headerlink" title="install kvm"></a>install kvm</h2><ul>
<li>install libvirt and qemu packages </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sudo apt install qemu qemu-kvm libvirt-bin bridge-utils</div><div class="line">modprobe kvm <span class="comment">#load kvm module</span></div><div class="line">systemctl start libvirtd.service <span class="comment">#</span></div><div class="line">vrish iface-bridge ens33 virbr0 <span class="comment">#create a bridge network mac address</span></div></pre></td></tr></table></figure>
<ul>
<li><a href="https://www.howtogeek.com/50787/add-a-user-to-a-group-or-second-group-on-linux/" target="_blank" rel="external">add current user</a> to libvirtd group </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo usermod -aG libvirtd $(whoami)</div><div class="line">sudo usermod -aG libvirt-qemu $(whoami)</div><div class="line">sudo reboot</div></pre></td></tr></table></figure>
<h4 id="network-in-kvm"><a href="#network-in-kvm" class="headerlink" title="network in kvm"></a>network in kvm</h4><p><a href="https://www.linux.com/topic/networking/creating-virtual-machines-kvm-part-2-networking/" target="_blank" rel="external">default network</a> is NAT(network address transation), when you create a new virtual machine, this forwards network traffic through your host system; if the host is connected to the Internet, then your vm have Internet access.</p>
<p>VM manager also creates an Ethernet bridge between the host and virtual network, so can ping IP address of VM from host, also ok on the other way.</p>
<ul>
<li>List of network cards</li>
</ul>
<p>go to <code>/sys/class/net</code> there are a few nic:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">lrwxrwxrwx 1 root root 0 Mar 24 16:18 docker0 -&gt; ../../devices/virtual/net/docker0</div><div class="line">lrwxrwxrwx 1 root root 0 Mar 24 16:18 docker_gwbridge -&gt; ../../devices/virtual/net/docker_gwbridge</div><div class="line">lrwxrwxrwx 1 root root 0 Mar 24 16:18 eno1 -&gt; ../../devices/pci0000:00/0000:00:1f.6/net/eno1</div><div class="line">lrwxrwxrwx 1 root root 0 Mar 24 16:18 enp4s0f2 -&gt; ../../devices/pci0000:00/0000:00:1c.4/0000:02:00.0/0000:03:03.0/0000:04:00.2/net/enp4s0f2</div><div class="line">lrwxrwxrwx 1 root root 0 Mar 24 16:18 lo -&gt; ../../devices/virtual/net/lo</div><div class="line">lrwxrwxrwx 1 root root 0 Mar 24 16:18 veth1757da9 -&gt; ../../devices/virtual/net/veth1757da9</div><div class="line">lrwxrwxrwx 1 root root 0 Mar 24 16:18 vethd4d0e7f -&gt; ../../devices/virtual/net/vethd4d0e7f</div><div class="line">lrwxrwxrwx 1 root root 0 Mar 24 16:18 virbr0 -&gt; ../../devices/virtual/net/virbr0</div><div class="line">lrwxrwxrwx 1 root root 0 Mar 24 16:18 virbr0-nic -&gt; ../../devices/virtual/net/virbr0-nic</div></pre></td></tr></table></figure>
<ul>
<li>multi interfaces on same MAC addresss</li>
</ul>
<p>when <a href="https://networkengineering.stackexchange.com/questions/34754/same-mac-on-different-interfaces" target="_blank" rel="external">a switch receives</a> a frame from an interface, it creates an entry in the mac-address table with the source mac and interface. it the source mac is known, it will update the table with the new interface. so bascially if you assign the mac address of an external-network-avialable NIC-A to the special vm, NIC-A is lost. </p>
<ul>
<li>virbr0 </li>
</ul>
<p>the <code>default</code> bridge NIC of libvirt is <code>virbr0</code>. bridge network means the guest and host share the same physical Network Cards, as well as offer the guest a special IP, which can be used to access the guest directly. the <code>virbr0</code> do <code>network address translation</code>(NAT), basically transfer the internal IP address to an external IP address, which means the internal IP address is un-visiable from outside. </p>
<p>to add the <code>virbr0</code>, when it is deleted previously: </p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">brctl addbr virbr0</div><div class="line">brctl stp virbr0 on</div><div class="line">brctl setf virbr0 0</div><div class="line">ifconfig virbr0 192.168.122.1 netmask 255.255.255.0 up</div></pre></td></tr></table></figure>
<p> to disable or delete <code>virbr0</code>:</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">virsh net-destroy default</div><div class="line">virsh net-undefine default</div><div class="line">service libvirtd restart</div><div class="line">ifconfig</div></pre></td></tr></table></figure>
<p> after starting the vm, can check the bridge network by:</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">virsh domiflist vm-name</div><div class="line">virsh domifaddr vm-name</div></pre></td></tr></table></figure>
<p> and we can login the vm, (after we assign current user to <code>libvert</code> group), and check NAT is working: </p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ssh 192.168.122.1 </div><div class="line">ping www.bing.com</div><div class="line">ping 10.20.xxx.xxx  <span class="comment"># ping the host external IP</span></div></pre></td></tr></table></figure>
<p>basically the vm can access external website, but external web can’t access vm_name.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">attach-interface/detach-interface/domiflist</div></pre></td></tr></table></figure>
<h2 id="create-vm"><a href="#create-vm" class="headerlink" title="create vm"></a>create vm</h2><p>create a virtual machine,  can be done either through <code>virt-install</code> or <code>config.xml</code>:</p>
<h3 id="virt-install"><a href="#virt-install" class="headerlink" title="virt-install"></a>virt-install</h3><p><code>virt-install</code> has depends on system python, pip. if current ptyhon version is 2.7, it gives warnning and return -1 due to unfound module. so make sure the #PYTHONPATH# point to the correct path if you have multi python in system. and <code>virt-install</code> has to run with <code>root</code>. </p>
<p>then can start a virtual machine with <a href="https://unix.stackexchange.com/questions/502560/virsh-connected-to-domain-name-escape-character-is" target="_blank" rel="external">following command options</a>)</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">sudo virt-install \</div><div class="line">--name v1 \</div><div class="line">--ram 2048 \</div><div class="line"><span class="comment"># --cdrom=ubuntu-16.04.3-server-amd64.iso \</span></div><div class="line">--disk path=/var/lib/libvirt/images/ubuntu.qcow2 \</div><div class="line">--vcpus 2 \</div><div class="line">--virt-type kvm \</div><div class="line">--os-type linux \</div><div class="line">--os-variant ubuntu16.04 \</div><div class="line">--graphics none \</div><div class="line">--console pty, target_type=serial \</div><div class="line">--location /var/lib/libvirt/images/ubuntu-16.04.3-server-amd64.iso \</div><div class="line">--network bridge:virbr0 \ </div><div class="line">--extra-args console=ttyS0</div></pre></td></tr></table></figure>
<p>during the installation, the process looks very much like Linux installation on a bare machine. I suppose this way, it’s like install a dual-OS in the bare machine. during the installation, there is an error <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=833706" target="_blank" rel="external">failed to load installer component libc6-udeb</a>, it’s may due to the iso or img has missing component.</p>
<h3 id="config-xml"><a href="#config-xml" class="headerlink" title="config.xml"></a>config.xml</h3><ul>
<li><p>create volumes </p>
<p>go to /var/lib/libvirt/images, and create volume as following: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">qemu-img create -f qcow2 ubuntu.qcow2 40G</div></pre></td></tr></table></figure>
</li>
</ul>
<p>check <a href="https://www.jianshu.com/p/4a50c02aa16e" target="_blank" rel="external">qemu-kvm &amp; qemu-img introduction</a></p>
<ul>
<li><p>add vm image </p>
<p>cp ubuntu.iso to <code>/var/lib/libvirt/images</code> as well:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ubuntu.qcow2</div><div class="line">ubuntu-16.04.3-server-amd64.iso</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="vm-xml"><a href="#vm-xml" class="headerlink" title="vm.xml"></a>vm.xml</h4><p>follow an <a href="https://docs.fedoraproject.org/en-US/Fedora/18/html/" target="_blank" rel="external">xml sample</a>: </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">domain</span> <span class="attr">type</span>=<span class="string">'kvm'</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>v1<span class="tag">&lt;/<span class="name">name</span>&gt;</span> </div><div class="line">        <span class="tag">&lt;<span class="name">memory</span>&gt;</span>4048576<span class="tag">&lt;/<span class="name">memory</span>&gt;</span> </div><div class="line">        <span class="tag">&lt;<span class="name">currentMemory</span>&gt;</span>4048576<span class="tag">&lt;/<span class="name">currentMemory</span>&gt;</span> </div><div class="line">        <span class="tag">&lt;<span class="name">vcpu</span>&gt;</span>2<span class="tag">&lt;/<span class="name">vcpu</span>&gt;</span> </div><div class="line">        <span class="tag">&lt;<span class="name">os</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">type</span> <span class="attr">arch</span>=<span class="string">'x86_64'</span> <span class="attr">machine</span>=<span class="string">'pc'</span>&gt;</span>hvm<span class="tag">&lt;/<span class="name">type</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">boot</span> <span class="attr">dev</span>=<span class="string">'cdrom'</span>/&gt;</span> </div><div class="line">       <span class="tag">&lt;/<span class="name">os</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">features</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">acpi</span>/&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">apic</span>/&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">pae</span>/&gt;</span></div><div class="line">       <span class="tag">&lt;/<span class="name">features</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">clock</span> <span class="attr">offset</span>=<span class="string">'localtime'</span>/&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">on_poweroff</span>&gt;</span>destroy<span class="tag">&lt;/<span class="name">on_poweroff</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">on_reboot</span>&gt;</span>restart<span class="tag">&lt;/<span class="name">on_reboot</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">on_crash</span>&gt;</span>destroy<span class="tag">&lt;/<span class="name">on_crash</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">serial</span> <span class="attr">type</span>=<span class="string">'pty'</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">target</span> <span class="attr">port</span>=<span class="string">'0'</span> /&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">serial</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">console</span> <span class="attr">type</span>=<span class="string">'pty'</span> &gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">'serial'</span> <span class="attr">port</span>=<span class="string">'0'</span> /&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">console</span>&gt;</span> </div><div class="line">      <span class="tag">&lt;<span class="name">devices</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">emulator</span>&gt;</span>/usr/bin/qemu-system-x86_64<span class="tag">&lt;/<span class="name">emulator</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">'file'</span> <span class="attr">device</span>=<span class="string">'disk'</span>&gt;</span></div><div class="line">          <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">'qemu'</span> <span class="attr">type</span>=<span class="string">'qcow2'</span>/&gt;</span></div><div class="line">           <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">'/var/lib/libvirt/images/ubuntu.qcow2'</span>/&gt;</span> </div><div class="line">           <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">'hda'</span> <span class="attr">bus</span>=<span class="string">'ide'</span>/&gt;</span></div><div class="line">         <span class="tag">&lt;/<span class="name">disk</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">'file'</span> <span class="attr">device</span>=<span class="string">'cdrom'</span>&gt;</span></div><div class="line">           <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">'/var/lib/libvirt/images/ubuntu-16.04.3-server-amd64.iso'</span>/&gt;</span> </div><div class="line">           <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">'hdb'</span> <span class="attr">bus</span>=<span class="string">'ide'</span>/&gt;</span></div><div class="line">         <span class="tag">&lt;/<span class="name">disk</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">'bridge'</span> &gt;</span></div><div class="line">           <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">'52:54:00:98:45:3b'</span> /&gt;</span></div><div class="line">           <span class="tag">&lt;<span class="name">source</span> <span class="attr">bridge</span>=<span class="string">'virbr0'</span> /&gt;</span></div><div class="line">	   <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">'virtio'</span> /&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">interface</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">serial</span> <span class="attr">type</span>=<span class="string">'pty'</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">target</span> <span class="attr">port</span>=<span class="string">'0'</span> /&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">serial</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">console</span> <span class="attr">type</span>=<span class="string">'pty'</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">'serial'</span> <span class="attr">port</span>=<span class="string">'0'</span> /&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">console</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">'mouse'</span> <span class="attr">bus</span>=<span class="string">'ps2'</span>/&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">graphics</span> <span class="attr">type</span>=<span class="string">'vnc'</span> <span class="attr">port</span>=<span class="string">'-1'</span> <span class="attr">autoport</span>=<span class="string">'no'</span> <span class="attr">listen</span> = <span class="string">'0.0.0.0'</span> <span class="attr">keymap</span>=<span class="string">'en-us'</span>&gt;</span></div><div class="line">	   <span class="tag">&lt;<span class="name">listen</span> <span class="attr">type</span>=<span class="string">'address'</span> <span class="attr">address</span>=<span class="string">'0.0.0.0'</span> /&gt;</span></div><div class="line">	 <span class="tag">&lt;/<span class="name">graphics</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">devices</span>&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">domain</span>&gt;</span></div></pre></td></tr></table></figure>
<p>a few tips about the xml above:</p>
<ul>
<li><p>\<interface\> component is necessary for network interface. </interface\></p>
</li>
<li><p>if not assign a special <code>mac address</code> in the interface. since we had define <code>virbr0</code>, an automatic mac address will be assigned, which is unique from the host machine’s IP, but if ssh login to the guest (ssh username@guest_ip), it actually can ping host machine’s iP or any external ip(www.being.com)</p>
</li>
<li><p>\<serial tty\=""> compoennt, is setting for <code>console</code>.</serial></p>
</li>
</ul>
<p>finally run the following CLI to start vm: v1:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">virsh define vm1.xml </div><div class="line">virsh start ubuntu(the image)</div><div class="line">virsh list</div></pre></td></tr></table></figure>
<h2 id="libvert"><a href="#libvert" class="headerlink" title="libvert"></a>libvert</h2><p>libvert is a software package to manage vm, including libvirtAPI, libvirtd(daemon process), and virsh tool. </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo systemctl restart libvirtd</div><div class="line">systemctl status libvirtd</div></pre></td></tr></table></figure>
<p>only when <code>libvirtd</code> service is running, can we manage vm through <code>libvert</code>. all configure of the vm is stored ad <code>/etc/libvirt/qemu</code>. for <code>virsh</code> there are two mode:</p>
<ul>
<li>immediate way e.g. in host shell <code>virsh list</code> </li>
<li>interactive shell e.g. by <code>virsh</code> to virsh shell</li>
</ul>
<h4 id="common-virsh-commands"><a href="#common-virsh-commands" class="headerlink" title="common virsh commands"></a>common virsh commands</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">virsh &lt;command&gt; &lt;domain-id&gt; [options]</div><div class="line">virsh uri #hypervisor&apos;s URI</div><div class="line">virsh hostname</div><div class="line">virsh nodeinfo </div><div class="line">virsh list (running, idel, paused, shutdown, shutoff, crashed, dying)</div><div class="line">virsh shutdown &lt;domain&gt;</div><div class="line">virsh start &lt;domain&gt;</div><div class="line">virsh destroy &lt;domain&gt;</div><div class="line">virsh undefine &lt;domain&gt;</div><div class="line">virsh create #through config.xml</div><div class="line">virsh connect  #reconnect to hypervisor </div><div class="line">virsh nodeinfo </div><div class="line">virsh define #file domain</div><div class="line">virsh  setmem domain-id kbs #immediately</div><div class="line">virsh sertmaxmem domain-id kbs</div><div class="line">virsh setvcpus domain-id count </div><div class="line">virsh vncdisplay domain-id #listed vnc port</div><div class="line">virsh console &lt;domain&gt;</div></pre></td></tr></table></figure>
<h4 id="virsh-network-commands"><a href="#virsh-network-commands" class="headerlink" title="virsh network commands"></a>virsh network commands</h4><ul>
<li>host configure </li>
</ul>
<p>Every standard libvirt installation provides NAT based connectivity to virtual machines out of the box. This is the so called ‘default virtual network’ </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">virsh net-list </div><div class="line">virsh net-define /usr/share/libvirt/networks/default.xml</div><div class="line">virsh net-start default</div><div class="line">virsh net-info default</div><div class="line">virsh net-dumpxml default</div></pre></td></tr></table></figure>
<p>When the <a href="https://wiki.libvirt.org/page/Networking" target="_blank" rel="external">libvirt default network</a>is running, you will see an isolated bridge device. This device explicitly does <em>NOT</em> have any physical interfaces added, since it uses NAT + forwarding to connect to outside world. <strong>Do not add interfaces</strong>. Libvirt will add iptables rules to allow traffic to/from guests attached to the virbr0 device in the INPUT, FORWARD, OUTPUT and POSTROUTING chains.</p>
<p>if <code>default.xml</code> is not found, check <a href="https://blog.programster.org/kvm-missing-default-network" target="_blank" rel="external">fix missing default network</a>, <code>default.xml</code> is sth like:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">network</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>default<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">uuid</span>&gt;</span>9a05da11-e96b-47f3-8253-a3a482e445f5<span class="tag">&lt;/<span class="name">uuid</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">forward</span> <span class="attr">mode</span>=<span class="string">'nat'</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">bridge</span> <span class="attr">name</span>=<span class="string">'virbr0'</span> <span class="attr">stp</span>=<span class="string">'on'</span> <span class="attr">delay</span>=<span class="string">'0'</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">'52:54:00:0a:cd:21'</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">ip</span> <span class="attr">address</span>=<span class="string">'192.168.122.1'</span> <span class="attr">netmask</span>=<span class="string">'255.255.255.0'</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dhcp</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">range</span> <span class="attr">start</span>=<span class="string">'192.168.122.2'</span> <span class="attr">end</span>=<span class="string">'192.168.122.254'</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dhcp</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">ip</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">network</span>&gt;</span></div></pre></td></tr></table></figure>
<p>then run:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo virsh net-define --file default.xml</div><div class="line">sudo virsh net-start default</div><div class="line">sudo virsh net-autostart --network default</div></pre></td></tr></table></figure>
<p>if bind <code>default</code> to <code>virbr0</code> already, need delete this brige first.</p>
<ul>
<li>guest configure </li>
</ul>
<p>add the following to guest xml configure:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">'network'</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">source</span> <span class="attr">network</span>=<span class="string">'default'</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">'00:16:3e:1a:b3:4a'</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">interface</span>&gt;</span></div></pre></td></tr></table></figure>
<p>more details can check <a href="https://wiki.libvirt.org/page/Networking" target="_blank" rel="external">virsh networking doc</a></p>
<h4 id="snapshots"><a href="#snapshots" class="headerlink" title="snapshots"></a>snapshots</h4><p>snapshots used to save the state(disk mem, time..) of a domain</p>
<ul>
<li>create a snapshot for a vm </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">virsh snapshot-create-as --domain test_vm  \</div><div class="line">--name <span class="string">"test_vm_snapshot1"</span> \ </div><div class="line">--description <span class="string">"test vm snapshot "</span></div></pre></td></tr></table></figure>
<ul>
<li>list all snapshots for vm</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">virsh snapshot-list test_vm</div></pre></td></tr></table></figure>
<ul>
<li>display info about a snapshot </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">virsh snapshot-info --domain test_vm --snapshotname test_vm_snapshot1</div><div class="line">``` </div><div class="line"></div><div class="line">* delete a snapshot </div><div class="line"></div><div class="line">```sh</div><div class="line">virsh snapshot-delete --domain test_vm --snapshotname test_vm_shapshot1</div></pre></td></tr></table></figure>
<h4 id="manage-volumes"><a href="#manage-volumes" class="headerlink" title="manage volumes"></a>manage volumes</h4><ul>
<li>create a storage volume</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">virsh vol-create-as default test_vol.qcow2 10G</div><div class="line"><span class="comment"># create test_vol on the deafult storage pool</span></div><div class="line">du -sh /var/lib/libvirt/images/test_vol.qcow2</div></pre></td></tr></table></figure>
<ul>
<li>attach  to a vm</li>
</ul>
<p>attache <code>test-vol</code> to vm <code>test</code> </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">virsh attach-disk --domain <span class="built_in">test</span> \</div><div class="line">--<span class="built_in">source</span> /var/lib/libvirt/images/<span class="built_in">test</span>-vol.qcow2 \</div><div class="line">--persistent --target vdb</div></pre></td></tr></table></figure>
<p>which can be check that the vm has added a block device <code>/dev/vdb</code> </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ssh <span class="built_in">test</span>  <span class="comment">#how to ssh to vm </span></div><div class="line">lsblk --output NAME,SIZE,TYPE</div></pre></td></tr></table></figure>
<p>or directly grow disk image:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">qemu-img resize /var/lib/libvirt/images/test.qcow2 +1G</div></pre></td></tr></table></figure>
<ul>
<li>detach from a vm</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">virsh detach-disk --domain <span class="built_in">test</span> --persistent --live --target vdb</div></pre></td></tr></table></figure>
<ul>
<li>delete a vm </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">virsh vol-delete test_vol.qcow2 --pool default</div><div class="line">virsh pool-refresh default</div><div class="line">virsh vol-list default</div></pre></td></tr></table></figure>
<h4 id="fs-virsh-commands"><a href="#fs-virsh-commands" class="headerlink" title="fs virsh commands"></a>fs virsh commands</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">virt-ls -l -d &lt;domain&gt; &lt;directory&gt;</div><div class="line">virt-cat -d &lt;domain&gt; &lt;file_path&gt;</div></pre></td></tr></table></figure>
<h2 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h2><p><a href="http://www.178linux.com/103971" target="_blank" rel="external">kvm introduction in chinese</a></p>
<p><a href="https://help.ubuntu.com/community/KVM/Installation" target="_blank" rel="external">kvm pre-install checklist</a></p>
<p><a href="http://www.yolinux.com/TUTORIALS/LinuxTutorialNetworking.html" target="_blank" rel="external">Linux network configuration</a></p>
<p><a href="https://help.ubuntu.com/community/KVM/Installation" target="_blank" rel="external">kvm installation official doc</a></p>
<p><a href="https://graspingtech.com/creating-virtual-machine-virt-install/" target="_blank" rel="external">creating vm with virt-install</a></p>
<p><a href="https://linuxhint.com/install_kvm_ubuntu/" target="_blank" rel="external">install KVM in ubuntu</a></p>
<p><a href="https://www.jianshu.com/p/110b60c14a8b" target="_blank" rel="external">jianshu: kvm network configure</a></p>
<p><a href="https://www.cnblogs.com/CloudMan6/p/5308071.html" target="_blank" rel="external">cloudman: understand virbr0</a></p>
<p><a href="https://libvirt.org/sources/virshcmdref/html-single/" target="_blank" rel="external">virsh command refer</a></p>
<p><a href="https://www.ibm.com/developerworks/cn/linux/1409_qiaoly_qemuimgages/index.html" target="_blank" rel="external">qcow2  vs  raw</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/20/real-time-matlab-simulink-code-generation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/20/real-time-matlab-simulink-code-generation/" itemprop="url">real-time matlab/simulink code generation</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-20T06:44:35-04:00">
                2020-03-20
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/20/real-time-matlab-simulink-code-generation/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/03/20/real-time-matlab-simulink-code-generation/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="real-time-matlab-code-generation"><a href="#real-time-matlab-code-generation" class="headerlink" title="real-time matlab code generation"></a>real-time matlab code generation</h1><h2 id="backgroud"><a href="#backgroud" class="headerlink" title="backgroud"></a>backgroud</h2><p>Python and Linux vs Matlab and Windows, I prefer the front. but as a teamwork, I have to understand how matlab/Simulink code generation works, especially with real-time model. </p>
<h2 id="Simulink-Coder"><a href="#Simulink-Coder" class="headerlink" title="Simulink Coder"></a>Simulink Coder</h2><p>previously named as Real-Time workshop(rtw).</p>
<h4 id="real-time-model-data-structure"><a href="#real-time-model-data-structure" class="headerlink" title="real time model data structure"></a>real time model data structure</h4><p>access rtModel data by using a set of macros analogous to the ssSetxxx and ssGetxxx macros that S-functions use to access SimStruct data, including noninlined S-functions compiled by the code generator.</p>
<p>You need to use the set of macros rtmGetxxx and rtmSetxxx to access the real-time model data structure. The rtModel is an optimized data structure that replaces SimStruct as the top level data structure for a model. The rtmGetxxx and rtmSetxxx macros are used in the generated code as well as from the main.c or main.cpp module.</p>
<p>Usage of rtmGetxxx and rtmSetxxx macros is the same as for the ssSetxxx and ssGetxxx versions, except that you replace SimStruct S by real-time model data structure rtM. </p>
<table>
<thead>
<tr>
<th>rtm macro</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td> rtmGetdX(rtm)</td>
<td>get the derivatives of block continous states</td>
<td></td>
</tr>
<tr>
<td> rtmGetNumSampleTimes(RT_MDL rtM)</td>
<td>Get the number of sample times that a block has</td>
<td></td>
</tr>
<tr>
<td>rtmGetSampleTime(RT_MDL rtM, int TID)</td>
<td>Get task sample time</td>
</tr>
<tr>
<td>rtmGetStepSize(RT_MDL)</td>
<td>Return the fundamental step size of the model</td>
</tr>
<tr>
<td>rtmGetT(RT_MDL,t)</td>
<td>Get the current simulation time </td>
</tr>
<tr>
<td>rtmGetErrorStatus(rtm)</td>
<td>Get the current error status</td>
</tr>
</tbody>
</table>
<h4 id="code-generation-to-used-externally"><a href="#code-generation-to-used-externally" class="headerlink" title="code generation to used externally :"></a>code generation to used externally :</h4><p>1) Install the Real-Time Workshop (RTW) Toolbox for MATLAB;</p>
<p>2) Create the Simulink Model and Prepare it for autocoding;</p>
<p>3) Correctly configure the RTW options and include a *.tcl file;</p>
<p>4) Build any S-Functions of the model;</p>
<p>5) Build the model (generate autocode including makefile);</p>
<p>6) Tune up the makefile with any missing options/libraries/files;</p>
<p>7) Integrate autocoded model in RTEMS using the wrapper.</p>
<h4 id="ert-main"><a href="#ert-main" class="headerlink" title="ert_main()"></a>ert_main()</h4><p>the following is a common sample of real-time model generated C code. </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">rt_OneStep(<span class="keyword">void</span>)&#123;</div><div class="line">	simulation_custom_step() ;</div><div class="line">&#125;</div><div class="line"></div><div class="line">main()&#123;</div><div class="line">	simulation_initialize();</div><div class="line">	<span class="keyword">while</span>(rtmGetErrorStatus(xx_M) == (<span class="literal">NULL</span>))&#123;</div><div class="line">		 rt_OneStep();</div><div class="line">    &#125;</div><div class="line">    simulation_terminate();</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div></pre></td></tr></table></figure>
<p>if no time interupt setting up, there is a <a href="https://www.mathworks.com/matlabcentral/answers/92639-how-do-i-customize-the-main-function-generated-by-real-time-workshop-embedded-coder-5-2-r2008b" target="_blank" rel="external">Warning: The simulation will run forever. Generated ERT main won’t simulate model step behavior. To change this behavior select the ‘MAT-file logging’ option.</a></p>
<p>from real-time Matlab/Simulink model to C/C++ code, we need manually set the while-loop break statement. for example, we can  run 100 times or based on some event-trigger.</p>
<h4 id="Timing"><a href="#Timing" class="headerlink" title="Timing"></a>Timing</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">  <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">    uint16_T clockTick1;  <span class="comment">//base rate counter (5s)</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">      uint16_T TID[<span class="number">2</span>];</div><div class="line">    &#125; TaskCounters;  <span class="comment">//subtask counter (0.02s)</span></div><div class="line">  &#125; Timing;</div><div class="line">  </div><div class="line">currentTime =  Timing.clockTick1 * <span class="number">5.0</span> ;</div></pre></td></tr></table></figure>
<p>absolute timer for sample time: [5.0s, 0.0s]. the resolution of this integer timer is 5.0, which is the step size of the task. so bascially, assuming to run one step need physcially 5s, but inside the module, each internal step is 0.02s. </p>
<p>if we run a test scenario with 20s, basically we have 4 clockTick1 and inside each clockTick1, we have 250 times internal steps.</p>
<h2 id="a-few-modification"><a href="#a-few-modification" class="headerlink" title="a few modification"></a>a few modification</h2><p>the following is a few modification based on the auto-generated C code:</p>
<ul>
<li>redefine data structure</li>
</ul>
<p>matlab coder use most <code>C structure</code> to package signals. in our adas model, most signals have similar inner items, so first I’d like to define a <code>parent structre</code>, then define all other adas signals using <code>typedef</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> structure parent  adas_sig1 ;</div><div class="line"><span class="keyword">typedef</span> structure parent  adas_sig2 ;</div><div class="line"><span class="keyword">typedef</span> structure parent  adas_sig3 ;</div><div class="line"><span class="keyword">typedef</span> structure parent  adas_sig4 ;</div></pre></td></tr></table></figure>
<p>with the <code>parent struct</code>, we can define one method to handle all adas signals. </p>
<ul>
<li>add trigger model in rt_oneStep()</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">checkTriggerSigs(&amp;FunctionSignal, outputs_name);</div><div class="line">	<span class="keyword">int</span> idx = <span class="number">0</span>;</div><div class="line">	<span class="keyword">for</span>(; idx&lt;outputs_name.size(); idx++)&#123;</div><div class="line">			<span class="keyword">if</span> ( outputs_name[idx] == <span class="string">"adas_sig1"</span>) &#123;</div><div class="line">				<span class="keyword">double</span> *vals = gd1_struc_2arr(adas_ig1) ; </div><div class="line">				outputs_data.push_back(als);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span> <span class="keyword">if</span>( outputs_name[idx] ==  <span class="string">"adas_sig2"</span>) &#123;</div><div class="line">				<span class="keyword">double</span> *vals = gd1_struc_2arr(adas_sig2) ;</div><div class="line">				outputs_data.push_back(vals);</div><div class="line">			&#125;</div><div class="line"></div><div class="line"><span class="comment">// ws msg send model</span></div></pre></td></tr></table></figure>
<ul>
<li>add sim_time to break the loop</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">real_T sim_time = <span class="number">5.0</span> ; </div><div class="line">fflush((<span class="literal">NULL</span>));</div><div class="line"><span class="keyword">while</span> (rtmGetErrorStatus(OpenLoopSimulation_M) == (<span class="literal">NULL</span>) &amp;&amp;  (Timing.clockTick1) * <span class="number">5.0</span> &lt;=  sim_time) &#123;</div><div class="line">      rt_OneStep();</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h2 id="in-summary"><a href="#in-summary" class="headerlink" title="in summary"></a>in summary</h2><p>the work above is the core modifcation to make real-time matlab/simulink model with trigger model translated to C/C++ code, which can be integrated in <a href="https://zjli2013.github.io/2020/03/18/massively-adas-test-pipeline/" target="_blank" rel="external">massively adas test pipeline</a>.  </p>
<h2 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h2><p><a href="https://devel.rtems.org/wiki/Packages/Matlab" target="_blank" rel="external">matlab code generation from rtems</a></p>
<p><a href="https://www.mathworks.com/company/newsletters/articles/the-joy-of-generating-c-code-from-matlab.html" target="_blank" rel="external">the joy of generating C code from MATLAB</a></p>
<p><a href="https://ww2.mathworks.cn/products/matlab-coder.html" target="_blank" rel="external">matlab coder introduction</a></p>
<p><a href="https://www.mathworks.com/help/rtw/index.html" target="_blank" rel="external">matlab code doc</a></p>
<p><a href="https://www.mathworks.com/help/rtw/ug/use-the-real-time-model-data-structure.html" target="_blank" rel="external">real-time model data structure</a></p>
<p><a href="https://ww2.mathworks.cn/help/simulink/ug/generate-code-from-rate-based-model.html" target="_blank" rel="external">generate code from rate-based model</a></p>
<p><a href="https://www.mathworks.com/help/stateflow/ug/schedule-one-subsystem-in-a-single-step.html" target="_blank" rel="external">schedule a subsystem multiple times in a single step</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/20/">20</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="David Z.J. Lee" />
          <p class="site-author-name" itemprop="name">David Z.J. Lee</p>
           
              <p class="site-description motion-element" itemprop="description">what I don't know</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">192</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">51</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/ZJLi2013" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.linkedin.com/in/zhengjia13/" target="_blank" title="LinkedIn">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  LinkedIn
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">David Z.J. Lee</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://zjlee.disqus.com/count.js" async></script>
    

    

  




	





  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
