<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="what I don&apos;t know">
<meta property="og:type" content="website">
<meta property="og:title" content="Serious Autonomous Vehicles">
<meta property="og:url" content="http://yoursite.com/page/11/index.html">
<meta property="og:site_name" content="Serious Autonomous Vehicles">
<meta property="og:description" content="what I don&apos;t know">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Serious Autonomous Vehicles">
<meta name="twitter:description" content="what I don&apos;t know">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/11/"/>





  <title>Serious Autonomous Vehicles</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Serious Autonomous Vehicles</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/01/Apollo2-0-Routing源码-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/01/Apollo2-0-Routing源码-2/" itemprop="url">Apollo2.0 Routing源码(2)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-01T04:18:22-04:00">
                2019-05-01
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/05/01/Apollo2-0-Routing源码-2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/05/01/Apollo2-0-Routing源码-2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// 模块入口</span></div><div class="line"></div><div class="line">APOLLO_MAIN(apollo::routing::Routing) </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span></div><div class="line">&#123;</div><div class="line">	google::InitGoogleLogging(arg[<span class="number">0</span>]) ;</div><div class="line">	google::ParseCommandLineFlags(&amp;argc, &amp;argv, <span class="literal">true</span>);</div><div class="line">	signal(SIGINT, apollo::common::apollo_app_sigint_handler);</div><div class="line">	apollo::routing::Routing apollo_app_ ; </div><div class="line">	ros::init(argc, argv, apollo_app_.Name());</div><div class="line">	apollo_app_.Spin();</div><div class="line">	</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">``` </div><div class="line"></div><div class="line">`appollo_app_.Spin()` can be found [here](https:<span class="comment">//zjli2013.github.io/2019/04/28/apollo-planning-源码/)</span></div><div class="line"></div><div class="line"></div><div class="line">```c </div><div class="line"></div><div class="line">apollo::common:Status Routing::Init()</div><div class="line">&#123;</div><div class="line">	<span class="keyword">const</span> <span class="keyword">auto</span> routing_map_file = apollo::hdmap::RoutingMapFile() ;</div><div class="line">	navigator_ptr_.reset(<span class="keyword">new</span> Navigator(routing_map_file)) ;</div><div class="line">	common::util::GetProtoFromFile(FLAGS_routing_conf_file, &amp;routing_conf_);</div><div class="line">	hdmap_ = apollo::hdmap::HDMapUtil::BaseMapPtr();</div><div class="line">	AdapterManager::Init(FLAGS_routing_adapter_config_filename); </div><div class="line">	AdapterManager::AddRoutingRequestCallback(&amp;Routing::OnRoutingRequest, <span class="keyword">this</span>);</div><div class="line">	<span class="keyword">return</span> apollo::common::Status::OK();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* </span></div><div class="line"></div><div class="line">	DEFINE_string(routing_adapter_config_filename, "modules/routing/conf/adapter.conf", "the adapter config filename")</div><div class="line"></div><div class="line">*/</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">void</span> AdapterManager::Init()</div><div class="line">&#123;</div><div class="line">	<span class="comment">//...</span></div><div class="line">	</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">const</span> <span class="keyword">auto</span> &amp;config :: configs.config())</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">case</span> AdapterConfig::ROUTING_REQUEST :</div><div class="line">			EnableRoutingRequest(FLAGS_routing_request_topic, config);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		</div><div class="line">		<span class="keyword">case</span> AdapterConfig::ROUTING_RESPONSE:</div><div class="line">			EnableRoutingResponse(FLAGS_routing_response_topic, config);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		</div><div class="line">		<span class="keyword">case</span> AdapterConfig::ROUTING_MONITOR:</div><div class="line">			EnableMonitor(FLAGS_monitor_topic, config);</div><div class="line">			<span class="keyword">break</span>; </div><div class="line">			</div><div class="line">			</div><div class="line">	    <span class="comment">//... </span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>where define <code>EnableRoutingRequest()</code> ?</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">//apollo/modules/common/adapters/adapter_manager.h </span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> REGISTER_ADAPTER(name)</span></div><div class="line">	<span class="keyword">static</span> <span class="keyword">void</span> Enable#<span class="meta">#name(const std::string &amp;topic_name, const AdapterConfig &amp;config)</span></div><div class="line">	&#123;</div><div class="line">		instance()-&gt;InternalEnable#<span class="meta">#name(topic_name, config);</span></div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">static</span> <span class="title">void</span> <span class="title">Add</span>##<span class="title">name</span>##<span class="title">Callback</span>(</span></div><div class="line">		<span class="title">void</span>(<span class="title">T</span>::*fp)(<span class="keyword">const</span> name##Adapter::DataType &amp;data), T *obj)&#123;</div><div class="line">			Add#<span class="meta">#name##Callback(std::bind(fp, obj, std::placeholders::_1));</span></div><div class="line">		&#125;</div><div class="line">		</div><div class="line">	tempalate&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">static</span> <span class="title">void</span> <span class="title">Add</span>##<span class="title">name</span>##<span class="title">Callback</span>(<span class="title">void</span> (<span class="title">T</span>:</span>:*fp)(<span class="keyword">const</span> name##Adapter::DataType &amp;data))&#123;</div><div class="line">		Add#<span class="meta">#name##Callback(fp);</span></div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	</div><div class="line"><span class="comment">// apollo/modules/common/adapters/message_adapters.h</span></div><div class="line"></div><div class="line"><span class="keyword">using</span> RoutingRequestAdapter = Adapter&lt;routing::RoutingRequest&gt; ;</div><div class="line"><span class="keyword">using</span> RoutingResponseAdapter = Adapter&lt;routing::RoutingResponse&gt;;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// apollo/moduels/common/adapters/adapter.h </span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">typename</span> <span class="built_in">std</span>::function&lt;<span class="keyword">void</span>(<span class="keyword">const</span> D&amp;)&gt; Callback ;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// apollo/modules/common/adapters/adapter.h </span></div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">D</span>&gt; <span class="title">void</span> <span class="title">Adapter</span>&lt;D&gt;:</span>OnReceive(<span class="keyword">const</span> D&amp; message)</div><div class="line">&#123;</div><div class="line">	last_receive_time_ = apollo::common::time::Clock::NowInSeconds();</div><div class="line">	EnqueueData(message);</div><div class="line">	FireCallbacks(message);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">AddCallback</span><span class="params">(Callback callback)</span></span></div><div class="line">&#123;</div><div class="line">	receive_callbacks_.push_back(callback);</div><div class="line">&#125;</div><div class="line"></div><div class="line">tempplate&lt;<span class="class"><span class="keyword">class</span> <span class="title">D</span>&gt; <span class="title">void</span> <span class="title">Adapter</span>&lt;D&gt;:</span>:FireCallbacks(<span class="keyword">const</span> D&amp; data)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">const</span> <span class="keyword">auto</span>&amp; callback : receive_callbacks_)</div><div class="line">	&#123;</div><div class="line">		callback(data);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Dreamview and Planning modules have message publish API. e.g. </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">SimulationWorldUpdater::(WebSocketHandler *websocket, SimControl *sim_control, <span class="keyword">const</span> MapSerivce *map_service, <span class="keyword">bool</span> routing_from_file) : sim_world_service_(map_service, routing_from_file), </div><div class="line">map_service_(map_service), </div><div class="line">websocket_(websocket),</div><div class="line">sim_control_(sim_control)</div><div class="line">&#123;</div><div class="line">	<span class="comment">// ...</span></div><div class="line">	websocket_-&gt;RegisterMessageHandler(<span class="string">"SendRoutingRequest"</span>, [<span class="keyword">this</span>][cosnt Json &amp;json, WebSocketHandler::Connection *conn)</div><div class="line">	&#123;</div><div class="line">		RoutingRequest routing_request, </div><div class="line">		</div><div class="line">		<span class="keyword">bool</span> succed = ConstructRoutingRequest(json, &amp;routing_request);</div><div class="line">		<span class="keyword">if</span>(succed)&#123;</div><div class="line">			AdapterManager::FillRoutingRequestHeader(FLAGS_dreamview_module_name, &amp;routing_request); </div><div class="line">			AdapterManager::PublishRoutingRequest(routing_request);</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>ApapterManager class is used to make sure the connection among each module in ROS message type.</p>
<p>Routing class has GPS and IMU input and generate routing and velocity info as output. </p>
<p>Navigator class is using A start algorthm with hd map, start point and end point as input to generate a navigation route.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/30/未来5年在哪里-7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/30/未来5年在哪里-7/" itemprop="url">未来5年在哪里(7)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-30T11:06:14-04:00">
                2019-04-30
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/04/30/未来5年在哪里-7/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/04/30/未来5年在哪里-7/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="噱头团队"><a href="#噱头团队" class="headerlink" title="噱头团队"></a>噱头团队</h2><p>必须在有危机意识的企业中成长。靠投资活的团队，往往只展现其繁荣的一面，对内对外；而实际公司的产品、市场定位，甚至内部员工都不知情。对员工缺乏诚实，对市场客户也不会诚实。</p>
<h2 id="民企文化"><a href="#民企文化" class="headerlink" title="民企文化"></a>民企文化</h2><p>近距离观察了一家民企（长城汽车），意识到民企都不容易迈过国际化的坎儿。为什么需要国际化？因为资本市场是赢者通吃。行业内国际企业进入，本土行业要想生存，必须主动走出去。</p>
<p>民企的老总个人印记太深。集权的管理问题，符合中国文化传统，但与现代管理理念相差甚远。强调军事化管理的集体制，是无法调动个人主观积极性的，对于底层车间工人可能有效，但如此又会造成企业管理上的双轨制，产生内部紧张。另外，集体制会助长一些骄横的个人气息，狭隘自大，而不利于个人内在品质的培养。一个代表先进生产关系和生产力的团队，是不会容忍形式主义的。</p>
<p>国内不错的企业要么狼性，要么艰苦奋斗。其实鼓励创业氛围没有问题，但是文化上很容易“右倾”，把规则理解的太死。</p>
<p>另外强调艰苦奋斗又不集权的华为，给员工持股，也许才是现代优秀企业该有的特征。把员工当作“合伙人“，自然调动了员工的积极性，而不是为某个老板打工。 </p>
<p>回国前的想法是参与一个团队的成长，而不是在一家公司打工。所以除了物质利益，现在人更渴求在工作中的身份认同：”合伙人“。</p>
<h1 id="套路"><a href="#套路" class="headerlink" title="套路"></a>套路</h1><p>国内的套路：先放话。</p>
<p>改革开放前，国家层面严禁私有制，结果江浙的小农户搞了“分田到户”私有承包，后来却全国推广了。面对新情况，国家领导也在摸索，但又要给广大普通人一致的声音。所以先放话。在日后的实践中，慢慢修正，甚至会产生与放话的内容完全相反的实践。至于普通人，如果把放话的内容听的太真，跟领导较劲儿，就是不懂套路。</p>
<p>有些企业做了匪夷所思的规定，还名正言顺地称为“企业文化”，对于明显不符合人情逻辑的条例，也就是这类“放话”，企业领导并不知道怎么管理，员工明白就好，该怎么来还是怎么来；但如果因此想挑战企业领导的规定，就是不懂套路。</p>
<h2 id="提拔-or-压制"><a href="#提拔-or-压制" class="headerlink" title="提拔 or 压制"></a>提拔 or 压制</h2><p>国内有个说法叫”站错队“：不怨能力，是没跟对人。在美国职场，管理层都至少表现比较”亲民“，另外工薪层也基本生活无忧，所以两者相安，比较容易相信对方；相对，国内的职场还没有成熟的系统，就会有”站错队“的风险。另外大家都有生活压力，难免成了隐性竞争对手，互不信任，所以国内的职场被压制可能多过受提拔。这当然是陋习。</p>
<p>偶然看了密西根的地图，一股亲切感就涌上来。在美国的大环境会把善意当作默认的配置，工作生活上有意无意都会受到他人的帮助或有意无意地帮助别人。善意比较容易表达出来；相比，国内的环境，职场上、生活上，都有一些压制感。</p>
<p>比如生活上的压抑感。在北美的同学都嘴上说，回国好啊，吃的多么多么好。实际上，外面的东西都不敢吃，忌讳比如肉干净吗、油干净吗、放了不该放的调料吗。办点事，老是担心哪里被骗了都不知道。社会系统不成熟，就会有这样的隐形成本。</p>
<h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><p>写完上面的内容4天后，才有机会再次打开。工作到没时间读书是对人最大的消耗。希望自己尽快适应国内工作生活节奏，而又不受制于这样的工作生活状态。</p>
<p><a href="https://www.sohu.com/a/128114001_473283" target="_blank" rel="external">某个人的回忆</a></p>
<p>ps 军训的时候，每天跑8km，站军姿一个半小时，在这样的环境下反而更激发我去思考，如何把高标准习成标配。</p>
<h2 id="管理之路"><a href="#管理之路" class="headerlink" title="管理之路"></a>管理之路</h2><p>我以为自己是细节导向的，国内这个工作环境会占据太多个人时间，叫人没时间思考大方向的问题。高标准成为标配吧。</p>
<p>越来越看到技术是平的，相比，工作流程，系统建设才是企业愿意花钱的地方。写程序、推公式、做运营、甚至做基础研究，到一定阶段都是极易取代的。“单腿走路”是high risk的。相比，任何一个领域的产品人，至少有一条粗腿，同时还有很多不错的小腿。把各个环节、各个岗位有机组合起来的，就是管理。而在工作中需要有意培养系统（管理）意识。</p>
<p>现在的民企，管理水平还是很差的。文化层面上，虽然在推一些流程，但是也有一些制度性的限制。一方面，一边高举打破旧思维搞创新，一边又做很多行为细节上的约束，在员工心理建立墙。工作流程的建立，不是做几次讲座、参加几个培训，领导提倡几次，不是喊出来的，而是像培养一个工作习惯。需要反复练习，慢慢融入到企业文化，变成员工自然而然的行为。</p>
<p>日常层面上，任务管理、时间管理都比较缺乏。老板会希望员工加班，但并没有定义很好的工作内容，即缺乏任务管理，缺乏日常的考核机制。然后责任不明晰，缺乏有效的工作模式，比如出现一个问题，一伙儿人都围上来了。或者一个会议讨论停不下来。当然，大的层面还是工作的流程没有建立好。</p>
<p>今后的工作，要经常跳出来思考系统建设，而不要跟年轻人拼体力上。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/28/apollo-planning-源码/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/28/apollo-planning-源码/" itemprop="url">Apollo 2.0  Planning 源码(1)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-28T11:30:06-04:00">
                2019-04-28
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/04/28/apollo-planning-源码/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/04/28/apollo-planning-源码/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">// 模块入口</span></div><div class="line"></div><div class="line">APOLLO_MAIN(apollo::planning::Planning)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></div><div class="line">&#123;</div><div class="line">	google::InitGoogleLogging(argv[<span class="number">0</span>]);</div><div class="line">	google::ParseCommandLineFlags(&amp;argc, &amp;argv, <span class="literal">true</span>); </div><div class="line">	signal(SIGINT, apollo::common::apollo_app_sigint_handler);</div><div class="line">	apollo::planning::Planning apollo_app_ ;</div><div class="line">	ros::init(argc, argv, apollo_app_.Name());</div><div class="line">	apollo_app_.Spin();</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">///////////////////////////////////////////////////////</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> ApolloApp::Spin()</div><div class="line">&#123;</div><div class="line">	ros::<span class="function">AsyncSpinner <span class="title">spinner</span><span class="params">(callback_thread_num_)</span></span>;</div><div class="line">	<span class="keyword">auto</span> status = Init();</div><div class="line">	status = Start(); </div><div class="line">	</div><div class="line">	spinner.start();</div><div class="line">	ros::waitForShutdown();</div><div class="line">	Stop();</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">///////////////////////////////////////////////////////</span></div><div class="line"></div><div class="line"></div><div class="line">Status Planning::Init()</div><div class="line">&#123;</div><div class="line">	hdmap_ = apollo::hdmap::HDMapUtil::BaseMapPtr();</div><div class="line">	</div><div class="line">apollo::common::util::GetProtoFromFile(FLAGS_planning_config_file, &amp;config);</div><div class="line">	</div><div class="line">	<span class="keyword">if</span>(!AdapterManager::Initialized())&#123;</div><div class="line">		AdaapterManager::Init(FLAGS_planning_adapter_config_filename);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	AdapterManager::GetLocalization();</div><div class="line">	AdapterManager::GetChassis();</div><div class="line">	AdapterManager::GetRoutingResponse();</div><div class="line">	AdapterManager::GetRoutingRequest();</div><div class="line">	</div><div class="line">	<span class="keyword">if</span>(FLAGS_enable_prediction)</div><div class="line">		AdapterManager::GetPrediction();</div><div class="line">		</div><div class="line">	<span class="keyword">if</span>(FLAGS_enable_traffic_light)</div><div class="line">		AdapterManager::GetTrafficLightDetection();</div><div class="line">		</div><div class="line">	ReferenceLineProvider::instance()-&gt;Init(hdmap_, config_.qp_spline_reference_line_smoother_config()); </div><div class="line">	</div><div class="line">	RegisterPlanners();</div><div class="line">	</div><div class="line">	planner_ = planner_factory_.CreateObject(config_.planner_type());</div><div class="line">	</div><div class="line">	<span class="keyword">return</span> planner_-&gt;Init(config_);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* DEFINE_string(planning_adapter_config_filename,</span></div><div class="line">	"modules/planning/conf/adapter.conf",</div><div class="line">	"The adapter configuration file")</div><div class="line">*/</div><div class="line"></div><div class="line"><span class="comment">///////////////////////////////////////////////////////////////</span></div><div class="line"></div><div class="line"><span class="keyword">void</span> AdapterManager::Init(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;adapter_config_filename)</div><div class="line">&#123;</div><div class="line">	AdapterManagerConfig configs;</div><div class="line">	util::GetProtoFromFile(adapter_config_filename, &amp;configs);</div><div class="line">	Init(configs);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//////////////////////////////////////////////////////////////</span></div><div class="line"></div><div class="line"><span class="keyword">void</span> AdapterManager::Init(<span class="keyword">const</span> AdapterManagerConfig&amp; configs)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">if</span>(Initialized())	<span class="keyword">return</span>;</div><div class="line">	instance()-&gt;initialized_ = <span class="literal">true</span>; </div><div class="line">	</div><div class="line">	<span class="keyword">if</span>(configs.is_ros())&#123;</div><div class="line">		instance()-&gt;node_handle_.reset(<span class="keyword">new</span> ros::NodeHandle());</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">const</span> <span class="keyword">auto</span> &amp;config : configs.config())</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">case</span> AdapterConfig::CHASSIS:</div><div class="line">			EnableChassis(FLAGS_chassis_topic, config);</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> AdapterConfig::LOCALIZATION:</div><div class="line">			EnableLocalization(FLAGS_localization_topic, config);</div><div class="line">			<span class="keyword">break</span>;	</div><div class="line">			<span class="comment">// ...</span></div><div class="line">	&#125;</div><div class="line"> &#125;</div><div class="line"> </div><div class="line"><span class="comment">/* DEFINE_string 宏</span></div><div class="line">	FLAGS_chassis_topic -&gt;  /apollo/canbus/chassis</div><div class="line">	FLAGS_localization_topic -&gt; /apollo/localization/pose</div><div class="line">*/</div></pre></td></tr></table></figure>
<p>where is <code>EnableChassis</code> ? </p>
<p>in /apollo/modules/common/adapters/message_adapters.h</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">using</span> ChassisAdapter=Adapter&lt;::apollo::canbus::Chassis&gt;;</div><div class="line"></div><div class="line"><span class="keyword">using</span> GpsAdapter = Adapter&lt;apollo::localization::Gps&gt;;</div><div class="line"></div><div class="line"><span class="keyword">using</span> PlanningAdapter = Adapter&lt;planning::ADCTrajectory&gt;;</div></pre></td></tr></table></figure>
<p>in /apollo/modules/common/adapters/adapter_manager.h</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> REGISTER_ADAPTER(name)</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> Enable#<span class="meta">#name(const std::string &amp;topic_name, const AdapterConfig&amp; config)</span></div><div class="line">	&#123;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<h5 id="continue-tomorrow"><a href="#continue-tomorrow" class="headerlink" title="continue tomorrow"></a>continue tomorrow</h5>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/08/自动驾驶职位介绍/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/08/自动驾驶职位介绍/" itemprop="url">自动驾驶职位介绍</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-08T09:07:04-04:00">
                2019-04-08
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/04/08/自动驾驶职位介绍/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/04/08/自动驾驶职位介绍/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="光庭科技（武汉）"><a href="#光庭科技（武汉）" class="headerlink" title="光庭科技（武汉）"></a>光庭科技（武汉）</h2><p>智能网联汽车车载终端产品，汽车IT公司，自主研发、产品设计、制造和销售。e.g. 自动驾驶控制器，远程无线通信终端，立体相机、地图传感器、”光谷梦4.0”自动驾驶系统</p>
<p>职位：感知算法工程师</p>
<p>要求：图像/点云目标检测、跟踪；slam算法；Camera/Lidar/Radar传感器融合算法；系统集成和调试</p>
<p>加分项：ROS开发经验，视觉SLAM算法，深度学习算法</p>
<p>职位：控制算法工程师</p>
<p>要求：控制系统设计、信号处理、动态系统建模； 时域/频域控制器设计和稳定性分析；汽车速度和方向控制</p>
<p>职位：测试主管</p>
<p>要求： 产品测试方案、管理。软件测试及自动化测试工具</p>
<h2 id="华砺智行（武汉）"><a href="#华砺智行（武汉）" class="headerlink" title="华砺智行（武汉）"></a>华砺智行（武汉）</h2><p>智能基础设施平台，为智能驾驶、智慧城市提供软硬件解决方案。产品：智能网联汽车终端、交通行业、无线通信、云平台、交通应用等</p>
<h2 id="天迈科技（郑州）"><a href="#天迈科技（郑州）" class="headerlink" title="天迈科技（郑州）"></a>天迈科技（郑州）</h2><p>城市公交运营、管理及服务提供综合解决方案。车联网产品：智能公交调度系统、远程监控系统、智能公交收银系统、充电运营管理。</p>
<p>职位：视频算法工程师</p>
<p>要求： 驾驶员行为状态检测算法，机器学习检测效果</p>
<h2 id="赢彻科技"><a href="#赢彻科技" class="headerlink" title="赢彻科技"></a>赢彻科技</h2><p>物流</p>
<h2 id="纵目科技"><a href="#纵目科技" class="headerlink" title="纵目科技"></a>纵目科技</h2><p>环视ADAS解决方案</p>
<p>职位：  车身控制算法工程师</p>
<p>要求： 车身横向、侧向控制算法设计、仿真、测试。自动控制理论，车辆底盘控制，车身动力学，Carsim, Simulink</p>
<h2 id="西井科技（上海）"><a href="#西井科技（上海）" class="headerlink" title="西井科技（上海）"></a>西井科技（上海）</h2><p>职位： 仿真平台开发工程师</p>
<p>要求： 设计仿真平台架构，传感器仿真模型，3D物理引擎(unreal, unity)，熟悉开源仿真平台(carla, airsim)，构建场景环境</p>
<h2 id="小鹏汽车（广州）"><a href="#小鹏汽车（广州）" class="headerlink" title="小鹏汽车（广州）"></a>小鹏汽车（广州）</h2><p>职位： SLAM专家</p>
<p>要求： 视觉定位算法；与感知、地图模块结合做3d视觉系统；</p>
<p>职位：HD Map工程师</p>
<p>要求： 大规模多层高精地图框架，地图API, 地图数据质量评估，地图数据格式</p>
<p>职位：运动控制算法专家</p>
<p>要求：转向、制动、动力系统的主动控制，对底盘、执行器的控制需求；车道保持、自适应巡航、自动变道等功能运动控制，现场调试</p>
<p>职位：规划与控制专家</p>
<p>要求：算法开发、测试，提出硬件设计和集成要求</p>
<p>职位： 雷达算法工程师</p>
<p>要求： 算法仿真验证、数据分析、算法嵌入式平台实现、维护</p>
<p>职位：计算机视觉</p>
<p>要求：场景元素识别；道路、停车场环境寓意分割；算法验证</p>
<p>职位：传感器融合</p>
<p>要求： 毫米波、超声波、摄像头、激光雷达测试开发； 感知数据处理、实时地图构建及应用；目标实时跟踪与预测</p>
<p>职位：项目经理</p>
<p>要求： l2-l4产品解决方案项目管理</p>
<h2 id="宇通汽车（深圳）"><a href="#宇通汽车（深圳）" class="headerlink" title="宇通汽车（深圳）"></a>宇通汽车（深圳）</h2><p>职位： 控制工程师</p>
<p>要求： 轨迹跟踪、车辆控制、 仿真优化</p>
<p>职位：行为决策工程师</p>
<p>要求：行为决策算法开发，碰撞预测、行为预测、驾驶经验库、交通安全规则库等，基于强化学习的跟踪(?)</p>
<p>职位：首席工程师</p>
<p>要求：自驾客车架构规划、设计；核心算法开发和测试；自动驾驶技术跟踪。熟悉人工智能、机器视觉、深度学习、高精地图、定位等， 熟悉滤波算法、轨迹规划</p>
<h2 id="纽励科技"><a href="#纽励科技" class="headerlink" title="纽励科技"></a>纽励科技</h2><p>职位：ADAS产品经理</p>
<p>要求：产品客户需求调研、项目收集整理， 与主机厂沟通技术方案，产品改进。熟悉AEB, ACC, LKA, FCW, 自动泊车，熟悉汽车电子软硬件设计、嵌入式开发标准，熟悉传感器</p>
<h2 id="光束汽车"><a href="#光束汽车" class="headerlink" title="光束汽车"></a>光束汽车</h2><p>职位： 控制算法</p>
<h2 id="华人运通"><a href="#华人运通" class="headerlink" title="华人运通"></a>华人运通</h2><p>职位： 控制工程师</p>
<p>要求： 运动控制算法的设计开发、仿真、优化，测试； 基于驾驶员操作数据的车辆运动控制算法</p>
<h2 id="恒大汽车"><a href="#恒大汽车" class="headerlink" title="恒大汽车"></a>恒大汽车</h2><p>自行开发，现有汽车平台及产品 </p>
<p>职位： 仿真验证经理</p>
<p>要求：汽车电子网络、诊断开发测试、</p>
<p>研发中心结构： 造型中心，动力总成中心， 车联网中心，整车工程中心，自动驾驶中心</p>
<h2 id="上海电气"><a href="#上海电气" class="headerlink" title="上海电气"></a>上海电气</h2><p>轨道公交智能系统</p>
<p>职位： 控制算法工程师</p>
<p>要求：车辆控制实时数据采集、理论模型、系统仿真和实测验证算法</p>
<h2 id="Magna-Steyr-麦格纳斯太尔汽车技术"><a href="#Magna-Steyr-麦格纳斯太尔汽车技术" class="headerlink" title="Magna Steyr 麦格纳斯太尔汽车技术"></a>Magna Steyr 麦格纳斯太尔汽车技术</h2><p>职位： L4 ADAS电子专家</p>
<p>要求： ADAS SE团队</p>
<p>职位： GNSS测试验证首席工程师</p>
<h2 id="牧月科技"><a href="#牧月科技" class="headerlink" title="牧月科技"></a>牧月科技</h2><p>职位：仿真系统工程师</p>
<p>要求： 负责仿真系统开发、测试，及各种传感器的仿真软件库，利用已有数据构建仿真场景；开发自动化仿真分析平台</p>
<h2 id="景驰科技（文远知行）"><a href="#景驰科技（文远知行）" class="headerlink" title="景驰科技（文远知行）"></a>景驰科技（文远知行）</h2><p>职位： 仿真算法工程师</p>
<p>要求： 开发场景自动化生成算法、人机交互仿真软件工具集、可扩展计算框架</p>
<h2 id="腾讯CSIG事业部"><a href="#腾讯CSIG事业部" class="headerlink" title="腾讯CSIG事业部"></a>腾讯CSIG事业部</h2><h2 id="伟世通"><a href="#伟世通" class="headerlink" title="伟世通"></a>伟世通</h2><p>职位： 软件测试</p>
<p>要求： ADAS软件测试、竞品分析</p>
<h2 id="博世（苏州）"><a href="#博世（苏州）" class="headerlink" title="博世（苏州）"></a>博世（苏州）</h2><p>职位： 控制算法工程师</p>
<p>要求： ADAS自动泊车系统</p>
<h2 id="亿伽通（吉利系）"><a href="#亿伽通（吉利系）" class="headerlink" title="亿伽通（吉利系）"></a>亿伽通（吉利系）</h2><p>职位：算法工程师<br>要求：定位产品场景、需求分析； 参与搭建自动驾驶数据智能服务平台；熟悉基于视觉的slam方案</p>
<h2 id="奥迪中国（北京）"><a href="#奥迪中国（北京）" class="headerlink" title="奥迪中国（北京）"></a>奥迪中国（北京）</h2><p>车联网团队</p>
<p>职位： 测试工程师</p>
<p>要求： ADAS/HAD功能测试</p>
<p>职位：仿真工程师</p>
<p>要求： SiL环境搭建，adas功能仿真测试</p>
<h2 id="斑马智行（阿里、上汽）"><a href="#斑马智行（阿里、上汽）" class="headerlink" title="斑马智行（阿里、上汽）"></a>斑马智行（阿里、上汽）</h2><h2 id="智加科技（苏州）"><a href="#智加科技（苏州）" class="headerlink" title="智加科技（苏州）"></a>智加科技（苏州）</h2><p>职位： 传感器标定工程师</p>
<p>要求： 传感器选型、数据读取、内外参标定、在线检测</p>
<p>职位：感知算法工程师</p>
<p>要求： 对图像、点云等的静态场景要素检测和追踪；融合传感器数据后的目标检测和跟踪；服务地图自建、预测规划决策系统</p>
<p>职位： 地图定位工程师</p>
<p>要求： 开发多传感器融合算法以提高地图精度，自动化地图的大规模采集、生成、标注、校政。</p>
<p>职位： 决策规划工程师 </p>
<p>要求： 预测、决策、规划等系统</p>
<p>职位： 仿真工程师</p>
<p>要求： 利用真实数据或合成数据搭建动态环境的仿真框架；设计场景，为感知、规划、预测等模块开发仿真测试接口；开发基于仿真测试的自动化分析平台；构建可扩展的仿真框架</p>
<h2 id="魔视智能（上海）"><a href="#魔视智能（上海）" class="headerlink" title="魔视智能（上海）"></a>魔视智能（上海）</h2><h2 id="极目智能"><a href="#极目智能" class="headerlink" title="极目智能"></a>极目智能</h2><p>职位： 车辆决策算法工程师 </p>
<h2 id="零跑科技"><a href="#零跑科技" class="headerlink" title="零跑科技"></a>零跑科技</h2><p>职位： 算法工程师</p>
<p>要求： 定位算法模块，基于GPS/IMU的航伟推算算法，视觉定位算法</p>
<h2 id="阿里巴巴（人工智能实验室）"><a href="#阿里巴巴（人工智能实验室）" class="headerlink" title="阿里巴巴（人工智能实验室）"></a>阿里巴巴（人工智能实验室）</h2><p>职位： 仿真算法工程师 </p>
<h2 id="吉利"><a href="#吉利" class="headerlink" title="吉利"></a>吉利</h2><h2 id="Volvo上海研发中心"><a href="#Volvo上海研发中心" class="headerlink" title="Volvo上海研发中心"></a>Volvo上海研发中心</h2><h2 id="中智行（南京）"><a href="#中智行（南京）" class="headerlink" title="中智行（南京）"></a>中智行（南京）</h2><p>l4 解决方案</p>
<h2 id="同元软控（苏州）"><a href="#同元软控（苏州）" class="headerlink" title="同元软控（苏州）"></a>同元软控（苏州）</h2><p>国产CAD/CAE产品供应商</p>
<h2 id="华为2012"><a href="#华为2012" class="headerlink" title="华为2012"></a>华为2012</h2><h2 id="华为海思（上海）"><a href="#华为海思（上海）" class="headerlink" title="华为海思（上海）"></a>华为海思（上海）</h2><p>职位： 软件测试 </p>
<h2 id="一汽红旗"><a href="#一汽红旗" class="headerlink" title="一汽红旗"></a>一汽红旗</h2><p>职位： 车联网构架设计师</p>
<p>要求： T-box端-云构架，v2x</p>
<p>潜在人选：</p>
<ul>
<li>车联网企业： 斑马、亿伽通、博泰、百度车联网团队、飞驰镁物、哈曼、四维图新、梧桐车联</li>
<li>新势力： 蔚来、小鹏、威马</li>
</ul>
<p>职位：软件算法、系统工程师</p>
<p>潜在人选：</p>
<ul>
<li>上汽人工智能实验室</li>
<li>英伟达</li>
<li>福特-argo ai </li>
<li>momenta, plusai</li>
</ul>
<p>职位： 数据挖掘工程师</p>
<p>要求： 大数据建模分析，用户数据、车辆数据、驾驶员数据等</p>
<p>潜在人选：</p>
<ul>
<li>浪潮</li>
<li>曙光</li>
<li>华为云</li>
<li>阿里云</li>
<li>百度</li>
</ul>
<h2 id="华域汽车"><a href="#华域汽车" class="headerlink" title="华域汽车"></a>华域汽车</h2><h2 id="滴滴无人车"><a href="#滴滴无人车" class="headerlink" title="滴滴无人车"></a>滴滴无人车</h2><h2 id="美团无人车"><a href="#美团无人车" class="headerlink" title="美团无人车"></a>美团无人车</h2><p>职位： 仿真工程师</p>
<h2 id="一汽大众"><a href="#一汽大众" class="headerlink" title="一汽大众"></a>一汽大众</h2><p>职位：决策算法工程师</p>
<h2 id="veoneer"><a href="#veoneer" class="headerlink" title="veoneer"></a>veoneer</h2><p>职位：adas软件开发工程师 </p>
<h2 id="易航智能"><a href="#易航智能" class="headerlink" title="易航智能"></a>易航智能</h2><p>职位： 控制算法工程师</p>
<h2 id="三一无人驾驶"><a href="#三一无人驾驶" class="headerlink" title="三一无人驾驶"></a>三一无人驾驶</h2><p>无人码头</p>
<p>职位： 算法工程师</p>
<h2 id="易高美"><a href="#易高美" class="headerlink" title="易高美"></a>易高美</h2><p>职位： hpmap仿真工程师</p>
<p>要求： 大批量仿真数据自动化生成；设计分布式仿真系统底层架构，3D引擎编辑器工具链开发；实现仿真系统场景渲染；对大批量及各种随机虚拟数据自动化脚本工具开发。OpenGL/Direct3D图形接口; unreal, unity引擎</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/03/粒子滤波-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/03/粒子滤波-2/" itemprop="url">particle filter (2)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-03T11:51:48-04:00">
                2019-04-03
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/04/03/粒子滤波-2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/04/03/粒子滤波-2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://zjli2013.github.io/2019/04/02/partical-filter/" target="_blank" rel="external">前一篇</a> 介绍贝叶斯滤波的数学原理和蒙特卡洛定位的算法。本篇将介绍基于序贯重要性采样。粒子滤波的思想就是采用一个加权粒子分布去近似后验概率分布<code>p(x)</code></p>
<h2 id="蒙特卡洛积分"><a href="#蒙特卡洛积分" class="headerlink" title="蒙特卡洛积分"></a>蒙特卡洛积分</h2><p>定义一连续随机变量X, 其概率密度分布函数为 <code>p(X)</code>; 定义<code>Y=f(X)</code>， 则随机变量Y的数学期望：</p>
<p><a href="https://www.codecogs.com/eqnedit.php?latex=E(Y)&space;=&space;\int&space;f(x)p(x)&space;dx&space;\approx&space;\frac{1}{N}&space;\sum_{i=1}^{N}&space;f(x_i)&space;p(x_i)" target="_blank"><img src="https://latex.codecogs.com/gif.latex?E(Y)&space;=&space;\int&space;f(x)p(x)&space;dx&space;\approx&space;\frac{1}{N}&space;\sum_{i=1}^{N}&space;f(x_i)&space;p(x_i)" title="E(Y) = \int f(x)p(x) dx \approx \frac{1}{N} \sum_{i=1}^{N} f(x_i) p(x_i)"></a></p>
<p>实际中，概率密度分布<code>p(X)</code>未知，如何保障所采样的点服从<code>p(X)</code></p>
<h3 id="直接采样"><a href="#直接采样" class="headerlink" title="直接采样"></a>直接采样</h3><p>通过对均匀分布采样，实现对任意分布的采样。 </p>
<p>任何未知概率密度分布的累积概率函数cdf都映射在[0-1]区间，通过在[0-1]区间的均匀采样，再函数<code>z = cdf(y)</code>求逆，即是符合真实 <code>y</code>的概率密度分布的采样点。</p>
<p>但如果cdf()函数未知或无法求逆，直接采样不可行。</p>
<h3 id="接受-拒绝采样"><a href="#接受-拒绝采样" class="headerlink" title="接受-拒绝采样"></a>接受-拒绝采样</h3><p>用一个已知概率分布函数<code>q(X)</code>去采样，然后按照一定的方法拒绝某些样本，达到近似<code>p(X)</code>分布: </p>
<pre><code>p(x_i) &lt;= k p(x_i)
</code></pre><p>该采样的限制是确定参数k。</p>
<h3 id="重要性采样"><a href="#重要性采样" class="headerlink" title="重要性采样"></a>重要性采样</h3><p>在一定的抽样数量基础上，增加准确度。未知<code>p(x)</code>, 在已知概率密度分布的<code>q(x)</code>上采样{x_1, x_2, … x_n}后估计f的期望：</p>
<p><a href="https://www.codecogs.com/eqnedit.php?latex=E(Y)&space;=&space;\int&space;f(x)p(x)&space;dx&space;\approx&space;\frac{1}{N}&space;\sum_{i=1}^{N}&space;f(x_i)" target="_blank"><img src="https://latex.codecogs.com/gif.latex?E(Y)&space;=&space;\int&space;f(x)p(x)&space;dx&space;\approx&space;\frac{1}{N}&space;\sum_{i=1}^{N}&space;f(x_i)" title="E(Y) = \int f(x)p(x) dx \approx \frac{1}{N} \sum_{i=1}^{N} f(x_i)"></a></p>
<p><a href="https://www.codecogs.com/eqnedit.php?latex=E(Y)&ace;=&space;\int&space;\frac{p(x)}{q(x)}&space;q(x)&space;f(x)&space;dx" target="_blank"><img src="https://latex.codecogs.com/gif.latex?E(Y)&space;=&space;\int&space;\frac{p(x)}{q(x)}&space;q(x)&space;f(x)&space;dx" title="E(Y) = \int \frac{p(x)}{q(x)} q(x) f(x) dx"></a></p>
<p>定义新的随机变量：<br>        <a href="https://www.codecogs.com/eqnedit.php?latex=Z&space;=&space;\frac{p(x)}{q(x)}&space;f(x)" target="_blank"><img src="https://latex.codecogs.com/gif.latex?Z&space;=&space;\frac{p(x)}{q(x)}&space;f(x)" title="Z = \frac{p(x)}{q(x)} f(x)"></a></p>
<p>关于原随机变量<code>Y</code>在未知概率分布<code>p(x)</code>下的期望，转化为新的随机变量<code>Z</code>在已知概率分布<code>q(x)</code>下的期望。已知概率分布，即知道如何采样。这里 <code>p(x)/q(x)</code> 就是权值。</p>
<p>so the <a href="https://users.aalto.fi/~ssarkka/course_k2012/handout6.pdf" target="_blank" rel="external">posterior expectations</a> can be computed as:</p>
<p><a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;Z(x^i)&space;=&space;\frac{p(x^i&space;|&space;z_{1:t})}{q(x^i&space;|&space;z_{1:t})}&space;f(x^i)&space;\\&space;E[Y]&space;=&space;\frac{1}{N}&space;\sum_{i=1}^{N}&space;Z(x^i)" target="_blank"><img src="https://latex.codecogs.com/gif.latex?\inline&space;Z(x^i)&space;=&space;\frac{p(x^i&space;|&space;z_{1:t})}{q(x^i&space;|&space;z_{1:t})}&space;f(x^i)&space;\\&space;E[Y]&space;=&space;\frac{1}{N}&space;\sum_{i=1}^{N}&space;Z(x^i)" title="Z(x^i) = \frac{p(x^i | z_{1:t})}{q(x^i | z_{1:t})} f(x^i) \\ E[Y] = \frac{1}{N} \sum_{i=1}^{N} Z(x^i)"></a></p>
<p>as the importance weights can be defined as: </p>
<p><a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;w^i&space;=&space;\frac{p(x^i&space;|&space;z_{1:t})}{q(x^i&space;|&space;z_{1:t})}" target="_blank"><img src="https://latex.codecogs.com/gif.latex?\inline&space;w^i&space;=&space;\frac{p(x^i&space;|&space;z_{1:t})}{q(x^i&space;|&space;z_{1:t})}" title="w^i = \frac{p(x^i | z_{1:t})}{q(x^i | z_{1:t})}"></a></p>
<p>the problem is we can’t get <code>p(x|z)</code> ,  but a loosed (unnormalized) importance weights as:</p>
<p><a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;\tilde{w^i}&space;=&space;\frac{p(x^i)&space;p(z_{1:t}&space;|&space;x^i)}{q(x^i&space;|&space;z_{1:t})}" target="_blank"><img src="https://latex.codecogs.com/gif.latex?\inline&space;\tilde{w^i}&space;=&space;\frac{p(x^i)&space;p(z_{1:t}&space;|&space;x^i)}{q(x^i&space;|&space;z_{1:t})}" title="\tilde{w^i} = \frac{p(x^i) p(z_{1:t} | x^i)}{q(x^i | z_{1:t})}"></a></p>
<p>then do normalized from it:</p>
<p><a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;w^i&space;=&space;\frac{\tilde{w^i}}{\sum_{j}&space;\tilde{w^j}&space;}" target="_blank"><img src="https://latex.codecogs.com/gif.latex?\inline&space;w^i&space;=&space;\frac{\tilde{w^i}}{\sum_{j}&space;\tilde{w^j}&space;}" title="w^i = \frac{\tilde{w^i}}{\sum_{j} \tilde{w^j} }"></a></p>
<p>so the posterior expectation is approximated as: </p>
<p><a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;E[Y&space;|&space;z_{1:t}]&space;\approx&space;\sum_{i=1}^{N}&space;w^i&space;f(x^i)" target="_blank"><img src="https://latex.codecogs.com/gif.latex?\inline&space;E[Y&space;|&space;z_{1:t}]&space;\approx&space;\sum_{i=1}^{N}&space;w^i&space;f(x^i)" title="E[Y | z_{1:t}] \approx \sum_{i=1}^{N} w^i f(x^i)"></a></p>
<h2 id="sequential-importance-sampling-SIS"><a href="#sequential-importance-sampling-SIS" class="headerlink" title="sequential importance sampling(SIS)"></a>sequential importance sampling(SIS)</h2><p>consider the full posterior distribution of states <code>X_{0:k}</code> given measurements <code>y_{1:k}</code> :</p>
<p><a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;p(x_{0:k}&space;|&space;z_{1:k})&space;\approx&space;p(z_k&space;|&space;x_{0:k},&space;z_{1:k-1})&space;p(x_{0:k}&space;|&space;z_{1:k-1})&space;\\&space;=&space;p(z_k&space;|&space;x_k)&space;p(x_k&space;|&space;x_{0:k-1},&space;z_{1:k-1})&space;p(x_{0:k-1}|&space;z_{1:k-1})&space;\\&space;=&space;p(z_k&space;|&space;x_k)&space;p(x_k&space;|&space;x_{k-1})&space;p(x_{0:k-1}&space;|&space;z_{1:k-1})" target="_blank"><img src="https://latex.codecogs.com/gif.latex?\inline&space;p(x_{0:k}&space;|&space;z_{1:k})&space;\approx&space;p(z_k&space;|&space;x_{0:k},&space;z_{1:k-1})&space;p(x_{0:k}&space;|&space;z_{1:k-1})&space;\\&space;=&space;p(z_k&space;|&space;x_k)&space;p(x_k&space;|&space;x_{0:k-1},&space;z_{1:k-1})&space;p(x_{0:k-1}|&space;z_{1:k-1})&space;\\&space;=&space;p(z_k&space;|&space;x_k)&space;p(x_k&space;|&space;x_{k-1})&space;p(x_{0:k-1}&space;|&space;z_{1:k-1})" title="p(x_{0:k} | z_{1:k}) \approx p(z_k | x_{0:k}, z_{1:k-1}) p(x_{0:k} | z_{1:k-1}) \\ = p(z_k | x_k) p(x_k | x_{0:k-1}, z_{1:k-1}) p(x_{0:k-1}| z_{1:k-1}) \\ = p(z_k | x_k) p(x_k | x_{k-1}) p(x_{0:k-1} | z_{1:k-1})"></a></p>
<p>consider the sequential of <code>q(x)</code>:</p>
<p><a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;q(x_{0:k}|&space;z_{1:k})&space;=&space;q(x_{0:k-1}&space;|&space;z_{1:k-1})&space;q(x_k&space;|&space;x_{0:k-1},&space;z_{1:k})" target="_blank"><img src="https://latex.codecogs.com/gif.latex?\inline&space;q(x_{0:k}|&space;z_{1:k})&space;=&space;q(x_{0:k-1}&space;|&space;z_{1:k-1})&space;q(x_k&space;|&space;x_{0:k-1},&space;z_{1:k})" title="q(x_{0:k}| z_{1:k}) = q(x_{0:k-1} | z_{1:k-1}) q(x_k | x_{0:k-1}, z_{1:k})"></a></p>
<p>then the unnormalized importance weights can be as:</p>
<p><a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;w^i&space;\approx&space;\frac{p(z_k|x_k)p(x_k|x_{k-1})&space;p(x_{0:k-1}&space;|&space;z_{1:k-1})}{&space;q(x_k&space;|&space;x_{0:k-1},&space;z_{1:k})&space;q(x_{0:k-1}&space;|&space;z_{1:k-1})&space;}" target="_blank"><img src="https://latex.codecogs.com/gif.latex?\inline&space;w^i&space;\approx&space;\frac{p(z_k|x_k)p(x_k|x_{k-1})&space;p(x_{0:k-1}&space;|&space;z_{1:k-1})}{&space;q(x_k&space;|&space;x_{0:k-1},&space;z_{1:k})&space;q(x_{0:k-1}&space;|&space;z_{1:k-1})&space;}" title="w^i \approx \frac{p(z_k|x_k)p(x_k|x_{k-1}) p(x_{0:k-1} | z_{1:k-1})}{ q(x_k | x_{0:k-1}, z_{1:k}) q(x_{0:k-1} | z_{1:k-1}) }"></a></p>
<p>namely:</p>
<p><a href="https://www.codecogs.com/eqnedit.php?latex=\inline&space;w_k^i&space;\approx&space;\frac{p(z_k|x_k)p(x_k|x_{k-1})}{&space;q(x_k&space;|&space;x_{0:k-1},&space;z_{1:k})&space;}&space;w_{k-1}^i" target="_blank"><img src="https://latex.codecogs.com/gif.latex?\inline&space;w_k^i&space;\approx&space;\frac{p(z_k|x_k)p(x_k|x_{k-1})}{&space;q(x_k&space;|&space;x_{0:k-1},&space;z_{1:k})&space;}&space;w_{k-1}^i" title="w_k^i \approx \frac{p(z_k|x_k)p(x_k|x_{k-1})}{ q(x_k | x_{0:k-1}, z_{1:k}) } w_{k-1}^i"></a></p>
<p>the problem in SIS is the algorithm is degenerate, that variance of the weights increases at every step, which means the algorithm will converget to single none-zero (w=1) weight and the rest being zero. </p>
<p>so resampling.</p>
<h2 id="sequential-importance-resampling-SER"><a href="#sequential-importance-resampling-SER" class="headerlink" title="sequential importance resampling(SER)"></a>sequential importance resampling(SER)</h2><p>resampling process: </p>
<p>1) interpret each weight as the probability of obtaining the sample index <code>i</code> in the set <code>x^i</code></p>
<p>2) draw <code>N</code> samples from that discrete distribtuion and replace the old sample set with the new one.</p>
<p>SER process:</p>
<p>1) draw point <code>x_i</code> from the     <code>q</code> distribution.<br>2) calculate the weights in iteration SIS and normalized the weights to sum to unity<br>3) if the effective number of particles is too low, go to resampling process</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/02/partical-filter/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/02/partical-filter/" itemprop="url">partical filter</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-02T10:53:59-04:00">
                2019-04-02
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/04/02/partical-filter/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/04/02/partical-filter/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://medium.com/intro-to-artificial-intelligence/localisation-udacitys-self-driving-car-nanodegree-8440a1f83eab" target="_blank" rel="external">localizing</a> the vehicle involves determing where on the map the vehicle is most likely to be by matching what the vehicles see to the map.</p>
<p>Markov localization or Bayes Filter for localization is the generalized filter. thinking of the robot location as a probability distribution, each time the robot move, the distribution becomes more diffuse(wide).  by passing control data, map data, observation into the filter will concentrate(narrow) the distribution at each timestep. </p>
<h2 id="state-space"><a href="#state-space" class="headerlink" title="state space"></a>state space</h2><pre><code>x = f(x, v)            (1)

z = h(x, w)             (2)
</code></pre><p><code>v</code>, <code>w</code> is the process noise, measurement noise respectfully, and each is in the normal Gaussian distribution.  </p>
<h2 id="Bayes-filter-derivation"><a href="#Bayes-filter-derivation" class="headerlink" title="Bayes filter derivation"></a>Bayes filter derivation</h2><p><a href="https://www.codecogs.com/eqnedit.php?latex=p(x_k&space;|&space;z_{1:k})&space;=&space;\frac{p(z_k&space;|&space;x_k)&space;p(x_k&space;|&space;z_{1:k-1})}{p(z_k&space;|&space;z_{1:k-1})}" target="_blank"><img src="https://latex.codecogs.com/gif.latex?p(x_k&space;|&space;z_{1:k})&space;=&space;\frac{p(z_k&space;|&space;x_k)&space;p(x_k&space;|&space;z_{1:k-1})}{p(z_k&space;|&space;z_{1:k-1})}" title="p(x_k | z_{1:k}) = \frac{p(z_k | x_k) p(x_k | z_{1:k-1})}{p(z_k | z_{1:k-1})}"></a>     (b)</p>
<p>consider the multiply rule of probability:</p>
<pre><code>p(a, b) = p(a|b) p(b) 
</code></pre><p>lhs of equation(b) is:</p>
<p><a href="https://www.codecogs.com/eqnedit.php?latex=p(x_k&space;|&space;z_{1:k})&space;=&space;\frac{p(x_k,&space;z_k,&space;z_{1:k-1})}{p(z_{1:k})}&space;=&space;\frac{p(z_k&space;|&space;x_k,&space;z_{1:k-1})&space;p(x_k,&space;z_{1:k-1})}{p(z_{1:k})}&space;=&space;\frac{p(z_k&space;|&space;x_k&space;)&space;p(x_k,&space;z_{1:k-1})}{p(z_{1:k})}" target="_blank"><img src="https://latex.codecogs.com/gif.latex?p(x_k&space;|&space;z_{1:k})&space;=&space;\frac{p(x_k,&space;z_k,&space;z_{1:k-1})}{p(z_{1:k})}&space;=&space;\frac{p(z_k&space;|&space;x_k,&space;z_{1:k-1})&space;p(x_k,&space;z_{1:k-1})}{p(z_{1:k})}&space;=&space;\frac{p(z_k&space;|&space;x_k&space;)&space;p(x_k,&space;z_{1:k-1})}{p(z_{1:k})}" title="p(x_k | z_{1:k}) = \frac{p(x_k, z_k, z_{1:k-1})}{p(z_{1:k})} = \frac{p(z_k | x_k, z_{1:k-1}) p(x_k, z_{1:k-1})}{p(z_{1:k})} = \frac{p(z_k | x_k ) p(x_k, z_{1:k-1})}{p(z_{1:k})}"></a></p>
<p>given <code>x_k</code>, assuming <code>z_k</code> is <a href="https://stats.stackexchange.com/questions/130944/deriving-the-bayes-filter-correction-equation" target="_blank" rel="external">independent from all previous measurements</a> <code>z_{1:k-1}</code>: </p>
<p><a href="https://www.codecogs.com/eqnedit.php?latex=p(x_k&space;|&space;z_{1:k})&space;=&space;\frac{p(z_k&space;|&space;x_k)&space;p(x_k&space;|&space;z_{1:k-1})&space;p(z_{1:k-1})}{p(z_k,&space;z_{1:k-1})}&space;\\&space;=&space;\frac{p(z_k&space;|&space;x_k)&space;p(x_k&space;|&space;z_{1:k-1})&space;p(z_{1:k-1})}{p(z_k|z_{1:k-1})p(z_{1:k-1})}&space;\\&space;=&space;\frac{p(z_k&space;|&space;x_k)&space;p(x_k&space;|&space;z_{1:k-1})&space;}{p(z_k|z_{1:k-1})}" target="_blank"><img src="https://latex.codecogs.com/gif.latex?p(x_k&space;|&space;z_{1:k})&space;=&space;\frac{p(z_k&space;|&space;x_k)&space;p(x_k&space;|&space;z_{1:k-1})&space;p(z_{1:k-1})}{p(z_k,&space;z_{1:k-1})}&space;\\&space;=&space;\frac{p(z_k&space;|&space;x_k)&space;p(x_k&space;|&space;z_{1:k-1})&space;p(z_{1:k-1})}{p(z_k|z_{1:k-1})p(z_{1:k-1})}&space;\\&space;=&space;\frac{p(z_k&space;|&space;x_k)&space;p(x_k&space;|&space;z_{1:k-1})&space;}{p(z_k|z_{1:k-1})}" title="p(x_k | z_{1:k}) = \frac{p(z_k | x_k) p(x_k | z_{1:k-1}) p(z_{1:k-1})}{p(z_k, z_{1:k-1})} \\ = \frac{p(z_k | x_k) p(x_k | z_{1:k-1}) p(z_{1:k-1})}{p(z_k|z_{1:k-1})p(z_{1:k-1})} \\ = \frac{p(z_k | x_k) p(x_k | z_{1:k-1}) }{p(z_k|z_{1:k-1})}"></a></p>
<h2 id="Markov-Localization"><a href="#Markov-Localization" class="headerlink" title="Markov Localization"></a>Markov Localization</h2><p>in which the true state <code>x</code> is unobserved, and the measurements <code>z</code> is observed.<br>assuming 1st order Markov, the probability of current true state:</p>
<pre><code>p(x_k | x_{0:k-1}) == p(x_k | x_{k-1}) (3)
</code></pre><p>similarly, the measurement is only dependent on current state,  which is a <a href="http://robots.stanford.edu/papers/thrun.pf-in-robotics-uai02.pdf" target="_blank" rel="external">stochastic projection</a> of the true state <code>x_t</code>, :</p>
<pre><code>p(z_k | x_{0:k}) = p(z_k | x_k)     (4)            
</code></pre><p>(3) is referred to as motion model, and (4) as measurement/observation model. </p>
<p>the classical problem in partially observable Markov chains is to recover a posterior distribution from all avilable sensor measurements and controls in all timesteps. </p>
<p>Especially, for the localization problem here is to obtain the system current state posterior <code>p(x_k | z_{1:k})</code> based on the all existing measurements, which can be solved by Bayes Filter.</p>
<p>ps. the propability distribution of current state is also depend on other known inputs, e.g. map data, control data.</p>
<h3 id="prediction"><a href="#prediction" class="headerlink" title="prediction"></a>prediction</h3><p>from Bayes filter equation, <code>p(x_k | z_{1:k-1})</code> need get first, which is the prediction step. physically, it used to estimate the system state based on all previous measurements.</p>
<p>consider <code>x_{k-1}</code> as the random variable, the integration of pdf <code>p(x_k, x_{k-1} | z_{1:k-1})</code>  about <code>x_{k-1}</code> is  <code>p(x_k | z_{1:k-1})</code> </p>
<p><a href="https://www.codecogs.com/eqnedit.php?latex=p(x_k&space;|&space;z_{1:k-1})&space;=&space;\int&space;p(x_k,&space;x_{k-1}&space;|&space;z_{1:k-1})&space;dx_{k-1}" target="_blank"><img src="https://latex.codecogs.com/gif.latex?p(x_k&space;|&space;z_{1:k-1})&space;=&space;\int&space;p(x_k,&space;x_{k-1}&space;|&space;z_{1:k-1})&space;dx_{k-1}" title="p(x_k | z_{1:k-1}) = \int p(x_k, x_{k-1} | z_{1:k-1}) dx_{k-1}"></a></p>
<p>consider the multiply rule:  </p>
<p><a href="https://www.codecogs.com/eqnedit.php?latex=p(x_k,&space;x_{k-1})&space;=&space;p(x_k&space;|&space;x_{k-1})&space;p(x_{k-1})&space;\\&space;p(x_k,&space;x_{k-1}&space;|&space;z_{1:k-1})&space;=&space;p(x_k&space;|&space;x_{k-1},&space;z_{1:k-1})&space;p(x_{k-1}&space;|&space;z_{1:k-1})" target="_blank"><img src="https://latex.codecogs.com/gif.latex?p(x_k,&space;x_{k-1})&space;=&space;p(x_k&space;|&space;x_{k-1})&space;p(x_{k-1})&space;\\&space;p(x_k,&space;x_{k-1}&space;|&space;z_{1:k-1})&space;=&space;p(x_k&space;|&space;x_{k-1},&space;z_{1:k-1})&space;p(x_{k-1}&space;|&space;z_{1:k-1})" title="p(x_k, x_{k-1}) = p(x_k | x_{k-1}) p(x_{k-1}) \\ p(x_k, x_{k-1} | z_{1:k-1}) = p(x_k | x_{k-1}, z_{1:k-1}) p(x_{k-1} | z_{1:k-1})"></a></p>
<p>by 1st order Markov assuming, the first item in integral can reduced: </p>
<p><a href="https://www.codecogs.com/eqnedit.php?latex=p(x_k&space;|&space;z_{1:k-1}&space;)&space;=&space;\int&space;p(x_k&space;|&space;x_{k-1})&space;p(x_{k-1}&space;|&space;z_{1:k-1})&space;dx_{k-1}" target="_blank"><img src="https://latex.codecogs.com/gif.latex?p(x_k&space;|&space;z_{1:k-1}&space;)&space;=&space;\int&space;p(x_k&space;|&space;x_{k-1})&space;p(x_{k-1}&space;|&space;z_{1:k-1})&space;dx_{k-1}" title="p(x_k | z_{1:k-1} ) = \int p(x_k | x_{k-1}) p(x_{k-1} | z_{1:k-1}) dx_{k-1}"></a></p>
<p><code>p(x_k | x_{k-1})</code> is determined by the system, which obey the same distribution of process noise.  <code>p(x_{k-1} | z_{1:k-1})</code> is known, as the posterior state at timestep <code>k-1</code>. this is where the recursive process. </p>
<h3 id="update"><a href="#update" class="headerlink" title="update"></a>update</h3><p>using equation (b) to update the current posterior state. the denominator of (b) is a constant coeffient. <code>p(z_k | x_k)</code> is the likelihood paramter, decided by measurement.  </p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/31/无迹卡尔曼滤波/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/31/无迹卡尔曼滤波/" itemprop="url">无迹卡尔曼滤波</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-31T10:29:26-04:00">
                2019-03-31
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/03/31/无迹卡尔曼滤波/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/03/31/无迹卡尔曼滤波/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>非线性系统：</p>
<pre><code>x = f(x, w)         （1）

z = h(x) + v                 （2）
</code></pre><p>随机信号 <code>w</code>, <code>v</code>分别是过程噪声和观测噪声    </p>
<h2 id="CTRV-状态方程"><a href="#CTRV-状态方程" class="headerlink" title="CTRV 状态方程"></a>CTRV <a href="https://winfriedauner.de/projects/" target="_blank" rel="external">状态方程</a></h2><p>对于const turn rate and velocity magnitude (<a href="https://fevemania.github.io/blog/mathematic-formula-note-of-unscented-kalman-filter/" target="_blank" rel="external">CTRV</a> )场景：</p>
<pre><code>x = (px, py, v, phi, \dot{phi})
</code></pre><p>固定速度和转动速率约束，即：</p>
<p><a href="https://www.codecogs.com/eqnedit.php?latex=\dot{x}&space;=&space;(\dot{p_x},&space;\dot{p_y},&space;\dot{v},&space;\dot{\psi},&space;\ddot{\psi})&space;=&space;(vcos(\psi&space;),&space;vsin(\psi),&space;0,&space;\dot{\psi},&space;0)" target="_blank"><img src="https://latex.codecogs.com/gif.latex?\dot{x}&space;=&space;(\dot{p_x},&space;\dot{p_y},&space;\dot{v},&space;\dot{\psi},&space;\ddot{\psi})&space;=&space;(vcos(\psi&space;),&space;vsin(\psi),&space;0,&space;\dot{\psi},&space;0)" title="\dot{x} = (\dot{p_x}, \dot{p_y}, \dot{v}, \dot{\psi}, \ddot{\psi}) = (vcos(\psi ), vsin(\psi), 0, \dot{\psi}, 0)"></a>  </p>
<p><a href="https://www.codecogs.com/eqnedit.php?latex=x_{k&plus;1}&space;=&space;x_k&space;&plus;&space;\int_{t_k}^{t_{k&plus;1}}&space;\dot{x}&space;dt&space;&plus;&space;v" target="_blank"><img src="https://latex.codecogs.com/gif.latex?x_{k&plus;1}&space;=&space;x_k&space;&plus;&space;\int_{t_k}^{t_{k&plus;1}}&space;\dot{x}&space;dt&space;&plus;&space;v" title="x_{k+1} = x_k + \int_{t_k}^{t_{k+1}} \dot{x} dt + w"></a>      </p>
<p>考虑 <code>dv/dt == 0</code> , <code>dphi^2\dt^2==0</code> 且<code>\psi</code>是时间的函数, 上述第一项即：</p>
<p><a href="https://www.codecogs.com/eqnedit.php?latex=px_{k&plus;1}&space;=&space;px_k&space;&plus;&space;\int_{t_k}^{t_{k&plus;1}}&space;v&space;cos\psi)&space;dt&space;&plus;&space;v&space;\\&space;=&space;px_k&space;&plus;&space;{\frac{sin\psi}{\dot{\psi}}}_{t_k}^{t_{k&plus;1}}" target="_blank"><img src="https://latex.codecogs.com/gif.latex?px_{k&plus;1}&space;=&space;px_k&space;&plus;&space;\int_{t_k}^{t_{k&plus;1}}&space;v&space;cos\psi)&space;dt&space;&plus;&space;v&space;\\&space;=&space;px_k&space;&plus;&space;{\frac{sin\psi}{\dot{\psi}}}_{t_k}^{t_{k&plus;1}}" title="px_{k+1} = px_k + \int_{t_k}^{t_{k+1}} v cos\psi) dt + w \\ = px_k + {\frac{sin\psi}{\dot{\psi}}}_{t_k}^{t_{k+1}}"></a>     </p>
<p>从原状态空间到预测空间，由方程（1),（2）可见，过程噪声<code>w</code>是状态<code>x</code>的非线性项；而<code>z</code>关于观测噪声<code>v</code>是线性的。ukf实际采用增广状态变量<code>sigmax = [x, w]</code>. 过程噪声<code>w</code>包括径向加速度和角加速度 <code>[w_a, w_phi]</code>， 且<code>w</code>不是时间的函数 , 对上述第一项可展开：</p>
<p><a href="https://www.codecogs.com/eqnedit.php?latex=px_{k&plus;1}&space;=&space;px_k&space;&plus;&space;\int_{t_k}^{t_{k&plus;1}}&space;\dot{px}&space;dt&space;&plus;&space;\int_{0}^{\Delta&space;t}&space;w_a&space;\Delta&space;t&space;\cos{\psi}dt&space;=&space;px_k&space;&plus;&space;\frac{sin{\psi}}{\dot{\psi}}_{t_{k&plus;1}}^{t_k}&space;&plus;&space;0.5&space;w_a&space;cos{\psi}&space;\Delta&space;t^2" target="_blank"><img src="https://latex.codecogs.com/gif.latex?px_{k&plus;1}&space;=&space;px_k&space;&plus;&space;\int_{t_k}^{t_{k&plus;1}}&space;\dot{px}&space;dt&space;&plus;&space;\int_{0}^{\Delta&space;t}&space;w_a&space;\Delta&space;t&space;\cos{\psi}dt&space;=&space;px_k&space;&plus;&space;\frac{sin{\psi}}{\dot{\psi}}_{t_{k&plus;1}}^{t_k}&space;&plus;&space;0.5&space;w_a&space;cos{\psi}&space;\Delta&space;t^2" title="px_{k+1} = px_k + \int_{t_k}^{t_{k+1}} \dot{px} dt + \int_{0}^{\Delta t} w_a \Delta t \cos{\psi}dt = px_k + \frac{sin{\psi}}{\dot{\psi}}_{t_{k+1}}^{t_k} + 0.5 w_a cos{\psi} \Delta t^2"></a></p>
<h2 id="预测空间"><a href="#预测空间" class="headerlink" title="预测空间"></a>预测空间</h2><p>对比<a href="https://zjli2013.github.io/2019/03/30/卡尔曼滤波/" target="_blank" rel="external">扩展卡尔曼</a> ekf采用一阶线性化近似。无迹卡尔曼ukf，将原状态空间的特征采样点(sigmax)映射到预测空间，采用预测空间里的状态变量<code>f(sigmax)</code>的均值、方差的加权推广作为先验状态估计<code>x^-</code> 和先验误差<code>P^-</code>。</p>
<p>其中权值表述：</p>
<pre><code>$$ w = lamda / ( lamda + ns) when i==1 $$ 
$$ w_i = 0.5/(lamba + ns)       when i!=1 $$

$$ X^- =  sum(w_i * f(sigmax) ) $$
$$ P^- =  sum(w_i * (f(sigmax) - x).^2) $$  
</code></pre><h2 id="观测空间"><a href="#观测空间" class="headerlink" title="观测空间"></a>观测空间</h2><p>将原状态空间的特征采样点(sigmax)映射到观测空间，采用观测空间里的状态变量<code>h(sigmax)</code>的均值、方差的加权作为先验观测值<code>Z^-</code> 和观测值先验误差<code>S^-</code>，使用与预测空间同样的权值。</p>
<pre><code>$$ Z^- =  sum(w_i * h(sigmax) ) $$
$$ S^- =  sum(w_i * (Z^- - z).^2) + R $$  
</code></pre><p>卡尔曼滤波表示： 后验估计（真实状态变量值）与先验估计（预测空间的状态变量值）的差异，可表示为真实观测值与观测空间里的先验观测值的差异的增益 K。</p>
<pre><code>$$ x - x^-  = K (z - Z^-) $$   （3）
</code></pre><p>可见，卡尔曼增益<code>K</code>在衡量状态误差与观测误差之间的相关性。定义预测空间与观测空间的相关系数：</p>
<pre><code>T =  sum(w_i * (X^- - x)(Z^- - z))
K =  T /  S^-                   （4）
</code></pre><h2 id="ukf算法"><a href="#ukf算法" class="headerlink" title="ukf算法"></a>ukf算法</h2><p>有（4）， （3） 分别更新卡尔曼增益和状态变量， 预测空间里的先验误差更新由：</p>
<pre><code>P = P - KSK^t
</code></pre><p>ps: 在非线性的处理上，线性化或者布点采样都是常用的思路。也是ekf与ukf的区别。 </p>
<p><a href="https://starsmydestination.github.io/2017/05/09/UKF/" target="_blank" rel="external">link1</a></p>
<p><a href="https://blog.csdn.net/Young_Gy/article/details/78542754" target="_blank" rel="external">link2</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/31/CarND-term2-Extended-Kalman-Filter/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/31/CarND-term2-Extended-Kalman-Filter/" itemprop="url">CarND(term2): Extended Kalman Filter</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-31T01:49:50-04:00">
                2019-03-31
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/03/31/CarND-term2-Extended-Kalman-Filter/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/03/31/CarND-term2-Extended-Kalman-Filter/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="sensor-measurement"><a href="#sensor-measurement" class="headerlink" title="sensor measurement"></a>sensor measurement</h2><h3 id="Radar"><a href="#Radar" class="headerlink" title="Radar"></a>Radar</h3><p>radio detection andranging, using radio waves to measure the distance to objects as well as their velocity and angle. Radar used a lot in preventing collions, parking assistance, cruise control. and Radar isn’t affected by weather conditions. </p>
<p>while Radar can’t tell an object’s shape correctly. and Radar can’t detect objects if they are out of their line of sight.</p>
<p>the Radar measurement data in EKF proejcct is 3D position and velocity vector <code>(ro, theta, ro_dot)</code> in polar coordinates.</p>
<h3 id="Lidar"><a href="#Lidar" class="headerlink" title="Lidar"></a>Lidar</h3><p>light detection and ranging, using near-infrared light to scan objects and create 3D map of the enviroment. it’s 360-degree view and can track movements and their directions. but it also depends on weather conditions and can’t detecting the speed of other vehicles well. </p>
<p>the Lidar measurement data in EKF proeject is 2D position vector <code>(x,y)</code> in Cartesian coordinate system.  </p>
<p><a href="https://www.intellias.com/the-ultimate-sensor-battle-lidar-vs-radar/" target="_blank" rel="external">compare Radar vs Lidar</a></p>
<h2 id="server-client-network"><a href="#server-client-network" class="headerlink" title="server - client network"></a>server - client network</h2><p><a href="https://github.com/udacity/CarND-Extended-Kalman-Filter-Project" target="_blank" rel="external">Udacity simulator</a> communicate with EKF controller through websocket. </p>
<p>in simulators(Udacity carsim, Carla) running time, the message channel between simulator server and external controller need to be open all the time. so the simulator feed the controller with sensor data, and the controller feedback simulator with controlling data. </p>
<h3 id="uwebSocket"><a href="#uwebSocket" class="headerlink" title="uwebSocket"></a>uwebSocket</h3><p>built once <a href="https://zjli2013.github.io/2018/06/29/gnu-make/" target="_blank" rel="external">uwebSocket</a>, <a href="https://en.wikipedia.org/wiki/WebSocket" target="_blank" rel="external">webSocket</a> protocol providing full-duplex communication channel between server and client through a singlt TCP connection. it allows the server to send content ot the client without being first requested by the client, and allowing messages to be passed back and forth while keeping the conenction open. </p>
<h3 id="sensor-raw-data"><a href="#sensor-raw-data" class="headerlink" title="sensor raw data"></a>sensor raw data</h3><p>every data slice includes a either Lidar or Radar raw measurement and a ground truth measurement. </p>
<p>The state variable <code>x</code> is described in Cartesian coord, so for Radar measurement processing, there is a coordinate transfer from Cartesian to polar, and which lead it nonlinear, requiring Extended Karman Filter.</p>
<h3 id="EKF-controller"><a href="#EKF-controller" class="headerlink" title="EKF controller"></a>EKF controller</h3><p>the client side is the EKF controller, which process the sensor measurement.</p>
<p>define </p>
<pre><code>system state `x_` ,

  state priori covariance `P_`,

   state transition matrix `F`, 

process covariance `Q_`, 

measurement gain matrix  &apos;H&apos;

measurement covariance &apos;R_&apos; 

kalman filter gain &apos;K&apos;
</code></pre><p> as discussed in <a href="https://zjli2013.github.io/2019/03/30/卡尔曼滤波/" target="_blank" rel="external">previous blog</a>: </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"> </div><div class="line"><span class="keyword">void</span> KalmanFilter::Predict()</div><div class="line">&#123;</div><div class="line">	x_ = F * x_ ;   </div><div class="line">	P_ = F * P_ * F.transpose() + Q_ ;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">void</span> KalmanFilter::Update(<span class="keyword">const</span> Vector &amp; measurement)</div><div class="line">&#123;</div><div class="line">	<span class="keyword">if</span>(EKF)</div><div class="line">		h = toPolar(x_); </div><div class="line">		y = measurement - h ;</div><div class="line">	<span class="keyword">else</span></div><div class="line">		y = measurement - H * x_ ;</div><div class="line">		 </div><div class="line">	K = P_ * Ht / (H * P_ * Ht + R_);  </div><div class="line">	x_ = x_ + K * y ; </div><div class="line">	P_ = (I - K*H) * P_ ;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/30/卡尔曼滤波/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/30/卡尔曼滤波/" itemprop="url">卡尔曼滤波</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-30T10:21:09-04:00">
                2019-03-30
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/03/30/卡尔曼滤波/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/03/30/卡尔曼滤波/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="状态方程"><a href="#状态方程" class="headerlink" title="状态方程"></a>状态方程</h2><p>状态变量 <code>$x$</code> 满足, 其中 <code>u</code>为控制变量：</p>
<pre><code>$$ x = A x_prev + B u_prev + w_prev $$    (1) 
</code></pre><p>观测变量 <code>$z</code> 满足：</p>
<pre><code>$$ z = H x + v $$                    (2)
</code></pre><p>随机信号 $<code>w</code>$ 和 $<code>v</code>$ 分别表示过程激励噪声和观测噪声，假定相互独立，且服从正态分布。</p>
<p>定义状态变量的先验估计 $<code>x^-</code>$， 即基于之前状态对当前状态的预测值； 定义后验估计 $<code>x^</code>$，即已知当前观测值所计算的当前状态变量。 定义先验误差 $<code>e^-</code>$, 后验误差 $<code>e^</code>$, 满足： </p>
<pre><code>$$ e^- = x - x^- $$                     (3)

$$ e^ = x - x^ $$                         (4)
</code></pre><p>卡尔曼滤波表示： 后验估计（观测值所推导的状态变量值）与先验估计（预测的状态变量值）的差异，可表示为观测值与以先验估计为输入的观测值的差异的增益 <code>K</code>。</p>
<pre><code>$$ x^ -  x^- =  K ( z - H x^- ) $$     (5)
</code></pre><p><code>K</code>可由先验误差的协方差 <code>P</code>、观测噪声的协方差<code>R</code> 和观测增益<code>H</code>表示: </p>
<pre><code>$$ K = P^- H^t /  (  HP^-H^t + R ) $$   (6)
</code></pre><p>可见：</p>
<p>1） 当<code>R</code> 趋于0时， <code>k</code> 趋近于 <code>h</code> 的逆，此时 <code>x^ = x</code>。即当观测误差很小，观测值趋近真实值。</p>
<p>2） 当<code>P</code>趋于0时，即预测值趋近真实值。  </p>
<h2 id="算法设计"><a href="#算法设计" class="headerlink" title="算法设计"></a>算法设计</h2><p>卡尔曼滤波器用反馈控制估计过程状态（变量）：  滤波器估计某一时刻的状态（时间更新/预估），然后以（含噪声的）测量变量获得反馈（测量更新/校政）。</p>
<p>时间更新，当前时步状态先验估计 <code>x^-</code> 及先验误差协方差近似<code>P^-</code>:</p>
<pre><code>$$ x^- =  A x^-_prev + B u_prev $$  (7.1)

$$ P^- = A P^_prev A^t + Q $$         (7.2)
</code></pre><p>其中 $ P(w) ~ N(0, Q) $ </p>
<p>测量更新，使用(6)更新卡尔曼增益<code>K</code>, 使用（5)更新后验状态变量<code>x^</code>和当前步先验误差协方差值 <code>P^</code>： </p>
<pre><code>$$ P = ( I  - KH ) P^-  $$            (8)
</code></pre><h2 id="控制器调参"><a href="#控制器调参" class="headerlink" title="控制器调参"></a>控制器调参</h2><p>测量误差一般可观测得到；而过程误差q需要通过与一个已知误差的在线滤波器对比调整系数。调参一般是离线过程。一般当过程误差和卡尔曼增益会快速收敛并保持常数。但测量误差受环境影响不易保持不变。</p>
<h2 id="扩展卡尔曼"><a href="#扩展卡尔曼" class="headerlink" title="扩展卡尔曼"></a>扩展卡尔曼</h2><p>当观测值与系统状态变量 或 系统本身是非线性关系，方程(1), (2)变非线性函数。</p>
<pre><code>$$  x = f(x_prev, u_prev, w) $$  (1.2) 
$$  z =  h(x, v)    $$            (2.2) 
</code></pre><p><a href="https://www.cs.unc.edu/~welch/kalman/media/pdf/kalman_intro_chinese.pdf" target="_blank" rel="external">link</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/30/paper-reading-Carla-an-open-urban-driving-simulator/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/30/paper-reading-Carla-an-open-urban-driving-simulator/" itemprop="url">paper reading-Carla an open urban driving simulator</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-30T03:32:25-04:00">
                2019-03-30
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/03/30/paper-reading-Carla-an-open-urban-driving-simulator/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/03/30/paper-reading-Carla-an-open-urban-driving-simulator/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://carla.org" target="_blank" rel="external">CARLA</a> used to support training, prototyping, validation of self-driving models, including perception and control. CARLA is usded to study the performance of three approaches, 1)  classic modular pipeline that comprises a vision-based perception module, a rule-based planner, and a maneuver controller; 2)a deep network that maps sensory input to driving commands via imitaion learning;  3) end-to-end reinforcment learning.</p>
<p>all approaches make use of a high-level topological planner. the planner takes the current position of the agent and the location of the goal as input, and use A* algorithm to provide a high-level plan.  this plan advises the agent to turn left/right, or keep straight at intersections, but not provide a trajectory neither geometric info. which is a weaker form of common GPS.</p>
<h2 id="simulation-engine"><a href="#simulation-engine" class="headerlink" title="simulation engine"></a>simulation engine</h2><p>CARLA simulates a dynamic world and provide a simple interface between the world and an agent that interacts with the world. CARLA is designed as a server-client system, where the server runs the simulation and renders the scene, the client API is responsible for interaction between the agent and the server via sockets.</p>
<p>the client send commands and meta-commands to the server and receives sensor readings in return. the comands control the vehicle and includes steering, accelerating, and braking. meta-commands controls the behavior of hte server, e.g. resetting hte simulation, modifying the sensor suite.</p>
<h3 id="environment"><a href="#environment" class="headerlink" title="environment"></a>environment</h3><p>the static 3D world, such as buildings, traffic signs,  and the dynamic objects such as vehicles, pedestrains. the behavior of non-player characters is based on standard UE4 vehicle model(PhysXVehicles), and extended with a basic controller to govern NPC’s behavior: lane following, respecting traffic lights, speed limits, and decision making at intersections.</p>
<h3 id="pedestrains"><a href="#pedestrains" class="headerlink" title="pedestrains"></a>pedestrains</h3><p>pedestrains navigate the streets according to a town-specific navigation map, which conveys a location-based cost, which is designed to encourage pedestrains to walk along sidewalkd and marked road crossing, but allows them to cross road at any point.</p>
<h3 id="sensors"><a href="#sensors" class="headerlink" title="sensors"></a>sensors</h3><p>camera parameters include 3D location, 3D orientation with respect to the vehicle’s coordinate system, field of view, and depth of field.</p>
<p>the semantic segmentation pseudo-sensor provides 12 semantic classes:  road, land-marking, traffic sign, sidewalk, fence, pole, wall, building, vegetation, vehicle, pedestrain, and other.</p>
<p>a range of measurements associated with the state of the agent.  ? </p>
<p>measurements concerning traffic rules include the percentage of vehicle’s footprint that impinges on wrong-way lanes or sidewalks, as well as states of the traffic lights and speed limit at the current location of the vehicle. </p>
<p>CARLA provides access to exact location and bounding boxes of all dynamic objects. </p>
<h2 id="autonomous-driving"><a href="#autonomous-driving" class="headerlink" title="autonomous driving"></a>autonomous driving</h2><p>the agent interacts with the environment over discrete time steps. at each time step, the agent gets an observation, which is a tuple of sensory inputs, and must produce an action, which represents steering, throttle, brake. </p>
<h3 id="modular-pipeline"><a href="#modular-pipeline" class="headerlink" title="modular pipeline"></a>modular pipeline</h3><p>the pipeline includes:  perception, planning, continuous control. local planning is critical based on visual perception.</p>
<h4 id="perception"><a href="#perception" class="headerlink" title="perception"></a>perception</h4><p>using semantic segmentation network based on RefineNet to estimate lanes, road limits, and dynamic objects. and a classification model is used to determine proximity to intersections. </p>
<h4 id="the-local-planner"><a href="#the-local-planner" class="headerlink" title="the local planner"></a>the local planner</h4><p>coordinates low-level navigation by generating a set of waypoints, near-term goal states that represents the desired position and orientation of the car in near future.  the rule-based state:  1) road-following,  2) left-turn, 3) right-turn, 4) intersection-forward, 5) hazard-stop. transitions between states are performed based on estimates provided by the perception module and on topological info provided by the global planner.</p>
<h4 id="continuous-controller"><a href="#continuous-controller" class="headerlink" title="continuous controller"></a>continuous controller</h4><p>using PID controller, which inputs current pose, speed, a list of waypoints, and outputs steering, throttle, and brake.</p>
<h2 id="carla-release"><a href="#carla-release" class="headerlink" title="carla release"></a>carla release</h2><h3 id="9-1"><a href="#9-1" class="headerlink" title="9.1"></a>9.1</h3><p>1)   enable client to detect collisions and determine lane changes :  <code>sensor.other.collision</code>, <code>sensor.other.lane_detector</code>, </p>
<p>2)  access to the road network, waypoints nearby current vehicle and define user navigation algorithms: <code>Map</code></p>
<p>3) support new map created from external RoadRunner/VectorZero, in OpenDriven map standard </p>
<h3 id="9-2"><a href="#9-2" class="headerlink" title="9.2"></a>9.2</h3><p>1) simulation of traffic scenarios by <a href="https://github.com/carla-simulator/scenario_runner" target="_blank" rel="external"><code>Scenario Runner</code></a>. e.g.  following leading vehicle,  stationary object crossing, dynamic object crossing, opposite vehicle running red light, vehicle turn right/left etc</p>
<p>2)upgraded ROS bridge </p>
<p>3) vehicle navigation from client side: <code>BasicAgent</code>, navigate to a point given location while dealing with other vehicles and traffic lights safely;  <code>RoamingAgent</code>, drives around making random choices when presented to multiple options</p>
<h3 id="9-3"><a href="#9-3" class="headerlink" title="9.3"></a>9.3</h3><p>1) new town and new pedestrains </p>
<p>2) no rendering mode, a 2D map visualization tool that display vehicles, traffic lights, speed limits, pedestrains, road, etc. help to improve the server framerate</p>
<p>3) traffic light class in client <code>TrafficLightState</code> </p>
<p>4) new sensors.  <code>ObstacleDetector</code>, a simple raycast sensor to detect something in front of the ego vehicle and what is it; and <code>GlobalNavigationSatelliteSystem</code>, attach to ego vehicle and get its geolocation, which is based on the geo-reference define in OpenDriven file associated with each map.</p>
<h3 id="9-4"><a href="#9-4" class="headerlink" title="9.4"></a>9.4</h3><p>1) allow client side to change physics properties of vehicle or their components in runtime <code>WheelsPhysicsControl</code> </p>
<p>2) logging and playback system, which includes a camera-following mode to follow a target actor while replaying the simulation, and can replay situations from different viewpoints. and the logging query engine allow users to query different types of events.</p>
<p>3) random streaming port, which makes it possible to stream sensor data in a secondary port</p>
<p>4) import maps,  replace maps as tar.gz files in “ExportedMaps” folder </p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/10/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><span class="page-number current">11</span><a class="page-number" href="/page/12/">12</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><a class="extend next" rel="next" href="/page/12/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="David Z.J. Lee" />
          <p class="site-author-name" itemprop="name">David Z.J. Lee</p>
           
              <p class="site-description motion-element" itemprop="description">what I don't know</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">177</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">47</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/ZJLi2013" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.linkedin.com/in/zhengjia13/" target="_blank" title="LinkedIn">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  LinkedIn
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">David Z.J. Lee</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://zjlee.disqus.com/count.js" async></script>
    

    

  




	





  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
