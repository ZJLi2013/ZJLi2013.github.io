<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="k8s," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="backgroundk8s networks include a few topics:  pod to pod communication in k8s  pod to the host node communication  pod to external service URL  external request to pod in k8s   the networks have two c">
<meta name="keywords" content="k8s">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s: flannel">
<meta property="og:url" content="http://yoursite.com/2020/05/23/k8s-flannel/index.html">
<meta property="og:site_name" content="Serious Autonomous Vehicles">
<meta property="og:description" content="backgroundk8s networks include a few topics:  pod to pod communication in k8s  pod to the host node communication  pod to external service URL  external request to pod in k8s   the networks have two c">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://static.bookstack.cn/projects/source-code-reading-notes/729e704bd9fc39c9223da5185e9ef084.png">
<meta property="og:image" content="https://www.centos.bz/wp-content/uploads/2017/06/flannel-01.png">
<meta property="og:updated_time" content="2020-05-23T13:18:05.914Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="k8s: flannel">
<meta name="twitter:description" content="backgroundk8s networks include a few topics:  pod to pod communication in k8s  pod to the host node communication  pod to external service URL  external request to pod in k8s   the networks have two c">
<meta name="twitter:image" content="https://static.bookstack.cn/projects/source-code-reading-notes/729e704bd9fc39c9223da5185e9ef084.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/05/23/k8s-flannel/"/>





  <title>k8s: flannel | Serious Autonomous Vehicles</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Serious Autonomous Vehicles</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/23/k8s-flannel/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">k8s: flannel</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-23T08:19:53-04:00">
                2020-05-23
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/05/23/k8s-flannel/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/05/23/k8s-flannel/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="background"><a href="#background" class="headerlink" title="background"></a>background</h2><p>k8s networks include a few topics:</p>
<ul>
<li><p>pod to pod communication in k8s</p>
</li>
<li><p>pod to the host node communication</p>
</li>
<li><p>pod to external service URL</p>
</li>
<li><p>external request to pod in k8s</p>
</li>
</ul>
<p>the networks have two components: DNS and iptables. DNS used to resovle URL name to IP; iptables used to control network message transfer in/out. </p>
<h4 id="preparation-image-for-test"><a href="#preparation-image-for-test" class="headerlink" title="preparation image for test"></a>preparation image for test</h4><p>to test network inside pod/docker, we need add the following network tools: </p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="string">iputils-ping</span> <span class="string">\</span> </div><div class="line"><span class="string">net-tools</span> <span class="string">\</span> </div><div class="line"><span class="string">iptables</span> <span class="string">\</span></div><div class="line"><span class="string">iproute</span></div></pre></td></tr></table></figure>
<h4 id="docker-pod-runtime-privileges"><a href="#docker-pod-runtime-privileges" class="headerlink" title="docker/pod runtime privileges"></a>docker/pod runtime privileges</h4><p>by default, docker doesn’t allow run <code>iptables</code> inside container. and it give errors:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">root@redisjq:/<span class="comment"># iptables -t nat -L | grep INPUT </span></div><div class="line">iptables v1.6.0: can<span class="string">'t initialize iptables table `nat'</span>: Permission denied (you must be root)</div><div class="line">Perhaps iptables or your kernel needs to be upgraded.</div></pre></td></tr></table></figure>
<p>which need to add <a href="https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities" target="_blank" rel="external">docker runtime privilege and Linux capabilities</a></p>
<p><a href="https://www.weave.works/blog/container-capabilities-kubernetes/" target="_blank" rel="external">container capabilities in k8s</a></p>
<p>In a Kubernetes pod, the names are the same, but everything has to be defined in the pod specification. When implementing this in Kubernetes, you add an array of capabilities under the securityContext tag.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">securityContext:</div><div class="line">  capabilities:</div><div class="line">    add:</div><div class="line">       - NET_ADMIN</div></pre></td></tr></table></figure>
<h2 id="k8s-pod-DNS"><a href="#k8s-pod-DNS" class="headerlink" title="k8s pod DNS"></a>k8s pod DNS</h2><p><a href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/" target="_blank" rel="external">DNS for services and pods</a> introduced four types: </p>
<ul>
<li><p>None </p>
</li>
<li><p>Default， where POD derived DNS config from the host node where to run pod.</p>
</li>
<li><p>ClusterFirst， where POD use DNS info from kube-dns or coreDNS</p>
</li>
<li><p>ClusterFirstWithHostNet, as the name explained.</p>
</li>
</ul>
<p>tips, <strong>Default</strong> is not the default DNS policy. If dnsPolicy is not explicitly specified, then <strong>ClusterFirst</strong> is used as default.</p>
<p>the purpose of pod/service DNS is used to transfer URL to IP, which is the second step after iptabels is understand successfully.</p>
<p><code>coreDNS</code> is setted during <code>kube-adm init</code> with <code>serverDNS</code>. To do SNAT, the pod/service in K8S need access </p>
<h5 id="resolv-conf-DNS-inside-pod"><a href="#resolv-conf-DNS-inside-pod" class="headerlink" title="resolv.conf/DNS inside pod :"></a>resolv.conf/DNS inside pod :</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">root@redisjq:/redis<span class="comment"># cat /etc/resolv.conf </span></div><div class="line">nameserver 10.96.0.10</div><div class="line">search lg.svc.cluster.local svc.cluster.local cluster.local</div><div class="line">options ndots:5</div></pre></td></tr></table></figure>
<p>clearly, the pod DNS is coming from cluster, which can be check by: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">kubectl describe configmap kubeadm-config -n kube-system </div><div class="line"></div><div class="line">kind: ClusterConfiguration</div><div class="line">kubernetesVersion: v1.18.2</div><div class="line">networking:</div><div class="line">  dnsDomain: cluster.local</div><div class="line">  podSubnet: 10.4.0.0/16</div><div class="line">  serviceSubnet: 10.96.0.0/12</div></pre></td></tr></table></figure>
<p>and that’s the reason why resolve URL failed, as clusterDNS is kind of random defined. </p>
<p>the DNS failure gives errors as following inside pod: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">socket.gaierror: [Errno -3] Temporary failure in name resolution</div></pre></td></tr></table></figure>
<h4 id="docker0-DNS"><a href="#docker0-DNS" class="headerlink" title="docker0 DNS"></a>docker0 DNS</h4><p>docker engine can configure its DNS at <code>/etc/daemon.json</code>, with “dns” section. when running docker in single mode, docker0 looks has host machine’s DNS, but when runnig in swarm mode, need to define additional DNS for external access.</p>
<h2 id="iptables-in-K8S"><a href="#iptables-in-K8S" class="headerlink" title="iptables in K8S"></a>iptables in K8S</h2><p><a href="https://docs.docker.com/network/iptables/" target="_blank" rel="external">docker and iptables</a></p>
<p>you should not modify the rules Docker inserts into your iptables policies. Docker installs two custom iptables chains named <code>DOCKER-USER</code> and <code>DOCKER</code>, and it ensures that incoming packets are always checked by these two chains first</p>
<p>a simple test can found, <code>docker0</code> NIC is bridge is well to bind host network namespace, either export or response request externally. while with <code>flannel.d</code> NIC, pod can’t access external resources.</p>
<p><a href="https://www.bookstack.cn/read/source-code-reading-notes/kubernetes-kube_proxy_iptables.md" target="_blank" rel="external">code review: kube-proxy iptables</a>: </p>
<p>iptables has 5 tables and 5 chains.</p>
<p>the 5 chaines: </p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="attr">PREROUTING:</span> <span class="string">before</span> <span class="string">message</span> <span class="string">into</span> <span class="string">route,</span> <span class="string">the</span> <span class="string">external</span> <span class="string">request</span> <span class="string">DNAT.</span></div><div class="line"><span class="attr">INPUT:</span> <span class="string">message</span> <span class="string">to</span> <span class="string">local</span> <span class="string">host</span> <span class="string">or</span> <span class="string">current</span> <span class="string">network</span> <span class="string">namespace.</span> </div><div class="line"><span class="attr">FORWARD:</span> <span class="string">message</span> <span class="string">forward</span> <span class="string">to</span> <span class="string">other</span> <span class="string">host</span> <span class="string">or</span> <span class="string">other</span> <span class="string">network</span> <span class="string">namespace.</span></div><div class="line"><span class="attr">OUTPUT:</span> <span class="string">message</span> <span class="string">export</span> <span class="string">from</span> <span class="string">current</span> <span class="string">host</span></div><div class="line"><span class="attr">POSTROUTING:</span> <span class="string">after</span> <span class="string">route</span> <span class="string">before</span> <span class="string">NIC,</span> <span class="string">message</span> <span class="string">SNAT</span></div></pre></td></tr></table></figure>
<p>the 5 tables: </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">filter table, used to control the network package need to ACCEPT, or DROP, or REJECT when it comes to a chain</div><div class="line">nat(network address translation) table, used to modify the src/target address of network package</div><div class="line">mangle table, used to modify IP header info of network package</div><div class="line">raw table</div><div class="line">security table</div></pre></td></tr></table></figure>
<p>for k8s pods/services, mostly consider <code>filter</code> and <code>nat</code> tables. and k8s expand another 7 chains: KUBE-SERVICES、KUBE-EXTERNAL-SERVICES、KUBE-NODEPORTS、KUBE-POSTROUTING、KUBE-MARK-MASQ、KUBE-MARK-DROP、KUBE-FORWARD. </p>
<p><img src="https://static.bookstack.cn/projects/source-code-reading-notes/729e704bd9fc39c9223da5185e9ef084.png" alt="image"></p>
<h2 id="virtual-network-flannel"><a href="#virtual-network-flannel" class="headerlink" title="virtual network flannel"></a>virtual network flannel</h2><h4 id="check-running-flanneld"><a href="#check-running-flanneld" class="headerlink" title="check running flanneld"></a>check running flanneld</h4><ul>
<li><p><code>/etc/cni/net.d/10-flannel.conflist</code> on host machine is the same as <code>/etc/kube-flannel/cni-conf.json</code> in flannel container on master node.</p>
</li>
<li><p><code>/run/flannel/subnet.env</code> exist in both flannel container (on master node) and in master host machine. it looks like network configure(subnet.env) is copied from container to host machine. so if there is no <code>flannel container</code> running on some nodes, these nodes won’t have the right network configure. </p>
</li>
</ul>
<p>at master node, <code>HostPath</code> points to: /run/flannel, /etc/cni/net.d, kube-flannel-cfg (ConfigMap); while at working node(due to missing /gcr.io/flannel image), <code>/run/flannel/subnet.env</code> is missed. previously, I thought to cp this file from master node to woker node is the solution, then this file is missed every time to restart worker node. </p>
<p>once copied both <code>kube-proxy</code> and <code>flannel</code> images to worker node, and restart <code>kubelet</code> at worker node, the cluster should give <code>Running status</code> of all these components. including 2 copies of <code>flannel</code>, one running on master node, and the other running on working node. </p>
<p>as we are using <code>kubectl</code> to start the cluster, the actual flanneld is <code>/opt/bin/flanneld</code> from the running flannel container, and it maps NIC to the host machine. </p>
<p>another thing is, <code>flannel</code> is the core of the default <code>kube-proxy</code>, so <code>kube-proxy</code> image is also required on both nodes. <code>coreDNS</code> run two copies on master node.</p>
<h4 id="Flannel-mechanism"><a href="#Flannel-mechanism" class="headerlink" title="Flannel mechanism"></a><a href="https://www.jianshu.com/p/165a256fb1da" target="_blank" rel="external">Flannel mechanism</a></h4><p>the data flow: <strong>the sending message</strong> go to VNC(virtual network card) <code>docker0</code> on host machine, which transfers to VNC <code>flannel0</code>. this process is P2P. the global <code>etcd</code> service maintain a iptables among nodes, which store the subnet range of each node. 2) the <code>flanneld</code> service on the special node package <strong>the sending message</strong> as UDP package, and delivery to target node, based on the iptables. 3) when the target node received the UDP package, it unpackage the message, and send to its <code>flannel0</code>, then transfer to its <code>docker0</code>. </p>
<p>1) after flanneld started，will create <code>flannel.1</code> virtual network card. the purpose of <code>flannel.1</code> is for across-host network, including package/unpackage UDP, and maintain iptables among the nodes. </p>
<p>2) each node also create <code>cni0</code> virtual network card, at the first time to run flannel CNI. the purpose of <code>cni0</code> is same as <code>docker0</code>, and it’s a bridge network, used for communication in the same node. </p>
<p><img src="https://www.centos.bz/wp-content/uploads/2017/06/flannel-01.png" alt="image"></p>
<h2 id="test-with-redis-services"><a href="#test-with-redis-services" class="headerlink" title="test with redis services"></a>test with redis services</h2><p>we had define a <code>redisjq</code> pod, the following testes are all in this pod:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">kubectl <span class="built_in">exec</span> -it redisjq -n lg  /bin/bash</div><div class="line">ping localhost <span class="comment">#ok</span></div><div class="line">ping 10.255.18.3 <span class="comment">#not </span></div><div class="line">ping 10.3.101.101 <span class="comment">#not</span></div><div class="line">ping 10.20.180.12 </div><div class="line"></div><div class="line">ifconfig </div><div class="line">&gt;&gt;eth0,  10.4.1.46</div><div class="line">&gt;&gt;lo, 127.0.0.1</div></pre></td></tr></table></figure>
<p>the output above is initial output before we had any network setttings. basically the pod can only ping localhost, neither the host DNS, or the host IP. the vip(10.4.1.46) is not in the same network namespace as host network space. </p>
<h4 id="flannel-d-pod-on-both-nodes"><a href="#flannel-d-pod-on-both-nodes" class="headerlink" title="flannel.d pod on both  nodes:"></a>flannel.d pod on both  nodes:</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">david@meng:~/k8s/lgsvl$ kubectl get pods kube-flannel-ds-amd64-85d6m  -n kube-system --output=wide</div><div class="line">NAME                          READY   STATUS    RESTARTS   AGE   IP             NODE   NOMINATED NODE   READINESS GATES</div><div class="line">kube-flannel-ds-amd64-85d6m   1/1     Running   5          15d   10.20.180.12   meng   &lt;none&gt;           &lt;none&gt;</div><div class="line"></div><div class="line">david@meng:~/k8s/lgsvl$ kubectl get pods kube-flannel-ds-amd64-fflsl  -n kube-system --output=wide</div><div class="line">NAME                          READY   STATUS    RESTARTS   AGE   IP              NODE     NOMINATED NODE   READINESS GATES</div><div class="line">kube-flannel-ds-amd64-fflsl   1/1     Running   154        15d   10.20.181.132   ubuntu   &lt;none&gt;           &lt;none&gt;</div></pre></td></tr></table></figure>
<p><code>flannel.d</code> is runing on each node, should triggered by <code>kubelet</code>. <code>flannel.d</code> is used as virtual network interface, to manage across-node pod communication inside k8s. </p>
<h4 id="coredns-pod-in-meng-node"><a href="#coredns-pod-in-meng-node" class="headerlink" title="coredns pod in meng node"></a>coredns pod in meng node</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">david@meng:~/k8s/lgsvl$ kubectl get pods coredns-66bff467f8-59g97  -n kube-system --output=wide</div><div class="line">NAME                       READY   STATUS    RESTARTS   AGE   IP          NODE   NOMINATED NODE   READINESS GATES</div><div class="line">coredns-66bff467f8-59g97   1/1     Running   4          14d   10.4.0.27   meng   &lt;none&gt;           &lt;none&gt;</div></pre></td></tr></table></figure>
<p><code>coredns</code> has two replicas, both running on master node(meng), and we can see it only has virtual ip/cluster ip ( 10.4.0.x).</p>
<h4 id="redisjs-pod-in-ubuntu’s-node"><a href="#redisjs-pod-in-ubuntu’s-node" class="headerlink" title="redisjs pod in ubuntu’s node"></a>redisjs pod in ubuntu’s node</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">david@meng:~/k8s/lgsvl$ kubectl get pods redisjq -n lg --output=wide </div><div class="line">NAME      READY   STATUS    RESTARTS   AGE   IP          NODE     NOMINATED NODE   READINESS GATES</div><div class="line">redisjq   1/1     Running   0          20m   10.4.1.47   ubuntu   &lt;none&gt;           &lt;none&gt;</div></pre></td></tr></table></figure>
<p>by default, working pod is only running at woker node(ubuntu), which has clusterIP(10.4.1.47).</p>
<h4 id="pod1-ping-pod2-in-the-same-node"><a href="#pod1-ping-pod2-in-the-same-node" class="headerlink" title="pod1 ping pod2 in the same node"></a>pod1 ping pod2 in the same node</h4><p><strong>ping successfully</strong> there is no doubt in the same node, pods can ping each other.</p>
<h4 id="redisjq-pod1-10-4-1-47-in-ubuntu-ping-corends-pod2-10-4-0-27-in-meng"><a href="#redisjq-pod1-10-4-1-47-in-ubuntu-ping-corends-pod2-10-4-0-27-in-meng" class="headerlink" title="redisjq pod1(10.4.1.47) in ubuntu ping corends pod2(10.4.0.27) in meng"></a>redisjq pod1(10.4.1.47) in ubuntu ping corends pod2(10.4.0.27) in meng</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">root@redisjq:/redis<span class="comment"># ping 10.4.0.27 </span></div><div class="line">PING 10.4.0.27 (10.4.0.27) 56(84) bytes of data.</div><div class="line">64 bytes from 10.4.0.27: icmp_seq=1 ttl=62 time=0.757 ms</div></pre></td></tr></table></figure>
<p><strong>ping successfully</strong>, which is the working of flanneld. </p>
<h4 id="redisjq-pod1-10-4-1-7-in-ubuntu-ping-hostIP-10-20-181-132-of-ubuntu"><a href="#redisjq-pod1-10-4-1-7-in-ubuntu-ping-hostIP-10-20-181-132-of-ubuntu" class="headerlink" title="redisjq pod1(10.4.1.7) in ubuntu  ping hostIP(10.20.181.132) of ubuntu"></a>redisjq pod1(10.4.1.7) in ubuntu  ping hostIP(10.20.181.132) of ubuntu</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">root@redisjq:/redis<span class="comment"># ping 10.20.181.132</span></div><div class="line">PING 10.20.181.132 (10.20.181.132) 56(84) bytes of data.</div><div class="line">64 bytes from 10.20.181.132: icmp_seq=1 ttl=64 time=0.127 ms</div></pre></td></tr></table></figure>
<p><strong>ping successfuly</strong>, pod in cluster can ping its host node, sounds no problem. </p>
<h4 id="redisjq-pod1-10-4-1-7-in-ubuntu-ping-hostIP-10-20-180-12-of-meng"><a href="#redisjq-pod1-10-4-1-7-in-ubuntu-ping-hostIP-10-20-180-12-of-meng" class="headerlink" title="redisjq pod1(10.4.1.7) in ubuntu ping hostIP(10.20.180.12) of meng"></a>redisjq pod1(10.4.1.7) in ubuntu ping hostIP(10.20.180.12) of meng</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">root@redisjq:/redis<span class="comment"># ping 10.20.180.12 </span></div><div class="line">PING 10.20.180.12 (10.20.180.12) 56(84) bytes of data.</div></pre></td></tr></table></figure>
<p><strong>ping failed</strong>, interesting, so pod in cluster can’t ping any non-hosting node’s IP.</p>
<p>so far, pod with vip can ping any other pod with vip in the cluster, no matter in the same node or not.  pod with vip can only ping its host machine’s physical IP, but pod can’t ping other hostIP.</p>
<p>namely, the network of pod VIP inside k8s and the bridge network from pod vip to its host is set well. but the network from pod to external IP is not well.</p>
<p>these 4 tests give a very good understanding about flannel’s function inside k8s: pod to pod in the same node or not. but usually we need SNAT or DNAT. to make SNAT/DNAT avaiable, we need understand <strong>DNS &amp; iptables</strong> of k8s. </p>
<h2 id="update-iptables-to-allow-pod-access-public-IP"><a href="#update-iptables-to-allow-pod-access-public-IP" class="headerlink" title="update iptables to allow pod access public IP"></a>update iptables to allow pod access public IP</h2><h4 id="cni0-docker0-eno1-flannel-1-in-host-machine-vs-eth0-in-pod"><a href="#cni0-docker0-eno1-flannel-1-in-host-machine-vs-eth0-in-pod" class="headerlink" title="cni0, docker0, eno1, flannel.1 in host machine vs eth0 in pod"></a>cni0, docker0, eno1, flannel.1 in host machine vs eth0 in pod</h4><p>these virtual NIC are common in k8s env. </p>
<ul>
<li>on node1 </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">cni0: 10.4.1.1</div><div class="line">docker0: 172.17.0.1</div><div class="line">eno1: 10.20.181.132</div><div class="line">flannel.1: 10.4.1.0</div></pre></td></tr></table></figure>
<ul>
<li>on pod1, which is running on node1</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">eth0:  10.4.1.48</div></pre></td></tr></table></figure>
<p><a href="https://www.centos.bz/2017/06/k8s-flannel-network/" target="_blank" rel="external">pod1 -&gt; pod2 network message flow</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pod1(10.4.1.48) on node1(10.20.181.132) -&gt; cni0(10.4.1.1) -&gt; flannel.1(10.4.1.0) -&gt; kube-flannel on node1(10.20.181.132) -&gt; kube-flannel on node2(10.20.180.12) -&gt; flannel.1 on node2 -&gt; cni0 on node2 -&gt; pod2(10.4.1.46) on node2</div></pre></td></tr></table></figure>
<p>to allow network message SNAT, namely to handle <strong>FORWARD</strong> internal clusterIP data to external services, we can add the following newe iptable rule:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -t nat -I POSTROUTING -s 10.4.1.0/24 -j MASQUERADE</div></pre></td></tr></table></figure>
<p>after add the new rule, check inside pod:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">root@redisjq:/redis<span class="comment"># ping 10.20.180.12 </span></div><div class="line">PING 10.20.180.12 (10.20.180.12) 56(84) bytes of data.</div><div class="line">64 bytes from 10.20.180.12: icmp_seq=1 ttl=62 time=0.690 ms</div><div class="line">root@redisjq:/redis<span class="comment"># ping 10.20.181.132</span></div><div class="line">PING 10.20.181.132 (10.20.181.132) 56(84) bytes of data.</div><div class="line">64 bytes from 10.20.181.132: icmp_seq=1 ttl=64 time=0.108 ms</div><div class="line">root@redisjq:/redis<span class="comment"># ping 10.20.180.61 </span></div><div class="line">PING 10.20.180.61 (10.20.180.61) 56(84) bytes of data.</div><div class="line">64 bytes from 10.20.180.61: icmp_seq=1 ttl=126 time=0.366 ms</div><div class="line">root@redisjq:/redis<span class="comment"># ping www.baidu.com</span></div><div class="line">ping: unknown host www.baidu.com</div><div class="line">root@redisjq:/redis<span class="comment"># ping 61.135.169.121   #baidu IP</span></div><div class="line">PING 61.135.169.121 (61.135.169.121) 56(84) bytes of data.</div><div class="line">64 bytes from 61.135.169.121: icmp_seq=1 ttl=51 time=8.16 ms</div></pre></td></tr></table></figure>
<p>the DNS is not fixed, so we can’t ping <code>www.baidu.com</code>, but we can ping its IP.</p>
<p>on the other hand, to hanle <strong>FORWARD</strong> external request to internal clusterIP, we can add the following new iptable rule:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -t nat -I PREROUTING -d 10.4.1.0/24 -j MASQUERADE</div></pre></td></tr></table></figure>
<p>that’s beauty of iptables. </p>
<p>as mentioned previously, to handle pod DNS error, we need add <a href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/" target="_blank" rel="external">pod/service DNS strategy</a> inside the <code>pod.yaml</code>:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  dnsPolicy:</span> <span class="string">Default</span></div></pre></td></tr></table></figure>
<p>our k8s cluster has none DNS server itself, so to do SNAT/DNAT, we have to keep <code>Default</code> dns strategy, which make pod/service to use its host machine’s DNS, which is defined at <code>/etc/resovl.conf</code>.</p>
<p>one thing to take care, some host machine has only <code>nameserver 127.0.0.1</code> in <code>resolv.conf</code>, then we need add the real DNS server.</p>
<h2 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h2><p>with knowledge about iptables and dns, we can make an useful K8S cluster. the left work is make useful pods.</p>
<h2 id="refere"><a href="#refere" class="headerlink" title="refere"></a>refere</h2><p><a href="https://jimmysong.io/blog/configuring-kubernetes-kube-dns/" target="_blank" rel="external">jimmy song: config K8S DNS: kube-dns</a></p>
<p><a href="https://askubuntu.com/questions/346838/how-do-i-configure-my-dns-settings-in-ubuntu-server" target="_blank" rel="external">configure DNS settings in Ubuntu</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/90992878" target="_blank" rel="external">zhihu: k8s network</a></p>
<p><a href="https://www.kubernetes.org.cn/4317.html" target="_blank" rel="external">k8s expose service</a></p>
<p><a href="https://www.kubernetes.org.cn/6838.html" target="_blank" rel="external">k8s network advance</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1140088" target="_blank" rel="external">docker iptables from tencent cloud</a></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/k8s/" rel="tag"># k8s</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/05/17/k8s-setup-2/" rel="next" title="k8s setup 2">
                <i class="fa fa-chevron-left"></i> k8s setup 2
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/05/23/Linux-iptables/" rel="prev" title="Linux iptables">
                Linux iptables <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="David Z.J. Lee" />
          <p class="site-author-name" itemprop="name">David Z.J. Lee</p>
           
              <p class="site-description motion-element" itemprop="description">what I don't know</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">190</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">51</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/ZJLi2013" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.linkedin.com/in/zhengjia13/" target="_blank" title="LinkedIn">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  LinkedIn
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#background"><span class="nav-number">1.</span> <span class="nav-text">background</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#preparation-image-for-test"><span class="nav-number">1.0.1.</span> <span class="nav-text">preparation image for test</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#docker-pod-runtime-privileges"><span class="nav-number">1.0.2.</span> <span class="nav-text">docker/pod runtime privileges</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#k8s-pod-DNS"><span class="nav-number">2.</span> <span class="nav-text">k8s pod DNS</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#resolv-conf-DNS-inside-pod"><span class="nav-number">2.0.0.1.</span> <span class="nav-text">resolv.conf/DNS inside pod :</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#docker0-DNS"><span class="nav-number">2.0.1.</span> <span class="nav-text">docker0 DNS</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#iptables-in-K8S"><span class="nav-number">3.</span> <span class="nav-text">iptables in K8S</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#virtual-network-flannel"><span class="nav-number">4.</span> <span class="nav-text">virtual network flannel</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#check-running-flanneld"><span class="nav-number">4.0.1.</span> <span class="nav-text">check running flanneld</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Flannel-mechanism"><span class="nav-number">4.0.2.</span> <span class="nav-text">Flannel mechanism</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#test-with-redis-services"><span class="nav-number">5.</span> <span class="nav-text">test with redis services</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#flannel-d-pod-on-both-nodes"><span class="nav-number">5.0.1.</span> <span class="nav-text">flannel.d pod on both  nodes:</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#coredns-pod-in-meng-node"><span class="nav-number">5.0.2.</span> <span class="nav-text">coredns pod in meng node</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#redisjs-pod-in-ubuntu’s-node"><span class="nav-number">5.0.3.</span> <span class="nav-text">redisjs pod in ubuntu’s node</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pod1-ping-pod2-in-the-same-node"><span class="nav-number">5.0.4.</span> <span class="nav-text">pod1 ping pod2 in the same node</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#redisjq-pod1-10-4-1-47-in-ubuntu-ping-corends-pod2-10-4-0-27-in-meng"><span class="nav-number">5.0.5.</span> <span class="nav-text">redisjq pod1(10.4.1.47) in ubuntu ping corends pod2(10.4.0.27) in meng</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#redisjq-pod1-10-4-1-7-in-ubuntu-ping-hostIP-10-20-181-132-of-ubuntu"><span class="nav-number">5.0.6.</span> <span class="nav-text">redisjq pod1(10.4.1.7) in ubuntu  ping hostIP(10.20.181.132) of ubuntu</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#redisjq-pod1-10-4-1-7-in-ubuntu-ping-hostIP-10-20-180-12-of-meng"><span class="nav-number">5.0.7.</span> <span class="nav-text">redisjq pod1(10.4.1.7) in ubuntu ping hostIP(10.20.180.12) of meng</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#update-iptables-to-allow-pod-access-public-IP"><span class="nav-number">6.</span> <span class="nav-text">update iptables to allow pod access public IP</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#cni0-docker0-eno1-flannel-1-in-host-machine-vs-eth0-in-pod"><span class="nav-number">6.0.1.</span> <span class="nav-text">cni0, docker0, eno1, flannel.1 in host machine vs eth0 in pod</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#summary"><span class="nav-number">7.</span> <span class="nav-text">summary</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#refere"><span class="nav-number">8.</span> <span class="nav-text">refere</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">David Z.J. Lee</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://zjlee.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://yoursite.com/2020/05/23/k8s-flannel/';
          this.page.identifier = '2020/05/23/k8s-flannel/';
          this.page.title = 'k8s: flannel';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://zjlee.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
