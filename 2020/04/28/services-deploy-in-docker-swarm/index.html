<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="swarm," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="backgroudour application so far includes the following three services:  simulator  pythonAPI  redisJQ   docker swarm network has the following three kind of networks, of course bridge to host network.">
<meta name="keywords" content="swarm">
<meta property="og:type" content="article">
<meta property="og:title" content="services deploy in docker swarm">
<meta property="og:url" content="http://yoursite.com/2020/04/28/services-deploy-in-docker-swarm/index.html">
<meta property="og:site_name" content="Serious Autonomous Vehicles">
<meta property="og:description" content="backgroudour application so far includes the following three services:  simulator  pythonAPI  redisJQ   docker swarm network has the following three kind of networks, of course bridge to host network.">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2020-04-28T12:55:55.889Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="services deploy in docker swarm">
<meta name="twitter:description" content="backgroudour application so far includes the following three services:  simulator  pythonAPI  redisJQ   docker swarm network has the following three kind of networks, of course bridge to host network.">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/04/28/services-deploy-in-docker-swarm/"/>





  <title>services deploy in docker swarm | Serious Autonomous Vehicles</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Serious Autonomous Vehicles</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/28/services-deploy-in-docker-swarm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">services deploy in docker swarm</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-04-28T08:54:49-04:00">
                2020-04-28
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/04/28/services-deploy-in-docker-swarm/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/04/28/services-deploy-in-docker-swarm/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="backgroud"><a href="#backgroud" class="headerlink" title="backgroud"></a>backgroud</h2><p>our application so far includes the following three services:</p>
<ul>
<li><p>simulator</p>
</li>
<li><p>pythonAPI</p>
</li>
<li><p>redisJQ</p>
</li>
</ul>
<p><strong>docker swarm network</strong> has the following three kind of networks, of course <code>bridge</code> to host network.</p>
<ul>
<li><p>overlay network, services in the same overlay network, can communicate to each other </p>
</li>
<li><p>routing network, the service requested can be hosted in any of the running nodes, further as load balancer.</p>
</li>
<li><p>host network </p>
</li>
</ul>
<p>usually,  <a href="https://docs.microsoft.com/en-us/dotnet/architecture/microservices/multi-container-microservice-net-applications/multi-container-applications-docker-compose" target="_blank" rel="external">multi-container apps can be deployed with docker-compose.yml</a>, check <a href="https://docs.docker.com/compose/compose-file/" target="_blank" rel="external">docker compse</a> for more details.</p>
<h2 id="DNS-service-discovery"><a href="#DNS-service-discovery" class="headerlink" title="DNS service discovery"></a>DNS service discovery</h2><p>the following is an example from (<a href="https://github.com/docker/labs/blob/master/networking/A3-overlay-networking.md" target="_blank" rel="external">overlay networking and service discovery</a>:</p>
<p>my test env includes 2 nodes, with host IP as following. when running docker services, it will generate a responding virtual IP, while which is dynamic assgined. </p>
<table>
<thead>
<tr>
<th>hostname</th>
<th>virtualIP</th>
<th>hostIP</th>
</tr>
</thead>
<tbody>
<tr>
<td>node1</td>
<td>10.0.0.4</td>
<td>xx.20.181.132</td>
</tr>
<tr>
<td>node2</td>
<td>10.0.0.2</td>
<td>xx.20.180.212</td>
</tr>
</tbody>
</table>
<p>a common issue when try first to use overlay network in swarm, e.g. ping the other service doesn’t work, check <code>/etc/resolv.conf</code> file: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cat /etc/resolv.conf </span></div><div class="line">nameserver 8.8.8.8</div><div class="line">nameserver 8.8.4.4</div><div class="line">``` </div><div class="line"></div><div class="line">the default `dns=8.8.8.8` can<span class="string">'t ping either hostIP or any docker0 IP. the reason can find [#moby/#23910](https://github.com/moby/moby/issues/23910): When spinning up a container, Docker will by default check for a DNS server defined in /etc/resolv.conf in the host OS, and if it doesn'</span>t find one, or finds only 127.0.0.1, will opt to use Google<span class="string">'s public DNS server 8.8.8.8. </span></div><div class="line"></div><div class="line">one solution mentioned:</div><div class="line"></div><div class="line">* cat /etc/docker/daemon.json </div><div class="line"></div><div class="line">```xml</div><div class="line">&#123;</div><div class="line"></div><div class="line">		"dns": ["172.17.0.1", "your.dns.server.ip", "8.8.8.8"]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>add a file <code>/etc/NetworkManager/dnsmasq.d/docker-bridge.conf</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">listen-address=172.17.0.1</div></pre></td></tr></table></figure>
<p>so basically, the default DNS setting only listens to DNS requests from 127.0.0.1 (ie, your computer). by adding <code>listen-address=172.17.0.1</code>, it tells it to listen to the docker bridge also. very importantly, <strong>Docker DNS server is used only for the user created networks</strong>, so need create a new docker network. if use the default <code>ingress</code> overlay network, the dns setup above still doesn’t work.</p>
<p>another solution is using <strong>host network</strong>, mentioned <a href="https://l-lin.github.io/post/2018/2018-09-03-docker_ubuntu_18_dns/" target="_blank" rel="external">using host DNS in docker container with Ubuntu</a> </p>
<h4 id="test-virtualIP-network"><a href="#test-virtualIP-network" class="headerlink" title="test virtualIP network"></a>test virtualIP network</h4><ul>
<li>create a new docker network</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker network create -d overlay l3</div></pre></td></tr></table></figure>
<p>why here need a new network ?  due to <strong>Docker DNS server(172.17.0.1) is used only for the user created networks</strong></p>
<ul>
<li>start the service with the created network: </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">docker service create --name lg --replicas 2 --network l3 20.20.180.212:5000/lg</div><div class="line">``` </div><div class="line"></div><div class="line">* check vip on both nodes</div><div class="line"></div><div class="line">```sh</div><div class="line"> docker network inspect l3</div></pre></td></tr></table></figure>
<p>check vip by the line <code>IPv4Address</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">node1 vip : `10.0.1.5/24`</div><div class="line">node2 vip: `10.0.1.6/24`</div></pre></td></tr></table></figure>
<ul>
<li>go to the running container </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">docker <span class="built_in">exec</span> -it 788e667ea9cb  /bin/bash </div><div class="line">apt-get update &amp;&amp; apt-get install iputils-ping</div><div class="line">ping 10.0.1.5</div><div class="line">ping 10.0.1.6</div></pre></td></tr></table></figure>
<ul>
<li>now ping service-name directly </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ping lg </div><div class="line">PING lg (10.0.1.2) 56(84) bytes of data.</div></pre></td></tr></table></figure>
<ul>
<li>inspect service </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">docker service inspect lg </div><div class="line">            <span class="string">"VirtualIPs"</span>: [</div><div class="line">                &#123;</div><div class="line">                    <span class="string">"Addr"</span>: <span class="string">"10.0.1.2/24"</span></div><div class="line">                &#125;</div><div class="line">            ]</div></pre></td></tr></table></figure>
<ul>
<li>ping host IP from contianer vip</li>
</ul>
<p>as far as we add both <code>host dns</code> and <code>docker0 dns</code> to the dns option in <code>/etc/docker/daemon.json</code>, the container vip can ping host IP.</p>
<h4 id="assign-ENV-variable-from-script"><a href="#assign-ENV-variable-from-script" class="headerlink" title="assign ENV variable from script"></a>assign ENV variable from script</h4><ul>
<li>get services vip </li>
</ul>
<p><a href="https://serverfault.com/questions/925267/how-do-i-list-docker-vip-addresses" target="_blank" rel="external">get vip list</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">vip=`sudo docker service inspect --format <span class="string">'&#123;&#123;.Endpoint.VirtualIPs&#125;&#125;'</span>  lgsvl | awk <span class="string">'&#123;print substr($2, 1, length($2)-5)&#125;'</span>`</div><div class="line"><span class="built_in">echo</span> <span class="variable">$vip</span></div></pre></td></tr></table></figure>
<ul>
<li>create docker service with runtime env</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">ping -c 1 lg  | awk <span class="string">'NR==1 &#123;print $2&#125;'</span> </div><div class="line">``` </div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">## multi-services test</span></div><div class="line"></div><div class="line"><span class="comment">#### run all services in single docker mode</span></div><div class="line"></div><div class="line">```sh</div><div class="line">docker run -it -p 6379:6379 --mount <span class="built_in">source</span>=jq-vol,target=/job_queue redisjq /bin/bash </div><div class="line">docker run xx.xx.xx.xxx:5000/lg</div><div class="line">docker run -it --mount <span class="built_in">source</span>=jq-vol,target=/pythonAPI/job_queue xx.xx.xx.xxx:5000/redispythonapi  /bin/bash</div></pre></td></tr></table></figure>
<ul>
<li>check docker-IP of <code>lg</code> :</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">docker sh </div><div class="line">docker container inspect &lt;lg&gt; <span class="comment">#get its IP-address</span></div></pre></td></tr></table></figure>
<ul>
<li>update <code>SIMULATOR_HOST</code> for <code>redispythonapi</code> </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">docker <span class="built_in">exec</span> -it &lt;redispythonapi&gt; /bin/bash</div><div class="line"><span class="built_in">export</span> SIMULATOR_HOST=lg_ip_address <span class="comment">#from the step above</span></div><div class="line">./redis_worker.sh  <span class="comment">#where all python scenarios are running in queue</span></div></pre></td></tr></table></figure>
<p>here we can check the lg container’s IP is <code>172.17.0.3</code> and redispythonapi’s IP is <code>172.17.0.4</code>, then update <code>start_redis_worker.sh</code> with <code>SIMULATOR_HOST=172.17.0.3</code></p>
<ul>
<li>get the container IP</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">docker container ls  | grep -w xx.xx.xx.xxx:5000/lg | awk <span class="string">'&#123;print $1&#125;'</span> </div><div class="line">docker inspect --format=<span class="string">'&#123;&#123;range .NetworkSettings.Networks&#125;&#125;&#123;&#123;.IPAddress&#125;&#125;&#123;&#123;end&#125;&#125;'</span>  $(docker container ls  | grep -w xx.xx.xx.xxx:5000/lg | awk <span class="string">'&#123;print $1&#125;'</span> )</div></pre></td></tr></table></figure>
<h2 id="assign-a-special-IP-to-service-in-swarm"><a href="#assign-a-special-IP-to-service-in-swarm" class="headerlink" title="assign a special IP to service in swarm"></a>assign a special IP to service in swarm</h2><p>docker network create support <a href="https://docs.docker.com/engine/reference/commandline/network_create/" target="_blank" rel="external">subnet</a>, which only ip-addressing function, namely we can use custom-defined virtual IP for our services. a sample: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">docker network create -d overlay \</div><div class="line">  --subnet=192.168.10.0/25 \</div><div class="line">  --subnet=192.168.20.0/25 \</div><div class="line">  --gateway=192.168.10.100 \</div><div class="line">  --gateway=192.168.20.100 \</div><div class="line">  --aux-address=<span class="string">"my-router=192.168.10.5"</span> --aux-address=<span class="string">"my-switch=192.168.10.6"</span> \</div><div class="line">  --aux-address=<span class="string">"my-printer=192.168.20.5"</span> --aux-address=<span class="string">"my-nas=192.168.20.6"</span> \</div><div class="line">  my-multihost-network</div><div class="line">``` </div><div class="line"></div><div class="line">we can run our application as:</div><div class="line"></div><div class="line">```sh</div><div class="line">docker network create --driver=overlay --subnet=192.168.10.0/28  lgsvl-net</div><div class="line">docker service create --name lgsvl --replicas 2 --network lgsvl-net --host <span class="string">"host:192.168.10.2"</span>  xx.xx.xx.xxx:5000/lgsvl</div><div class="line">docker service create --name redis --replicas 1 --network lgsvl-net  -p 6379:6379 --mount <span class="built_in">source</span>=jq-vol,target=/job_queue  --constraint <span class="string">'node.hostname==ubuntu'</span> xx.xx.xx.xxx:5000/redisjq</div><div class="line">docker service create --name pythonapi --replicas 1 --network lgsvl-net --mount <span class="built_in">source</span>=jq-vol,target=/pythonAPI/job_queue  xx.xx.xx.xxx:5000/redispythonapi</div></pre></td></tr></table></figure>
<p><a href="https://www.cnblogs.com/milantgh/p/4075912.html" target="_blank" rel="external">understand subnet mask</a>. IP address include <code>master IP</code> and <code>subnet mask</code>, we choose <code>28</code> here, basically generate about <code>2^(32-28)-2= 14</code> avaiable IP address in the subnet. but in a swarm env, subnet IPs are consuming more as the nodes or replicas of service increase.</p>
<p>taking an example, with 2-nodes and 2-replicas of service, <strong>5 subnet IPs are occupied, rather than 2</strong></p>
<p>run <code>docker network inspect lgsvl-net</code> on both nodes:</p>
<ul>
<li>on node1 gives:</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">lg.1 IPV4Address: 192.168.10.11/28</div><div class="line">lgssvl-net-endpoint: 192.168.10.6/28</div></pre></td></tr></table></figure>
<ul>
<li>on node2 gives:</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">lg.2 IPV4Address: 192.168.10.4/28</div><div class="line">lgssvl-net-endpoint: 192.168.10.3/28</div><div class="line">``` </div><div class="line"></div><div class="line">* `docker service inspect lg` gives:</div><div class="line"></div><div class="line">```xml</div><div class="line">VirualIPs: 192.168.10.2/28</div></pre></td></tr></table></figure>
<p>clearly 5 IP address are occupied. and the IP for each internal service is random picked, there is no gurantee <code>service</code> will always get the first avaiable IP. </p>
<h4 id="docker-serivce-with-–ip"><a href="#docker-serivce-with-–ip" class="headerlink" title="docker serivce with –ip"></a>docker serivce with –ip</h4><p><strong>only docker run –ip</strong> works, there is no similar <code>--ip</code> option in <code>docker service create</code>. but a lot case require this feature: <a href="https://success.docker.com/article/how-do-i-publish-a-service-port-to-a-specific-ip-address" target="_blank" rel="external">how to publish a service port to a specific IP address</a>,  when publishing a port using <code>--publish</code>, the port is published to <code>0.0.0.0</code> instead of a specific interface’s assigned IP. and there is no way to assign an fixed IP to a service in swarm. </p>
<p>a few disscussion in <a href="https://github.com/moby/moby/issues/26696" target="_blank" rel="external">moby/#26696</a>, <a href="https://github.com/moby/moby/issues/25303" target="_blank" rel="external">add more options to `service create</a>, <a href="https://github.com/moby/moby/issues/24170#issuecomment-300771012" target="_blank" rel="external">a possible solution</a>, <a href="https://github.com/moby/moby/issues/24170" target="_blank" rel="external">Static/Reserved IP addresses for swarm services</a></p>
<p>mostly depend on the issues like “ip address is not known in advance, since docker service launched in swarm mode will end up on multiple docker servers”. there should not be applicable to docker swarm setup, since if one decides to go with docker swarm service, has to accept that service will run on multiple hosts with different ip addresses. I.e. trying to attach service / service instance to specific IP address somewhat contradicting with docker swarm service concept. </p>
<p><a href="https://docs.docker.com/engine/reference/commandline/service_create/" target="_blank" rel="external">docker service create</a> does have options <code>--host host:ip-address</code> and <code>--hostname</code> and similar in <a href="https://docs.docker.com/engine/reference/commandline/service_update/" target="_blank" rel="external">docker service update</a>  support <code>host-add</code> and <code>host-rm</code>.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">$ docker service create --name redis --host <span class="string">"redishost:192.168.10.2"</span> --hostname myredis redis:3.0.6</div><div class="line">``` </div><div class="line"></div><div class="line"><span class="keyword">then</span> <span class="built_in">exec</span> into the running container, we can check out `192.168.10.2 redishost` is one line <span class="keyword">in</span> `/etc/hosts` and `myredis` is <span class="keyword">in</span> `/etc/hostname`</div><div class="line"></div><div class="line">but remember, the DNS <span class="keyword">for</span> this hostIP(192.168.10.2) should be first configured <span class="keyword">in</span> the docker engine DNS list. <span class="keyword">if</span> not, even the hostIP is <span class="keyword">in</span> the arrange of the subnet, it is unreachable from the containers.</div><div class="line"></div><div class="line">[another explain](https://www.freecodecamp.org/news/docker-nginx-letsencrypt-easy-secure-reverse-proxy-40165ba3aee2/): by default docker containers are put on their own network. This means that you won’t be able to access your container by it’s hostname, <span class="keyword">if</span> you’re sitting on your laptop on your host network. It is only the containers that are able to access each other through their hostname.</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#### dnsrr vs vip </span></div><div class="line"></div><div class="line">```sh</div><div class="line">--endpoint-mode dnsrr</div></pre></td></tr></table></figure>
<p><code>dnsrr</code> mode, namely DNS round Robin mode, when query Docker’s internal DNS server to get the IP address of the service, it will return IP address of every node running the service.</p>
<p><code>vip</code> mode, return the IP address of only one of the running cntainers. </p>
<p>When you submit a DNS query for a service name to the Swarm DNS service, it will return one, or all, the IP addresses of the related containers, depending on the endpoint-mode.</p>
<p><a href="https://stackoverflow.com/questions/42875572/how-to-load-balance-websocket-apps-in-docker-swarm" target="_blank" rel="external">dnsrr vs vip</a>: Swarm defaults to use a virtual ip (endpoint-mode vip). So each service gets its own IP address, and the swarm load balancer assigns the request as it sees fit; to prevent a service from having an IP address, you can run <code>docker service update your_app --endpoint-mode dnsrr</code>, which will allow an internal load balancer to <code>run a DNS query against a service name</code>, to discover each task/container’s IP for a given service</p>
<p>in our case, we want to assign a speical IP to the service in swarm. <strong>why?</strong> because our app has websocket server/client communicataion, which is IP address based. we can’ assign <code>service name</code> for WS server/client.</p>
<p>check another issue: <a href="https://stackoverflow.com/questions/54101508/how-do-you-dockerize-a-websocket-server" target="_blank" rel="external">dockerlize a websocket server</a></p>
<h2 id="global-mode-to-run-swarm"><a href="#global-mode-to-run-swarm" class="headerlink" title="global mode to run swarm"></a>global mode to run swarm</h2><p>when deploying service with global mode, namely each node will only run one replicas of the service. the benefit of <code>global mode</code> is we can always find the node IP, no matter the IP address is in host network or user-defined overlay network/subnetwork. </p>
<h4 id="get-service’s-IP-in-global-mode"><a href="#get-service’s-IP-in-global-mode" class="headerlink" title="get service’s IP in global mode"></a>get service’s IP in global mode</h4><p><a href="https://www.cyberciti.biz/faq/unix-linux-check-if-port-is-in-use-command/" target="_blank" rel="external">get listened port</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">root@c7279faebefa:/lgsvl<span class="comment"># netstat -tulpn | grep LISTEN</span></div><div class="line">tcp        0      0 127.0.0.11:33263        0.0.0.0:*               LISTEN      -               </div><div class="line">tcp        0      0 0.0.0.0:8080            0.0.0.0:*               LISTEN      7/lgsvl_Core.x86_64</div><div class="line">tcp        0      0 0.0.0.0:8181            0.0.0.0:*               LISTEN      7/lgsvl_Core.x86_64</div></pre></td></tr></table></figure>
<p>both <code>8080</code> and <code>8181</code> is listening after <code>lgsvl</code> service started. on the <code>lgsvl</code> side, we can modify it to listen on all address with <code>8181</code> port. then the following <a href="https://www.jb51.net/article/173931.htm" target="_blank" rel="external">python script</a> to find node’s IP:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> socket</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_host_ip</span><span class="params">()</span>:</span></div><div class="line">  <span class="keyword">try</span>:</div><div class="line">    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</div><div class="line">    s.connect((<span class="string">'8.8.8.8'</span>, <span class="number">80</span>))</div><div class="line">    ip = s.getsockname()[<span class="number">0</span>]</div><div class="line">  <span class="keyword">finally</span>:</div><div class="line">    s.close()</div><div class="line"> </div><div class="line">  <span class="keyword">return</span> ip</div></pre></td></tr></table></figure>
<p>in this way, no need to pre-define the <code>SIMULATOR_HOST</code> env variable at first. the pythonAPI only need to find out its own IP and detect if <code>8181</code> is listening on in runtime.</p>
<h4 id="container-vs-service"><a href="#container-vs-service" class="headerlink" title="container vs service"></a>container vs service</h4><p><a href="https://stackoverflow.com/questions/43408493/what-is-the-difference-between-docker-service-and-docker-container" target="_blank" rel="external">difference between service and container</a>:</p>
<ul>
<li><p><code>docker run</code> is used to create a standalone container</p>
</li>
<li><p><code>docker service</code> is the one run in a distributed env. when create a service, you specify which container image to use and which commands to execue inside the running containers. </p>
</li>
</ul>
<p>There is only one command(no matter the format is <code>CMD</code> <code>ENTRYPOINT</code> or <code>command in docker-compose</code>) that docker will run to start your container, and when that command exits, the container exits. in swarm service mode, with default restart option(any), the container run and exit and restart again with a different containeID. check <a href="https://stackoverflow.com/questions/56328330/dockerfile-docker-compose-and-swarm-mode-lifecycle" target="_blank" rel="external">dockerfile, docker-compose and swarm mode lifecycle</a> for details. </p>
<h4 id="docker-container-restart-policy"><a href="#docker-container-restart-policy" class="headerlink" title="docker container restart policy:"></a><a href="https://rollout.io/blog/ensuring-containers-are-always-running-with-dockers-restart-policy/" target="_blank" rel="external">docker container restart policy</a>:</h4><p><a href="https://docs.docker.com/config/containers/start-containers-automatically/" target="_blank" rel="external">docker official doc: start containers automatically</a></p>
<ul>
<li><p>no, simply doesn’t restart under any circumstance </p>
</li>
<li><p>on-failure, to restart if the exit code has error. user can specify a maximum number of times Docker will automatically restart the container; the container will not restart when app exit with a successful exit code. </p>
</li>
<li><p>unless-stopped, only stop when Docker is stopped. so most time, this policy work exactly like <code>always</code>, one exception, when a container is stopped and the server is reboot or the DOcker serivce is restarted, the container won’t restart itself. if the container was running before the reboot, the container would be restarted once the system restarted.</p>
</li>
<li><p>always, tells Docker to restart the container under any circumstance. and the service will restart even with reboot. any other policy can’t restart when system reboot.</p>
</li>
</ul>
<p>similar restart policy can be found in :</p>
<ul>
<li><a href="https://docs.docker.com/compose/compose-file/#restart_policy" target="_blank" rel="external">docker-compose restart policy</a></li>
</ul>
<ul>
<li><a href="https://docs.docker.com/engine/reference/commandline/service_create/" target="_blank" rel="external">docker service create restat-condition</a></li>
</ul>
<h4 id="keep-redisJQ-alive-in-python-script"><a href="#keep-redisJQ-alive-in-python-script" class="headerlink" title="keep redisJQ alive in python script"></a>keep redisJQ alive in python script</h4><p>by default setup, <code>redis server</code> is keep restarting and running, which make the <code>pythonapi</code> service always report: <code>redis.exceptions.ConnectionError: Error 111 connecting to xx.xxx.xxx:6379. Connection refused.</code></p>
<p>so we can keep redisJQ alive in python script level by simply a <code>while loop</code>.</p>
<p>for test purpose, we also make pythonAPI restart policy as none, so the service won’t automatically run even with empty jobQueue.</p>
<p>the final test script can run in the following:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">docker service create --name lgsvl --network lgsvl-net --mode global xx.xx.xx.xxx:5000/lgsvl</div><div class="line">docker service create --name redis -p 6379:6379 --network lgsvl-net --mount <span class="built_in">source</span>=jq-vol,target=/job_queue  --constraint <span class="string">'node.hostname==ubuntu'</span> xx.xx.xx.xxx:5000/redisjq </div><div class="line">docker service create --name pythonapi --network lgsvl-net --mode global --mount <span class="built_in">source</span>=jq-vol,target=/pythonAPI/job_queue --restart-condition none xx.xx.xx.xxx:5000/pythonapi</div></pre></td></tr></table></figure>
<h4 id="use-python-variable-in-os-system"><a href="#use-python-variable-in-os-system" class="headerlink" title="use python variable in os.system"></a>use python variable in os.system</h4><p><a href="https://stackoverflow.com/questions/27128851/how-to-use-python-variable-in-os-system" target="_blank" rel="external">sample</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">os.system(<span class="string">"ls -lt %s"</span>%your_py_variable)</div></pre></td></tr></table></figure>
<h2 id="proxy-in-docker-swarm"><a href="#proxy-in-docker-swarm" class="headerlink" title="proxy in docker swarm"></a>proxy in docker swarm</h2><p><a href="https://www.haproxy.com/blog/haproxy-on-docker-swarm-load-balancing-and-dns-service-discovery/" target="_blank" rel="external">HAProxy</a></p>
<p>Routing external traffic into the cluster, load balancing across replicas, and DNS service discovery are a few capabilities that require finesse. but proxy can’t either assign a special IP to a special service, neither can expose the service with a fixed IP, so in our case, no helpful.</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/swarm/" rel="tag"># swarm</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/04/28/redis-task-queue-2/" rel="next" title="redis task queue (2)">
                <i class="fa fa-chevron-left"></i> redis task queue (2)
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/05/17/k8s-setup-1/" rel="prev" title="k8s setup 1">
                k8s setup 1 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="David Z.J. Lee" />
          <p class="site-author-name" itemprop="name">David Z.J. Lee</p>
           
              <p class="site-description motion-element" itemprop="description">what I don't know</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">177</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">47</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/ZJLi2013" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.linkedin.com/in/zhengjia13/" target="_blank" title="LinkedIn">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  LinkedIn
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#backgroud"><span class="nav-number">1.</span> <span class="nav-text">backgroud</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DNS-service-discovery"><span class="nav-number">2.</span> <span class="nav-text">DNS service discovery</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#test-virtualIP-network"><span class="nav-number">2.0.1.</span> <span class="nav-text">test virtualIP network</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#assign-ENV-variable-from-script"><span class="nav-number">2.0.2.</span> <span class="nav-text">assign ENV variable from script</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#assign-a-special-IP-to-service-in-swarm"><span class="nav-number">3.</span> <span class="nav-text">assign a special IP to service in swarm</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#docker-serivce-with-–ip"><span class="nav-number">3.0.1.</span> <span class="nav-text">docker serivce with –ip</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#global-mode-to-run-swarm"><span class="nav-number">4.</span> <span class="nav-text">global mode to run swarm</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#get-service’s-IP-in-global-mode"><span class="nav-number">4.0.1.</span> <span class="nav-text">get service’s IP in global mode</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#container-vs-service"><span class="nav-number">4.0.2.</span> <span class="nav-text">container vs service</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#docker-container-restart-policy"><span class="nav-number">4.0.3.</span> <span class="nav-text">docker container restart policy:</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#keep-redisJQ-alive-in-python-script"><span class="nav-number">4.0.4.</span> <span class="nav-text">keep redisJQ alive in python script</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#use-python-variable-in-os-system"><span class="nav-number">4.0.5.</span> <span class="nav-text">use python variable in os.system</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#proxy-in-docker-swarm"><span class="nav-number">5.</span> <span class="nav-text">proxy in docker swarm</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">David Z.J. Lee</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://zjlee.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://yoursite.com/2020/04/28/services-deploy-in-docker-swarm/';
          this.page.identifier = '2020/04/28/services-deploy-in-docker-swarm/';
          this.page.title = 'services deploy in docker swarm';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://zjlee.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
