<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="aws," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="ceph introA Ceph Storage Cluster requires at least one Ceph Monitor, Ceph Manager, and Ceph OSD (Object Storage Daemon) ceph storage clusterThe Ceph File System, Ceph Object Storage and Ceph Block Dev">
<meta name="keywords" content="aws">
<meta property="og:type" content="article">
<meta property="og:title" content="ceph &amp; boto3 introduction">
<meta property="og:url" content="http://yoursite.com/2020/02/28/ceph-boto3-intro/index.html">
<meta property="og:site_name" content="Serious Autonomous Vehicles">
<meta property="og:description" content="ceph introA Ceph Storage Cluster requires at least one Ceph Monitor, Ceph Manager, and Ceph OSD (Object Storage Daemon) ceph storage clusterThe Ceph File System, Ceph Object Storage and Ceph Block Dev">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://docs.ceph.com/docs/master/_images/ditaa-bd1070de50515485f116a874684956bc7e26c664.png">
<meta property="og:updated_time" content="2020-03-03T09:02:02.501Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ceph &amp; boto3 introduction">
<meta name="twitter:description" content="ceph introA Ceph Storage Cluster requires at least one Ceph Monitor, Ceph Manager, and Ceph OSD (Object Storage Daemon) ceph storage clusterThe Ceph File System, Ceph Object Storage and Ceph Block Dev">
<meta name="twitter:image" content="https://docs.ceph.com/docs/master/_images/ditaa-bd1070de50515485f116a874684956bc7e26c664.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/02/28/ceph-boto3-intro/"/>





  <title>ceph & boto3 introduction | Serious Autonomous Vehicles</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Serious Autonomous Vehicles</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/28/ceph-boto3-intro/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">ceph & boto3 introduction</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-28T21:16:46-05:00">
                2020-02-28
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/02/28/ceph-boto3-intro/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/02/28/ceph-boto3-intro/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="ceph-intro"><a href="#ceph-intro" class="headerlink" title="ceph intro"></a>ceph intro</h2><p>A Ceph Storage Cluster requires at least one Ceph Monitor, Ceph Manager, and Ceph OSD (Object Storage Daemon)</p>
<h3 id="ceph-storage-cluster"><a href="#ceph-storage-cluster" class="headerlink" title="ceph storage cluster"></a>ceph storage cluster</h3><p>The Ceph File System, Ceph Object Storage and Ceph Block Devices read data from and write data to the Ceph Storage Cluster.</p>
<p><a href="https://docs.ceph.com/docs/master/rados/operations/" target="_blank" rel="external">cluster operations</a></p>
<p><a href="https://docs.ceph.com/docs/master/rados/operations/data-placement/" target="_blank" rel="external">data placement</a></p>
<ul>
<li><p>pools, which are logical groups for storing objects</p>
</li>
<li><p>Placement Groups(PG), PGs are fragments of a logical object pool</p>
</li>
<li><p>CRUSH maps, provide the physical topology of the cluster to the CRUSH algorithm to determine where the data for an object and its replicas should be stored, and how to do so across failure domains for added data safety among other things.</p>
</li>
<li><p>Balancer, a feature that will automatically optimize the distribution of PGs across devices to achieve a balanced data distribution</p>
</li>
</ul>
<h3 id="Librados-APIs-workflow"><a href="#Librados-APIs-workflow" class="headerlink" title="Librados APIs workflow"></a>Librados APIs workflow</h3><p>apis can interact with: Ceph monitor as well as OSD.</p>
<ul>
<li><a href="https://docs.ceph.com/docs/master/rados/api/librados-intro/" target="_blank" rel="external">get libs</a></li>
</ul>
<h4 id="configure-a-cluster-handling"><a href="#configure-a-cluster-handling" class="headerlink" title="configure a cluster handling"></a>configure a cluster handling</h4><ul>
<li>the client app must invoke <code>librados</code> and connected to a Ceph Monitor</li>
<li>librados retrieves the cluster map </li>
<li>when the client app wants to read or write data, it creates an I/O context and bind to a pool</li>
<li>with the I/O context, the client provides the object name to <code>librados</code>, for locating the data. </li>
<li>then the client application can read or write data</li>
</ul>
<p>Thus, the first steps in using the cluster from your app are to 1) create a cluster handle that your app will use to connect to the storage cluster, and then 2) use that handle to connect. To connect to the cluster, the app must supply a monitor address, a username and an authentication key (cephx is enabled by defaul</p>
<p>an easy way, in Ceph configuration file:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[global]</div><div class="line">mon host = 192.168.0.1</div><div class="line">keyring = /etc/ceph/ceph.client.admin.keyring</div></pre></td></tr></table></figure>
<p><img src="https://docs.ceph.com/docs/master/_images/ditaa-bd1070de50515485f116a874684956bc7e26c664.png" alt="image"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> rados</div><div class="line"></div><div class="line"><span class="keyword">try</span>:</div><div class="line">        cluster = rados.Rados(conffile=<span class="string">''</span>)</div><div class="line"><span class="keyword">except</span> TypeError <span class="keyword">as</span> e:</div><div class="line">        <span class="keyword">print</span> <span class="string">'Argument validation error: '</span>, e</div><div class="line">        <span class="keyword">raise</span> e</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"Created cluster handle."</span></div><div class="line"></div><div class="line"><span class="keyword">try</span>:</div><div class="line">        cluster.connect()</div><div class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">        <span class="keyword">print</span> <span class="string">"connection error: "</span>, e</div><div class="line">        <span class="keyword">raise</span> e</div><div class="line"><span class="keyword">finally</span>:</div><div class="line">        <span class="keyword">print</span> <span class="string">"Connected to the cluster."</span></div></pre></td></tr></table></figure>
<p>python api, has default <code>admin</code> as id, <code>ceph</code> as cluster name, and <code>ceph.conf</code> as confffile value</p>
<h4 id="creating-an-I-O-context"><a href="#creating-an-I-O-context" class="headerlink" title="creating an I/O context"></a>creating an I/O context</h4><p>RADOS enables you to interact both synchronously and asynchronously. Once your app has an I/O Context, read/write operations only require you to know the object/xattr name. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">print</span> <span class="string">"\n\nI/O Context and Object Operations"</span></div><div class="line"><span class="keyword">print</span> <span class="string">"================================="</span></div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"\nCreating a context for the 'data' pool"</span></div><div class="line"><span class="keyword">if</span> <span class="keyword">not</span> cluster.pool_exists(<span class="string">'data'</span>):</div><div class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">'No data pool exists'</span>)</div><div class="line">ioctx = cluster.open_ioctx(<span class="string">'data'</span>)</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"\nWriting object 'hw' with contents 'Hello World!' to pool 'data'."</span></div><div class="line">ioctx.write(<span class="string">"hw"</span>, <span class="string">"Hello World!"</span>)</div><div class="line"><span class="keyword">print</span> <span class="string">"Writing XATTR 'lang' with value 'en_US' to object 'hw'"</span></div><div class="line">ioctx.set_xattr(<span class="string">"hw"</span>, <span class="string">"lang"</span>, <span class="string">"en_US"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"\nWriting object 'bm' with contents 'Bonjour tout le monde!' to pool 'data'."</span></div><div class="line">ioctx.write(<span class="string">"bm"</span>, <span class="string">"Bonjour tout le monde!"</span>)</div><div class="line"><span class="keyword">print</span> <span class="string">"Writing XATTR 'lang' with value 'fr_FR' to object 'bm'"</span></div><div class="line">ioctx.set_xattr(<span class="string">"bm"</span>, <span class="string">"lang"</span>, <span class="string">"fr_FR"</span>)</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"\nContents of object 'hw'\n------------------------"</span></div><div class="line"><span class="keyword">print</span> ioctx.read(<span class="string">"hw"</span>)</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"\n\nGetting XATTR 'lang' from object 'hw'"</span></div><div class="line"><span class="keyword">print</span> ioctx.get_xattr(<span class="string">"hw"</span>, <span class="string">"lang"</span>)</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"\nContents of object 'bm'\n------------------------"</span></div><div class="line"><span class="keyword">print</span> ioctx.read(<span class="string">"bm"</span>)</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"Getting XATTR 'lang' from object 'bm'"</span></div><div class="line"><span class="keyword">print</span> ioctx.get_xattr(<span class="string">"bm"</span>, <span class="string">"lang"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"\nRemoving object 'hw'"</span></div><div class="line">ioctx.remove_object(<span class="string">"hw"</span>)</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"Removing object 'bm'"</span></div><div class="line">ioctx.remove_object(<span class="string">"bm"</span>)</div></pre></td></tr></table></figure>
<h4 id="closing-sessions"><a href="#closing-sessions" class="headerlink" title="closing sessions"></a>closing sessions</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">print</span> <span class="string">"\nClosing the connection."</span></div><div class="line">ioctx.close()</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"Shutting down the handle."</span></div><div class="line">cluster.shutdown()</div></pre></td></tr></table></figure>
<h3 id="librados-in-Python"><a href="#librados-in-Python" class="headerlink" title="librados in Python"></a><a href="https://docs.ceph.com/docs/master/rados/api/python/" target="_blank" rel="external">librados in Python</a></h3><h4 id="data-level-operations"><a href="#data-level-operations" class="headerlink" title="data level operations"></a>data level operations</h4><ul>
<li>configure a cluster handle</li>
</ul>
<p>To connect to the Ceph Storage Cluster, your application needs to know where to find the Ceph Monitor. Provide this information to your application by specifying the path to your Ceph configuration file, which contains the location of the initial Ceph monitors.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> rados, sys</div><div class="line">cluster = rados.Rados(conffile=<span class="string">'ceph.conf'</span>)</div></pre></td></tr></table></figure>
<ul>
<li>connect to the cluster </li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">cluster.connect()</div><div class="line"><span class="keyword">print</span> <span class="string">"\nCluster ID: "</span> + cluster.get_fsid()</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"\n\nCluster Statistics"</span></div><div class="line"><span class="keyword">print</span> <span class="string">"=================="</span></div><div class="line">cluster_stats = cluster.get_cluster_stats()</div><div class="line"></div><div class="line"><span class="keyword">for</span> key, value <span class="keyword">in</span> cluster_stats.iteritems():</div><div class="line">        <span class="keyword">print</span> key, value</div></pre></td></tr></table></figure>
<ul>
<li>manage pools </li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">cluster.create_pool(<span class="string">'test'</span>)</div><div class="line">pools = cluster.list_pools()</div><div class="line"><span class="keyword">for</span> pool <span class="keyword">in</span> pools:</div><div class="line">        <span class="keyword">print</span> pool</div><div class="line">cluster.delete_pool(<span class="string">'test'</span>)</div></pre></td></tr></table></figure>
<ul>
<li>I/O context </li>
</ul>
<p>to read from or write to Ceph Storage cluster, requires ioctx.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ioctx = cluster.open_ioctx($ioctx_name)</div><div class="line"><span class="comment">#</span></div><div class="line">ioctx = cluster.open_ioctx2($pool_id)</div></pre></td></tr></table></figure>
<p><code>ioctx_name</code> is the name of the pool, <code>pool_id</code> is the ID of the pool</p>
<ul>
<li>read, write, remove objects </li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ioctx.write_full(<span class="string">"hw"</span>, <span class="string">"hello"</span>)</div><div class="line">ioctx.read(<span class="string">"hw"</span>)</div><div class="line">ioctx.remove_object(<span class="string">"hw"</span>)</div></pre></td></tr></table></figure>
<ul>
<li>with extended attris</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">ioctx.set_xattr(<span class="string">"hw"</span>, <span class="string">"lang"</span> <span class="string">"en_US"</span>)</div><div class="line">ioctx.get_xattr(<span class="string">"hw"</span>, <span class="string">"lang"</span>)</div><div class="line"></div><div class="line">``` </div><div class="line"></div><div class="line">* list objs </div><div class="line"></div><div class="line">```python </div><div class="line"></div><div class="line">obj_itr = ioctx.list_objects()</div><div class="line"></div><div class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">	<span class="keyword">try</span>:</div><div class="line">		rados_obj = obj_itr.next()</div><div class="line">		print(rados_obj.read())</div></pre></td></tr></table></figure>
<h4 id="RADOS-S3-api"><a href="#RADOS-S3-api" class="headerlink" title="RADOS S3 api"></a>RADOS S3 api</h4><p>Ceph supports <a href="https://docs.ceph.com/docs/dumpling/radosgw/s3/" target="_blank" rel="external">RESTful API</a> that is compatible with basic data access model of Amazon S3 api.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">PUT /&#123;bucket&#125;/&#123;object&#125; HTTP/1.1</div><div class="line">DELETE /&#123;bucket&#125;/&#123;object&#125; HTTP/1.1</div><div class="line">GET /&#123;bucket&#125;/&#123;object&#125; HTTP/1.1</div><div class="line">HEAD /&#123;bucket&#125;/&#123;object&#125; HTTP/1.1  //get object info </div><div class="line">GET /&#123;bucket&#125;/&#123;object&#125;?acl HTTP/1.1</div></pre></td></tr></table></figure>
<h2 id="Amazon-S3"><a href="#Amazon-S3" class="headerlink" title="Amazon S3"></a>Amazon S3</h2><p>Simple Storage Serivce(s3) is used as file/object storage system to store and share files across Internet. it can store any type of objects, with simple key-value. elastic computing cluster(ec2) is Amazon’s computing service. there are three class in S3: servivce, bucket, object.</p>
<p>there are two ways to access S3, through SDK(boto), or raw  Restful API(GET, PUT). the following is SDK way.</p>
<h4 id="create-a-bucket"><a href="#create-a-bucket" class="headerlink" title="create a bucket"></a>create a bucket</h4><p>Put(), Get(), return all objects in the bucket. <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/s3-example-creating-buckets.html" target="_blank" rel="external">Bucket</a> is a storage location to hold files(objects). </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_bucket</span><span class="params">(bucket_name, region=None)</span>:</span></div><div class="line">	<span class="keyword">try</span>:</div><div class="line">		<span class="keyword">if</span> region <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">			s3_client = boto3.client(<span class="string">'s3'</span>)</div><div class="line">			s3.client.create_bucket(Bucket=bucket_name)</div><div class="line">		<span class="keyword">else</span>:</div><div class="line">            s3_client = boto3.client(<span class="string">'s3'</span>, region_name=region)</div><div class="line">            location = &#123;<span class="string">'LocationConstraint'</span>: region&#125;</div><div class="line">            s3_client.create_bucket(Bucket=bucket_name,</div><div class="line">            CreateBucketConfiguration=location)</div><div class="line">    <span class="keyword">except</span> ClientError <span class="keyword">as</span> e:</div><div class="line">        logging.error(e)</div><div class="line">        <span class="keyword">return</span> <span class="keyword">False</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">True</span>			</div><div class="line"></div><div class="line">response = s3_client.list_buckets()</div><div class="line"><span class="keyword">for</span> bucket <span class="keyword">in</span> response[<span class="string">'Buckets'</span>]:</div><div class="line">	<span class="keyword">print</span> bucket</div></pre></td></tr></table></figure>
<h4 id="upload-files"><a href="#upload-files" class="headerlink" title="upload files"></a>upload files</h4><p>basically to <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/s3-uploading-files.html" target="_blank" rel="external">upload a file</a> to an S3 bucket. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_file</span><span class="params">(file_name, bucket, object_name=None)</span>:</span></div><div class="line">    <span class="keyword">if</span> object_name <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">        object_name = file_name</div><div class="line"></div><div class="line">    <span class="comment"># Upload the file</span></div><div class="line">    s3_client = boto3.client(<span class="string">'s3'</span>)</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        response = s3_client.upload_file(file_name, bucket, object_name)</div><div class="line">    <span class="keyword">except</span> ClientError <span class="keyword">as</span> e:</div><div class="line">        logging.error(e)</div><div class="line">        <span class="keyword">return</span> <span class="keyword">False</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">True</span></div></pre></td></tr></table></figure>
<p><code>upload_file()</code> handles large files by splitting them into smaller chunks and uploading each chunk in parallel. which is same logic as ceph to hide the lower-level detail of data splitting and transfering.</p>
<p><code>upload_fileobj()</code> accepts a readable file-like object, which should be openedin bin mode, not text mode:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">s3 = boto3.client(<span class="string">'s3'</span>)</div><div class="line"><span class="keyword">with</span> open(<span class="string">"FILE_NAME"</span>, <span class="string">"rb"</span>) <span class="keyword">as</span> f:</div><div class="line">    s3.upload_fileobj(f, <span class="string">"BUCKET_NAME"</span>, <span class="string">"OBJECT_NAME"</span>)</div></pre></td></tr></table></figure>
<p>all <code>Client</code>, <code>Bucket</code> and <code>Object</code> have these two methods. </p>
<h4 id="download-files"><a href="#download-files" class="headerlink" title="download files"></a>download files</h4><p><a href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/s3-example-download-file.html" target="_blank" rel="external">download_file()</a> a pair of upload files method, which accepts the names of bucket and object to download, and the filename to save the downloaded file to.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">s3 = boto3.client(<span class="string">'s3'</span>)</div><div class="line">s3.download_file(<span class="string">'BUCKET_NAME'</span>, <span class="string">'OBJECT_NAME'</span>, <span class="string">'FILE_NAME'</span>)</div></pre></td></tr></table></figure>
<p>same as upload file, there is a read-only open method: <code>download_fileobj()</code>.</p>
<h4 id="bucket-policy"><a href="#bucket-policy" class="headerlink" title="bucket policy"></a>bucket policy</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">s3 = boto3.client(<span class="string">'s3'</span>)</div><div class="line">result = s3.get_bucket_policy(Bucket=<span class="string">'BUCKET_NAME'</span>)</div><div class="line">bucket_policy = json.dumps(bucket_policy)</div><div class="line">s3.put_bucket_policy(Bucket=bucket_name, Policy=bucket_policy)</div><div class="line">s3.delete_bucket_policy(Bucket=<span class="string">'BUCKET_NAME'</span>)</div><div class="line">control_list = s3.get_bucket_acl(Bucket=<span class="string">'BUCKEET_NAME'</span>)</div></pre></td></tr></table></figure>
<h4 id="get-objects"><a href="#get-objects" class="headerlink" title="get objects"></a>get objects</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">obj_list = s3.list_objects(Bucket=<span class="string">'bucket_name'</span>)</div><div class="line">obj_cont = s3.get_object(Bucket=<span class="string">'bucket_name'</span>, Key=<span class="string">'file_key'</span>)</div></pre></td></tr></table></figure>
<p>error: botocore.errorfactory.NoSuchKey: An error occurred (NoSuchKey) when calling the GetObject operation: Unknown</p>
<h4 id="read-objects-through-url-restful-api"><a href="#read-objects-through-url-restful-api" class="headerlink" title="read objects through url (restful api)"></a>read objects through url (restful api)</h4><p>through url path to get a file/object: <code>https://&lt;bucket-name&gt;.s3.amazonaws.com/&lt;key&gt;</code></p>
<h4 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h4><p><a href="https://docs.ceph.com/docs/master/start/intro/" target="_blank" rel="external">ceph official doc</a></p>
<p><a href="https://botocore.amazonaws.com/v1/documentation/api/latest/index.html" target="_blank" rel="external">botocore official doc</a></p>
<p><a href="https://github.com/boto/boto3" target="_blank" rel="external">boto3 github</a></p>
<p><a href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/s3-examples.html" target="_blank" rel="external">amazon S3 example</a></p>
<p><a href="https://www.howtoforge.com/how-to-create-an-s3-bucket-object-storage-on-amazon-aws/" target="_blank" rel="external">GUI: create an S3 bucket and store objects in AWS</a></p>
<p><a href="https://www.cnblogs.com/junneyang/p/5980286.html" target="_blank" rel="external">boto API access S3 object</a></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/aws/" rel="tag"># aws</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/02/27/from-HPC-to-cloud-2/" rel="next" title="from HPC to cloud (2) - distributed storage intro">
                <i class="fa fa-chevron-left"></i> from HPC to cloud (2) - distributed storage intro
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/03/03/boto3-streamingBody-to-BytesIO/" rel="prev" title="boto3 streamingBody to BytesIO">
                boto3 streamingBody to BytesIO <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="David Z.J. Lee" />
          <p class="site-author-name" itemprop="name">David Z.J. Lee</p>
           
              <p class="site-description motion-element" itemprop="description">what I don't know</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">180</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">48</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/ZJLi2013" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.linkedin.com/in/zhengjia13/" target="_blank" title="LinkedIn">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  LinkedIn
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#ceph-intro"><span class="nav-number">1.</span> <span class="nav-text">ceph intro</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ceph-storage-cluster"><span class="nav-number">1.1.</span> <span class="nav-text">ceph storage cluster</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Librados-APIs-workflow"><span class="nav-number">1.2.</span> <span class="nav-text">Librados APIs workflow</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#configure-a-cluster-handling"><span class="nav-number">1.2.1.</span> <span class="nav-text">configure a cluster handling</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#creating-an-I-O-context"><span class="nav-number">1.2.2.</span> <span class="nav-text">creating an I/O context</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#closing-sessions"><span class="nav-number">1.2.3.</span> <span class="nav-text">closing sessions</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#librados-in-Python"><span class="nav-number">1.3.</span> <span class="nav-text">librados in Python</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#data-level-operations"><span class="nav-number">1.3.1.</span> <span class="nav-text">data level operations</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RADOS-S3-api"><span class="nav-number">1.3.2.</span> <span class="nav-text">RADOS S3 api</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Amazon-S3"><span class="nav-number">2.</span> <span class="nav-text">Amazon S3</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#create-a-bucket"><span class="nav-number">2.0.1.</span> <span class="nav-text">create a bucket</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#upload-files"><span class="nav-number">2.0.2.</span> <span class="nav-text">upload files</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#download-files"><span class="nav-number">2.0.3.</span> <span class="nav-text">download files</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#bucket-policy"><span class="nav-number">2.0.4.</span> <span class="nav-text">bucket policy</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#get-objects"><span class="nav-number">2.0.5.</span> <span class="nav-text">get objects</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#read-objects-through-url-restful-api"><span class="nav-number">2.0.6.</span> <span class="nav-text">read objects through url (restful api)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#refer"><span class="nav-number">2.0.7.</span> <span class="nav-text">refer</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">David Z.J. Lee</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://zjlee.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://yoursite.com/2020/02/28/ceph-boto3-intro/';
          this.page.identifier = '2020/02/28/ceph-boto3-intro/';
          this.page.title = 'ceph & boto3 introduction';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://zjlee.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
