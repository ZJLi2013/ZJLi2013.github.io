<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="what I don&apos;t know">
<meta property="og:type" content="website">
<meta property="og:title" content="Serious Autonomous Vehicles">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Serious Autonomous Vehicles">
<meta property="og:description" content="what I don&apos;t know">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Serious Autonomous Vehicles">
<meta name="twitter:description" content="what I don&apos;t know">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>Serious Autonomous Vehicles</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Serious Autonomous Vehicles</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/03/where-are-you-in-next-4-years-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/03/where-are-you-in-next-4-years-1/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-12-03T09:26:09-05:00">
                2019-12-03
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/12/03/where-are-you-in-next-4-years-1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/12/03/where-are-you-in-next-4-years-1/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>title: where are you in next 4 years 1<br>date: 2019-12-03 09:23:03</p>
<h2 id="tags"><a href="#tags" class="headerlink" title="tags:"></a>tags:</h2><p>it’s more than one year since I started this series “where are you in the next 5 years”, I wound love to transfer to “the next 4 years”, and thanks for the opportunity to get back in China, so there is a high chance to involve in the market heavily in a short time. </p>
<p>at the begining of the year, travelled around the whole nation, stay in Shanghai, Beijing, Shenzhen, Guangzhong. and that was a great chance to get familiar with the startups in autonomus vehicle, as this trip really gave me some input, and till now I had another half year in one of the top OEMs in China. combined with this two sources, which gave me the kind of the whole picture of ADS market happening in China. I would love to write this blog more in bussiness thought, rather than engineering way.  </p>
<h2 id="L4-startups"><a href="#L4-startups" class="headerlink" title="L4 startups"></a>L4 startups</h2><p>ADS leap time is about 2016 to the first half year of 2018. there are a bunch of startups and also most OEMs have build their ADS teams.</p>
<p>the startups, e.g. Pony.ai, WeRide, AutoX, roadstar(the new split), ToSimple, Momenta. which are still very active recently. </p>
<p>Today I have taken PlusAI’s tech open day, I have to say, most of these startups have very similar tech roadmap. I personally, think that’s a really sad thing. </p>
<p>a few teches they all have: </p>
<ul>
<li><p>simulation pipeline </p>
</li>
<li><p>data pipeline(collect, label, training)  </p>
</li>
<li><p>AI based perception, motion planning</p>
</li>
<li><p>friendly HMI </p>
</li>
</ul>
<p>WeRide and Pony.ai are in <code>Robtaxi service</code>;  ToSimple and PlusAI are in <code>highway logistics</code>;  Momenta is in <code>harbor transformation</code>.</p>
<p>Alibaba, jingdong, Meituan e.t.c are in small personal package delivery shuttles, similar as Nuro.</p>
<p>OEMs focus in the passenger vehicles.</p>
<p>DiDi focus in taxi services as well, similar as Uber, Waymo.</p>
<p>all of them can be called as ADS service suppliers. however, most of them use the exactly same sensor packages, including Lidar, Camera, Radar, GPS e.t.c. the software stacks during prodcut dev as mentioned above are mostly similar; there maybe a few special features during the services in deployment, e.g. Robtaxi may have a Uber-like call-taxi app e.t.c, Rather than that, nothing really is amazing about ADS itself.</p>
<p>and mostly this is not a tech problem, it’s must be defined or find out by the social guys, who are from the real needs. </p>
<p>in the engineering work environment, it’s easily to misunderstand the role of engineering. engineering is the bumper, only when the house need fixed, there is a need for bumper. However, in an engineering-centered env, it’s so easy to tell no difference between I have the bumper and I have the needs. My experieince till now, I am learning how to use the bumper well, but few thinks why need to learn to use the bumper.</p>
<p>on the other hand, what kind of tech is really helpful or profitable? </p>
<p>by chance, to talk with Unity China team, who are enhancing Unity3D engine with cloud support, <a href="https://unity.com/simulation" target="_blank" rel="external">unity simualtion</a>, which is the feature I am looking for a while. if the tech pipeline is the waterflow, the Unity team is the one standing at the upper flow, who can implement new features in engine. </p>
<p>just like Nvidia, Google e.t.c, these are the guys who really make a difference with their tech. and it’s profitable of course.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/29/recent-thoughts-in-ADS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/29/recent-thoughts-in-ADS/" itemprop="url">recent thoughts in ADS</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-11-29T08:56:20-05:00">
                2019-11-29
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/11/29/recent-thoughts-in-ADS/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/11/29/recent-thoughts-in-ADS/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>the following are some pieces of ideas during  discussion and online resources.</p>
<h2 id="system-engineering-in-practical"><a href="#system-engineering-in-practical" class="headerlink" title="system engineering in practical"></a>system engineering in practical</h2><p>the following idea is coming from the expert of system engineering. </p>
<p>originally, system engineering or model based design sounds come from aerospace, defense department. the feature of these products: </p>
<p>1) they are the most complex system</p>
<p>2) they are sponsored by the goverment</p>
<p>3) they are unique and no competitors</p>
<p>which means they don’t need worry about money and time, so to gurantee the product finally works, they can design from top to down in a long time. </p>
<p>the degrade order of requirements level comes as:</p>
<p>areospace, defense product &gt;&gt;  vehicle level product &gt;&gt;  industry level product &gt;&gt; customer level product</p>
<p>usually the techs used in the top level is gradually degrading into the next lower level in years. e.g. GPS, Internet, autonomous e.t.c. at the same time, the metholodies from top level go to lower level as well. </p>
<p>I suppose that’s why system engineeering design comes to vehicle industry. however, does it really work in this competitional industry?  I got the first experince when running scenaio testes in simulation SIL. as the system engineering team define the test cases/scenarios, e.g. 400 test scenarios; on the other hand, the vehicle test team does the road test a few times every week.the result is, most time the 400 test scenarios never catch a system failure; but most road test failure scenario does can be repeated in the simulation env.</p>
<p>system engineering based design doesn’t fit well. there are a lot reasons. at first, traditionally the design lifetime of a new vehicle model is about 3~5 years, and startup EV companies recently has even shorter design life cycle, about 1~2 years. so a top-down design at the early time, to cover every aspect of a new model, does almost not make sense. in the V development model, most fresh engineers thought the top-down design is done once for all, the reality is most early stage system engineering desgin need be reconstructured. </p>
<p>secondly, system engineering design usually is abstract and high beyond and except engineering considerations, as the system engineers mostly doesn’t have engineering experience in most sections of the sysetem. which results in the system engineering based requirements are not testable, can’t measure during section implementation.</p>
<p>there are a few suggestions to set a workable system engineering process: </p>
<p>the system engineering team should sit by the develop teams and test teams, they should have a lot of communication, and balance the high-level requirements and also testable, measurable, implementable requirements. basically, system engineering design should have product/component developers as input.</p>
<p>both the system engineers and developers should understand the whole V model, including system requirements, component requirements are iteratable.</p>
<p>focus on the special requirement, and not always start from the top, each special requirement is like a point, and all these existing points(already finished requirements) will merged to the whole picture finally.</p>
<p>take an example, during the road test, there will come a new requirement to have a HMI visulization,  then focus on this HMI requirement, cause this requirements may not exist in the top down design. but it is the actual need.</p>
<h2 id="system-test-and-verification-CI-CD"><a href="#system-test-and-verification-CI-CD" class="headerlink" title="system test and verification CI/CD"></a>system test and verification CI/CD</h2><p>as most OEMs have said they will massive product L3 ADS around 2022, it is the time to jump into the ADS system test and verification. just knew that Nvidia has the full-stack hardware lines: the AI chips in car(e.g. Xavier), the AI training workstation(e.g. DGX), and the ADS system verifcation platform(e.g. Constallation box).</p>
<h4 id="data-needs"><a href="#data-needs" class="headerlink" title="data needs"></a>data needs</h4><p>the ADS development depends a lot on data infrastructure:</p>
<pre><code>data collect --&gt; data storage --&gt; data analysis
</code></pre><p>there are many small pieces as well, e.g. data cleaning, labeling, training, mining, visulization e.t.c</p>
<p>from different dev stage or teams, there are different focus. </p>
<ul>
<li><p>road test/sensor team, they need a lot of online vehicle status/sensor data check, data logging, visulization(dev HMI), as well as offline data analysis and storage </p>
</li>
<li><p>perception team, need a lot of raw image/radar data, used to train, mine, as well as to query and store.</p>
</li>
<li><p>planning/control team, need high quality data to test algorithms as well as a good structured in-car computer.</p>
</li>
<li><p>HMI team, are focusing on friendly data display </p>
</li>
<li><p>fleet operation team, need think about how to transfer data in cloud, vehicle, OEM data centers e.t.c.</p>
</li>
</ul>
<p>sooner or later, data pipepline built up is a have to choice.</p>
<h4 id="data-collection-vendors"><a href="#data-collection-vendors" class="headerlink" title="data collection vendors"></a>data collection vendors</h4><p>road test data collection equipment used in ADS development, is actually not a very big market, compared to in-var computers. but still there are a few vendors already. </p>
<ul>
<li>the top chip OEMs, e.g.  Nvidia, Intel has these products.</li>
<li>chip poxy, e.g.  Inspire </li>
<li>traditional vehicle test vendors, e.g. Dspace, Vector, Prescan</li>
<li>startups, e.g. horizon </li>
</ul>
<h4 id="Nvidia-constellation"><a href="#Nvidia-constellation" class="headerlink" title="Nvidia constellation"></a>Nvidia constellation</h4><p>ADS system test usually includes simulation test and road test. and the road test is also called vehicle-in-loop, which is highly expensive and not easy to repeat; then is hardware-in-loop(HIL) test, basically including only the domain controller/ECU in test loop; finally is the  is software-in-loop(SIL) test, which is most controllable but also not that reliable.</p>
<p>in practical, it’s not easy to build up a closed-loop verification(CI/CD) process from SIL to HIL to road test. and once CI/CD is setted up, the whole team can be turned into data/simulation/test driven.  </p>
<p>the difficult and hidden part is the supporting toolchain development. Most vehicle test vendors have their special full-stack solution toolchains, but most of them are too eco-customized, it’s really difficult for ADS team, specially OEMs, to follow a speical vendor solution.</p>
<p>another reason, test vehicles include components from different vendors, e.g. camera from sony, radar from bosch, Lidar from a Chinese startup, logging equipment from dSpace, and ECUs from Conti. which makes it difficult to fit this mixed system into a Vector verification platform. </p>
<p>Nvidia Constallation is trying to meet the gap from SIL, HIL to road test. as it can suppport most customized ECUs.</p>
<ul>
<li><p>from road test to HIL, it use the exactly same chip. </p>
</li>
<li><p>for road test resimulation,  Nvidia offer a sim env, and the road test log can feed in directly</p>
</li>
</ul>
<p>the ability to do resimulation of road test is a big step, the input is directly scanned images/cloud points, even lgsvl, Carla has no such direct support. but resimulation is really useful for CI/CD. Nvidia constallation as said, is the solution from captured data to KPIs.</p>
<p>another big thing is about their high-level scenario description language(HLSDL), which I think is more abstract than OpenScenario. the HLSDL engine use hyper-parameters, SOTIF embedded scenario idea, and optimized scenario generator, which should be massive, random as well as KPI significantly, it should be a good scenario engine if it has these features. </p>
<h2 id="Bosch-VMS"><a href="#Bosch-VMS" class="headerlink" title="Bosch VMS"></a>Bosch VMS</h2><p>vehicle management system(VMS) is cloud nature framework from Bosch, which is used to meet the similar requirements as Nvidia’s solution, to bring the closed-loop(CI/CD) from road test data collection, data anlaysis to fleet management. they have a few applications based on VMS:</p>
<ul>
<li>fleet batteries management(FBM)</li>
</ul>
<p>for single vehicle’s diaglostic, prediction; and for the EV market, FBM can be used as certification for second-hand EV dealers</p>
<ul>
<li>road coefficient system(RCS)</li>
</ul>
<p>Bosch has both in-vehicle data collection box and cloud server, RCS will be taken as additional sensor for ADS in prodcut</p>
<ul>
<li>VMS in itself</li>
</ul>
<p>Bosch would like to think VMS as the PLM for ADS, from design, test, to deployment. and it shoul be easy to integrate many dev tools, e.g. labeling, simulation e.t.c</p>
<h2 id="what-about-safety"><a href="#what-about-safety" class="headerlink" title="what about safety"></a>what about safety</h2><p>as mentioned previously, 80% of Tesla FSD is to handle AI computing, Nvidia Xavier has about 50% GPU; Mobileye has very limited support for AI. all right, Tesla is most AI aggressive, then Nvidia, then Mobileye is most conserved. which make OEMs take Mobileye solution as more safety, but AI does better performance in perception, so how to balance these two ways? </p>
<p>I realized the greats of Mobileye’s new concept: <code>responsibility sensitive safety</code>(RSS), RSS can be used as the ADS safety boundary, but inside either AI or CV make the house power. a lot of AI research on mixed traditional algorithms with AI algorithms, RSS sounds the good solution. would be nice to build a general <code>RSS Mixing AI</code>(RMA) framework.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/29/X11-GUI-in-docker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/29/X11-GUI-in-docker/" itemprop="url">X11 GUI in docker</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-11-29T08:43:13-05:00">
                2019-11-29
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/11/29/X11-GUI-in-docker/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/11/29/X11-GUI-in-docker/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Xorg"><a href="#Xorg" class="headerlink" title="Xorg"></a>Xorg</h2><p>Xorg is client-server architecture, including Xprotocol, Xclient, Xserver. Linux itself has no graphics interface, all GUI apps in Linux is based on X protcol.</p>
<p>Xserver used to manage the Display device, e.g. monitor, Xserver is responsible for displaying, and send the device input(e.g. keyboard click) to Xclient.</p>
<p>Xclient, or X app, which includes grahics libs, e.g. OpenGL, Vulkan e.t.c</p>
<h4 id="xauthority"><a href="#xauthority" class="headerlink" title="xauthority"></a>xauthority</h4><p>Xauthority file can be found in each user home directory and is used to store credentials in cookies used by xauth for authentication of X sessions. Once an X session is started, the cookie is used to authenticate connections to that specific display. You can find more info on X authentication and X authority in the xauth man pages (type man xauth in a terminal). if you are not the owner of this file you can’t login since you can’t store your credentials there.</p>
<p>when <code>Xorg</code> starts, <code>.Xauthority</code> file is send to Xorg, review this file by <code>xauth -f ~/.Xauthority</code> </p>
<p>ubuntu@ubuntu:~$ xauth -f ~/.Xauthority<br>Using authority file /home/wubantu/.Xauthority<br>xauth&gt; list<br>ubuntu/unix:1  MIT-MAGIC-COOKIE-1  ee227cb9465ac073a072b9d263b4954e<br>ubuntu/unix:0  MIT-MAGIC-COOKIE-1  71cdd2303de2ef9cf7abc91714bbb417<br>ubuntu/unix:10  MIT-MAGIC-COOKIE-1  7541848bd4e0ce920277cb0bb2842828</p>
<p><code>Xserver</code> is the host who will used to display/render graphics, and the other host is <code>Xclient</code>. if Xclient is from remote host, then need configure $DISPLAY in <code>Xserver</code>. To display X11 on remote Xserver,  need to copy the .Xauthority from Xserver to Xclient machine, and export $DISPLAY and $XAUTHORITY</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">export DISPLAY=&#123;Display number stored in the Xauthority file&#125;</div><div class="line">export XAUTHORITY=&#123;the file path of .Xauthority&#125;</div></pre></td></tr></table></figure>
<h4 id="xhost"><a href="#xhost" class="headerlink" title="xhost"></a>xhost</h4><p><a href="https://www.linuxidc.com/Linux/2012-11/74874.htm" target="_blank" rel="external">Xhost</a> is used to grant access to Xserver (on your local host), by default, the local client can access the local Xserer, but any remote client need get granted first through Xhost. taking an example, when ssh from hostA to hostB, and run <code>glxgears</code> in this ssh shel. for grahics/GPU resources,  hostA is used to display, so hostA is the Xserver.</p>
<h4 id="x11-forwarding"><a href="#x11-forwarding" class="headerlink" title="x11 forwarding"></a>x11 forwarding</h4><p>when Xserver and Xclient are in the same host machine, nothing big deal. but Xserver, Xclient can totally be on different machines, as well as Xprotocol communication between them. this is how SSH -X helps to run the app in Xclient, and display in Xserver, which needs <code>X11 Forwarding</code>.</p>
<p><img src="http://www.ipaomi.com/wp-content/uploads/2017/11/x_server_client_remote.gif" alt="image"></p>
<h4 id="test-benchmark"><a href="#test-benchmark" class="headerlink" title="test benchmark"></a>test benchmark</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ssh 192.16.0.13</div><div class="line">xeyes</div></pre></td></tr></table></figure>
<h4 id="tmp-X11-unix"><a href="#tmp-X11-unix" class="headerlink" title="/tmp/.X11-unix"></a>/tmp/.X11-unix</h4><p>the X11(xorg) server communicates with client via some kind of reliable stream of bytes. </p>
<p>A Unix-domain socket is like the more familiar TCP ones, except that instead of connecting to an address and port, you connect to a path. You use an actual file (a socket file) to connect.</p>
<pre><code>srwxrwxrwx 1 root root 0 Nov 26 08:49 X0
</code></pre><p>the <code>s</code> in front of the permissions, which means its a socket. If you have multiple X servers running, you’ll have more than one file there.</p>
<p>is where X server put listening AF_DOMAIN sockets. </p>
<h4 id="DISPLAY-device"><a href="#DISPLAY-device" class="headerlink" title="DISPLAY device"></a>DISPLAY device</h4><p>DISPLAY format: <strong>hostname: displaynumber.screennumber</strong></p>
<p>hostname is the hostname or hostname IP of Xserver</p>
<p>displaynumber starting from 0<br>screennumber starting from 0</p>
<p>when using TCP(x11-unix protocol only works when Xclient and Xserver are in the same machine), displaynumber is the connection port number minus 6000; so if displaynumber is 0, namely the port is 6000. <code>DISPLAY</code> refers to a display device, and all graphics will be displayed on this device.<br>by deafult,  Xserver localhost doesn’t listen on TCP port. run: <code>sudo netstat -lnp | grep &quot;6010&quot;</code>, no return. <a href="https://askubuntu.com/questions/1143831/xserver-listen-on-tcp-ubuntu-19-04" target="_blank" rel="external">how to configure Xserver listen on TCP</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Add DisallowTCP=false under directive [security] in /etc/gdm3/custom.conf file. Now open file /etc/X11/xinit/xserverrc and change exec /usr/bin/X -nolisten tcp to exec /usr/bin/X11/X -listen tcp. Then restart GDM with command sudo systemctl restart gdm3. To verify the status of listen at port 6000, issue command ss -ta | grep -F 6000. Assume that $DISPLAY value is :0.</div></pre></td></tr></table></figure>
<h4 id="virtual-DISPLAY-device"><a href="#virtual-DISPLAY-device" class="headerlink" title="virtual DISPLAY device"></a>virtual DISPLAY device</h4><p><a href="https://bbs.archlinux.org/viewtopic.php?id=180904" target="_blank" rel="external">creating a virtual display/monitor</a><br><a href="https://bbs.archlinux.org/viewtopic.php?id=180904" target="_blank" rel="external">add fake display when no Monitor is plugged in</a></p>
<h2 id="Xserver-broadcast"><a href="#Xserver-broadcast" class="headerlink" title="Xserver broadcast"></a>Xserver broadcast</h2><p>the idea behind is to stand in one manager(Xserver) machine, and send command to a bunch of worker(Xclient) machines. the default way is all Xclient will talk to Xserver, which eat too much GPU and network bandwith resources on manager node. so it’s better that each worker node will do the display on its own. and if there is no monitor on these worker nodes, they can survive with virtual display.</p>
<h4 id="xvfb"><a href="#xvfb" class="headerlink" title="xvfb"></a>xvfb</h4><p><a href="http://manpages.ubuntu.com/manpages/xenial/man1/xvfb-run.1.html" target="_blank" rel="external">xvfb</a> is the virtual Xserver solution, but doesn’t run well(need check more)</p>
<h4 id="nvidia-xconfig"><a href="#nvidia-xconfig" class="headerlink" title="nvidia-xconfig"></a>nvidia-xconfig</h4><p><a href="https://devtalk.nvidia.com/default/topic/585014/how-to-configure-x-server-to-work-headless-as-well-with-any-monitor-connected-/" target="_blank" rel="external">configure X server to work headless as well with any monitor connected</a></p>
<h4 id="unity-headless"><a href="#unity-headless" class="headerlink" title="unity headless"></a>unity headless</h4><h2 id="env-setup"><a href="#env-setup" class="headerlink" title="env setup"></a>env setup</h2><p>to test with docker, vulkan, ssh, usually need the following packages: </p>
<h4 id="vulkan-dev-env"><a href="#vulkan-dev-env" class="headerlink" title="vulkan dev env"></a>vulkan dev env</h4><pre><code>sudo add-apt-repository ppa:graphics-drivers/ppa
sudo apt upgrade
apt-get install libvulkan1 vulkan vulkan-utils 
sudo apt install vulkan-sdk 
</code></pre><h4 id="nvidia-env"><a href="#nvidia-env" class="headerlink" title="nvidia env"></a>nvidia env</h4><pre><code>install nvidia-driver, nvidia-container-runtime
install mesa-utils  #glxgears
</code></pre><h4 id="docker-env"><a href="#docker-env" class="headerlink" title="docker env"></a>docker env</h4><pre><code>install docker 
</code></pre><h2 id="run-glxgear-vkcube-lgsvl-in-docker-through-ssh-tunnel"><a href="#run-glxgear-vkcube-lgsvl-in-docker-through-ssh-tunnel" class="headerlink" title="run glxgear/vkcube/lgsvl in docker through ssh tunnel"></a>run glxgear/vkcube/lgsvl in docker through ssh tunnel</h2><p>there is a very nice blog: <a href="https://dzone.com/articles/docker-x11-client-via-ssh" target="_blank" rel="external">Docker x11 client via SSH</a>, disccussed the arguments passing to the following samples</p>
<h4 id="run-glxgear"><a href="#run-glxgear" class="headerlink" title="run glxgear"></a>run glxgear</h4><p>glxgear is OpenGL benchmark test. </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ssh -X -v abc@192.168.0.13</div><div class="line">sudo docker run --runtime=nvidia -ti --rm -e DISPLAY -v /tmp/.X11-unix:/tmp/.X11-unix -v &quot;$HOME/.Xauthority:/root/.Xauthority&quot; --net=host 192.168.0.10:5000/glxgears</div></pre></td></tr></table></figure>
<p>if seting $DISPLAY=localhost:10.0 , then the gears will display at master node(ubuntu)</p>
<p>if setting $DISPLAY=:0,  then the gears will display at worker node(worker)</p>
<p>and w/o <code>/tmp/.X11-unix</code> it works as well. </p>
<h4 id="run-vkcube"><a href="#run-vkcube" class="headerlink" title="run vkcube"></a>run vkcube</h4><p>vkcube is Vulkan benchmark test.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ssh -X -v abc@192.168.0.13</div><div class="line">export DISPLAY=:0</div><div class="line">sudo docker run --runtime=nvidia -ti --rm -e DISPLAY -v /tmp/.X11-unix:/tmp/.X11-unix -v &quot;$HOME/.Xauthority:/root/.Xauthority&quot; --net=host  192.168.0.10:5000/vkcube</div></pre></td></tr></table></figure>
<p>in this way, vkcube is displayed in worker node(namely, using worker GPU resource), manager node has no burden at all. </p>
<p>if <code>$DISPLAY=localhost:10.0</code>, to run vkcube, give errors:</p>
<pre><code>No protocol specified
Cannot find a compatible Vulkan installable client driver (ICD).
Exiting ...
</code></pre><p>looks vulkan has limitation.</p>
<h4 id="run-lgsvl"><a href="#run-lgsvl" class="headerlink" title="run lgsvl"></a>run lgsvl</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">export DISPLAY=:0</div><div class="line">sudo docker run --runtime=nvidia -ti --rm -p 8080:8080 -e DISPLAY -v /tmp/.X11-unix:/tmp/.X11-unix -v &quot;$HOME/.Xauthority:/root/.Xauthority&quot; --net=host  192.168.0.10:5000/lgsvl  /bin/bash </div><div class="line">./simulator</div></pre></td></tr></table></figure>
<p>works well! the good news as if take the manager node as the end user monitor, and all worker nodes in cloud, without display, then this parameters will be used in <code>docker service create</code> to host in the swarm. so the next step is to vitual display for each worker node.</p>
<h2 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h2><p><a href="https://www.x.org/wiki/XServer/" target="_blank" rel="external">wiki: Xorg/Xserver</a><br><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-xwin/index.html" target="_blank" rel="external">IBM study: Xwindows</a><br><a href="https://www.cnblogs.com/ipaomi/p/7830778.html" target="_blank" rel="external">cnblogs: run GUI in remote server</a><br><a href="https://wiki.ubuntu.com/X/Config" target="_blank" rel="external">xorg.conf in ubuntu</a><br><a href="https://docs.citrix.com/en-us/linux-virtual-delivery-agent/current-release/configuration/configure-xauthority.html" target="_blank" rel="external">configure Xauthority</a><br><a href="https://stackoverflow.com/questions/44429394/x11-forwarding-of-a-gui-app-running-in-docker" target="_blank" rel="external">X11 forwarding of a GUI app running in docker</a><br><a href="https://www.cnblogs.com/kevin-boy/p/3223404.html" target="_blank" rel="external">cnblogs: Linux DISPLAY skills</a><br><a href="https://github.com/NVIDIA/nvidia-docker/issues/631" target="_blank" rel="external">nvidia-runtime-container feature: Vulkan support</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/26/what-about-Tesla/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/26/what-about-Tesla/" itemprop="url">what about Tesla</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-11-26T10:05:01-05:00">
                2019-11-26
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/11/26/what-about-Tesla/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/11/26/what-about-Tesla/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>Tesla is ROCKING the industry</strong>. OTA, camera only, fleet learning, shadow mode, Autopilot, Gega Factory, Cybertruck etc. There is a saying: “看不到，看不懂，追不上(can’t see it; can’t understand it; can’t chase it)”. I have to say most Tesla news are more exciting than news from traditional OEMs. and my best wishes to Tesla to grow greater.  </p>
<h2 id="Tesla-timeline"><a href="#Tesla-timeline" class="headerlink" title="Tesla timeline"></a>Tesla timeline</h2><h4 id="2019"><a href="#2019" class="headerlink" title="2019"></a>2019</h4><ul>
<li><p>release Cybertruck<br><img src="https://i0.wp.com/ramenswag.com/wp-content/uploads/2019/11/4k-tesla-cybertruck-wallpaper.jpg?resize=1060%2C596&amp;ssl=1" alt="image"></p>
</li>
<li><p><a href="https://www.tesla.com/blog/introducing-software-version-10-0" target="_blank" rel="external">Tesla software V10.0</a> OTA: </p>
<ul>
<li>Smart Summon(enable vehicle to navigate a parking lot and come to them or their destination of choice, as long as their car is within their line of sight)</li>
<li>Driving Visualization(HMI)<ul>
<li>Automatic lane change</li>
<li>lane departure avoidance: Autopilot will warn the driver and slow down the vehicle</li>
</ul>
</li>
<li>emergency lane departure avoidance: Autopilot will steer the vehciel back into the driving lane if the off-lane may lead to collision</li>
</ul>
</li>
<li>Model 3 safety reward from IIHS and Euro NCAP</li>
<li>Tesla Insurance</li>
<li>Megapack: battery storage for massive usage</li>
<li>V3 super charging station: more powerful station and pre-heating battery</li>
<li>Powerpack: energy storage system in South Austrilia</li>
<li>Model 3 release (March) and the most customer satisfied vehicles in China</li>
<li>cut-off 7% employees globally(Jan)</li>
</ul>
<h4 id="2018"><a href="#2018" class="headerlink" title="2018"></a>2018</h4><ul>
<li><a href="https://www.tesla.cn/blog/how-track-mode-works" target="_blank" rel="external">race mode Model 3</a></li>
<li>Model 3 the lowest probability of injury by NHTSA: <a href="https://www.tesla.cn/blog/model-3-lowest-probability-injury-any-vehicle-ever-tested-nhtsa" target="_blank" rel="external">what make Model 3 safe</a></li>
<li><a href="https://www.tesla.cn/support/software-v9" target="_blank" rel="external">Tesla V9.0 OTA</a>: <ul>
<li>road status info</li>
<li>climate control</li>
<li>Navigate on Autopilot</li>
<li>Autosteer and Auto lane change combination</li>
<li>blindspot warning(when turn signal in engaged but a vehicle or obstacle is detected in the target lane)</li>
<li>use high occupancy vehicle(HOV) lane</li>
<li>obstacle aware acceleration(if obstacle detected, acc is automatically limited)</li>
<li>Dashcam (record and store video footage) </li>
</ul>
</li>
<li>Tesla privatization (Aug)</li>
</ul>
<h4 id="2017"><a href="#2017" class="headerlink" title="2017"></a>2017</h4><ul>
<li>super charing station 10000 globally</li>
<li>collabration with Panasonic to produce battery at Buffalo, 1Mpw</li>
</ul>
<h4 id="2016"><a href="#2016" class="headerlink" title="2016"></a>2016</h4><ul>
<li>purchase SolarCity</li>
<li>purchase Grohmann Enginering(German): highly automatic manufacture</li>
<li><p><a href="https://www.tesla.cn/blog/all-tesla-cars-being-produced-now-have-full-self-driving-hardware" target="_blank" rel="external">massive product of Tesla vehicles with hardwares to support fully self driving</a>(Oct)<br><img src="https://www.tesla.cn/sites/default/files/images/blogs/ap_2_header.jpg" alt="image"></p>
<ul>
<li>8 cameras to support 360 view, in front 250 meters env detection</li>
<li>12 Ultrasonic </li>
<li>front Radar</li>
<li>ADS HAD (x40 powerful than previous)</li>
<li>ADS algorithm:  deep learning network combine with vision, radar and ultrasonic(AEB, collision warning, lane keeping, ACC is not included yet)</li>
</ul>
</li>
<li>Autopilot 8.0 OTA, or namely <a href="https://www.tesla.cn/blog/upgrading-autopilot-seeing-world-radar" target="_blank" rel="external">“see” the world through Radar</a> </li>
</ul>
<p><img src="https://www.teslarati.com/wp-content/uploads/2016/09/Tesla-v8_0-Autopilot-Multi-Car-Radar.jpg" alt="image"></p>
<ul>
<li><p><a href="https://www.tesla.cn/blog/master-plan-part-deux" target="_blank" rel="external">Tesla’s master plane 2</a></p>
</li>
<li><p>deadly accident across the truck(2016.7)</p>
</li>
<li>HEPA defense “biological weapon”</li>
<li>accept reservation for Model 3(march)</li>
<li>Tesla 7.1.1 OTA:  remote summon </li>
<li><a href="https://www.tesla.cn/blog/特斯拉空中升级7.1系统" target="_blank" rel="external">Tesla 7.1 OTA</a>: <ul>
<li>vertical parking</li>
<li>speed gentelly in living house area</li>
<li>highway ACC, traffic jam following</li>
<li>more road info in HMI, e.t.c truck, bus, motobike </li>
</ul>
</li>
</ul>
<p><img src="https://electrek.co/wp-content/uploads/sites/3/2015/10/press01_autopilot_dash.jpg" alt="image"></p>
<h4 id="2015"><a href="#2015" class="headerlink" title="2015"></a>2015</h4><ul>
<li>Autopilot 7.0 update:<ul>
<li>Autopark(requires driver in the car and only parallel parking)</li>
<li>Autosteer</li>
<li>Auto lane changing</li>
<li>UI refresh</li>
<li>Automatic emergency steering</li>
<li>side collision warning</li>
</ul>
</li>
</ul>
<h2 id="Autopilot-evoluvation"><a href="#Autopilot-evoluvation" class="headerlink" title="Autopilot evoluvation"></a>Autopilot evoluvation</h2><p><a href="https://www.autopilotreview.com/tesla-autopilot-v1-v2-v3-and-beyond-differences/" target="_blank" rel="external">in a nutshell</a>, Autopilot is dynamic cruise control(ACC) + Autosteer + auto lane chang. </p>
<p>Autopilot 7.0 relied primarily on the front-facing camera. radar hasn’t been used primarily in 7.0 was due to false positives(wrong detection). but in 8.0 with <code>fleet learning</code>. 8.0 made radar the main sensor input. </p>
<p>almost entirely eliminate the false positive – the false braking events – and enable the car to initiate braking no matter what the object is as long as it is not large and fluffy </p>
<p>but any large, or metallic or dense, the radar system is able to detect and initiate a braking event. both when Autopilot active or not(then AEB)</p>
<p>even if the vision system doesn’t recognize the object, it actually doesn’t matter what the object is(while vision does need to know what the thing is), it just knows there is somehting dense.</p>
<p><code>fleeting learning</code> will mark the geolocation of where all the false alarm occurs, and what the shape of that object. so Tesla system know at a particular position at a particular street or highway, if you see a radar object of a following shape - don’t worry it’s just a road sign or bridge or a Christmas decoration. basically marking these locations as a list of exceptions. </p>
<p>the radar system can track 2 cars/obstacles ahead and imporove the cut-in , cut-off reponse. so in case the car in front suddenly swerve out of the way of an obstacle. </p>
<p>the limit of hardware is reaching, but there will be still a quite improvement as the software and data would improve quite amount.</p>
<p>but still perfect safety is really an impossible goal, it’s really about improving the probability of safety.</p>
<p>in Autopilot 9.0, <code>Navigate on Autopilot(Beta)</code>  intelligently suggests lane changes to keep you on your route in addition to making adjustments so you don’t get stuck behind slow cars or trucks. Navigate on Autopilot will also automatically steer toward and take the correct highway interchanges and exits based on your destination.</p>
<p>Autopilot is keeping evaluation with more exicting features:  </p>
<ul>
<li>traffic light and stop signs detection</li>
<li>enhanced summon</li>
<li>naviagte multi-story parking lots </li>
<li>automaticly send off vehicle to park</li>
<li>Autopilot on city streets</li>
<li>Robotaxi service</li>
</ul>
<h2 id="Tesla-Hardware"><a href="#Tesla-Hardware" class="headerlink" title="Tesla Hardware"></a>Tesla Hardware</h2><h4 id="Hardware-1-0"><a href="#Hardware-1-0" class="headerlink" title="Hardware 1.0"></a>Hardware 1.0</h4><p>or Autopliot 1 or AP1, it was a joint development between Mobileye and Tesla.  It featured a single front-facing camera and radar to sense the environment plus Mobileye’s hardware and software to control the driving experience. AP1 was so good that when Tesla decided to build their own system, it took them years to catch up to the baseline Autopilot functionality in AP1.  Mobileye EyeQ3 is good to mark/label in free space, intuitive routing, obstacle-avoid, and traffic signal recognization etc. but it has a few limitations to env light, and reconstruct 3D world from 2D images etc does work as expect all the time. and EyeQ3 detects objects with traditional algorithms, not cool! </p>
<ul>
<li><p>AP1 Hardware Suite:</p>
<ul>
<li>Front camera (single monochrome)</li>
<li>Front radar with range of 525 feet / 160 meters</li>
<li>12 ultrasonic sensors with 16 ft range / 5 meters</li>
<li>Rear camera for driver only (not used in Autopilot)</li>
<li>Mobileye EyeQ3 computing platform</li>
</ul>
</li>
<li><p>AP1 Core features:</p>
<ul>
<li>Traffic-Aware Cruise Control (TACC), start &amp; stop</li>
<li>Autosteer (closed-access roads, like freeways)</li>
<li>Auto Lane Change (driver initiated)</li>
<li>Auto Park</li>
<li>Summon</li>
</ul>
</li>
</ul>
<h4 id="Hardware-2-0"><a href="#Hardware-2-0" class="headerlink" title="Hardware 2.0"></a>Hardware 2.0</h4><p>AP2 highlights machine learning/neurual networks with camera inputs, so with more sensors and more powerful computing platforms. </p>
<p><img src="https://electrek.co/wp-content/uploads/sites/3/2016/10/tesla-second-gen-autopilot-sensors-suite.png" alt="image"></p>
<ul>
<li><p>AP2 Hardware Suite:</p>
<ul>
<li>Front cameras (3 cameras, medium, narrow and wide angle)</li>
<li>Side cameras (4 total, 2 forward and 2 rear-facing, on each side)</li>
<li>Rear camera (1 rear-facing)</li>
<li>Front radar with range of 525 feet / 160 meters</li>
<li>12 ultrasonic sensors with 26 ft range / 8 meters</li>
<li>NVIDIA DRIVE PX 2 AI computing platform</li>
</ul>
</li>
</ul>
<ul>
<li><p>AP2 Core features:</p>
<ul>
<li>Traffic-Aware Cruise Control (TACC), start &amp; stop</li>
<li>Autosteer (closed-access roads, like freeways)</li>
<li>Auto Lane Change (driver initiated)</li>
<li>Navigate on Autopilot (on-ramp to off-ramp)</li>
<li>Auto Park</li>
<li>Summon</li>
</ul>
<p>there was AP2.5 update, with redundant NVIDIA DRIVE PX2 and forward radar with longer range (170m)</p>
</li>
</ul>
<h4 id="Hardware-3-0"><a href="#Hardware-3-0" class="headerlink" title="Hardware 3.0"></a>Hardware 3.0</h4><p>or Full Self Driving(FSD) Computer, </p>
<p><img src="https://www.autopilotreview.com/wp-content/uploads/2019/04/tesla-fsd-computer-perception-input-image-1068x558.jpg" alt="image"></p>
<h2 id="Telsa-guys"><a href="#Telsa-guys" class="headerlink" title="Telsa guys"></a>Telsa guys</h2><p><a href="https://sterlinganderson.info" target="_blank" rel="external">Sterling Anderson</a> from 2015 - 2016, director of Autopilot program.</p>
<p><a href="http://nondot.org/sabre/" target="_blank" rel="external">Chris Latter</a> in early 2017, VP for Autopilot software </p>
<p>Jim Keller, from 2016 to 2017, VP for Autopilot hardware</p>
<p>David Nister, from 2015 to 2017, VP for Autopilot</p>
<p>Stuart Bowers from 2018 -2019, VP for Autopilot </p>
<p>Pete Bannon, from 2016 to now, Director for Autopilot hardware</p>
<p>Andrej Karpathy, from 2017 to now, Director of AI</p>
<h2 id="Tesla-in-media"><a href="#Tesla-in-media" class="headerlink" title="Tesla in media"></a>Tesla in media</h2><p><a href="https://www.teslarati.com/" target="_blank" rel="external">TeslaRati</a> </p>
<p><a href="https://www.tesla.cn/blog/" target="_blank" rel="external">Tesla official</a></p>
<p><a href="https://teslamotorsclub.com/tmc/" target="_blank" rel="external">Telsa motor club</a></p>
<p><a href="https://www.autopilotreview.com" target="_blank" rel="external">Autopilot review</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/22413629" target="_blank" rel="external">zhihu: Tesla Autopilot history</a></p>
<p><a href="https://www.thedrive.com/tech/4591/the-war-for-autonomous-driving-2017-mercedes-benz-e-class-vs-2017-tesla-model-s" target="_blank" rel="external">2017 Mercedes-Benz E vs 2017 Tesla Model S</a></p>
<p><a href="https://www.techrepublic.com/article/teslas-autopilot-8-0-why-elon-musk-says-perfect-safety-is-still-impossible/" target="_blank" rel="external">Tesla’s Autopilot 8.0: why Elon Mush says perfect safety is still impossible</a></p>
<p><a href="https://electrek.co/2016/09/11/transcript-elon-musks-press-conference-about-tesla-autopilot-under-v8-0-update-part-1/" target="_blank" rel="external">Transcript: Elon Musk’s press conference about Tesla Autopilot under v8.0 update</a></p>
<p><a href="https://electrek.co/2015/10/14/tesla-reveals-all-the-details-of-its-autopilot-and-its-software-v7-0-slide-presentation-and-audio-conference/" target="_blank" rel="external">Tesla reveals all the details of its autopilot and its software v7.0</a></p>
<p><a href="https://teslamotorsclub.com/tmc/threads/software-update-2018-39-4a3910f-plus-other-v9-0-early-access-builds.129936/" target="_blank" rel="external">Software update 2018.39</a></p>
<p><a href="https://electrek.co/2019/09/15/tesla-v10-first-look-release-notes-features/" target="_blank" rel="external">Tesla V10: first look at release notes and features</a></p>
<p><a href="https://www.teslarati.com/tesla-autopilot-fsd-traffic-light-stop-sign-recognition-and-response-shadow-mode/" target="_blank" rel="external">Tesla Autopilot’s stop sign, traffic light recognition and response is operating in shadow mode</a></p>
<p><a href="https://www.teslarati.com/tesla-full-self-driving-suite-price-increase-enhanced-summon-elon-musk/" target="_blank" rel="external">Tesla’s full self-driving suite with enhanced summon</a></p>
<p><a href="https://www.teslarati.com/tesla-robotaxi-service-vs-uber-vs-lyft-autonomous-taxi-race/" target="_blank" rel="external">Tesla’s Robotaxi service will be an inevitable player in the AV taxi race</a></p>
<p><a href="https://www.autopilotreview.com/tesla-autopilot-v1-v2-v3-and-beyond-differences/" target="_blank" rel="external">Tesla Autopilot AP1 vs AP2 vs AP3</a></p>
<p><a href="https://www.autopilotreview.com/tesla-custom-ai-chips-hardware-3/" target="_blank" rel="external">Tesla Hardware 3 Detailed</a></p>
<p><a href="https://www.autopilotreview.com/future-tesla-autopilot-updates/" target="_blank" rel="external">Future Tesla Autopilot update coming soon</a></p>
<p><a href="https://www.tesla.com/support/autopilot" target="_blank" rel="external">Autopilot and full self driving capability features</a></p>
<p><a href="https://www.leiphone.com/news/201904/Bv25oLklcvVSkoIB.html" target="_blank" rel="external">multi view Tesla FSD chips</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/64383604" target="_blank" rel="external">zhihu: EyeQ5 vs Xavier vs FSD</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/21/deploy-lgsvl-in-docker-swarm-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/21/deploy-lgsvl-in-docker-swarm-2/" itemprop="url">deploy lgsvl in docker swarm-2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-11-21T08:31:30-05:00">
                2019-11-21
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/11/21/deploy-lgsvl-in-docker-swarm-2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/11/21/deploy-lgsvl-in-docker-swarm-2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="background"><a href="#background" class="headerlink" title="background"></a>background</h2><p>previously tried to <a href="https://zjli2013.github.io/2019/11/19/deploy-lgsvl-in-docker-swarm/" target="_blank" rel="external">deploy lgsvl by docker compose v3</a>, which at first sounds promising, but due to lack of runtime support, which doesn’t work any way.  <code>docker service create --generic-resource</code> is another choice.</p>
<h2 id="docker-service-options"><a href="#docker-service-options" class="headerlink" title="docker service options"></a>docker service options</h2><p><a href="https://docs.docker.com/engine/swarm/services/" target="_blank" rel="external">docker service</a> support a few common <a href="https://docs.docker.com/engine/reference/commandline/service_create/" target="_blank" rel="external">options</a></p>
<pre><code>--workdir is the working directory inside the container 

--args is used to update the command the service runs 

--publish &lt;Published-Port&gt;:&lt;Service-Port&gt;

--network

--mount 

--mode 

--env 
</code></pre><p> <a href="https://docs.docker.com/engine/swarm/configs/" target="_blank" rel="external">–config</a></p>
<h2 id="docker-service-create-with-generic-resource"><a href="#docker-service-create-with-generic-resource" class="headerlink" title="docker service create with generic-resource"></a>docker service create with generic-resource</h2><h4 id="generic-resource"><a href="#generic-resource" class="headerlink" title="generic-resource"></a>generic-resource</h4><p>create services requesting <a href="https://docs.docker.com/v17.12/edge/engine/reference/commandline/service_create/#specify-isolation-mode-windows" target="_blank" rel="external">generic resources</a> is supported well:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ docker service create --name cuda \</div><div class="line">                        --generic-resource &quot;NVIDIA-GPU=2&quot; \</div><div class="line">                        --generic-resource &quot;SSD=1&quot; \</div><div class="line">                        nvidia/cuda</div></pre></td></tr></table></figure>
<p>tips: acutally the keyword <code>NVIDIA-GPU</code> is not the real tags. <code>generic_resource</code> is also supported in <a href="https://stackoverflow.com/questions/49141284/docker-swarm-generic-device-resource-connection" target="_blank" rel="external">docker compose v3.5</a>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">generic_resources:</div><div class="line">    - discrete_resource_spec:</div><div class="line">       kind: &apos;gpu&apos;</div><div class="line">       value: 2</div></pre></td></tr></table></figure>
<p><code>--generic-resource</code> has the ability to access GPU in service, a few blog topics:</p>
<ul>
<li><p><a href="https://codingsans.com/blog/gpu-orchestration-using-docker" target="_blank" rel="external">GPU Orchestration Using Docker</a></p>
</li>
<li><p><a href="http://cowlet.org/2018/05/21/accessing-gpus-from-a-docker-swarm-service.html" target="_blank" rel="external">access gpus from swarm service</a></p>
</li>
</ul>
<h4 id="first-try"><a href="#first-try" class="headerlink" title="first try"></a>first try</h4><p>follow <a href="http://cowlet.org/2018/05/21/accessing-gpus-from-a-docker-swarm-service.html" target="_blank" rel="external">accessing GPUs from swarm service</a>. install <a href="https://github.com/NVIDIA/nvidia-container-runtime" target="_blank" rel="external">nvidia-container-runtime</a> and install <code>docker-compose</code>, and run the following script:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">export GPU_ID=`nvidia-smi -a | grep UUID | awk &apos;&#123;print substr($4,0,12)&#125;&apos;`</div><div class="line">sudo mkdir -p /etc/systemd/system/docker.service.d</div><div class="line">cat EOF | sudo tee --append /etc/systemd/system/docker.service.d/override.conf</div><div class="line">[Service]</div><div class="line">ExecStart=</div><div class="line">ExecStart=/usr/bin/dockerd -H fdd:// --default-runtime=nvidia --node-generic-resource gpu=$&#123;GPU_ID&#125;</div><div class="line">EOF</div><div class="line">sudo sed -i &apos;swarm-resource = &quot;DOCKER_RESOURCE_GPU&quot;&apos; /etc/nvidia-container-runtime/config.toml</div><div class="line">sudo systemctl daemon-reload</div><div class="line">sudo systemctl start docker</div></pre></td></tr></table></figure>
<p>to understand supported dockerd options, can check <a href="https://github.com/docker/cli/blob/master/docs/reference/commandline/dockerd.md" target="_blank" rel="external">here</a>, then run the test as: </p>
<pre><code>docker service create --name vkcc --generic-resource &quot;gpu=0&quot; --constraint &apos;node.role==manager&apos; nvidia/cudagl:9.0-base-ubuntu16.04

docker service create --name vkcc --generic-resource &quot;gpu=0&quot; --env DISPLAY=unix:$DISPLAY --mount src=&quot;X11-unix&quot;,dst=&quot;/tmp/.X11-unix&quot; --constraint &apos;node.role==manager&apos; vkcube 
</code></pre><p>which gives the errors:</p>
<pre><code>1/1: no suitable node (1 node not available for new tasks; insufficient resourc… 
1/1: no suitable node (insufficient resources on 2 nodes) 
</code></pre><p>if run as, where <code>GPU-9b5113ed</code> is the physical GPU ID in node:</p>
<pre><code>docker service create --name vkcc --generic-resource &quot;gpu=GPU-9b5113ed&quot; nvidia/cudagl:9.0-base-ubuntu16.04
</code></pre><p>which gives the error: </p>
<pre><code>invalid generic-resource request `gpu=GPU-9b5113ed`, Named Generic Resources is not supported for service create or update
</code></pre><p>these errors are due to swarm cluster can’t recognized this GPU resource, which is configured in <code>/etc/nvidia-container-runtime/config.toml</code></p>
<h4 id="second-try"><a href="#second-try" class="headerlink" title="second try"></a>second try</h4><p>as mentioined in <a href="https://codingsans.com/blog/gpu-orchestration-using-docker" target="_blank" rel="external">GPU orchestration using Docker</a>, another change can be done:</p>
<pre><code>ExecStart=/usr/bin/dockerd -H unix:///var/run/docker.sock --default-runtime=nvidia --node-generic-resource gpu=${GPU_ID}
</code></pre><p>which fixes the <code>no suitable node</code> issue, but start container failed: OCI..</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:~# docker service ps vkcc  </div><div class="line">ID                  NAME                IMAGE                                NODE                DESIRED STATE       CURRENT STATE           ERROR                              PORTS</div><div class="line">orhcaxyujece        vkcc.1              nvidia/cudagl:9.0-base-ubuntu16.04   ubuntu              Ready               Ready 3 seconds ago                                        </div><div class="line">e001nd557ka6         \_ vkcc.1          nvidia/cudagl:9.0-base-ubuntu16.04   ubuntu              Shutdown            Failed 3 seconds ago    &quot;starting container failed: OC…&quot;</div></pre></td></tr></table></figure>
<p>check daemon log with <code>sudo journalctl -fu docker.service</code>, which gives:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Nov 21 13:07:12 ubuntu dockerd[1372]: time=&quot;2019-11-21T13:07:12.089005034+08:00&quot; level=error msg=&quot;fatal task error&quot; error=&quot;starting container failed: OCI runtime create failed: unable to retrieve OCI runtime error (open /run/containerd/io.containerd.runtime.v1.linux/moby/9eee7ac30a376ee8f59704f7687455bfb163e5ea3dd6d09d24fbd69ca2dfaa4e/log.json: no such file or directory): nvidia-container-runtime did not terminate sucessfully: unknown&quot; module=node/agent/taskmanager node.id=emzw1f9293rwdk97ki7gfqq1q service.id=qdma7vr1g519lz9hx2y1fen9o task.id=ex1l4wy61kvughns5uzo6qgxy</div></pre></td></tr></table></figure>
<h4 id="third-try"><a href="#third-try" class="headerlink" title="third try"></a>third try</h4><p>following <a href="https://github.com/NVIDIA/nvidia-docker/issues/141#issuecomment-356458450" target="_blank" rel="external">issue #141</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">nvidia-smi -a | grep UUID | awk &apos;&#123;print &quot;--node-generic-resource gpu=&quot;substr($4,0,12)&#125;&apos; | paste -d&apos; &apos; -s</div><div class="line">sudo systemctl edit docker</div><div class="line"></div><div class="line">[Service]</div><div class="line">ExecStart=</div><div class="line">ExecStart=/usr/bin/dockerd -H fd:// --default-runtime=nvidia &lt;resource output from the above&gt;</div></pre></td></tr></table></figure>
<p>and run: </p>
<pre><code>docker service create --name vkcc --generic-resource &quot;gpu=1&quot; --env DISPLAY --constraint &apos;node.role==manager&apos; nvidia/cudagl:9.0-base-ubuntu16.04
</code></pre><p>it works  with output <code>verify: Service converged</code>. However, when test image with <code>vucube</code> or <code>lgsvl</code> it has errors:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Nov 21 19:33:20 ubuntu dockerd[52334]: time=&quot;2019-11-21T19:33:20.467968047+08:00&quot; level=error msg=&quot;fatal task error&quot; error=&quot;task: non-zero exit (1)&quot; module=node/agent/taskmanager node.id=emzw1f9293rwdk97ki7gfqq1q service.id=spahe4h24fecq11ja3sp8t2cn task.id=uo7nk4a3ud201bo9ymmlpxzr3</div></pre></td></tr></table></figure>
<p>to debug the <code>non-zero exit (1)</code> :</p>
<pre><code>docker service  ls    #get the dead service-ID

docker [service] inspect  r14a68p6v1gu  # check 

docker ps -a  # find the dead container-ID 

docker logs  ff9a1b5ca0de   # check the log of the failure container
</code></pre><p>it gives: <code>Cannot find a compatible Vulkan installable client driver (ICD)</code> </p>
<p>check the issue at <a href="https://gitlab.com/nvidia/container-images/vulkan/issues/2" target="_blank" rel="external">gitlab/nvidia-images</a></p>
<h4 id="forth-try"><a href="#forth-try" class="headerlink" title="forth try"></a>forth try</h4><pre><code>docker service create --name glx --generic-resource &quot;gpu=1&quot; --constraint &apos;node.role==manager&apos;  --env DISPLAY --mount src=&quot;X11-unix&quot;,dst=&quot;/tmp/.X11-unix&quot; --mount src=&quot;tmp&quot;,dst=&quot;/root/.Xauthority&quot;  --network host  192.168.0.10:5000/glxgears 
</code></pre><p>BINGO !!!!! it does serve  <code>openGL/glxgears</code> in service mode. However, there are a few issues:</p>
<ul>
<li><p>constraint to manager node</p>
</li>
<li><p>require host network </p>
</li>
</ul>
<p>the <code>X11-unix</code> and <code>Xauthority</code> are from <a href="https://www.csdn.net/article/2015-07-30/2825340" target="_blank" rel="external">X11 configuration</a>, which need more study. also  <code>network</code> parameter need to expand to ingress overlay</p>
<p>mostly, vulkan image still can’t run, with the same error: <code>Cannot find a compatible Vulkan installable client driver (ICD)</code></p>
<h4 id="generic-resource-support-discussion"><a href="#generic-resource-support-discussion" class="headerlink" title="generic-resource support discussion"></a>generic-resource support discussion</h4><p><a href="https://github.com/moby/moby/issues/33439" target="_blank" rel="external">moby issue 33439: add support for swarmkit generic resources</a></p>
<ul>
<li>how to advertise Generic Resources(republish generic resources)</li>
<li>how to request Generic Resources </li>
</ul>
<p><a href="https://github.com/NVIDIA/nvidia-docker/issues/141" target="_blank" rel="external">nvidia-docker issue 141: support for swarm mode in Docker 1.12</a></p>
<p><a href="https://github.com/docker/docker.github.io/pull/5416" target="_blank" rel="external">docker issue 5416: Add Generic Resources</a></p>
<p><strong>Generic resources</strong></p>
<p><a href="https://github.com/RenaudWasTaken/docker.github.io/blob/master/compose/compose-file/index.md" target="_blank" rel="external">Generic resources</a> are a way to select the kind of nodes your task can land on.</p>
<p>In a swarm cluster, nodes can advertise Generic resources as discrete values or as named values such as SSD=3 or GPU=UID1, GPU=UID2.</p>
<p>The Generic resources on a service allows you to request for a number of these Generic resources advertised by swarm nodes and have your tasks land on nodes with enough available resources to statisfy your request.</p>
<p>If you request Named Generic resource(s), the resources selected are exposed in your container through the use of environment variables. E.g: DOCKER_RESOURCE_GPU=UID1,UID2</p>
<p>You can only set the generic_resources resources’ reservations field.</p>
<p><a href="https://stackoverflow.com/questions/40172594/schedule-a-container-with-docker-swarm-using-gpu-memory-as-a-constraint" target="_blank" rel="external">overstack: schedule a container with swarm using GPU memory as a constraint</a></p>
<p><a href="https://docs.docker.com/v17.12/datacenter/ucp/2.2/guides/admin/configure/add-labels-to-cluster-nodes/" target="_blank" rel="external">label swarm nodes</a></p>
<pre><code>$ docker node update --label-add &lt;key&gt;=&lt;value&gt; &lt;node-id&gt;
</code></pre><p><a href="https://github.com/docker/compose/issues/6691" target="_blank" rel="external">compose issue #6691</a></p>
<p><a href="https://github.com/NVIDIA/nvidia-docker/issues/141" target="_blank" rel="external">docker-nvidia issue #141</a></p>
<h4 id="SwarmKit"><a href="#SwarmKit" class="headerlink" title="SwarmKit"></a>SwarmKit</h4><p><a href="https://github.com/docker/swarmkit" target="_blank" rel="external">swarmkit</a> also support <a href="https://github.com/docker/swarmkit/blob/master/design/generic_resources.md" target="_blank" rel="external">GenericResource</a>, please check <a href="https://github.com/docker/swarmkit/blob/master/design/generic_resources.md#use-cases" target="_blank" rel="external">design doc</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ # Single resource</div><div class="line">$ swarmctl service create --name nginx --image nginx:latest --generic-resources &quot;banana=2&quot;</div><div class="line">$ # Multiple resources</div><div class="line">$ swarmctl service create --name nginx --image nginx:latest --generic-resources &quot;banana=2,apple=3&quot;</div></pre></td></tr></table></figure>
<pre><code>./bin/swarmctl service create --device /dev/nvidia-uvm --device /dev/nvidiactl --device /dev/nvidia0 --bind /var/lib/nvidia-docker/volumes/nvidia_driver/367.35:/usr/local/nvidia --image nvidia/digits:4.0 --name digits
</code></pre><p>swarmkit add support <a href="https://github.com/docker/swarmkit/issues/1244" target="_blank" rel="external">devices option</a></p>
<h2 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h2><p><a href="https://stackoverflow.com/questions/51398808/how-to-manage-docker-swarm-service-configuration" target="_blank" rel="external">manage swarm service with config</a></p>
<p><a href="https://upcloud.com/community/tutorials/how-to-configure-docker-swarm/" target="_blank" rel="external">UpCloud: how to configure Docker swarm</a></p>
<p><a href="https://codefresh.io/docker-tutorial/deploy-docker-compose-v3-swarm-mode-cluster/" target="_blank" rel="external">Docker compose v3 to swarm cluster</a></p>
<p><a href="https://blog.couchbase.com/deploy-docker-compose-services-swarm/" target="_blank" rel="external">deploy docker compose services to swarm</a></p>
<p><a href="https://docs.docker.com/v17.12/edge/engine/reference/commandline/deploy/" target="_blank" rel="external">docker deploy doc</a></p>
<p><a href="https://github.com/alexei-led/swarm-mac/blob/master/init_swarm.sh" target="_blank" rel="external">alexei-led github</a></p>
<p><a href="https://vsupalov.com/docker-arg-env-variable-guide/" target="_blank" rel="external">Docker ARG, ENV, .env – a complete guide</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/19/deploy-lgsvl-in-docker-swarm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/19/deploy-lgsvl-in-docker-swarm/" itemprop="url">deploy lgsvl in docker swarm</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-11-19T08:16:59-05:00">
                2019-11-19
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/11/19/deploy-lgsvl-in-docker-swarm/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/11/19/deploy-lgsvl-in-docker-swarm/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>previously, <a href="https://zjli2013.github.io/2019/11/13/vulkan-in-docker-to-support-new-lgsvl/" target="_blank" rel="external">vulkan in docker</a> gives the way to run vulkan based apps in Docker; this post is about how to deploy a GPU-based app in docker swarm. Docker swarm has the ability to deploy apps(service) in scalability.</p>
<h2 id="Docker-registry"><a href="#Docker-registry" class="headerlink" title="Docker registry"></a>Docker registry</h2><p>Docker Registry is acted as a local Docker Hub, so the nodes in the LAN can share images.</p>
<h3 id="update-docker-daemon-with-insecure-registries"><a href="#update-docker-daemon-with-insecure-registries" class="headerlink" title="update docker daemon with insecure-registries"></a>update docker daemon with insecure-registries</h3><ul>
<li><p>modify <code>/etc/docker/daemon.json</code> in worker node: </p>
<pre><code>&quot;insecure-registries&quot;: [&quot;192.168.0.10:5000&quot;] 
</code></pre></li>
<li><p>systemctl restart docker </p>
</li>
<li><p>start registry service in manager node </p>
<p>  docker service create –name registry –publish published=5000,target=5000 registry:2</p>
</li>
</ul>
<p>access docker registry on both manager node and worker node :</p>
<pre><code>$ curl http://192.168.0.10:5000/v2/   #on manager node 
$ curl http://192.168.0.10:5000/v2/   #on worker node 
</code></pre><p>insecure registry is only for test; for product, it has to with secure connection, check the official doc about <a href="https://docs.docker.com/registry/deploying/" target="_blank" rel="external">deploy a registry server</a></p>
<h3 id="upload-images-to-this-local-registry-hub"><a href="#upload-images-to-this-local-registry-hub" class="headerlink" title="upload images to this local registry hub"></a>upload images to this local registry hub</h3><pre><code>docker tag  stackdemo  192.168.0.10:5000/stackdemo
docker push  192.168.0.10:5000/stackdemo:latest
curl  http://192.168.0.10:5000/v2/_catalog
</code></pre><p>on worker run: </p>
<pre><code>docker pull 192.168.0.10:5000/stackdemo 
docker run -p 8000:8000  192.168.0.10:5000/stackdemo  
</code></pre><p>the purpose of <code>local registry</code> is to build a local docker image file server, to share in the cluster server. </p>
<h2 id="Deploy-compose"><a href="#Deploy-compose" class="headerlink" title="Deploy compose"></a>Deploy compose</h2><h3 id="docker-compose-build"><a href="#docker-compose-build" class="headerlink" title="docker-compose build"></a>docker-compose build</h3><p><code>docker-compose build</code> is used to build the images. <code>docker-compose up</code> will run the image, if not exiting, will build the image first. for lgsvl app, the running has a few parameters, so directly run <code>docker-compose up</code> will report <code>no protocol</code> error.</p>
<h3 id="run-vkcube-in-docker-compose"><a href="#run-vkcube-in-docker-compose" class="headerlink" title="run vkcube in docker-compose"></a>run vkcube in docker-compose</h3><p>docker-compose v2 does support <code>runtime=nvidia</code>, by appending the following to <code>/etc/docker/daemon.json</code>:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">"runtimes": &#123;</div><div class="line">     "nvidia": &#123;</div><div class="line">         "path": "nvidia-container-runtime",</div><div class="line">         "runtimeArgs": []</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>to run vkcube in compose by:</p>
<pre><code>xhost +si:localuser:root
docker-compose up
</code></pre><p>the docker-compose.yml is :</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">version: '2.3'</div><div class="line"></div><div class="line">services:</div><div class="line"> vkcube-test:</div><div class="line">  runtime: nvidia</div><div class="line">  volumes:</div><div class="line">      - /tmp/.X11-unix:/tmp/.X11-unix </div><div class="line">  environment:</div><div class="line">  - NVIDIA_VISIBLE_DEVICES=0 </div><div class="line">  - DISPLAY</div><div class="line">#  image: nvidia/cuda:9.0-base</div><div class="line">  image: vkcube</div><div class="line">#  build: .</div></pre></td></tr></table></figure>
<p>however, currently <a href="https://github.com/docker/compose/issues?utf8=%E2%9C%93&amp;q=nvidia" target="_blank" rel="external">composev3 doesn’t support NVIDIA runtime</a>, who is required to run stack deploy. </p>
<h3 id="support-v3-compose-with-nvidia-runtime"><a href="#support-v3-compose-with-nvidia-runtime" class="headerlink" title="support v3 compose with nvidia runtime"></a>support v3 compose with nvidia runtime</h3><p>as discussed at <a href="https://github.com/docker/compose/issues/6691" target="_blank" rel="external">#issue: support for NVIDIA GPUs under docker compose</a>:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">services:</div><div class="line">  my_app:</div><div class="line">    deploy:</div><div class="line">      resources:</div><div class="line">        reservations:</div><div class="line">          generic_resources:</div><div class="line">            - discrete_resource_spec:</div><div class="line">                kind: 'gpu'</div><div class="line">                value: 2</div></pre></td></tr></table></figure>
<p>update <a href="https://www.ipyker.com/2018/03/22/docker-daemon" target="_blank" rel="external">daemon.json</a> with <code>node-generic-resources</code>, an official sample of <a href="https://github.com/docker/cli/blob/9a39a1/cli/compose/loader/full-example.yml#L71-L74" target="_blank" rel="external">compose resource</a> can be reviewed. but so far, it only reports error:</p>
<pre><code>ERROR: The Compose file &apos;./docker-compose.yml&apos; is invalid because:
services.nvidia-smi-test.deploy.resources.reservations value Additional properties are not allowed (&apos;generic_resources&apos; was unexpected`
</code></pre><h3 id="deploy-compose-V3-to-swarm"><a href="#deploy-compose-V3-to-swarm" class="headerlink" title="deploy compose_V3 to swarm"></a>deploy compose_V3 to swarm</h3><p><a href="https://docs.docker.com/compose/compose-file/" target="_blank" rel="external">docker compose v3</a> has two run options, if triggered by <code>docker-compose up</code>, it is in standalone mode, will all services in the stack is host in current node; if triggered through <code>docker stack deploy</code> and current node is the manager of the swarm cluster, the services will be hosted in the swarm. btw, <code>docker compose v2</code> only support standalone mode.</p>
<p>take an example from the official doc: <a href="https://docs.docker.com/engine/swarm/stack-deploy/" target="_blank" rel="external">deploy a stack to swarm</a>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">docker service create --name registry --publish published=5000,target=5000 registry:2</div><div class="line">docker-compose up -d</div><div class="line">docker-compose ps</div><div class="line">docker-compose down --volumes</div><div class="line">docker-compose push #push to local registry</div><div class="line">docker stack deploy</div><div class="line">docker stack services stackdemo</div><div class="line">docker stack rm stackdemo</div><div class="line">docker service rm registry</div></pre></td></tr></table></figure>
<p>after deploy <code>stackdemo</code> in swarm, check on both manager node and worker node:</p>
<pre><code>curl http://192.168.0.13:8000
curl http://192.168.0.10:8000
</code></pre><h3 id="docker-service-runtime"><a href="#docker-service-runtime" class="headerlink" title="docker service runtime"></a>docker service runtime</h3><p><code>docker run</code> can support runtime env through <code>-e</code> in CLI or <code>env-file</code>, but actually <code>docker service</code> doesn’t have runtime env support. <code>docker compose v3</code> give the possiblity to configure the runtime env and deploy the service to clusters, but so far v3 compose doesn’t support <code>runtime=nvidia</code>, so not helpful.</p>
<p>I tried to run vkcube, lgsvl with docker service:</p>
<pre><code>docker service create --name vkcc --env NVIDIA_VISIBLE_DEVICES=0 --env DISPLAY=unix:$DISPLAY --mount src=&quot;/.X11-unix&quot;,dst=&quot;/tmp/.X11-unix&quot;  vkcube
docker service create --name lgsvl  -p 8080:8080 --env NVIDIA_VISIBLE_DEVICES=0 --env DISPLAY=unix$DISPLAY --mount src=&quot;X11-unix&quot;,dst=&quot;/tmp/.X11-unix&quot;  lgsvl
</code></pre><p>for <code>vkcube</code>, the service converged, but no GUI display; for <code>lgsvl</code>, the service failed.</p>
<h2 id="Docker-deploy"><a href="#Docker-deploy" class="headerlink" title="Docker deploy"></a>Docker deploy</h2><p><a href="https://docs.docker.com/v17.12/edge/engine/reference/commandline/deploy/" target="_blank" rel="external">docker deploy</a> is used to deploy a complete application stack to the swarm, which accepts the stack application in <a href="https://docs.docker.com/compose/compose-file/" target="_blank" rel="external">compose file</a>, docker depoy is in experimental, which can be trigger in <code>/etc/docker/daemon.json</code>, <a href="https://docs.docker.com/v17.12/engine/reference/commandline/dockerd/#daemon-configuration-file" target="_blank" rel="external">check to enable experimental features</a></p>
<p><a href="https://www.jianshu.com/p/1db6f0150fdb" target="_blank" rel="external">a sample from jianshu</a> <code>docker-compose.yml</code>:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">version: "3"</div><div class="line"></div><div class="line">services:</div><div class="line">  nginx:</div><div class="line">    image: nginx:alpine</div><div class="line">    ports:</div><div class="line">      - 80:80</div><div class="line">    deploy:</div><div class="line">      mode: replicated</div><div class="line">      replicas: 4</div><div class="line"></div><div class="line">  visualizer:</div><div class="line">    image: dockersamples/visualizer</div><div class="line">    ports:</div><div class="line">      - "9001:8080"</div><div class="line">    volumes:</div><div class="line">      - "/var/run/docker.sock:/var/run/docker.sock"</div><div class="line">    deploy:</div><div class="line">      replicas: 1</div><div class="line">      placement:</div><div class="line">        constraints: [node.role == manager]</div><div class="line"></div><div class="line">  portainer:</div><div class="line">    image: portainer/portainer</div><div class="line">    ports:</div><div class="line">      - "9000:9000"</div><div class="line">    volumes:</div><div class="line">      - "/var/run/docker.sock:/var/run/docker.sock"</div><div class="line">    deploy:</div><div class="line">      replicas: 1</div><div class="line">      placement:</div><div class="line">        constraints: [node.role == manager]</div></pre></td></tr></table></figure>
<p>a few commands to look into swarm services: </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">docker stack deploy -c docker-compose.yml   stack-demo </div><div class="line">docker stack services  stack-demo </div><div class="line">docker service inspect --pretty stack-demo   # inspect service in the swarm</div><div class="line">docker service ps &lt;service-id&gt;  # check which nodes are running the service</div><div class="line">docker ps #on the special node where the task is running, to see details about the container</div></pre></td></tr></table></figure>
<h2 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h2><p>at this moment, it’s not possible to use v3 compose.yml to support <code>runtime=nvidia</code>, so using v3 compose.yml to depoly a gpu-based service in swarm is blocked. the nature swarm way maybe the right solution. </p>
<h2 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h2><p> <a href="https://github.com/docker/docker.github.io/blob/master/registry/insecure.md" target="_blank" rel="external">run as an insecure registry</a></p>
<p> <a href="https://www.cnblogs.com/sparkdev/p/6890995.html" target="_blank" rel="external">https configure for docker registry in LAN</a></p>
<p> <a href="https://asperti.com/en/docker-proxy-for-lan" target="_blank" rel="external">a docker proxy for your LAN</a></p>
<p> <a href="https://github.com/alexei-led/swarm-mac/blob/master/init_swarm.sh" target="_blank" rel="external">alex: deploy compose(v3) to swarm</a></p>
<p> <a href="https://sysdig.com/blog/monitor-docker-swarm/" target="_blank" rel="external">monitor docker swarm</a></p>
<p> <a href="https://github.com/dockersamples/docker-swarm-visualizer" target="_blank" rel="external">docker swarm visulizer</a></p>
<p> <a href="https://proxy.dockerflow.com/swarm-mode-auto/" target="_blank" rel="external">swarm mode with docker service</a></p>
<p> <a href="https://docs.docker.com/v17.09/engine/swarm/swarm-tutorial/inspect-service/" target="_blank" rel="external">inspect a service on the swarm</a></p>
<p> <a href="https://github.com/dockersamples/example-voting-app#linux-containers" target="_blank" rel="external">voting example</a></p>
<p> <a href="https://yudanta.github.io/posts/nvidia-docker-and-docker-compose-enabled/" target="_blank" rel="external">enable compose for nvidia-docker</a></p>
<p> <a href="https://libraries.io/pypi/nvidia-docker-compose" target="_blank" rel="external">nvidia-docker-compose</a></p>
<p> <a href="https://github.com/docker/compose/issues/6691" target="_blank" rel="external">compose issue: to support nvidia under Docker compose</a></p>
<p> <a href="https://github.com/docker/app/issues/241" target="_blank" rel="external">potential solution for composev3 with runtime</a></p>
<p> <a href="https://github.com/docker/swarmkit/blob/master/design/generic_resources.md" target="_blank" rel="external">swarmkit: generic_resources</a></p>
<p> <a href="https://vsupalov.com/docker-arg-env-variable-guide/" target="_blank" rel="external">Docker ARG, ENV, .env – a complete guide</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/13/vulkan-in-docker-to-support-new-lgsvl/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/13/vulkan-in-docker-to-support-new-lgsvl/" itemprop="url">vulkan in docker to support new lgsvl</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-11-13T08:06:45-05:00">
                2019-11-13
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/11/13/vulkan-in-docker-to-support-new-lgsvl/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/11/13/vulkan-in-docker-to-support-new-lgsvl/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="background"><a href="#background" class="headerlink" title="background"></a>background</h3><p>Docker is a great idea to package apps, the first time to try <a href="https://zjli2013.github.io/2019/07/12/play-with-Docker-swarm-compose/" target="_blank" rel="external">play with docker swarm</a>. <a href="https://github.com/lgsvl/simulator" target="_blank" rel="external">lg-sim</a> has updated to HDRP rendering, which has a higher quality, as well requires more GPU features, <code>Vulkan</code>. currently <code>Vulkan</code> is not supported by standard <code>docker</code> neither <code>nvidia-dcker</code>, which is deprecated after <code>docker enginer &gt; 19.03</code>. </p>
<p>there is <a href="https://gitlab.com/nvidia/container-images" target="_blank" rel="external">nvidia images</a>,  the special one we are interesed is <a href="https://gitlab.com/nvidia/container-images/vulkan" target="_blank" rel="external">vulkan docker</a>, and there is an related <a href="https://github.com/edowson/docker-nvidia-vulkan" target="_blank" rel="external">personal project</a>, which is based on the <code>cudagl=10.1</code>, which is not supported by non-Tesla GPU. so for our platform, which has only <a href="https://developer.nvidia.com/cuda-gpus" target="_blank" rel="external">Quadra P2000 GPUs</a>, the supported CUDA is 9.0, so we need to rebuild the vulkan docker based on <code>CUDA9.0</code>. check the <a href="https://gitlab.com/nvidia/container-images/vulkan/blob/master/Dockerfile" target="_blank" rel="external">vulkan dockerfile</a>, instead of using <code>cudagl:9.0</code>, change to: <code>FROM nvidia/cudagl:9.0-base-ubuntu16.04</code></p>
<p>after build the image, we can build the <a href="https://gitlab.com/nvidia/container-images/samples/tree/master/vulkan/ubuntu16.04" target="_blank" rel="external">vulkan test samples</a>. if no issue, load lg-sim into this vulkan-docker.</p>
<p>a few lines may help:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">/usr/lib/nvidia-384/libGLX_nvidia.s.0 </div><div class="line"></div><div class="line">/usr/share/vulkan/icd.d</div><div class="line"></div><div class="line">/proc/driver/nvidia/version</div></pre></td></tr></table></figure>
<h3 id="new-lgsvl-in-docker"><a href="#new-lgsvl-in-docker" class="headerlink" title="new lgsvl in docker"></a>new lgsvl in docker</h3><p>the previous lg-sim(2019.04) can be easily run in docker, as mentioned <a href="https://github.com/lgsvl/simulator/issues/222" target="_blank" rel="external">here</a>.</p>
<p>the above vulkan-docker image is the base to host lgsvl (2019.09). additionaly, adding <code>vulkan_pso_cache.bin</code> to the docker. the benefit of host lgsvl server in docker, is to access the webUI from host or remote. so the network should be configured to run as <code>--net=host</code>. if configure as a swarm overlay network, it should support swarm cluster.</p>
<p>a few related issue can be checked at <a href="https://github.com/lgsvl/simulator/issues/488" target="_blank" rel="external">lgsvl issues hub</a>.</p>
<h3 id="VOLUME-in-dockerfile"><a href="#VOLUME-in-dockerfile" class="headerlink" title="VOLUME in dockerfile"></a>VOLUME in dockerfile</h3><p>the following sample is from <a href="https://stackoverflow.com/questions/41935435/understanding-volume-instruction-in-dockerfile" target="_blank" rel="external">understand VOLUME instruction in Dockerfile</a></p>
<p>create a Dockerfile as: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">FROM openjdk</div><div class="line">VOLUME vol1 /vol2</div><div class="line">CMD [&quot;/bin/bash&quot;]</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">docker build -t vol_test . </div><div class="line">docker run --rm -it vol_test</div></pre></td></tr></table></figure>
<p>check in the container, <code>vol1</code>, <code>vol2</code> does both exist in the running container.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">bash-4.2# ls </div><div class="line">	bin   dev  home  lib64	mnt  proc  run	 srv  tmp  var	 vol2</div><div class="line">	boot  etc  lib	 media	opt  root  sbin  sys  usr  vol1</div></pre></td></tr></table></figure>
<p>also check in host terminal:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:~# docker volume ls </div><div class="line">DRIVER              VOLUME NAME</div><div class="line">local               0ffca0474fe0d2bf8911fba9cd6b5875e51abe172f6a4b3eb5fd8b784e59ee76</div><div class="line">local               7c03d43aaa018a8fb031ef8ed809d30f025478ef6a64aa87b87b224b83901445</div></pre></td></tr></table></figure>
<p>and check further: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:/var/lib/docker/volumes# ls </div><div class="line">0ffca0474fe0d2bf8911fba9cd6b5875e51abe172f6a4b3eb5fd8b784e59ee76  metadata.db</div><div class="line">7c03d43aaa018a8fb031ef8ed809d30f025478ef6a64aa87b87b224b83901445</div></pre></td></tr></table></figure>
<p>once <code>touch ass_file</code> under container <code>/vol1</code>, we can find immediately in host machine at <code>/var/lib/docker/volumes</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:/var/lib/docker/volumes/0ffca0474fe0d2bf8911fba9cd6b5875e51abe172f6a4b3eb5fd8b784e59ee76/_data# ls -lt </div><div class="line">total 0</div><div class="line">-rw-r--r-- 1 root root 0 Nov  7 11:40 css_file</div><div class="line">-rw-r--r-- 1 root root 0 Nov  7 11:40 ass_file</div></pre></td></tr></table></figure>
<p>also if deleted file from host machine, it equally delete from the runnning container. The <code>_data</code> folder is also referred to as a <code>mount point</code>.  Exit out from the container and list the volumes on the host. They are gone. We used the –rm flag when running the container and this option effectively wipes out not just the container on exit, but also the volumes.</p>
<h3 id="sync-localhost-folder-to-container"><a href="#sync-localhost-folder-to-container" class="headerlink" title="sync localhost folder to container"></a>sync localhost folder to container</h3><p>by default, Dockerfile can not map to a host path, when trying to bring files in from the host to the container during runtime. namely, The Dockerfile can only specify the destination of the volume.  for example, we expect to sync a localshost folder e.g. <code>attach_me</code> to container, by <code>cd /path/to/dockfile &amp;&amp; docker run -v /attache_me -it vol_test</code>. a new data volume named <code>attach_me</code> is, just like the other <code>/vol1</code>, <code>/vol2</code> located in the container, but this one is totally nothing to do with the localhost folder. </p>
<p>while a trick can do the sync:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -it -v $(pwd)/attach_me:/attach_me vol_test</div></pre></td></tr></table></figure>
<p>Both sides of the <code>:</code> character expects an absolute path. Left side being an absolute path on the host machine, right side being an absolute path inside the container.</p>
<h3 id="volumes-in-compose"><a href="#volumes-in-compose" class="headerlink" title="volumes in compose"></a>volumes in compose</h3><p>which is only works during compose build, and has nothing to do with docker container.</p>
<h3 id="copy-folder-from-host-to-container"><a href="#copy-folder-from-host-to-container" class="headerlink" title="copy folder from host to container"></a>copy folder from host to container</h3><ul>
<li>COPY in dockerfile</li>
</ul>
<p>ERROR: Service ‘lg-run’ failed to build: COPY failed: stat /var/lib/docker/tmp/docker-builder322528355/home/wubantu/zj/simulator201909/build: no such file or directory</p>
<p>the solution is to keep the folder in Dockerfile’s current pwd; if else, Docker engine will look from <code>/var/lib/docker/tmp</code>.</p>
<h3 id="VOLUME-summary"><a href="#VOLUME-summary" class="headerlink" title="VOLUME summary"></a>VOLUME summary</h3><p>If you do not provide a volume in your run command, or compose file, the only option for docker is to create an anonymous volume. This is a local named <code>volume with a long unique id</code> for the name and no other indication for why it was created or what data it contains. If you override the volume, pointing to a named or host volume, your data will go there instead.</p>
<p>when <code>VOLUME</code> in DOCKERFILE, it actually has nothing to do with current host path, it actually generate something in host machine, located at <code>/var/lib/docker/volumes/</code>, which is nonreadable and managed by Docker Engine. also don’t forget to use <code>--rm</code>, which will delete the attached volumes in host when the container exit.</p>
<p><a href="https://stackoverflow.com/questions/41935435/understanding-volume-instruction-in-dockerfile" target="_blank" rel="external">warning: VOLUME breaks things</a></p>
<h3 id="understand-docker-compose-yml"><a href="#understand-docker-compose-yml" class="headerlink" title="understand docker-compose.yml"></a>understand docker-compose.yml</h3><p><a href="https://www.ionos.com/community/server-cloud-infrastructure/docker/understanding-and-managing-docker-container-volumes/" target="_blank" rel="external">Understand and manage Docker container volumes</a></p>
<p><a href="https://www.lunarg.com/vulkan-sdk/" target="_blank" rel="external">what is vulkan SDK</a></p>
<p><a href="https://www.wihlidal.com/blog/graphics/2019-05-28-vk-rust-ray-tracing-hlsl/" target="_blank" rel="external">Graham blog</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/06/build-cluster-on-Docker-swarm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/06/build-cluster-on-Docker-swarm/" itemprop="url">build cluster on Docker swarm</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-11-06T07:10:03-05:00">
                2019-11-06
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/11/06/build-cluster-on-Docker-swarm/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/11/06/build-cluster-on-Docker-swarm/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Docker-micro-services"><a href="#Docker-micro-services" class="headerlink" title="Docker micro services"></a>Docker micro services</h3><p><a href="https://docs.docker.com/v17.09/engine/swarm/key-concepts/#services-and-tasks" target="_blank" rel="external">key concepts in Docker</a></p>
<p>when deploy an application(lg-sim) to swarm cluster as a service, which is defined in a/the manager node, the manager node will dispatch units of work as taskes to worker nodes.</p>
<p>when create a service, you specify which container image to use and which commands to execute inside runing containers. In the <code>replicated services</code>, the swarm manager distributes a specific number of replica tasks among the nodes based upon the scale you set in the desired state. For <code>global services</code>, the swarm runs one task for the service on every available node in the cluster.</p>
<p><img src="https://docs.docker.com/v17.09/engine/swarm/images/swarm-diagram.png" alt="docker node"></p>
<h4 id="Docker-swarm-CLI-commands"><a href="#Docker-swarm-CLI-commands" class="headerlink" title="Docker swarm CLI commands"></a>Docker swarm CLI commands</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">docker swarm init </div><div class="line">docker swarm join</div><div class="line">docker service create  --name  --env --workdir --user</div><div class="line">docker service inspect </div><div class="line">docker service ls </div><div class="line">docker service rm</div><div class="line">docker service scale </div><div class="line">docker service ps</div><div class="line">docker service update  --args</div><div class="line">docker node inspect </div><div class="line">docker node update --label-add </div><div class="line">docker node promote/demote </div><div class="line"># run in worker</div><div class="line">docker swarm leave</div><div class="line"># run in manager</div><div class="line">docker node rm worker-node</div><div class="line">docker ps  #get running container ID</div><div class="line">docker exec -it containerID /bin/bash</div><div class="line">docker run -it</div><div class="line">docker-compose up build/run</div></pre></td></tr></table></figure>
<h4 id="delete-unused-Docker-network"><a href="#delete-unused-Docker-network" class="headerlink" title="delete unused Docker network"></a>delete unused Docker network</h4><p>as Docker network may confuse external when access to the local network interfaces, sometimes need to remove the docker networks.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">docker network ls</div><div class="line">docker network disconnect -f  &#123;network&#125; &#123;endpoint-name&#125;</div><div class="line">docker network rm </div><div class="line">docker stop $(docker ps -a -q)</div><div class="line">docker rm $(docker ps -a -q)</div><div class="line">docker volume prune </div><div class="line">docker network prune</div></pre></td></tr></table></figure>
<p>the above scripts will delete the unused(non-active) docker network, then may still active docker related networks, which can be deleted through:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">sudo ip link del docker0</div><div class="line">``` </div><div class="line"></div><div class="line"></div><div class="line">### access Docker service </div><div class="line"></div><div class="line">Docker container has its own virutal IP(172.17.0.1) and port(2347), which allowed to access in the host machine; for externaly access, need to map the hostmachine IP to docker container, by `--publish-add`. the internal communication among docker nodes are configured by `advertise_addr` and `listen-addr`.</div><div class="line"></div><div class="line"></div><div class="line">#### through IP externaly</div><div class="line">To publish a service’s ports externally, use the --publish &lt;PUBLISHED-PORT&gt;:&lt;SERVICE-PORT&gt; flag. When a user or process connects to a service, any worker node running a service task may respond.</div><div class="line"></div><div class="line">taking example from [5mins series](https://www.cnblogs.com/CloudMan6/tag/Swarm/)</div></pre></td></tr></table></figure>
<p>docker service create –name web_server –replicas=2 httpd<br>docker service ps web_server </p>
<h1 id="access-service-only-on-host-machine-through-the-Docker-IP"><a href="#access-service-only-on-host-machine-through-the-Docker-IP" class="headerlink" title="access service only on host machine through the Docker IP"></a>access service only on host machine through the Docker IP</h1><p>curl 172.17.0.1<br>docker service update –publish-add 8080:80 web_server</p>
<h1 id="access-service-externally"><a href="#access-service-externally" class="headerlink" title="access service externally"></a>access service externally</h1><p>curl <a href="http://hostmachineIP:8080" target="_blank" rel="external">http://hostmachineIP:8080</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#### configure websocket protocol</div><div class="line"></div><div class="line">for lg-sim server to pythonAPI client, which is communicated through `websocket`, it&apos;s better if the service can be configured to publish through websocket.</div><div class="line"></div><div class="line"></div><div class="line">#### publish httpd server to swarm service</div></pre></td></tr></table></figure></p>
<p>docker service create –name web_server –publish 880:80 –replicas=2  httpd<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">the container IP is IP in network interface `docker0`(e.g. 172.17.0.1), which can be checked through `ifconfig`.  `80` is the default port used by httpd, which is mapped to the host machine `880` port. so any of the following will check correctly:</div></pre></td></tr></table></figure></p>
<p>curl 172.17.0.1:880<br>curl localhost:880<br>curl 192.168.0.1:880<br>curl 192.168.0.13:880 #the other docker node<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"> </div><div class="line">#### publish lg-sim into swarm service </div><div class="line"></div><div class="line">the previous version(2019.04) of lg-sim doesn&apos;t have a http server built-in, since 2019.7, they have `Nancy http server`, which is a great step toward dockerlize the lg-sim server.</div><div class="line"></div><div class="line"></div><div class="line">### manage data in Docker </div><div class="line"></div><div class="line">`Volumes` are stored in a part of the host filesystem, which is located `/var/lib/docker/volumes`, which is actually managed by Docker, rather than by host machine.</div><div class="line">Volumes are the preferred way to [persist data in Docker](https://docs.docker.com/v17.09/engine/admin/volumes/#more-details-about-mount-types) containers and services. some use cases of volume:</div><div class="line"></div><div class="line">* once created, even the container stops or removed, the volume still exist.</div><div class="line">* multiple containes can mount the same voume simultaneously; </div><div class="line">* when need to store data on a remote host </div><div class="line">* when need to backup, restore, or migrate data from one Dockr to another</div><div class="line"></div><div class="line">#### RexRay</div><div class="line"></div><div class="line">an even high-robost way is to separate volume manager and storge provider manager. [Rex-Ray](https://rexray.readthedocs.io/en/v0.3.3/)</div></pre></td></tr></table></figure></p>
<p>docker service create –name web_s \<br>    –publish 8080:80 \<br>    –mount “type=volume, volume-driver=rexray, source=web_data, target=/usr/local/apache2/htdocs” \<br>    httpd</p>
<p>docker exec -it containerID<br>ls -ld /usr/local/apahce2/htdocs<br>chown www-data:www-data </p>
<h2 id="test-visit"><a href="#test-visit" class="headerlink" title="test visit"></a>test visit</h2><p>curl <a href="http://192.168.0.1:8080" target="_blank" rel="external">http://192.168.0.1:8080</a><br>docker inspect containerID </p>
<p>```</p>
<p><code>source</code> reprensents the name of data volume, if null, will create new<br><code>target</code> reprensents data volume will be mounted to <code>/usr/local/apache2/htdocs</code> in each container</p>
<p>in RexRay, data volume update, scale, failover(when any node crashed, the data volume won’t lose) also be taken care.</p>
<h3 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h3><p><a href="https://www.cnblogs.com/CloudMan6/tag/Swarm/" target="_blank" rel="external">5mins in Docker</a></p>
<p><a href="https://www.bookstack.cn/read/docker-swarm-guides/kai-shi-shi-yong-swarm-swarmmo-shi-duan-kou-lu-you.md" target="_blank" rel="external">Docker swarm in and out</a></p>
<p><a href="https://boxboat.com/2016/08/17/whats-docker-swarm-advertise-addr/" target="_blank" rel="external">what is swarm advertise-addr</a></p>
<p><a href="https://www.reddit.com/r/docker/comments/a5kbte/run_docker_exec_over_a_docker_swarm/" target="_blank" rel="external">can ran exec in swarm</a></p>
<p><a href="https://stackoverflow.com/questions/39362363/execute-a-command-within-docker-swarm-service" target="_blank" rel="external">execute a command within docker swarm service</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/05/Linux-network-tool/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/05/Linux-network-tool/" itemprop="url">Linux network tool</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-11-05T08:11:11-05:00">
                2019-11-05
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/11/05/Linux-network-tool/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/11/05/Linux-network-tool/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Linux-network-commands"><a href="#Linux-network-commands" class="headerlink" title="Linux network commands"></a>Linux network commands</h2><h3 id="ip"><a href="#ip" class="headerlink" title="ip"></a>ip</h3><p><a href="https://www.computerhope.com/unix/ip.htm" target="_blank" rel="external">ip</a> command is used to edit and display the configuration of network interfaces, routing, and tunnels. On many Linux systems, it replaces the deprecated ifconfig command.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">ip link  del docker0   # delete a virtual network interface </div><div class="line">ip addr add 192.168.0.1  dev eth1  #assign IP to a specific interface(eht1)</div><div class="line">ip addr show #check network interface </div><div class="line">ip addr del 192.168.0.1 dev eth1 </div><div class="line">ip link set eth1 up/down</div><div class="line">ip route [show] </div><div class="line">ip route add 192.168.0.1 via 10.10.20.0 dev eth0  #add static route 192.168.0.1</div><div class="line">ip route del 192.168.0.1  #remove static route</div><div class="line">ip route add default via 192.168.0.1 # add default gw</div></pre></td></tr></table></figure>
<h3 id="netstate"><a href="#netstate" class="headerlink" title="netstate"></a>netstate</h3><p><a href="https://www.ibm.com/support/knowledgecenter/en/ssw_aix_72/n_commands/netstat.html" target="_blank" rel="external">netstate</a> used to display active sockets/ports for each protocol (tcp/ip)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">netstat -lat </div><div class="line">netstat -us</div></pre></td></tr></table></figure>
<h3 id="nmcli"><a href="#nmcli" class="headerlink" title="nmcli"></a>nmcli</h3><p><a href="https://developer.gnome.org/NetworkManager/stable/nmcli.html" target="_blank" rel="external">nmcli</a> is a Gnome command tool to control NetworkManager and report network status: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">nmcli  device status </div><div class="line">nmcli connection show =</div></pre></td></tr></table></figure>
<h3 id="route"><a href="#route" class="headerlink" title="route"></a>route</h3><p><a href="http://www.softpanorama.org/Net/Netutils/route_in_linux.shtml" target="_blank" rel="external">route</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">route  ==&gt;  ip route (modern version) ##print router </div><div class="line">route add -net sample-net gw 192.168.0.1 </div><div class="line">route del -net link-local netmask  255.255.0.0  #delete a virtual network interface </div><div class="line">ip route flush  # flashing routing table</div></pre></td></tr></table></figure>
<h3 id="tracepath"><a href="#tracepath" class="headerlink" title="tracepath"></a>tracepath</h3><p><a href="https://www.linux.org/docs/man8/tracepath.html" target="_blank" rel="external">tracepath</a> is used to traces path to a network host discovering MTU along this path. a modern version is <code>traceroute</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">tracepath 192.168.0.1 </div><div class="line">``` </div><div class="line"></div><div class="line">### networking service</div></pre></td></tr></table></figure>
<p>systemctl restart networking<br>/etc/init.d/networking restart </p>
<h1 id="or"><a href="#or" class="headerlink" title="or"></a>or</h1><p>service NetworkManager stop<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">## network interface </div><div class="line"></div><div class="line">location at `/etc/network/interfaces` </div><div class="line"></div><div class="line">`eno1` is onboard Ethernet(wired) adapter. if machines has already `eth1` in its config file, for the second adapter, it will use `eno1` rather than using `eth2`.</div><div class="line"></div><div class="line">[ifconfig](https://www.ibm.com/support/knowledgecenter/ssw_aix_71/i_commands/ifconfig.html) is used to set up network interfaces such as Loopback, Ethernet network interface: a software interface to networking hardware, e.g.  physical or virtual. physical interface, such as `eth0`, namely Ethernet network card. virtual interface such as `Loopback`, `bridges`, `VLANs` e.t.c.</div></pre></td></tr></table></figure></p>
<p>ifconfig -a<br>ifconfig eth0  #check specific network interface<br>ifconfig eth0 192.168.0.1 #assign static IP address to network interface<br>ifconfig eth0 netmask 255.255.0.0 #assign netmask </p>
<p>ifconfig docker0 down/up </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">replaced by `ip` command later.</div><div class="line"></div><div class="line"></div><div class="line">### why enp4s0f2 instead of eth0</div><div class="line"></div><div class="line">[change back to eth0](https://www.itzgeek.com/how-tos/mini-howtos/change-default-network-name-ens33-to-old-eth0-on-ubuntu-16-04.html)</div><div class="line"></div><div class="line">```shell</div><div class="line"></div><div class="line">lspci | grep -i &quot;net&quot;</div><div class="line"></div><div class="line">dmesg | grep -i eth0</div><div class="line"></div><div class="line">ip a </div><div class="line"></div><div class="line">sudo vi /etc/default/grub</div><div class="line">	GRUB_CMDLINELINUX=&quot;net.ifnames=0 biosdevname=0&quot;</div><div class="line">update-grub</div><div class="line"></div><div class="line"># update  /etc/network/interfaces </div><div class="line"></div><div class="line">auto eth0</div><div class="line">iface eth0  inet static </div><div class="line"></div><div class="line">sudo reboot</div></pre></td></tr></table></figure>
<h3 id="Unknown-interface-enp4s0f2"><a href="#Unknown-interface-enp4s0f2" class="headerlink" title="Unknown interface enp4s0f2"></a>Unknown interface enp4s0f2</h3><p>due TO <code>/etc/network/interfaces</code> has <code>auto enp4s0f2</code> line, which always create this network interface , when restart the networking service.</p>
<h3 id="ping-hostname-with-docker0"><a href="#ping-hostname-with-docker0" class="headerlink" title="ping hostname with docker0"></a>ping hostname with docker0</h3><p>usually there may be have multi network interfaces(eth0, docker0, bridge..) on a remote host, when ping this remote host with exisiting docker network (<code>docker0</code>), by default will talk to the docker0, which may not the desired one.</p>
<h2 id="build-LAN-cluster-with-office-PCs"><a href="#build-LAN-cluster-with-office-PCs" class="headerlink" title="build LAN cluster with office PCs"></a>build LAN cluster with office PCs</h2><ul>
<li>setup PC IPs</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">master node: </div><div class="line">IP Address:  192.168.0.1 </div><div class="line">netmask: 24</div><div class="line">Gateway: null</div><div class="line">DNS serer:  10.3.101.101 </div><div class="line"></div><div class="line"></div><div class="line">worker node:</div><div class="line"></div><div class="line">IP address:  192.168.0.12</div><div class="line">netmask: 24</div><div class="line">Gateway: 192.168.0.1</div><div class="line">DNS: 10.255.18.3</div><div class="line"></div><div class="line">``` </div><div class="line"></div><div class="line">* `ufw disable` </div><div class="line"></div><div class="line">*  update `/etc/hosts` file:</div></pre></td></tr></table></figure>
<pre><code>192.168.0.1 master
192.168.0.12 worker 
</code></pre><pre><code>if need to update the default hostname to `worker`, can modify `/etc/hostname` file, and reboot.

* ping test :

```script 

ping -c 3 master 
ping -c 3 worker
</code></pre><ul>
<li>set ssh access(optionally)</li>
</ul>
<pre><code class="script">
sudo apt-get install openssh-server 
ssh-keygen -t rsa 
# use custmized key
cp rsa_pub.key authorized_key
</code></pre>
<h2 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h2><p><a href="https://www.cyberciti.biz/faq/ubuntu-linux-add-static-routing/" target="_blank" rel="external">Ubuntu add static route</a></p>
<p><a href="https://www.tecmint.com/ip-command-examples/" target="_blank" rel="external">10 useful IP commands</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/29/未来5年在哪里11/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/29/未来5年在哪里11/" itemprop="url">未来5年在哪里11</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-10-29T10:39:40-04:00">
                2019-10-29
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/10/29/未来5年在哪里11/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/10/29/未来5年在哪里11/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>真实一直有隐藏的一面，而那些窥视过隐藏面的人，注定于大多数人不同，光鲜或者孤独。想想不甘心做韭菜又上升无望的漫漫岁月，简直注定了人生悲剧。</p>
<h3 id="脆弱的感情"><a href="#脆弱的感情" class="headerlink" title="脆弱的感情"></a>脆弱的感情</h3><p>自以为是个单纯的人，所以喜欢工程师氛围、高校科研氛围、美国的社区文化。回到国内，这些氛围都找不到了。扑面而来的气息，显得很黑暗森林。我怀疑一个单纯的人，在这样的环境下，如何能生存。所以，花尽心思去思考怎么顺应社会。话语中，充满了数字和术语，像一个机器在聊天，而不是一个有感情的人，女生都没办法接近我这样的人。</p>
<p>谈女生总会到一个话题，你稳定了吗。这个”未来5年“系列已经过了一年了，换环境、换公司、换小方向，到底有什么本质的变化，确定了一个方向，确定了一些问题吗？实际上都没有，甚至还没清楚自己要在哪里（国家、城市），做什么行业（汽车、咨询），都是一些自定义的限制。</p>
<h3 id="小城市的行业"><a href="#小城市的行业" class="headerlink" title="小城市的行业"></a>小城市的行业</h3><p>回来的火车上，遇见了小城的公务员一家去武汉旅游。他们在当地的审计局工作，每年有一些培训在全国各地，比如，南京、武汉。然后一年还有5～10天年薪假。所以一年会有一两次国内的旅行，长一个月，短半个月的。他们的工资在5千 ～ 6千，小城市买了房子，买了10几万的德国/日本车；单位同事，家底好的可以开30-40万的abb。</p>
<ul>
<li>体系内</li>
</ul>
<p>学校、医院、法务机关、警察、税务、工商、建设、银行、电力、通信、交通、烟草、农林牧渔等等，庞大的网络可以解决三四线城市大量优质年轻人就业，因为是政府机关，在这些组织里面的年轻人，自然是党国的忠实跟随者。他们拿着高于当地平均值的工资，足够在小城市活的衣食无忧，甚至如上面的小夫妻，有车有房，有一年两次的度假。相比，大城市里租房、加班、年假等于零的奋斗青年，简直是苦逼。</p>
<ul>
<li>体系外</li>
</ul>
<p>三四线城市，（政府）体系以外的行业典型： 美容养生、学生教育、餐饮、休闲娱乐（电影、健身、文化项目）、汽修、服装、家具，是属于可以创业的行当。江浙以外，很少有三四线城市有自己的传统支柱产业，比如，农产品加工、能源石化、机械加工、小商品生产等等；更鲜有高附加值支柱产业，诸如，电子器件产业群、芯片产业群、汽车产业群、生物制药产业群、it产业群、精密制造产业群、金融服务业等等。</p>
<p>小城就一家国有钢铁厂，因为北方的能源、钢铁产能过剩，也气数不多。在这些小城市发展高附加值的产业，相当于空中楼阁。所以，体系外的年轻人生存状态其实很空心化。</p>
<ul>
<li>空心化</li>
</ul>
<p>“空心化”不是对服务业的贬低，但是相比发达欧美国家的小城市，它们会有一些其貌不扬，但历史百年的世界级的公司和产品。比如，德国狼堡，世界汽车产业中心；美国密西根奥本山小镇，世界级汽车应用软件商聚集地。生活在这些地方的年轻人，当然可以选择进入当地的服务业，诸如快餐连锁、超市服装、甚至房租装修、水电工等等。但是对于做研究、懂技术的年轻人，他们也能找到很容易进入一个创造绝对价值的公司。国内三四线小城市的“空心化”，就是除了传统的服务行业以及政府体系可以吸纳年轻人之外，缺乏生产绝对价值的支柱公司。</p>
<p>倒逼年轻人只能进入传统服务业或者政府机构，能够发挥年轻人创作力的机会太少了。服务业是景上添花，没有高附加值制造业的世界地位，服务业只会被局限在传统的衣食住行。这样一个显著的问题，就是影响了年轻人的价值体系。研究生毕业以后，收入水平、价值实现竟然不如隔壁小学毕业开早点的王老二。那国家投入这么多教育，是为了让这些年轻人去自卑吗。</p>
<ul>
<li>结局</li>
</ul>
<p>愚民之策，老百姓根本看不到问题，实际上在短期内，服务业是滞后价值创造产业的。开早点的王老二，还可以一个月赚5万，而且不需要为一个大学毕业生买单。长远点，低端/传统服务业，比如餐厅、修车店、服装店会慢慢饱和，甚至开展恶性竞争。每家新开的餐厅，头两个月可以吸引顾客，之后就被隔壁新开的餐厅带流量了。</p>
<p>一旦大部分传统服务行业进入这个阶段，除了政府直接控制的体系内，老百姓可能就受不了。要么政府强行维稳，全国陷入“中等收入陷阱”。要么社会就会开始乱。</p>
<p>中国有大量的三四线城市，可能都面对“空心化”的问题。大概率进入“中等收入陷阱”。看到问题而又无奈的人，会选择在这场演化之前逃离。国家层面的软实力，不是一天能建立起来的。这恐怕也是中国虽然有着表面的gdp数据，但实际上社会系统相比成熟的发达国家还差很远的地方。如果在演进之前，能慢慢发展出好的系统话。</p>
<h3 id="自动驾驶失业潮"><a href="#自动驾驶失业潮" class="headerlink" title="自动驾驶失业潮"></a>自动驾驶失业潮</h3><p>有预测，到2030年，l3+自动驾驶的行业渗透可能只在10%。相比普遍的乐观预测，到2020年以后，l3+前装量产。国内近来发了一些很政策导向的产业牌照：全球第一张5G商用牌照， 全球第一张自动驾驶商用牌照。相比，苹果在2020年都不会上5G，美国撤销自动驾驶交通委员会。到底是国内领先，还是国家在画大饼？要保障这么多新生劳动力进入市场，国家也很南啊。</p>
<p>政策可以画行业大饼，但市场比政策更理性。waymo已经被资本市场降低估值，应该就是市场对这个行业的真实回应。按照资本的延后性，大概这个行业的裁员潮会尾随而来。</p>
<p>如果失业了，新职业选择在哪里？变化是永恒的。越是高级的打工仔，受裁员影响越高。在互联网级的快速迭代市场，专业的深度也许不如专业的可移植性对打工仔更合适。</p>
<h3 id="进军服务业"><a href="#进军服务业" class="headerlink" title="进军服务业"></a>进军服务业</h3><p>看《中国机长》又一次加深的这样的体会。飞机设计、航空发动机、自动驾驶飞控系统是远在普通人的关心之外的；相比，机长、空姐、机场运营人员、服务人员容纳着大量就业，也最直接产生价值。而且他们服务产生的价值，也是经济活力的主要贡献和决定者。相比，虽然国家没有自主的民航发动机、没有自主的cae软件，谁又觉得有什么问题呢。不过是一小群人为此担忧，大部分百姓甚至政策决策者只需要看到中国的航运数据又上升了，航运公司对各地gdp的贡献又大了，就可以士气高涨。</p>
<p>离客户越近，价值越大。在核心技术没有先发优势的市场，做技术只是backup的需求。相比，服务业更靠近广大终端客户人群，价值传递最短、损耗最小、获利最大。所以，空心化后的精英都会去高附加值服务业，比如，金融、互联网。</p>
<p>我们确实不该操政策精英的心，相比，做一个短视的普通人，识时务，进挣钱的行业，就是普通人该干的。</p>
<p>所以，还是要好好准备mba。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="David Z.J. Lee" />
          <p class="site-author-name" itemprop="name">David Z.J. Lee</p>
           
              <p class="site-description motion-element" itemprop="description">what I don't know</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">132</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">32</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/ZJLi2013" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.linkedin.com/in/zhengjia13/" target="_blank" title="LinkedIn">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  LinkedIn
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">David Z.J. Lee</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://zjlee.disqus.com/count.js" async></script>
    

    

  




	





  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
