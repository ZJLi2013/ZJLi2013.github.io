<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="what I don&apos;t know">
<meta property="og:type" content="website">
<meta property="og:title" content="Serious Autonomous Vehicles">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Serious Autonomous Vehicles">
<meta property="og:description" content="what I don&apos;t know">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Serious Autonomous Vehicles">
<meta name="twitter:description" content="what I don&apos;t know">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>Serious Autonomous Vehicles</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Serious Autonomous Vehicles</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/07/mf4-know-how/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/07/mf4-know-how/" itemprop="url">mf4 know how</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-07T08:51:49-04:00">
                2020-07-07
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/07/07/mf4-know-how/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/07/07/mf4-know-how/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="preparation"><a href="#preparation" class="headerlink" title="preparation"></a>preparation</h2><h4 id="pip-reinstall"><a href="#pip-reinstall" class="headerlink" title="pip reinstall"></a>pip reinstall</h4><ul>
<li><p>uninstall current pip </p>
</li>
<li><p>apt-get install python-pip  #which install the default 8.1 version</p>
</li>
<li><p>sudo -H pip2 install –upgrade pip  #which upgrade to 20.1 version</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install --install-option=<span class="string">"--prefix=<span class="variable">$PREFIX_PATH</span>"</span> package_name</div></pre></td></tr></table></figure>
<p><a href="https://github.com/pypa/pip/issues/4754" target="_blank" rel="external">why does pip3 say I am using v8.1.1, however version 20.1.1 is avail</a></p>
<h4 id="install-asammdf"><a href="#install-asammdf" class="headerlink" title="install asammdf"></a>install asammdf</h4><p><a href="https://github.com/danielhrisca/asammdf" target="_blank" rel="external">github: asammdf</a></p>
<p>it’s recommended to use <strong>conda</strong> env to manage this project. name this env as <code>mdf</code>. it’s recommended to install packages through <code>conda install</code>, rather than system <code>apt-get install</code>. </p>
<p>the following packages is required:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">conda install numpy</div><div class="line">conda install pandas</div><div class="line">conda install -c conda-forge dbus</div><div class="line">conda install lxml=4.5.0</div><div class="line">conda install -c conda-forge canmatrix</div><div class="line">conda install -c conda-forge asammdf</div><div class="line">conda install  pyqt5  <span class="comment">#optionally but recommended, if you need asammdf GUI tool in Linux</span></div></pre></td></tr></table></figure>
<p>take care the pkg installed path, either globally in <code>conda/pkgs/</code>  or in the special env <code>/conda/envs/mdf/lib/python3/site-packages</code>, can simplely <code>import asammdf</code> to see $PYTHONPATH found the module.</p>
<h4 id="conda-pythonpath"><a href="#conda-pythonpath" class="headerlink" title="conda pythonpath"></a>conda pythonpath</h4><p>check existing system path.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> sys</div><div class="line">sys.path </div><div class="line">[<span class="string">''</span>, <span class="string">'/usr/lib/python3/dist-packages'</span>, <span class="string">'/home/anaconda3/envs/mf4/lib/python3.8/site-packages'</span>]</div></pre></td></tr></table></figure>
<p>PYTHON loads the modules from the <code>sys.path</code> in the order, so if PYTHON find the required module in the first PATH, which however is the wrong version, then it’s an error.</p>
<p><a href="https://stackoverflow.com/questions/17386880/does-anaconda-create-a-separate-pythonpath-variable-for-each-new-environment" target="_blank" rel="external">does anaconda create a separate PYTHONPATH for each new env</a>: each environment is a completely separate installation of Python and all the packages. there’s no need to mess with PYTHONPATH because the Python binary in the environment already searches the site-packages in that environment, and the libs of the environment.</p>
<p>in one word, <strong>when using conda, don’t use system PYTHONPAH</strong></p>
<h4 id="install-asammdf-gui"><a href="#install-asammdf-gui" class="headerlink" title="install asammdf[gui]"></a>install asammdf[gui]</h4><ul>
<li>test with PyQt5 </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">python3 </div><div class="line">import PyQt5</div></pre></td></tr></table></figure>
<p>reports <a href="https://askubuntu.com/questions/308128/failed-to-load-platform-plugin-xcb-while-launching-qt5-app-on-linux-without" target="_blank" rel="external">Could not load the Qt platform plugin “xcb” in “” even though it was found</a></p>
<p>the reason is due to <a href="https://github.com/neuropoly/spinalcordtoolbox/issues/2436" target="_blank" rel="external">libqxcb.so</a> from <code>~/anaconda3/envs/aeb/lib/python3.6/site-packages/PyQt5/Qt/plugins/platforms</code> not found <code>libxcb-xinerama.so.0</code>, fixed by <a href="https://github.com/supertriodo/Arena-Tracker/issues/52" target="_blank" rel="external">install libxcb-xinerama0</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ldd libqxcb.so </div><div class="line">$ libxcb-xinerama.so.0 =&gt; not found</div><div class="line">sudo apt-get install libxcb-xinerama0</div></pre></td></tr></table></figure>
<ul>
<li>install </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> PYTHONPATH=<span class="string">""</span></div><div class="line">pip install asammdf[gui]</div></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Requirement already satisfied: pyqtgraph==0.11.0rc0; extra == <span class="string">"gui"</span> <span class="keyword">in</span> /home/gwm/anaconda3/envs/aeb/lib/python3.6/site-packages (from asammdf[gui]) (0.11.0rc0)</div><div class="line">Requirement already satisfied: psutil; extra == <span class="string">"gui"</span> <span class="keyword">in</span> /home/gwm/anaconda3/envs/aeb/lib/python3.6/site-packages (from asammdf[gui]) (5.7.0)</div><div class="line">Requirement already satisfied: PyQt5&gt;=5.13.1; extra == <span class="string">"gui"</span> <span class="keyword">in</span> /home/gwm/anaconda3/envs/aeb/lib/python3.6/site-packages (from asammdf[gui]) (5.15.0)</div></pre></td></tr></table></figure>
<h4 id="numpy-utils"><a href="#numpy-utils" class="headerlink" title="numpy utils"></a>numpy utils</h4><ul>
<li>output precision</li>
</ul>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">res = np.where(arr==roi)</div><div class="line"><span class="keyword">for</span> x <span class="keyword">in</span> np.nditer(arr):</div><div class="line">	print(x)</div><div class="line">np.set_printoptions(precision=<span class="number">3</span>)</div><div class="line">np.set_printoptions(suppress=<span class="keyword">True</span>)</div><div class="line">np.around([], decimals=<span class="number">2</span>)</div><div class="line"><span class="keyword">for</span> (k,v) <span class="keyword">in</span> dict.items():</div><div class="line">	<span class="keyword">print</span> (k, v)</div></pre></td></tr></table></figure>
<h2 id="asammdf"><a href="#asammdf" class="headerlink" title="asammdf"></a>asammdf</h2><h4 id="bypass-non-standard-msg"><a href="#bypass-non-standard-msg" class="headerlink" title="bypass non-standard msg"></a>bypass non-standard msg</h4><p>most OEM mdf4 files are collected by <code>Vector CANape</code> tools, which may include many uncommon types, such as Matlab/Simulink objects, measurement signals(multimedia) cam-stream e.t.c, which can’t be parsed by current asammdf tool.</p>
<p>so a simple fix is to bypass these uncommon data type, submit in the <a href="https://github.com/danielhrisca/asammdf/issues/343" target="_blank" rel="external">git issue</a>.</p>
<h4 id="bytes-object-to-numerical-values"><a href="#bytes-object-to-numerical-values" class="headerlink" title="bytes object to numerical values"></a>bytes object to numerical values</h4><p>bytes objects basically contain a sequence of integers in the range 0-255, but when represented, Python displays these bytes as ASCII codepoints to make it easier to read their contents.</p>
<p>Because a bytes object consist of a sequence of integers, you can construct a bytes object from any other sequence of integers with values in the 0-255 range, like a list:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">bVal = bytes([72, 101, 108, 108, 111])</div><div class="line">strVal = bVal.decode(<span class="string">'utf-8'</span>)</div></pre></td></tr></table></figure>
<p>in asammdf, the numerical ndarray can be stored as <code>uint8</code>, <code>uint32</code>, <code>uint64</code> e.t.c, but with a different range and representation. for radar/camera detected obj id, the range is in [0~255], so here need output as <code>uint8</code>.</p>
<p>sample of ObjID as asammdf.Signal: </p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="string">&lt;Signal</span> <span class="attr">MRR_ObjID_3:</span></div><div class="line">	<span class="string">samples=[b''</span> <span class="string">b''</span> <span class="string">b''</span> <span class="string">...</span> <span class="string">b''</span> <span class="string">b''</span> <span class="string">b'']</span></div><div class="line">	<span class="string">timestamps=[</span> <span class="number">0.08185676</span>  <span class="number">0.13073605</span>  <span class="number">0.18073289</span> <span class="string">...</span> <span class="number">57.5313583</span>  <span class="number">57.5813593</span></div><div class="line"> <span class="number">57.63134464</span><span class="string">]</span></div><div class="line">	<span class="string">invalidation_bits=None</span></div><div class="line">	<span class="string">unit=""</span></div><div class="line">	<span class="string">conversion=None</span></div><div class="line">	<span class="string">source=&lt;asammdf.blocks.source_utils.Source</span> <span class="string">object</span> <span class="string">at</span> <span class="number">0x7f79b91c7ae8</span><span class="string">&gt;</span></div><div class="line">	comment="&lt;CNcomment&gt;</div><div class="line">&lt;TX/&gt;</div><div class="line">&lt;address byte_count="1" byte_order="BE"&gt;0x0008&lt;/address&gt;</div><div class="line">&lt;/CNcomment&gt;"</div><div class="line">	mastermeta="('t', 1)"</div><div class="line">	raw=False</div><div class="line">	display_name=</div><div class="line">	attachment=()&gt;</div></pre></td></tr></table></figure>
<h4 id="mf4-reader"><a href="#mf4-reader" class="headerlink" title="mf4_reader"></a>mf4_reader</h4><p>first, we need define a high-level APIs to handle collected mf4 from road test. which often includes a bunch of groups for each sensor, and a few channels to record one kind of Signal in one sensor. and another dimension is <code>time</code>, as each Signal is a time serial. the sample Signal output also shows there are two np.narray: <code>samples</code> and <code>timestamps</code>.</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="bullet">-</span><span class="string">&gt; group </span></div><div class="line">----&gt; channel</div><div class="line">--------&gt; samples[timestampIndex]</div></pre></td></tr></table></figure>
<p>what we need is to repackage the signals from mf4 as structures of input(mostly like sensor packages) and output(another structure or CAN package)  to any model required, e.g. fusion/aeb.  </p>
<ul>
<li>init_multi_read(group_name, channel_nums, obj_nums, channel_list)</li>
</ul>
<p><code>channel_nums</code>, gives the number of channels/signals for this sensor</p>
<p><code>obj_nums</code>, is the number of objects can detected by a special sensor, which is given by the vendor of the sensor. e.g. Bosch 5th Radar can detect at most 32 objects.</p>
<p><code>channel_list</code>, is the name list of the channels, whose length should equal <code>channel_nums</code>. </p>
<p>this API does read all required channels raw data into memeory initially.</p>
<ul>
<li>updateCacheData(group_name, time)</li>
</ul>
<p><code>time</code> is the given timestamp, this API returns the interested samples at the given <code>time</code>.  one trick here is <code>time matching</code>, as very possiblly, the given <code>time</code> doesn’t match any of the recorded timestamp in a special channel, here always seek the most closest timestamp to <code>time</code>.</p>
<ul>
<li><p>seek_closest_timestamp_index(timestamps, time)</p>
</li>
<li><p>get_channel_data_by_name(channel_name, time)</p>
</li>
<li><p>get_channel_all_data_by_name(channel_name)</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">from</span> asammdf <span class="keyword">import</span> MDF4</div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">mf4_reader</span><span class="params">()</span>:</span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, mf4_file)</span>:</span></div><div class="line">		self.reader = MDF4(mf4_file)</div><div class="line">		self.channelValsCacheMap = dict()</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">init_multi_read</span><span class="params">(group_name, channel_name, obj_nums, channel_namelist)</span>:</span></div><div class="line">		channelValuesMap = dict()</div><div class="line">		<span class="keyword">for</span> i <span class="keyword">in</span> range(obj_nums):</div><div class="line">			<span class="keyword">for</span> base_name <span class="keyword">in</span> channel_namelist:</div><div class="line">				channel_name = base_name + str(i+<span class="number">1</span>)</div><div class="line">				channel_raw_data = self.get_channel_all_data_by_name(channel_name)</div><div class="line">				<span class="keyword">if</span> channel_raw_data :</div><div class="line">					channelValuesMap[channel_name] = channel_raw_data</div><div class="line">				<span class="keyword">else</span>:</div><div class="line">					channelValuesMap[channel_name] = <span class="keyword">None</span></div><div class="line">		self.channelValsCacheMap[group_name] = channelValuesMap</div></pre></td></tr></table></figure>
<h4 id="fusion-adapter"><a href="#fusion-adapter" class="headerlink" title="fusion adapter"></a>fusion adapter</h4><p>once we can read all raw signals from mf4 files, then need to package these signals as the upper-level application requires. e.g. fusion, aeb input structs.</p>
<p>taking fusion module as example. the input includes radar structure, camera structure, e.t.c, something like:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">radar_sensor_pack</span><span class="params">()</span>:</span></div><div class="line">	self.objID, </div><div class="line">        self.objExistProb ,</div><div class="line">        self.objDistx,</div><div class="line">        self.objDisty, </div><div class="line">        self.objRelVelx,</div><div class="line">        self.objRelVely, </div><div class="line">        ...</div></pre></td></tr></table></figure>
<p>data collection is done by Vector CANape, the sensor pack is defined in <code>*.dbc</code> file, so here basically does package <code>dbc</code> signals to a Python sensor_object, and then assign this sensor_object with the values from mdf4 files.</p>
<p>we need define a bunch of fusion_adapter to package all the necessary inputs for each module, e.g. fusion, aeb e.t.c</p>
<h4 id="rosAdapter"><a href="#rosAdapter" class="headerlink" title="rosAdapter"></a>rosAdapter</h4><p>another kind of usage from mf4 file, is transfer mf4 to rosbag. due to most ADS dev/debug/verifcation tools currently are based on ros env. on the other hand, ros base data collection is not robost enough than CANape, so the data collection is in <code>*.mf4</code>. </p>
<ul>
<li>build ros message and define ros_sensor_obj</li>
</ul>
<p>as asammdf reader is in python, here can build ros message into python module, as mentioned prevously. as ros message built is with <code>catkin_make</code>, which is based on python2.7, so need add the <code>sensor_msgs</code> python module path to $PYTHONPATH in the <code>conda env fusion</code>. </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> PYTHONPATH=/home/gitlab_/mf4io/linux/toRosbag/catkin_ws/install/lib/python2.7/dist-packages</div></pre></td></tr></table></figure>
<p>basically, we use <code>python3</code> shell, but we add the <code>catkin_ws/python2.7</code> to its PYTHONPATH.</p>
<ul>
<li>write rosbag </li>
</ul>
<p>then we can fill in <code>ros_sensor_obj</code> from mf4 structures. and write to bag.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">self.bag.write(<span class="string">'/bose_cr/radar/front_right/object'</span>, ros_sensor_obj.data)</div></pre></td></tr></table></figure>
<h4 id="rosbag-know-how"><a href="#rosbag-know-how" class="headerlink" title="rosbag know-how"></a>rosbag know-how</h4><ul>
<li><a href="http://wiki.ros.org/rosbag/Commandline" target="_blank" rel="external">rosbag filter</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rosbag filter 20200619-xx.bag  only-mrr.bag <span class="string">"topic==`/bose_mrr/radar/front/object`"</span></div></pre></td></tr></table></figure>
<ul>
<li><a href="http://wiki.ros.org/ROS/Tutorials/reading%20msgs%20from%20a%20bag%20file" target="_blank" rel="external">read message from a bag file</a></li>
</ul>
<h2 id="refere"><a href="#refere" class="headerlink" title="refere"></a>refere</h2><p><a href="https://github.com/lxml/lxml" target="_blank" rel="external">lxml</a></p>
<p><a href="https://github.com/ebroecker/canmatrix" target="_blank" rel="external">canmatrix</a></p>
<p><a href="https://github.com/danielhrisca/asammdf" target="_blank" rel="external">asammdf</a></p>
<p><a href="https://stackoverflow.com/questions/2592764/what-does-a-b-prefix-before-a-python-string-mean" target="_blank" rel="external">what does a b prefix before a python string mean</a></p>
<p><a href="https://www.tutorialspoint.com/numpy/numpy_data_types.htm" target="_blank" rel="external">numpy data type</a></p>
<p><a href="http://wiki.ros.org/rosbag/Code%20API#cpp_api" target="_blank" rel="external">write rosbag api</a></p>
<p><a href="http://wiki.ros.org/ROS/Tutorials/Recording%20and%20playing%20back%20data" target="_blank" rel="external">record and play back data</a></p>
<p><a href="https://github.com/ElectricRCAircraftGuy/eRCaGuy_dotfiles/blob/master/useful_scripts/ros_readbagfile.py" target="_blank" rel="external">ros_readbagfile.py</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/28/so-ViL-now/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/06/28/so-ViL-now/" itemprop="url">so ViL, now</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-28T08:26:20-04:00">
                2020-06-28
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/06/28/so-ViL-now/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/06/28/so-ViL-now/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="background"><a href="#background" class="headerlink" title="background"></a>background</h2><p>usually Software-in-Loop(SiL) test and verification is defined to cover 90% of all ADS scenarios, then about 9% is test in HiL or ViL, the last 1% is on the real road. so we are on the way to product, so here is ViL.</p>
<h2 id="why-ViL"><a href="#why-ViL" class="headerlink" title="why ViL ?"></a>why ViL ?</h2><p>Vehicle-in-Loop(ViL) is the last second step in evaluation and verification before releasing a new vehicle product. as ViL is close to the real car system. the benefits is to offer the real vehicle dynamic, which means the real vehicle respond and delay e.t.c. </p>
<p>for functions/features development, ViL also helps to calibrate the boundary of some system parameters, which saves a lot of energy of calibration engineers, as they don’t need to the test field and prepare and run the real vehicles day by day.</p>
<h2 id="how-ViL-works"><a href="#how-ViL-works" class="headerlink" title="how ViL works ?"></a>how ViL works ?</h2><p>the logic of ViL is to integrate the real vehicle (dynamic) into a virtual test environment(VTE):</p>
<ul>
<li><p>forward: the real vehicle send vehicle dynamic data(vehicle position, heading, speed e.t.c) to VTE;</p>
</li>
<li><p>backward: VTE split out env information to the real vehicle, which is handled by SoC in vehicle. </p>
</li>
</ul>
<p> so first need prepare a VTE, which has the ability to support external vehicle dynamic(VD) plugin, which is a common feature of VTE, e.g. <a href="https://www.lgsvlsimulator.com/docs/ego-vehicle-dynamics/" target="_blank" rel="external">lgsvl full model interface</a></p>
<p>secondly, VTE has the ability to export sensor data, which includes exporting data type and exporting data protocol. the common solution is <code>rosbag</code> through <code>ros</code> communication.</p>
<h2 id="ViL-in-reality"><a href="#ViL-in-reality" class="headerlink" title="ViL in reality"></a>ViL in reality</h2><p>the ideal way of plugin real vehicle dynamic into VTE is throuh full-model-interface(FMI), which is especially true for SiL. </p>
<p>for forward data, vehicle dynamic data here only requies real vehicle position information, which can be obtained in a few ways. from vehicle CAN bus, or from RTK sensor, or from upper application layer, e.g. vehicle status module. but most VTE normally support ros message parsing, rather than CAN message parsing. so additionaly need to define a CAN-ROS message adapter. </p>
<p>for backward data, most VTE(e.g. LG) does have some kind of message channels, e.g. sensor ros topices, which can be used to publish the virtual environment information(sensor data). or VTE may have well-supported sensor message exporter.</p>
<h2 id="limitations"><a href="#limitations" class="headerlink" title="limitations"></a>limitations</h2><p>the ViL solution above is an useable and very customized solution, so the extenable ability and data/model precision is limited. </p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/28/where-are-you-in-next-4-years-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/06/28/where-are-you-in-next-4-years-3/" itemprop="url">where are you in next 4 years(3)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-28T08:19:43-04:00">
                2020-06-28
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/06/28/where-are-you-in-next-4-years-3/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/06/28/where-are-you-in-next-4-years-3/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>temparately, we have high and low, and of course whether you are a safe-well person tells a lot. </p>
<p>I rejected SxxCVxxW, as the interchange doesn’t tell any difference, the only thing is a new brand and a new office. I am looking for some really changes. </p>
<p>but what’s that ? I still can’t say, maybe recently I am almost lost the focus. things happen recently:</p>
<p>Tesla of course, is leading the rocket rising, with new features in AutoPilot, and new vehicle models always on the way. then Zoox is purchused by Amazon with 1.2 billion USD, how these solution-focused start-ups survive become really interesting now; in China, the top 3 new energy start-ups, namely, Nio, LiXiang, XiaoPeng are beyond self-driving solution lonely, but car makers. and their vehicle model is not that productive, but kind of found a way to survive in Chiese market; the MaaS service providers, such as Didi, Ponyai, WeRide, AutoX are still on the way, and push really harsh to make some noise in Shanghai, Guangzhou and other cities. of course, Waymo, as the top one MaaS service provider globally is also finding its way to break through, just bind to Volvo. </p>
<p>individuals and teams are working really hard to find out the way, but <strong>where is the way</strong>, or at least what’s the right direction in self-driving in next 5 ~ 10 years. technically, there may be still lots of engineering and research work to do; in bussiniess side, looks car-maker teams are really making some progress, just like Tesla, or other traditional OEMs, they follow the gradually evaluation solution to OTA upgrade the vehciles little by little. </p>
<p>However, it’s just unbelievable to belive OEM teams can lead such a great disruptive innovation in future human life, rather than these innovative and culture-diverse high-tech start-up teams.</p>
<p>there is a foundamental paradox between bussiness and creativity. this is a capital driven bussiness world, every new product is born to create a new needs for human consumers, even more and more <strong>needs</strong> are unnecessary or anti-human, does this make kind of creativities sound unhuman or irrationaly? I don’t want to answer this question, as I am in one of these teams, and I am even eager to learn how to make success through these creativities.</p>
<p>anyway, I am staying in an OEM supported start-up now, and running on the way to product some model next year. I don’t know where is the way later, and I am afraid this half year is not easy. </p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/27/play-with-boost-python-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/06/27/play-with-boost-python-2/" itemprop="url">play with boost.python 2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-27T07:53:57-04:00">
                2020-06-27
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/06/27/play-with-boost-python-2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/06/27/play-with-boost-python-2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="background"><a href="#background" class="headerlink" title="background"></a>background</h2><p>in <a href="https://zjli2013.github.io" target="_blank" rel="external">1</a>, we have a basic work flow of boost.python. in reality, the C++ project may have multi headers, where define many structs/classes, and include nested structs. here we give an simple example of nested struct/class.</p>
<h4 id="api-header-hpp"><a href="#api-header-hpp" class="headerlink" title="api_header.hpp"></a>api_header.hpp</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">	<span class="keyword">float</span> time; </div><div class="line">	<span class="keyword">float</span> dx ;</div><div class="line">	<span class="keyword">float</span> dy ;</div><div class="line">&#125; AEB;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">	AEB out1 ;</div><div class="line">&#125; OP;</div></pre></td></tr></table></figure>
<h4 id="aeb-hpp"><a href="#aeb-hpp" class="headerlink" title="aeb.hpp"></a>aeb.hpp</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"api_header.hpp"</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">aeb</span> &#123;</span></div><div class="line">    <span class="keyword">public</span>:</div><div class="line">        aeb() &#123;&#125;</div><div class="line">	OP op_out ;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">test_op</span><span class="params">()</span></span>&#123;</div><div class="line">            (<span class="keyword">void</span>) <span class="built_in">memset</span>((<span class="keyword">void</span> *)&amp;op_out, <span class="number">0</span>, <span class="keyword">sizeof</span>(OP)); </div><div class="line">            op_out.out1.time = <span class="number">1.0</span> ; </div><div class="line">            op_out.out1.dx = <span class="number">2.0</span> ;</div><div class="line">            op_out.out1.dy = <span class="number">3.0</span> ; </div><div class="line">            AEB o1 = op_out.out1 ;</div><div class="line">            <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; o1.time &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span> ;</div><div class="line">        &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>for each of them, we can write a separate wrapp files.</p>
<h4 id="api-wrapper-cpp"><a href="#api-wrapper-cpp" class="headerlink" title="api_wrapper.cpp"></a>api_wrapper.cpp</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Python.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;boost/python.hpp&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"api_struct.h"</span></span></div><div class="line"></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> boost::python;</div><div class="line"></div><div class="line">BOOST_PYTHON_MODULE(api_wrapper) &#123;  </div><div class="line">    </div><div class="line">    class_&lt;AEB&gt;(<span class="string">"AEB"</span>, <span class="string">"aeb struct"</span>)</div><div class="line">            .def_readwrite(<span class="string">"time"</span>, &amp;AEB::time)</div><div class="line">            .def_readwrite(<span class="string">"dx"</span>, &amp;AEB::dx)</div><div class="line">            .def_readwrite(<span class="string">"dy"</span>, &amp;AEB::dy) ;</div><div class="line"></div><div class="line">    class_&lt;OP&gt;(<span class="string">"OP"</span>, <span class="string">"OP struct"</span>)</div><div class="line">            .def_readwrite(<span class="string">"out1"</span>, &amp;OP::out1);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="aeb-wrapper-cpp"><a href="#aeb-wrapper-cpp" class="headerlink" title="aeb_wrapper.cpp"></a>aeb_wrapper.cpp</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Python.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;boost/python.hpp&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"student.h"</span></span></div><div class="line"></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> boost::python;</div><div class="line"></div><div class="line">BOOST_PYTHON_MODULE(aeb) &#123;                                                                                                                                                                              </div><div class="line">    scope().attr(<span class="string">"__version__"</span>) = <span class="string">"1.0.0"</span>;</div><div class="line">    class_&lt;aeb&gt;(<span class="string">"aeb"</span>, <span class="string">"a class of aeb ADAS"</span>)</div><div class="line">        .def(init&lt;&gt;())</div><div class="line">        .def(init&lt;<span class="built_in">std</span>::<span class="built_in">string</span>, <span class="keyword">int</span>&gt;())</div><div class="line">        .def_readwrite(<span class="string">"op_out"</span>, &amp;aeb::op_out)</div><div class="line">        .def(<span class="string">"test_op"</span>, &amp;aeb::test_op, <span class="string">"test op"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>compared to previous blog, we had <code>def_readwrite()</code> to include the nested struct in <code>aeb</code> python module, which is dynamic linked during python runtime, so which requires to import <code>api_header</code> module first, then import <code>aeb</code> module.</p>
<h4 id="build-amp-amp-test"><a href="#build-amp-amp-test" class="headerlink" title="build &amp;&amp; test"></a>build &amp;&amp; test</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">g++ -I/home/anaconda3/envs/aeb/include/python3.6m -I/usr/<span class="built_in">local</span>/include/boost -fPIC wrap_api.cpp -L/usr/<span class="built_in">local</span>/lib/ -lboost_python36 -shared -o wrap_api.so</div><div class="line"></div><div class="line">g++ -I/home/anaconda3/envs/aeb/include/python3.6m -I/usr/<span class="built_in">local</span>/include/boost -fPIC wrap_student.cpp -L/usr/<span class="built_in">local</span>/lib/ -lboost_python36 -shared -o student.so</div></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> wrap_api</div><div class="line"><span class="keyword">import</span> aeb</div><div class="line">s = aeb.aeb()</div><div class="line">s.test_op()</div><div class="line">a = s.op_out.out1 </div><div class="line">a.time</div><div class="line">a.dx</div></pre></td></tr></table></figure>
<h2 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h2><p>this basic workflow is enough to package Matlab/Simulink ADAS models C++ code to Python test framework. </p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/26/boost-python-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/06/26/boost-python-1/" itemprop="url">boost.python 1</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-26T07:19:15-04:00">
                2020-06-26
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/06/26/boost-python-1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/06/26/boost-python-1/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="background"><a href="#background" class="headerlink" title="background"></a>background</h2><p>in OEM’s ADS team, there are bunch of model-based design engineers, who build the ADAS features based on Matlab/Simulink tools, which is good to build quick demos, when comes to massive data verification, we can’t really depends on Matlab solver, which is so slow and licensed. </p>
<p>so a common idea is to recompile the Matlab/Simulink model to C/C++ code, which can further embedded to more open envs, e.g. python or C++.</p>
<p>as previously mentioned, we had designed a rq based massive data driven test framework, so the gap from C++ ADAS code to this python test framework is fixed in this blog.</p>
<p>there are a few wasy to integrate C++ code to Python, one is <code>Boost.Python</code>: </p>
<h2 id="setup"><a href="#setup" class="headerlink" title="setup"></a>setup</h2><p><a href="https://www.boost.org/doc/libs/1_73_0/more/getting_started/unix-variants.html" target="_blank" rel="external">install boost</a></p>
<p><a href="https://www.boost.org/doc/libs/1_72_0/libs/python/doc/html/building/configuring_boost_build.html" target="_blank" rel="external">configuring Boost.BUild</a></p>
<p>python env :  3.6 (from conda env aeb)<br>gcc:  4.5.0 </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> BOOST_BUILD_PATH=`<span class="built_in">pwd</span>`   <span class="comment">#where we keep `user-config.jam`</span></div></pre></td></tr></table></figure>
<h4 id="user-config-jam"><a href="#user-config-jam" class="headerlink" title="user-config.jam"></a>user-config.jam</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="string">using</span> <span class="string">gcc</span> <span class="string">:</span> <span class="number">5.4</span><span class="number">.0</span> <span class="string">:</span> <span class="string">/usr/bin/g++</span> <span class="string">;</span></div><div class="line"></div><div class="line"><span class="string">using</span> <span class="string">python</span> <span class="string">:</span> <span class="number">3.6</span></div><div class="line">        <span class="string">:</span> <span class="string">"/home/anaconda3/envs/aeb/bin/python"</span></div><div class="line">        <span class="string">:</span> <span class="string">"/home/anaconda3/envs/aeb/include"</span></div><div class="line">        <span class="string">:</span> <span class="string">"/home/anaconda3/envs/aeb/include/python3.6m"</span> <span class="string">;</span> </div><div class="line"><span class="string">```</span> </div><div class="line"></div><div class="line"><span class="string">bootstrap</span> <span class="string">will</span> <span class="string">find</span> <span class="string">`user-config.jam`</span> <span class="string">from</span> <span class="string">$BOOST_BUILD_PATH.</span> </div><div class="line"></div><div class="line"><span class="string">```sh</span> </div><div class="line"><span class="string">cd</span>  <span class="string">/path/to/boost_1_73_0</span></div><div class="line"><span class="string">./bootstrap.sh</span> <span class="bullet">--help</span></div><div class="line"><span class="string">./bootstrap.sh</span> <span class="bullet">--prefix=/usr/local/</span> <span class="bullet">--show-libraries</span></div><div class="line"><span class="string">b2</span> <span class="bullet">--with-python</span> <span class="bullet">--prefix="/usr/local/"</span> <span class="string">install</span> <span class="string">variant=release</span> <span class="string">link=static</span> <span class="string">address-model=64</span> </div><div class="line"><span class="string">b2</span> <span class="bullet">--clean</span></div></pre></td></tr></table></figure>
<p><a href="https://cloud.tencent.com/developer/article/1011767" target="_blank" rel="external">a sample of user-config.jam</a></p>
<ul>
<li>error fixing </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">fatal error: pyconfig.h: No such file or directory</div><div class="line">compilation terminated.</div></pre></td></tr></table></figure>
<p>need <code>export CPATH=~/anaconda/envs/aeb/include/python3.6m/</code>,  where located <code>pyconfig.h</code> and other headers</p>
<p>finally report: boost.python build successfully !</p>
<h2 id="demo-run"><a href="#demo-run" class="headerlink" title="demo run"></a>demo run</h2><p>the following is simple sample of how to use boost_python wrapper to wrapping an AEB model(in c++) to python</p>
<h4 id="aeb-h"><a href="#aeb-h" class="headerlink" title="aeb.h"></a>aeb.h</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">	<span class="keyword">float</span> time; </div><div class="line">	<span class="keyword">float</span> dx ;</div><div class="line">	<span class="keyword">float</span> dy ;</div><div class="line">&#125; AEB;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">	AEB out1 ;</div><div class="line">&#125; OP;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">aeb</span> &#123;</span></div><div class="line">    <span class="keyword">public</span>:</div><div class="line">        Student() &#123;&#125;</div><div class="line">	OP op_out ;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">test_op</span><span class="params">()</span></span>&#123;</div><div class="line">            (<span class="keyword">void</span>) <span class="built_in">memset</span>((<span class="keyword">void</span> *)&amp;op_out, <span class="number">0</span>, <span class="keyword">sizeof</span>(OP)); </div><div class="line">            op_out.out1.time = <span class="number">1.0</span> ; </div><div class="line">            op_out.out1.dx = <span class="number">2.0</span> ;</div><div class="line">            op_out.out1.dy = <span class="number">3.0</span> ; </div><div class="line">            AEB o1 = op_out.out1 ;</div><div class="line">            <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; o1.time &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span> ;</div><div class="line">        &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h4 id="wrap-aeb-cpp"><a href="#wrap-aeb-cpp" class="headerlink" title="wrap_aeb.cpp"></a>wrap_aeb.cpp</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Python.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;boost/python.hpp&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;boost/python/suite/indexing/vector_indexing_suite.hpp&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"aeb.h"</span></span></div><div class="line"></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> boost::python;</div><div class="line"></div><div class="line">BOOST_PYTHON_MODULE(aeb) &#123;</div><div class="line">    scope().attr(<span class="string">"__version__"</span>) = <span class="string">"1.0.0"</span>;</div><div class="line">    scope().attr(<span class="string">"__doc__"</span>) = <span class="string">"a demo module to use boost_python."</span>;</div><div class="line">    class_&lt;aeb&gt;(<span class="string">"aeb"</span>, <span class="string">"a class of aeb"</span>)</div><div class="line">        .def(init&lt;&gt;())</div><div class="line">        .def(<span class="string">"test_op"</span>, &amp;aeb::test_op, <span class="string">"test op"</span>)</div><div class="line">        .def_readonly(<span class="string">"op_out"</span>, &amp;aeb::op_out)</div><div class="line">&#125;</div><div class="line"></div><div class="line">``` </div><div class="line"></div><div class="line">tips, <span class="keyword">if</span> aeb.h <span class="keyword">and</span> aeb.cpp are separated files, it's better to merge them first;  <span class="keyword">for</span> nested structure in wrapper is another topic later.</div><div class="line"></div><div class="line">###<span class="meta"># build and python import </span></div><div class="line"></div><div class="line">* check header location</div><div class="line"></div><div class="line">      Python.h @ `/home/anaconda3/envs/aeb/include/python3<span class="number">.6</span>m`</div><div class="line"></div><div class="line">      boost/python @ `/usr/local/include/boost`</div><div class="line"></div><div class="line">* check .so lib location</div><div class="line">     </div><div class="line">       /usr/local/lib/</div><div class="line"></div><div class="line"></div><div class="line">tips, <span class="keyword">if</span> there is duplicated `boost lib` in system, e.g. `/usr/lib/x86_64-linxu-gnu/libboost_python.so` which maybe conflict with `boost_python` install location at `/usr/local/lib/libboost_python36.so`</div><div class="line"></div><div class="line">* build </div><div class="line"></div><div class="line">```sh</div><div class="line">g++ -I/home/anaconda3/envs/aeb/include/python3<span class="number">.6</span>m -I/usr/local/include/boost -fPIC wrap_aeb.cpp -L/usr/local/lib/ -lboost_python36 -shared -o aeb.so</div></pre></td></tr></table></figure>
<ul>
<li>test </li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> aeb</div><div class="line">t = aeb.aeb</div><div class="line">t.test_op()</div></pre></td></tr></table></figure>
<h2 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h2><p>this blog gives the basic idea how to use <code>boost.python</code> to integrate c++ to python test framework. there are plenty details need fixed, e.g. nested structures, share_pointers. maybe share in next blog.</p>
<h4 id="refere"><a href="#refere" class="headerlink" title="refere"></a>refere</h4><p><a href="https://www.boost.org/doc/libs/1_66_0/libs/python/doc/html/tutorial/index.html" target="_blank" rel="external">boost.python tutorial</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/22/play-with-ros-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/06/22/play-with-ros-2/" itemprop="url">play with ros 2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-22T08:32:13-04:00">
                2020-06-22
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/06/22/play-with-ros-2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/06/22/play-with-ros-2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="ros-msgs"><a href="#ros-msgs" class="headerlink" title="ros msgs"></a>ros msgs</h4><p>ros msgs usually used in C++, as our ADS data tool is implemented in Python, I’d try to build <code>*.msg</code> to python module. find two blogs from ROS doc: </p>
<p><a href="http://wiki.ros.org/rospy_tutorials/Tutorials/Makefile" target="_blank" rel="external">writing a ROS python Makefile</a></p>
<p><a href="http://wiki.ros.org/ROS/Tutorials/CreatingMsgAndSrv#Common_step_for_msg_and_srv" target="_blank" rel="external">create a ros msg</a></p>
<p>to build msg into python module, the <code>package.yml</code> should at least include the following lines:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="string">&lt;buildtool_depend&gt;catkin&lt;/buildtool_depend&gt;</span></div><div class="line"><span class="string">&lt;build_depend&gt;message_generation&lt;/build_depend&gt;</span></div><div class="line"><span class="string">&lt;build_export_depend&gt;rospy&lt;/build_export_depend&gt;</span></div><div class="line"><span class="string">&lt;build_export_depend&gt;std_msgs&lt;/build_export_depend&gt;</span></div><div class="line"><span class="string">&lt;exec_depend&gt;rospy&lt;/exec_depend&gt;</span></div><div class="line"><span class="string">&lt;exec_depend&gt;std_msgs&lt;/exec_depend&gt;</span></div></pre></td></tr></table></figure>
<p>the default <code>CMakeList.txt</code> looks like: </p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="string">find_package(catkin</span> <span class="string">REQUIED</span> <span class="string">COMPONENTS</span></div><div class="line">	<span class="string">roscpp</span></div><div class="line">	<span class="string">rospy</span></div><div class="line">	<span class="string">std_msgs</span></div><div class="line">	<span class="string">message_generation</span></div><div class="line"><span class="string">)</span> </div><div class="line"></div><div class="line"><span class="string">add_message_files(</span></div><div class="line">	<span class="string">FILES</span></div><div class="line">	<span class="string">custom.msg</span></div><div class="line"><span class="string">)</span></div><div class="line"></div><div class="line"><span class="string">generate_messages(</span></div><div class="line">	<span class="string">DEPENDENCIES</span></div><div class="line">	<span class="string">std_msgs</span></div><div class="line"><span class="string">)</span></div></pre></td></tr></table></figure>
<p>the generated msg python module is located at <code>~/catkin_ws/devel/lib/python2.7/dist-packages/my_msg_py/msg</code>,which can add to <code>$PYTHONPATH</code> for later usage</p>
<h4 id="create-ros-node-with-catkin"><a href="#create-ros-node-with-catkin" class="headerlink" title="create ros node with catkin"></a>create ros node with catkin</h4><p>first check your <code>$ROS_PAKCAGE_PATH</code>, the default pkg path is <code>/opt/ros/kinetic/share</code>, append custom pkgs path from <code>~/cakin_ws/devel/share</code>. </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> ~/my_catkin_ws/src</div><div class="line">catkin_create_pkg my_pkg [dependencies, e.g. sd_msgs rospy]</div><div class="line">rospack find</div></pre></td></tr></table></figure>
<p><code>catkin_create_pkg</code> will create a <code>CMakeList.txt</code> at pkg level, and a <code>src</code> folder, where can hold custom nodes definition.</p>
<h4 id="sensor-serial-data-to-ros-node"><a href="#sensor-serial-data-to-ros-node" class="headerlink" title="sensor serial data to ros node"></a>sensor serial data to ros node</h4><p>sensors(e.g. rtk, imu) to ros is communication from external world to ros sys. Things need to take care:  mostly sensor hardware device doesn’t support ROS driver directly, so first need device serial or CAN or Ethernet to get the raw sensor data, and package it as <code>sensor/raw_msg</code> to publish out; the real ros-defined sensor node, will subscribe <code>sensor/raw_msg</code> and publish the repackaged <code>sensor/data</code> to the ros system, (which usually happened in ros callback).</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">rtk_cb</span><span class="params">(std_msgs::ByteMultiArray raw_msg)</span>:</span></div><div class="line">    rtk_msg = func(raw_msg)</div><div class="line">    pub.publish(rtk_msg)</div><div class="line"></div><div class="line">pub = nodeHandler.advertise&lt;sensor_msgs:NavSatFix&gt;(<span class="string">"/rtk_gps/data"</span>, <span class="number">1</span>)</div><div class="line">sub = nodeHandler.subscribe(<span class="string">"/rtk_gps/raw_data"</span>, <span class="number">1</span>, rtk_cb)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">raw_data_generator</span><span class="params">()</span>:</span></div><div class="line">	<span class="keyword">try</span>:	</div><div class="line">		<span class="keyword">with</span> open(<span class="string">"/dev/ttyS0"</span>, <span class="string">"r|w"</span>) <span class="keyword">as</span> fd:</div><div class="line">			header = read(fd, buf, header_line)</div><div class="line">			<span class="keyword">while</span> ros::ok():</div><div class="line">				content = read(fd, buf, content_lines)</div><div class="line">				std::msgs::ByteMultiArray raw_msg </div><div class="line">				raw_msg.data.push_back(header)</div><div class="line">				raw_msg.data.push_back(content)	</div><div class="line">				pub.publish(raw_msg)</div><div class="line">		close(fd)</div><div class="line">	<span class="keyword">except</span>:</div><div class="line">		print(<span class="string">"failed to read raw data\n"</span>)</div></pre></td></tr></table></figure>
<h4 id="sensor-CAN-data-to-ros-node"><a href="#sensor-CAN-data-to-ros-node" class="headerlink" title="sensor CAN data to ros node"></a>sensor CAN data to ros node</h4><p>sensors(such as camera, radar, lidar e.t.c) go to ros sys through Veh CAN Bus. the difference between <strong>CAN</strong> msg and <strong>serial</strong> msg is data atomicity. as serial msg is only one variable, which gurantee atomicity in application level;  while each CAN frame usually include a few variables, which need custom implement atomicity in application level. </p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">thread0 = pthread_create(recv_thread, raw_can_data)</div><div class="line">thread1 = pthread_create(send_thread)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">thread0</span><span class="params">()</span>:</span></div><div class="line"> 	 recv_data = func(raw_can_data)</div><div class="line">	 pthread_mutex_lock(mutex_lock)</div><div class="line">	 sensor_raw = recv_data </div><div class="line">	 sem_post(sem_0)</div><div class="line">	 pthread_mutex_unlock(mutex_lock)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">thread1</span><span class="params">()</span>:</span></div><div class="line">	pthread_mutex_lock(mutex_lock)</div><div class="line">	sensor_ros_msg =  sensor_raw </div><div class="line">	pthread_mutex_unlock(mutex_lock)</div><div class="line">	node_.publish(sensor_ros_msg)</div></pre></td></tr></table></figure>
<h4 id="ros-node-to-external-device"><a href="#ros-node-to-external-device" class="headerlink" title="ros node to external device"></a>ros node to external device</h4><p>another kind of communication, is from ros system to external device/env, such as dSPACE. the external device, if not communication through serial, then usually support Ethernet(udp/tcp), which then need to implement a custom udp/tcp data recv/send func. the ros node subscribe the necessary data, then send it out through udp/tcp.</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">cb</span><span class="params">(sensor_msg)</span>:</span></div><div class="line">	data = repack(sensor_msg)</div><div class="line">	udp.send(data)</div><div class="line"></div><div class="line">sub = nodeHandler.subscribe(<span class="string">"/useful/data"</span>, <span class="number">1</span>, cb)</div></pre></td></tr></table></figure>
<h4 id="xml-rpc-amp-amp-tcpros"><a href="#xml-rpc-amp-amp-tcpros" class="headerlink" title="xml-rpc &amp;&amp; tcpros"></a>xml-rpc &amp;&amp; tcpros</h4><p>the ros sytem has two communication, to register/update ros node, publish/subscribe topics to ros master. this kind of message go through <code>xml-rpc</code>. after worker nodes registered in master node, the P2P communication can generated, and the data is transfered through <code>tcpros</code>. </p>
<p>each ros node has a <code>xml-rpc</code> server, in code, <code>nodeHandler.advertise()</code> called in publisher/subscriber node, to register their topices to ros master.</p>
<p>once a subscribe node register to master, which topics it subscribed, master returns a URI as response, then the subscriber and publisher can build connection through this URI. when a publish node register to master, master call <code>publisherUpdate()</code> to notify all subscriber, who subscribe topices from this publisher.</p>
<h4 id="ros-visual-rviz"><a href="#ros-visual-rviz" class="headerlink" title="ros visual(rviz)"></a>ros visual(rviz)</h4><p><a href="https://github.com/jstnhuang/ros-rviz" target="_blank" rel="external">ros-rviz</a></p>
<ul>
<li>how rviz works ?</li>
</ul>
<p>If you want to create a node providing a set of interactive markers, you need to instantiate an InteractiveMarkerServer object. This will handle the connection to the client (usually RViz) and make sure that all changes you make are being transmitted and that your application is being notified of all the actions the user performs on the interactive markers. </p>
<p><img src="http://wiki.ros.org/rviz/Tutorials/Interactive%20Markers:%20Getting%20Started?action=AttachFile&amp;do=get&amp;target=interactive_marker_architecture.png" alt="image"></p>
<ul>
<li>rviz rosbag </li>
</ul>
<p><strong>rviz config</strong> can customize the rviz display, the default located at <code>~/.rviz/default.rviz</code>. </p>
<p>the idea to play rosbag and render in rviz is to define a custom node, to receive the custom <code>pkg_msg</code> from replayed rosbag, then repckage <code>pkg_msg</code> as corresponded <code>marker/markerArray</code>, then publish these msg out, which will be received by <code>rviz</code></p>
<p>usually we define a custom node to receive replayed topics from <code>rosbag.play()</code>, and define a callback func to publish its marker objects out. </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">ros::Publisher markerArray </div><div class="line">def pkg_cb(sensor_pkg):</div><div class="line">	for objIdx in sensor_pkg.ObjNum:</div><div class="line">		prepare_marker(marker, sensor_pkg.objects[objIdx]</div><div class="line">		SensorDisplay.markers.append(marker)	</div><div class="line">	markerArray.publish(SensorDisplay)</div><div class="line">	SensorDisplay-&gt;markers.clear()</div><div class="line"></div><div class="line">subPkg = nodeHandler.subscribe("sensor_pkg", 1, pkg_cb);</div><div class="line">markerArray = nodeHandler.advertise&lt;visulization_msgs::MarkerArray&gt;("sensor_pkg", 1)</div></pre></td></tr></table></figure>
<h4 id="ros-summary"><a href="#ros-summary" class="headerlink" title="ros summary"></a>ros summary</h4><p>ros is a very common communciation way and message type in ADS dev, many demo are implemented based on ros, which gives a bunch of ros related tools. in this blog, we review three of them:</p>
<ul>
<li>ros based sensor device data collection </li>
<li>ros rviz </li>
<li>rosbag.play </li>
</ul>
<p>which can support a few kinds of applications, e.g. debuging, replay, data collection.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/04/redis-queue-rq-in-data-processing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/06/04/redis-queue-rq-in-data-processing/" itemprop="url">redis queue(rq) in data processing</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-04T08:49:49-04:00">
                2020-06-04
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/06/04/redis-queue-rq-in-data-processing/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/06/04/redis-queue-rq-in-data-processing/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="background"><a href="#background" class="headerlink" title="background"></a>background</h2><p>recently thinking about how to design middleware and frameworks in self-driving team, just like the back-end service in most web servicees, which gives the way to go uppper and go abstract. currently many start-up ADS team, espcially Internet-based start-ups, have built-in ADS frameworks and middlewares, to support their daily dev and easily to implement new features. here is an old topic, <a href="https://zjli2013.github.io/2020/04/28/redis-task-queue-2/" target="_blank" rel="external">redis task queue</a>, how to design a robost <code>data pipeline</code> to support ADAS/ADS functions virtual test with physical collected road data.</p>
<p>the experience to put lgsvl into swarm/k8s brings the idea about <code>micro-services</code>, which is a great way to decouple a large work to a few small pieces of independent but communicatable services. so when coming to handle large data set, which is very common in ADS dev. </p>
<p>so the first idea is to decouple the <code>data pipeline</code> as a few micro-services:  reader service, process service, post-analysis service e.t.c</p>
<p>then two questions immediately up:  which data/message type fits, which network communication protocol fits.and beyond these two basic questions, also need a lot work about message adapter among/in services. previously, I designed <code>websocket and json</code> solution. but it’s too tedious to plug in a <code>ws-server/client</code> at the front/end of each service, especially as the number of serivces grows. </p>
<p>take it back, <code>data pipeline</code> is a heavy data IO work, is it really smart to split the work into a few pieces, then find the network communication among them ? we increase the system complex by introducing additional network communcation moduels, and the only benefit is decouple a heavy data IO work. and more, the network modules need consider cache, job scheduler, load balance issues, as the data process service may take much longer than reader services. </p>
<p>traditionally, heavy data IO work is common run in <code>batch processing</code>, disregarding network issues, and it’s better to run directly in memory/cache. so I go to <a href="https://github.com/rq/rq" target="_blank" rel="external">rq</a></p>
<h2 id="interprocess-communication-in-distributed-system"><a href="#interprocess-communication-in-distributed-system" class="headerlink" title="interprocess communication in distributed system"></a>interprocess communication in distributed system</h2><p><code>MPI</code> is the standard for IPC in HPC apps, of course there are <code>Linux IPC</code> libs, which brings more low-level ipc APIs. <code>MPI</code> apps mostly run on high performance computing cluster, which has the samilar API e.g. <code>Allreduce</code> as <code>Hadoop/MapReduce</code>, while the difference <code>MPI/allReduce</code> doesn’t tolerate failure, which means any node failed, the <code>MPI</code> apps failed. Which is the foundmental difference from HPC to distributed system nowadays, really popular as the new infrastructure for cloud and AI. </p>
<p>in the distributed system, there are a few ways to do interprocess communication:</p>
<ul>
<li><p><strong>RESTful protocol</strong>, such as TCP, UDP, websocket. </p>
</li>
<li><p><strong>async communication</strong>, there are different ways to implement async interprocess communication, one way is <code>message queue</code>, of course many language, e.g. js, go have some light-weight libs/framework to support ansyc communication interprocessly.</p>
</li>
<li><p><strong>rpc</strong>, <a href="">thrift</a> is an Apache project, <a href="">grpc</a> is high efficient with protobuf, but it doesn’t support well service discovery/load balance mechanism inside, which is a limitation in cloud-native applications.  <a href="">dubbo</a> has a better design for service discovery and load balance, the message type by default is <code>json</code>. so all of these can be the corner-stone service in modern micro service envs. also the common <code>micro-service framework</code>, e.g. Spring Cloud has interprocess communication component as well.</p>
</li>
</ul>
<p>for data hungry services, <code>batch processing</code> frameworks, e.g. Spring Batch, Linux Parallel should also consider.</p>
<h2 id="rq"><a href="#rq" class="headerlink" title="rq"></a>rq</h2><p>the following is from <a href="http://python-rq.org/docs/" target="_blank" rel="external">rq doc</a></p>
<h4 id="Queues"><a href="#Queues" class="headerlink" title="Queues"></a>Queues</h4><p>a <code>job</code> is a Python object, namely a function that is invoked async in a worker process. <code>enqueueing</code> is simply pushing a reference to the func and its ars onto a queue.</p>
<p>we can add as many Queue instance as we need in one Redis instance, the Queue instance can’t tell each other, but they are hosted in the same redis instance, which gives the way to find jobs binding to Queue1 in worker2 from Queue2</p>
<h4 id="jobs"><a href="#jobs" class="headerlink" title="jobs"></a>jobs</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">job1 = q.enqueue(my_func, func_args)</div><div class="line">job2 = Job.create(my_func, ttl=<span class="number">100</span>, failure_ttl=<span class="number">10</span>, depends_on=, description=, func_args)</div><div class="line">q.enqueue_job(job2)</div></pre></td></tr></table></figure>
<ul>
<li>timeout: specifies the max runtime of job before it’s interrupted and marked as failed. </li>
<li>ttl: specifies the maximum queued time(in sec) of the job before it’s dscarded. default is None(infinite TTL)</li>
<li>failure_ttl: specifies how long(in sec) failed jobs are kept(default to 1 years)</li>
</ul>
<p>the following sample is a way to find all <code>rq:job:</code>s, but the return is a bytes object, which need encode as <code>utf-8</code> for any further usage.</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> redis</div><div class="line">r = redis.StrictRedis()</div><div class="line">r.keys()</div><div class="line"><span class="keyword">for</span> key <span class="keyword">in</span> r.scan_iter(<span class="string">"rq:job:*"</span>):</div><div class="line">	print(key.encode(<span class="string">'utf-8'</span>)</div></pre></td></tr></table></figure>
<h4 id="workers"><a href="#workers" class="headerlink" title="workers"></a>workers</h4><p>workers will read jobs from the given queues(the order is important) in an endless loop, waiting for new work to arrive when all jobs done. each worker will process a single job at a time. by default, workers will start working immediately and wait until new jobs. another mode is <code>burst</code>, where to finish all currently avaiable work and quit asa all given queues are emptied.</p>
<p><code>rq worker</code> shell script is a simple <code>fetch-fork-execute</code> loop</p>
<h2 id="connections"><a href="#connections" class="headerlink" title="connections"></a>connections</h2><p>when you want to use multiple connections, you should use <code>Connection</code> contexts or pass connections around explicitly. </p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">conn1 = Redis(<span class="string">'localhost'</span>, <span class="number">6379</span>)</div><div class="line">conn2 = Redis(<span class="string">'remote.host.org'</span>, <span class="number">9836</span>)</div><div class="line"></div><div class="line">q1 = Queue(<span class="string">'foo'</span>, connection=conn1)</div><div class="line">q2 = Queue(<span class="string">'bar'</span>, connection=conn2)</div></pre></td></tr></table></figure>
<p>Every job that is enqueued on a queue will know what connection it belongs to. The same goes for the workers.<br>within the Connection context, every newly created RQ object instance will have the connection argument set implicitly.</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">setUp</span><span class="params">(self)</span>:</span></div><div class="line">    push_connection(Redis())</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">tearDown</span><span class="params">(self)</span>:</span></div><div class="line">    pop_connection()</div></pre></td></tr></table></figure>
<p>this should be the way to handle distributed queues. </p>
<h4 id="results"><a href="#results" class="headerlink" title="results"></a>results</h4><p>if a job returns a <code>non-None</code> value, the worker will write that return value back to the job’s Redis hash under <code>result</code> key. the job’s Redis hash itself expire in 500sec by default after the job is finished.</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">q.enqueue(foo, result_ttl=<span class="number">86400</span>)  <span class="comment"># result expires after 1 day</span></div><div class="line">q.enqueue(func_without_rv, result_ttl=<span class="number">500</span>)  <span class="comment"># job kept explicitly</span></div></pre></td></tr></table></figure>
<p>when an exception is thrown inside a job, it’s caught by the worker, serialized and stored under <code>exc_info</code> key. By default, jobs should execute within 180 seconds. After that, the worker kills the work horse and puts the job onto the failed queue, indicating the job timed out.</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">q.enqueue(mytask, args=(foo,), kwargs=&#123;<span class="string">'bar'</span>: qux&#125;, job_timeout=<span class="number">600</span>)  <span class="comment"># 10 mins</span></div></pre></td></tr></table></figure>
<h4 id="job-registries"><a href="#job-registries" class="headerlink" title="job registries"></a>job registries</h4><p>each queue maintains a set of Job Registries. e.g.  <code>StartedJobRegistry</code>, <code>FinishedJobRegistry</code> e.t.c. we can find these after log in <code>redis-cli</code></p>
<h4 id="version-bug"><a href="#version-bug" class="headerlink" title="version bug"></a>version bug</h4><p>when run <code>rq</code> demo, it reports: </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">raise</span> RedisError(<span class="string">"ZADD requires an equal number of "</span></div><div class="line">redis.exceptions.RedisError: ZADD requires an equal number of values <span class="keyword">and</span> scores</div></pre></td></tr></table></figure>
<p>manually change <code>/rq/registry.py</code>:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"> <span class="comment"># return pipeline.zadd(self.key, &#123;job.id: score&#125;)</span></div><div class="line"><span class="keyword">return</span> pipeline.zadd(self.key, job.id, score)</div></pre></td></tr></table></figure>
<h2 id="data-pipeline-for-ADS-function-verification"><a href="#data-pipeline-for-ADS-function-verification" class="headerlink" title="data pipeline for ADS function verification"></a>data pipeline for ADS function verification</h2><ul>
<li>queues </li>
</ul>
<p>each queue instance can be taken as a separate namespace in the Redis instance, so the workers only process the jobs in the same queue. but if multi-queues are hosted in the same Redis instance, then Redis api can find Queue A’s jobs in Queue B’s workers. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">conn = Redis() </div><div class="line">mf4q = Queue(<span class="string">'mf4Q'</span>, connection=conn)</div><div class="line">aebq = Queue(<span class="string">'aebQ'</span>, connection=conn)</div><div class="line">dbq = Queue(<span class="string">'dbQ'</span>, connection=conn)</div></pre></td></tr></table></figure>
<ul>
<li>jobs</li>
</ul>
<p>if the handler_fun has return values, namely status. <code>rq</code> store its status at <code>job.result</code>, thle lifecycle of which can be controlled by <code>result_ttl</code>, e.t.c.</p>
<p>to control the order of running the jobs, jobs can have <code>depend</code>. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">mf4_jober</span><span class="params">(url_path)</span>:</span></div><div class="line">    mf4_job = mf4q.enqueue(mf4_reader, args=(url_path,), timeout=<span class="number">60</span>, ttl=<span class="number">60</span>, failure_ttl=<span class="number">1</span>,  job_timeout=<span class="number">60</span>, result_ttl=<span class="number">60</span>, job_id=mf4_job_id)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">aeb_jober</span><span class="params">(mf4_frames)</span>:</span></div><div class="line">    aeb_job = aebq.enqueue(aeb_oneStep, args=(i_, ), timeout=<span class="number">60</span>, ttl=<span class="number">20</span>, failure_ttl=<span class="number">1</span>, result_ttl=<span class="number">10</span>, job_id=aeb_job_id)</div><div class="line">	</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">db_jober</span><span class="params">(aeb_frame, idx)</span>:</span></div><div class="line">    db_job= dbq.enqueue(db_oneStep, args=(aeb_frame,), timeout=<span class="number">60</span>, ttl=<span class="number">20</span>, failure_ttl=<span class="number">1</span>, job_id=db_job_id)</div></pre></td></tr></table></figure>
<ul>
<li>workers </li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">def mf4_workers(conn, num_workers=1):</div><div class="line">	for i in range(num_workers):</div><div class="line">		worker_ = Worker([mf4q], connection=conn, name=worker_name)</div><div class="line">		workers_.append(worker_)</div><div class="line">	for w in workers_:</div><div class="line">		w.work(burst=True)</div><div class="line">def aeb_workers()</div><div class="line">def db_workers()</div></pre></td></tr></table></figure>
<ul>
<li>runners</li>
</ul>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">runner</span><span class="params">(conn)</span>:</span></div><div class="line">	mf4_workers(conn)</div><div class="line">	<span class="keyword">for</span> k <span class="keyword">in</span> conn.scan_iter(<span class="string">"rq:job:mf4_job_*"</span>):</div><div class="line">		t_ = k.decode(<span class="string">'utf-8'</span>)</div><div class="line">		j_ = Job.fetch(t_[<span class="number">7</span>:], connection=conn)</div><div class="line">		aeb_jober(j_.result)</div><div class="line">	input(<span class="string">"hold on ..."</span>)</div><div class="line">	aeb_workers(conn)</div></pre></td></tr></table></figure>
<p>since the output of <code>mf4</code> jobs is the input of <code>aeb</code>, so we need <code>runners</code>, similar for <code>db</code>.</p>
<h2 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h2><p> <code>rq</code> is a good framework for this level data pipleine. for even bigger and complex system, <code>rq</code> maybe just a middleware, and there should be an even larger framework. the software engineering idea about <code>framework</code> and <code>middleware</code> in a large system gradually become the foundataion of ADS team</p>
<p>in distributed system, there are a few basic concepts <code>distributed consensus</code>, the popular choice e.g. zookeeper, etcd; <code>interprocess communication</code>, <code>distributed cache</code> e.t.c. really cool to know.</p>
<h2 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h2><p><a href="http://xiaorui.cc/" target="_blank" rel="external">xiaorui blog: rq</a></p>
<p><a href="https://www.cnblogs.com/jpwahaha/p/10601096.html" target="_blank" rel="external">微服架构中的进程间通信</a></p>
<p><a href="https://www.cnblogs.com/imyalost/p/6792724.html" target="_blank" rel="external">微服务架构</a></p>
<p><a href="https://www.tuicool.com/articles/QreqUnU" target="_blank" rel="external">使用gRPC构建微服务</a></p>
<p><a href="https://blog.csdn.net/fly910905/article/details/100016003" target="_blank" rel="external">微服务, 通信协议对比</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1081697" target="_blank" rel="external">理解批处理的关键设计</a></p>
<p><a href="https://www.cnblogs.com/rookiemzl/p/9788002.html" target="_blank" rel="external">spring batch 批处理</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/23/Linux-iptables/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/23/Linux-iptables/" itemprop="url">Linux iptables</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-23T08:21:38-04:00">
                2020-05-23
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/05/23/Linux-iptables/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/05/23/Linux-iptables/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="background"><a href="#background" class="headerlink" title="background"></a>background</h2><p>从<a href="http://www.zsythink.net/archives/1199" target="_blank" rel="external">iptable详解</a>整理的。 理解iptables，是为了更好的理解k8s中网络。</p>
<p>从逻辑上讲。防火墙可以大体分为主机防火墙和网络防火墙。</p>
<p>主机防火墙：针对于单个主机进行防护。</p>
<p>网络防火墙：往往处于网络入口或边缘，针对于网络入口进行防护，服务于防火墙背后的本地局域网。</p>
<p><strong>iptables</strong>其实不是真正的防火墙，我们可以把它理解成一个客户端代理，用户通过iptables这个代理，将用户的安全设定执行到对应的”安全框架”中，这个”安全框架”才是真正的防火墙，这个框架的名字叫<strong>netfilter</strong></p>
<p>Netfilter是Linux操作系统核心层内部的一个数据包处理模块，它具有如下功能：</p>
<ul>
<li><p>网络地址转换(Network Address Translate)</p>
</li>
<li><p>数据包内容修改</p>
</li>
<li><p>以及数据包过滤的防火墙功能</p>
</li>
</ul>
<p>规则一般的定义为”如果数据包头符合这样的条件，就这样处理这个数据包”. 规则分别指定了源地址、目的地址、传输协议（如TCP、UDP、ICMP）和服务类型（如HTTP、FTP和SMTP）等.  当数据包与规则匹配时，iptables就根据规则所定义的方法来处理这些数据包，如放行（accept）、拒绝（reject）和丢弃（drop）等。配置防火墙的主要工作就是添加、修改和删除这些规则。</p>
<p>如果我们想要防火墙能够达到”防火”的目的，则需要在内核中设置关卡，所有进出的报文都要通过这些关卡，经过检查后，符合放行条件的才能放行，符合阻拦条件的则需要被阻止，于是，就出现了input关卡和output关卡，而这些关卡在iptables中不被称为”关卡”,而被称为”链”。当客户端发来的报文访问的目标地址并不是本机，而是其他服务器，当本机的内核支持IP_FORWARD时，我们可以将报文转发给其他服务器。这个时候，我们就会提到iptables中的其他”关卡”，也就是其他”链”，他们就是  “路由前”、”转发”、”路由后”，他们的英文名是</p>
<p>PREROUTING、FORWARD、POSTROUTING</p>
<p><img src="http://www.zsythink.net/wp-content/uploads/2017/02/021217_0051_2.png" alt="image"></p>
<p>当我们定义iptables规则时，所做的操作其实类似于”增删改查”。</p>
<p>“关卡“/”链“ 包括：  prerouting, INPUT, OUTPUT, FORWARD, POSTROUTING</p>
<p>表： filter 负责过滤(iptables_filter); nat(network address translation), 网络地址转发， mangle, raw</p>
<p>表名：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -t filter -L (INPUT/OUTPUT/FORWARD/DOCKER-USER/DOCKER-ISOLATION-STAGE/KUBE-EXTERNAL-SERVICES/KUBE-FIREWALL/UBE-FORWARD/KUBE-KUBELET-CANARY/KUBE-SERVICES)</div></pre></td></tr></table></figure>
<p>-t选项，查看表名(filter/mangle/nat)<br>-L 选项，规则/链名<br>-n 选项，表示不对IP地址进行名称反解，直接显示IP地址。<br>–line-number 选项， 显示规则的编号</p>
<p>规则大致由两个逻辑单元组成，匹配条件与动作。 </p>
<ul>
<li>测试1：拒绝某个远程主机(10.20.180.12)访问当前主机(10.20.181.132)</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -t filter -I INPUT -s 10.20.180.12  -j DROP</div></pre></td></tr></table></figure>
<ul>
<li>-I 选项, 插入规则到哪个链</li>
<li>-s 选项，匹配条件中的源地址</li>
<li>-j 选项，当匹配条件满足，采取的动作</li>
</ul>
<ul>
<li>测试1.1：拒绝某个远程主机(10.20.180.12)访问当前主机(10.20.181.132)，再追加一条接受(10.20.180.12)的访问</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -A INPUT -s 10.20.180.12 -j ACCEPT</div></pre></td></tr></table></figure>
<ul>
<li>-A选项，追加规则到某个链。 </li>
</ul>
<p>不通 即规则的顺序很重要。如果报文已经被前面的规则匹配到，iptables则会对报文执行对应的动作，即使后面的规则也能匹配到当前报文，很有可能也没有机会再对报文执行相应的动作了。</p>
<ul>
<li>测试2: 根据规则编号去删除规则</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">iptables --line -vnL INPUT</div><div class="line">iptables -t filter -D INPUT N</div></pre></td></tr></table></figure>
<ul>
<li>-D选项，删除某条链上的第N条规则</li>
</ul>
<ul>
<li>测试2.2: 根据具体的条件去执行删除规则</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">iptables -vnL INPUT</div><div class="line">iptables -t filter -D INPUT -s 10.20.180.12 -j DROP</div></pre></td></tr></table></figure>
<p>修改规则，一般就是删除旧规则，再添加新规则。</p>
<ul>
<li>保存规则</li>
</ul>
<p>当重启iptables服务或者重启服务器以后，我们平常添加的规则或者对规则所做出的修改都将消失，为了防止这种情况的发生，我们需要将规则”保存”</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">iptables-save &gt; /etc/network/iptables.up.rules</div><div class="line">iptables-apply <span class="comment">#restart iptables</span></div></pre></td></tr></table></figure>
<ul>
<li><p>更多关于匹配条件</p>
<p>-s 选项， 指定源地址作为匹配条件，还可以指定一个网段，或用 逗号分割多个IP;  支持取反。</p>
<p>-d 选项，指定目标地址作为匹配条件。 </p>
</li>
</ul>
<p>不指定，默认就是（0.0.0.0/0），即所有IP</p>
<p> -p 选项，指定匹配的报文协议类型。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">iptables -t filter -I INPUT -s 10.20.180.12 -d 10.20.181.132 -p tcp -j REJECT</div><div class="line">ssh 10.20.180.12 <span class="comment">#from 10.20.181.132 ssh t0 10.20.180.12 suppose to be rejected. but not ?</span></div></pre></td></tr></table></figure>
<p> -i选项，匹配报文通过哪块网卡流入本机。</p>
<h4 id="iptables之网络防火墙"><a href="#iptables之网络防火墙" class="headerlink" title="iptables之网络防火墙"></a>iptables之网络防火墙</h4><p>当外部网络中的主机与网络内部主机通讯时，不管是由外部主机发往内部主机的报文，还是由内部主机发往外部主机的报文，都需要经过iptables所在的主机，由iptables所在的主机进行”过滤并转发”，所以，防火墙主机的主要工作就是”过滤并转发”</p>
<p><img src="http://www.zsythink.net/wp-content/uploads/2017/05/051017_0955_1.png" alt="image"></p>
<p>主机B也属于内部网络，同时主机B也能与外部网络进行通讯，如上图所示，主机B有两块网卡，网卡1与网卡2，网卡1的IP地址为10.1.0.3，网卡2的IP地址为192.168.1.146: </p>
<p><img src="http://www.zsythink.net/wp-content/uploads/2017/05/051017_0955_2.png" alt="image"></p>
<p>c主机网关指向B主机网卡1的IP地址；A主机网关指向B主机网卡2的IP地址。</p>
<p>on hostmachine A:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">route add -net 10.1.0.0/16 gw 192.168.1.146 </div><div class="line">ping 10.1.0.1 <span class="comment"># ping machine C, not available</span></div><div class="line">ping 10.1.0.3 <span class="comment"># ping machine B(NIC 2), avaiailable</span></div></pre></td></tr></table></figure>
<ul>
<li>为什么10.1.0.1没有回应。</li>
</ul>
<p>A主机通过路由表得知，发往10.1.0.0/16网段的报文的网关为B主机，当报文达到B主机时，B主机发现A的目标为10.1.0.1，而自己的IP是10.1.0.3，这时，B主机则需要将这个报文转发给10.1.0.1（也就是C主机），但是，Linux主机在默认情况下，并不会转发报文，如果想要让Linux主机能够转发报文，需要额外的设置，这就是为什么10.1.0.1没有回应的原因，因为B主机压根就没有将A主机的ping请求转发给C主机，C主机压根就没有收到A的ping请求，所以A自然得不到回应</p>
<ul>
<li>为什么10.1.0.3会回应。</li>
</ul>
<p>这是因为10.1.0.3这个IP与192.168.1.146这个IP都属于B主机，当A主机通过路由表将ping报文发送到B主机上时，B主机发现自己既是192.168.1.146又是10.1.0.3，所以，B主机就直接回应了A主机，并没有将报文转发给谁，所以A主机得到了10.1.0.3的回应</p>
<ul>
<li>如何让LINUX主机转发报文</li>
</ul>
<p>check <code>/proc/sys/net/ipv4/ip_forward</code>. if content is <code>0</code>, meaning the Linux hostmachine doesn’t forward; if content is <code>1</code>, meaning the Linux hostmachine does forward. </p>
<p>or </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sysctl -w net.ipv4.ip_forward=1</div></pre></td></tr></table></figure>
<p>for permenentally allow Linux host forward, update file <code>/etc/sysctl.conf</code>. </p>
<p>设置linux主机转发报文后， A ping C || C ping A should works.</p>
<p>如果我们想要使内部的主机能够访问外部主机的web服务，我们应该怎样做呢？ 我们需要在FORWARD链中放行内部主机对外部主机的web请求.</p>
<ul>
<li>在B主机上：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">iptables -I FORWARD -j REJECT</div><div class="line">iptables -I FORWARD -s 10.1.0.0/16 -p tcp --dport 80 -j ACCEPT</div></pre></td></tr></table></figure>
<p>B主机上所有转发(forward)命令，都REJECT。只ACCEPT 内网10.1.0.0/16 网段， 端口80的转发FORWARD. （即内网网段可访问外网)。 C ping A (ok)</p>
<p>destnation port 目标端口。</p>
<p>想让A ping C, 需在B主机iptables中再添加如下规则：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -I FORWARD -d 10.1.0.0/16 -p tcp --sport 80 -j ACCEPT</div></pre></td></tr></table></figure>
<p>source port 源端口。 </p>
<p>配置规则时，往往需要考虑“双向性”。因为一条规则(forward)，只会匹配最新的规则定义。上述修改完了，A 可以PING C，但C又PING不通A了。 a better way, no matter request from in to out or the othersize, both should FORWARD.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -I FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT</div></pre></td></tr></table></figure>
<ul>
<li>更多动作</li>
</ul>
<p>NAT, network address translation. 网络地址转换。NAT说白了就是修改报文的IP地址，NAT功能通常会被集成到路由器、防火墙、或独立的NAT设备中。那为什么要修改报文的IP地址呢？</p>
<p>scenario1 :网络内部有10台主机，它们有各自的IP地址，当网络内部的主机与其他网络中的主机通讯时，则会暴露自己的IP地址，如果我们想要隐藏这些主机的IP地址，该怎么办呢？</p>
<p>当网络内部的主机向网络外部主机发送报文时，报文会经过防火墙或路由器，当报文经过防火墙或路由器时，将报文的源IP修改为防火墙或者路由器的IP地址，当其他网络中的主机收到这些报文时，显示的源IP地址则是路由器或者防火墙的，而不是那10台主机的IP地址，这样，就起到隐藏网络内部主机IP的作用。同时路由器会维护一张NAT表，记录这个内部主机的IP和端口。当外部网络中的主机进行回应时，外部主机将响应报文发送给路由器，路由器根据刚才NAT表中的映射记录，将响应报文中的目标IP与目标端口再改为内部主机的IP与端口号，然后再将响应报文发送给内部网络中的主机。</p>
<p>刚才描述的过程中，”IP地址的转换”一共发生了两次。</p>
<p>内部网络的报文发送出去时，报文的源IP会被修改，也就是源地址转换：Source Network Address Translation，缩写为SNAT。</p>
<p>外部网络的报文响应时，响应报文的目标IP会再次被修改，也就是目标地址转换：Destinationnetwork address translation，缩写为DNAT。</p>
<p>不论内网访问外网，Or the otherwise。都会有上述两次IP转换。一般将内网请求外网服务称为snat，外网请求内网服务称为dnat.</p>
<p>上述场景不仅仅能够隐藏网络内部主机的IP地址，还能够让局域网内的主机共享公网IP，让使用私网IP的主机能够访问互联网。比如，整个公司只有一个公网IP，但是整个公司有10台电脑，我们怎样能让这10台电脑都访问互联网呢？ 只要在路由器上配置公网IP，在私网主机访问公网服务时，报文经过路由器，路由器将报文中的私网IP与端口号进行修改和映射，将其映射为公网IP与端口号，这时，内网主机即可共享公网IP访问互联网上的服务了</p>
<p>场景2：公司有自己的局域网，网络中有两台主机作为服务器，主机1提供web服务，主机2提供数据库服务，但是这两台服务器在局域网中使用私有IP地址，只能被局域网内的主机访问，互联网无法访问到这两台服务器，整个公司只有一个可用的公网IP。如何让公网访问到公司的内网服务呢？</p>
<p>将这个公网IP配置到公司的某台主机或路由器上，然后对外宣称，这个IP地址对外提供web服务与数据库服务，于是互联网主机将请求报文发送给这公网 IP地址，也就是说，此时报文中的目标IP为公网IP，当路由器收到报文后，将报文的目标地址改为对应的私网地址，比如，如果报文的目标IP与端口号为：公网IP+3306，我们就将报文的目标地址与端口改为：主机2的私网IP+3306，同理，公网IP+80端口映射为主机1的私网IP+80端口，当私网中的主机回应对应请求报文时，再将回应报文的源地址从私网IP+端口号映射为公网IP+端口号，再由路由器或公网主机发送给互联网中的主机。</p>
<h6 id="测试环境，同ABC主机。"><a href="#测试环境，同ABC主机。" class="headerlink" title="测试环境，同ABC主机。"></a>测试环境，同ABC主机。</h6><ul>
<li>SNAT 测试</li>
</ul>
<p>on B hostmachine:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -t nat -A POSTROUTING -s 10.1.0.0/16 -j SNAT --to-source 192.168.1.146</div></pre></td></tr></table></figure>
<p>SNAT规则只能存在于POSTROUTING链与INPUT链中。 “–to-source”就是SNAT动作的常用选项，用于指定SNAT需要将报文的源IP修改为哪个IP地址。此处，即B的公网IP.</p>
<ul>
<li>DNAT测试</li>
</ul>
<p>on B machine:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">iptables -t nat -F  <span class="comment">#flash nat table </span></div><div class="line">iptables -t nat -I PREROUTING -d 192.168.1.146 -p tcp --dport 3389 -j DNAT --to-destination 10.1.0.6:3389</div></pre></td></tr></table></figure>
<p>-j DNAT –to-destination 10.1.0.6:3389”表示将符合条件的报文进行DNAT，也就是目标地址转换，将符合条件的报文的目标地址与目标端口修改为10.1.0.6:3389。 理论上只要完成上述DNAT配置规则即可，但是在测试时，只配置DNAT规则后，并不能正常DNAT，经过测试发现，将相应的SNAT规则同时配置后，即可正常DNAT，于是我们又配置了SNAT:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -t nat -A POSTROUTING -s 10.1.0.0/16 -j SNAT --to-source 192.168.1.146</div></pre></td></tr></table></figure>
<h4 id="MASQUERADE"><a href="#MASQUERADE" class="headerlink" title="MASQUERADE"></a>MASQUERADE</h4><p>当我们拨号网上时，每次分配的IP地址往往不同，不会长期分给我们一个固定的IP地址，如果这时，我们想要让内网主机共享公网IP上网，就会很麻烦，因为每次IP地址发生变化以后，我们都要重新配置SNAT规则，这样显示不是很人性化，我们通过MASQUERADE即可解决这个问题。</p>
<p>MASQUERADE会动态的将源地址转换为可用的IP地址，其实与SNAT实现的功能完全一致，都是修改源地址，只不过SNAT需要指明将报文的源地址改为哪个IP，而MASQUERADE则不用指定明确的IP，会动态的将报文的源地址修改为指定网卡上可用的IP地址。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -t nat -I POSTROUTING -s 10.1.0.0/16 -o en1 -j MASQUERADE</div></pre></td></tr></table></figure>
<p>通过B外网网卡出去的报文在经过POSTROUTING链时，会自动将报文的源地址修改为外网网卡上可用的IP地址，这时，即使外网网卡中的公网IP地址发生了改变，也能够正常的、动态的将内部主机的报文的源IP映射为对应的公网IP。</p>
<p>可以把MASQUERADE理解为动态的、自动化的SNAT</p>
<h4 id="REDIRECT"><a href="#REDIRECT" class="headerlink" title="REDIRECT"></a>REDIRECT</h4><p>使用REDIRECT动作可以在本机上进行端口映射</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-ports 8080</div></pre></td></tr></table></figure>
<p>经过上述规则映射后，当别的机器访问本机的80端口时，报文会被重定向到本机的8080端口上。<br>REDIRECT规则只能定义在PREROUTING链或者OUTPUT链中。</p>
<h2 id="refer"><a href="#refer" class="headerlink" title="refer"></a>refer</h2><p><a href="https://www.digitalocean.com/community/tutorials/iptables-essentials-common-firewall-rules-and-commands" target="_blank" rel="external">iptables essentials</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1521589" target="_blank" rel="external">ip route, ip rule &amp; iptables 知多少</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/23/k8s-flannel/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/23/k8s-flannel/" itemprop="url">k8s: flannel</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-23T08:19:53-04:00">
                2020-05-23
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/05/23/k8s-flannel/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/05/23/k8s-flannel/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="background"><a href="#background" class="headerlink" title="background"></a>background</h2><p>k8s networks include a few topics:</p>
<ul>
<li><p>pod to pod communication in k8s</p>
</li>
<li><p>pod to the host node communication</p>
</li>
<li><p>pod to external service URL</p>
</li>
<li><p>external request to pod in k8s</p>
</li>
</ul>
<p>the networks have two components: DNS and iptables. DNS used to resovle URL name to IP; iptables used to control network message transfer in/out. </p>
<h4 id="preparation-image-for-test"><a href="#preparation-image-for-test" class="headerlink" title="preparation image for test"></a>preparation image for test</h4><p>to test network inside pod/docker, we need add the following network tools: </p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="string">iputils-ping</span> <span class="string">\</span> </div><div class="line"><span class="string">net-tools</span> <span class="string">\</span> </div><div class="line"><span class="string">iptables</span> <span class="string">\</span></div><div class="line"><span class="string">iproute</span></div></pre></td></tr></table></figure>
<h4 id="docker-pod-runtime-privileges"><a href="#docker-pod-runtime-privileges" class="headerlink" title="docker/pod runtime privileges"></a>docker/pod runtime privileges</h4><p>by default, docker doesn’t allow run <code>iptables</code> inside container. and it give errors:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">root@redisjq:/<span class="comment"># iptables -t nat -L | grep INPUT </span></div><div class="line">iptables v1.6.0: can<span class="string">'t initialize iptables table `nat'</span>: Permission denied (you must be root)</div><div class="line">Perhaps iptables or your kernel needs to be upgraded.</div></pre></td></tr></table></figure>
<p>which need to add <a href="https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities" target="_blank" rel="external">docker runtime privilege and Linux capabilities</a></p>
<p><a href="https://www.weave.works/blog/container-capabilities-kubernetes/" target="_blank" rel="external">container capabilities in k8s</a></p>
<p>In a Kubernetes pod, the names are the same, but everything has to be defined in the pod specification. When implementing this in Kubernetes, you add an array of capabilities under the securityContext tag.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">securityContext:</div><div class="line">  capabilities:</div><div class="line">    add:</div><div class="line">       - NET_ADMIN</div></pre></td></tr></table></figure>
<h2 id="k8s-pod-DNS"><a href="#k8s-pod-DNS" class="headerlink" title="k8s pod DNS"></a>k8s pod DNS</h2><p><a href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/" target="_blank" rel="external">DNS for services and pods</a> introduced four types: </p>
<ul>
<li><p>None </p>
</li>
<li><p>Default， where POD derived DNS config from the host node where to run pod.</p>
</li>
<li><p>ClusterFirst， where POD use DNS info from kube-dns or coreDNS</p>
</li>
<li><p>ClusterFirstWithHostNet, as the name explained.</p>
</li>
</ul>
<p>tips, <strong>Default</strong> is not the default DNS policy. If dnsPolicy is not explicitly specified, then <strong>ClusterFirst</strong> is used as default.</p>
<p>the purpose of pod/service DNS is used to transfer URL to IP, which is the second step after iptabels is understand successfully.</p>
<p><code>coreDNS</code> is setted during <code>kube-adm init</code> with <code>serverDNS</code>. To do SNAT, the pod/service in K8S need access </p>
<h5 id="resolv-conf-DNS-inside-pod"><a href="#resolv-conf-DNS-inside-pod" class="headerlink" title="resolv.conf/DNS inside pod :"></a>resolv.conf/DNS inside pod :</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">root@redisjq:/redis<span class="comment"># cat /etc/resolv.conf </span></div><div class="line">nameserver 10.96.0.10</div><div class="line">search lg.svc.cluster.local svc.cluster.local cluster.local</div><div class="line">options ndots:5</div></pre></td></tr></table></figure>
<p>clearly, the pod DNS is coming from cluster, which can be check by: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">kubectl describe configmap kubeadm-config -n kube-system </div><div class="line"></div><div class="line">kind: ClusterConfiguration</div><div class="line">kubernetesVersion: v1.18.2</div><div class="line">networking:</div><div class="line">  dnsDomain: cluster.local</div><div class="line">  podSubnet: 10.4.0.0/16</div><div class="line">  serviceSubnet: 10.96.0.0/12</div></pre></td></tr></table></figure>
<p>and that’s the reason why resolve URL failed, as clusterDNS is kind of random defined. </p>
<p>the DNS failure gives errors as following inside pod: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">socket.gaierror: [Errno -3] Temporary failure in name resolution</div></pre></td></tr></table></figure>
<h4 id="docker0-DNS"><a href="#docker0-DNS" class="headerlink" title="docker0 DNS"></a>docker0 DNS</h4><p>docker engine can configure its DNS at <code>/etc/daemon.json</code>, with “dns” section. when running docker in single mode, docker0 looks has host machine’s DNS, but when runnig in swarm mode, need to define additional DNS for external access.</p>
<h2 id="iptables-in-K8S"><a href="#iptables-in-K8S" class="headerlink" title="iptables in K8S"></a>iptables in K8S</h2><p><a href="https://docs.docker.com/network/iptables/" target="_blank" rel="external">docker and iptables</a></p>
<p>you should not modify the rules Docker inserts into your iptables policies. Docker installs two custom iptables chains named <code>DOCKER-USER</code> and <code>DOCKER</code>, and it ensures that incoming packets are always checked by these two chains first</p>
<p>a simple test can found, <code>docker0</code> NIC is bridge is well to bind host network namespace, either export or response request externally. while with <code>flannel.d</code> NIC, pod can’t access external resources.</p>
<p><a href="https://www.bookstack.cn/read/source-code-reading-notes/kubernetes-kube_proxy_iptables.md" target="_blank" rel="external">code review: kube-proxy iptables</a>: </p>
<p>iptables has 5 tables and 5 chains.</p>
<p>the 5 chaines: </p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="attr">PREROUTING:</span> <span class="string">before</span> <span class="string">message</span> <span class="string">into</span> <span class="string">route,</span> <span class="string">the</span> <span class="string">external</span> <span class="string">request</span> <span class="string">DNAT.</span></div><div class="line"><span class="attr">INPUT:</span> <span class="string">message</span> <span class="string">to</span> <span class="string">local</span> <span class="string">host</span> <span class="string">or</span> <span class="string">current</span> <span class="string">network</span> <span class="string">namespace.</span> </div><div class="line"><span class="attr">FORWARD:</span> <span class="string">message</span> <span class="string">forward</span> <span class="string">to</span> <span class="string">other</span> <span class="string">host</span> <span class="string">or</span> <span class="string">other</span> <span class="string">network</span> <span class="string">namespace.</span></div><div class="line"><span class="attr">OUTPUT:</span> <span class="string">message</span> <span class="string">export</span> <span class="string">from</span> <span class="string">current</span> <span class="string">host</span></div><div class="line"><span class="attr">POSTROUTING:</span> <span class="string">after</span> <span class="string">route</span> <span class="string">before</span> <span class="string">NIC,</span> <span class="string">message</span> <span class="string">SNAT</span></div></pre></td></tr></table></figure>
<p>the 5 tables: </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">filter table, used to control the network package need to ACCEPT, or DROP, or REJECT when it comes to a chain</div><div class="line">nat(network address translation) table, used to modify the src/target address of network package</div><div class="line">mangle table, used to modify IP header info of network package</div><div class="line">raw table</div><div class="line">security table</div></pre></td></tr></table></figure>
<p>for k8s pods/services, mostly consider <code>filter</code> and <code>nat</code> tables. and k8s expand another 7 chains: KUBE-SERVICES、KUBE-EXTERNAL-SERVICES、KUBE-NODEPORTS、KUBE-POSTROUTING、KUBE-MARK-MASQ、KUBE-MARK-DROP、KUBE-FORWARD. </p>
<p><img src="https://static.bookstack.cn/projects/source-code-reading-notes/729e704bd9fc39c9223da5185e9ef084.png" alt="image"></p>
<h2 id="virtual-network-flannel"><a href="#virtual-network-flannel" class="headerlink" title="virtual network flannel"></a>virtual network flannel</h2><h4 id="check-running-flanneld"><a href="#check-running-flanneld" class="headerlink" title="check running flanneld"></a>check running flanneld</h4><ul>
<li><p><code>/etc/cni/net.d/10-flannel.conflist</code> on host machine is the same as <code>/etc/kube-flannel/cni-conf.json</code> in flannel container on master node.</p>
</li>
<li><p><code>/run/flannel/subnet.env</code> exist in both flannel container (on master node) and in master host machine. it looks like network configure(subnet.env) is copied from container to host machine. so if there is no <code>flannel container</code> running on some nodes, these nodes won’t have the right network configure. </p>
</li>
</ul>
<p>at master node, <code>HostPath</code> points to: /run/flannel, /etc/cni/net.d, kube-flannel-cfg (ConfigMap); while at working node(due to missing /gcr.io/flannel image), <code>/run/flannel/subnet.env</code> is missed. previously, I thought to cp this file from master node to woker node is the solution, then this file is missed every time to restart worker node. </p>
<p>once copied both <code>kube-proxy</code> and <code>flannel</code> images to worker node, and restart <code>kubelet</code> at worker node, the cluster should give <code>Running status</code> of all these components. including 2 copies of <code>flannel</code>, one running on master node, and the other running on working node. </p>
<p>as we are using <code>kubectl</code> to start the cluster, the actual flanneld is <code>/opt/bin/flanneld</code> from the running flannel container, and it maps NIC to the host machine. </p>
<p>another thing is, <code>flannel</code> is the core of the default <code>kube-proxy</code>, so <code>kube-proxy</code> image is also required on both nodes. <code>coreDNS</code> run two copies on master node.</p>
<h4 id="Flannel-mechanism"><a href="#Flannel-mechanism" class="headerlink" title="Flannel mechanism"></a><a href="https://www.jianshu.com/p/165a256fb1da" target="_blank" rel="external">Flannel mechanism</a></h4><p>the data flow: <strong>the sending message</strong> go to VNC(virtual network card) <code>docker0</code> on host machine, which transfers to VNC <code>flannel0</code>. this process is P2P. the global <code>etcd</code> service maintain a iptables among nodes, which store the subnet range of each node. 2) the <code>flanneld</code> service on the special node package <strong>the sending message</strong> as UDP package, and delivery to target node, based on the iptables. 3) when the target node received the UDP package, it unpackage the message, and send to its <code>flannel0</code>, then transfer to its <code>docker0</code>. </p>
<p>1) after flanneld started，will create <code>flannel.1</code> virtual network card. the purpose of <code>flannel.1</code> is for across-host network, including package/unpackage UDP, and maintain iptables among the nodes. </p>
<p>2) each node also create <code>cni0</code> virtual network card, at the first time to run flannel CNI. the purpose of <code>cni0</code> is same as <code>docker0</code>, and it’s a bridge network, used for communication in the same node. </p>
<p><img src="https://www.centos.bz/wp-content/uploads/2017/06/flannel-01.png" alt="image"></p>
<h2 id="test-with-redis-services"><a href="#test-with-redis-services" class="headerlink" title="test with redis services"></a>test with redis services</h2><p>we had define a <code>redisjq</code> pod, the following testes are all in this pod:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">kubectl <span class="built_in">exec</span> -it redisjq -n lg  /bin/bash</div><div class="line">ping localhost <span class="comment">#ok</span></div><div class="line">ping 10.255.18.3 <span class="comment">#not </span></div><div class="line">ping 10.3.101.101 <span class="comment">#not</span></div><div class="line">ping 10.20.180.12 </div><div class="line"></div><div class="line">ifconfig </div><div class="line">&gt;&gt;eth0,  10.4.1.46</div><div class="line">&gt;&gt;lo, 127.0.0.1</div></pre></td></tr></table></figure>
<p>the output above is initial output before we had any network setttings. basically the pod can only ping localhost, neither the host DNS, or the host IP. the vip(10.4.1.46) is not in the same network namespace as host network space. </p>
<h4 id="flannel-d-pod-on-both-nodes"><a href="#flannel-d-pod-on-both-nodes" class="headerlink" title="flannel.d pod on both  nodes:"></a>flannel.d pod on both  nodes:</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">david@meng:~/k8s/lgsvl$ kubectl get pods kube-flannel-ds-amd64-85d6m  -n kube-system --output=wide</div><div class="line">NAME                          READY   STATUS    RESTARTS   AGE   IP             NODE   NOMINATED NODE   READINESS GATES</div><div class="line">kube-flannel-ds-amd64-85d6m   1/1     Running   5          15d   10.20.180.12   meng   &lt;none&gt;           &lt;none&gt;</div><div class="line"></div><div class="line">david@meng:~/k8s/lgsvl$ kubectl get pods kube-flannel-ds-amd64-fflsl  -n kube-system --output=wide</div><div class="line">NAME                          READY   STATUS    RESTARTS   AGE   IP              NODE     NOMINATED NODE   READINESS GATES</div><div class="line">kube-flannel-ds-amd64-fflsl   1/1     Running   154        15d   10.20.181.132   ubuntu   &lt;none&gt;           &lt;none&gt;</div></pre></td></tr></table></figure>
<p><code>flannel.d</code> is runing on each node, should triggered by <code>kubelet</code>. <code>flannel.d</code> is used as virtual network interface, to manage across-node pod communication inside k8s. </p>
<h4 id="coredns-pod-in-meng-node"><a href="#coredns-pod-in-meng-node" class="headerlink" title="coredns pod in meng node"></a>coredns pod in meng node</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">david@meng:~/k8s/lgsvl$ kubectl get pods coredns-66bff467f8-59g97  -n kube-system --output=wide</div><div class="line">NAME                       READY   STATUS    RESTARTS   AGE   IP          NODE   NOMINATED NODE   READINESS GATES</div><div class="line">coredns-66bff467f8-59g97   1/1     Running   4          14d   10.4.0.27   meng   &lt;none&gt;           &lt;none&gt;</div></pre></td></tr></table></figure>
<p><code>coredns</code> has two replicas, both running on master node(meng), and we can see it only has virtual ip/cluster ip ( 10.4.0.x).</p>
<h4 id="redisjs-pod-in-ubuntu’s-node"><a href="#redisjs-pod-in-ubuntu’s-node" class="headerlink" title="redisjs pod in ubuntu’s node"></a>redisjs pod in ubuntu’s node</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">david@meng:~/k8s/lgsvl$ kubectl get pods redisjq -n lg --output=wide </div><div class="line">NAME      READY   STATUS    RESTARTS   AGE   IP          NODE     NOMINATED NODE   READINESS GATES</div><div class="line">redisjq   1/1     Running   0          20m   10.4.1.47   ubuntu   &lt;none&gt;           &lt;none&gt;</div></pre></td></tr></table></figure>
<p>by default, working pod is only running at woker node(ubuntu), which has clusterIP(10.4.1.47).</p>
<h4 id="pod1-ping-pod2-in-the-same-node"><a href="#pod1-ping-pod2-in-the-same-node" class="headerlink" title="pod1 ping pod2 in the same node"></a>pod1 ping pod2 in the same node</h4><p><strong>ping successfully</strong> there is no doubt in the same node, pods can ping each other.</p>
<h4 id="redisjq-pod1-10-4-1-47-in-ubuntu-ping-corends-pod2-10-4-0-27-in-meng"><a href="#redisjq-pod1-10-4-1-47-in-ubuntu-ping-corends-pod2-10-4-0-27-in-meng" class="headerlink" title="redisjq pod1(10.4.1.47) in ubuntu ping corends pod2(10.4.0.27) in meng"></a>redisjq pod1(10.4.1.47) in ubuntu ping corends pod2(10.4.0.27) in meng</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">root@redisjq:/redis<span class="comment"># ping 10.4.0.27 </span></div><div class="line">PING 10.4.0.27 (10.4.0.27) 56(84) bytes of data.</div><div class="line">64 bytes from 10.4.0.27: icmp_seq=1 ttl=62 time=0.757 ms</div></pre></td></tr></table></figure>
<p><strong>ping successfully</strong>, which is the working of flanneld. </p>
<h4 id="redisjq-pod1-10-4-1-7-in-ubuntu-ping-hostIP-10-20-181-132-of-ubuntu"><a href="#redisjq-pod1-10-4-1-7-in-ubuntu-ping-hostIP-10-20-181-132-of-ubuntu" class="headerlink" title="redisjq pod1(10.4.1.7) in ubuntu  ping hostIP(10.20.181.132) of ubuntu"></a>redisjq pod1(10.4.1.7) in ubuntu  ping hostIP(10.20.181.132) of ubuntu</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">root@redisjq:/redis<span class="comment"># ping 10.20.181.132</span></div><div class="line">PING 10.20.181.132 (10.20.181.132) 56(84) bytes of data.</div><div class="line">64 bytes from 10.20.181.132: icmp_seq=1 ttl=64 time=0.127 ms</div></pre></td></tr></table></figure>
<p><strong>ping successfuly</strong>, pod in cluster can ping its host node, sounds no problem. </p>
<h4 id="redisjq-pod1-10-4-1-7-in-ubuntu-ping-hostIP-10-20-180-12-of-meng"><a href="#redisjq-pod1-10-4-1-7-in-ubuntu-ping-hostIP-10-20-180-12-of-meng" class="headerlink" title="redisjq pod1(10.4.1.7) in ubuntu ping hostIP(10.20.180.12) of meng"></a>redisjq pod1(10.4.1.7) in ubuntu ping hostIP(10.20.180.12) of meng</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">root@redisjq:/redis<span class="comment"># ping 10.20.180.12 </span></div><div class="line">PING 10.20.180.12 (10.20.180.12) 56(84) bytes of data.</div></pre></td></tr></table></figure>
<p><strong>ping failed</strong>, interesting, so pod in cluster can’t ping any non-hosting node’s IP.</p>
<p>so far, pod with vip can ping any other pod with vip in the cluster, no matter in the same node or not.  pod with vip can only ping its host machine’s physical IP, but pod can’t ping other hostIP.</p>
<p>namely, the network of pod VIP inside k8s and the bridge network from pod vip to its host is set well. but the network from pod to external IP is not well.</p>
<p>these 4 tests give a very good understanding about flannel’s function inside k8s: pod to pod in the same node or not. but usually we need SNAT or DNAT. to make SNAT/DNAT avaiable, we need understand <strong>DNS &amp; iptables</strong> of k8s. </p>
<h2 id="update-iptables-to-allow-pod-access-public-IP"><a href="#update-iptables-to-allow-pod-access-public-IP" class="headerlink" title="update iptables to allow pod access public IP"></a>update iptables to allow pod access public IP</h2><h4 id="cni0-docker0-eno1-flannel-1-in-host-machine-vs-eth0-in-pod"><a href="#cni0-docker0-eno1-flannel-1-in-host-machine-vs-eth0-in-pod" class="headerlink" title="cni0, docker0, eno1, flannel.1 in host machine vs eth0 in pod"></a>cni0, docker0, eno1, flannel.1 in host machine vs eth0 in pod</h4><p>these virtual NIC are common in k8s env. </p>
<ul>
<li>on node1 </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">cni0: 10.4.1.1</div><div class="line">docker0: 172.17.0.1</div><div class="line">eno1: 10.20.181.132</div><div class="line">flannel.1: 10.4.1.0</div></pre></td></tr></table></figure>
<ul>
<li>on pod1, which is running on node1</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">eth0:  10.4.1.48</div></pre></td></tr></table></figure>
<p><a href="https://www.centos.bz/2017/06/k8s-flannel-network/" target="_blank" rel="external">pod1 -&gt; pod2 network message flow</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pod1(10.4.1.48) on node1(10.20.181.132) -&gt; cni0(10.4.1.1) -&gt; flannel.1(10.4.1.0) -&gt; kube-flannel on node1(10.20.181.132) -&gt; kube-flannel on node2(10.20.180.12) -&gt; flannel.1 on node2 -&gt; cni0 on node2 -&gt; pod2(10.4.1.46) on node2</div></pre></td></tr></table></figure>
<p>to allow network message SNAT, namely to handle <strong>FORWARD</strong> internal clusterIP data to external services, we can add the following newe iptable rule:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -t nat -I POSTROUTING -s 10.4.1.0/24 -j MASQUERADE</div></pre></td></tr></table></figure>
<p>after add the new rule, check inside pod:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">root@redisjq:/redis<span class="comment"># ping 10.20.180.12 </span></div><div class="line">PING 10.20.180.12 (10.20.180.12) 56(84) bytes of data.</div><div class="line">64 bytes from 10.20.180.12: icmp_seq=1 ttl=62 time=0.690 ms</div><div class="line">root@redisjq:/redis<span class="comment"># ping 10.20.181.132</span></div><div class="line">PING 10.20.181.132 (10.20.181.132) 56(84) bytes of data.</div><div class="line">64 bytes from 10.20.181.132: icmp_seq=1 ttl=64 time=0.108 ms</div><div class="line">root@redisjq:/redis<span class="comment"># ping 10.20.180.61 </span></div><div class="line">PING 10.20.180.61 (10.20.180.61) 56(84) bytes of data.</div><div class="line">64 bytes from 10.20.180.61: icmp_seq=1 ttl=126 time=0.366 ms</div><div class="line">root@redisjq:/redis<span class="comment"># ping www.baidu.com</span></div><div class="line">ping: unknown host www.baidu.com</div><div class="line">root@redisjq:/redis<span class="comment"># ping 61.135.169.121   #baidu IP</span></div><div class="line">PING 61.135.169.121 (61.135.169.121) 56(84) bytes of data.</div><div class="line">64 bytes from 61.135.169.121: icmp_seq=1 ttl=51 time=8.16 ms</div></pre></td></tr></table></figure>
<p>the DNS is not fixed, so we can’t ping <code>www.baidu.com</code>, but we can ping its IP.</p>
<p>on the other hand, to hanle <strong>FORWARD</strong> external request to internal clusterIP, we can add the following new iptable rule:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -t nat -I PREROUTING -d 10.4.1.0/24 -j MASQUERADE</div></pre></td></tr></table></figure>
<p>that’s beauty of iptables. </p>
<p>as mentioned previously, to handle pod DNS error, we need add <a href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/" target="_blank" rel="external">pod/service DNS strategy</a> inside the <code>pod.yaml</code>:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  dnsPolicy:</span> <span class="string">Default</span></div></pre></td></tr></table></figure>
<p>our k8s cluster has none DNS server itself, so to do SNAT/DNAT, we have to keep <code>Default</code> dns strategy, which make pod/service to use its host machine’s DNS, which is defined at <code>/etc/resovl.conf</code>.</p>
<p>one thing to take care, some host machine has only <code>nameserver 127.0.0.1</code> in <code>resolv.conf</code>, then we need add the real DNS server.</p>
<h2 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h2><p>with knowledge about iptables and dns, we can make an useful K8S cluster. the left work is make useful pods.</p>
<h2 id="refere"><a href="#refere" class="headerlink" title="refere"></a>refere</h2><p><a href="https://jimmysong.io/blog/configuring-kubernetes-kube-dns/" target="_blank" rel="external">jimmy song: config K8S DNS: kube-dns</a></p>
<p><a href="https://askubuntu.com/questions/346838/how-do-i-configure-my-dns-settings-in-ubuntu-server" target="_blank" rel="external">configure DNS settings in Ubuntu</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/90992878" target="_blank" rel="external">zhihu: k8s network</a></p>
<p><a href="https://www.kubernetes.org.cn/4317.html" target="_blank" rel="external">k8s expose service</a></p>
<p><a href="https://www.kubernetes.org.cn/6838.html" target="_blank" rel="external">k8s network advance</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1140088" target="_blank" rel="external">docker iptables from tencent cloud</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/17/k8s-setup-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="David Z.J. Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Serious Autonomous Vehicles">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/17/k8s-setup-2/" itemprop="url">k8s setup 2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-17T08:50:57-04:00">
                2020-05-17
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/05/17/k8s-setup-2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/05/17/k8s-setup-2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="background"><a href="#background" class="headerlink" title="background"></a>background</h2><p>this blog try to deploy two service in k8s: redis and dashboard. the other is engineering. </p>
<h2 id="manual-deploy-via-kubectl"><a href="#manual-deploy-via-kubectl" class="headerlink" title="manual deploy via kubectl"></a>manual deploy via kubectl</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">kubectl create ns <span class="built_in">test</span>-busybox</div><div class="line">kubectl run busybox --namespace=<span class="built_in">test</span>-busybox \</div><div class="line">                      --port=8280 \</div><div class="line">                      --image=busybox \</div><div class="line">                      -- sh -c <span class="string">"echo 'Hello' &gt; /var/www/index.html &amp;&amp; httpd -f -p 8280 -h /var/www/"</span></div><div class="line"></div><div class="line">kubectl get pods -n <span class="built_in">test</span>-busybox  <span class="comment">#should display `Running`, but `Pending`</span></div></pre></td></tr></table></figure>
<ul>
<li>error1: pending pod</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kubectl describe pods/busybox -n <span class="built_in">test</span>-busybox</div></pre></td></tr></table></figure>
<p>gives:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Warning  FailedScheduling  &lt;unknown&gt;  default-scheduler  0/2 nodes are available: 1 node(s) had taint &#123;node-role.kubernetes.io/master: &#125;, that the pod didn<span class="string">'t tolerate, 1 node(s) had taint &#123;node.kubernetes.io/unreachable: &#125;, that the pod didn'</span>t tolerate.</div></pre></td></tr></table></figure>
<p>a few things to check:</p>
<ul>
<li><p><code>swapoff -a</code> to close firewall on working node </p>
</li>
<li><p><code>kubectl uncordon</code> to make node schedulable <a href="https://github.com/Azure/AKS/issues/856" target="_blank" rel="external">kubectl uncordon</a></p>
</li>
</ul>
<ul>
<li>error 2: failed create pod sandbox</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Warning  FailedCreatePodSandBox  25s (x4 over 2m2s)  kubelet, ubuntu    Failed to create pod sandbox: rpc error: code = Unknown desc = failed pulling image <span class="string">"k8s.gcr.io/pause:3.2"</span>: Error response from daemon: Get https://k8s.gcr.io/v2/: net/http: request canceled <span class="keyword">while</span> waiting <span class="keyword">for</span> connection (Client.Timeout exceeded <span class="keyword">while</span> awaiting headers)</div></pre></td></tr></table></figure>
<p>solution is to copy <code>k8s.grc.io/pause:3.2</code> image to <code>ubuntu node</code>, and restart kubelet on working node.</p>
<ul>
<li>error 3: no network plugin CNI</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">networkPlugin cni failed to <span class="built_in">set</span> up pod <span class="string">"busybox_test-busybox"</span> network: open /run/flannel/subnet.env: no such file or directory</div></pre></td></tr></table></figure>
<p><a href="https://github.com/kubernetes/kubernetes/issues/36575" target="_blank" rel="external">a temp solution</a> is to cp <code>/run/flannel/subnet.env</code> from master node to worker node, then restart kubelet at the worker node. as further study, the <code>cp subnet.env</code> to worker node is not the right solution, as every time the worker node shutdown, this <code>subnet.env</code> file will delete, and won’t restart when reboot the worker node the next day.</p>
<p>so the final solution here is to pull <code>quay.io/coreos/flannel</code> image to worker node, as well as <code>k8s.gcr.io/kube-proxy</code>. in later k8s version, <code>kube-proxy</code> is like a proxy, what’s really inside is the flannel daemon. so we need both <code>kube-proxy</code> and <code>flannel</code> at worker node, to guarantee the network working.</p>
<p>we can see the <code>busybox</code> service is running well: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">kubectl expose pod busybox --<span class="built_in">type</span>=NodePort   --namespace=<span class="built_in">test</span>-busybox</div><div class="line">kubectl get pods --output=wide -n <span class="built_in">test</span>-busybox</div><div class="line">NAME      READY   STATUS    RESTARTS   AGE     IP         NODE     NOMINATED NODE   READINESS GATES</div><div class="line">busybox   1/1     Running   0          7m57s   10.4.0.3   ubuntu   &lt;none&gt;           &lt;none&gt;</div><div class="line">kubectl get service busybox -n <span class="built_in">test</span>-busybox</div><div class="line">NAME      TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</div><div class="line">busybox   NodePort   10.107.117.219   &lt;none&gt;        8280:32431/TCP   33s</div></pre></td></tr></table></figure>
<p>but the problem here is, we can’t access this service from host machine. </p>
<h4 id="exposing-an-external-IP-to-access-an-app-in-cluster"><a href="#exposing-an-external-IP-to-access-an-app-in-cluster" class="headerlink" title="exposing an external IP to access an app in cluster"></a><a href="https://kubernetes.io/docs/tutorials/stateless-application/expose-external-ip-address/" target="_blank" rel="external">exposing an external IP to access an app in cluster</a></h4><p>to expose service externally, define the service as either<code>LoadBalancer</code> or <code>NodePort</code> type. but <code>LoaderBalancer</code> <a href="https://github.com/kubernetes/kubernetes/issues/23562" target="_blank" rel="external">requires external third-party: 23562</a> implement of load balancer, e.g. AWS.<br><a href="https://stackoverflow.com/questions/44110876/kubernetes-service-external-ip-pending" target="_blank" rel="external">why loadBalancer service doesn’t work</a>: if you are using a custom Kubernetes Cluster (using minikube, kubeadm or the like). In this case, there is no LoadBalancer integrated (unlike AWS or Google Cloud). With this default setup, you can only use NodePort or an Ingress Controller.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">kubectl apply -f /home/gwm/k8s/busybox.yaml</div><div class="line">kubectl get deployments hello-world  	<span class="comment">#display info of Deployment</span></div><div class="line">kubectl describe deployments hello-world</div><div class="line">kubectl get replicasets		<span class="comment">#display info of ReplicaSet</span></div><div class="line">kubectl describe replicasets</div><div class="line">kubectl expose deployment hello-world --<span class="built_in">type</span>=NodePort --name=my-service  <span class="comment"># create a service object that exposes the deployment </span></div><div class="line">kubectl get services my-service </div><div class="line">kubectl describe services my-service</div><div class="line"><span class="comment">#cleanup when test done</span></div><div class="line">kubectl delete services my-service</div><div class="line">kubectl delete deployment hello-world</div></pre></td></tr></table></figure>
<p>looks the <code>NodePort</code> service doesn’t work as expected: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">curl http://10.20.180.12:8280 </div><div class="line">curl: (7) Failed to connect to 10.20.180.12 port 8280: Connection refused</div></pre></td></tr></table></figure>
<p>if pods can’t be cleaned by <code>kubectl delete pods xx</code>, try <code>kubectl delete pod &lt;PODNAME&gt; --grace-period=0 --force --namespace &lt;NAMESPACE&gt;</code>. </p>
<p><strong>how to access k8s service outside the cluster</strong></p>
<h2 id="kubectl-config"><a href="#kubectl-config" class="headerlink" title="kubectl config"></a>kubectl config</h2><h4 id="reconfigure-a-node’s-kubelet-in-a-live-cluster"><a href="#reconfigure-a-node’s-kubelet-in-a-live-cluster" class="headerlink" title="reconfigure a node’s kubelet in a live cluster"></a><a href="https://kubernetes.io/docs/tasks/administer-cluster/reconfigure-kubelet/#automatic-rbac-rules-for-node-authorizer" target="_blank" rel="external">reconfigure a node’s kubelet in a live cluster</a></h4><p>Basic workflow overview</p>
<p>The basic workflow for configuring a kubelet in a live cluster is as follows:</p>
<pre><code>Write a YAML or JSON configuration file containing the kubelet’s configuration.
Wrap this file in a ConfigMap and save it to the Kubernetes control plane.
Update the kubelet’s corresponding Node object to use this ConfigMap.
</code></pre><ul>
<li>dump configure file of each node </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">NODE_NAME=<span class="string">"the-name-of-the-node-you-are-reconfiguring"</span>; curl -sSL <span class="string">"http://localhost:8001/api/v1/nodes/<span class="variable">$&#123;NODE_NAME&#125;</span>/proxy/configz"</span> | jq <span class="string">'.kubeletconfig|.kind="KubeletConfiguration"|.apiVersion="kubelet.config.k8s.io/v1beta1"'</span> &gt; kubelet_configz_<span class="variable">$&#123;NODE_NAME&#125;</span></div></pre></td></tr></table></figure>
<p>our cluster have <code>ubuntu</code> and <code>meng</code>(as leader) two nodes. with these two config files, we found two existing issues: </p>
<p>1) network config on two nodes doesn’ match each other</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;   <span class="string">"clusterDomain"</span>: <span class="string">"xyz.abc"</span>,</div><div class="line">---</div><div class="line">&gt;   <span class="string">"clusterDomain"</span>: <span class="string">"cluster.local"</span>,</div><div class="line">&lt;     <span class="string">"10.3.0.10"</span></div><div class="line">---</div><div class="line">&gt;     <span class="string">"10.96.0.10"</span></div></pre></td></tr></table></figure>
<p>after generrating the NODE config files above, we can edit these files, and then push the edited config file to the control plane:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">NODE_NAME=meng; kubectl -n kube-system create configmap meng-node-config --from-file=kubelet=kubelet_configz_<span class="variable">$&#123;NODE_NAME&#125;</span> --append-hash -o yaml</div><div class="line">NODE_NAME=ubuntu; kubectl -n kube-system create configmap ubuntu-node-config --from-file=kubelet=kubelet_configz_<span class="variable">$&#123;NODE_NAME&#125;</span> --append-hash -o yaml</div></pre></td></tr></table></figure>
<p>after this setting up, we can check the new generated configmaps:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">kubectl get configmaps -n kube-system</div><div class="line">kubectl edit configmap meng-node-config-t442m526c5 -n kube-system</div></pre></td></tr></table></figure>
<p>tips: configMaps is also an Object in k8s, just like namespace, pods, svc. but which is only in /tmp, need manually dump. </p>
<p>namely:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">meng-node-config-t442m526c5          1      35m</div><div class="line">ubuntu-node-config-ghkg27446c        1      18s</div></pre></td></tr></table></figure>
<ul>
<li>set node to use new configMap, by <code>kubectl edit node ${NODE_NAME}</code>, and add the following YAML under <code>spec</code>:</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="attr">configSource:</span></div><div class="line"><span class="attr">    configMap:</span></div><div class="line"><span class="attr">        name:</span> <span class="string">CONFIG_MAP_NAME</span> <span class="comment"># replace CONFIG_MAP_NAME with the name of the ConfigMap</span></div><div class="line"><span class="attr">        namespace:</span> <span class="string">kube-system</span></div><div class="line"><span class="attr">        kubeletConfigKey:</span> <span class="string">kubelet</span></div></pre></td></tr></table></figure>
<ul>
<li>observe the node begin with the new configuration</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kubectl get node <span class="variable">$&#123;NODE_NAME&#125;</span> -o yaml</div></pre></td></tr></table></figure>
<p>2) kubectl command doesn’t work at worker node</p>
<p>basically, worker node always report <code>error: Missing or incomplete configuration info.  Please point to an existing, complete config file</code> when running <code>kubectl</code> command. </p>
<p>which needs to copy <code>/etc/kubernetes/admin.conf</code> from master to worker, then append <code>cat &quot;export KUBECONFIG=/etc/kubernetes/admin.conf&quot; &gt;&gt; /etc/profile</code> at worker node.</p>
<p><a href="https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/" target="_blank" rel="external">organizing cluster accesss using kubecnfig files</a></p>
<h4 id="docker0-iptables-transfer"><a href="#docker0-iptables-transfer" class="headerlink" title="docker0 iptables transfer"></a>docker0 iptables transfer</h4><p>when starting docker engine, <code>docker0</code> VNC is created, and this vnc add its routing rules to the host’s iptables. From docker 1.13.1, the routing rules of <code>docker0</code> vnc is only transfer to localhost of the host machine, namely <code>docker0</code> to any other non-localhost is forbidden, which leads to the service can only be access on the host machine, where this pod/container is running. in multi-nodes k8s, we need enable iptable FORWARD. </p>
<p>append the following line to <code>ExecStart</code> line in file <code>/lib/systemd/system/docker.service</code>: </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ExecStartPost=/sbin/iptables -I FORWARD -s 0.0.0.0/0 -j ACCEPT</div></pre></td></tr></table></figure>
<p>then restart docker engine: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">systemctl daemon-reload</div><div class="line">systemctl restart docker.service</div></pre></td></tr></table></figure>
<p>after enable docker0 iptable rules, the following test service can be accessed on both nodes. </p>
<h2 id="deploy-redis-service"><a href="#deploy-redis-service" class="headerlink" title="deploy redis service"></a>deploy redis service</h2><h4 id="create-a-k8s-redis-image"><a href="#create-a-k8s-redis-image" class="headerlink" title="create a k8s-redis image"></a>create a k8s-redis image</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"># use existing docker image as a base</div><div class="line">FROM ubuntu:16.04</div><div class="line"></div><div class="line"># Download and install dependency</div><div class="line">RUN apt-get update &amp;&amp; apt-get install -y --no-install-recommends redis-server</div><div class="line"></div><div class="line"># EXPOSE the port to the Host OS</div><div class="line">EXPOSE 6379</div><div class="line"></div><div class="line"># Tell the image what command it has to execute as it starts as a container</div><div class="line">CMD ["redis-server"]</div></pre></td></tr></table></figure>
<p>build the image and push to both nodes. </p>
<h4 id="deploy-a-redis-deployment"><a href="#deploy-a-redis-deployment" class="headerlink" title="deploy a redis-deployment"></a>deploy a redis-deployment</h4><ul>
<li>create <code>redis-deployment.yaml</code>: </li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">apiVersion: apps/v1</div><div class="line">kind: Deployment</div><div class="line">metadata:</div><div class="line">  labels:</div><div class="line">    app.kubernetes.io/name: load-balancer-example</div><div class="line">  name: kredis-deployment</div><div class="line">spec:</div><div class="line">  replicas: 1</div><div class="line">  selector:</div><div class="line">    matchLabels:</div><div class="line">      app.kubernetes.io/name: load-balancer-example</div><div class="line">  template:</div><div class="line">    metadata:</div><div class="line">      labels:</div><div class="line">        app.kubernetes.io/name: load-balancer-example</div><div class="line">    spec:</div><div class="line">      containers:</div><div class="line">      - image: 10.20.181.119:5000/k8s_redis</div><div class="line">        name: kredis</div><div class="line">        ports:</div><div class="line">        - containerPort: 6379</div></pre></td></tr></table></figure>
<ul>
<li>expose deployment as service</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">kubectl create ns <span class="built_in">test</span>-busybox</div><div class="line">kubectl apply -f redis-deployment.yaml</div><div class="line">kubectl get deployments redis-deployment 	<span class="comment">#display info of Deployment</span></div><div class="line">kubectl describe deployments redis-deployment</div><div class="line">kubectl get replicasets		<span class="comment">#display info of ReplicaSet</span></div><div class="line">kubectl describe replicasets</div><div class="line">kubectl expose deployment redis-deployment --<span class="built_in">type</span>=NodePort --name=my-redis  <span class="comment"># create a service object that exposes the deployment </span></div><div class="line">kubectl get services my-redis </div><div class="line">kubectl describe services my-redis </div><div class="line">kubectl get pods --output=wide</div><div class="line"><span class="comment">#clean up later (afer step 3)</span></div><div class="line">kubectl delete services my-redis</div><div class="line">kubectl delete deployment redis-deployment</div></pre></td></tr></table></figure>
<h4 id="access-as-pod"><a href="#access-as-pod" class="headerlink" title="access as pod"></a>access as pod</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">gwm@meng:~/k8s/alpine$ kubectl get pods --output=wide </div><div class="line">NAME                                 READY   STATUS    RESTARTS   AGE   IP          NODE     NOMINATED NODE   READINESS GATES</div><div class="line">kredis-deployment-7567b7f4b7-wmqgd   1/1     Running   0          16h   10.4.1.18   ubuntu   &lt;none&gt;           &lt;none&gt;</div><div class="line">gwm@meng:~/k8s/alpine$ redis-cli -p 6379</div><div class="line">Could not connect to Redis at 127.0.0.1:6379: Connection refused</div><div class="line">not connected&gt; </div><div class="line">gwm@ubuntu:~$ redis-cli -p 6379</div><div class="line">Could not connect to Redis at 127.0.0.1:6379: Connection refused</div><div class="line">not connected&gt;</div></pre></td></tr></table></figure>
<p>as we can see here, as <code>redis-server</code> as pod, won’t expose any port. and pod-IP(10.4.1.18) is only accessible inside cluster</p>
<h4 id="access-as-service"><a href="#access-as-service" class="headerlink" title="access as service"></a>access as service</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">kubectl get services --output=wide </div><div class="line">NAME            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE   SELECTOR</div><div class="line">kredis-deploy   NodePort    10.104.43.224   &lt;none&gt;        6379:31962/TCP   23h   app.kubernetes.io/name=load-balancer-example</div><div class="line">kubernetes      ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP          8d    &lt;none&gt;</div><div class="line">root@ubuntu:~<span class="comment"># docker container inspect 60bfd6c5ccac  | grep 31962 </span></div><div class="line">root@ubuntu:~<span class="comment"># redis-cli -p 31962 </span></div><div class="line">127.0.0.1:31962&gt; </div><div class="line">root@ubuntu:~<span class="comment"># redis-cli -p 31962 -h 10.20.181.132 </span></div><div class="line">10.20.181.132:31962&gt; </div><div class="line">gwm@meng:~$ redis-cli -h 10.20.181.132 -p 31962 </div><div class="line">10.20.181.132:31962&gt;</div></pre></td></tr></table></figure>
<p>so basically, we can access <code>redis</code> as service with the exposed port <code>31962</code>, and the host node’s IP(10.20.181.132), (rather than the serivce cluster IP(10.104.43.224). </p>
<p>tips, only check service, won’t tell on which node, the pod is running. so need check the pod, and get its node’s IP. </p>
<p>with <code>docker StartExec</code> with <code>iptable FORWARD</code>, <code>redis-cli</code> on on both ubuntu node and meng node can access the service. </p>
<p>in summary:  if we deploy service as NodePort,  we suppose to access the service with its host node’s IP and the exposed port, from external/outside of k8s.</p>
<h4 id="endpoints"><a href="#endpoints" class="headerlink" title="endpoints"></a>endpoints</h4><p><a href="https://theithollow.com/2019/02/04/kubernetes-endpoints/" target="_blank" rel="external">k8s endpoints</a>. what’s the difference from endpoints to externalIP ? </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">kubectl get endpoints </div><div class="line">NAME         ENDPOINTS           AGE</div><div class="line">kubernetes   10.20.180.12:6443   8d</div></pre></td></tr></table></figure>
<p>it gives us the kubernetes endpoints, which is avaiable on both meng and ubuntu nodes.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">gwm@meng:~$ curl http://10.20.180.12:6443 </div><div class="line">Client sent an HTTP request to an HTTPS server.</div><div class="line">gwm@ubuntu:~$ curl http://10.20.180.12:6443 </div><div class="line">Client sent an HTTP request to an HTTPS server.</div></pre></td></tr></table></figure>
<p>not every service has <code>ENDPOINTS</code>, which gives the way to access outside of the cluster. but <code>NodePort</code> type service can bind to the running pod’s host IP with the exported port.</p>
<p>whenever <a href="https://yq.aliyun.com/articles/679802" target="_blank" rel="external">expose k8s service</a> to either internally or externally, it goes through <code>kube-proxy</code>. when <code>kube-proxy</code> do network transfer, it has two ways: Userspace or Iptables.</p>
<p>clusterIP, is basically expose internnaly, with the service’s cluster IP; while nodePort type, is basically bind the service’s port to each node, so we can access the service from each node with the node’s IP and this fixed port. </p>
<h4 id="apiserver"><a href="#apiserver" class="headerlink" title="apiserver"></a>apiserver</h4><p><a href="https://www.jianshu.com/p/a25e9e613f2c" target="_blank" rel="external">core of k8s: API Server</a>, is the RESTful API for resource POST/GET/DELETE/UPDATE. we can access through: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">curl apiserver_ip:apiserver_port/api</div><div class="line">curl apiserver_ip:apiserver_port/api/v1/pods</div><div class="line">curl apiserver_ip:apiserver_port/api/v1/services</div><div class="line">CURL apiserver_ip:apiserver_port/api/v1/proxy/nodes/&#123;name&#125;/pods/</div></pre></td></tr></table></figure>
<ul>
<li>check apiServer IP</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">kubectl get pods -n kube-system --output=wide</div><div class="line">kube-apiserver-meng            1/1     Running   2          8d     10.20.180.12    meng     &lt;none&gt;           &lt;none&gt;</div></pre></td></tr></table></figure>
<p>if check the <code>LISTEN</code> ports on both worker and master nodes, there are many k8s related ports, some are accessible, while some are not. </p>
<h2 id="k8s-dashboard"><a href="#k8s-dashboard" class="headerlink" title="k8s dashboard"></a>k8s dashboard</h2><p>the following is from <a href="https://kuboard.cn/install/install-k8s-dashboard.html#%E5%AE%89%E8%A3%85" target="_blank" rel="external">dashboard doc in cn</a></p>
<ul>
<li>download src</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">docker search kubernetes-dashboard-amd64</div><div class="line">docker pull k8scn/kubernetes-dashboard-amd64</div><div class="line">docker tag k8scn/kubernetes-dashboard-amd64:latest k8s.gcr.io/kubernetes-dashboard-amd64:latest</div></pre></td></tr></table></figure>
<ul>
<li>clear old dashboard resources </li>
</ul>
<p>if there are old running dashboard, can clear first. </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">kubectl get clusterroles kubernetes-dashboard --output=wide </div><div class="line">kubectl get clusterrolebindings kubernetes-dashboard  --output=wide </div><div class="line">kubectl delete clusterroles kubernetes-dashboard </div><div class="line">kubectl delete clusterrolebindings kubernetes-dashboard </div><div class="line">kubectl delete ns kubernetes-dashboard</div></pre></td></tr></table></figure>
<ul>
<li>start a fresh dashboard</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">kubectl apply -f https://kuboard.cn/install-script/k8s-dashboard/v2.0.0-beta5.yaml </div><div class="line">kubectl apply -f https://kuboard.cn/install-script/k8s-dashboard/auth.yaml</div></pre></td></tr></table></figure>
<p>or src from <a href="https://github.com/kubernetes/dashboard/blob/master/aio/deploy/recommended.yaml" target="_blank" rel="external">github/dashboard/recommended.yaml</a>, and run:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">kubectl create -f admin-user.yaml</div><div class="line">kubectl create -f recommended.yaml</div></pre></td></tr></table></figure>
<p><code>admin-user.yaml</code> is defined wih <code>admin authorization</code>. if not define or applied, when login to dashboard web UI, it gives some errors like:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">namespaces is forbidden: User <span class="string">"system:serviceaccount:kubernetes-dashboard:kubernetes-dashboard"</span> cannot list resource <span class="string">"namespaces"</span> <span class="keyword">in</span> API group <span class="string">""</span> at the cluster scope</div></pre></td></tr></table></figure>
<p>so there are two tips during creating dashboard.</p>
<ul>
<li><p>auth/admin-user.yaml is required</p>
</li>
<li><p>add NodePort type service to expose dashboard. if not, can’ access dashboard on host machine. </p>
</li>
</ul>
<p>refer from <a href="https://tomoyadeng.github.io/blog/2019/08/11/k8s-dashboard-openssl/index.html" target="_blank" rel="external">deploy dashboard &amp;&amp; metrics-server</a></p>
<ul>
<li><p>create <code>external-http.yaml</code> to expose NodePort service </p>
</li>
<li><p>create <code>admin-user.yaml</code> for admin manage</p>
</li>
</ul>
<ul>
<li>get the ServiceAccount token</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk <span class="string">'&#123;print $1&#125;'</span>)</div></pre></td></tr></table></figure>
<ul>
<li>go to <code>https://nodeIP.6443</code>, tips, dashboard service is using <code>https</code></li>
</ul>
<ul>
<li>login dashboard</li>
</ul>
<p>there are two ways to auth to login dashboard: </p>
<p>– kubeconfig, the configure to access the cluster</p>
<p>– token, every service account has a secret with valid Bearer Token, that can used to login to Dashboard. </p>
<ul>
<li>system checks</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">kubectl get secrets -n kubernetes-dashboard</div><div class="line">kubectl get serviceaccount -n kubernetes-dashboard</div><div class="line">kubectl describe serviceaccount kubernetes-dashboard  -n kubernetes-dashboard</div></pre></td></tr></table></figure>
<h4 id="metrics-server"><a href="#metrics-server" class="headerlink" title="metrics-server"></a>metrics-server</h4><p>metrics-server is a replace of Heapster. </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kubectl edit deploy -n kubernetes-dashboard dashboard-metrics-scraper</div></pre></td></tr></table></figure>
<h4 id="roles"><a href="#roles" class="headerlink" title="roles"></a>roles</h4><p>the right way to create a role:</p>
<ul>
<li>create a ServiceAccount </li>
<li>bind a role for the ServiceAccount(cluster-admin role is needed)</li>
<li>make a ClusterRoleBinding for ServiceAccount </li>
</ul>
<h4 id="list-all-container-images-in-all-ns"><a href="#list-all-container-images-in-all-ns" class="headerlink" title="list all container images in all ns"></a><a href="https://kubernetes.io/docs/tasks/access-application-cluster/list-all-running-container-images/" target="_blank" rel="external">list all container images in all ns</a></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">kubectl get pods --all-namespaces -o jsonpath=<span class="string">"&#123;..image&#125;"</span> |\</div><div class="line">tr -s <span class="string">'[[:space:]]'</span> <span class="string">'\n'</span> |\</div><div class="line">sort |\</div><div class="line">uniq -c</div></pre></td></tr></table></figure>
<h2 id="refere"><a href="#refere" class="headerlink" title="refere"></a>refere</h2><p><a href="https://kubernetes.io/docs/reference/kubectl/cheatsheet/" target="_blank" rel="external">kubectl cheatsheet</a></p>
<p><a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" target="_blank" rel="external">deployments from k8s doc</a></p>
<p><a href="https://jekhokie.github.io/k8s/busybox/helm/2020/04/23/small-web-server-to-k8s.html" target="_blank" rel="external">deploy tiny web server to k8s</a></p>
<p><a href="https://learnk8s.io/production-best-practices" target="_blank" rel="external">k8s production best practices</a></p>
<p><a href="https://github.com/containernetworking/cni/blob/master/SPEC.md" target="_blank" rel="external">cni readme</a></p>
<p><a href="https://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/" target="_blank" rel="external">configure network plugins</a>:</p>
<p><a href="https://www.centos.bz/2017/06/k8s-flannel-network/" target="_blank" rel="external">k8s与flannel网络原理</a></p>
<p><a href="https://network.51cto.com/art/201908/601109.htm" target="_blank" rel="external">清晰脱俗的直解K8S网络</a></p>
<p> <a href="https://shogokobayashi.com/2018/09/27/k8s-ex01-iptables-and-docker/" target="_blank" rel="external">k8s: iptables and docker0</a></p>
<p> <a href="https://blog.csdn.net/whatday/article/details/105197120" target="_blank" rel="external">linux docker and iptables</a></p>
<p><a href="https://kubernetes.io/docs/reference/access-authn-authz/controlling-access/" target="_blank" rel="external">controlling access to k8s APIserver</a></p>
<p><a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/" target="_blank" rel="external">understand RBAC auth</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/19/">19</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="David Z.J. Lee" />
          <p class="site-author-name" itemprop="name">David Z.J. Lee</p>
           
              <p class="site-description motion-element" itemprop="description">what I don't know</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">183</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">49</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/ZJLi2013" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.linkedin.com/in/zhengjia13/" target="_blank" title="LinkedIn">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  LinkedIn
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">David Z.J. Lee</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://zjlee.disqus.com/count.js" async></script>
    

    

  




	





  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
